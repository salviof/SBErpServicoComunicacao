var la=Object.defineProperty;var da=(t,E,e)=>E in t?la(t,E,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[E]=e;var wt=(t,E,e)=>(da(t,typeof E!="symbol"?E+"":E,e),e);(function(){const E=document.createElement("link").relList;if(E&&E.supports&&E.supports("modulepreload"))return;for(const g of document.querySelectorAll('link[rel="modulepreload"]'))u(g);new MutationObserver(g=>{for(const S of g)if(S.type==="childList")for(const y of S.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&u(y)}).observe(document,{childList:!0,subtree:!0});function e(g){const S={};return g.integrity&&(S.integrity=g.integrity),g.referrerPolicy&&(S.referrerPolicy=g.referrerPolicy),g.crossOrigin==="use-credentials"?S.credentials="include":g.crossOrigin==="anonymous"?S.credentials="omit":S.credentials="same-origin",S}function u(g){if(g.ep)return;g.ep=!0;const S=e(g);fetch(g.href,S)}})();function _r(t,E){const e=Object.create(null),u=t.split(",");for(let g=0;g<u.length;g++)e[u[g]]=!0;return E?g=>!!e[g.toLowerCase()]:g=>!!e[g]}function st(t){if(Fe(t)){const E={};for(let e=0;e<t.length;e++){const u=t[e],g=ct(u)?pa(u):st(u);if(g)for(const S in g)E[S]=g[S]}return E}else{if(ct(t))return t;if(Xe(t))return t}}const ua=/;(?![^(]*\))/g,fa=/:([^]+)/,ha=/\/\*.*?\*\//gs;function pa(t){const E={};return t.replace(ha,"").split(ua).forEach(e=>{if(e){const u=e.split(fa);u.length>1&&(E[u[0].trim()]=u[1].trim())}}),E}function $n(t){let E="";if(ct(t))E=t;else if(Fe(t))for(let e=0;e<t.length;e++){const u=$n(t[e]);u&&(E+=u+" ")}else if(Xe(t))for(const e in t)t[e]&&(E+=e+" ");return E.trim()}const ga="itemscope,allowfullscreen,formnovalidate,ismap,nomodule,novalidate,readonly",va=_r(ga);function Ns(t){return!!t||t===""}const ut=t=>ct(t)?t:t==null?"":Fe(t)||Xe(t)&&(t.toString===js||!$e(t.toString))?JSON.stringify(t,Bs,2):String(t),Bs=(t,E)=>E&&E.__v_isRef?Bs(t,E.value):An(E)?{[`Map(${E.size})`]:[...E.entries()].reduce((e,[u,g])=>(e[`${u} =>`]=g,e),{})}:Us(E)?{[`Set(${E.size})`]:[...E.values()]}:Xe(E)&&!Fe(E)&&!Ks(E)?String(E):E,Qe={},Mn=[],Ct=()=>{},ma=()=>!1,ya=/^on[^a-z]/,Si=t=>ya.test(t),Sr=t=>t.startsWith("onUpdate:"),dt=Object.assign,Er=(t,E)=>{const e=t.indexOf(E);e>-1&&t.splice(e,1)},ba=Object.prototype.hasOwnProperty,We=(t,E)=>ba.call(t,E),Fe=Array.isArray,An=t=>Ei(t)==="[object Map]",Us=t=>Ei(t)==="[object Set]",$e=t=>typeof t=="function",ct=t=>typeof t=="string",wr=t=>typeof t=="symbol",Xe=t=>t!==null&&typeof t=="object",Fs=t=>Xe(t)&&$e(t.then)&&$e(t.catch),js=Object.prototype.toString,Ei=t=>js.call(t),_a=t=>Ei(t).slice(8,-1),Ks=t=>Ei(t)==="[object Object]",Tr=t=>ct(t)&&t!=="NaN"&&t[0]!=="-"&&""+parseInt(t,10)===t,oi=_r(",key,ref,ref_for,ref_key,onVnodeBeforeMount,onVnodeMounted,onVnodeBeforeUpdate,onVnodeUpdated,onVnodeBeforeUnmount,onVnodeUnmounted"),wi=t=>{const E=Object.create(null);return e=>E[e]||(E[e]=t(e))},Sa=/-(\w)/g,Dt=wi(t=>t.replace(Sa,(E,e)=>e?e.toUpperCase():"")),Ea=/\B([A-Z])/g,Rn=wi(t=>t.replace(Ea,"-$1").toLowerCase()),Ti=wi(t=>t.charAt(0).toUpperCase()+t.slice(1)),$i=wi(t=>t?`on${Ti(t)}`:""),Vn=(t,E)=>!Object.is(t,E),ai=(t,E)=>{for(let e=0;e<t.length;e++)t[e](E)},vi=(t,E,e)=>{Object.defineProperty(t,E,{configurable:!0,enumerable:!1,value:e})},tr=t=>{const E=parseFloat(t);return isNaN(E)?t:E},wa=t=>{const E=ct(t)?Number(t):NaN;return isNaN(E)?t:E};let Vr;const Ta=()=>Vr||(Vr=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{});let Tt;class Ra{constructor(E=!1){this.detached=E,this._active=!0,this.effects=[],this.cleanups=[],this.parent=Tt,!E&&Tt&&(this.index=(Tt.scopes||(Tt.scopes=[])).push(this)-1)}get active(){return this._active}run(E){if(this._active){const e=Tt;try{return Tt=this,E()}finally{Tt=e}}}on(){Tt=this}off(){Tt=this.parent}stop(E){if(this._active){let e,u;for(e=0,u=this.effects.length;e<u;e++)this.effects[e].stop();for(e=0,u=this.cleanups.length;e<u;e++)this.cleanups[e]();if(this.scopes)for(e=0,u=this.scopes.length;e<u;e++)this.scopes[e].stop(!0);if(!this.detached&&this.parent&&!E){const g=this.parent.scopes.pop();g&&g!==this&&(this.parent.scopes[this.index]=g,g.index=this.index)}this.parent=void 0,this._active=!1}}}function Ia(t,E=Tt){E&&E.active&&E.effects.push(t)}function Ca(){return Tt}const Rr=t=>{const E=new Set(t);return E.w=0,E.n=0,E},Hs=t=>(t.w&qt)>0,$s=t=>(t.n&qt)>0,Ma=({deps:t})=>{if(t.length)for(let E=0;E<t.length;E++)t[E].w|=qt},Aa=t=>{const{deps:E}=t;if(E.length){let e=0;for(let u=0;u<E.length;u++){const g=E[u];Hs(g)&&!$s(g)?g.delete(t):E[e++]=g,g.w&=~qt,g.n&=~qt}E.length=e}},nr=new WeakMap;let jn=0,qt=1;const ir=30;let Rt;const En=Symbol(""),rr=Symbol("");class Ir{constructor(E,e=null,u){this.fn=E,this.scheduler=e,this.active=!0,this.deps=[],this.parent=void 0,Ia(this,u)}run(){if(!this.active)return this.fn();let E=Rt,e=Wt;for(;E;){if(E===this)return;E=E.parent}try{return this.parent=Rt,Rt=this,Wt=!0,qt=1<<++jn,jn<=ir?Ma(this):Wr(this),this.fn()}finally{jn<=ir&&Aa(this),qt=1<<--jn,Rt=this.parent,Wt=e,this.parent=void 0,this.deferStop&&this.stop()}}stop(){Rt===this?this.deferStop=!0:this.active&&(Wr(this),this.onStop&&this.onStop(),this.active=!1)}}function Wr(t){const{deps:E}=t;if(E.length){for(let e=0;e<E.length;e++)E[e].delete(t);E.length=0}}let Wt=!0;const Vs=[];function Ln(){Vs.push(Wt),Wt=!1}function Nn(){const t=Vs.pop();Wt=t===void 0?!0:t}function mt(t,E,e){if(Wt&&Rt){let u=nr.get(t);u||nr.set(t,u=new Map);let g=u.get(e);g||u.set(e,g=Rr()),Ws(g)}}function Ws(t,E){let e=!1;jn<=ir?$s(t)||(t.n|=qt,e=!Hs(t)):e=!t.has(Rt),e&&(t.add(Rt),Rt.deps.push(t))}function Ut(t,E,e,u,g,S){const y=nr.get(t);if(!y)return;let c=[];if(E==="clear")c=[...y.values()];else if(e==="length"&&Fe(t)){const m=Number(u);y.forEach((h,d)=>{(d==="length"||d>=m)&&c.push(h)})}else switch(e!==void 0&&c.push(y.get(e)),E){case"add":Fe(t)?Tr(e)&&c.push(y.get("length")):(c.push(y.get(En)),An(t)&&c.push(y.get(rr)));break;case"delete":Fe(t)||(c.push(y.get(En)),An(t)&&c.push(y.get(rr)));break;case"set":An(t)&&c.push(y.get(En));break}if(c.length===1)c[0]&&sr(c[0]);else{const m=[];for(const h of c)h&&m.push(...h);sr(Rr(m))}}function sr(t,E){const e=Fe(t)?t:[...t];for(const u of e)u.computed&&Gr(u);for(const u of e)u.computed||Gr(u)}function Gr(t,E){(t!==Rt||t.allowRecurse)&&(t.scheduler?t.scheduler():t.run())}const Oa=_r("__proto__,__v_isRef,__isVue"),Gs=new Set(Object.getOwnPropertyNames(Symbol).filter(t=>t!=="arguments"&&t!=="caller").map(t=>Symbol[t]).filter(wr)),ka=Cr(),Pa=Cr(!1,!0),Da=Cr(!0),qr=xa();function xa(){const t={};return["includes","indexOf","lastIndexOf"].forEach(E=>{t[E]=function(...e){const u=ze(this);for(let S=0,y=this.length;S<y;S++)mt(u,"get",S+"");const g=u[E](...e);return g===-1||g===!1?u[E](...e.map(ze)):g}}),["push","pop","shift","unshift","splice"].forEach(E=>{t[E]=function(...e){Ln();const u=ze(this)[E].apply(this,e);return Nn(),u}}),t}function La(t){const E=ze(this);return mt(E,"has",t),E.hasOwnProperty(t)}function Cr(t=!1,E=!1){return function(u,g,S){if(g==="__v_isReactive")return!t;if(g==="__v_isReadonly")return t;if(g==="__v_isShallow")return E;if(g==="__v_raw"&&S===(t?E?Qa:Qs:E?Js:Ys).get(u))return u;const y=Fe(u);if(!t){if(y&&We(qr,g))return Reflect.get(qr,g,S);if(g==="hasOwnProperty")return La}const c=Reflect.get(u,g,S);return(wr(g)?Gs.has(g):Oa(g))||(t||mt(u,"get",g),E)?c:ht(c)?y&&Tr(g)?c:c.value:Xe(c)?t?Xs(c):Or(c):c}}const Na=qs(),Ba=qs(!0);function qs(t=!1){return function(e,u,g,S){let y=e[u];if(Pn(y)&&ht(y)&&!ht(g))return!1;if(!t&&(!mi(g)&&!Pn(g)&&(y=ze(y),g=ze(g)),!Fe(e)&&ht(y)&&!ht(g)))return y.value=g,!0;const c=Fe(e)&&Tr(u)?Number(u)<e.length:We(e,u),m=Reflect.set(e,u,g,S);return e===ze(S)&&(c?Vn(g,y)&&Ut(e,"set",u,g):Ut(e,"add",u,g)),m}}function Ua(t,E){const e=We(t,E);t[E];const u=Reflect.deleteProperty(t,E);return u&&e&&Ut(t,"delete",E,void 0),u}function Fa(t,E){const e=Reflect.has(t,E);return(!wr(E)||!Gs.has(E))&&mt(t,"has",E),e}function ja(t){return mt(t,"iterate",Fe(t)?"length":En),Reflect.ownKeys(t)}const zs={get:ka,set:Na,deleteProperty:Ua,has:Fa,ownKeys:ja},Ka={get:Da,set(t,E){return!0},deleteProperty(t,E){return!0}},Ha=dt({},zs,{get:Pa,set:Ba}),Mr=t=>t,Ri=t=>Reflect.getPrototypeOf(t);function ei(t,E,e=!1,u=!1){t=t.__v_raw;const g=ze(t),S=ze(E);e||(E!==S&&mt(g,"get",E),mt(g,"get",S));const{has:y}=Ri(g),c=u?Mr:e?Pr:Wn;if(y.call(g,E))return c(t.get(E));if(y.call(g,S))return c(t.get(S));t!==g&&t.get(E)}function ti(t,E=!1){const e=this.__v_raw,u=ze(e),g=ze(t);return E||(t!==g&&mt(u,"has",t),mt(u,"has",g)),t===g?e.has(t):e.has(t)||e.has(g)}function ni(t,E=!1){return t=t.__v_raw,!E&&mt(ze(t),"iterate",En),Reflect.get(t,"size",t)}function zr(t){t=ze(t);const E=ze(this);return Ri(E).has.call(E,t)||(E.add(t),Ut(E,"add",t,t)),this}function Yr(t,E){E=ze(E);const e=ze(this),{has:u,get:g}=Ri(e);let S=u.call(e,t);S||(t=ze(t),S=u.call(e,t));const y=g.call(e,t);return e.set(t,E),S?Vn(E,y)&&Ut(e,"set",t,E):Ut(e,"add",t,E),this}function Jr(t){const E=ze(this),{has:e,get:u}=Ri(E);let g=e.call(E,t);g||(t=ze(t),g=e.call(E,t)),u&&u.call(E,t);const S=E.delete(t);return g&&Ut(E,"delete",t,void 0),S}function Qr(){const t=ze(this),E=t.size!==0,e=t.clear();return E&&Ut(t,"clear",void 0,void 0),e}function ii(t,E){return function(u,g){const S=this,y=S.__v_raw,c=ze(y),m=E?Mr:t?Pr:Wn;return!t&&mt(c,"iterate",En),y.forEach((h,d)=>u.call(g,m(h),m(d),S))}}function ri(t,E,e){return function(...u){const g=this.__v_raw,S=ze(g),y=An(S),c=t==="entries"||t===Symbol.iterator&&y,m=t==="keys"&&y,h=g[t](...u),d=e?Mr:E?Pr:Wn;return!E&&mt(S,"iterate",m?rr:En),{next(){const{value:b,done:a}=h.next();return a?{value:b,done:a}:{value:c?[d(b[0]),d(b[1])]:d(b),done:a}},[Symbol.iterator](){return this}}}}function jt(t){return function(...E){return t==="delete"?!1:this}}function $a(){const t={get(S){return ei(this,S)},get size(){return ni(this)},has:ti,add:zr,set:Yr,delete:Jr,clear:Qr,forEach:ii(!1,!1)},E={get(S){return ei(this,S,!1,!0)},get size(){return ni(this)},has:ti,add:zr,set:Yr,delete:Jr,clear:Qr,forEach:ii(!1,!0)},e={get(S){return ei(this,S,!0)},get size(){return ni(this,!0)},has(S){return ti.call(this,S,!0)},add:jt("add"),set:jt("set"),delete:jt("delete"),clear:jt("clear"),forEach:ii(!0,!1)},u={get(S){return ei(this,S,!0,!0)},get size(){return ni(this,!0)},has(S){return ti.call(this,S,!0)},add:jt("add"),set:jt("set"),delete:jt("delete"),clear:jt("clear"),forEach:ii(!0,!0)};return["keys","values","entries",Symbol.iterator].forEach(S=>{t[S]=ri(S,!1,!1),e[S]=ri(S,!0,!1),E[S]=ri(S,!1,!0),u[S]=ri(S,!0,!0)}),[t,e,E,u]}const[Va,Wa,Ga,qa]=$a();function Ar(t,E){const e=E?t?qa:Ga:t?Wa:Va;return(u,g,S)=>g==="__v_isReactive"?!t:g==="__v_isReadonly"?t:g==="__v_raw"?u:Reflect.get(We(e,g)&&g in u?e:u,g,S)}const za={get:Ar(!1,!1)},Ya={get:Ar(!1,!0)},Ja={get:Ar(!0,!1)},Ys=new WeakMap,Js=new WeakMap,Qs=new WeakMap,Qa=new WeakMap;function Xa(t){switch(t){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function Za(t){return t.__v_skip||!Object.isExtensible(t)?0:Xa(_a(t))}function Or(t){return Pn(t)?t:kr(t,!1,zs,za,Ys)}function ec(t){return kr(t,!1,Ha,Ya,Js)}function Xs(t){return kr(t,!0,Ka,Ja,Qs)}function kr(t,E,e,u,g){if(!Xe(t)||t.__v_raw&&!(E&&t.__v_isReactive))return t;const S=g.get(t);if(S)return S;const y=Za(t);if(y===0)return t;const c=new Proxy(t,y===2?u:e);return g.set(t,c),c}function On(t){return Pn(t)?On(t.__v_raw):!!(t&&t.__v_isReactive)}function Pn(t){return!!(t&&t.__v_isReadonly)}function mi(t){return!!(t&&t.__v_isShallow)}function Zs(t){return On(t)||Pn(t)}function ze(t){const E=t&&t.__v_raw;return E?ze(E):t}function eo(t){return vi(t,"__v_skip",!0),t}const Wn=t=>Xe(t)?Or(t):t,Pr=t=>Xe(t)?Xs(t):t;function to(t){Wt&&Rt&&(t=ze(t),Ws(t.dep||(t.dep=Rr())))}function no(t,E){t=ze(t);const e=t.dep;e&&sr(e)}function ht(t){return!!(t&&t.__v_isRef===!0)}function tc(t){return nc(t,!1)}function nc(t,E){return ht(t)?t:new ic(t,E)}class ic{constructor(E,e){this.__v_isShallow=e,this.dep=void 0,this.__v_isRef=!0,this._rawValue=e?E:ze(E),this._value=e?E:Wn(E)}get value(){return to(this),this._value}set value(E){const e=this.__v_isShallow||mi(E)||Pn(E);E=e?E:ze(E),Vn(E,this._rawValue)&&(this._rawValue=E,this._value=e?E:Wn(E),no(this))}}function rc(t){return ht(t)?t.value:t}const sc={get:(t,E,e)=>rc(Reflect.get(t,E,e)),set:(t,E,e,u)=>{const g=t[E];return ht(g)&&!ht(e)?(g.value=e,!0):Reflect.set(t,E,e,u)}};function io(t){return On(t)?t:new Proxy(t,sc)}var ro;class oc{constructor(E,e,u,g){this._setter=e,this.dep=void 0,this.__v_isRef=!0,this[ro]=!1,this._dirty=!0,this.effect=new Ir(E,()=>{this._dirty||(this._dirty=!0,no(this))}),this.effect.computed=this,this.effect.active=this._cacheable=!g,this.__v_isReadonly=u}get value(){const E=ze(this);return to(E),(E._dirty||!E._cacheable)&&(E._dirty=!1,E._value=E.effect.run()),E._value}set value(E){this._setter(E)}}ro="__v_isReadonly";function ac(t,E,e=!1){let u,g;const S=$e(t);return S?(u=t,g=Ct):(u=t.get,g=t.set),new oc(u,g,S||!g,e)}function Gt(t,E,e,u){let g;try{g=u?t(...u):t()}catch(S){Ii(S,E,e)}return g}function St(t,E,e,u){if($e(t)){const S=Gt(t,E,e,u);return S&&Fs(S)&&S.catch(y=>{Ii(y,E,e)}),S}const g=[];for(let S=0;S<t.length;S++)g.push(St(t[S],E,e,u));return g}function Ii(t,E,e,u=!0){const g=E?E.vnode:null;if(E){let S=E.parent;const y=E.proxy,c=e;for(;S;){const h=S.ec;if(h){for(let d=0;d<h.length;d++)if(h[d](t,y,c)===!1)return}S=S.parent}const m=E.appContext.config.errorHandler;if(m){Gt(m,null,10,[t,y,c]);return}}cc(t,e,g,u)}function cc(t,E,e,u=!0){console.error(t)}let Gn=!1,or=!1;const ft=[];let kt=0;const kn=[];let Lt=null,yn=0;const so=Promise.resolve();let Dr=null;function lc(t){const E=Dr||so;return t?E.then(this?t.bind(this):t):E}function dc(t){let E=kt+1,e=ft.length;for(;E<e;){const u=E+e>>>1;qn(ft[u])<t?E=u+1:e=u}return E}function xr(t){(!ft.length||!ft.includes(t,Gn&&t.allowRecurse?kt+1:kt))&&(t.id==null?ft.push(t):ft.splice(dc(t.id),0,t),oo())}function oo(){!Gn&&!or&&(or=!0,Dr=so.then(co))}function uc(t){const E=ft.indexOf(t);E>kt&&ft.splice(E,1)}function fc(t){Fe(t)?kn.push(...t):(!Lt||!Lt.includes(t,t.allowRecurse?yn+1:yn))&&kn.push(t),oo()}function Xr(t,E=Gn?kt+1:0){for(;E<ft.length;E++){const e=ft[E];e&&e.pre&&(ft.splice(E,1),E--,e())}}function ao(t){if(kn.length){const E=[...new Set(kn)];if(kn.length=0,Lt){Lt.push(...E);return}for(Lt=E,Lt.sort((e,u)=>qn(e)-qn(u)),yn=0;yn<Lt.length;yn++)Lt[yn]();Lt=null,yn=0}}const qn=t=>t.id==null?1/0:t.id,hc=(t,E)=>{const e=qn(t)-qn(E);if(e===0){if(t.pre&&!E.pre)return-1;if(E.pre&&!t.pre)return 1}return e};function co(t){or=!1,Gn=!0,ft.sort(hc);const E=Ct;try{for(kt=0;kt<ft.length;kt++){const e=ft[kt];e&&e.active!==!1&&Gt(e,null,14)}}finally{kt=0,ft.length=0,ao(),Gn=!1,Dr=null,(ft.length||kn.length)&&co()}}function pc(t,E,...e){if(t.isUnmounted)return;const u=t.vnode.props||Qe;let g=e;const S=E.startsWith("update:"),y=S&&E.slice(7);if(y&&y in u){const d=`${y==="modelValue"?"model":y}Modifiers`,{number:b,trim:a}=u[d]||Qe;a&&(g=e.map(n=>ct(n)?n.trim():n)),b&&(g=e.map(tr))}let c,m=u[c=$i(E)]||u[c=$i(Dt(E))];!m&&S&&(m=u[c=$i(Rn(E))]),m&&St(m,t,6,g);const h=u[c+"Once"];if(h){if(!t.emitted)t.emitted={};else if(t.emitted[c])return;t.emitted[c]=!0,St(h,t,6,g)}}function lo(t,E,e=!1){const u=E.emitsCache,g=u.get(t);if(g!==void 0)return g;const S=t.emits;let y={},c=!1;if(!$e(t)){const m=h=>{const d=lo(h,E,!0);d&&(c=!0,dt(y,d))};!e&&E.mixins.length&&E.mixins.forEach(m),t.extends&&m(t.extends),t.mixins&&t.mixins.forEach(m)}return!S&&!c?(Xe(t)&&u.set(t,null),null):(Fe(S)?S.forEach(m=>y[m]=null):dt(y,S),Xe(t)&&u.set(t,y),y)}function Ci(t,E){return!t||!Si(E)?!1:(E=E.slice(2).replace(/Once$/,""),We(t,E[0].toLowerCase()+E.slice(1))||We(t,Rn(E))||We(t,E))}let yt=null,Mi=null;function yi(t){const E=yt;return yt=t,Mi=t&&t.type.__scopeId||null,E}function uo(t){Mi=t}function fo(){Mi=null}function ho(t,E=yt,e){if(!E||t._n)return t;const u=(...g)=>{u._d&&cs(-1);const S=yi(E);let y;try{y=t(...g)}finally{yi(S),u._d&&cs(1)}return y};return u._n=!0,u._c=!0,u._d=!0,u}function Vi(t){const{type:E,vnode:e,proxy:u,withProxy:g,props:S,propsOptions:[y],slots:c,attrs:m,emit:h,render:d,renderCache:b,data:a,setupState:n,ctx:i,inheritAttrs:r}=t;let s,o;const l=yi(t);try{if(e.shapeFlag&4){const f=g||u;s=Ot(d.call(f,f,b,S,n,a,i)),o=m}else{const f=E;s=Ot(f.length>1?f(S,{attrs:m,slots:c,emit:h}):f(S,null)),o=E.props?m:gc(m)}}catch(f){Hn.length=0,Ii(f,t,1),s=ot(Mt)}let v=s;if(o&&r!==!1){const f=Object.keys(o),{shapeFlag:p}=v;f.length&&p&7&&(y&&f.some(Sr)&&(o=vc(o,y)),v=zt(v,o))}return e.dirs&&(v=zt(v),v.dirs=v.dirs?v.dirs.concat(e.dirs):e.dirs),e.transition&&(v.transition=e.transition),s=v,yi(l),s}const gc=t=>{let E;for(const e in t)(e==="class"||e==="style"||Si(e))&&((E||(E={}))[e]=t[e]);return E},vc=(t,E)=>{const e={};for(const u in t)(!Sr(u)||!(u.slice(9)in E))&&(e[u]=t[u]);return e};function mc(t,E,e){const{props:u,children:g,component:S}=t,{props:y,children:c,patchFlag:m}=E,h=S.emitsOptions;if(E.dirs||E.transition)return!0;if(e&&m>=0){if(m&1024)return!0;if(m&16)return u?Zr(u,y,h):!!y;if(m&8){const d=E.dynamicProps;for(let b=0;b<d.length;b++){const a=d[b];if(y[a]!==u[a]&&!Ci(h,a))return!0}}}else return(g||c)&&(!c||!c.$stable)?!0:u===y?!1:u?y?Zr(u,y,h):!0:!!y;return!1}function Zr(t,E,e){const u=Object.keys(E);if(u.length!==Object.keys(t).length)return!0;for(let g=0;g<u.length;g++){const S=u[g];if(E[S]!==t[S]&&!Ci(e,S))return!0}return!1}function yc({vnode:t,parent:E},e){for(;E&&E.subTree===t;)(t=E.vnode).el=e,E=E.parent}const bc=t=>t.__isSuspense;function _c(t,E){E&&E.pendingBranch?Fe(t)?E.effects.push(...t):E.effects.push(t):fc(t)}function Sc(t,E){if(at){let e=at.provides;const u=at.parent&&at.parent.provides;u===e&&(e=at.provides=Object.create(u)),e[t]=E}}function ci(t,E,e=!1){const u=at||yt;if(u){const g=u.parent==null?u.vnode.appContext&&u.vnode.appContext.provides:u.parent.provides;if(g&&t in g)return g[t];if(arguments.length>1)return e&&$e(E)?E.call(u.proxy):E}}const si={};function Wi(t,E,e){return po(t,E,e)}function po(t,E,{immediate:e,deep:u,flush:g,onTrack:S,onTrigger:y}=Qe){const c=Ca()===(at==null?void 0:at.scope)?at:null;let m,h=!1,d=!1;if(ht(t)?(m=()=>t.value,h=mi(t)):On(t)?(m=()=>t,u=!0):Fe(t)?(d=!0,h=t.some(v=>On(v)||mi(v)),m=()=>t.map(v=>{if(ht(v))return v.value;if(On(v))return Sn(v);if($e(v))return Gt(v,c,2)})):$e(t)?E?m=()=>Gt(t,c,2):m=()=>{if(!(c&&c.isUnmounted))return b&&b(),St(t,c,3,[a])}:m=Ct,E&&u){const v=m;m=()=>Sn(v())}let b,a=v=>{b=o.onStop=()=>{Gt(v,c,4)}},n;if(Yn)if(a=Ct,E?e&&St(E,c,3,[m(),d?[]:void 0,a]):m(),g==="sync"){const v=yl();n=v.__watcherHandles||(v.__watcherHandles=[])}else return Ct;let i=d?new Array(t.length).fill(si):si;const r=()=>{if(o.active)if(E){const v=o.run();(u||h||(d?v.some((f,p)=>Vn(f,i[p])):Vn(v,i)))&&(b&&b(),St(E,c,3,[v,i===si?void 0:d&&i[0]===si?[]:i,a]),i=v)}else o.run()};r.allowRecurse=!!E;let s;g==="sync"?s=r:g==="post"?s=()=>vt(r,c&&c.suspense):(r.pre=!0,c&&(r.id=c.uid),s=()=>xr(r));const o=new Ir(m,s);E?e?r():i=o.run():g==="post"?vt(o.run.bind(o),c&&c.suspense):o.run();const l=()=>{o.stop(),c&&c.scope&&Er(c.scope.effects,o)};return n&&n.push(l),l}function Ec(t,E,e){const u=this.proxy,g=ct(t)?t.includes(".")?go(u,t):()=>u[t]:t.bind(u,u);let S;$e(E)?S=E:(S=E.handler,e=E);const y=at;Dn(this);const c=po(g,S.bind(u),e);return y?Dn(y):wn(),c}function go(t,E){const e=E.split(".");return()=>{let u=t;for(let g=0;g<e.length&&u;g++)u=u[e[g]];return u}}function Sn(t,E){if(!Xe(t)||t.__v_skip||(E=E||new Set,E.has(t)))return t;if(E.add(t),ht(t))Sn(t.value,E);else if(Fe(t))for(let e=0;e<t.length;e++)Sn(t[e],E);else if(Us(t)||An(t))t.forEach(e=>{Sn(e,E)});else if(Ks(t))for(const e in t)Sn(t[e],E);return t}function wc(){const t={isMounted:!1,isLeaving:!1,isUnmounting:!1,leavingVNodes:new Map};return _o(()=>{t.isMounted=!0}),So(()=>{t.isUnmounting=!0}),t}const bt=[Function,Array],Tc={name:"BaseTransition",props:{mode:String,appear:Boolean,persisted:Boolean,onBeforeEnter:bt,onEnter:bt,onAfterEnter:bt,onEnterCancelled:bt,onBeforeLeave:bt,onLeave:bt,onAfterLeave:bt,onLeaveCancelled:bt,onBeforeAppear:bt,onAppear:bt,onAfterAppear:bt,onAppearCancelled:bt},setup(t,{slots:E}){const e=cl(),u=wc();let g;return()=>{const S=E.default&&yo(E.default(),!0);if(!S||!S.length)return;let y=S[0];if(S.length>1){for(const r of S)if(r.type!==Mt){y=r;break}}const c=ze(t),{mode:m}=c;if(u.isLeaving)return Gi(y);const h=es(y);if(!h)return Gi(y);const d=ar(h,c,u,e);cr(h,d);const b=e.subTree,a=b&&es(b);let n=!1;const{getTransitionKey:i}=h.type;if(i){const r=i();g===void 0?g=r:r!==g&&(g=r,n=!0)}if(a&&a.type!==Mt&&(!bn(h,a)||n)){const r=ar(a,c,u,e);if(cr(a,r),m==="out-in")return u.isLeaving=!0,r.afterLeave=()=>{u.isLeaving=!1,e.update.active!==!1&&e.update()},Gi(y);m==="in-out"&&h.type!==Mt&&(r.delayLeave=(s,o,l)=>{const v=mo(u,a);v[String(a.key)]=a,s._leaveCb=()=>{o(),s._leaveCb=void 0,delete d.delayedLeave},d.delayedLeave=l})}return y}}},vo=Tc;function mo(t,E){const{leavingVNodes:e}=t;let u=e.get(E.type);return u||(u=Object.create(null),e.set(E.type,u)),u}function ar(t,E,e,u){const{appear:g,mode:S,persisted:y=!1,onBeforeEnter:c,onEnter:m,onAfterEnter:h,onEnterCancelled:d,onBeforeLeave:b,onLeave:a,onAfterLeave:n,onLeaveCancelled:i,onBeforeAppear:r,onAppear:s,onAfterAppear:o,onAppearCancelled:l}=E,v=String(t.key),f=mo(e,t),p=(w,M)=>{w&&St(w,u,9,M)},_=(w,M)=>{const A=M[1];p(w,M),Fe(w)?w.every(W=>W.length<=1)&&A():w.length<=1&&A()},T={mode:S,persisted:y,beforeEnter(w){let M=c;if(!e.isMounted)if(g)M=r||c;else return;w._leaveCb&&w._leaveCb(!0);const A=f[v];A&&bn(t,A)&&A.el._leaveCb&&A.el._leaveCb(),p(M,[w])},enter(w){let M=m,A=h,W=d;if(!e.isMounted)if(g)M=s||m,A=o||h,W=l||d;else return;let ee=!1;const F=w._enterCb=C=>{ee||(ee=!0,C?p(W,[w]):p(A,[w]),T.delayedLeave&&T.delayedLeave(),w._enterCb=void 0)};M?_(M,[w,F]):F()},leave(w,M){const A=String(t.key);if(w._enterCb&&w._enterCb(!0),e.isUnmounting)return M();p(b,[w]);let W=!1;const ee=w._leaveCb=F=>{W||(W=!0,M(),F?p(i,[w]):p(n,[w]),w._leaveCb=void 0,f[A]===t&&delete f[A])};f[A]=t,a?_(a,[w,ee]):ee()},clone(w){return ar(w,E,e,u)}};return T}function Gi(t){if(Ai(t))return t=zt(t),t.children=null,t}function es(t){return Ai(t)?t.children?t.children[0]:void 0:t}function cr(t,E){t.shapeFlag&6&&t.component?cr(t.component.subTree,E):t.shapeFlag&128?(t.ssContent.transition=E.clone(t.ssContent),t.ssFallback.transition=E.clone(t.ssFallback)):t.transition=E}function yo(t,E=!1,e){let u=[],g=0;for(let S=0;S<t.length;S++){let y=t[S];const c=e==null?y.key:String(e)+String(y.key!=null?y.key:S);y.type===gt?(y.patchFlag&128&&g++,u=u.concat(yo(y.children,E,c))):(E||y.type!==Mt)&&u.push(c!=null?zt(y,{key:c}):y)}if(g>1)for(let S=0;S<u.length;S++)u[S].patchFlag=-2;return u}const li=t=>!!t.type.__asyncLoader,Ai=t=>t.type.__isKeepAlive;function Rc(t,E){bo(t,"a",E)}function Ic(t,E){bo(t,"da",E)}function bo(t,E,e=at){const u=t.__wdc||(t.__wdc=()=>{let g=e;for(;g;){if(g.isDeactivated)return;g=g.parent}return t()});if(Oi(E,u,e),e){let g=e.parent;for(;g&&g.parent;)Ai(g.parent.vnode)&&Cc(u,E,e,g),g=g.parent}}function Cc(t,E,e,u){const g=Oi(E,t,u,!0);Eo(()=>{Er(u[E],g)},e)}function Oi(t,E,e=at,u=!1){if(e){const g=e[t]||(e[t]=[]),S=E.__weh||(E.__weh=(...y)=>{if(e.isUnmounted)return;Ln(),Dn(e);const c=St(E,e,t,y);return wn(),Nn(),c});return u?g.unshift(S):g.push(S),S}}const Ft=t=>(E,e=at)=>(!Yn||t==="sp")&&Oi(t,(...u)=>E(...u),e),Mc=Ft("bm"),_o=Ft("m"),Ac=Ft("bu"),Oc=Ft("u"),So=Ft("bum"),Eo=Ft("um"),kc=Ft("sp"),Pc=Ft("rtg"),Dc=Ft("rtc");function xc(t,E=at){Oi("ec",t,E)}function Lc(t,E){const e=yt;if(e===null)return t;const u=Di(e)||e.proxy,g=t.dirs||(t.dirs=[]);for(let S=0;S<E.length;S++){let[y,c,m,h=Qe]=E[S];y&&($e(y)&&(y={mounted:y,updated:y}),y.deep&&Sn(c),g.push({dir:y,instance:u,value:c,oldValue:void 0,arg:m,modifiers:h}))}return t}function hn(t,E,e,u){const g=t.dirs,S=E&&E.dirs;for(let y=0;y<g.length;y++){const c=g[y];S&&(c.oldValue=S[y].value);let m=c.dir[u];m&&(Ln(),St(m,e,8,[t.el,c,t,E]),Nn())}}const wo="components";function Nt(t,E){return Bc(wo,t,!0,E)||t}const Nc=Symbol();function Bc(t,E,e=!0,u=!1){const g=yt||at;if(g){const S=g.type;if(t===wo){const c=hl(S,!1);if(c&&(c===E||c===Dt(E)||c===Ti(Dt(E))))return S}const y=ts(g[t]||S[t],E)||ts(g.appContext[t],E);return!y&&u?S:y}}function ts(t,E){return t&&(t[E]||t[Dt(E)]||t[Ti(Dt(E))])}function To(t,E,e,u){let g;const S=e&&e[u];if(Fe(t)||ct(t)){g=new Array(t.length);for(let y=0,c=t.length;y<c;y++)g[y]=E(t[y],y,void 0,S&&S[y])}else if(typeof t=="number"){g=new Array(t);for(let y=0;y<t;y++)g[y]=E(y+1,y,void 0,S&&S[y])}else if(Xe(t))if(t[Symbol.iterator])g=Array.from(t,(y,c)=>E(y,c,void 0,S&&S[c]));else{const y=Object.keys(t);g=new Array(y.length);for(let c=0,m=y.length;c<m;c++){const h=y[c];g[c]=E(t[h],h,c,S&&S[c])}}else g=[];return e&&(e[u]=g),g}const lr=t=>t?Bo(t)?Di(t)||t.proxy:lr(t.parent):null,Kn=dt(Object.create(null),{$:t=>t,$el:t=>t.vnode.el,$data:t=>t.data,$props:t=>t.props,$attrs:t=>t.attrs,$slots:t=>t.slots,$refs:t=>t.refs,$parent:t=>lr(t.parent),$root:t=>lr(t.root),$emit:t=>t.emit,$options:t=>Lr(t),$forceUpdate:t=>t.f||(t.f=()=>xr(t.update)),$nextTick:t=>t.n||(t.n=lc.bind(t.proxy)),$watch:t=>Ec.bind(t)}),qi=(t,E)=>t!==Qe&&!t.__isScriptSetup&&We(t,E),Uc={get({_:t},E){const{ctx:e,setupState:u,data:g,props:S,accessCache:y,type:c,appContext:m}=t;let h;if(E[0]!=="$"){const n=y[E];if(n!==void 0)switch(n){case 1:return u[E];case 2:return g[E];case 4:return e[E];case 3:return S[E]}else{if(qi(u,E))return y[E]=1,u[E];if(g!==Qe&&We(g,E))return y[E]=2,g[E];if((h=t.propsOptions[0])&&We(h,E))return y[E]=3,S[E];if(e!==Qe&&We(e,E))return y[E]=4,e[E];dr&&(y[E]=0)}}const d=Kn[E];let b,a;if(d)return E==="$attrs"&&mt(t,"get",E),d(t);if((b=c.__cssModules)&&(b=b[E]))return b;if(e!==Qe&&We(e,E))return y[E]=4,e[E];if(a=m.config.globalProperties,We(a,E))return a[E]},set({_:t},E,e){const{data:u,setupState:g,ctx:S}=t;return qi(g,E)?(g[E]=e,!0):u!==Qe&&We(u,E)?(u[E]=e,!0):We(t.props,E)||E[0]==="$"&&E.slice(1)in t?!1:(S[E]=e,!0)},has({_:{data:t,setupState:E,accessCache:e,ctx:u,appContext:g,propsOptions:S}},y){let c;return!!e[y]||t!==Qe&&We(t,y)||qi(E,y)||(c=S[0])&&We(c,y)||We(u,y)||We(Kn,y)||We(g.config.globalProperties,y)},defineProperty(t,E,e){return e.get!=null?t._.accessCache[E]=0:We(e,"value")&&this.set(t,E,e.value,null),Reflect.defineProperty(t,E,e)}};let dr=!0;function Fc(t){const E=Lr(t),e=t.proxy,u=t.ctx;dr=!1,E.beforeCreate&&ns(E.beforeCreate,t,"bc");const{data:g,computed:S,methods:y,watch:c,provide:m,inject:h,created:d,beforeMount:b,mounted:a,beforeUpdate:n,updated:i,activated:r,deactivated:s,beforeDestroy:o,beforeUnmount:l,destroyed:v,unmounted:f,render:p,renderTracked:_,renderTriggered:T,errorCaptured:w,serverPrefetch:M,expose:A,inheritAttrs:W,components:ee,directives:F,filters:C}=E;if(h&&jc(h,u,null,t.appContext.config.unwrapInjectedRef),y)for(const D in y){const j=y[D];$e(j)&&(u[D]=j.bind(e))}if(g){const D=g.call(e,e);Xe(D)&&(t.data=Or(D))}if(dr=!0,S)for(const D in S){const j=S[D],Y=$e(j)?j.bind(e,e):$e(j.get)?j.get.bind(e,e):Ct,q=!$e(j)&&$e(j.set)?j.set.bind(e):Ct,B=gl({get:Y,set:q});Object.defineProperty(u,D,{enumerable:!0,configurable:!0,get:()=>B.value,set:R=>B.value=R})}if(c)for(const D in c)Ro(c[D],u,e,D);if(m){const D=$e(m)?m.call(e):m;Reflect.ownKeys(D).forEach(j=>{Sc(j,D[j])})}d&&ns(d,t,"c");function I(D,j){Fe(j)?j.forEach(Y=>D(Y.bind(e))):j&&D(j.bind(e))}if(I(Mc,b),I(_o,a),I(Ac,n),I(Oc,i),I(Rc,r),I(Ic,s),I(xc,w),I(Dc,_),I(Pc,T),I(So,l),I(Eo,f),I(kc,M),Fe(A))if(A.length){const D=t.exposed||(t.exposed={});A.forEach(j=>{Object.defineProperty(D,j,{get:()=>e[j],set:Y=>e[j]=Y})})}else t.exposed||(t.exposed={});p&&t.render===Ct&&(t.render=p),W!=null&&(t.inheritAttrs=W),ee&&(t.components=ee),F&&(t.directives=F)}function jc(t,E,e=Ct,u=!1){Fe(t)&&(t=ur(t));for(const g in t){const S=t[g];let y;Xe(S)?"default"in S?y=ci(S.from||g,S.default,!0):y=ci(S.from||g):y=ci(S),ht(y)&&u?Object.defineProperty(E,g,{enumerable:!0,configurable:!0,get:()=>y.value,set:c=>y.value=c}):E[g]=y}}function ns(t,E,e){St(Fe(t)?t.map(u=>u.bind(E.proxy)):t.bind(E.proxy),E,e)}function Ro(t,E,e,u){const g=u.includes(".")?go(e,u):()=>e[u];if(ct(t)){const S=E[t];$e(S)&&Wi(g,S)}else if($e(t))Wi(g,t.bind(e));else if(Xe(t))if(Fe(t))t.forEach(S=>Ro(S,E,e,u));else{const S=$e(t.handler)?t.handler.bind(e):E[t.handler];$e(S)&&Wi(g,S,t)}}function Lr(t){const E=t.type,{mixins:e,extends:u}=E,{mixins:g,optionsCache:S,config:{optionMergeStrategies:y}}=t.appContext,c=S.get(E);let m;return c?m=c:!g.length&&!e&&!u?m=E:(m={},g.length&&g.forEach(h=>bi(m,h,y,!0)),bi(m,E,y)),Xe(E)&&S.set(E,m),m}function bi(t,E,e,u=!1){const{mixins:g,extends:S}=E;S&&bi(t,S,e,!0),g&&g.forEach(y=>bi(t,y,e,!0));for(const y in E)if(!(u&&y==="expose")){const c=Kc[y]||e&&e[y];t[y]=c?c(t[y],E[y]):E[y]}return t}const Kc={data:is,props:mn,emits:mn,methods:mn,computed:mn,beforeCreate:pt,created:pt,beforeMount:pt,mounted:pt,beforeUpdate:pt,updated:pt,beforeDestroy:pt,beforeUnmount:pt,destroyed:pt,unmounted:pt,activated:pt,deactivated:pt,errorCaptured:pt,serverPrefetch:pt,components:mn,directives:mn,watch:$c,provide:is,inject:Hc};function is(t,E){return E?t?function(){return dt($e(t)?t.call(this,this):t,$e(E)?E.call(this,this):E)}:E:t}function Hc(t,E){return mn(ur(t),ur(E))}function ur(t){if(Fe(t)){const E={};for(let e=0;e<t.length;e++)E[t[e]]=t[e];return E}return t}function pt(t,E){return t?[...new Set([].concat(t,E))]:E}function mn(t,E){return t?dt(dt(Object.create(null),t),E):E}function $c(t,E){if(!t)return E;if(!E)return t;const e=dt(Object.create(null),t);for(const u in E)e[u]=pt(t[u],E[u]);return e}function Vc(t,E,e,u=!1){const g={},S={};vi(S,Pi,1),t.propsDefaults=Object.create(null),Io(t,E,g,S);for(const y in t.propsOptions[0])y in g||(g[y]=void 0);e?t.props=u?g:ec(g):t.type.props?t.props=g:t.props=S,t.attrs=S}function Wc(t,E,e,u){const{props:g,attrs:S,vnode:{patchFlag:y}}=t,c=ze(g),[m]=t.propsOptions;let h=!1;if((u||y>0)&&!(y&16)){if(y&8){const d=t.vnode.dynamicProps;for(let b=0;b<d.length;b++){let a=d[b];if(Ci(t.emitsOptions,a))continue;const n=E[a];if(m)if(We(S,a))n!==S[a]&&(S[a]=n,h=!0);else{const i=Dt(a);g[i]=fr(m,c,i,n,t,!1)}else n!==S[a]&&(S[a]=n,h=!0)}}}else{Io(t,E,g,S)&&(h=!0);let d;for(const b in c)(!E||!We(E,b)&&((d=Rn(b))===b||!We(E,d)))&&(m?e&&(e[b]!==void 0||e[d]!==void 0)&&(g[b]=fr(m,c,b,void 0,t,!0)):delete g[b]);if(S!==c)for(const b in S)(!E||!We(E,b))&&(delete S[b],h=!0)}h&&Ut(t,"set","$attrs")}function Io(t,E,e,u){const[g,S]=t.propsOptions;let y=!1,c;if(E)for(let m in E){if(oi(m))continue;const h=E[m];let d;g&&We(g,d=Dt(m))?!S||!S.includes(d)?e[d]=h:(c||(c={}))[d]=h:Ci(t.emitsOptions,m)||(!(m in u)||h!==u[m])&&(u[m]=h,y=!0)}if(S){const m=ze(e),h=c||Qe;for(let d=0;d<S.length;d++){const b=S[d];e[b]=fr(g,m,b,h[b],t,!We(h,b))}}return y}function fr(t,E,e,u,g,S){const y=t[e];if(y!=null){const c=We(y,"default");if(c&&u===void 0){const m=y.default;if(y.type!==Function&&$e(m)){const{propsDefaults:h}=g;e in h?u=h[e]:(Dn(g),u=h[e]=m.call(null,E),wn())}else u=m}y[0]&&(S&&!c?u=!1:y[1]&&(u===""||u===Rn(e))&&(u=!0))}return u}function Co(t,E,e=!1){const u=E.propsCache,g=u.get(t);if(g)return g;const S=t.props,y={},c=[];let m=!1;if(!$e(t)){const d=b=>{m=!0;const[a,n]=Co(b,E,!0);dt(y,a),n&&c.push(...n)};!e&&E.mixins.length&&E.mixins.forEach(d),t.extends&&d(t.extends),t.mixins&&t.mixins.forEach(d)}if(!S&&!m)return Xe(t)&&u.set(t,Mn),Mn;if(Fe(S))for(let d=0;d<S.length;d++){const b=Dt(S[d]);rs(b)&&(y[b]=Qe)}else if(S)for(const d in S){const b=Dt(d);if(rs(b)){const a=S[d],n=y[b]=Fe(a)||$e(a)?{type:a}:Object.assign({},a);if(n){const i=as(Boolean,n.type),r=as(String,n.type);n[0]=i>-1,n[1]=r<0||i<r,(i>-1||We(n,"default"))&&c.push(b)}}}const h=[y,c];return Xe(t)&&u.set(t,h),h}function rs(t){return t[0]!=="$"}function ss(t){const E=t&&t.toString().match(/^\s*(function|class) (\w+)/);return E?E[2]:t===null?"null":""}function os(t,E){return ss(t)===ss(E)}function as(t,E){return Fe(E)?E.findIndex(e=>os(e,t)):$e(E)&&os(E,t)?0:-1}const Mo=t=>t[0]==="_"||t==="$stable",Nr=t=>Fe(t)?t.map(Ot):[Ot(t)],Gc=(t,E,e)=>{if(E._n)return E;const u=ho((...g)=>Nr(E(...g)),e);return u._c=!1,u},Ao=(t,E,e)=>{const u=t._ctx;for(const g in t){if(Mo(g))continue;const S=t[g];if($e(S))E[g]=Gc(g,S,u);else if(S!=null){const y=Nr(S);E[g]=()=>y}}},Oo=(t,E)=>{const e=Nr(E);t.slots.default=()=>e},qc=(t,E)=>{if(t.vnode.shapeFlag&32){const e=E._;e?(t.slots=ze(E),vi(E,"_",e)):Ao(E,t.slots={})}else t.slots={},E&&Oo(t,E);vi(t.slots,Pi,1)},zc=(t,E,e)=>{const{vnode:u,slots:g}=t;let S=!0,y=Qe;if(u.shapeFlag&32){const c=E._;c?e&&c===1?S=!1:(dt(g,E),!e&&c===1&&delete g._):(S=!E.$stable,Ao(E,g)),y=E}else E&&(Oo(t,E),y={default:1});if(S)for(const c in g)!Mo(c)&&!(c in y)&&delete g[c]};function ko(){return{app:null,config:{isNativeTag:ma,performance:!1,globalProperties:{},optionMergeStrategies:{},errorHandler:void 0,warnHandler:void 0,compilerOptions:{}},mixins:[],components:{},directives:{},provides:Object.create(null),optionsCache:new WeakMap,propsCache:new WeakMap,emitsCache:new WeakMap}}let Yc=0;function Jc(t,E){return function(u,g=null){$e(u)||(u=Object.assign({},u)),g!=null&&!Xe(g)&&(g=null);const S=ko(),y=new Set;let c=!1;const m=S.app={_uid:Yc++,_component:u,_props:g,_container:null,_context:S,_instance:null,version:bl,get config(){return S.config},set config(h){},use(h,...d){return y.has(h)||(h&&$e(h.install)?(y.add(h),h.install(m,...d)):$e(h)&&(y.add(h),h(m,...d))),m},mixin(h){return S.mixins.includes(h)||S.mixins.push(h),m},component(h,d){return d?(S.components[h]=d,m):S.components[h]},directive(h,d){return d?(S.directives[h]=d,m):S.directives[h]},mount(h,d,b){if(!c){const a=ot(u,g);return a.appContext=S,d&&E?E(a,h):t(a,h,b),c=!0,m._container=h,h.__vue_app__=m,Di(a.component)||a.component.proxy}},unmount(){c&&(t(null,m._container),delete m._container.__vue_app__)},provide(h,d){return S.provides[h]=d,m}};return m}}function hr(t,E,e,u,g=!1){if(Fe(t)){t.forEach((a,n)=>hr(a,E&&(Fe(E)?E[n]:E),e,u,g));return}if(li(u)&&!g)return;const S=u.shapeFlag&4?Di(u.component)||u.component.proxy:u.el,y=g?null:S,{i:c,r:m}=t,h=E&&E.r,d=c.refs===Qe?c.refs={}:c.refs,b=c.setupState;if(h!=null&&h!==m&&(ct(h)?(d[h]=null,We(b,h)&&(b[h]=null)):ht(h)&&(h.value=null)),$e(m))Gt(m,c,12,[y,d]);else{const a=ct(m),n=ht(m);if(a||n){const i=()=>{if(t.f){const r=a?We(b,m)?b[m]:d[m]:m.value;g?Fe(r)&&Er(r,S):Fe(r)?r.includes(S)||r.push(S):a?(d[m]=[S],We(b,m)&&(b[m]=d[m])):(m.value=[S],t.k&&(d[t.k]=m.value))}else a?(d[m]=y,We(b,m)&&(b[m]=y)):n&&(m.value=y,t.k&&(d[t.k]=y))};y?(i.id=-1,vt(i,e)):i()}}}const vt=_c;function Qc(t){return Xc(t)}function Xc(t,E){const e=Ta();e.__VUE__=!0;const{insert:u,remove:g,patchProp:S,createElement:y,createText:c,createComment:m,setText:h,setElementText:d,parentNode:b,nextSibling:a,setScopeId:n=Ct,insertStaticContent:i}=t,r=($,K,re,ue=null,H=null,G=null,U=!1,L=null,z=!!K.dynamicChildren)=>{if($===K)return;$&&!bn($,K)&&(ue=Q($),R($,H,G,!0),$=null),K.patchFlag===-2&&(z=!1,K.dynamicChildren=null);const{type:J,ref:ne,shapeFlag:oe}=K;switch(J){case ki:s($,K,re,ue);break;case Mt:o($,K,re,ue);break;case di:$==null&&l(K,re,ue,U);break;case gt:ee($,K,re,ue,H,G,U,L,z);break;default:oe&1?p($,K,re,ue,H,G,U,L,z):oe&6?F($,K,re,ue,H,G,U,L,z):(oe&64||oe&128)&&J.process($,K,re,ue,H,G,U,L,z,ae)}ne!=null&&H&&hr(ne,$&&$.ref,G,K||$,!K)},s=($,K,re,ue)=>{if($==null)u(K.el=c(K.children),re,ue);else{const H=K.el=$.el;K.children!==$.children&&h(H,K.children)}},o=($,K,re,ue)=>{$==null?u(K.el=m(K.children||""),re,ue):K.el=$.el},l=($,K,re,ue)=>{[$.el,$.anchor]=i($.children,K,re,ue,$.el,$.anchor)},v=({el:$,anchor:K},re,ue)=>{let H;for(;$&&$!==K;)H=a($),u($,re,ue),$=H;u(K,re,ue)},f=({el:$,anchor:K})=>{let re;for(;$&&$!==K;)re=a($),g($),$=re;g(K)},p=($,K,re,ue,H,G,U,L,z)=>{U=U||K.type==="svg",$==null?_(K,re,ue,H,G,U,L,z):M($,K,H,G,U,L,z)},_=($,K,re,ue,H,G,U,L)=>{let z,J;const{type:ne,props:oe,shapeFlag:ce,transition:pe,dirs:he}=$;if(z=$.el=y($.type,G,oe&&oe.is,oe),ce&8?d(z,$.children):ce&16&&w($.children,z,null,ue,H,G&&ne!=="foreignObject",U,L),he&&hn($,null,ue,"created"),T(z,$,$.scopeId,U,ue),oe){for(const ve in oe)ve!=="value"&&!oi(ve)&&S(z,ve,null,oe[ve],G,$.children,ue,H,x);"value"in oe&&S(z,"value",null,oe.value),(J=oe.onVnodeBeforeMount)&&At(J,ue,$)}he&&hn($,null,ue,"beforeMount");const fe=(!H||H&&!H.pendingBranch)&&pe&&!pe.persisted;fe&&pe.beforeEnter(z),u(z,K,re),((J=oe&&oe.onVnodeMounted)||fe||he)&&vt(()=>{J&&At(J,ue,$),fe&&pe.enter(z),he&&hn($,null,ue,"mounted")},H)},T=($,K,re,ue,H)=>{if(re&&n($,re),ue)for(let G=0;G<ue.length;G++)n($,ue[G]);if(H){let G=H.subTree;if(K===G){const U=H.vnode;T($,U,U.scopeId,U.slotScopeIds,H.parent)}}},w=($,K,re,ue,H,G,U,L,z=0)=>{for(let J=z;J<$.length;J++){const ne=$[J]=L?Vt($[J]):Ot($[J]);r(null,ne,K,re,ue,H,G,U,L)}},M=($,K,re,ue,H,G,U)=>{const L=K.el=$.el;let{patchFlag:z,dynamicChildren:J,dirs:ne}=K;z|=$.patchFlag&16;const oe=$.props||Qe,ce=K.props||Qe;let pe;re&&pn(re,!1),(pe=ce.onVnodeBeforeUpdate)&&At(pe,re,K,$),ne&&hn(K,$,re,"beforeUpdate"),re&&pn(re,!0);const he=H&&K.type!=="foreignObject";if(J?A($.dynamicChildren,J,L,re,ue,he,G):U||j($,K,L,null,re,ue,he,G,!1),z>0){if(z&16)W(L,K,oe,ce,re,ue,H);else if(z&2&&oe.class!==ce.class&&S(L,"class",null,ce.class,H),z&4&&S(L,"style",oe.style,ce.style,H),z&8){const fe=K.dynamicProps;for(let ve=0;ve<fe.length;ve++){const ye=fe[ve],Ee=oe[ye],we=ce[ye];(we!==Ee||ye==="value")&&S(L,ye,Ee,we,H,$.children,re,ue,x)}}z&1&&$.children!==K.children&&d(L,K.children)}else!U&&J==null&&W(L,K,oe,ce,re,ue,H);((pe=ce.onVnodeUpdated)||ne)&&vt(()=>{pe&&At(pe,re,K,$),ne&&hn(K,$,re,"updated")},ue)},A=($,K,re,ue,H,G,U)=>{for(let L=0;L<K.length;L++){const z=$[L],J=K[L],ne=z.el&&(z.type===gt||!bn(z,J)||z.shapeFlag&70)?b(z.el):re;r(z,J,ne,null,ue,H,G,U,!0)}},W=($,K,re,ue,H,G,U)=>{if(re!==ue){if(re!==Qe)for(const L in re)!oi(L)&&!(L in ue)&&S($,L,re[L],null,U,K.children,H,G,x);for(const L in ue){if(oi(L))continue;const z=ue[L],J=re[L];z!==J&&L!=="value"&&S($,L,J,z,U,K.children,H,G,x)}"value"in ue&&S($,"value",re.value,ue.value)}},ee=($,K,re,ue,H,G,U,L,z)=>{const J=K.el=$?$.el:c(""),ne=K.anchor=$?$.anchor:c("");let{patchFlag:oe,dynamicChildren:ce,slotScopeIds:pe}=K;pe&&(L=L?L.concat(pe):pe),$==null?(u(J,re,ue),u(ne,re,ue),w(K.children,re,ne,H,G,U,L,z)):oe>0&&oe&64&&ce&&$.dynamicChildren?(A($.dynamicChildren,ce,re,H,G,U,L),(K.key!=null||H&&K===H.subTree)&&Po($,K,!0)):j($,K,re,ne,H,G,U,L,z)},F=($,K,re,ue,H,G,U,L,z)=>{K.slotScopeIds=L,$==null?K.shapeFlag&512?H.ctx.activate(K,re,ue,U,z):C(K,re,ue,H,G,U,z):O($,K,z)},C=($,K,re,ue,H,G,U)=>{const L=$.component=al($,ue,H);if(Ai($)&&(L.ctx.renderer=ae),ll(L),L.asyncDep){if(H&&H.registerDep(L,I),!$.el){const z=L.subTree=ot(Mt);o(null,z,K,re)}return}I(L,$,K,re,H,G,U)},O=($,K,re)=>{const ue=K.component=$.component;if(mc($,K,re))if(ue.asyncDep&&!ue.asyncResolved){D(ue,K,re);return}else ue.next=K,uc(ue.update),ue.update();else K.el=$.el,ue.vnode=K},I=($,K,re,ue,H,G,U)=>{const L=()=>{if($.isMounted){let{next:ne,bu:oe,u:ce,parent:pe,vnode:he}=$,fe=ne,ve;pn($,!1),ne?(ne.el=he.el,D($,ne,U)):ne=he,oe&&ai(oe),(ve=ne.props&&ne.props.onVnodeBeforeUpdate)&&At(ve,pe,ne,he),pn($,!0);const ye=Vi($),Ee=$.subTree;$.subTree=ye,r(Ee,ye,b(Ee.el),Q(Ee),$,H,G),ne.el=ye.el,fe===null&&yc($,ye.el),ce&&vt(ce,H),(ve=ne.props&&ne.props.onVnodeUpdated)&&vt(()=>At(ve,pe,ne,he),H)}else{let ne;const{el:oe,props:ce}=K,{bm:pe,m:he,parent:fe}=$,ve=li(K);if(pn($,!1),pe&&ai(pe),!ve&&(ne=ce&&ce.onVnodeBeforeMount)&&At(ne,fe,K),pn($,!0),oe&&X){const ye=()=>{$.subTree=Vi($),X(oe,$.subTree,$,H,null)};ve?K.type.__asyncLoader().then(()=>!$.isUnmounted&&ye()):ye()}else{const ye=$.subTree=Vi($);r(null,ye,re,ue,$,H,G),K.el=ye.el}if(he&&vt(he,H),!ve&&(ne=ce&&ce.onVnodeMounted)){const ye=K;vt(()=>At(ne,fe,ye),H)}(K.shapeFlag&256||fe&&li(fe.vnode)&&fe.vnode.shapeFlag&256)&&$.a&&vt($.a,H),$.isMounted=!0,K=re=ue=null}},z=$.effect=new Ir(L,()=>xr(J),$.scope),J=$.update=()=>z.run();J.id=$.uid,pn($,!0),J()},D=($,K,re)=>{K.component=$;const ue=$.vnode.props;$.vnode=K,$.next=null,Wc($,K.props,ue,re),zc($,K.children,re),Ln(),Xr(),Nn()},j=($,K,re,ue,H,G,U,L,z=!1)=>{const J=$&&$.children,ne=$?$.shapeFlag:0,oe=K.children,{patchFlag:ce,shapeFlag:pe}=K;if(ce>0){if(ce&128){q(J,oe,re,ue,H,G,U,L,z);return}else if(ce&256){Y(J,oe,re,ue,H,G,U,L,z);return}}pe&8?(ne&16&&x(J,H,G),oe!==J&&d(re,oe)):ne&16?pe&16?q(J,oe,re,ue,H,G,U,L,z):x(J,H,G,!0):(ne&8&&d(re,""),pe&16&&w(oe,re,ue,H,G,U,L,z))},Y=($,K,re,ue,H,G,U,L,z)=>{$=$||Mn,K=K||Mn;const J=$.length,ne=K.length,oe=Math.min(J,ne);let ce;for(ce=0;ce<oe;ce++){const pe=K[ce]=z?Vt(K[ce]):Ot(K[ce]);r($[ce],pe,re,null,H,G,U,L,z)}J>ne?x($,H,G,!0,!1,oe):w(K,re,ue,H,G,U,L,z,oe)},q=($,K,re,ue,H,G,U,L,z)=>{let J=0;const ne=K.length;let oe=$.length-1,ce=ne-1;for(;J<=oe&&J<=ce;){const pe=$[J],he=K[J]=z?Vt(K[J]):Ot(K[J]);if(bn(pe,he))r(pe,he,re,null,H,G,U,L,z);else break;J++}for(;J<=oe&&J<=ce;){const pe=$[oe],he=K[ce]=z?Vt(K[ce]):Ot(K[ce]);if(bn(pe,he))r(pe,he,re,null,H,G,U,L,z);else break;oe--,ce--}if(J>oe){if(J<=ce){const pe=ce+1,he=pe<ne?K[pe].el:ue;for(;J<=ce;)r(null,K[J]=z?Vt(K[J]):Ot(K[J]),re,he,H,G,U,L,z),J++}}else if(J>ce)for(;J<=oe;)R($[J],H,G,!0),J++;else{const pe=J,he=J,fe=new Map;for(J=he;J<=ce;J++){const ie=K[J]=z?Vt(K[J]):Ot(K[J]);ie.key!=null&&fe.set(ie.key,J)}let ve,ye=0;const Ee=ce-he+1;let we=!1,me=0;const N=new Array(Ee);for(J=0;J<Ee;J++)N[J]=0;for(J=pe;J<=oe;J++){const ie=$[J];if(ye>=Ee){R(ie,H,G,!0);continue}let se;if(ie.key!=null)se=fe.get(ie.key);else for(ve=he;ve<=ce;ve++)if(N[ve-he]===0&&bn(ie,K[ve])){se=ve;break}se===void 0?R(ie,H,G,!0):(N[se-he]=J+1,se>=me?me=se:we=!0,r(ie,K[se],re,null,H,G,U,L,z),ye++)}const Z=we?Zc(N):Mn;for(ve=Z.length-1,J=Ee-1;J>=0;J--){const ie=he+J,se=K[ie],le=ie+1<ne?K[ie+1].el:ue;N[J]===0?r(null,se,re,le,H,G,U,L,z):we&&(ve<0||J!==Z[ve]?B(se,re,le,2):ve--)}}},B=($,K,re,ue,H=null)=>{const{el:G,type:U,transition:L,children:z,shapeFlag:J}=$;if(J&6){B($.component.subTree,K,re,ue);return}if(J&128){$.suspense.move(K,re,ue);return}if(J&64){U.move($,K,re,ae);return}if(U===gt){u(G,K,re);for(let oe=0;oe<z.length;oe++)B(z[oe],K,re,ue);u($.anchor,K,re);return}if(U===di){v($,K,re);return}if(ue!==2&&J&1&&L)if(ue===0)L.beforeEnter(G),u(G,K,re),vt(()=>L.enter(G),H);else{const{leave:oe,delayLeave:ce,afterLeave:pe}=L,he=()=>u(G,K,re),fe=()=>{oe(G,()=>{he(),pe&&pe()})};ce?ce(G,he,fe):fe()}else u(G,K,re)},R=($,K,re,ue=!1,H=!1)=>{const{type:G,props:U,ref:L,children:z,dynamicChildren:J,shapeFlag:ne,patchFlag:oe,dirs:ce}=$;if(L!=null&&hr(L,null,re,$,!0),ne&256){K.ctx.deactivate($);return}const pe=ne&1&&ce,he=!li($);let fe;if(he&&(fe=U&&U.onVnodeBeforeUnmount)&&At(fe,K,$),ne&6)V($.component,re,ue);else{if(ne&128){$.suspense.unmount(re,ue);return}pe&&hn($,null,K,"beforeUnmount"),ne&64?$.type.remove($,K,re,H,ae,ue):J&&(G!==gt||oe>0&&oe&64)?x(J,K,re,!1,!0):(G===gt&&oe&384||!H&&ne&16)&&x(z,K,re),ue&&k($)}(he&&(fe=U&&U.onVnodeUnmounted)||pe)&&vt(()=>{fe&&At(fe,K,$),pe&&hn($,null,K,"unmounted")},re)},k=$=>{const{type:K,el:re,anchor:ue,transition:H}=$;if(K===gt){P(re,ue);return}if(K===di){f($);return}const G=()=>{g(re),H&&!H.persisted&&H.afterLeave&&H.afterLeave()};if($.shapeFlag&1&&H&&!H.persisted){const{leave:U,delayLeave:L}=H,z=()=>U(re,G);L?L($.el,G,z):z()}else G()},P=($,K)=>{let re;for(;$!==K;)re=a($),g($),$=re;g(K)},V=($,K,re)=>{const{bum:ue,scope:H,update:G,subTree:U,um:L}=$;ue&&ai(ue),H.stop(),G&&(G.active=!1,R(U,$,K,re)),L&&vt(L,K),vt(()=>{$.isUnmounted=!0},K),K&&K.pendingBranch&&!K.isUnmounted&&$.asyncDep&&!$.asyncResolved&&$.suspenseId===K.pendingId&&(K.deps--,K.deps===0&&K.resolve())},x=($,K,re,ue=!1,H=!1,G=0)=>{for(let U=G;U<$.length;U++)R($[U],K,re,ue,H)},Q=$=>$.shapeFlag&6?Q($.component.subTree):$.shapeFlag&128?$.suspense.next():a($.anchor||$.el),te=($,K,re)=>{$==null?K._vnode&&R(K._vnode,null,null,!0):r(K._vnode||null,$,K,null,null,null,re),Xr(),ao(),K._vnode=$},ae={p:r,um:R,m:B,r:k,mt:C,mc:w,pc:j,pbc:A,n:Q,o:t};let de,X;return E&&([de,X]=E(ae)),{render:te,hydrate:de,createApp:Jc(te,de)}}function pn({effect:t,update:E},e){t.allowRecurse=E.allowRecurse=e}function Po(t,E,e=!1){const u=t.children,g=E.children;if(Fe(u)&&Fe(g))for(let S=0;S<u.length;S++){const y=u[S];let c=g[S];c.shapeFlag&1&&!c.dynamicChildren&&((c.patchFlag<=0||c.patchFlag===32)&&(c=g[S]=Vt(g[S]),c.el=y.el),e||Po(y,c)),c.type===ki&&(c.el=y.el)}}function Zc(t){const E=t.slice(),e=[0];let u,g,S,y,c;const m=t.length;for(u=0;u<m;u++){const h=t[u];if(h!==0){if(g=e[e.length-1],t[g]<h){E[u]=g,e.push(u);continue}for(S=0,y=e.length-1;S<y;)c=S+y>>1,t[e[c]]<h?S=c+1:y=c;h<t[e[S]]&&(S>0&&(E[u]=e[S-1]),e[S]=u)}}for(S=e.length,y=e[S-1];S-- >0;)e[S]=y,y=E[y];return e}const el=t=>t.__isTeleport,gt=Symbol(void 0),ki=Symbol(void 0),Mt=Symbol(void 0),di=Symbol(void 0),Hn=[];let It=null;function qe(t=!1){Hn.push(It=t?null:[])}function tl(){Hn.pop(),It=Hn[Hn.length-1]||null}let zn=1;function cs(t){zn+=t}function Do(t){return t.dynamicChildren=zn>0?It||Mn:null,tl(),zn>0&&It&&It.push(t),t}function Ye(t,E,e,u,g,S){return Do(Le(t,E,e,u,g,S,!0))}function xo(t,E,e,u,g){return Do(ot(t,E,e,u,g,!0))}function pr(t){return t?t.__v_isVNode===!0:!1}function bn(t,E){return t.type===E.type&&t.key===E.key}const Pi="__vInternal",Lo=({key:t})=>t??null,ui=({ref:t,ref_key:E,ref_for:e})=>t!=null?ct(t)||ht(t)||$e(t)?{i:yt,r:t,k:E,f:!!e}:t:null;function Le(t,E=null,e=null,u=0,g=null,S=t===gt?0:1,y=!1,c=!1){const m={__v_isVNode:!0,__v_skip:!0,type:t,props:E,key:E&&Lo(E),ref:E&&ui(E),scopeId:Mi,slotScopeIds:null,children:e,component:null,suspense:null,ssContent:null,ssFallback:null,dirs:null,transition:null,el:null,anchor:null,target:null,targetAnchor:null,staticCount:0,shapeFlag:S,patchFlag:u,dynamicProps:g,dynamicChildren:null,appContext:null,ctx:yt};return c?(Br(m,e),S&128&&t.normalize(m)):e&&(m.shapeFlag|=ct(e)?8:16),zn>0&&!y&&It&&(m.patchFlag>0||S&6)&&m.patchFlag!==32&&It.push(m),m}const ot=nl;function nl(t,E=null,e=null,u=0,g=null,S=!1){if((!t||t===Nc)&&(t=Mt),pr(t)){const c=zt(t,E,!0);return e&&Br(c,e),zn>0&&!S&&It&&(c.shapeFlag&6?It[It.indexOf(t)]=c:It.push(c)),c.patchFlag|=-2,c}if(pl(t)&&(t=t.__vccOpts),E){E=il(E);let{class:c,style:m}=E;c&&!ct(c)&&(E.class=$n(c)),Xe(m)&&(Zs(m)&&!Fe(m)&&(m=dt({},m)),E.style=st(m))}const y=ct(t)?1:bc(t)?128:el(t)?64:Xe(t)?4:$e(t)?2:0;return Le(t,E,e,u,g,y,S,!0)}function il(t){return t?Zs(t)||Pi in t?dt({},t):t:null}function zt(t,E,e=!1){const{props:u,ref:g,patchFlag:S,children:y}=t,c=E?rl(u||{},E):u;return{__v_isVNode:!0,__v_skip:!0,type:t.type,props:c,key:c&&Lo(c),ref:E&&E.ref?e&&g?Fe(g)?g.concat(ui(E)):[g,ui(E)]:ui(E):g,scopeId:t.scopeId,slotScopeIds:t.slotScopeIds,children:y,target:t.target,targetAnchor:t.targetAnchor,staticCount:t.staticCount,shapeFlag:t.shapeFlag,patchFlag:E&&t.type!==gt?S===-1?16:S|16:S,dynamicProps:t.dynamicProps,dynamicChildren:t.dynamicChildren,appContext:t.appContext,dirs:t.dirs,transition:t.transition,component:t.component,suspense:t.suspense,ssContent:t.ssContent&&zt(t.ssContent),ssFallback:t.ssFallback&&zt(t.ssFallback),el:t.el,anchor:t.anchor,ctx:t.ctx,ce:t.ce}}function Tn(t=" ",E=0){return ot(ki,null,t,E)}function No(t,E){const e=ot(di,null,t);return e.staticCount=E,e}function _t(t="",E=!1){return E?(qe(),xo(Mt,null,t)):ot(Mt,null,t)}function Ot(t){return t==null||typeof t=="boolean"?ot(Mt):Fe(t)?ot(gt,null,t.slice()):typeof t=="object"?Vt(t):ot(ki,null,String(t))}function Vt(t){return t.el===null&&t.patchFlag!==-1||t.memo?t:zt(t)}function Br(t,E){let e=0;const{shapeFlag:u}=t;if(E==null)E=null;else if(Fe(E))e=16;else if(typeof E=="object")if(u&65){const g=E.default;g&&(g._c&&(g._d=!1),Br(t,g()),g._c&&(g._d=!0));return}else{e=32;const g=E._;!g&&!(Pi in E)?E._ctx=yt:g===3&&yt&&(yt.slots._===1?E._=1:(E._=2,t.patchFlag|=1024))}else $e(E)?(E={default:E,_ctx:yt},e=32):(E=String(E),u&64?(e=16,E=[Tn(E)]):e=8);t.children=E,t.shapeFlag|=e}function rl(...t){const E={};for(let e=0;e<t.length;e++){const u=t[e];for(const g in u)if(g==="class")E.class!==u.class&&(E.class=$n([E.class,u.class]));else if(g==="style")E.style=st([E.style,u.style]);else if(Si(g)){const S=E[g],y=u[g];y&&S!==y&&!(Fe(S)&&S.includes(y))&&(E[g]=S?[].concat(S,y):y)}else g!==""&&(E[g]=u[g])}return E}function At(t,E,e,u=null){St(t,E,7,[e,u])}const sl=ko();let ol=0;function al(t,E,e){const u=t.type,g=(E?E.appContext:t.appContext)||sl,S={uid:ol++,vnode:t,type:u,parent:E,appContext:g,root:null,next:null,subTree:null,effect:null,update:null,scope:new Ra(!0),render:null,proxy:null,exposed:null,exposeProxy:null,withProxy:null,provides:E?E.provides:Object.create(g.provides),accessCache:null,renderCache:[],components:null,directives:null,propsOptions:Co(u,g),emitsOptions:lo(u,g),emit:null,emitted:null,propsDefaults:Qe,inheritAttrs:u.inheritAttrs,ctx:Qe,data:Qe,props:Qe,attrs:Qe,slots:Qe,refs:Qe,setupState:Qe,setupContext:null,suspense:e,suspenseId:e?e.pendingId:0,asyncDep:null,asyncResolved:!1,isMounted:!1,isUnmounted:!1,isDeactivated:!1,bc:null,c:null,bm:null,m:null,bu:null,u:null,um:null,bum:null,da:null,a:null,rtg:null,rtc:null,ec:null,sp:null};return S.ctx={_:S},S.root=E?E.root:S,S.emit=pc.bind(null,S),t.ce&&t.ce(S),S}let at=null;const cl=()=>at||yt,Dn=t=>{at=t,t.scope.on()},wn=()=>{at&&at.scope.off(),at=null};function Bo(t){return t.vnode.shapeFlag&4}let Yn=!1;function ll(t,E=!1){Yn=E;const{props:e,children:u}=t.vnode,g=Bo(t);Vc(t,e,g,E),qc(t,u);const S=g?dl(t,E):void 0;return Yn=!1,S}function dl(t,E){const e=t.type;t.accessCache=Object.create(null),t.proxy=eo(new Proxy(t.ctx,Uc));const{setup:u}=e;if(u){const g=t.setupContext=u.length>1?fl(t):null;Dn(t),Ln();const S=Gt(u,t,0,[t.props,g]);if(Nn(),wn(),Fs(S)){if(S.then(wn,wn),E)return S.then(y=>{ls(t,y,E)}).catch(y=>{Ii(y,t,0)});t.asyncDep=S}else ls(t,S,E)}else Uo(t,E)}function ls(t,E,e){$e(E)?t.type.__ssrInlineRender?t.ssrRender=E:t.render=E:Xe(E)&&(t.setupState=io(E)),Uo(t,e)}let ds;function Uo(t,E,e){const u=t.type;if(!t.render){if(!E&&ds&&!u.render){const g=u.template||Lr(t).template;if(g){const{isCustomElement:S,compilerOptions:y}=t.appContext.config,{delimiters:c,compilerOptions:m}=u,h=dt(dt({isCustomElement:S,delimiters:c},y),m);u.render=ds(g,h)}}t.render=u.render||Ct}Dn(t),Ln(),Fc(t),Nn(),wn()}function ul(t){return new Proxy(t.attrs,{get(E,e){return mt(t,"get","$attrs"),E[e]}})}function fl(t){const E=u=>{t.exposed=u||{}};let e;return{get attrs(){return e||(e=ul(t))},slots:t.slots,emit:t.emit,expose:E}}function Di(t){if(t.exposed)return t.exposeProxy||(t.exposeProxy=new Proxy(io(eo(t.exposed)),{get(E,e){if(e in E)return E[e];if(e in Kn)return Kn[e](t)},has(E,e){return e in E||e in Kn}}))}function hl(t,E=!0){return $e(t)?t.displayName||t.name:t.name||E&&t.__name}function pl(t){return $e(t)&&"__vccOpts"in t}const gl=(t,E)=>ac(t,E,Yn);function vl(t,E,e){const u=arguments.length;return u===2?Xe(E)&&!Fe(E)?pr(E)?ot(t,null,[E]):ot(t,E):ot(t,null,E):(u>3?e=Array.prototype.slice.call(arguments,2):u===3&&pr(e)&&(e=[e]),ot(t,E,e))}const ml=Symbol(""),yl=()=>ci(ml),bl="3.2.47",_l="http://www.w3.org/2000/svg",_n=typeof document<"u"?document:null,us=_n&&_n.createElement("template"),Sl={insert:(t,E,e)=>{E.insertBefore(t,e||null)},remove:t=>{const E=t.parentNode;E&&E.removeChild(t)},createElement:(t,E,e,u)=>{const g=E?_n.createElementNS(_l,t):_n.createElement(t,e?{is:e}:void 0);return t==="select"&&u&&u.multiple!=null&&g.setAttribute("multiple",u.multiple),g},createText:t=>_n.createTextNode(t),createComment:t=>_n.createComment(t),setText:(t,E)=>{t.nodeValue=E},setElementText:(t,E)=>{t.textContent=E},parentNode:t=>t.parentNode,nextSibling:t=>t.nextSibling,querySelector:t=>_n.querySelector(t),setScopeId(t,E){t.setAttribute(E,"")},insertStaticContent(t,E,e,u,g,S){const y=e?e.previousSibling:E.lastChild;if(g&&(g===S||g.nextSibling))for(;E.insertBefore(g.cloneNode(!0),e),!(g===S||!(g=g.nextSibling)););else{us.innerHTML=u?`<svg>${t}</svg>`:t;const c=us.content;if(u){const m=c.firstChild;for(;m.firstChild;)c.appendChild(m.firstChild);c.removeChild(m)}E.insertBefore(c,e)}return[y?y.nextSibling:E.firstChild,e?e.previousSibling:E.lastChild]}};function El(t,E,e){const u=t._vtc;u&&(E=(E?[E,...u]:[...u]).join(" ")),E==null?t.removeAttribute("class"):e?t.setAttribute("class",E):t.className=E}function wl(t,E,e){const u=t.style,g=ct(e);if(e&&!g){if(E&&!ct(E))for(const S in E)e[S]==null&&gr(u,S,"");for(const S in e)gr(u,S,e[S])}else{const S=u.display;g?E!==e&&(u.cssText=e):E&&t.removeAttribute("style"),"_vod"in t&&(u.display=S)}}const fs=/\s*!important$/;function gr(t,E,e){if(Fe(e))e.forEach(u=>gr(t,E,u));else if(e==null&&(e=""),E.startsWith("--"))t.setProperty(E,e);else{const u=Tl(t,E);fs.test(e)?t.setProperty(Rn(u),e.replace(fs,""),"important"):t[u]=e}}const hs=["Webkit","Moz","ms"],zi={};function Tl(t,E){const e=zi[E];if(e)return e;let u=Dt(E);if(u!=="filter"&&u in t)return zi[E]=u;u=Ti(u);for(let g=0;g<hs.length;g++){const S=hs[g]+u;if(S in t)return zi[E]=S}return E}const ps="http://www.w3.org/1999/xlink";function Rl(t,E,e,u,g){if(u&&E.startsWith("xlink:"))e==null?t.removeAttributeNS(ps,E.slice(6,E.length)):t.setAttributeNS(ps,E,e);else{const S=va(E);e==null||S&&!Ns(e)?t.removeAttribute(E):t.setAttribute(E,S?"":e)}}function Il(t,E,e,u,g,S,y){if(E==="innerHTML"||E==="textContent"){u&&y(u,g,S),t[E]=e??"";return}if(E==="value"&&t.tagName!=="PROGRESS"&&!t.tagName.includes("-")){t._value=e;const m=e??"";(t.value!==m||t.tagName==="OPTION")&&(t.value=m),e==null&&t.removeAttribute(E);return}let c=!1;if(e===""||e==null){const m=typeof t[E];m==="boolean"?e=Ns(e):e==null&&m==="string"?(e="",c=!0):m==="number"&&(e=0,c=!0)}try{t[E]=e}catch{}c&&t.removeAttribute(E)}function Cn(t,E,e,u){t.addEventListener(E,e,u)}function Cl(t,E,e,u){t.removeEventListener(E,e,u)}function Ml(t,E,e,u,g=null){const S=t._vei||(t._vei={}),y=S[E];if(u&&y)y.value=u;else{const[c,m]=Al(E);if(u){const h=S[E]=Pl(u,g);Cn(t,c,h,m)}else y&&(Cl(t,c,y,m),S[E]=void 0)}}const gs=/(?:Once|Passive|Capture)$/;function Al(t){let E;if(gs.test(t)){E={};let u;for(;u=t.match(gs);)t=t.slice(0,t.length-u[0].length),E[u[0].toLowerCase()]=!0}return[t[2]===":"?t.slice(3):Rn(t.slice(2)),E]}let Yi=0;const Ol=Promise.resolve(),kl=()=>Yi||(Ol.then(()=>Yi=0),Yi=Date.now());function Pl(t,E){const e=u=>{if(!u._vts)u._vts=Date.now();else if(u._vts<=e.attached)return;St(Dl(u,e.value),E,5,[u])};return e.value=t,e.attached=kl(),e}function Dl(t,E){if(Fe(E)){const e=t.stopImmediatePropagation;return t.stopImmediatePropagation=()=>{e.call(t),t._stopped=!0},E.map(u=>g=>!g._stopped&&u&&u(g))}else return E}const vs=/^on[a-z]/,xl=(t,E,e,u,g=!1,S,y,c,m)=>{E==="class"?El(t,u,g):E==="style"?wl(t,e,u):Si(E)?Sr(E)||Ml(t,E,e,u,y):(E[0]==="."?(E=E.slice(1),!0):E[0]==="^"?(E=E.slice(1),!1):Ll(t,E,u,g))?Il(t,E,u,S,y,c,m):(E==="true-value"?t._trueValue=u:E==="false-value"&&(t._falseValue=u),Rl(t,E,u,g))};function Ll(t,E,e,u){return u?!!(E==="innerHTML"||E==="textContent"||E in t&&vs.test(E)&&$e(e)):E==="spellcheck"||E==="draggable"||E==="translate"||E==="form"||E==="list"&&t.tagName==="INPUT"||E==="type"&&t.tagName==="TEXTAREA"||vs.test(E)&&ct(e)?!1:E in t}const Kt="transition",Un="animation",Ur=(t,{slots:E})=>vl(vo,Nl(t),E);Ur.displayName="Transition";const Fo={name:String,type:String,css:{type:Boolean,default:!0},duration:[String,Number,Object],enterFromClass:String,enterActiveClass:String,enterToClass:String,appearFromClass:String,appearActiveClass:String,appearToClass:String,leaveFromClass:String,leaveActiveClass:String,leaveToClass:String};Ur.props=dt({},vo.props,Fo);const gn=(t,E=[])=>{Fe(t)?t.forEach(e=>e(...E)):t&&t(...E)},ms=t=>t?Fe(t)?t.some(E=>E.length>1):t.length>1:!1;function Nl(t){const E={};for(const ee in t)ee in Fo||(E[ee]=t[ee]);if(t.css===!1)return E;const{name:e="v",type:u,duration:g,enterFromClass:S=`${e}-enter-from`,enterActiveClass:y=`${e}-enter-active`,enterToClass:c=`${e}-enter-to`,appearFromClass:m=S,appearActiveClass:h=y,appearToClass:d=c,leaveFromClass:b=`${e}-leave-from`,leaveActiveClass:a=`${e}-leave-active`,leaveToClass:n=`${e}-leave-to`}=t,i=Bl(g),r=i&&i[0],s=i&&i[1],{onBeforeEnter:o,onEnter:l,onEnterCancelled:v,onLeave:f,onLeaveCancelled:p,onBeforeAppear:_=o,onAppear:T=l,onAppearCancelled:w=v}=E,M=(ee,F,C)=>{vn(ee,F?d:c),vn(ee,F?h:y),C&&C()},A=(ee,F)=>{ee._isLeaving=!1,vn(ee,b),vn(ee,n),vn(ee,a),F&&F()},W=ee=>(F,C)=>{const O=ee?T:l,I=()=>M(F,ee,C);gn(O,[F,I]),ys(()=>{vn(F,ee?m:S),Ht(F,ee?d:c),ms(O)||bs(F,u,r,I)})};return dt(E,{onBeforeEnter(ee){gn(o,[ee]),Ht(ee,S),Ht(ee,y)},onBeforeAppear(ee){gn(_,[ee]),Ht(ee,m),Ht(ee,h)},onEnter:W(!1),onAppear:W(!0),onLeave(ee,F){ee._isLeaving=!0;const C=()=>A(ee,F);Ht(ee,b),jl(),Ht(ee,a),ys(()=>{ee._isLeaving&&(vn(ee,b),Ht(ee,n),ms(f)||bs(ee,u,s,C))}),gn(f,[ee,C])},onEnterCancelled(ee){M(ee,!1),gn(v,[ee])},onAppearCancelled(ee){M(ee,!0),gn(w,[ee])},onLeaveCancelled(ee){A(ee),gn(p,[ee])}})}function Bl(t){if(t==null)return null;if(Xe(t))return[Ji(t.enter),Ji(t.leave)];{const E=Ji(t);return[E,E]}}function Ji(t){return wa(t)}function Ht(t,E){E.split(/\s+/).forEach(e=>e&&t.classList.add(e)),(t._vtc||(t._vtc=new Set)).add(E)}function vn(t,E){E.split(/\s+/).forEach(u=>u&&t.classList.remove(u));const{_vtc:e}=t;e&&(e.delete(E),e.size||(t._vtc=void 0))}function ys(t){requestAnimationFrame(()=>{requestAnimationFrame(t)})}let Ul=0;function bs(t,E,e,u){const g=t._endId=++Ul,S=()=>{g===t._endId&&u()};if(e)return setTimeout(S,e);const{type:y,timeout:c,propCount:m}=Fl(t,E);if(!y)return u();const h=y+"end";let d=0;const b=()=>{t.removeEventListener(h,a),S()},a=n=>{n.target===t&&++d>=m&&b()};setTimeout(()=>{d<m&&b()},c+1),t.addEventListener(h,a)}function Fl(t,E){const e=window.getComputedStyle(t),u=i=>(e[i]||"").split(", "),g=u(`${Kt}Delay`),S=u(`${Kt}Duration`),y=_s(g,S),c=u(`${Un}Delay`),m=u(`${Un}Duration`),h=_s(c,m);let d=null,b=0,a=0;E===Kt?y>0&&(d=Kt,b=y,a=S.length):E===Un?h>0&&(d=Un,b=h,a=m.length):(b=Math.max(y,h),d=b>0?y>h?Kt:Un:null,a=d?d===Kt?S.length:m.length:0);const n=d===Kt&&/\b(transform|all)(,|$)/.test(u(`${Kt}Property`).toString());return{type:d,timeout:b,propCount:a,hasTransform:n}}function _s(t,E){for(;t.length<E.length;)t=t.concat(t);return Math.max(...E.map((e,u)=>Ss(e)+Ss(t[u])))}function Ss(t){return Number(t.slice(0,-1).replace(",","."))*1e3}function jl(){return document.body.offsetHeight}const Es=t=>{const E=t.props["onUpdate:modelValue"]||!1;return Fe(E)?e=>ai(E,e):E};function Kl(t){t.target.composing=!0}function ws(t){const E=t.target;E.composing&&(E.composing=!1,E.dispatchEvent(new Event("input")))}const Hl={created(t,{modifiers:{lazy:E,trim:e,number:u}},g){t._assign=Es(g);const S=u||g.props&&g.props.type==="number";Cn(t,E?"change":"input",y=>{if(y.target.composing)return;let c=t.value;e&&(c=c.trim()),S&&(c=tr(c)),t._assign(c)}),e&&Cn(t,"change",()=>{t.value=t.value.trim()}),E||(Cn(t,"compositionstart",Kl),Cn(t,"compositionend",ws),Cn(t,"change",ws))},mounted(t,{value:E}){t.value=E??""},beforeUpdate(t,{value:E,modifiers:{lazy:e,trim:u,number:g}},S){if(t._assign=Es(S),t.composing||document.activeElement===t&&t.type!=="range"&&(e||u&&t.value.trim()===E||(g||t.type==="number")&&tr(t.value)===E))return;const y=E??"";t.value!==y&&(t.value=y)}},$l=["ctrl","shift","alt","meta"],Vl={stop:t=>t.stopPropagation(),prevent:t=>t.preventDefault(),self:t=>t.target!==t.currentTarget,ctrl:t=>!t.ctrlKey,shift:t=>!t.shiftKey,alt:t=>!t.altKey,meta:t=>!t.metaKey,left:t=>"button"in t&&t.button!==0,middle:t=>"button"in t&&t.button!==1,right:t=>"button"in t&&t.button!==2,exact:(t,E)=>$l.some(e=>t[`${e}Key`]&&!E.includes(e))},Ts=(t,E)=>(e,...u)=>{for(let g=0;g<E.length;g++){const S=Vl[E[g]];if(S&&S(e,E))return}return t(e,...u)},Wl={esc:"escape",space:" ",up:"arrow-up",left:"arrow-left",right:"arrow-right",down:"arrow-down",delete:"backspace"},jo=(t,E)=>e=>{if(!("key"in e))return;const u=Rn(e.key);if(E.some(g=>g===u||Wl[g]===u))return t(e)},Gl=dt({patchProp:xl},Sl);let Rs;function ql(){return Rs||(Rs=Qc(Gl))}const zl=(...t)=>{const E=ql().createApp(...t),{mount:e}=E;return E.mount=u=>{const g=Yl(u);if(!g)return;const S=E._component;!$e(S)&&!S.render&&!S.template&&(S.template=g.innerHTML),g.innerHTML="";const y=e(g,!1,g instanceof SVGElement);return g instanceof Element&&(g.removeAttribute("v-cloak"),g.setAttribute("data-v-app","")),y},E};function Yl(t){return ct(t)?document.querySelector(t):t}function Jl(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Ko={exports:{}};(function(t,E){(function(){var e={expires:"1d",path:"; path=/",domain:"",secure:"",sameSite:"; SameSite=Lax"},u={install:function(g,S){S&&this.config(S.expires,S.path,S.domain,S.secure,S.sameSite),g.prototype&&(g.prototype.$cookies=this),g.config&&g.config.globalProperties&&(g.config.globalProperties.$cookies=this,g.provide("$cookies",this)),g.$cookies=this},config:function(g,S,y,c,m){e.expires=g||"1d",e.path=S?"; path="+S:"; path=/",e.domain=y?"; domain="+y:"",e.secure=c?"; Secure":"",e.sameSite=m?"; SameSite="+m:"; SameSite=Lax"},get:function(g){var S=decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(g).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null;if(S&&(S.substring(0,1)==="{"&&S.substring(S.length-1,S.length)==="}"||S.substring(0,1)==="["&&S.substring(S.length-1,S.length)==="]"))try{S=JSON.parse(S)}catch{return S}return S},set:function(g,S,y,c,m,h,d){if(g){if(/^(?:expires|max\-age|path|domain|secure|SameSite)$/i.test(g))throw new Error('Cookie name illegality. Cannot be set to ["expires","max-age","path","domain","secure","SameSite"]	 current key name: '+g)}else throw new Error("Cookie name is not found in the first argument.");S&&typeof S=="object"&&(S=JSON.stringify(S));var b="";if(y=y??e.expires,y&&y!=0)switch(y.constructor){case Number:y===1/0||y===-1?b="; expires=Fri, 31 Dec 9999 23:59:59 GMT":b="; max-age="+y;break;case String:if(/^(?:\d+(y|m|d|h|min|s))$/i.test(y)){var a=y.replace(/^(\d+)(?:y|m|d|h|min|s)$/i,"$1");switch(y.replace(/^(?:\d+)(y|m|d|h|min|s)$/i,"$1").toLowerCase()){case"m":b="; max-age="+ +a*2592e3;break;case"d":b="; max-age="+ +a*86400;break;case"h":b="; max-age="+ +a*3600;break;case"min":b="; max-age="+ +a*60;break;case"s":b="; max-age="+a;break;case"y":b="; max-age="+ +a*31104e3;break}}else b="; expires="+y;break;case Date:b="; expires="+y.toUTCString();break}return document.cookie=encodeURIComponent(g)+"="+encodeURIComponent(S)+b+(m?"; domain="+m:e.domain)+(c?"; path="+c:e.path)+(h==null?e.secure:h?"; Secure":"")+(d==null?e.sameSite:d?"; SameSite="+d:""),this},remove:function(g,S,y){return!g||!this.isKey(g)?!1:(document.cookie=encodeURIComponent(g)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(y?"; domain="+y:e.domain)+(S?"; path="+S:e.path)+"; SameSite=Lax",!0)},isKey:function(g){return new RegExp("(?:^|;\\s*)"+encodeURIComponent(g).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){if(!document.cookie)return[];for(var g=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),S=0;S<g.length;S++)g[S]=decodeURIComponent(g[S]);return g}};t.exports=u,typeof window<"u"&&(window.$cookies=u)})()})(Ko);var Ql=Ko.exports;const Xl=Jl(Ql);(function(){function t(E,e,u){function g(c,m){if(!e[c]){if(!E[c]){var h=typeof require=="function"&&require;if(!m&&h)return h(c,!0);if(S)return S(c,!0);var d=new Error("Cannot find module '"+c+"'");throw d.code="MODULE_NOT_FOUND",d}var b=e[c]={exports:{}};E[c][0].call(b.exports,function(a){var n=E[c][1][a];return g(n||a)},b,b.exports,t,E,e,u)}return e[c].exports}for(var S=typeof require=="function"&&require,y=0;y<u.length;y++)g(u[y]);return g}return t})()({1:[function(t,E,e){for(var u=/[\\\"\x00-\x1F]/g,g={},S=0;S<32;++S)g[String.fromCharCode(S)]="\\U"+("0000"+S.toString(16)).slice(-4).toUpperCase();g["\b"]="\\b",g["	"]="\\t",g[`
`]="\\n",g["\f"]="\\f",g["\r"]="\\r",g['"']='\\"',g["\\"]="\\\\";function y(d){return u.lastIndex=0,d.replace(u,function(b){return g[b]})}function c(d){switch(typeof d){case"string":return'"'+y(d)+'"';case"number":return isFinite(d)?d:"null";case"boolean":return d;case"object":return d===null?"null":Array.isArray(d)?m(d):h(d);default:throw new Error("Cannot stringify: "+typeof d)}}function m(d){for(var b="[",a="",n=0;n<d.length;++n)a+=b,b=",",a+=c(d[n]);return b!=","?"[]":a+"]"}function h(d){var b="{",a="",n=Object.keys(d);n.sort();for(var i=0;i<n.length;++i){var r=n[i];a+=b+'"'+y(r)+'":',b=",",a+=c(d[r])}return b!=","?"{}":a+"}"}E.exports={stringify:c}},{}],2:[function(t,E,e){const u=e;u.bignum=t("bn.js"),u.define=t("./asn1/api").define,u.base=t("./asn1/base"),u.constants=t("./asn1/constants"),u.decoders=t("./asn1/decoders"),u.encoders=t("./asn1/encoders")},{"./asn1/api":3,"./asn1/base":5,"./asn1/constants":9,"./asn1/decoders":11,"./asn1/encoders":14,"bn.js":18}],3:[function(t,E,e){const u=t("./encoders"),g=t("./decoders"),S=t("inherits"),y=e;y.define=function(h,d){return new c(h,d)};function c(m,h){this.name=m,this.body=h,this.decoders={},this.encoders={}}c.prototype._createNamed=function(h){const d=this.name;function b(a){this._initNamed(a,d)}return S(b,h),b.prototype._initNamed=function(n,i){h.call(this,n,i)},new b(this)},c.prototype._getDecoder=function(h){return h=h||"der",this.decoders.hasOwnProperty(h)||(this.decoders[h]=this._createNamed(g[h])),this.decoders[h]},c.prototype.decode=function(h,d,b){return this._getDecoder(d).decode(h,b)},c.prototype._getEncoder=function(h){return h=h||"der",this.encoders.hasOwnProperty(h)||(this.encoders[h]=this._createNamed(u[h])),this.encoders[h]},c.prototype.encode=function(h,d,b){return this._getEncoder(d).encode(h,b)}},{"./decoders":11,"./encoders":14,inherits:146}],4:[function(t,E,e){const u=t("inherits"),g=t("../base/reporter").Reporter,S=t("safer-buffer").Buffer;function y(m,h){if(g.call(this,h),!S.isBuffer(m)){this.error("Input not Buffer");return}this.base=m,this.offset=0,this.length=m.length}u(y,g),e.DecoderBuffer=y,y.isDecoderBuffer=function(h){return h instanceof y?!0:typeof h=="object"&&S.isBuffer(h.base)&&h.constructor.name==="DecoderBuffer"&&typeof h.offset=="number"&&typeof h.length=="number"&&typeof h.save=="function"&&typeof h.restore=="function"&&typeof h.isEmpty=="function"&&typeof h.readUInt8=="function"&&typeof h.skip=="function"&&typeof h.raw=="function"},y.prototype.save=function(){return{offset:this.offset,reporter:g.prototype.save.call(this)}},y.prototype.restore=function(h){const d=new y(this.base);return d.offset=h.offset,d.length=this.offset,this.offset=h.offset,g.prototype.restore.call(this,h.reporter),d},y.prototype.isEmpty=function(){return this.offset===this.length},y.prototype.readUInt8=function(h){return this.offset+1<=this.length?this.base.readUInt8(this.offset++,!0):this.error(h||"DecoderBuffer overrun")},y.prototype.skip=function(h,d){if(!(this.offset+h<=this.length))return this.error(d||"DecoderBuffer overrun");const b=new y(this.base);return b._reporterState=this._reporterState,b.offset=this.offset,b.length=this.offset+h,this.offset+=h,b},y.prototype.raw=function(h){return this.base.slice(h?h.offset:this.offset,this.length)};function c(m,h){if(Array.isArray(m))this.length=0,this.value=m.map(function(d){return c.isEncoderBuffer(d)||(d=new c(d,h)),this.length+=d.length,d},this);else if(typeof m=="number"){if(!(0<=m&&m<=255))return h.error("non-byte EncoderBuffer value");this.value=m,this.length=1}else if(typeof m=="string")this.value=m,this.length=S.byteLength(m);else if(S.isBuffer(m))this.value=m,this.length=m.length;else return h.error("Unsupported type: "+typeof m)}e.EncoderBuffer=c,c.isEncoderBuffer=function(h){return h instanceof c?!0:typeof h=="object"&&h.constructor.name==="EncoderBuffer"&&typeof h.length=="number"&&typeof h.join=="function"},c.prototype.join=function(h,d){return h||(h=S.alloc(this.length)),d||(d=0),this.length===0||(Array.isArray(this.value)?this.value.forEach(function(b){b.join(h,d),d+=b.length}):(typeof this.value=="number"?h[d]=this.value:typeof this.value=="string"?h.write(this.value,d):S.isBuffer(this.value)&&this.value.copy(h,d),d+=this.length)),h}},{"../base/reporter":7,inherits:146,"safer-buffer":251}],5:[function(t,E,e){const u=e;u.Reporter=t("./reporter").Reporter,u.DecoderBuffer=t("./buffer").DecoderBuffer,u.EncoderBuffer=t("./buffer").EncoderBuffer,u.Node=t("./node")},{"./buffer":4,"./node":6,"./reporter":7}],6:[function(t,E,e){const u=t("../base/reporter").Reporter,g=t("../base/buffer").EncoderBuffer,S=t("../base/buffer").DecoderBuffer,y=t("minimalistic-assert"),c=["seq","seqof","set","setof","objid","bool","gentime","utctime","null_","enum","int","objDesc","bitstr","bmpstr","charstr","genstr","graphstr","ia5str","iso646str","numstr","octstr","printstr","t61str","unistr","utf8str","videostr"],m=["key","obj","use","optional","explicit","implicit","def","choice","any","contains"].concat(c),h=["_peekTag","_decodeTag","_use","_decodeStr","_decodeObjid","_decodeTime","_decodeNull","_decodeInt","_decodeBool","_decodeList","_encodeComposite","_encodeStr","_encodeObjid","_encodeTime","_encodeNull","_encodeInt","_encodeBool"];function d(a,n,i){const r={};this._baseState=r,r.name=i,r.enc=a,r.parent=n||null,r.children=null,r.tag=null,r.args=null,r.reverseArgs=null,r.choice=null,r.optional=!1,r.any=!1,r.obj=!1,r.use=null,r.useDecoder=null,r.key=null,r.default=null,r.explicit=null,r.implicit=null,r.contains=null,r.parent||(r.children=[],this._wrap())}E.exports=d;const b=["enc","parent","children","tag","args","reverseArgs","choice","optional","any","obj","use","alteredUse","key","default","explicit","implicit","contains"];d.prototype.clone=function(){const n=this._baseState,i={};b.forEach(function(s){i[s]=n[s]});const r=new this.constructor(i.parent);return r._baseState=i,r},d.prototype._wrap=function(){const n=this._baseState;m.forEach(function(i){this[i]=function(){const s=new this.constructor(this);return n.children.push(s),s[i].apply(s,arguments)}},this)},d.prototype._init=function(n){const i=this._baseState;y(i.parent===null),n.call(this),i.children=i.children.filter(function(r){return r._baseState.parent===this},this),y.equal(i.children.length,1,"Root node can have only one child")},d.prototype._useArgs=function(n){const i=this._baseState,r=n.filter(function(s){return s instanceof this.constructor},this);n=n.filter(function(s){return!(s instanceof this.constructor)},this),r.length!==0&&(y(i.children===null),i.children=r,r.forEach(function(s){s._baseState.parent=this},this)),n.length!==0&&(y(i.args===null),i.args=n,i.reverseArgs=n.map(function(s){if(typeof s!="object"||s.constructor!==Object)return s;const o={};return Object.keys(s).forEach(function(l){l==(l|0)&&(l|=0);const v=s[l];o[v]=l}),o}))},h.forEach(function(a){d.prototype[a]=function(){const i=this._baseState;throw new Error(a+" not implemented for encoding: "+i.enc)}}),c.forEach(function(a){d.prototype[a]=function(){const i=this._baseState,r=Array.prototype.slice.call(arguments);return y(i.tag===null),i.tag=a,this._useArgs(r),this}}),d.prototype.use=function(n){y(n);const i=this._baseState;return y(i.use===null),i.use=n,this},d.prototype.optional=function(){const n=this._baseState;return n.optional=!0,this},d.prototype.def=function(n){const i=this._baseState;return y(i.default===null),i.default=n,i.optional=!0,this},d.prototype.explicit=function(n){const i=this._baseState;return y(i.explicit===null&&i.implicit===null),i.explicit=n,this},d.prototype.implicit=function(n){const i=this._baseState;return y(i.explicit===null&&i.implicit===null),i.implicit=n,this},d.prototype.obj=function(){const n=this._baseState,i=Array.prototype.slice.call(arguments);return n.obj=!0,i.length!==0&&this._useArgs(i),this},d.prototype.key=function(n){const i=this._baseState;return y(i.key===null),i.key=n,this},d.prototype.any=function(){const n=this._baseState;return n.any=!0,this},d.prototype.choice=function(n){const i=this._baseState;return y(i.choice===null),i.choice=n,this._useArgs(Object.keys(n).map(function(r){return n[r]})),this},d.prototype.contains=function(n){const i=this._baseState;return y(i.use===null),i.contains=n,this},d.prototype._decode=function(n,i){const r=this._baseState;if(r.parent===null)return n.wrapResult(r.children[0]._decode(n,i));let s=r.default,o=!0,l=null;if(r.key!==null&&(l=n.enterKey(r.key)),r.optional){let f=null;if(r.explicit!==null?f=r.explicit:r.implicit!==null?f=r.implicit:r.tag!==null&&(f=r.tag),f===null&&!r.any){const p=n.save();try{r.choice===null?this._decodeGeneric(r.tag,n,i):this._decodeChoice(n,i),o=!0}catch{o=!1}n.restore(p)}else if(o=this._peekTag(n,f,r.any),n.isError(o))return o}let v;if(r.obj&&o&&(v=n.enterObject()),o){if(r.explicit!==null){const p=this._decodeTag(n,r.explicit);if(n.isError(p))return p;n=p}const f=n.offset;if(r.use===null&&r.choice===null){let p;r.any&&(p=n.save());const _=this._decodeTag(n,r.implicit!==null?r.implicit:r.tag,r.any);if(n.isError(_))return _;r.any?s=n.raw(p):n=_}if(i&&i.track&&r.tag!==null&&i.track(n.path(),f,n.length,"tagged"),i&&i.track&&r.tag!==null&&i.track(n.path(),n.offset,n.length,"content"),r.any||(r.choice===null?s=this._decodeGeneric(r.tag,n,i):s=this._decodeChoice(n,i)),n.isError(s))return s;if(!r.any&&r.choice===null&&r.children!==null&&r.children.forEach(function(_){_._decode(n,i)}),r.contains&&(r.tag==="octstr"||r.tag==="bitstr")){const p=new S(s);s=this._getUse(r.contains,n._reporterState.obj)._decode(p,i)}}return r.obj&&o&&(s=n.leaveObject(v)),r.key!==null&&(s!==null||o===!0)?n.leaveKey(l,r.key,s):l!==null&&n.exitKey(l),s},d.prototype._decodeGeneric=function(n,i,r){const s=this._baseState;return n==="seq"||n==="set"?null:n==="seqof"||n==="setof"?this._decodeList(i,n,s.args[0],r):/str$/.test(n)?this._decodeStr(i,n,r):n==="objid"&&s.args?this._decodeObjid(i,s.args[0],s.args[1],r):n==="objid"?this._decodeObjid(i,null,null,r):n==="gentime"||n==="utctime"?this._decodeTime(i,n,r):n==="null_"?this._decodeNull(i,r):n==="bool"?this._decodeBool(i,r):n==="objDesc"?this._decodeStr(i,n,r):n==="int"||n==="enum"?this._decodeInt(i,s.args&&s.args[0],r):s.use!==null?this._getUse(s.use,i._reporterState.obj)._decode(i,r):i.error("unknown tag: "+n)},d.prototype._getUse=function(n,i){const r=this._baseState;return r.useDecoder=this._use(n,i),y(r.useDecoder._baseState.parent===null),r.useDecoder=r.useDecoder._baseState.children[0],r.implicit!==r.useDecoder._baseState.implicit&&(r.useDecoder=r.useDecoder.clone(),r.useDecoder._baseState.implicit=r.implicit),r.useDecoder},d.prototype._decodeChoice=function(n,i){const r=this._baseState;let s=null,o=!1;return Object.keys(r.choice).some(function(l){const v=n.save(),f=r.choice[l];try{const p=f._decode(n,i);if(n.isError(p))return!1;s={type:l,value:p},o=!0}catch{return n.restore(v),!1}return!0},this),o?s:n.error("Choice not matched")},d.prototype._createEncoderBuffer=function(n){return new g(n,this.reporter)},d.prototype._encode=function(n,i,r){const s=this._baseState;if(s.default!==null&&s.default===n)return;const o=this._encodeValue(n,i,r);if(o!==void 0&&!this._skipDefault(o,i,r))return o},d.prototype._encodeValue=function(n,i,r){const s=this._baseState;if(s.parent===null)return s.children[0]._encode(n,i||new u);let o=null;if(this.reporter=i,s.optional&&n===void 0)if(s.default!==null)n=s.default;else return;let l=null,v=!1;if(s.any)o=this._createEncoderBuffer(n);else if(s.choice)o=this._encodeChoice(n,i);else if(s.contains)l=this._getUse(s.contains,r)._encode(n,i),v=!0;else if(s.children)l=s.children.map(function(f){if(f._baseState.tag==="null_")return f._encode(null,i,n);if(f._baseState.key===null)return i.error("Child should have a key");const p=i.enterKey(f._baseState.key);if(typeof n!="object")return i.error("Child expected, but input is not object");const _=f._encode(n[f._baseState.key],i,n);return i.leaveKey(p),_},this).filter(function(f){return f}),l=this._createEncoderBuffer(l);else if(s.tag==="seqof"||s.tag==="setof"){if(!(s.args&&s.args.length===1))return i.error("Too many args for : "+s.tag);if(!Array.isArray(n))return i.error("seqof/setof, but data is not Array");const f=this.clone();f._baseState.implicit=null,l=this._createEncoderBuffer(n.map(function(p){const _=this._baseState;return this._getUse(_.args[0],n)._encode(p,i)},f))}else s.use!==null?o=this._getUse(s.use,r)._encode(n,i):(l=this._encodePrimitive(s.tag,n),v=!0);if(!s.any&&s.choice===null){const f=s.implicit!==null?s.implicit:s.tag,p=s.implicit===null?"universal":"context";f===null?s.use===null&&i.error("Tag could be omitted only for .use()"):s.use===null&&(o=this._encodeComposite(f,v,p,l))}return s.explicit!==null&&(o=this._encodeComposite(s.explicit,!1,"context",o)),o},d.prototype._encodeChoice=function(n,i){const r=this._baseState,s=r.choice[n.type];return s||y(!1,n.type+" not found in "+JSON.stringify(Object.keys(r.choice))),s._encode(n.value,i)},d.prototype._encodePrimitive=function(n,i){const r=this._baseState;if(/str$/.test(n))return this._encodeStr(i,n);if(n==="objid"&&r.args)return this._encodeObjid(i,r.reverseArgs[0],r.args[1]);if(n==="objid")return this._encodeObjid(i,null,null);if(n==="gentime"||n==="utctime")return this._encodeTime(i,n);if(n==="null_")return this._encodeNull();if(n==="int"||n==="enum")return this._encodeInt(i,r.args&&r.reverseArgs[0]);if(n==="bool")return this._encodeBool(i);if(n==="objDesc")return this._encodeStr(i,n);throw new Error("Unsupported tag: "+n)},d.prototype._isNumstr=function(n){return/^[0-9 ]*$/.test(n)},d.prototype._isPrintstr=function(n){return/^[A-Za-z0-9 '()+,-./:=?]*$/.test(n)}},{"../base/buffer":4,"../base/reporter":7,"minimalistic-assert":223}],7:[function(t,E,e){const u=t("inherits");function g(y){this._reporterState={obj:null,path:[],options:y||{},errors:[]}}e.Reporter=g,g.prototype.isError=function(c){return c instanceof S},g.prototype.save=function(){const c=this._reporterState;return{obj:c.obj,pathLen:c.path.length}},g.prototype.restore=function(c){const m=this._reporterState;m.obj=c.obj,m.path=m.path.slice(0,c.pathLen)},g.prototype.enterKey=function(c){return this._reporterState.path.push(c)},g.prototype.exitKey=function(c){const m=this._reporterState;m.path=m.path.slice(0,c-1)},g.prototype.leaveKey=function(c,m,h){const d=this._reporterState;this.exitKey(c),d.obj!==null&&(d.obj[m]=h)},g.prototype.path=function(){return this._reporterState.path.join("/")},g.prototype.enterObject=function(){const c=this._reporterState,m=c.obj;return c.obj={},m},g.prototype.leaveObject=function(c){const m=this._reporterState,h=m.obj;return m.obj=c,h},g.prototype.error=function(c){let m;const h=this._reporterState,d=c instanceof S;if(d?m=c:m=new S(h.path.map(function(b){return"["+JSON.stringify(b)+"]"}).join(""),c.message||c,c.stack),!h.options.partial)throw m;return d||h.errors.push(m),m},g.prototype.wrapResult=function(c){const m=this._reporterState;return m.options.partial?{result:this.isError(c)?null:c,errors:m.errors}:c};function S(y,c){this.path=y,this.rethrow(c)}u(S,Error),S.prototype.rethrow=function(c){if(this.message=c+" at: "+(this.path||"(shallow)"),Error.captureStackTrace&&Error.captureStackTrace(this,S),!this.stack)try{throw new Error(this.message)}catch(m){this.stack=m.stack}return this}},{inherits:146}],8:[function(t,E,e){function u(g){const S={};return Object.keys(g).forEach(function(y){(y|0)==y&&(y=y|0);const c=g[y];S[c]=y}),S}e.tagClass={0:"universal",1:"application",2:"context",3:"private"},e.tagClassByName=u(e.tagClass),e.tag={0:"end",1:"bool",2:"int",3:"bitstr",4:"octstr",5:"null_",6:"objid",7:"objDesc",8:"external",9:"real",10:"enum",11:"embed",12:"utf8str",13:"relativeOid",16:"seq",17:"set",18:"numstr",19:"printstr",20:"t61str",21:"videostr",22:"ia5str",23:"utctime",24:"gentime",25:"graphstr",26:"iso646str",27:"genstr",28:"unistr",29:"charstr",30:"bmpstr"},e.tagByName=u(e.tag)},{}],9:[function(t,E,e){const u=e;u._reverse=function(S){const y={};return Object.keys(S).forEach(function(c){(c|0)==c&&(c=c|0);const m=S[c];y[m]=c}),y},u.der=t("./der")},{"./der":8}],10:[function(t,E,e){const u=t("inherits"),g=t("bn.js"),S=t("../base/buffer").DecoderBuffer,y=t("../base/node"),c=t("../constants/der");function m(a){this.enc="der",this.name=a.name,this.entity=a,this.tree=new h,this.tree._init(a.body)}E.exports=m,m.prototype.decode=function(n,i){return S.isDecoderBuffer(n)||(n=new S(n,i)),this.tree._decode(n,i)};function h(a){y.call(this,"der",a)}u(h,y),h.prototype._peekTag=function(n,i,r){if(n.isEmpty())return!1;const s=n.save(),o=d(n,'Failed to peek tag: "'+i+'"');return n.isError(o)?o:(n.restore(s),o.tag===i||o.tagStr===i||o.tagStr+"of"===i||r)},h.prototype._decodeTag=function(n,i,r){const s=d(n,'Failed to decode tag of "'+i+'"');if(n.isError(s))return s;let o=b(n,s.primitive,'Failed to get length of "'+i+'"');if(n.isError(o))return o;if(!r&&s.tag!==i&&s.tagStr!==i&&s.tagStr+"of"!==i)return n.error('Failed to match tag: "'+i+'"');if(s.primitive||o!==null)return n.skip(o,'Failed to match body of: "'+i+'"');const l=n.save(),v=this._skipUntilEnd(n,'Failed to skip indefinite length body: "'+this.tag+'"');return n.isError(v)?v:(o=n.offset-l.offset,n.restore(l),n.skip(o,'Failed to match body of: "'+i+'"'))},h.prototype._skipUntilEnd=function(n,i){for(;;){const r=d(n,i);if(n.isError(r))return r;const s=b(n,r.primitive,i);if(n.isError(s))return s;let o;if(r.primitive||s!==null?o=n.skip(s):o=this._skipUntilEnd(n,i),n.isError(o))return o;if(r.tagStr==="end")break}},h.prototype._decodeList=function(n,i,r,s){const o=[];for(;!n.isEmpty();){const l=this._peekTag(n,"end");if(n.isError(l))return l;const v=r.decode(n,"der",s);if(n.isError(v)&&l)break;o.push(v)}return o},h.prototype._decodeStr=function(n,i){if(i==="bitstr"){const r=n.readUInt8();return n.isError(r)?r:{unused:r,data:n.raw()}}else if(i==="bmpstr"){const r=n.raw();if(r.length%2===1)return n.error("Decoding of string type: bmpstr length mismatch");let s="";for(let o=0;o<r.length/2;o++)s+=String.fromCharCode(r.readUInt16BE(o*2));return s}else if(i==="numstr"){const r=n.raw().toString("ascii");return this._isNumstr(r)?r:n.error("Decoding of string type: numstr unsupported characters")}else{if(i==="octstr")return n.raw();if(i==="objDesc")return n.raw();if(i==="printstr"){const r=n.raw().toString("ascii");return this._isPrintstr(r)?r:n.error("Decoding of string type: printstr unsupported characters")}else return/str$/.test(i)?n.raw().toString():n.error("Decoding of string type: "+i+" unsupported")}},h.prototype._decodeObjid=function(n,i,r){let s;const o=[];let l=0,v=0;for(;!n.isEmpty();)v=n.readUInt8(),l<<=7,l|=v&127,v&128||(o.push(l),l=0);v&128&&o.push(l);const f=o[0]/40|0,p=o[0]%40;if(r?s=o:s=[f,p].concat(o.slice(1)),i){let _=i[s.join(" ")];_===void 0&&(_=i[s.join(".")]),_!==void 0&&(s=_)}return s},h.prototype._decodeTime=function(n,i){const r=n.raw().toString();let s,o,l,v,f,p;if(i==="gentime")s=r.slice(0,4)|0,o=r.slice(4,6)|0,l=r.slice(6,8)|0,v=r.slice(8,10)|0,f=r.slice(10,12)|0,p=r.slice(12,14)|0;else if(i==="utctime")s=r.slice(0,2)|0,o=r.slice(2,4)|0,l=r.slice(4,6)|0,v=r.slice(6,8)|0,f=r.slice(8,10)|0,p=r.slice(10,12)|0,s<70?s=2e3+s:s=1900+s;else return n.error("Decoding "+i+" time is not supported yet");return Date.UTC(s,o-1,l,v,f,p,0)},h.prototype._decodeNull=function(){return null},h.prototype._decodeBool=function(n){const i=n.readUInt8();return n.isError(i)?i:i!==0},h.prototype._decodeInt=function(n,i){const r=n.raw();let s=new g(r);return i&&(s=i[s.toString(10)]||s),s},h.prototype._use=function(n,i){return typeof n=="function"&&(n=n(i)),n._getDecoder("der").tree};function d(a,n){let i=a.readUInt8(n);if(a.isError(i))return i;const r=c.tagClass[i>>6],s=(i&32)===0;if((i&31)===31){let l=i;for(i=0;(l&128)===128;){if(l=a.readUInt8(n),a.isError(l))return l;i<<=7,i|=l&127}}else i&=31;const o=c.tag[i];return{cls:r,primitive:s,tag:i,tagStr:o}}function b(a,n,i){let r=a.readUInt8(i);if(a.isError(r))return r;if(!n&&r===128)return null;if(!(r&128))return r;const s=r&127;if(s>4)return a.error("length octect is too long");r=0;for(let o=0;o<s;o++){r<<=8;const l=a.readUInt8(i);if(a.isError(l))return l;r|=l}return r}},{"../base/buffer":4,"../base/node":6,"../constants/der":8,"bn.js":18,inherits:146}],11:[function(t,E,e){const u=e;u.der=t("./der"),u.pem=t("./pem")},{"./der":10,"./pem":12}],12:[function(t,E,e){const u=t("inherits"),g=t("safer-buffer").Buffer,S=t("./der");function y(c){S.call(this,c),this.enc="pem"}u(y,S),E.exports=y,y.prototype.decode=function(m,h){const d=m.toString().split(/[\r\n]+/g),b=h.label.toUpperCase(),a=/^-----(BEGIN|END) ([^-]+)-----$/;let n=-1,i=-1;for(let o=0;o<d.length;o++){const l=d[o].match(a);if(l!==null&&l[2]===b)if(n===-1){if(l[1]!=="BEGIN")break;n=o}else{if(l[1]!=="END")break;i=o;break}}if(n===-1||i===-1)throw new Error("PEM section not found for: "+b);const r=d.slice(n+1,i).join("");r.replace(/[^a-z0-9+/=]+/gi,"");const s=g.from(r,"base64");return S.prototype.decode.call(this,s,h)}},{"./der":10,inherits:146,"safer-buffer":251}],13:[function(t,E,e){const u=t("inherits"),g=t("safer-buffer").Buffer,S=t("../base/node"),y=t("../constants/der");function c(b){this.enc="der",this.name=b.name,this.entity=b,this.tree=new m,this.tree._init(b.body)}E.exports=c,c.prototype.encode=function(a,n){return this.tree._encode(a,n).join()};function m(b){S.call(this,"der",b)}u(m,S),m.prototype._encodeComposite=function(a,n,i,r){const s=d(a,n,i,this.reporter);if(r.length<128){const v=g.alloc(2);return v[0]=s,v[1]=r.length,this._createEncoderBuffer([v,r])}let o=1;for(let v=r.length;v>=256;v>>=8)o++;const l=g.alloc(1+1+o);l[0]=s,l[1]=128|o;for(let v=1+o,f=r.length;f>0;v--,f>>=8)l[v]=f&255;return this._createEncoderBuffer([l,r])},m.prototype._encodeStr=function(a,n){if(n==="bitstr")return this._createEncoderBuffer([a.unused|0,a.data]);if(n==="bmpstr"){const i=g.alloc(a.length*2);for(let r=0;r<a.length;r++)i.writeUInt16BE(a.charCodeAt(r),r*2);return this._createEncoderBuffer(i)}else return n==="numstr"?this._isNumstr(a)?this._createEncoderBuffer(a):this.reporter.error("Encoding of string type: numstr supports only digits and space"):n==="printstr"?this._isPrintstr(a)?this._createEncoderBuffer(a):this.reporter.error("Encoding of string type: printstr supports only latin upper and lower case letters, digits, space, apostrophe, left and rigth parenthesis, plus sign, comma, hyphen, dot, slash, colon, equal sign, question mark"):/str$/.test(n)?this._createEncoderBuffer(a):n==="objDesc"?this._createEncoderBuffer(a):this.reporter.error("Encoding of string type: "+n+" unsupported")},m.prototype._encodeObjid=function(a,n,i){if(typeof a=="string"){if(!n)return this.reporter.error("string objid given, but no values map found");if(!n.hasOwnProperty(a))return this.reporter.error("objid not found in values map");a=n[a].split(/[\s.]+/g);for(let l=0;l<a.length;l++)a[l]|=0}else if(Array.isArray(a)){a=a.slice();for(let l=0;l<a.length;l++)a[l]|=0}if(!Array.isArray(a))return this.reporter.error("objid() should be either array or string, got: "+JSON.stringify(a));if(!i){if(a[1]>=40)return this.reporter.error("Second objid identifier OOB");a.splice(0,2,a[0]*40+a[1])}let r=0;for(let l=0;l<a.length;l++){let v=a[l];for(r++;v>=128;v>>=7)r++}const s=g.alloc(r);let o=s.length-1;for(let l=a.length-1;l>=0;l--){let v=a[l];for(s[o--]=v&127;(v>>=7)>0;)s[o--]=128|v&127}return this._createEncoderBuffer(s)};function h(b){return b<10?"0"+b:b}m.prototype._encodeTime=function(a,n){let i;const r=new Date(a);return n==="gentime"?i=[h(r.getUTCFullYear()),h(r.getUTCMonth()+1),h(r.getUTCDate()),h(r.getUTCHours()),h(r.getUTCMinutes()),h(r.getUTCSeconds()),"Z"].join(""):n==="utctime"?i=[h(r.getUTCFullYear()%100),h(r.getUTCMonth()+1),h(r.getUTCDate()),h(r.getUTCHours()),h(r.getUTCMinutes()),h(r.getUTCSeconds()),"Z"].join(""):this.reporter.error("Encoding "+n+" time is not supported yet"),this._encodeStr(i,"octstr")},m.prototype._encodeNull=function(){return this._createEncoderBuffer("")},m.prototype._encodeInt=function(a,n){if(typeof a=="string"){if(!n)return this.reporter.error("String int or enum given, but no values map");if(!n.hasOwnProperty(a))return this.reporter.error("Values map doesn't contain: "+JSON.stringify(a));a=n[a]}if(typeof a!="number"&&!g.isBuffer(a)){const s=a.toArray();!a.sign&&s[0]&128&&s.unshift(0),a=g.from(s)}if(g.isBuffer(a)){let s=a.length;a.length===0&&s++;const o=g.alloc(s);return a.copy(o),a.length===0&&(o[0]=0),this._createEncoderBuffer(o)}if(a<128)return this._createEncoderBuffer(a);if(a<256)return this._createEncoderBuffer([0,a]);let i=1;for(let s=a;s>=256;s>>=8)i++;const r=new Array(i);for(let s=r.length-1;s>=0;s--)r[s]=a&255,a>>=8;return r[0]&128&&r.unshift(0),this._createEncoderBuffer(g.from(r))},m.prototype._encodeBool=function(a){return this._createEncoderBuffer(a?255:0)},m.prototype._use=function(a,n){return typeof a=="function"&&(a=a(n)),a._getEncoder("der").tree},m.prototype._skipDefault=function(a,n,i){const r=this._baseState;let s;if(r.default===null)return!1;const o=a.join();if(r.defaultBuffer===void 0&&(r.defaultBuffer=this._encodeValue(r.default,n,i).join()),o.length!==r.defaultBuffer.length)return!1;for(s=0;s<o.length;s++)if(o[s]!==r.defaultBuffer[s])return!1;return!0};function d(b,a,n,i){let r;if(b==="seqof"?b="seq":b==="setof"&&(b="set"),y.tagByName.hasOwnProperty(b))r=y.tagByName[b];else if(typeof b=="number"&&(b|0)===b)r=b;else return i.error("Unknown tag: "+b);return r>=31?i.error("Multi-octet tag encoding unsupported"):(a||(r|=32),r|=y.tagClassByName[n||"universal"]<<6,r)}},{"../base/node":6,"../constants/der":8,inherits:146,"safer-buffer":251}],14:[function(t,E,e){const u=e;u.der=t("./der"),u.pem=t("./pem")},{"./der":13,"./pem":15}],15:[function(t,E,e){const u=t("inherits"),g=t("./der");function S(y){g.call(this,y),this.enc="pem"}u(S,g),E.exports=S,S.prototype.encode=function(c,m){const d=g.prototype.encode.call(this,c).toString("base64"),b=["-----BEGIN "+m.label+"-----"];for(let a=0;a<d.length;a+=64)b.push(d.slice(a,a+64));return b.push("-----END "+m.label+"-----"),b.join(`
`)}},{"./der":13,inherits:146}],16:[function(t,E,e){(function(u){(function(){var g=["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],S=typeof globalThis>"u"?u:globalThis;E.exports=function(){for(var c=[],m=0;m<g.length;m++)typeof S[g[m]]=="function"&&(c[c.length]=g[m]);return c}}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{}],17:[function(t,E,e){e.byteLength=d,e.toByteArray=a,e.fromByteArray=r;for(var u=[],g=[],S=typeof Uint8Array<"u"?Uint8Array:Array,y="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=0,m=y.length;c<m;++c)u[c]=y[c],g[y.charCodeAt(c)]=c;g["-".charCodeAt(0)]=62,g["_".charCodeAt(0)]=63;function h(s){var o=s.length;if(o%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var l=s.indexOf("=");l===-1&&(l=o);var v=l===o?0:4-l%4;return[l,v]}function d(s){var o=h(s),l=o[0],v=o[1];return(l+v)*3/4-v}function b(s,o,l){return(o+l)*3/4-l}function a(s){var o,l=h(s),v=l[0],f=l[1],p=new S(b(s,v,f)),_=0,T=f>0?v-4:v,w;for(w=0;w<T;w+=4)o=g[s.charCodeAt(w)]<<18|g[s.charCodeAt(w+1)]<<12|g[s.charCodeAt(w+2)]<<6|g[s.charCodeAt(w+3)],p[_++]=o>>16&255,p[_++]=o>>8&255,p[_++]=o&255;return f===2&&(o=g[s.charCodeAt(w)]<<2|g[s.charCodeAt(w+1)]>>4,p[_++]=o&255),f===1&&(o=g[s.charCodeAt(w)]<<10|g[s.charCodeAt(w+1)]<<4|g[s.charCodeAt(w+2)]>>2,p[_++]=o>>8&255,p[_++]=o&255),p}function n(s){return u[s>>18&63]+u[s>>12&63]+u[s>>6&63]+u[s&63]}function i(s,o,l){for(var v,f=[],p=o;p<l;p+=3)v=(s[p]<<16&16711680)+(s[p+1]<<8&65280)+(s[p+2]&255),f.push(n(v));return f.join("")}function r(s){for(var o,l=s.length,v=l%3,f=[],p=16383,_=0,T=l-v;_<T;_+=p)f.push(i(s,_,_+p>T?T:_+p));return v===1?(o=s[l-1],f.push(u[o>>2]+u[o<<4&63]+"==")):v===2&&(o=(s[l-2]<<8)+s[l-1],f.push(u[o>>10]+u[o>>4&63]+u[o<<2&63]+"=")),f.join("")}},{}],18:[function(t,E,e){(function(u,g){function S(F,C){if(!F)throw new Error(C||"Assertion failed")}function y(F,C){F.super_=C;var O=function(){};O.prototype=C.prototype,F.prototype=new O,F.prototype.constructor=F}function c(F,C,O){if(c.isBN(F))return F;this.negative=0,this.words=null,this.length=0,this.red=null,F!==null&&((C==="le"||C==="be")&&(O=C,C=10),this._init(F||0,C||10,O||"be"))}typeof u=="object"?u.exports=c:g.BN=c,c.BN=c,c.wordSize=26;var m;try{typeof window<"u"&&typeof window.Buffer<"u"?m=window.Buffer:m=t("buffer").Buffer}catch{}c.isBN=function(C){return C instanceof c?!0:C!==null&&typeof C=="object"&&C.constructor.wordSize===c.wordSize&&Array.isArray(C.words)},c.max=function(C,O){return C.cmp(O)>0?C:O},c.min=function(C,O){return C.cmp(O)<0?C:O},c.prototype._init=function(C,O,I){if(typeof C=="number")return this._initNumber(C,O,I);if(typeof C=="object")return this._initArray(C,O,I);O==="hex"&&(O=16),S(O===(O|0)&&O>=2&&O<=36),C=C.toString().replace(/\s+/g,"");var D=0;C[0]==="-"&&(D++,this.negative=1),D<C.length&&(O===16?this._parseHex(C,D,I):(this._parseBase(C,O,D),I==="le"&&this._initArray(this.toArray(),O,I)))},c.prototype._initNumber=function(C,O,I){C<0&&(this.negative=1,C=-C),C<67108864?(this.words=[C&67108863],this.length=1):C<4503599627370496?(this.words=[C&67108863,C/67108864&67108863],this.length=2):(S(C<9007199254740992),this.words=[C&67108863,C/67108864&67108863,1],this.length=3),I==="le"&&this._initArray(this.toArray(),O,I)},c.prototype._initArray=function(C,O,I){if(S(typeof C.length=="number"),C.length<=0)return this.words=[0],this.length=1,this;this.length=Math.ceil(C.length/3),this.words=new Array(this.length);for(var D=0;D<this.length;D++)this.words[D]=0;var j,Y,q=0;if(I==="be")for(D=C.length-1,j=0;D>=0;D-=3)Y=C[D]|C[D-1]<<8|C[D-2]<<16,this.words[j]|=Y<<q&67108863,this.words[j+1]=Y>>>26-q&67108863,q+=24,q>=26&&(q-=26,j++);else if(I==="le")for(D=0,j=0;D<C.length;D+=3)Y=C[D]|C[D+1]<<8|C[D+2]<<16,this.words[j]|=Y<<q&67108863,this.words[j+1]=Y>>>26-q&67108863,q+=24,q>=26&&(q-=26,j++);return this.strip()};function h(F,C){var O=F.charCodeAt(C);return O>=65&&O<=70?O-55:O>=97&&O<=102?O-87:O-48&15}function d(F,C,O){var I=h(F,O);return O-1>=C&&(I|=h(F,O-1)<<4),I}c.prototype._parseHex=function(C,O,I){this.length=Math.ceil((C.length-O)/6),this.words=new Array(this.length);for(var D=0;D<this.length;D++)this.words[D]=0;var j=0,Y=0,q;if(I==="be")for(D=C.length-1;D>=O;D-=2)q=d(C,O,D)<<j,this.words[Y]|=q&67108863,j>=18?(j-=18,Y+=1,this.words[Y]|=q>>>26):j+=8;else{var B=C.length-O;for(D=B%2===0?O+1:O;D<C.length;D+=2)q=d(C,O,D)<<j,this.words[Y]|=q&67108863,j>=18?(j-=18,Y+=1,this.words[Y]|=q>>>26):j+=8}this.strip()};function b(F,C,O,I){for(var D=0,j=Math.min(F.length,O),Y=C;Y<j;Y++){var q=F.charCodeAt(Y)-48;D*=I,q>=49?D+=q-49+10:q>=17?D+=q-17+10:D+=q}return D}c.prototype._parseBase=function(C,O,I){this.words=[0],this.length=1;for(var D=0,j=1;j<=67108863;j*=O)D++;D--,j=j/O|0;for(var Y=C.length-I,q=Y%D,B=Math.min(Y,Y-q)+I,R=0,k=I;k<B;k+=D)R=b(C,k,k+D,O),this.imuln(j),this.words[0]+R<67108864?this.words[0]+=R:this._iaddn(R);if(q!==0){var P=1;for(R=b(C,k,C.length,O),k=0;k<q;k++)P*=O;this.imuln(P),this.words[0]+R<67108864?this.words[0]+=R:this._iaddn(R)}this.strip()},c.prototype.copy=function(C){C.words=new Array(this.length);for(var O=0;O<this.length;O++)C.words[O]=this.words[O];C.length=this.length,C.negative=this.negative,C.red=this.red},c.prototype.clone=function(){var C=new c(null);return this.copy(C),C},c.prototype._expand=function(C){for(;this.length<C;)this.words[this.length++]=0;return this},c.prototype.strip=function(){for(;this.length>1&&this.words[this.length-1]===0;)this.length--;return this._normSign()},c.prototype._normSign=function(){return this.length===1&&this.words[0]===0&&(this.negative=0),this},c.prototype.inspect=function(){return(this.red?"<BN-R: ":"<BN: ")+this.toString(16)+">"};var a=["","0","00","000","0000","00000","000000","0000000","00000000","000000000","0000000000","00000000000","000000000000","0000000000000","00000000000000","000000000000000","0000000000000000","00000000000000000","000000000000000000","0000000000000000000","00000000000000000000","000000000000000000000","0000000000000000000000","00000000000000000000000","000000000000000000000000","0000000000000000000000000"],n=[0,0,25,16,12,11,10,9,8,8,7,7,7,7,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],i=[0,0,33554432,43046721,16777216,48828125,60466176,40353607,16777216,43046721,1e7,19487171,35831808,62748517,7529536,11390625,16777216,24137569,34012224,47045881,64e6,4084101,5153632,6436343,7962624,9765625,11881376,14348907,17210368,20511149,243e5,28629151,33554432,39135393,45435424,52521875,60466176];c.prototype.toString=function(C,O){C=C||10,O=O|0||1;var I;if(C===16||C==="hex"){I="";for(var D=0,j=0,Y=0;Y<this.length;Y++){var q=this.words[Y],B=((q<<D|j)&16777215).toString(16);j=q>>>24-D&16777215,j!==0||Y!==this.length-1?I=a[6-B.length]+B+I:I=B+I,D+=2,D>=26&&(D-=26,Y--)}for(j!==0&&(I=j.toString(16)+I);I.length%O!==0;)I="0"+I;return this.negative!==0&&(I="-"+I),I}if(C===(C|0)&&C>=2&&C<=36){var R=n[C],k=i[C];I="";var P=this.clone();for(P.negative=0;!P.isZero();){var V=P.modn(k).toString(C);P=P.idivn(k),P.isZero()?I=V+I:I=a[R-V.length]+V+I}for(this.isZero()&&(I="0"+I);I.length%O!==0;)I="0"+I;return this.negative!==0&&(I="-"+I),I}S(!1,"Base should be between 2 and 36")},c.prototype.toNumber=function(){var C=this.words[0];return this.length===2?C+=this.words[1]*67108864:this.length===3&&this.words[2]===1?C+=4503599627370496+this.words[1]*67108864:this.length>2&&S(!1,"Number can only safely store up to 53 bits"),this.negative!==0?-C:C},c.prototype.toJSON=function(){return this.toString(16)},c.prototype.toBuffer=function(C,O){return S(typeof m<"u"),this.toArrayLike(m,C,O)},c.prototype.toArray=function(C,O){return this.toArrayLike(Array,C,O)},c.prototype.toArrayLike=function(C,O,I){var D=this.byteLength(),j=I||Math.max(1,D);S(D<=j,"byte array longer than desired length"),S(j>0,"Requested array length <= 0"),this.strip();var Y=O==="le",q=new C(j),B,R,k=this.clone();if(Y){for(R=0;!k.isZero();R++)B=k.andln(255),k.iushrn(8),q[R]=B;for(;R<j;R++)q[R]=0}else{for(R=0;R<j-D;R++)q[R]=0;for(R=0;!k.isZero();R++)B=k.andln(255),k.iushrn(8),q[j-R-1]=B}return q},Math.clz32?c.prototype._countBits=function(C){return 32-Math.clz32(C)}:c.prototype._countBits=function(C){var O=C,I=0;return O>=4096&&(I+=13,O>>>=13),O>=64&&(I+=7,O>>>=7),O>=8&&(I+=4,O>>>=4),O>=2&&(I+=2,O>>>=2),I+O},c.prototype._zeroBits=function(C){if(C===0)return 26;var O=C,I=0;return O&8191||(I+=13,O>>>=13),O&127||(I+=7,O>>>=7),O&15||(I+=4,O>>>=4),O&3||(I+=2,O>>>=2),O&1||I++,I},c.prototype.bitLength=function(){var C=this.words[this.length-1],O=this._countBits(C);return(this.length-1)*26+O};function r(F){for(var C=new Array(F.bitLength()),O=0;O<C.length;O++){var I=O/26|0,D=O%26;C[O]=(F.words[I]&1<<D)>>>D}return C}c.prototype.zeroBits=function(){if(this.isZero())return 0;for(var C=0,O=0;O<this.length;O++){var I=this._zeroBits(this.words[O]);if(C+=I,I!==26)break}return C},c.prototype.byteLength=function(){return Math.ceil(this.bitLength()/8)},c.prototype.toTwos=function(C){return this.negative!==0?this.abs().inotn(C).iaddn(1):this.clone()},c.prototype.fromTwos=function(C){return this.testn(C-1)?this.notn(C).iaddn(1).ineg():this.clone()},c.prototype.isNeg=function(){return this.negative!==0},c.prototype.neg=function(){return this.clone().ineg()},c.prototype.ineg=function(){return this.isZero()||(this.negative^=1),this},c.prototype.iuor=function(C){for(;this.length<C.length;)this.words[this.length++]=0;for(var O=0;O<C.length;O++)this.words[O]=this.words[O]|C.words[O];return this.strip()},c.prototype.ior=function(C){return S((this.negative|C.negative)===0),this.iuor(C)},c.prototype.or=function(C){return this.length>C.length?this.clone().ior(C):C.clone().ior(this)},c.prototype.uor=function(C){return this.length>C.length?this.clone().iuor(C):C.clone().iuor(this)},c.prototype.iuand=function(C){var O;this.length>C.length?O=C:O=this;for(var I=0;I<O.length;I++)this.words[I]=this.words[I]&C.words[I];return this.length=O.length,this.strip()},c.prototype.iand=function(C){return S((this.negative|C.negative)===0),this.iuand(C)},c.prototype.and=function(C){return this.length>C.length?this.clone().iand(C):C.clone().iand(this)},c.prototype.uand=function(C){return this.length>C.length?this.clone().iuand(C):C.clone().iuand(this)},c.prototype.iuxor=function(C){var O,I;this.length>C.length?(O=this,I=C):(O=C,I=this);for(var D=0;D<I.length;D++)this.words[D]=O.words[D]^I.words[D];if(this!==O)for(;D<O.length;D++)this.words[D]=O.words[D];return this.length=O.length,this.strip()},c.prototype.ixor=function(C){return S((this.negative|C.negative)===0),this.iuxor(C)},c.prototype.xor=function(C){return this.length>C.length?this.clone().ixor(C):C.clone().ixor(this)},c.prototype.uxor=function(C){return this.length>C.length?this.clone().iuxor(C):C.clone().iuxor(this)},c.prototype.inotn=function(C){S(typeof C=="number"&&C>=0);var O=Math.ceil(C/26)|0,I=C%26;this._expand(O),I>0&&O--;for(var D=0;D<O;D++)this.words[D]=~this.words[D]&67108863;return I>0&&(this.words[D]=~this.words[D]&67108863>>26-I),this.strip()},c.prototype.notn=function(C){return this.clone().inotn(C)},c.prototype.setn=function(C,O){S(typeof C=="number"&&C>=0);var I=C/26|0,D=C%26;return this._expand(I+1),O?this.words[I]=this.words[I]|1<<D:this.words[I]=this.words[I]&~(1<<D),this.strip()},c.prototype.iadd=function(C){var O;if(this.negative!==0&&C.negative===0)return this.negative=0,O=this.isub(C),this.negative^=1,this._normSign();if(this.negative===0&&C.negative!==0)return C.negative=0,O=this.isub(C),C.negative=1,O._normSign();var I,D;this.length>C.length?(I=this,D=C):(I=C,D=this);for(var j=0,Y=0;Y<D.length;Y++)O=(I.words[Y]|0)+(D.words[Y]|0)+j,this.words[Y]=O&67108863,j=O>>>26;for(;j!==0&&Y<I.length;Y++)O=(I.words[Y]|0)+j,this.words[Y]=O&67108863,j=O>>>26;if(this.length=I.length,j!==0)this.words[this.length]=j,this.length++;else if(I!==this)for(;Y<I.length;Y++)this.words[Y]=I.words[Y];return this},c.prototype.add=function(C){var O;return C.negative!==0&&this.negative===0?(C.negative=0,O=this.sub(C),C.negative^=1,O):C.negative===0&&this.negative!==0?(this.negative=0,O=C.sub(this),this.negative=1,O):this.length>C.length?this.clone().iadd(C):C.clone().iadd(this)},c.prototype.isub=function(C){if(C.negative!==0){C.negative=0;var O=this.iadd(C);return C.negative=1,O._normSign()}else if(this.negative!==0)return this.negative=0,this.iadd(C),this.negative=1,this._normSign();var I=this.cmp(C);if(I===0)return this.negative=0,this.length=1,this.words[0]=0,this;var D,j;I>0?(D=this,j=C):(D=C,j=this);for(var Y=0,q=0;q<j.length;q++)O=(D.words[q]|0)-(j.words[q]|0)+Y,Y=O>>26,this.words[q]=O&67108863;for(;Y!==0&&q<D.length;q++)O=(D.words[q]|0)+Y,Y=O>>26,this.words[q]=O&67108863;if(Y===0&&q<D.length&&D!==this)for(;q<D.length;q++)this.words[q]=D.words[q];return this.length=Math.max(this.length,q),D!==this&&(this.negative=1),this.strip()},c.prototype.sub=function(C){return this.clone().isub(C)};function s(F,C,O){O.negative=C.negative^F.negative;var I=F.length+C.length|0;O.length=I,I=I-1|0;var D=F.words[0]|0,j=C.words[0]|0,Y=D*j,q=Y&67108863,B=Y/67108864|0;O.words[0]=q;for(var R=1;R<I;R++){for(var k=B>>>26,P=B&67108863,V=Math.min(R,C.length-1),x=Math.max(0,R-F.length+1);x<=V;x++){var Q=R-x|0;D=F.words[Q]|0,j=C.words[x]|0,Y=D*j+P,k+=Y/67108864|0,P=Y&67108863}O.words[R]=P|0,B=k|0}return B!==0?O.words[R]=B|0:O.length--,O.strip()}var o=function(C,O,I){var D=C.words,j=O.words,Y=I.words,q=0,B,R,k,P=D[0]|0,V=P&8191,x=P>>>13,Q=D[1]|0,te=Q&8191,ae=Q>>>13,de=D[2]|0,X=de&8191,$=de>>>13,K=D[3]|0,re=K&8191,ue=K>>>13,H=D[4]|0,G=H&8191,U=H>>>13,L=D[5]|0,z=L&8191,J=L>>>13,ne=D[6]|0,oe=ne&8191,ce=ne>>>13,pe=D[7]|0,he=pe&8191,fe=pe>>>13,ve=D[8]|0,ye=ve&8191,Ee=ve>>>13,we=D[9]|0,me=we&8191,N=we>>>13,Z=j[0]|0,ie=Z&8191,se=Z>>>13,le=j[1]|0,ge=le&8191,be=le>>>13,Se=j[2]|0,_e=Se&8191,Re=Se>>>13,Ie=j[3]|0,Ce=Ie&8191,Me=Ie>>>13,Ae=j[4]|0,ke=Ae&8191,xe=Ae>>>13,Pe=j[5]|0,De=Pe&8191,je=Pe>>>13,Be=j[6]|0,Oe=Be&8191,Ue=Be>>>13,Ve=j[7]|0,Ne=Ve&8191,Je=Ve>>>13,tt=j[8]|0,Ke=tt&8191,nt=tt>>>13,it=j[9]|0,He=it&8191,rt=it>>>13;I.negative=C.negative^O.negative,I.length=19,B=Math.imul(V,ie),R=Math.imul(V,se),R=R+Math.imul(x,ie)|0,k=Math.imul(x,se);var Ze=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(Ze>>>26)|0,Ze&=67108863,B=Math.imul(te,ie),R=Math.imul(te,se),R=R+Math.imul(ae,ie)|0,k=Math.imul(ae,se),B=B+Math.imul(V,ge)|0,R=R+Math.imul(V,be)|0,R=R+Math.imul(x,ge)|0,k=k+Math.imul(x,be)|0;var et=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(et>>>26)|0,et&=67108863,B=Math.imul(X,ie),R=Math.imul(X,se),R=R+Math.imul($,ie)|0,k=Math.imul($,se),B=B+Math.imul(te,ge)|0,R=R+Math.imul(te,be)|0,R=R+Math.imul(ae,ge)|0,k=k+Math.imul(ae,be)|0,B=B+Math.imul(V,_e)|0,R=R+Math.imul(V,Re)|0,R=R+Math.imul(x,_e)|0,k=k+Math.imul(x,Re)|0;var Yt=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(Yt>>>26)|0,Yt&=67108863,B=Math.imul(re,ie),R=Math.imul(re,se),R=R+Math.imul(ue,ie)|0,k=Math.imul(ue,se),B=B+Math.imul(X,ge)|0,R=R+Math.imul(X,be)|0,R=R+Math.imul($,ge)|0,k=k+Math.imul($,be)|0,B=B+Math.imul(te,_e)|0,R=R+Math.imul(te,Re)|0,R=R+Math.imul(ae,_e)|0,k=k+Math.imul(ae,Re)|0,B=B+Math.imul(V,Ce)|0,R=R+Math.imul(V,Me)|0,R=R+Math.imul(x,Ce)|0,k=k+Math.imul(x,Me)|0;var Jt=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(Jt>>>26)|0,Jt&=67108863,B=Math.imul(G,ie),R=Math.imul(G,se),R=R+Math.imul(U,ie)|0,k=Math.imul(U,se),B=B+Math.imul(re,ge)|0,R=R+Math.imul(re,be)|0,R=R+Math.imul(ue,ge)|0,k=k+Math.imul(ue,be)|0,B=B+Math.imul(X,_e)|0,R=R+Math.imul(X,Re)|0,R=R+Math.imul($,_e)|0,k=k+Math.imul($,Re)|0,B=B+Math.imul(te,Ce)|0,R=R+Math.imul(te,Me)|0,R=R+Math.imul(ae,Ce)|0,k=k+Math.imul(ae,Me)|0,B=B+Math.imul(V,ke)|0,R=R+Math.imul(V,xe)|0,R=R+Math.imul(x,ke)|0,k=k+Math.imul(x,xe)|0;var Qt=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(Qt>>>26)|0,Qt&=67108863,B=Math.imul(z,ie),R=Math.imul(z,se),R=R+Math.imul(J,ie)|0,k=Math.imul(J,se),B=B+Math.imul(G,ge)|0,R=R+Math.imul(G,be)|0,R=R+Math.imul(U,ge)|0,k=k+Math.imul(U,be)|0,B=B+Math.imul(re,_e)|0,R=R+Math.imul(re,Re)|0,R=R+Math.imul(ue,_e)|0,k=k+Math.imul(ue,Re)|0,B=B+Math.imul(X,Ce)|0,R=R+Math.imul(X,Me)|0,R=R+Math.imul($,Ce)|0,k=k+Math.imul($,Me)|0,B=B+Math.imul(te,ke)|0,R=R+Math.imul(te,xe)|0,R=R+Math.imul(ae,ke)|0,k=k+Math.imul(ae,xe)|0,B=B+Math.imul(V,De)|0,R=R+Math.imul(V,je)|0,R=R+Math.imul(x,De)|0,k=k+Math.imul(x,je)|0;var Xt=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(Xt>>>26)|0,Xt&=67108863,B=Math.imul(oe,ie),R=Math.imul(oe,se),R=R+Math.imul(ce,ie)|0,k=Math.imul(ce,se),B=B+Math.imul(z,ge)|0,R=R+Math.imul(z,be)|0,R=R+Math.imul(J,ge)|0,k=k+Math.imul(J,be)|0,B=B+Math.imul(G,_e)|0,R=R+Math.imul(G,Re)|0,R=R+Math.imul(U,_e)|0,k=k+Math.imul(U,Re)|0,B=B+Math.imul(re,Ce)|0,R=R+Math.imul(re,Me)|0,R=R+Math.imul(ue,Ce)|0,k=k+Math.imul(ue,Me)|0,B=B+Math.imul(X,ke)|0,R=R+Math.imul(X,xe)|0,R=R+Math.imul($,ke)|0,k=k+Math.imul($,xe)|0,B=B+Math.imul(te,De)|0,R=R+Math.imul(te,je)|0,R=R+Math.imul(ae,De)|0,k=k+Math.imul(ae,je)|0,B=B+Math.imul(V,Oe)|0,R=R+Math.imul(V,Ue)|0,R=R+Math.imul(x,Oe)|0,k=k+Math.imul(x,Ue)|0;var Zt=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(Zt>>>26)|0,Zt&=67108863,B=Math.imul(he,ie),R=Math.imul(he,se),R=R+Math.imul(fe,ie)|0,k=Math.imul(fe,se),B=B+Math.imul(oe,ge)|0,R=R+Math.imul(oe,be)|0,R=R+Math.imul(ce,ge)|0,k=k+Math.imul(ce,be)|0,B=B+Math.imul(z,_e)|0,R=R+Math.imul(z,Re)|0,R=R+Math.imul(J,_e)|0,k=k+Math.imul(J,Re)|0,B=B+Math.imul(G,Ce)|0,R=R+Math.imul(G,Me)|0,R=R+Math.imul(U,Ce)|0,k=k+Math.imul(U,Me)|0,B=B+Math.imul(re,ke)|0,R=R+Math.imul(re,xe)|0,R=R+Math.imul(ue,ke)|0,k=k+Math.imul(ue,xe)|0,B=B+Math.imul(X,De)|0,R=R+Math.imul(X,je)|0,R=R+Math.imul($,De)|0,k=k+Math.imul($,je)|0,B=B+Math.imul(te,Oe)|0,R=R+Math.imul(te,Ue)|0,R=R+Math.imul(ae,Oe)|0,k=k+Math.imul(ae,Ue)|0,B=B+Math.imul(V,Ne)|0,R=R+Math.imul(V,Je)|0,R=R+Math.imul(x,Ne)|0,k=k+Math.imul(x,Je)|0;var en=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(en>>>26)|0,en&=67108863,B=Math.imul(ye,ie),R=Math.imul(ye,se),R=R+Math.imul(Ee,ie)|0,k=Math.imul(Ee,se),B=B+Math.imul(he,ge)|0,R=R+Math.imul(he,be)|0,R=R+Math.imul(fe,ge)|0,k=k+Math.imul(fe,be)|0,B=B+Math.imul(oe,_e)|0,R=R+Math.imul(oe,Re)|0,R=R+Math.imul(ce,_e)|0,k=k+Math.imul(ce,Re)|0,B=B+Math.imul(z,Ce)|0,R=R+Math.imul(z,Me)|0,R=R+Math.imul(J,Ce)|0,k=k+Math.imul(J,Me)|0,B=B+Math.imul(G,ke)|0,R=R+Math.imul(G,xe)|0,R=R+Math.imul(U,ke)|0,k=k+Math.imul(U,xe)|0,B=B+Math.imul(re,De)|0,R=R+Math.imul(re,je)|0,R=R+Math.imul(ue,De)|0,k=k+Math.imul(ue,je)|0,B=B+Math.imul(X,Oe)|0,R=R+Math.imul(X,Ue)|0,R=R+Math.imul($,Oe)|0,k=k+Math.imul($,Ue)|0,B=B+Math.imul(te,Ne)|0,R=R+Math.imul(te,Je)|0,R=R+Math.imul(ae,Ne)|0,k=k+Math.imul(ae,Je)|0,B=B+Math.imul(V,Ke)|0,R=R+Math.imul(V,nt)|0,R=R+Math.imul(x,Ke)|0,k=k+Math.imul(x,nt)|0;var tn=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(tn>>>26)|0,tn&=67108863,B=Math.imul(me,ie),R=Math.imul(me,se),R=R+Math.imul(N,ie)|0,k=Math.imul(N,se),B=B+Math.imul(ye,ge)|0,R=R+Math.imul(ye,be)|0,R=R+Math.imul(Ee,ge)|0,k=k+Math.imul(Ee,be)|0,B=B+Math.imul(he,_e)|0,R=R+Math.imul(he,Re)|0,R=R+Math.imul(fe,_e)|0,k=k+Math.imul(fe,Re)|0,B=B+Math.imul(oe,Ce)|0,R=R+Math.imul(oe,Me)|0,R=R+Math.imul(ce,Ce)|0,k=k+Math.imul(ce,Me)|0,B=B+Math.imul(z,ke)|0,R=R+Math.imul(z,xe)|0,R=R+Math.imul(J,ke)|0,k=k+Math.imul(J,xe)|0,B=B+Math.imul(G,De)|0,R=R+Math.imul(G,je)|0,R=R+Math.imul(U,De)|0,k=k+Math.imul(U,je)|0,B=B+Math.imul(re,Oe)|0,R=R+Math.imul(re,Ue)|0,R=R+Math.imul(ue,Oe)|0,k=k+Math.imul(ue,Ue)|0,B=B+Math.imul(X,Ne)|0,R=R+Math.imul(X,Je)|0,R=R+Math.imul($,Ne)|0,k=k+Math.imul($,Je)|0,B=B+Math.imul(te,Ke)|0,R=R+Math.imul(te,nt)|0,R=R+Math.imul(ae,Ke)|0,k=k+Math.imul(ae,nt)|0,B=B+Math.imul(V,He)|0,R=R+Math.imul(V,rt)|0,R=R+Math.imul(x,He)|0,k=k+Math.imul(x,rt)|0;var nn=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(nn>>>26)|0,nn&=67108863,B=Math.imul(me,ge),R=Math.imul(me,be),R=R+Math.imul(N,ge)|0,k=Math.imul(N,be),B=B+Math.imul(ye,_e)|0,R=R+Math.imul(ye,Re)|0,R=R+Math.imul(Ee,_e)|0,k=k+Math.imul(Ee,Re)|0,B=B+Math.imul(he,Ce)|0,R=R+Math.imul(he,Me)|0,R=R+Math.imul(fe,Ce)|0,k=k+Math.imul(fe,Me)|0,B=B+Math.imul(oe,ke)|0,R=R+Math.imul(oe,xe)|0,R=R+Math.imul(ce,ke)|0,k=k+Math.imul(ce,xe)|0,B=B+Math.imul(z,De)|0,R=R+Math.imul(z,je)|0,R=R+Math.imul(J,De)|0,k=k+Math.imul(J,je)|0,B=B+Math.imul(G,Oe)|0,R=R+Math.imul(G,Ue)|0,R=R+Math.imul(U,Oe)|0,k=k+Math.imul(U,Ue)|0,B=B+Math.imul(re,Ne)|0,R=R+Math.imul(re,Je)|0,R=R+Math.imul(ue,Ne)|0,k=k+Math.imul(ue,Je)|0,B=B+Math.imul(X,Ke)|0,R=R+Math.imul(X,nt)|0,R=R+Math.imul($,Ke)|0,k=k+Math.imul($,nt)|0,B=B+Math.imul(te,He)|0,R=R+Math.imul(te,rt)|0,R=R+Math.imul(ae,He)|0,k=k+Math.imul(ae,rt)|0;var rn=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(rn>>>26)|0,rn&=67108863,B=Math.imul(me,_e),R=Math.imul(me,Re),R=R+Math.imul(N,_e)|0,k=Math.imul(N,Re),B=B+Math.imul(ye,Ce)|0,R=R+Math.imul(ye,Me)|0,R=R+Math.imul(Ee,Ce)|0,k=k+Math.imul(Ee,Me)|0,B=B+Math.imul(he,ke)|0,R=R+Math.imul(he,xe)|0,R=R+Math.imul(fe,ke)|0,k=k+Math.imul(fe,xe)|0,B=B+Math.imul(oe,De)|0,R=R+Math.imul(oe,je)|0,R=R+Math.imul(ce,De)|0,k=k+Math.imul(ce,je)|0,B=B+Math.imul(z,Oe)|0,R=R+Math.imul(z,Ue)|0,R=R+Math.imul(J,Oe)|0,k=k+Math.imul(J,Ue)|0,B=B+Math.imul(G,Ne)|0,R=R+Math.imul(G,Je)|0,R=R+Math.imul(U,Ne)|0,k=k+Math.imul(U,Je)|0,B=B+Math.imul(re,Ke)|0,R=R+Math.imul(re,nt)|0,R=R+Math.imul(ue,Ke)|0,k=k+Math.imul(ue,nt)|0,B=B+Math.imul(X,He)|0,R=R+Math.imul(X,rt)|0,R=R+Math.imul($,He)|0,k=k+Math.imul($,rt)|0;var sn=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(sn>>>26)|0,sn&=67108863,B=Math.imul(me,Ce),R=Math.imul(me,Me),R=R+Math.imul(N,Ce)|0,k=Math.imul(N,Me),B=B+Math.imul(ye,ke)|0,R=R+Math.imul(ye,xe)|0,R=R+Math.imul(Ee,ke)|0,k=k+Math.imul(Ee,xe)|0,B=B+Math.imul(he,De)|0,R=R+Math.imul(he,je)|0,R=R+Math.imul(fe,De)|0,k=k+Math.imul(fe,je)|0,B=B+Math.imul(oe,Oe)|0,R=R+Math.imul(oe,Ue)|0,R=R+Math.imul(ce,Oe)|0,k=k+Math.imul(ce,Ue)|0,B=B+Math.imul(z,Ne)|0,R=R+Math.imul(z,Je)|0,R=R+Math.imul(J,Ne)|0,k=k+Math.imul(J,Je)|0,B=B+Math.imul(G,Ke)|0,R=R+Math.imul(G,nt)|0,R=R+Math.imul(U,Ke)|0,k=k+Math.imul(U,nt)|0,B=B+Math.imul(re,He)|0,R=R+Math.imul(re,rt)|0,R=R+Math.imul(ue,He)|0,k=k+Math.imul(ue,rt)|0;var on=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(on>>>26)|0,on&=67108863,B=Math.imul(me,ke),R=Math.imul(me,xe),R=R+Math.imul(N,ke)|0,k=Math.imul(N,xe),B=B+Math.imul(ye,De)|0,R=R+Math.imul(ye,je)|0,R=R+Math.imul(Ee,De)|0,k=k+Math.imul(Ee,je)|0,B=B+Math.imul(he,Oe)|0,R=R+Math.imul(he,Ue)|0,R=R+Math.imul(fe,Oe)|0,k=k+Math.imul(fe,Ue)|0,B=B+Math.imul(oe,Ne)|0,R=R+Math.imul(oe,Je)|0,R=R+Math.imul(ce,Ne)|0,k=k+Math.imul(ce,Je)|0,B=B+Math.imul(z,Ke)|0,R=R+Math.imul(z,nt)|0,R=R+Math.imul(J,Ke)|0,k=k+Math.imul(J,nt)|0,B=B+Math.imul(G,He)|0,R=R+Math.imul(G,rt)|0,R=R+Math.imul(U,He)|0,k=k+Math.imul(U,rt)|0;var an=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(an>>>26)|0,an&=67108863,B=Math.imul(me,De),R=Math.imul(me,je),R=R+Math.imul(N,De)|0,k=Math.imul(N,je),B=B+Math.imul(ye,Oe)|0,R=R+Math.imul(ye,Ue)|0,R=R+Math.imul(Ee,Oe)|0,k=k+Math.imul(Ee,Ue)|0,B=B+Math.imul(he,Ne)|0,R=R+Math.imul(he,Je)|0,R=R+Math.imul(fe,Ne)|0,k=k+Math.imul(fe,Je)|0,B=B+Math.imul(oe,Ke)|0,R=R+Math.imul(oe,nt)|0,R=R+Math.imul(ce,Ke)|0,k=k+Math.imul(ce,nt)|0,B=B+Math.imul(z,He)|0,R=R+Math.imul(z,rt)|0,R=R+Math.imul(J,He)|0,k=k+Math.imul(J,rt)|0;var cn=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(cn>>>26)|0,cn&=67108863,B=Math.imul(me,Oe),R=Math.imul(me,Ue),R=R+Math.imul(N,Oe)|0,k=Math.imul(N,Ue),B=B+Math.imul(ye,Ne)|0,R=R+Math.imul(ye,Je)|0,R=R+Math.imul(Ee,Ne)|0,k=k+Math.imul(Ee,Je)|0,B=B+Math.imul(he,Ke)|0,R=R+Math.imul(he,nt)|0,R=R+Math.imul(fe,Ke)|0,k=k+Math.imul(fe,nt)|0,B=B+Math.imul(oe,He)|0,R=R+Math.imul(oe,rt)|0,R=R+Math.imul(ce,He)|0,k=k+Math.imul(ce,rt)|0;var ln=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(ln>>>26)|0,ln&=67108863,B=Math.imul(me,Ne),R=Math.imul(me,Je),R=R+Math.imul(N,Ne)|0,k=Math.imul(N,Je),B=B+Math.imul(ye,Ke)|0,R=R+Math.imul(ye,nt)|0,R=R+Math.imul(Ee,Ke)|0,k=k+Math.imul(Ee,nt)|0,B=B+Math.imul(he,He)|0,R=R+Math.imul(he,rt)|0,R=R+Math.imul(fe,He)|0,k=k+Math.imul(fe,rt)|0;var dn=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(dn>>>26)|0,dn&=67108863,B=Math.imul(me,Ke),R=Math.imul(me,nt),R=R+Math.imul(N,Ke)|0,k=Math.imul(N,nt),B=B+Math.imul(ye,He)|0,R=R+Math.imul(ye,rt)|0,R=R+Math.imul(Ee,He)|0,k=k+Math.imul(Ee,rt)|0;var un=(q+B|0)+((R&8191)<<13)|0;q=(k+(R>>>13)|0)+(un>>>26)|0,un&=67108863,B=Math.imul(me,He),R=Math.imul(me,rt),R=R+Math.imul(N,He)|0,k=Math.imul(N,rt);var fn=(q+B|0)+((R&8191)<<13)|0;return q=(k+(R>>>13)|0)+(fn>>>26)|0,fn&=67108863,Y[0]=Ze,Y[1]=et,Y[2]=Yt,Y[3]=Jt,Y[4]=Qt,Y[5]=Xt,Y[6]=Zt,Y[7]=en,Y[8]=tn,Y[9]=nn,Y[10]=rn,Y[11]=sn,Y[12]=on,Y[13]=an,Y[14]=cn,Y[15]=ln,Y[16]=dn,Y[17]=un,Y[18]=fn,q!==0&&(Y[19]=q,I.length++),I};Math.imul||(o=s);function l(F,C,O){O.negative=C.negative^F.negative,O.length=F.length+C.length;for(var I=0,D=0,j=0;j<O.length-1;j++){var Y=D;D=0;for(var q=I&67108863,B=Math.min(j,C.length-1),R=Math.max(0,j-F.length+1);R<=B;R++){var k=j-R,P=F.words[k]|0,V=C.words[R]|0,x=P*V,Q=x&67108863;Y=Y+(x/67108864|0)|0,Q=Q+q|0,q=Q&67108863,Y=Y+(Q>>>26)|0,D+=Y>>>26,Y&=67108863}O.words[j]=q,I=Y,Y=D}return I!==0?O.words[j]=I:O.length--,O.strip()}function v(F,C,O){var I=new f;return I.mulp(F,C,O)}c.prototype.mulTo=function(C,O){var I,D=this.length+C.length;return this.length===10&&C.length===10?I=o(this,C,O):D<63?I=s(this,C,O):D<1024?I=l(this,C,O):I=v(this,C,O),I};function f(F,C){this.x=F,this.y=C}f.prototype.makeRBT=function(C){for(var O=new Array(C),I=c.prototype._countBits(C)-1,D=0;D<C;D++)O[D]=this.revBin(D,I,C);return O},f.prototype.revBin=function(C,O,I){if(C===0||C===I-1)return C;for(var D=0,j=0;j<O;j++)D|=(C&1)<<O-j-1,C>>=1;return D},f.prototype.permute=function(C,O,I,D,j,Y){for(var q=0;q<Y;q++)D[q]=O[C[q]],j[q]=I[C[q]]},f.prototype.transform=function(C,O,I,D,j,Y){this.permute(Y,C,O,I,D,j);for(var q=1;q<j;q<<=1)for(var B=q<<1,R=Math.cos(2*Math.PI/B),k=Math.sin(2*Math.PI/B),P=0;P<j;P+=B)for(var V=R,x=k,Q=0;Q<q;Q++){var te=I[P+Q],ae=D[P+Q],de=I[P+Q+q],X=D[P+Q+q],$=V*de-x*X;X=V*X+x*de,de=$,I[P+Q]=te+de,D[P+Q]=ae+X,I[P+Q+q]=te-de,D[P+Q+q]=ae-X,Q!==B&&($=R*V-k*x,x=R*x+k*V,V=$)}},f.prototype.guessLen13b=function(C,O){var I=Math.max(O,C)|1,D=I&1,j=0;for(I=I/2|0;I;I=I>>>1)j++;return 1<<j+1+D},f.prototype.conjugate=function(C,O,I){if(!(I<=1))for(var D=0;D<I/2;D++){var j=C[D];C[D]=C[I-D-1],C[I-D-1]=j,j=O[D],O[D]=-O[I-D-1],O[I-D-1]=-j}},f.prototype.normalize13b=function(C,O){for(var I=0,D=0;D<O/2;D++){var j=Math.round(C[2*D+1]/O)*8192+Math.round(C[2*D]/O)+I;C[D]=j&67108863,j<67108864?I=0:I=j/67108864|0}return C},f.prototype.convert13b=function(C,O,I,D){for(var j=0,Y=0;Y<O;Y++)j=j+(C[Y]|0),I[2*Y]=j&8191,j=j>>>13,I[2*Y+1]=j&8191,j=j>>>13;for(Y=2*O;Y<D;++Y)I[Y]=0;S(j===0),S((j&-8192)===0)},f.prototype.stub=function(C){for(var O=new Array(C),I=0;I<C;I++)O[I]=0;return O},f.prototype.mulp=function(C,O,I){var D=2*this.guessLen13b(C.length,O.length),j=this.makeRBT(D),Y=this.stub(D),q=new Array(D),B=new Array(D),R=new Array(D),k=new Array(D),P=new Array(D),V=new Array(D),x=I.words;x.length=D,this.convert13b(C.words,C.length,q,D),this.convert13b(O.words,O.length,k,D),this.transform(q,Y,B,R,D,j),this.transform(k,Y,P,V,D,j);for(var Q=0;Q<D;Q++){var te=B[Q]*P[Q]-R[Q]*V[Q];R[Q]=B[Q]*V[Q]+R[Q]*P[Q],B[Q]=te}return this.conjugate(B,R,D),this.transform(B,R,x,Y,D,j),this.conjugate(x,Y,D),this.normalize13b(x,D),I.negative=C.negative^O.negative,I.length=C.length+O.length,I.strip()},c.prototype.mul=function(C){var O=new c(null);return O.words=new Array(this.length+C.length),this.mulTo(C,O)},c.prototype.mulf=function(C){var O=new c(null);return O.words=new Array(this.length+C.length),v(this,C,O)},c.prototype.imul=function(C){return this.clone().mulTo(C,this)},c.prototype.imuln=function(C){S(typeof C=="number"),S(C<67108864);for(var O=0,I=0;I<this.length;I++){var D=(this.words[I]|0)*C,j=(D&67108863)+(O&67108863);O>>=26,O+=D/67108864|0,O+=j>>>26,this.words[I]=j&67108863}return O!==0&&(this.words[I]=O,this.length++),this},c.prototype.muln=function(C){return this.clone().imuln(C)},c.prototype.sqr=function(){return this.mul(this)},c.prototype.isqr=function(){return this.imul(this.clone())},c.prototype.pow=function(C){var O=r(C);if(O.length===0)return new c(1);for(var I=this,D=0;D<O.length&&O[D]===0;D++,I=I.sqr());if(++D<O.length)for(var j=I.sqr();D<O.length;D++,j=j.sqr())O[D]!==0&&(I=I.mul(j));return I},c.prototype.iushln=function(C){S(typeof C=="number"&&C>=0);var O=C%26,I=(C-O)/26,D=67108863>>>26-O<<26-O,j;if(O!==0){var Y=0;for(j=0;j<this.length;j++){var q=this.words[j]&D,B=(this.words[j]|0)-q<<O;this.words[j]=B|Y,Y=q>>>26-O}Y&&(this.words[j]=Y,this.length++)}if(I!==0){for(j=this.length-1;j>=0;j--)this.words[j+I]=this.words[j];for(j=0;j<I;j++)this.words[j]=0;this.length+=I}return this.strip()},c.prototype.ishln=function(C){return S(this.negative===0),this.iushln(C)},c.prototype.iushrn=function(C,O,I){S(typeof C=="number"&&C>=0);var D;O?D=(O-O%26)/26:D=0;var j=C%26,Y=Math.min((C-j)/26,this.length),q=67108863^67108863>>>j<<j,B=I;if(D-=Y,D=Math.max(0,D),B){for(var R=0;R<Y;R++)B.words[R]=this.words[R];B.length=Y}if(Y!==0)if(this.length>Y)for(this.length-=Y,R=0;R<this.length;R++)this.words[R]=this.words[R+Y];else this.words[0]=0,this.length=1;var k=0;for(R=this.length-1;R>=0&&(k!==0||R>=D);R--){var P=this.words[R]|0;this.words[R]=k<<26-j|P>>>j,k=P&q}return B&&k!==0&&(B.words[B.length++]=k),this.length===0&&(this.words[0]=0,this.length=1),this.strip()},c.prototype.ishrn=function(C,O,I){return S(this.negative===0),this.iushrn(C,O,I)},c.prototype.shln=function(C){return this.clone().ishln(C)},c.prototype.ushln=function(C){return this.clone().iushln(C)},c.prototype.shrn=function(C){return this.clone().ishrn(C)},c.prototype.ushrn=function(C){return this.clone().iushrn(C)},c.prototype.testn=function(C){S(typeof C=="number"&&C>=0);var O=C%26,I=(C-O)/26,D=1<<O;if(this.length<=I)return!1;var j=this.words[I];return!!(j&D)},c.prototype.imaskn=function(C){S(typeof C=="number"&&C>=0);var O=C%26,I=(C-O)/26;if(S(this.negative===0,"imaskn works only with positive numbers"),this.length<=I)return this;if(O!==0&&I++,this.length=Math.min(I,this.length),O!==0){var D=67108863^67108863>>>O<<O;this.words[this.length-1]&=D}return this.strip()},c.prototype.maskn=function(C){return this.clone().imaskn(C)},c.prototype.iaddn=function(C){return S(typeof C=="number"),S(C<67108864),C<0?this.isubn(-C):this.negative!==0?this.length===1&&(this.words[0]|0)<C?(this.words[0]=C-(this.words[0]|0),this.negative=0,this):(this.negative=0,this.isubn(C),this.negative=1,this):this._iaddn(C)},c.prototype._iaddn=function(C){this.words[0]+=C;for(var O=0;O<this.length&&this.words[O]>=67108864;O++)this.words[O]-=67108864,O===this.length-1?this.words[O+1]=1:this.words[O+1]++;return this.length=Math.max(this.length,O+1),this},c.prototype.isubn=function(C){if(S(typeof C=="number"),S(C<67108864),C<0)return this.iaddn(-C);if(this.negative!==0)return this.negative=0,this.iaddn(C),this.negative=1,this;if(this.words[0]-=C,this.length===1&&this.words[0]<0)this.words[0]=-this.words[0],this.negative=1;else for(var O=0;O<this.length&&this.words[O]<0;O++)this.words[O]+=67108864,this.words[O+1]-=1;return this.strip()},c.prototype.addn=function(C){return this.clone().iaddn(C)},c.prototype.subn=function(C){return this.clone().isubn(C)},c.prototype.iabs=function(){return this.negative=0,this},c.prototype.abs=function(){return this.clone().iabs()},c.prototype._ishlnsubmul=function(C,O,I){var D=C.length+I,j;this._expand(D);var Y,q=0;for(j=0;j<C.length;j++){Y=(this.words[j+I]|0)+q;var B=(C.words[j]|0)*O;Y-=B&67108863,q=(Y>>26)-(B/67108864|0),this.words[j+I]=Y&67108863}for(;j<this.length-I;j++)Y=(this.words[j+I]|0)+q,q=Y>>26,this.words[j+I]=Y&67108863;if(q===0)return this.strip();for(S(q===-1),q=0,j=0;j<this.length;j++)Y=-(this.words[j]|0)+q,q=Y>>26,this.words[j]=Y&67108863;return this.negative=1,this.strip()},c.prototype._wordDiv=function(C,O){var I=this.length-C.length,D=this.clone(),j=C,Y=j.words[j.length-1]|0,q=this._countBits(Y);I=26-q,I!==0&&(j=j.ushln(I),D.iushln(I),Y=j.words[j.length-1]|0);var B=D.length-j.length,R;if(O!=="mod"){R=new c(null),R.length=B+1,R.words=new Array(R.length);for(var k=0;k<R.length;k++)R.words[k]=0}var P=D.clone()._ishlnsubmul(j,1,B);P.negative===0&&(D=P,R&&(R.words[B]=1));for(var V=B-1;V>=0;V--){var x=(D.words[j.length+V]|0)*67108864+(D.words[j.length+V-1]|0);for(x=Math.min(x/Y|0,67108863),D._ishlnsubmul(j,x,V);D.negative!==0;)x--,D.negative=0,D._ishlnsubmul(j,1,V),D.isZero()||(D.negative^=1);R&&(R.words[V]=x)}return R&&R.strip(),D.strip(),O!=="div"&&I!==0&&D.iushrn(I),{div:R||null,mod:D}},c.prototype.divmod=function(C,O,I){if(S(!C.isZero()),this.isZero())return{div:new c(0),mod:new c(0)};var D,j,Y;return this.negative!==0&&C.negative===0?(Y=this.neg().divmod(C,O),O!=="mod"&&(D=Y.div.neg()),O!=="div"&&(j=Y.mod.neg(),I&&j.negative!==0&&j.iadd(C)),{div:D,mod:j}):this.negative===0&&C.negative!==0?(Y=this.divmod(C.neg(),O),O!=="mod"&&(D=Y.div.neg()),{div:D,mod:Y.mod}):this.negative&C.negative?(Y=this.neg().divmod(C.neg(),O),O!=="div"&&(j=Y.mod.neg(),I&&j.negative!==0&&j.isub(C)),{div:Y.div,mod:j}):C.length>this.length||this.cmp(C)<0?{div:new c(0),mod:this}:C.length===1?O==="div"?{div:this.divn(C.words[0]),mod:null}:O==="mod"?{div:null,mod:new c(this.modn(C.words[0]))}:{div:this.divn(C.words[0]),mod:new c(this.modn(C.words[0]))}:this._wordDiv(C,O)},c.prototype.div=function(C){return this.divmod(C,"div",!1).div},c.prototype.mod=function(C){return this.divmod(C,"mod",!1).mod},c.prototype.umod=function(C){return this.divmod(C,"mod",!0).mod},c.prototype.divRound=function(C){var O=this.divmod(C);if(O.mod.isZero())return O.div;var I=O.div.negative!==0?O.mod.isub(C):O.mod,D=C.ushrn(1),j=C.andln(1),Y=I.cmp(D);return Y<0||j===1&&Y===0?O.div:O.div.negative!==0?O.div.isubn(1):O.div.iaddn(1)},c.prototype.modn=function(C){S(C<=67108863);for(var O=(1<<26)%C,I=0,D=this.length-1;D>=0;D--)I=(O*I+(this.words[D]|0))%C;return I},c.prototype.idivn=function(C){S(C<=67108863);for(var O=0,I=this.length-1;I>=0;I--){var D=(this.words[I]|0)+O*67108864;this.words[I]=D/C|0,O=D%C}return this.strip()},c.prototype.divn=function(C){return this.clone().idivn(C)},c.prototype.egcd=function(C){S(C.negative===0),S(!C.isZero());var O=this,I=C.clone();O.negative!==0?O=O.umod(C):O=O.clone();for(var D=new c(1),j=new c(0),Y=new c(0),q=new c(1),B=0;O.isEven()&&I.isEven();)O.iushrn(1),I.iushrn(1),++B;for(var R=I.clone(),k=O.clone();!O.isZero();){for(var P=0,V=1;!(O.words[0]&V)&&P<26;++P,V<<=1);if(P>0)for(O.iushrn(P);P-- >0;)(D.isOdd()||j.isOdd())&&(D.iadd(R),j.isub(k)),D.iushrn(1),j.iushrn(1);for(var x=0,Q=1;!(I.words[0]&Q)&&x<26;++x,Q<<=1);if(x>0)for(I.iushrn(x);x-- >0;)(Y.isOdd()||q.isOdd())&&(Y.iadd(R),q.isub(k)),Y.iushrn(1),q.iushrn(1);O.cmp(I)>=0?(O.isub(I),D.isub(Y),j.isub(q)):(I.isub(O),Y.isub(D),q.isub(j))}return{a:Y,b:q,gcd:I.iushln(B)}},c.prototype._invmp=function(C){S(C.negative===0),S(!C.isZero());var O=this,I=C.clone();O.negative!==0?O=O.umod(C):O=O.clone();for(var D=new c(1),j=new c(0),Y=I.clone();O.cmpn(1)>0&&I.cmpn(1)>0;){for(var q=0,B=1;!(O.words[0]&B)&&q<26;++q,B<<=1);if(q>0)for(O.iushrn(q);q-- >0;)D.isOdd()&&D.iadd(Y),D.iushrn(1);for(var R=0,k=1;!(I.words[0]&k)&&R<26;++R,k<<=1);if(R>0)for(I.iushrn(R);R-- >0;)j.isOdd()&&j.iadd(Y),j.iushrn(1);O.cmp(I)>=0?(O.isub(I),D.isub(j)):(I.isub(O),j.isub(D))}var P;return O.cmpn(1)===0?P=D:P=j,P.cmpn(0)<0&&P.iadd(C),P},c.prototype.gcd=function(C){if(this.isZero())return C.abs();if(C.isZero())return this.abs();var O=this.clone(),I=C.clone();O.negative=0,I.negative=0;for(var D=0;O.isEven()&&I.isEven();D++)O.iushrn(1),I.iushrn(1);do{for(;O.isEven();)O.iushrn(1);for(;I.isEven();)I.iushrn(1);var j=O.cmp(I);if(j<0){var Y=O;O=I,I=Y}else if(j===0||I.cmpn(1)===0)break;O.isub(I)}while(!0);return I.iushln(D)},c.prototype.invm=function(C){return this.egcd(C).a.umod(C)},c.prototype.isEven=function(){return(this.words[0]&1)===0},c.prototype.isOdd=function(){return(this.words[0]&1)===1},c.prototype.andln=function(C){return this.words[0]&C},c.prototype.bincn=function(C){S(typeof C=="number");var O=C%26,I=(C-O)/26,D=1<<O;if(this.length<=I)return this._expand(I+1),this.words[I]|=D,this;for(var j=D,Y=I;j!==0&&Y<this.length;Y++){var q=this.words[Y]|0;q+=j,j=q>>>26,q&=67108863,this.words[Y]=q}return j!==0&&(this.words[Y]=j,this.length++),this},c.prototype.isZero=function(){return this.length===1&&this.words[0]===0},c.prototype.cmpn=function(C){var O=C<0;if(this.negative!==0&&!O)return-1;if(this.negative===0&&O)return 1;this.strip();var I;if(this.length>1)I=1;else{O&&(C=-C),S(C<=67108863,"Number is too big");var D=this.words[0]|0;I=D===C?0:D<C?-1:1}return this.negative!==0?-I|0:I},c.prototype.cmp=function(C){if(this.negative!==0&&C.negative===0)return-1;if(this.negative===0&&C.negative!==0)return 1;var O=this.ucmp(C);return this.negative!==0?-O|0:O},c.prototype.ucmp=function(C){if(this.length>C.length)return 1;if(this.length<C.length)return-1;for(var O=0,I=this.length-1;I>=0;I--){var D=this.words[I]|0,j=C.words[I]|0;if(D!==j){D<j?O=-1:D>j&&(O=1);break}}return O},c.prototype.gtn=function(C){return this.cmpn(C)===1},c.prototype.gt=function(C){return this.cmp(C)===1},c.prototype.gten=function(C){return this.cmpn(C)>=0},c.prototype.gte=function(C){return this.cmp(C)>=0},c.prototype.ltn=function(C){return this.cmpn(C)===-1},c.prototype.lt=function(C){return this.cmp(C)===-1},c.prototype.lten=function(C){return this.cmpn(C)<=0},c.prototype.lte=function(C){return this.cmp(C)<=0},c.prototype.eqn=function(C){return this.cmpn(C)===0},c.prototype.eq=function(C){return this.cmp(C)===0},c.red=function(C){return new W(C)},c.prototype.toRed=function(C){return S(!this.red,"Already a number in reduction context"),S(this.negative===0,"red works only with positives"),C.convertTo(this)._forceRed(C)},c.prototype.fromRed=function(){return S(this.red,"fromRed works only with numbers in reduction context"),this.red.convertFrom(this)},c.prototype._forceRed=function(C){return this.red=C,this},c.prototype.forceRed=function(C){return S(!this.red,"Already a number in reduction context"),this._forceRed(C)},c.prototype.redAdd=function(C){return S(this.red,"redAdd works only with red numbers"),this.red.add(this,C)},c.prototype.redIAdd=function(C){return S(this.red,"redIAdd works only with red numbers"),this.red.iadd(this,C)},c.prototype.redSub=function(C){return S(this.red,"redSub works only with red numbers"),this.red.sub(this,C)},c.prototype.redISub=function(C){return S(this.red,"redISub works only with red numbers"),this.red.isub(this,C)},c.prototype.redShl=function(C){return S(this.red,"redShl works only with red numbers"),this.red.shl(this,C)},c.prototype.redMul=function(C){return S(this.red,"redMul works only with red numbers"),this.red._verify2(this,C),this.red.mul(this,C)},c.prototype.redIMul=function(C){return S(this.red,"redMul works only with red numbers"),this.red._verify2(this,C),this.red.imul(this,C)},c.prototype.redSqr=function(){return S(this.red,"redSqr works only with red numbers"),this.red._verify1(this),this.red.sqr(this)},c.prototype.redISqr=function(){return S(this.red,"redISqr works only with red numbers"),this.red._verify1(this),this.red.isqr(this)},c.prototype.redSqrt=function(){return S(this.red,"redSqrt works only with red numbers"),this.red._verify1(this),this.red.sqrt(this)},c.prototype.redInvm=function(){return S(this.red,"redInvm works only with red numbers"),this.red._verify1(this),this.red.invm(this)},c.prototype.redNeg=function(){return S(this.red,"redNeg works only with red numbers"),this.red._verify1(this),this.red.neg(this)},c.prototype.redPow=function(C){return S(this.red&&!C.red,"redPow(normalNum)"),this.red._verify1(this),this.red.pow(this,C)};var p={k256:null,p224:null,p192:null,p25519:null};function _(F,C){this.name=F,this.p=new c(C,16),this.n=this.p.bitLength(),this.k=new c(1).iushln(this.n).isub(this.p),this.tmp=this._tmp()}_.prototype._tmp=function(){var C=new c(null);return C.words=new Array(Math.ceil(this.n/13)),C},_.prototype.ireduce=function(C){var O=C,I;do this.split(O,this.tmp),O=this.imulK(O),O=O.iadd(this.tmp),I=O.bitLength();while(I>this.n);var D=I<this.n?-1:O.ucmp(this.p);return D===0?(O.words[0]=0,O.length=1):D>0?O.isub(this.p):O.strip!==void 0?O.strip():O._strip(),O},_.prototype.split=function(C,O){C.iushrn(this.n,0,O)},_.prototype.imulK=function(C){return C.imul(this.k)};function T(){_.call(this,"k256","ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f")}y(T,_),T.prototype.split=function(C,O){for(var I=4194303,D=Math.min(C.length,9),j=0;j<D;j++)O.words[j]=C.words[j];if(O.length=D,C.length<=9){C.words[0]=0,C.length=1;return}var Y=C.words[9];for(O.words[O.length++]=Y&I,j=10;j<C.length;j++){var q=C.words[j]|0;C.words[j-10]=(q&I)<<4|Y>>>22,Y=q}Y>>>=22,C.words[j-10]=Y,Y===0&&C.length>10?C.length-=10:C.length-=9},T.prototype.imulK=function(C){C.words[C.length]=0,C.words[C.length+1]=0,C.length+=2;for(var O=0,I=0;I<C.length;I++){var D=C.words[I]|0;O+=D*977,C.words[I]=O&67108863,O=D*64+(O/67108864|0)}return C.words[C.length-1]===0&&(C.length--,C.words[C.length-1]===0&&C.length--),C};function w(){_.call(this,"p224","ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001")}y(w,_);function M(){_.call(this,"p192","ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff")}y(M,_);function A(){_.call(this,"25519","7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed")}y(A,_),A.prototype.imulK=function(C){for(var O=0,I=0;I<C.length;I++){var D=(C.words[I]|0)*19+O,j=D&67108863;D>>>=26,C.words[I]=j,O=D}return O!==0&&(C.words[C.length++]=O),C},c._prime=function(C){if(p[C])return p[C];var O;if(C==="k256")O=new T;else if(C==="p224")O=new w;else if(C==="p192")O=new M;else if(C==="p25519")O=new A;else throw new Error("Unknown prime "+C);return p[C]=O,O};function W(F){if(typeof F=="string"){var C=c._prime(F);this.m=C.p,this.prime=C}else S(F.gtn(1),"modulus must be greater than 1"),this.m=F,this.prime=null}W.prototype._verify1=function(C){S(C.negative===0,"red works only with positives"),S(C.red,"red works only with red numbers")},W.prototype._verify2=function(C,O){S((C.negative|O.negative)===0,"red works only with positives"),S(C.red&&C.red===O.red,"red works only with red numbers")},W.prototype.imod=function(C){return this.prime?this.prime.ireduce(C)._forceRed(this):C.umod(this.m)._forceRed(this)},W.prototype.neg=function(C){return C.isZero()?C.clone():this.m.sub(C)._forceRed(this)},W.prototype.add=function(C,O){this._verify2(C,O);var I=C.add(O);return I.cmp(this.m)>=0&&I.isub(this.m),I._forceRed(this)},W.prototype.iadd=function(C,O){this._verify2(C,O);var I=C.iadd(O);return I.cmp(this.m)>=0&&I.isub(this.m),I},W.prototype.sub=function(C,O){this._verify2(C,O);var I=C.sub(O);return I.cmpn(0)<0&&I.iadd(this.m),I._forceRed(this)},W.prototype.isub=function(C,O){this._verify2(C,O);var I=C.isub(O);return I.cmpn(0)<0&&I.iadd(this.m),I},W.prototype.shl=function(C,O){return this._verify1(C),this.imod(C.ushln(O))},W.prototype.imul=function(C,O){return this._verify2(C,O),this.imod(C.imul(O))},W.prototype.mul=function(C,O){return this._verify2(C,O),this.imod(C.mul(O))},W.prototype.isqr=function(C){return this.imul(C,C.clone())},W.prototype.sqr=function(C){return this.mul(C,C)},W.prototype.sqrt=function(C){if(C.isZero())return C.clone();var O=this.m.andln(3);if(S(O%2===1),O===3){var I=this.m.add(new c(1)).iushrn(2);return this.pow(C,I)}for(var D=this.m.subn(1),j=0;!D.isZero()&&D.andln(1)===0;)j++,D.iushrn(1);S(!D.isZero());var Y=new c(1).toRed(this),q=Y.redNeg(),B=this.m.subn(1).iushrn(1),R=this.m.bitLength();for(R=new c(2*R*R).toRed(this);this.pow(R,B).cmp(q)!==0;)R.redIAdd(q);for(var k=this.pow(R,D),P=this.pow(C,D.addn(1).iushrn(1)),V=this.pow(C,D),x=j;V.cmp(Y)!==0;){for(var Q=V,te=0;Q.cmp(Y)!==0;te++)Q=Q.redSqr();S(te<x);var ae=this.pow(k,new c(1).iushln(x-te-1));P=P.redMul(ae),k=ae.redSqr(),V=V.redMul(k),x=te}return P},W.prototype.invm=function(C){var O=C._invmp(this.m);return O.negative!==0?(O.negative=0,this.imod(O).redNeg()):this.imod(O)},W.prototype.pow=function(C,O){if(O.isZero())return new c(1).toRed(this);if(O.cmpn(1)===0)return C.clone();var I=4,D=new Array(1<<I);D[0]=new c(1).toRed(this),D[1]=C;for(var j=2;j<D.length;j++)D[j]=this.mul(D[j-1],C);var Y=D[0],q=0,B=0,R=O.bitLength()%26;for(R===0&&(R=26),j=O.length-1;j>=0;j--){for(var k=O.words[j],P=R-1;P>=0;P--){var V=k>>P&1;if(Y!==D[0]&&(Y=this.sqr(Y)),V===0&&q===0){B=0;continue}q<<=1,q|=V,B++,!(B!==I&&(j!==0||P!==0))&&(Y=this.mul(Y,D[q]),B=0,q=0)}R=26}return Y},W.prototype.convertTo=function(C){var O=C.umod(this.m);return O===C?O.clone():O},W.prototype.convertFrom=function(C){var O=C.clone();return O.red=null,O},c.mont=function(C){return new ee(C)};function ee(F){W.call(this,F),this.shift=this.m.bitLength(),this.shift%26!==0&&(this.shift+=26-this.shift%26),this.r=new c(1).iushln(this.shift),this.r2=this.imod(this.r.sqr()),this.rinv=this.r._invmp(this.m),this.minv=this.rinv.mul(this.r).isubn(1).div(this.m),this.minv=this.minv.umod(this.r),this.minv=this.r.sub(this.minv)}y(ee,W),ee.prototype.convertTo=function(C){return this.imod(C.ushln(this.shift))},ee.prototype.convertFrom=function(C){var O=this.imod(C.mul(this.rinv));return O.red=null,O},ee.prototype.imul=function(C,O){if(C.isZero()||O.isZero())return C.words[0]=0,C.length=1,C;var I=C.imul(O),D=I.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),j=I.isub(D).iushrn(this.shift),Y=j;return j.cmp(this.m)>=0?Y=j.isub(this.m):j.cmpn(0)<0&&(Y=j.iadd(this.m)),Y._forceRed(this)},ee.prototype.mul=function(C,O){if(C.isZero()||O.isZero())return new c(0)._forceRed(this);var I=C.mul(O),D=I.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),j=I.isub(D).iushrn(this.shift),Y=j;return j.cmp(this.m)>=0?Y=j.isub(this.m):j.cmpn(0)<0&&(Y=j.iadd(this.m)),Y._forceRed(this)},ee.prototype.invm=function(C){var O=this.imod(C._invmp(this.m).mul(this.r2));return O._forceRed(this)}})(typeof E>"u"||E,this)},{buffer:20}],19:[function(t,E,e){var u;E.exports=function(c){return u||(u=new g(null)),u.generate(c)};function g(y){this.rand=y}if(E.exports.Rand=g,g.prototype.generate=function(c){return this._rand(c)},g.prototype._rand=function(c){if(this.rand.getBytes)return this.rand.getBytes(c);for(var m=new Uint8Array(c),h=0;h<m.length;h++)m[h]=this.rand.getByte();return m},typeof self=="object")self.crypto&&self.crypto.getRandomValues?g.prototype._rand=function(c){var m=new Uint8Array(c);return self.crypto.getRandomValues(m),m}:self.msCrypto&&self.msCrypto.getRandomValues?g.prototype._rand=function(c){var m=new Uint8Array(c);return self.msCrypto.getRandomValues(m),m}:typeof window=="object"&&(g.prototype._rand=function(){throw new Error("Not implemented yet")});else try{var S=t("crypto");if(typeof S.randomBytes!="function")throw new Error("Not supported");g.prototype._rand=function(c){return S.randomBytes(c)}}catch{}},{crypto:20}],20:[function(t,E,e){},{}],21:[function(t,E,e){var u=t("safe-buffer").Buffer;function g(d){u.isBuffer(d)||(d=u.from(d));for(var b=d.length/4|0,a=new Array(b),n=0;n<b;n++)a[n]=d.readUInt32BE(n*4);return a}function S(d){for(var b=0;b<d.length;d++)d[b]=0}function y(d,b,a,n,i){for(var r=a[0],s=a[1],o=a[2],l=a[3],v=d[0]^b[0],f=d[1]^b[1],p=d[2]^b[2],_=d[3]^b[3],T,w,M,A,W=4,ee=1;ee<i;ee++)T=r[v>>>24]^s[f>>>16&255]^o[p>>>8&255]^l[_&255]^b[W++],w=r[f>>>24]^s[p>>>16&255]^o[_>>>8&255]^l[v&255]^b[W++],M=r[p>>>24]^s[_>>>16&255]^o[v>>>8&255]^l[f&255]^b[W++],A=r[_>>>24]^s[v>>>16&255]^o[f>>>8&255]^l[p&255]^b[W++],v=T,f=w,p=M,_=A;return T=(n[v>>>24]<<24|n[f>>>16&255]<<16|n[p>>>8&255]<<8|n[_&255])^b[W++],w=(n[f>>>24]<<24|n[p>>>16&255]<<16|n[_>>>8&255]<<8|n[v&255])^b[W++],M=(n[p>>>24]<<24|n[_>>>16&255]<<16|n[v>>>8&255]<<8|n[f&255])^b[W++],A=(n[_>>>24]<<24|n[v>>>16&255]<<16|n[f>>>8&255]<<8|n[p&255])^b[W++],T=T>>>0,w=w>>>0,M=M>>>0,A=A>>>0,[T,w,M,A]}var c=[0,1,2,4,8,16,32,64,128,27,54],m=function(){for(var d=new Array(256),b=0;b<256;b++)b<128?d[b]=b<<1:d[b]=b<<1^283;for(var a=[],n=[],i=[[],[],[],[]],r=[[],[],[],[]],s=0,o=0,l=0;l<256;++l){var v=o^o<<1^o<<2^o<<3^o<<4;v=v>>>8^v&255^99,a[s]=v,n[v]=s;var f=d[s],p=d[f],_=d[p],T=d[v]*257^v*16843008;i[0][s]=T<<24|T>>>8,i[1][s]=T<<16|T>>>16,i[2][s]=T<<8|T>>>24,i[3][s]=T,T=_*16843009^p*65537^f*257^s*16843008,r[0][v]=T<<24|T>>>8,r[1][v]=T<<16|T>>>16,r[2][v]=T<<8|T>>>24,r[3][v]=T,s===0?s=o=1:(s=f^d[d[d[_^f]]],o^=d[d[o]])}return{SBOX:a,INV_SBOX:n,SUB_MIX:i,INV_SUB_MIX:r}}();function h(d){this._key=g(d),this._reset()}h.blockSize=4*4,h.keySize=256/8,h.prototype.blockSize=h.blockSize,h.prototype.keySize=h.keySize,h.prototype._reset=function(){for(var d=this._key,b=d.length,a=b+6,n=(a+1)*4,i=[],r=0;r<b;r++)i[r]=d[r];for(r=b;r<n;r++){var s=i[r-1];r%b===0?(s=s<<8|s>>>24,s=m.SBOX[s>>>24]<<24|m.SBOX[s>>>16&255]<<16|m.SBOX[s>>>8&255]<<8|m.SBOX[s&255],s^=c[r/b|0]<<24):b>6&&r%b===4&&(s=m.SBOX[s>>>24]<<24|m.SBOX[s>>>16&255]<<16|m.SBOX[s>>>8&255]<<8|m.SBOX[s&255]),i[r]=i[r-b]^s}for(var o=[],l=0;l<n;l++){var v=n-l,f=i[v-(l%4?0:4)];l<4||v<=4?o[l]=f:o[l]=m.INV_SUB_MIX[0][m.SBOX[f>>>24]]^m.INV_SUB_MIX[1][m.SBOX[f>>>16&255]]^m.INV_SUB_MIX[2][m.SBOX[f>>>8&255]]^m.INV_SUB_MIX[3][m.SBOX[f&255]]}this._nRounds=a,this._keySchedule=i,this._invKeySchedule=o},h.prototype.encryptBlockRaw=function(d){return d=g(d),y(d,this._keySchedule,m.SUB_MIX,m.SBOX,this._nRounds)},h.prototype.encryptBlock=function(d){var b=this.encryptBlockRaw(d),a=u.allocUnsafe(16);return a.writeUInt32BE(b[0],0),a.writeUInt32BE(b[1],4),a.writeUInt32BE(b[2],8),a.writeUInt32BE(b[3],12),a},h.prototype.decryptBlock=function(d){d=g(d);var b=d[1];d[1]=d[3],d[3]=b;var a=y(d,this._invKeySchedule,m.INV_SUB_MIX,m.INV_SBOX,this._nRounds),n=u.allocUnsafe(16);return n.writeUInt32BE(a[0],0),n.writeUInt32BE(a[3],4),n.writeUInt32BE(a[2],8),n.writeUInt32BE(a[1],12),n},h.prototype.scrub=function(){S(this._keySchedule),S(this._invKeySchedule),S(this._key)},E.exports.AES=h},{"safe-buffer":250}],22:[function(t,E,e){var u=t("./aes"),g=t("safe-buffer").Buffer,S=t("cipher-base"),y=t("inherits"),c=t("./ghash"),m=t("buffer-xor"),h=t("./incr32");function d(n,i){var r=0;n.length!==i.length&&r++;for(var s=Math.min(n.length,i.length),o=0;o<s;++o)r+=n[o]^i[o];return r}function b(n,i,r){if(i.length===12)return n._finID=g.concat([i,g.from([0,0,0,1])]),g.concat([i,g.from([0,0,0,2])]);var s=new c(r),o=i.length,l=o%16;s.update(i),l&&(l=16-l,s.update(g.alloc(l,0))),s.update(g.alloc(8,0));var v=o*8,f=g.alloc(8);f.writeUIntBE(v,0,8),s.update(f),n._finID=s.state;var p=g.from(n._finID);return h(p),p}function a(n,i,r,s){S.call(this);var o=g.alloc(4,0);this._cipher=new u.AES(i);var l=this._cipher.encryptBlock(o);this._ghash=new c(l),r=b(this,r,l),this._prev=g.from(r),this._cache=g.allocUnsafe(0),this._secCache=g.allocUnsafe(0),this._decrypt=s,this._alen=0,this._len=0,this._mode=n,this._authTag=null,this._called=!1}y(a,S),a.prototype._update=function(n){if(!this._called&&this._alen){var i=16-this._alen%16;i<16&&(i=g.alloc(i,0),this._ghash.update(i))}this._called=!0;var r=this._mode.encrypt(this,n);return this._decrypt?this._ghash.update(n):this._ghash.update(r),this._len+=n.length,r},a.prototype._final=function(){if(this._decrypt&&!this._authTag)throw new Error("Unsupported state or unable to authenticate data");var n=m(this._ghash.final(this._alen*8,this._len*8),this._cipher.encryptBlock(this._finID));if(this._decrypt&&d(n,this._authTag))throw new Error("Unsupported state or unable to authenticate data");this._authTag=n,this._cipher.scrub()},a.prototype.getAuthTag=function(){if(this._decrypt||!g.isBuffer(this._authTag))throw new Error("Attempting to get auth tag in unsupported state");return this._authTag},a.prototype.setAuthTag=function(i){if(!this._decrypt)throw new Error("Attempting to set auth tag in unsupported state");this._authTag=i},a.prototype.setAAD=function(i){if(this._called)throw new Error("Attempting to set AAD in unsupported state");this._ghash.update(i),this._alen+=i.length},E.exports=a},{"./aes":21,"./ghash":26,"./incr32":27,"buffer-xor":67,"cipher-base":71,inherits:146,"safe-buffer":250}],23:[function(t,E,e){var u=t("./encrypter"),g=t("./decrypter"),S=t("./modes/list.json");function y(){return Object.keys(S)}e.createCipher=e.Cipher=u.createCipher,e.createCipheriv=e.Cipheriv=u.createCipheriv,e.createDecipher=e.Decipher=g.createDecipher,e.createDecipheriv=e.Decipheriv=g.createDecipheriv,e.listCiphers=e.getCiphers=y},{"./decrypter":24,"./encrypter":25,"./modes/list.json":35}],24:[function(t,E,e){var u=t("./authCipher"),g=t("safe-buffer").Buffer,S=t("./modes"),y=t("./streamCipher"),c=t("cipher-base"),m=t("./aes"),h=t("evp_bytestokey"),d=t("inherits");function b(s,o,l){c.call(this),this._cache=new a,this._last=void 0,this._cipher=new m.AES(o),this._prev=g.from(l),this._mode=s,this._autopadding=!0}d(b,c),b.prototype._update=function(s){this._cache.add(s);for(var o,l,v=[];o=this._cache.get(this._autopadding);)l=this._mode.decrypt(this,o),v.push(l);return g.concat(v)},b.prototype._final=function(){var s=this._cache.flush();if(this._autopadding)return n(this._mode.decrypt(this,s));if(s)throw new Error("data not multiple of block length")},b.prototype.setAutoPadding=function(s){return this._autopadding=!!s,this};function a(){this.cache=g.allocUnsafe(0)}a.prototype.add=function(s){this.cache=g.concat([this.cache,s])},a.prototype.get=function(s){var o;if(s){if(this.cache.length>16)return o=this.cache.slice(0,16),this.cache=this.cache.slice(16),o}else if(this.cache.length>=16)return o=this.cache.slice(0,16),this.cache=this.cache.slice(16),o;return null},a.prototype.flush=function(){if(this.cache.length)return this.cache};function n(s){var o=s[15];if(o<1||o>16)throw new Error("unable to decrypt data");for(var l=-1;++l<o;)if(s[l+(16-o)]!==o)throw new Error("unable to decrypt data");if(o!==16)return s.slice(0,16-o)}function i(s,o,l){var v=S[s.toLowerCase()];if(!v)throw new TypeError("invalid suite type");if(typeof l=="string"&&(l=g.from(l)),v.mode!=="GCM"&&l.length!==v.iv)throw new TypeError("invalid iv length "+l.length);if(typeof o=="string"&&(o=g.from(o)),o.length!==v.key/8)throw new TypeError("invalid key length "+o.length);return v.type==="stream"?new y(v.module,o,l,!0):v.type==="auth"?new u(v.module,o,l,!0):new b(v.module,o,l)}function r(s,o){var l=S[s.toLowerCase()];if(!l)throw new TypeError("invalid suite type");var v=h(o,!1,l.key,l.iv);return i(s,v.key,v.iv)}e.createDecipher=r,e.createDecipheriv=i},{"./aes":21,"./authCipher":22,"./modes":34,"./streamCipher":37,"cipher-base":71,evp_bytestokey:106,inherits:146,"safe-buffer":250}],25:[function(t,E,e){var u=t("./modes"),g=t("./authCipher"),S=t("safe-buffer").Buffer,y=t("./streamCipher"),c=t("cipher-base"),m=t("./aes"),h=t("evp_bytestokey"),d=t("inherits");function b(s,o,l){c.call(this),this._cache=new n,this._cipher=new m.AES(o),this._prev=S.from(l),this._mode=s,this._autopadding=!0}d(b,c),b.prototype._update=function(s){this._cache.add(s);for(var o,l,v=[];o=this._cache.get();)l=this._mode.encrypt(this,o),v.push(l);return S.concat(v)};var a=S.alloc(16,16);b.prototype._final=function(){var s=this._cache.flush();if(this._autopadding)return s=this._mode.encrypt(this,s),this._cipher.scrub(),s;if(!s.equals(a))throw this._cipher.scrub(),new Error("data not multiple of block length")},b.prototype.setAutoPadding=function(s){return this._autopadding=!!s,this};function n(){this.cache=S.allocUnsafe(0)}n.prototype.add=function(s){this.cache=S.concat([this.cache,s])},n.prototype.get=function(){if(this.cache.length>15){var s=this.cache.slice(0,16);return this.cache=this.cache.slice(16),s}return null},n.prototype.flush=function(){for(var s=16-this.cache.length,o=S.allocUnsafe(s),l=-1;++l<s;)o.writeUInt8(s,l);return S.concat([this.cache,o])};function i(s,o,l){var v=u[s.toLowerCase()];if(!v)throw new TypeError("invalid suite type");if(typeof o=="string"&&(o=S.from(o)),o.length!==v.key/8)throw new TypeError("invalid key length "+o.length);if(typeof l=="string"&&(l=S.from(l)),v.mode!=="GCM"&&l.length!==v.iv)throw new TypeError("invalid iv length "+l.length);return v.type==="stream"?new y(v.module,o,l):v.type==="auth"?new g(v.module,o,l):new b(v.module,o,l)}function r(s,o){var l=u[s.toLowerCase()];if(!l)throw new TypeError("invalid suite type");var v=h(o,!1,l.key,l.iv);return i(s,v.key,v.iv)}e.createCipheriv=i,e.createCipher=r},{"./aes":21,"./authCipher":22,"./modes":34,"./streamCipher":37,"cipher-base":71,evp_bytestokey:106,inherits:146,"safe-buffer":250}],26:[function(t,E,e){var u=t("safe-buffer").Buffer,g=u.alloc(16,0);function S(m){return[m.readUInt32BE(0),m.readUInt32BE(4),m.readUInt32BE(8),m.readUInt32BE(12)]}function y(m){var h=u.allocUnsafe(16);return h.writeUInt32BE(m[0]>>>0,0),h.writeUInt32BE(m[1]>>>0,4),h.writeUInt32BE(m[2]>>>0,8),h.writeUInt32BE(m[3]>>>0,12),h}function c(m){this.h=m,this.state=u.alloc(16,0),this.cache=u.allocUnsafe(0)}c.prototype.ghash=function(m){for(var h=-1;++h<m.length;)this.state[h]^=m[h];this._multiply()},c.prototype._multiply=function(){for(var m=S(this.h),h=[0,0,0,0],d,b,a,n=-1;++n<128;){for(b=(this.state[~~(n/8)]&1<<7-n%8)!==0,b&&(h[0]^=m[0],h[1]^=m[1],h[2]^=m[2],h[3]^=m[3]),a=(m[3]&1)!==0,d=3;d>0;d--)m[d]=m[d]>>>1|(m[d-1]&1)<<31;m[0]=m[0]>>>1,a&&(m[0]=m[0]^225<<24)}this.state=y(h)},c.prototype.update=function(m){this.cache=u.concat([this.cache,m]);for(var h;this.cache.length>=16;)h=this.cache.slice(0,16),this.cache=this.cache.slice(16),this.ghash(h)},c.prototype.final=function(m,h){return this.cache.length&&this.ghash(u.concat([this.cache,g],16)),this.ghash(y([0,m,0,h])),this.state},E.exports=c},{"safe-buffer":250}],27:[function(t,E,e){function u(g){for(var S=g.length,y;S--;)if(y=g.readUInt8(S),y===255)g.writeUInt8(0,S);else{y++,g.writeUInt8(y,S);break}}E.exports=u},{}],28:[function(t,E,e){var u=t("buffer-xor");e.encrypt=function(g,S){var y=u(S,g._prev);return g._prev=g._cipher.encryptBlock(y),g._prev},e.decrypt=function(g,S){var y=g._prev;g._prev=S;var c=g._cipher.decryptBlock(S);return u(c,y)}},{"buffer-xor":67}],29:[function(t,E,e){var u=t("safe-buffer").Buffer,g=t("buffer-xor");function S(y,c,m){var h=c.length,d=g(c,y._cache);return y._cache=y._cache.slice(h),y._prev=u.concat([y._prev,m?c:d]),d}e.encrypt=function(y,c,m){for(var h=u.allocUnsafe(0),d;c.length;)if(y._cache.length===0&&(y._cache=y._cipher.encryptBlock(y._prev),y._prev=u.allocUnsafe(0)),y._cache.length<=c.length)d=y._cache.length,h=u.concat([h,S(y,c.slice(0,d),m)]),c=c.slice(d);else{h=u.concat([h,S(y,c,m)]);break}return h}},{"buffer-xor":67,"safe-buffer":250}],30:[function(t,E,e){var u=t("safe-buffer").Buffer;function g(y,c,m){for(var h,d=-1,b=8,a=0,n,i;++d<b;)h=y._cipher.encryptBlock(y._prev),n=c&1<<7-d?128:0,i=h[0]^n,a+=(i&128)>>d%8,y._prev=S(y._prev,m?n:i);return a}function S(y,c){var m=y.length,h=-1,d=u.allocUnsafe(y.length);for(y=u.concat([y,u.from([c])]);++h<m;)d[h]=y[h]<<1|y[h+1]>>7;return d}e.encrypt=function(y,c,m){for(var h=c.length,d=u.allocUnsafe(h),b=-1;++b<h;)d[b]=g(y,c[b],m);return d}},{"safe-buffer":250}],31:[function(t,E,e){var u=t("safe-buffer").Buffer;function g(S,y,c){var m=S._cipher.encryptBlock(S._prev),h=m[0]^y;return S._prev=u.concat([S._prev.slice(1),u.from([c?y:h])]),h}e.encrypt=function(S,y,c){for(var m=y.length,h=u.allocUnsafe(m),d=-1;++d<m;)h[d]=g(S,y[d],c);return h}},{"safe-buffer":250}],32:[function(t,E,e){var u=t("buffer-xor"),g=t("safe-buffer").Buffer,S=t("../incr32");function y(m){var h=m._cipher.encryptBlockRaw(m._prev);return S(m._prev),h}var c=16;e.encrypt=function(m,h){var d=Math.ceil(h.length/c),b=m._cache.length;m._cache=g.concat([m._cache,g.allocUnsafe(d*c)]);for(var a=0;a<d;a++){var n=y(m),i=b+a*c;m._cache.writeUInt32BE(n[0],i+0),m._cache.writeUInt32BE(n[1],i+4),m._cache.writeUInt32BE(n[2],i+8),m._cache.writeUInt32BE(n[3],i+12)}var r=m._cache.slice(0,h.length);return m._cache=m._cache.slice(h.length),u(h,r)}},{"../incr32":27,"buffer-xor":67,"safe-buffer":250}],33:[function(t,E,e){e.encrypt=function(u,g){return u._cipher.encryptBlock(g)},e.decrypt=function(u,g){return u._cipher.decryptBlock(g)}},{}],34:[function(t,E,e){var u={ECB:t("./ecb"),CBC:t("./cbc"),CFB:t("./cfb"),CFB8:t("./cfb8"),CFB1:t("./cfb1"),OFB:t("./ofb"),CTR:t("./ctr"),GCM:t("./ctr")},g=t("./list.json");for(var S in g)g[S].module=u[g[S].mode];E.exports=g},{"./cbc":28,"./cfb":29,"./cfb1":30,"./cfb8":31,"./ctr":32,"./ecb":33,"./list.json":35,"./ofb":36}],35:[function(t,E,e){E.exports={"aes-128-ecb":{cipher:"AES",key:128,iv:0,mode:"ECB",type:"block"},"aes-192-ecb":{cipher:"AES",key:192,iv:0,mode:"ECB",type:"block"},"aes-256-ecb":{cipher:"AES",key:256,iv:0,mode:"ECB",type:"block"},"aes-128-cbc":{cipher:"AES",key:128,iv:16,mode:"CBC",type:"block"},"aes-192-cbc":{cipher:"AES",key:192,iv:16,mode:"CBC",type:"block"},"aes-256-cbc":{cipher:"AES",key:256,iv:16,mode:"CBC",type:"block"},aes128:{cipher:"AES",key:128,iv:16,mode:"CBC",type:"block"},aes192:{cipher:"AES",key:192,iv:16,mode:"CBC",type:"block"},aes256:{cipher:"AES",key:256,iv:16,mode:"CBC",type:"block"},"aes-128-cfb":{cipher:"AES",key:128,iv:16,mode:"CFB",type:"stream"},"aes-192-cfb":{cipher:"AES",key:192,iv:16,mode:"CFB",type:"stream"},"aes-256-cfb":{cipher:"AES",key:256,iv:16,mode:"CFB",type:"stream"},"aes-128-cfb8":{cipher:"AES",key:128,iv:16,mode:"CFB8",type:"stream"},"aes-192-cfb8":{cipher:"AES",key:192,iv:16,mode:"CFB8",type:"stream"},"aes-256-cfb8":{cipher:"AES",key:256,iv:16,mode:"CFB8",type:"stream"},"aes-128-cfb1":{cipher:"AES",key:128,iv:16,mode:"CFB1",type:"stream"},"aes-192-cfb1":{cipher:"AES",key:192,iv:16,mode:"CFB1",type:"stream"},"aes-256-cfb1":{cipher:"AES",key:256,iv:16,mode:"CFB1",type:"stream"},"aes-128-ofb":{cipher:"AES",key:128,iv:16,mode:"OFB",type:"stream"},"aes-192-ofb":{cipher:"AES",key:192,iv:16,mode:"OFB",type:"stream"},"aes-256-ofb":{cipher:"AES",key:256,iv:16,mode:"OFB",type:"stream"},"aes-128-ctr":{cipher:"AES",key:128,iv:16,mode:"CTR",type:"stream"},"aes-192-ctr":{cipher:"AES",key:192,iv:16,mode:"CTR",type:"stream"},"aes-256-ctr":{cipher:"AES",key:256,iv:16,mode:"CTR",type:"stream"},"aes-128-gcm":{cipher:"AES",key:128,iv:12,mode:"GCM",type:"auth"},"aes-192-gcm":{cipher:"AES",key:192,iv:12,mode:"GCM",type:"auth"},"aes-256-gcm":{cipher:"AES",key:256,iv:12,mode:"GCM",type:"auth"}}},{}],36:[function(t,E,e){(function(u){(function(){var g=t("buffer-xor");function S(y){return y._prev=y._cipher.encryptBlock(y._prev),y._prev}e.encrypt=function(y,c){for(;y._cache.length<c.length;)y._cache=u.concat([y._cache,S(y)]);var m=y._cache.slice(0,c.length);return y._cache=y._cache.slice(c.length),g(c,m)}}).call(this)}).call(this,t("buffer").Buffer)},{buffer:68,"buffer-xor":67}],37:[function(t,E,e){var u=t("./aes"),g=t("safe-buffer").Buffer,S=t("cipher-base"),y=t("inherits");function c(m,h,d,b){S.call(this),this._cipher=new u.AES(h),this._prev=g.from(d),this._cache=g.allocUnsafe(0),this._secCache=g.allocUnsafe(0),this._decrypt=b,this._mode=m}y(c,S),c.prototype._update=function(m){return this._mode.encrypt(this,m,this._decrypt)},c.prototype._final=function(){this._cipher.scrub()},E.exports=c},{"./aes":21,"cipher-base":71,inherits:146,"safe-buffer":250}],38:[function(t,E,e){var u=t("browserify-des"),g=t("browserify-aes/browser"),S=t("browserify-aes/modes"),y=t("browserify-des/modes"),c=t("evp_bytestokey");function m(n,i){n=n.toLowerCase();var r,s;if(S[n])r=S[n].key,s=S[n].iv;else if(y[n])r=y[n].key*8,s=y[n].iv;else throw new TypeError("invalid suite type");var o=c(i,!1,r,s);return d(n,o.key,o.iv)}function h(n,i){n=n.toLowerCase();var r,s;if(S[n])r=S[n].key,s=S[n].iv;else if(y[n])r=y[n].key*8,s=y[n].iv;else throw new TypeError("invalid suite type");var o=c(i,!1,r,s);return b(n,o.key,o.iv)}function d(n,i,r){if(n=n.toLowerCase(),S[n])return g.createCipheriv(n,i,r);if(y[n])return new u({key:i,iv:r,mode:n});throw new TypeError("invalid suite type")}function b(n,i,r){if(n=n.toLowerCase(),S[n])return g.createDecipheriv(n,i,r);if(y[n])return new u({key:i,iv:r,mode:n,decrypt:!0});throw new TypeError("invalid suite type")}function a(){return Object.keys(y).concat(g.getCiphers())}e.createCipher=e.Cipher=m,e.createCipheriv=e.Cipheriv=d,e.createDecipher=e.Decipher=h,e.createDecipheriv=e.Decipheriv=b,e.listCiphers=e.getCiphers=a},{"browserify-aes/browser":23,"browserify-aes/modes":34,"browserify-des":39,"browserify-des/modes":40,evp_bytestokey:106}],39:[function(t,E,e){var u=t("cipher-base"),g=t("des.js"),S=t("inherits"),y=t("safe-buffer").Buffer,c={"des-ede3-cbc":g.CBC.instantiate(g.EDE),"des-ede3":g.EDE,"des-ede-cbc":g.CBC.instantiate(g.EDE),"des-ede":g.EDE,"des-cbc":g.CBC.instantiate(g.DES),"des-ecb":g.DES};c.des=c["des-cbc"],c.des3=c["des-ede3-cbc"],E.exports=m,S(m,u);function m(h){u.call(this);var d=h.mode.toLowerCase(),b=c[d],a;h.decrypt?a="decrypt":a="encrypt";var n=h.key;y.isBuffer(n)||(n=y.from(n)),(d==="des-ede"||d==="des-ede-cbc")&&(n=y.concat([n,n.slice(0,8)]));var i=h.iv;y.isBuffer(i)||(i=y.from(i)),this._des=b.create({key:n,iv:i,type:a})}m.prototype._update=function(h){return y.from(this._des.update(h))},m.prototype._final=function(){return y.from(this._des.final())}},{"cipher-base":71,"des.js":79,inherits:146,"safe-buffer":250}],40:[function(t,E,e){e["des-ecb"]={key:8,iv:0},e["des-cbc"]=e.des={key:8,iv:8},e["des-ede3-cbc"]=e.des3={key:24,iv:8},e["des-ede3"]={key:24,iv:0},e["des-ede-cbc"]={key:16,iv:8},e["des-ede"]={key:16,iv:0}},{}],41:[function(t,E,e){(function(u){(function(){var g=t("bn.js"),S=t("randombytes");function y(h){var d=c(h),b=d.toRed(g.mont(h.modulus)).redPow(new g(h.publicExponent)).fromRed();return{blinder:b,unblinder:d.invm(h.modulus)}}function c(h){var d=h.modulus.byteLength(),b;do b=new g(S(d));while(b.cmp(h.modulus)>=0||!b.umod(h.prime1)||!b.umod(h.prime2));return b}function m(h,d){var b=y(d),a=d.modulus.byteLength(),n=new g(h).mul(b.blinder).umod(d.modulus),i=n.toRed(g.mont(d.prime1)),r=n.toRed(g.mont(d.prime2)),s=d.coefficient,o=d.prime1,l=d.prime2,v=i.redPow(d.exponent1).fromRed(),f=r.redPow(d.exponent2).fromRed(),p=v.isub(f).imul(s).umod(o).imul(l);return f.iadd(p).imul(b.unblinder).umod(d.modulus).toArrayLike(u,"be",a)}m.getr=c,E.exports=m}).call(this)}).call(this,t("buffer").Buffer)},{"bn.js":42,buffer:68,randombytes:244}],42:[function(t,E,e){(function(u,g){function S(O,I){if(!O)throw new Error(I||"Assertion failed")}function y(O,I){O.super_=I;var D=function(){};D.prototype=I.prototype,O.prototype=new D,O.prototype.constructor=O}function c(O,I,D){if(c.isBN(O))return O;this.negative=0,this.words=null,this.length=0,this.red=null,O!==null&&((I==="le"||I==="be")&&(D=I,I=10),this._init(O||0,I||10,D||"be"))}typeof u=="object"?u.exports=c:g.BN=c,c.BN=c,c.wordSize=26;var m;try{typeof window<"u"&&typeof window.Buffer<"u"?m=window.Buffer:m=t("buffer").Buffer}catch{}c.isBN=function(I){return I instanceof c?!0:I!==null&&typeof I=="object"&&I.constructor.wordSize===c.wordSize&&Array.isArray(I.words)},c.max=function(I,D){return I.cmp(D)>0?I:D},c.min=function(I,D){return I.cmp(D)<0?I:D},c.prototype._init=function(I,D,j){if(typeof I=="number")return this._initNumber(I,D,j);if(typeof I=="object")return this._initArray(I,D,j);D==="hex"&&(D=16),S(D===(D|0)&&D>=2&&D<=36),I=I.toString().replace(/\s+/g,"");var Y=0;I[0]==="-"&&(Y++,this.negative=1),Y<I.length&&(D===16?this._parseHex(I,Y,j):(this._parseBase(I,D,Y),j==="le"&&this._initArray(this.toArray(),D,j)))},c.prototype._initNumber=function(I,D,j){I<0&&(this.negative=1,I=-I),I<67108864?(this.words=[I&67108863],this.length=1):I<4503599627370496?(this.words=[I&67108863,I/67108864&67108863],this.length=2):(S(I<9007199254740992),this.words=[I&67108863,I/67108864&67108863,1],this.length=3),j==="le"&&this._initArray(this.toArray(),D,j)},c.prototype._initArray=function(I,D,j){if(S(typeof I.length=="number"),I.length<=0)return this.words=[0],this.length=1,this;this.length=Math.ceil(I.length/3),this.words=new Array(this.length);for(var Y=0;Y<this.length;Y++)this.words[Y]=0;var q,B,R=0;if(j==="be")for(Y=I.length-1,q=0;Y>=0;Y-=3)B=I[Y]|I[Y-1]<<8|I[Y-2]<<16,this.words[q]|=B<<R&67108863,this.words[q+1]=B>>>26-R&67108863,R+=24,R>=26&&(R-=26,q++);else if(j==="le")for(Y=0,q=0;Y<I.length;Y+=3)B=I[Y]|I[Y+1]<<8|I[Y+2]<<16,this.words[q]|=B<<R&67108863,this.words[q+1]=B>>>26-R&67108863,R+=24,R>=26&&(R-=26,q++);return this._strip()};function h(O,I){var D=O.charCodeAt(I);if(D>=48&&D<=57)return D-48;if(D>=65&&D<=70)return D-55;if(D>=97&&D<=102)return D-87;S(!1,"Invalid character in "+O)}function d(O,I,D){var j=h(O,D);return D-1>=I&&(j|=h(O,D-1)<<4),j}c.prototype._parseHex=function(I,D,j){this.length=Math.ceil((I.length-D)/6),this.words=new Array(this.length);for(var Y=0;Y<this.length;Y++)this.words[Y]=0;var q=0,B=0,R;if(j==="be")for(Y=I.length-1;Y>=D;Y-=2)R=d(I,D,Y)<<q,this.words[B]|=R&67108863,q>=18?(q-=18,B+=1,this.words[B]|=R>>>26):q+=8;else{var k=I.length-D;for(Y=k%2===0?D+1:D;Y<I.length;Y+=2)R=d(I,D,Y)<<q,this.words[B]|=R&67108863,q>=18?(q-=18,B+=1,this.words[B]|=R>>>26):q+=8}this._strip()};function b(O,I,D,j){for(var Y=0,q=0,B=Math.min(O.length,D),R=I;R<B;R++){var k=O.charCodeAt(R)-48;Y*=j,k>=49?q=k-49+10:k>=17?q=k-17+10:q=k,S(k>=0&&q<j,"Invalid character"),Y+=q}return Y}c.prototype._parseBase=function(I,D,j){this.words=[0],this.length=1;for(var Y=0,q=1;q<=67108863;q*=D)Y++;Y--,q=q/D|0;for(var B=I.length-j,R=B%Y,k=Math.min(B,B-R)+j,P=0,V=j;V<k;V+=Y)P=b(I,V,V+Y,D),this.imuln(q),this.words[0]+P<67108864?this.words[0]+=P:this._iaddn(P);if(R!==0){var x=1;for(P=b(I,V,I.length,D),V=0;V<R;V++)x*=D;this.imuln(x),this.words[0]+P<67108864?this.words[0]+=P:this._iaddn(P)}this._strip()},c.prototype.copy=function(I){I.words=new Array(this.length);for(var D=0;D<this.length;D++)I.words[D]=this.words[D];I.length=this.length,I.negative=this.negative,I.red=this.red};function a(O,I){O.words=I.words,O.length=I.length,O.negative=I.negative,O.red=I.red}if(c.prototype._move=function(I){a(I,this)},c.prototype.clone=function(){var I=new c(null);return this.copy(I),I},c.prototype._expand=function(I){for(;this.length<I;)this.words[this.length++]=0;return this},c.prototype._strip=function(){for(;this.length>1&&this.words[this.length-1]===0;)this.length--;return this._normSign()},c.prototype._normSign=function(){return this.length===1&&this.words[0]===0&&(this.negative=0),this},typeof Symbol<"u"&&typeof Symbol.for=="function")try{c.prototype[Symbol.for("nodejs.util.inspect.custom")]=n}catch{c.prototype.inspect=n}else c.prototype.inspect=n;function n(){return(this.red?"<BN-R: ":"<BN: ")+this.toString(16)+">"}var i=["","0","00","000","0000","00000","000000","0000000","00000000","000000000","0000000000","00000000000","000000000000","0000000000000","00000000000000","000000000000000","0000000000000000","00000000000000000","000000000000000000","0000000000000000000","00000000000000000000","000000000000000000000","0000000000000000000000","00000000000000000000000","000000000000000000000000","0000000000000000000000000"],r=[0,0,25,16,12,11,10,9,8,8,7,7,7,7,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],s=[0,0,33554432,43046721,16777216,48828125,60466176,40353607,16777216,43046721,1e7,19487171,35831808,62748517,7529536,11390625,16777216,24137569,34012224,47045881,64e6,4084101,5153632,6436343,7962624,9765625,11881376,14348907,17210368,20511149,243e5,28629151,33554432,39135393,45435424,52521875,60466176];c.prototype.toString=function(I,D){I=I||10,D=D|0||1;var j;if(I===16||I==="hex"){j="";for(var Y=0,q=0,B=0;B<this.length;B++){var R=this.words[B],k=((R<<Y|q)&16777215).toString(16);q=R>>>24-Y&16777215,Y+=2,Y>=26&&(Y-=26,B--),q!==0||B!==this.length-1?j=i[6-k.length]+k+j:j=k+j}for(q!==0&&(j=q.toString(16)+j);j.length%D!==0;)j="0"+j;return this.negative!==0&&(j="-"+j),j}if(I===(I|0)&&I>=2&&I<=36){var P=r[I],V=s[I];j="";var x=this.clone();for(x.negative=0;!x.isZero();){var Q=x.modrn(V).toString(I);x=x.idivn(V),x.isZero()?j=Q+j:j=i[P-Q.length]+Q+j}for(this.isZero()&&(j="0"+j);j.length%D!==0;)j="0"+j;return this.negative!==0&&(j="-"+j),j}S(!1,"Base should be between 2 and 36")},c.prototype.toNumber=function(){var I=this.words[0];return this.length===2?I+=this.words[1]*67108864:this.length===3&&this.words[2]===1?I+=4503599627370496+this.words[1]*67108864:this.length>2&&S(!1,"Number can only safely store up to 53 bits"),this.negative!==0?-I:I},c.prototype.toJSON=function(){return this.toString(16,2)},m&&(c.prototype.toBuffer=function(I,D){return this.toArrayLike(m,I,D)}),c.prototype.toArray=function(I,D){return this.toArrayLike(Array,I,D)};var o=function(I,D){return I.allocUnsafe?I.allocUnsafe(D):new I(D)};c.prototype.toArrayLike=function(I,D,j){this._strip();var Y=this.byteLength(),q=j||Math.max(1,Y);S(Y<=q,"byte array longer than desired length"),S(q>0,"Requested array length <= 0");var B=o(I,q),R=D==="le"?"LE":"BE";return this["_toArrayLike"+R](B,Y),B},c.prototype._toArrayLikeLE=function(I,D){for(var j=0,Y=0,q=0,B=0;q<this.length;q++){var R=this.words[q]<<B|Y;I[j++]=R&255,j<I.length&&(I[j++]=R>>8&255),j<I.length&&(I[j++]=R>>16&255),B===6?(j<I.length&&(I[j++]=R>>24&255),Y=0,B=0):(Y=R>>>24,B+=2)}if(j<I.length)for(I[j++]=Y;j<I.length;)I[j++]=0},c.prototype._toArrayLikeBE=function(I,D){for(var j=I.length-1,Y=0,q=0,B=0;q<this.length;q++){var R=this.words[q]<<B|Y;I[j--]=R&255,j>=0&&(I[j--]=R>>8&255),j>=0&&(I[j--]=R>>16&255),B===6?(j>=0&&(I[j--]=R>>24&255),Y=0,B=0):(Y=R>>>24,B+=2)}if(j>=0)for(I[j--]=Y;j>=0;)I[j--]=0},Math.clz32?c.prototype._countBits=function(I){return 32-Math.clz32(I)}:c.prototype._countBits=function(I){var D=I,j=0;return D>=4096&&(j+=13,D>>>=13),D>=64&&(j+=7,D>>>=7),D>=8&&(j+=4,D>>>=4),D>=2&&(j+=2,D>>>=2),j+D},c.prototype._zeroBits=function(I){if(I===0)return 26;var D=I,j=0;return D&8191||(j+=13,D>>>=13),D&127||(j+=7,D>>>=7),D&15||(j+=4,D>>>=4),D&3||(j+=2,D>>>=2),D&1||j++,j},c.prototype.bitLength=function(){var I=this.words[this.length-1],D=this._countBits(I);return(this.length-1)*26+D};function l(O){for(var I=new Array(O.bitLength()),D=0;D<I.length;D++){var j=D/26|0,Y=D%26;I[D]=O.words[j]>>>Y&1}return I}c.prototype.zeroBits=function(){if(this.isZero())return 0;for(var I=0,D=0;D<this.length;D++){var j=this._zeroBits(this.words[D]);if(I+=j,j!==26)break}return I},c.prototype.byteLength=function(){return Math.ceil(this.bitLength()/8)},c.prototype.toTwos=function(I){return this.negative!==0?this.abs().inotn(I).iaddn(1):this.clone()},c.prototype.fromTwos=function(I){return this.testn(I-1)?this.notn(I).iaddn(1).ineg():this.clone()},c.prototype.isNeg=function(){return this.negative!==0},c.prototype.neg=function(){return this.clone().ineg()},c.prototype.ineg=function(){return this.isZero()||(this.negative^=1),this},c.prototype.iuor=function(I){for(;this.length<I.length;)this.words[this.length++]=0;for(var D=0;D<I.length;D++)this.words[D]=this.words[D]|I.words[D];return this._strip()},c.prototype.ior=function(I){return S((this.negative|I.negative)===0),this.iuor(I)},c.prototype.or=function(I){return this.length>I.length?this.clone().ior(I):I.clone().ior(this)},c.prototype.uor=function(I){return this.length>I.length?this.clone().iuor(I):I.clone().iuor(this)},c.prototype.iuand=function(I){var D;this.length>I.length?D=I:D=this;for(var j=0;j<D.length;j++)this.words[j]=this.words[j]&I.words[j];return this.length=D.length,this._strip()},c.prototype.iand=function(I){return S((this.negative|I.negative)===0),this.iuand(I)},c.prototype.and=function(I){return this.length>I.length?this.clone().iand(I):I.clone().iand(this)},c.prototype.uand=function(I){return this.length>I.length?this.clone().iuand(I):I.clone().iuand(this)},c.prototype.iuxor=function(I){var D,j;this.length>I.length?(D=this,j=I):(D=I,j=this);for(var Y=0;Y<j.length;Y++)this.words[Y]=D.words[Y]^j.words[Y];if(this!==D)for(;Y<D.length;Y++)this.words[Y]=D.words[Y];return this.length=D.length,this._strip()},c.prototype.ixor=function(I){return S((this.negative|I.negative)===0),this.iuxor(I)},c.prototype.xor=function(I){return this.length>I.length?this.clone().ixor(I):I.clone().ixor(this)},c.prototype.uxor=function(I){return this.length>I.length?this.clone().iuxor(I):I.clone().iuxor(this)},c.prototype.inotn=function(I){S(typeof I=="number"&&I>=0);var D=Math.ceil(I/26)|0,j=I%26;this._expand(D),j>0&&D--;for(var Y=0;Y<D;Y++)this.words[Y]=~this.words[Y]&67108863;return j>0&&(this.words[Y]=~this.words[Y]&67108863>>26-j),this._strip()},c.prototype.notn=function(I){return this.clone().inotn(I)},c.prototype.setn=function(I,D){S(typeof I=="number"&&I>=0);var j=I/26|0,Y=I%26;return this._expand(j+1),D?this.words[j]=this.words[j]|1<<Y:this.words[j]=this.words[j]&~(1<<Y),this._strip()},c.prototype.iadd=function(I){var D;if(this.negative!==0&&I.negative===0)return this.negative=0,D=this.isub(I),this.negative^=1,this._normSign();if(this.negative===0&&I.negative!==0)return I.negative=0,D=this.isub(I),I.negative=1,D._normSign();var j,Y;this.length>I.length?(j=this,Y=I):(j=I,Y=this);for(var q=0,B=0;B<Y.length;B++)D=(j.words[B]|0)+(Y.words[B]|0)+q,this.words[B]=D&67108863,q=D>>>26;for(;q!==0&&B<j.length;B++)D=(j.words[B]|0)+q,this.words[B]=D&67108863,q=D>>>26;if(this.length=j.length,q!==0)this.words[this.length]=q,this.length++;else if(j!==this)for(;B<j.length;B++)this.words[B]=j.words[B];return this},c.prototype.add=function(I){var D;return I.negative!==0&&this.negative===0?(I.negative=0,D=this.sub(I),I.negative^=1,D):I.negative===0&&this.negative!==0?(this.negative=0,D=I.sub(this),this.negative=1,D):this.length>I.length?this.clone().iadd(I):I.clone().iadd(this)},c.prototype.isub=function(I){if(I.negative!==0){I.negative=0;var D=this.iadd(I);return I.negative=1,D._normSign()}else if(this.negative!==0)return this.negative=0,this.iadd(I),this.negative=1,this._normSign();var j=this.cmp(I);if(j===0)return this.negative=0,this.length=1,this.words[0]=0,this;var Y,q;j>0?(Y=this,q=I):(Y=I,q=this);for(var B=0,R=0;R<q.length;R++)D=(Y.words[R]|0)-(q.words[R]|0)+B,B=D>>26,this.words[R]=D&67108863;for(;B!==0&&R<Y.length;R++)D=(Y.words[R]|0)+B,B=D>>26,this.words[R]=D&67108863;if(B===0&&R<Y.length&&Y!==this)for(;R<Y.length;R++)this.words[R]=Y.words[R];return this.length=Math.max(this.length,R),Y!==this&&(this.negative=1),this._strip()},c.prototype.sub=function(I){return this.clone().isub(I)};function v(O,I,D){D.negative=I.negative^O.negative;var j=O.length+I.length|0;D.length=j,j=j-1|0;var Y=O.words[0]|0,q=I.words[0]|0,B=Y*q,R=B&67108863,k=B/67108864|0;D.words[0]=R;for(var P=1;P<j;P++){for(var V=k>>>26,x=k&67108863,Q=Math.min(P,I.length-1),te=Math.max(0,P-O.length+1);te<=Q;te++){var ae=P-te|0;Y=O.words[ae]|0,q=I.words[te]|0,B=Y*q+x,V+=B/67108864|0,x=B&67108863}D.words[P]=x|0,k=V|0}return k!==0?D.words[P]=k|0:D.length--,D._strip()}var f=function(I,D,j){var Y=I.words,q=D.words,B=j.words,R=0,k,P,V,x=Y[0]|0,Q=x&8191,te=x>>>13,ae=Y[1]|0,de=ae&8191,X=ae>>>13,$=Y[2]|0,K=$&8191,re=$>>>13,ue=Y[3]|0,H=ue&8191,G=ue>>>13,U=Y[4]|0,L=U&8191,z=U>>>13,J=Y[5]|0,ne=J&8191,oe=J>>>13,ce=Y[6]|0,pe=ce&8191,he=ce>>>13,fe=Y[7]|0,ve=fe&8191,ye=fe>>>13,Ee=Y[8]|0,we=Ee&8191,me=Ee>>>13,N=Y[9]|0,Z=N&8191,ie=N>>>13,se=q[0]|0,le=se&8191,ge=se>>>13,be=q[1]|0,Se=be&8191,_e=be>>>13,Re=q[2]|0,Ie=Re&8191,Ce=Re>>>13,Me=q[3]|0,Ae=Me&8191,ke=Me>>>13,xe=q[4]|0,Pe=xe&8191,De=xe>>>13,je=q[5]|0,Be=je&8191,Oe=je>>>13,Ue=q[6]|0,Ve=Ue&8191,Ne=Ue>>>13,Je=q[7]|0,tt=Je&8191,Ke=Je>>>13,nt=q[8]|0,it=nt&8191,He=nt>>>13,rt=q[9]|0,Ze=rt&8191,et=rt>>>13;j.negative=I.negative^D.negative,j.length=19,k=Math.imul(Q,le),P=Math.imul(Q,ge),P=P+Math.imul(te,le)|0,V=Math.imul(te,ge);var Yt=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(Yt>>>26)|0,Yt&=67108863,k=Math.imul(de,le),P=Math.imul(de,ge),P=P+Math.imul(X,le)|0,V=Math.imul(X,ge),k=k+Math.imul(Q,Se)|0,P=P+Math.imul(Q,_e)|0,P=P+Math.imul(te,Se)|0,V=V+Math.imul(te,_e)|0;var Jt=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(Jt>>>26)|0,Jt&=67108863,k=Math.imul(K,le),P=Math.imul(K,ge),P=P+Math.imul(re,le)|0,V=Math.imul(re,ge),k=k+Math.imul(de,Se)|0,P=P+Math.imul(de,_e)|0,P=P+Math.imul(X,Se)|0,V=V+Math.imul(X,_e)|0,k=k+Math.imul(Q,Ie)|0,P=P+Math.imul(Q,Ce)|0,P=P+Math.imul(te,Ie)|0,V=V+Math.imul(te,Ce)|0;var Qt=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(Qt>>>26)|0,Qt&=67108863,k=Math.imul(H,le),P=Math.imul(H,ge),P=P+Math.imul(G,le)|0,V=Math.imul(G,ge),k=k+Math.imul(K,Se)|0,P=P+Math.imul(K,_e)|0,P=P+Math.imul(re,Se)|0,V=V+Math.imul(re,_e)|0,k=k+Math.imul(de,Ie)|0,P=P+Math.imul(de,Ce)|0,P=P+Math.imul(X,Ie)|0,V=V+Math.imul(X,Ce)|0,k=k+Math.imul(Q,Ae)|0,P=P+Math.imul(Q,ke)|0,P=P+Math.imul(te,Ae)|0,V=V+Math.imul(te,ke)|0;var Xt=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(Xt>>>26)|0,Xt&=67108863,k=Math.imul(L,le),P=Math.imul(L,ge),P=P+Math.imul(z,le)|0,V=Math.imul(z,ge),k=k+Math.imul(H,Se)|0,P=P+Math.imul(H,_e)|0,P=P+Math.imul(G,Se)|0,V=V+Math.imul(G,_e)|0,k=k+Math.imul(K,Ie)|0,P=P+Math.imul(K,Ce)|0,P=P+Math.imul(re,Ie)|0,V=V+Math.imul(re,Ce)|0,k=k+Math.imul(de,Ae)|0,P=P+Math.imul(de,ke)|0,P=P+Math.imul(X,Ae)|0,V=V+Math.imul(X,ke)|0,k=k+Math.imul(Q,Pe)|0,P=P+Math.imul(Q,De)|0,P=P+Math.imul(te,Pe)|0,V=V+Math.imul(te,De)|0;var Zt=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(Zt>>>26)|0,Zt&=67108863,k=Math.imul(ne,le),P=Math.imul(ne,ge),P=P+Math.imul(oe,le)|0,V=Math.imul(oe,ge),k=k+Math.imul(L,Se)|0,P=P+Math.imul(L,_e)|0,P=P+Math.imul(z,Se)|0,V=V+Math.imul(z,_e)|0,k=k+Math.imul(H,Ie)|0,P=P+Math.imul(H,Ce)|0,P=P+Math.imul(G,Ie)|0,V=V+Math.imul(G,Ce)|0,k=k+Math.imul(K,Ae)|0,P=P+Math.imul(K,ke)|0,P=P+Math.imul(re,Ae)|0,V=V+Math.imul(re,ke)|0,k=k+Math.imul(de,Pe)|0,P=P+Math.imul(de,De)|0,P=P+Math.imul(X,Pe)|0,V=V+Math.imul(X,De)|0,k=k+Math.imul(Q,Be)|0,P=P+Math.imul(Q,Oe)|0,P=P+Math.imul(te,Be)|0,V=V+Math.imul(te,Oe)|0;var en=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(en>>>26)|0,en&=67108863,k=Math.imul(pe,le),P=Math.imul(pe,ge),P=P+Math.imul(he,le)|0,V=Math.imul(he,ge),k=k+Math.imul(ne,Se)|0,P=P+Math.imul(ne,_e)|0,P=P+Math.imul(oe,Se)|0,V=V+Math.imul(oe,_e)|0,k=k+Math.imul(L,Ie)|0,P=P+Math.imul(L,Ce)|0,P=P+Math.imul(z,Ie)|0,V=V+Math.imul(z,Ce)|0,k=k+Math.imul(H,Ae)|0,P=P+Math.imul(H,ke)|0,P=P+Math.imul(G,Ae)|0,V=V+Math.imul(G,ke)|0,k=k+Math.imul(K,Pe)|0,P=P+Math.imul(K,De)|0,P=P+Math.imul(re,Pe)|0,V=V+Math.imul(re,De)|0,k=k+Math.imul(de,Be)|0,P=P+Math.imul(de,Oe)|0,P=P+Math.imul(X,Be)|0,V=V+Math.imul(X,Oe)|0,k=k+Math.imul(Q,Ve)|0,P=P+Math.imul(Q,Ne)|0,P=P+Math.imul(te,Ve)|0,V=V+Math.imul(te,Ne)|0;var tn=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(tn>>>26)|0,tn&=67108863,k=Math.imul(ve,le),P=Math.imul(ve,ge),P=P+Math.imul(ye,le)|0,V=Math.imul(ye,ge),k=k+Math.imul(pe,Se)|0,P=P+Math.imul(pe,_e)|0,P=P+Math.imul(he,Se)|0,V=V+Math.imul(he,_e)|0,k=k+Math.imul(ne,Ie)|0,P=P+Math.imul(ne,Ce)|0,P=P+Math.imul(oe,Ie)|0,V=V+Math.imul(oe,Ce)|0,k=k+Math.imul(L,Ae)|0,P=P+Math.imul(L,ke)|0,P=P+Math.imul(z,Ae)|0,V=V+Math.imul(z,ke)|0,k=k+Math.imul(H,Pe)|0,P=P+Math.imul(H,De)|0,P=P+Math.imul(G,Pe)|0,V=V+Math.imul(G,De)|0,k=k+Math.imul(K,Be)|0,P=P+Math.imul(K,Oe)|0,P=P+Math.imul(re,Be)|0,V=V+Math.imul(re,Oe)|0,k=k+Math.imul(de,Ve)|0,P=P+Math.imul(de,Ne)|0,P=P+Math.imul(X,Ve)|0,V=V+Math.imul(X,Ne)|0,k=k+Math.imul(Q,tt)|0,P=P+Math.imul(Q,Ke)|0,P=P+Math.imul(te,tt)|0,V=V+Math.imul(te,Ke)|0;var nn=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(nn>>>26)|0,nn&=67108863,k=Math.imul(we,le),P=Math.imul(we,ge),P=P+Math.imul(me,le)|0,V=Math.imul(me,ge),k=k+Math.imul(ve,Se)|0,P=P+Math.imul(ve,_e)|0,P=P+Math.imul(ye,Se)|0,V=V+Math.imul(ye,_e)|0,k=k+Math.imul(pe,Ie)|0,P=P+Math.imul(pe,Ce)|0,P=P+Math.imul(he,Ie)|0,V=V+Math.imul(he,Ce)|0,k=k+Math.imul(ne,Ae)|0,P=P+Math.imul(ne,ke)|0,P=P+Math.imul(oe,Ae)|0,V=V+Math.imul(oe,ke)|0,k=k+Math.imul(L,Pe)|0,P=P+Math.imul(L,De)|0,P=P+Math.imul(z,Pe)|0,V=V+Math.imul(z,De)|0,k=k+Math.imul(H,Be)|0,P=P+Math.imul(H,Oe)|0,P=P+Math.imul(G,Be)|0,V=V+Math.imul(G,Oe)|0,k=k+Math.imul(K,Ve)|0,P=P+Math.imul(K,Ne)|0,P=P+Math.imul(re,Ve)|0,V=V+Math.imul(re,Ne)|0,k=k+Math.imul(de,tt)|0,P=P+Math.imul(de,Ke)|0,P=P+Math.imul(X,tt)|0,V=V+Math.imul(X,Ke)|0,k=k+Math.imul(Q,it)|0,P=P+Math.imul(Q,He)|0,P=P+Math.imul(te,it)|0,V=V+Math.imul(te,He)|0;var rn=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(rn>>>26)|0,rn&=67108863,k=Math.imul(Z,le),P=Math.imul(Z,ge),P=P+Math.imul(ie,le)|0,V=Math.imul(ie,ge),k=k+Math.imul(we,Se)|0,P=P+Math.imul(we,_e)|0,P=P+Math.imul(me,Se)|0,V=V+Math.imul(me,_e)|0,k=k+Math.imul(ve,Ie)|0,P=P+Math.imul(ve,Ce)|0,P=P+Math.imul(ye,Ie)|0,V=V+Math.imul(ye,Ce)|0,k=k+Math.imul(pe,Ae)|0,P=P+Math.imul(pe,ke)|0,P=P+Math.imul(he,Ae)|0,V=V+Math.imul(he,ke)|0,k=k+Math.imul(ne,Pe)|0,P=P+Math.imul(ne,De)|0,P=P+Math.imul(oe,Pe)|0,V=V+Math.imul(oe,De)|0,k=k+Math.imul(L,Be)|0,P=P+Math.imul(L,Oe)|0,P=P+Math.imul(z,Be)|0,V=V+Math.imul(z,Oe)|0,k=k+Math.imul(H,Ve)|0,P=P+Math.imul(H,Ne)|0,P=P+Math.imul(G,Ve)|0,V=V+Math.imul(G,Ne)|0,k=k+Math.imul(K,tt)|0,P=P+Math.imul(K,Ke)|0,P=P+Math.imul(re,tt)|0,V=V+Math.imul(re,Ke)|0,k=k+Math.imul(de,it)|0,P=P+Math.imul(de,He)|0,P=P+Math.imul(X,it)|0,V=V+Math.imul(X,He)|0,k=k+Math.imul(Q,Ze)|0,P=P+Math.imul(Q,et)|0,P=P+Math.imul(te,Ze)|0,V=V+Math.imul(te,et)|0;var sn=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(sn>>>26)|0,sn&=67108863,k=Math.imul(Z,Se),P=Math.imul(Z,_e),P=P+Math.imul(ie,Se)|0,V=Math.imul(ie,_e),k=k+Math.imul(we,Ie)|0,P=P+Math.imul(we,Ce)|0,P=P+Math.imul(me,Ie)|0,V=V+Math.imul(me,Ce)|0,k=k+Math.imul(ve,Ae)|0,P=P+Math.imul(ve,ke)|0,P=P+Math.imul(ye,Ae)|0,V=V+Math.imul(ye,ke)|0,k=k+Math.imul(pe,Pe)|0,P=P+Math.imul(pe,De)|0,P=P+Math.imul(he,Pe)|0,V=V+Math.imul(he,De)|0,k=k+Math.imul(ne,Be)|0,P=P+Math.imul(ne,Oe)|0,P=P+Math.imul(oe,Be)|0,V=V+Math.imul(oe,Oe)|0,k=k+Math.imul(L,Ve)|0,P=P+Math.imul(L,Ne)|0,P=P+Math.imul(z,Ve)|0,V=V+Math.imul(z,Ne)|0,k=k+Math.imul(H,tt)|0,P=P+Math.imul(H,Ke)|0,P=P+Math.imul(G,tt)|0,V=V+Math.imul(G,Ke)|0,k=k+Math.imul(K,it)|0,P=P+Math.imul(K,He)|0,P=P+Math.imul(re,it)|0,V=V+Math.imul(re,He)|0,k=k+Math.imul(de,Ze)|0,P=P+Math.imul(de,et)|0,P=P+Math.imul(X,Ze)|0,V=V+Math.imul(X,et)|0;var on=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(on>>>26)|0,on&=67108863,k=Math.imul(Z,Ie),P=Math.imul(Z,Ce),P=P+Math.imul(ie,Ie)|0,V=Math.imul(ie,Ce),k=k+Math.imul(we,Ae)|0,P=P+Math.imul(we,ke)|0,P=P+Math.imul(me,Ae)|0,V=V+Math.imul(me,ke)|0,k=k+Math.imul(ve,Pe)|0,P=P+Math.imul(ve,De)|0,P=P+Math.imul(ye,Pe)|0,V=V+Math.imul(ye,De)|0,k=k+Math.imul(pe,Be)|0,P=P+Math.imul(pe,Oe)|0,P=P+Math.imul(he,Be)|0,V=V+Math.imul(he,Oe)|0,k=k+Math.imul(ne,Ve)|0,P=P+Math.imul(ne,Ne)|0,P=P+Math.imul(oe,Ve)|0,V=V+Math.imul(oe,Ne)|0,k=k+Math.imul(L,tt)|0,P=P+Math.imul(L,Ke)|0,P=P+Math.imul(z,tt)|0,V=V+Math.imul(z,Ke)|0,k=k+Math.imul(H,it)|0,P=P+Math.imul(H,He)|0,P=P+Math.imul(G,it)|0,V=V+Math.imul(G,He)|0,k=k+Math.imul(K,Ze)|0,P=P+Math.imul(K,et)|0,P=P+Math.imul(re,Ze)|0,V=V+Math.imul(re,et)|0;var an=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(an>>>26)|0,an&=67108863,k=Math.imul(Z,Ae),P=Math.imul(Z,ke),P=P+Math.imul(ie,Ae)|0,V=Math.imul(ie,ke),k=k+Math.imul(we,Pe)|0,P=P+Math.imul(we,De)|0,P=P+Math.imul(me,Pe)|0,V=V+Math.imul(me,De)|0,k=k+Math.imul(ve,Be)|0,P=P+Math.imul(ve,Oe)|0,P=P+Math.imul(ye,Be)|0,V=V+Math.imul(ye,Oe)|0,k=k+Math.imul(pe,Ve)|0,P=P+Math.imul(pe,Ne)|0,P=P+Math.imul(he,Ve)|0,V=V+Math.imul(he,Ne)|0,k=k+Math.imul(ne,tt)|0,P=P+Math.imul(ne,Ke)|0,P=P+Math.imul(oe,tt)|0,V=V+Math.imul(oe,Ke)|0,k=k+Math.imul(L,it)|0,P=P+Math.imul(L,He)|0,P=P+Math.imul(z,it)|0,V=V+Math.imul(z,He)|0,k=k+Math.imul(H,Ze)|0,P=P+Math.imul(H,et)|0,P=P+Math.imul(G,Ze)|0,V=V+Math.imul(G,et)|0;var cn=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(cn>>>26)|0,cn&=67108863,k=Math.imul(Z,Pe),P=Math.imul(Z,De),P=P+Math.imul(ie,Pe)|0,V=Math.imul(ie,De),k=k+Math.imul(we,Be)|0,P=P+Math.imul(we,Oe)|0,P=P+Math.imul(me,Be)|0,V=V+Math.imul(me,Oe)|0,k=k+Math.imul(ve,Ve)|0,P=P+Math.imul(ve,Ne)|0,P=P+Math.imul(ye,Ve)|0,V=V+Math.imul(ye,Ne)|0,k=k+Math.imul(pe,tt)|0,P=P+Math.imul(pe,Ke)|0,P=P+Math.imul(he,tt)|0,V=V+Math.imul(he,Ke)|0,k=k+Math.imul(ne,it)|0,P=P+Math.imul(ne,He)|0,P=P+Math.imul(oe,it)|0,V=V+Math.imul(oe,He)|0,k=k+Math.imul(L,Ze)|0,P=P+Math.imul(L,et)|0,P=P+Math.imul(z,Ze)|0,V=V+Math.imul(z,et)|0;var ln=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(ln>>>26)|0,ln&=67108863,k=Math.imul(Z,Be),P=Math.imul(Z,Oe),P=P+Math.imul(ie,Be)|0,V=Math.imul(ie,Oe),k=k+Math.imul(we,Ve)|0,P=P+Math.imul(we,Ne)|0,P=P+Math.imul(me,Ve)|0,V=V+Math.imul(me,Ne)|0,k=k+Math.imul(ve,tt)|0,P=P+Math.imul(ve,Ke)|0,P=P+Math.imul(ye,tt)|0,V=V+Math.imul(ye,Ke)|0,k=k+Math.imul(pe,it)|0,P=P+Math.imul(pe,He)|0,P=P+Math.imul(he,it)|0,V=V+Math.imul(he,He)|0,k=k+Math.imul(ne,Ze)|0,P=P+Math.imul(ne,et)|0,P=P+Math.imul(oe,Ze)|0,V=V+Math.imul(oe,et)|0;var dn=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(dn>>>26)|0,dn&=67108863,k=Math.imul(Z,Ve),P=Math.imul(Z,Ne),P=P+Math.imul(ie,Ve)|0,V=Math.imul(ie,Ne),k=k+Math.imul(we,tt)|0,P=P+Math.imul(we,Ke)|0,P=P+Math.imul(me,tt)|0,V=V+Math.imul(me,Ke)|0,k=k+Math.imul(ve,it)|0,P=P+Math.imul(ve,He)|0,P=P+Math.imul(ye,it)|0,V=V+Math.imul(ye,He)|0,k=k+Math.imul(pe,Ze)|0,P=P+Math.imul(pe,et)|0,P=P+Math.imul(he,Ze)|0,V=V+Math.imul(he,et)|0;var un=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(un>>>26)|0,un&=67108863,k=Math.imul(Z,tt),P=Math.imul(Z,Ke),P=P+Math.imul(ie,tt)|0,V=Math.imul(ie,Ke),k=k+Math.imul(we,it)|0,P=P+Math.imul(we,He)|0,P=P+Math.imul(me,it)|0,V=V+Math.imul(me,He)|0,k=k+Math.imul(ve,Ze)|0,P=P+Math.imul(ve,et)|0,P=P+Math.imul(ye,Ze)|0,V=V+Math.imul(ye,et)|0;var fn=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(fn>>>26)|0,fn&=67108863,k=Math.imul(Z,it),P=Math.imul(Z,He),P=P+Math.imul(ie,it)|0,V=Math.imul(ie,He),k=k+Math.imul(we,Ze)|0,P=P+Math.imul(we,et)|0,P=P+Math.imul(me,Ze)|0,V=V+Math.imul(me,et)|0;var Ki=(R+k|0)+((P&8191)<<13)|0;R=(V+(P>>>13)|0)+(Ki>>>26)|0,Ki&=67108863,k=Math.imul(Z,Ze),P=Math.imul(Z,et),P=P+Math.imul(ie,Ze)|0,V=Math.imul(ie,et);var Hi=(R+k|0)+((P&8191)<<13)|0;return R=(V+(P>>>13)|0)+(Hi>>>26)|0,Hi&=67108863,B[0]=Yt,B[1]=Jt,B[2]=Qt,B[3]=Xt,B[4]=Zt,B[5]=en,B[6]=tn,B[7]=nn,B[8]=rn,B[9]=sn,B[10]=on,B[11]=an,B[12]=cn,B[13]=ln,B[14]=dn,B[15]=un,B[16]=fn,B[17]=Ki,B[18]=Hi,R!==0&&(B[19]=R,j.length++),j};Math.imul||(f=v);function p(O,I,D){D.negative=I.negative^O.negative,D.length=O.length+I.length;for(var j=0,Y=0,q=0;q<D.length-1;q++){var B=Y;Y=0;for(var R=j&67108863,k=Math.min(q,I.length-1),P=Math.max(0,q-O.length+1);P<=k;P++){var V=q-P,x=O.words[V]|0,Q=I.words[P]|0,te=x*Q,ae=te&67108863;B=B+(te/67108864|0)|0,ae=ae+R|0,R=ae&67108863,B=B+(ae>>>26)|0,Y+=B>>>26,B&=67108863}D.words[q]=R,j=B,B=Y}return j!==0?D.words[q]=j:D.length--,D._strip()}function _(O,I,D){return p(O,I,D)}c.prototype.mulTo=function(I,D){var j,Y=this.length+I.length;return this.length===10&&I.length===10?j=f(this,I,D):Y<63?j=v(this,I,D):Y<1024?j=p(this,I,D):j=_(this,I,D),j},c.prototype.mul=function(I){var D=new c(null);return D.words=new Array(this.length+I.length),this.mulTo(I,D)},c.prototype.mulf=function(I){var D=new c(null);return D.words=new Array(this.length+I.length),_(this,I,D)},c.prototype.imul=function(I){return this.clone().mulTo(I,this)},c.prototype.imuln=function(I){var D=I<0;D&&(I=-I),S(typeof I=="number"),S(I<67108864);for(var j=0,Y=0;Y<this.length;Y++){var q=(this.words[Y]|0)*I,B=(q&67108863)+(j&67108863);j>>=26,j+=q/67108864|0,j+=B>>>26,this.words[Y]=B&67108863}return j!==0&&(this.words[Y]=j,this.length++),D?this.ineg():this},c.prototype.muln=function(I){return this.clone().imuln(I)},c.prototype.sqr=function(){return this.mul(this)},c.prototype.isqr=function(){return this.imul(this.clone())},c.prototype.pow=function(I){var D=l(I);if(D.length===0)return new c(1);for(var j=this,Y=0;Y<D.length&&D[Y]===0;Y++,j=j.sqr());if(++Y<D.length)for(var q=j.sqr();Y<D.length;Y++,q=q.sqr())D[Y]!==0&&(j=j.mul(q));return j},c.prototype.iushln=function(I){S(typeof I=="number"&&I>=0);var D=I%26,j=(I-D)/26,Y=67108863>>>26-D<<26-D,q;if(D!==0){var B=0;for(q=0;q<this.length;q++){var R=this.words[q]&Y,k=(this.words[q]|0)-R<<D;this.words[q]=k|B,B=R>>>26-D}B&&(this.words[q]=B,this.length++)}if(j!==0){for(q=this.length-1;q>=0;q--)this.words[q+j]=this.words[q];for(q=0;q<j;q++)this.words[q]=0;this.length+=j}return this._strip()},c.prototype.ishln=function(I){return S(this.negative===0),this.iushln(I)},c.prototype.iushrn=function(I,D,j){S(typeof I=="number"&&I>=0);var Y;D?Y=(D-D%26)/26:Y=0;var q=I%26,B=Math.min((I-q)/26,this.length),R=67108863^67108863>>>q<<q,k=j;if(Y-=B,Y=Math.max(0,Y),k){for(var P=0;P<B;P++)k.words[P]=this.words[P];k.length=B}if(B!==0)if(this.length>B)for(this.length-=B,P=0;P<this.length;P++)this.words[P]=this.words[P+B];else this.words[0]=0,this.length=1;var V=0;for(P=this.length-1;P>=0&&(V!==0||P>=Y);P--){var x=this.words[P]|0;this.words[P]=V<<26-q|x>>>q,V=x&R}return k&&V!==0&&(k.words[k.length++]=V),this.length===0&&(this.words[0]=0,this.length=1),this._strip()},c.prototype.ishrn=function(I,D,j){return S(this.negative===0),this.iushrn(I,D,j)},c.prototype.shln=function(I){return this.clone().ishln(I)},c.prototype.ushln=function(I){return this.clone().iushln(I)},c.prototype.shrn=function(I){return this.clone().ishrn(I)},c.prototype.ushrn=function(I){return this.clone().iushrn(I)},c.prototype.testn=function(I){S(typeof I=="number"&&I>=0);var D=I%26,j=(I-D)/26,Y=1<<D;if(this.length<=j)return!1;var q=this.words[j];return!!(q&Y)},c.prototype.imaskn=function(I){S(typeof I=="number"&&I>=0);var D=I%26,j=(I-D)/26;if(S(this.negative===0,"imaskn works only with positive numbers"),this.length<=j)return this;if(D!==0&&j++,this.length=Math.min(j,this.length),D!==0){var Y=67108863^67108863>>>D<<D;this.words[this.length-1]&=Y}return this._strip()},c.prototype.maskn=function(I){return this.clone().imaskn(I)},c.prototype.iaddn=function(I){return S(typeof I=="number"),S(I<67108864),I<0?this.isubn(-I):this.negative!==0?this.length===1&&(this.words[0]|0)<=I?(this.words[0]=I-(this.words[0]|0),this.negative=0,this):(this.negative=0,this.isubn(I),this.negative=1,this):this._iaddn(I)},c.prototype._iaddn=function(I){this.words[0]+=I;for(var D=0;D<this.length&&this.words[D]>=67108864;D++)this.words[D]-=67108864,D===this.length-1?this.words[D+1]=1:this.words[D+1]++;return this.length=Math.max(this.length,D+1),this},c.prototype.isubn=function(I){if(S(typeof I=="number"),S(I<67108864),I<0)return this.iaddn(-I);if(this.negative!==0)return this.negative=0,this.iaddn(I),this.negative=1,this;if(this.words[0]-=I,this.length===1&&this.words[0]<0)this.words[0]=-this.words[0],this.negative=1;else for(var D=0;D<this.length&&this.words[D]<0;D++)this.words[D]+=67108864,this.words[D+1]-=1;return this._strip()},c.prototype.addn=function(I){return this.clone().iaddn(I)},c.prototype.subn=function(I){return this.clone().isubn(I)},c.prototype.iabs=function(){return this.negative=0,this},c.prototype.abs=function(){return this.clone().iabs()},c.prototype._ishlnsubmul=function(I,D,j){var Y=I.length+j,q;this._expand(Y);var B,R=0;for(q=0;q<I.length;q++){B=(this.words[q+j]|0)+R;var k=(I.words[q]|0)*D;B-=k&67108863,R=(B>>26)-(k/67108864|0),this.words[q+j]=B&67108863}for(;q<this.length-j;q++)B=(this.words[q+j]|0)+R,R=B>>26,this.words[q+j]=B&67108863;if(R===0)return this._strip();for(S(R===-1),R=0,q=0;q<this.length;q++)B=-(this.words[q]|0)+R,R=B>>26,this.words[q]=B&67108863;return this.negative=1,this._strip()},c.prototype._wordDiv=function(I,D){var j=this.length-I.length,Y=this.clone(),q=I,B=q.words[q.length-1]|0,R=this._countBits(B);j=26-R,j!==0&&(q=q.ushln(j),Y.iushln(j),B=q.words[q.length-1]|0);var k=Y.length-q.length,P;if(D!=="mod"){P=new c(null),P.length=k+1,P.words=new Array(P.length);for(var V=0;V<P.length;V++)P.words[V]=0}var x=Y.clone()._ishlnsubmul(q,1,k);x.negative===0&&(Y=x,P&&(P.words[k]=1));for(var Q=k-1;Q>=0;Q--){var te=(Y.words[q.length+Q]|0)*67108864+(Y.words[q.length+Q-1]|0);for(te=Math.min(te/B|0,67108863),Y._ishlnsubmul(q,te,Q);Y.negative!==0;)te--,Y.negative=0,Y._ishlnsubmul(q,1,Q),Y.isZero()||(Y.negative^=1);P&&(P.words[Q]=te)}return P&&P._strip(),Y._strip(),D!=="div"&&j!==0&&Y.iushrn(j),{div:P||null,mod:Y}},c.prototype.divmod=function(I,D,j){if(S(!I.isZero()),this.isZero())return{div:new c(0),mod:new c(0)};var Y,q,B;return this.negative!==0&&I.negative===0?(B=this.neg().divmod(I,D),D!=="mod"&&(Y=B.div.neg()),D!=="div"&&(q=B.mod.neg(),j&&q.negative!==0&&q.iadd(I)),{div:Y,mod:q}):this.negative===0&&I.negative!==0?(B=this.divmod(I.neg(),D),D!=="mod"&&(Y=B.div.neg()),{div:Y,mod:B.mod}):this.negative&I.negative?(B=this.neg().divmod(I.neg(),D),D!=="div"&&(q=B.mod.neg(),j&&q.negative!==0&&q.isub(I)),{div:B.div,mod:q}):I.length>this.length||this.cmp(I)<0?{div:new c(0),mod:this}:I.length===1?D==="div"?{div:this.divn(I.words[0]),mod:null}:D==="mod"?{div:null,mod:new c(this.modrn(I.words[0]))}:{div:this.divn(I.words[0]),mod:new c(this.modrn(I.words[0]))}:this._wordDiv(I,D)},c.prototype.div=function(I){return this.divmod(I,"div",!1).div},c.prototype.mod=function(I){return this.divmod(I,"mod",!1).mod},c.prototype.umod=function(I){return this.divmod(I,"mod",!0).mod},c.prototype.divRound=function(I){var D=this.divmod(I);if(D.mod.isZero())return D.div;var j=D.div.negative!==0?D.mod.isub(I):D.mod,Y=I.ushrn(1),q=I.andln(1),B=j.cmp(Y);return B<0||q===1&&B===0?D.div:D.div.negative!==0?D.div.isubn(1):D.div.iaddn(1)},c.prototype.modrn=function(I){var D=I<0;D&&(I=-I),S(I<=67108863);for(var j=(1<<26)%I,Y=0,q=this.length-1;q>=0;q--)Y=(j*Y+(this.words[q]|0))%I;return D?-Y:Y},c.prototype.modn=function(I){return this.modrn(I)},c.prototype.idivn=function(I){var D=I<0;D&&(I=-I),S(I<=67108863);for(var j=0,Y=this.length-1;Y>=0;Y--){var q=(this.words[Y]|0)+j*67108864;this.words[Y]=q/I|0,j=q%I}return this._strip(),D?this.ineg():this},c.prototype.divn=function(I){return this.clone().idivn(I)},c.prototype.egcd=function(I){S(I.negative===0),S(!I.isZero());var D=this,j=I.clone();D.negative!==0?D=D.umod(I):D=D.clone();for(var Y=new c(1),q=new c(0),B=new c(0),R=new c(1),k=0;D.isEven()&&j.isEven();)D.iushrn(1),j.iushrn(1),++k;for(var P=j.clone(),V=D.clone();!D.isZero();){for(var x=0,Q=1;!(D.words[0]&Q)&&x<26;++x,Q<<=1);if(x>0)for(D.iushrn(x);x-- >0;)(Y.isOdd()||q.isOdd())&&(Y.iadd(P),q.isub(V)),Y.iushrn(1),q.iushrn(1);for(var te=0,ae=1;!(j.words[0]&ae)&&te<26;++te,ae<<=1);if(te>0)for(j.iushrn(te);te-- >0;)(B.isOdd()||R.isOdd())&&(B.iadd(P),R.isub(V)),B.iushrn(1),R.iushrn(1);D.cmp(j)>=0?(D.isub(j),Y.isub(B),q.isub(R)):(j.isub(D),B.isub(Y),R.isub(q))}return{a:B,b:R,gcd:j.iushln(k)}},c.prototype._invmp=function(I){S(I.negative===0),S(!I.isZero());var D=this,j=I.clone();D.negative!==0?D=D.umod(I):D=D.clone();for(var Y=new c(1),q=new c(0),B=j.clone();D.cmpn(1)>0&&j.cmpn(1)>0;){for(var R=0,k=1;!(D.words[0]&k)&&R<26;++R,k<<=1);if(R>0)for(D.iushrn(R);R-- >0;)Y.isOdd()&&Y.iadd(B),Y.iushrn(1);for(var P=0,V=1;!(j.words[0]&V)&&P<26;++P,V<<=1);if(P>0)for(j.iushrn(P);P-- >0;)q.isOdd()&&q.iadd(B),q.iushrn(1);D.cmp(j)>=0?(D.isub(j),Y.isub(q)):(j.isub(D),q.isub(Y))}var x;return D.cmpn(1)===0?x=Y:x=q,x.cmpn(0)<0&&x.iadd(I),x},c.prototype.gcd=function(I){if(this.isZero())return I.abs();if(I.isZero())return this.abs();var D=this.clone(),j=I.clone();D.negative=0,j.negative=0;for(var Y=0;D.isEven()&&j.isEven();Y++)D.iushrn(1),j.iushrn(1);do{for(;D.isEven();)D.iushrn(1);for(;j.isEven();)j.iushrn(1);var q=D.cmp(j);if(q<0){var B=D;D=j,j=B}else if(q===0||j.cmpn(1)===0)break;D.isub(j)}while(!0);return j.iushln(Y)},c.prototype.invm=function(I){return this.egcd(I).a.umod(I)},c.prototype.isEven=function(){return(this.words[0]&1)===0},c.prototype.isOdd=function(){return(this.words[0]&1)===1},c.prototype.andln=function(I){return this.words[0]&I},c.prototype.bincn=function(I){S(typeof I=="number");var D=I%26,j=(I-D)/26,Y=1<<D;if(this.length<=j)return this._expand(j+1),this.words[j]|=Y,this;for(var q=Y,B=j;q!==0&&B<this.length;B++){var R=this.words[B]|0;R+=q,q=R>>>26,R&=67108863,this.words[B]=R}return q!==0&&(this.words[B]=q,this.length++),this},c.prototype.isZero=function(){return this.length===1&&this.words[0]===0},c.prototype.cmpn=function(I){var D=I<0;if(this.negative!==0&&!D)return-1;if(this.negative===0&&D)return 1;this._strip();var j;if(this.length>1)j=1;else{D&&(I=-I),S(I<=67108863,"Number is too big");var Y=this.words[0]|0;j=Y===I?0:Y<I?-1:1}return this.negative!==0?-j|0:j},c.prototype.cmp=function(I){if(this.negative!==0&&I.negative===0)return-1;if(this.negative===0&&I.negative!==0)return 1;var D=this.ucmp(I);return this.negative!==0?-D|0:D},c.prototype.ucmp=function(I){if(this.length>I.length)return 1;if(this.length<I.length)return-1;for(var D=0,j=this.length-1;j>=0;j--){var Y=this.words[j]|0,q=I.words[j]|0;if(Y!==q){Y<q?D=-1:Y>q&&(D=1);break}}return D},c.prototype.gtn=function(I){return this.cmpn(I)===1},c.prototype.gt=function(I){return this.cmp(I)===1},c.prototype.gten=function(I){return this.cmpn(I)>=0},c.prototype.gte=function(I){return this.cmp(I)>=0},c.prototype.ltn=function(I){return this.cmpn(I)===-1},c.prototype.lt=function(I){return this.cmp(I)===-1},c.prototype.lten=function(I){return this.cmpn(I)<=0},c.prototype.lte=function(I){return this.cmp(I)<=0},c.prototype.eqn=function(I){return this.cmpn(I)===0},c.prototype.eq=function(I){return this.cmp(I)===0},c.red=function(I){return new F(I)},c.prototype.toRed=function(I){return S(!this.red,"Already a number in reduction context"),S(this.negative===0,"red works only with positives"),I.convertTo(this)._forceRed(I)},c.prototype.fromRed=function(){return S(this.red,"fromRed works only with numbers in reduction context"),this.red.convertFrom(this)},c.prototype._forceRed=function(I){return this.red=I,this},c.prototype.forceRed=function(I){return S(!this.red,"Already a number in reduction context"),this._forceRed(I)},c.prototype.redAdd=function(I){return S(this.red,"redAdd works only with red numbers"),this.red.add(this,I)},c.prototype.redIAdd=function(I){return S(this.red,"redIAdd works only with red numbers"),this.red.iadd(this,I)},c.prototype.redSub=function(I){return S(this.red,"redSub works only with red numbers"),this.red.sub(this,I)},c.prototype.redISub=function(I){return S(this.red,"redISub works only with red numbers"),this.red.isub(this,I)},c.prototype.redShl=function(I){return S(this.red,"redShl works only with red numbers"),this.red.shl(this,I)},c.prototype.redMul=function(I){return S(this.red,"redMul works only with red numbers"),this.red._verify2(this,I),this.red.mul(this,I)},c.prototype.redIMul=function(I){return S(this.red,"redMul works only with red numbers"),this.red._verify2(this,I),this.red.imul(this,I)},c.prototype.redSqr=function(){return S(this.red,"redSqr works only with red numbers"),this.red._verify1(this),this.red.sqr(this)},c.prototype.redISqr=function(){return S(this.red,"redISqr works only with red numbers"),this.red._verify1(this),this.red.isqr(this)},c.prototype.redSqrt=function(){return S(this.red,"redSqrt works only with red numbers"),this.red._verify1(this),this.red.sqrt(this)},c.prototype.redInvm=function(){return S(this.red,"redInvm works only with red numbers"),this.red._verify1(this),this.red.invm(this)},c.prototype.redNeg=function(){return S(this.red,"redNeg works only with red numbers"),this.red._verify1(this),this.red.neg(this)},c.prototype.redPow=function(I){return S(this.red&&!I.red,"redPow(normalNum)"),this.red._verify1(this),this.red.pow(this,I)};var T={k256:null,p224:null,p192:null,p25519:null};function w(O,I){this.name=O,this.p=new c(I,16),this.n=this.p.bitLength(),this.k=new c(1).iushln(this.n).isub(this.p),this.tmp=this._tmp()}w.prototype._tmp=function(){var I=new c(null);return I.words=new Array(Math.ceil(this.n/13)),I},w.prototype.ireduce=function(I){var D=I,j;do this.split(D,this.tmp),D=this.imulK(D),D=D.iadd(this.tmp),j=D.bitLength();while(j>this.n);var Y=j<this.n?-1:D.ucmp(this.p);return Y===0?(D.words[0]=0,D.length=1):Y>0?D.isub(this.p):D.strip!==void 0?D.strip():D._strip(),D},w.prototype.split=function(I,D){I.iushrn(this.n,0,D)},w.prototype.imulK=function(I){return I.imul(this.k)};function M(){w.call(this,"k256","ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f")}y(M,w),M.prototype.split=function(I,D){for(var j=4194303,Y=Math.min(I.length,9),q=0;q<Y;q++)D.words[q]=I.words[q];if(D.length=Y,I.length<=9){I.words[0]=0,I.length=1;return}var B=I.words[9];for(D.words[D.length++]=B&j,q=10;q<I.length;q++){var R=I.words[q]|0;I.words[q-10]=(R&j)<<4|B>>>22,B=R}B>>>=22,I.words[q-10]=B,B===0&&I.length>10?I.length-=10:I.length-=9},M.prototype.imulK=function(I){I.words[I.length]=0,I.words[I.length+1]=0,I.length+=2;for(var D=0,j=0;j<I.length;j++){var Y=I.words[j]|0;D+=Y*977,I.words[j]=D&67108863,D=Y*64+(D/67108864|0)}return I.words[I.length-1]===0&&(I.length--,I.words[I.length-1]===0&&I.length--),I};function A(){w.call(this,"p224","ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001")}y(A,w);function W(){w.call(this,"p192","ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff")}y(W,w);function ee(){w.call(this,"25519","7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed")}y(ee,w),ee.prototype.imulK=function(I){for(var D=0,j=0;j<I.length;j++){var Y=(I.words[j]|0)*19+D,q=Y&67108863;Y>>>=26,I.words[j]=q,D=Y}return D!==0&&(I.words[I.length++]=D),I},c._prime=function(I){if(T[I])return T[I];var D;if(I==="k256")D=new M;else if(I==="p224")D=new A;else if(I==="p192")D=new W;else if(I==="p25519")D=new ee;else throw new Error("Unknown prime "+I);return T[I]=D,D};function F(O){if(typeof O=="string"){var I=c._prime(O);this.m=I.p,this.prime=I}else S(O.gtn(1),"modulus must be greater than 1"),this.m=O,this.prime=null}F.prototype._verify1=function(I){S(I.negative===0,"red works only with positives"),S(I.red,"red works only with red numbers")},F.prototype._verify2=function(I,D){S((I.negative|D.negative)===0,"red works only with positives"),S(I.red&&I.red===D.red,"red works only with red numbers")},F.prototype.imod=function(I){return this.prime?this.prime.ireduce(I)._forceRed(this):(a(I,I.umod(this.m)._forceRed(this)),I)},F.prototype.neg=function(I){return I.isZero()?I.clone():this.m.sub(I)._forceRed(this)},F.prototype.add=function(I,D){this._verify2(I,D);var j=I.add(D);return j.cmp(this.m)>=0&&j.isub(this.m),j._forceRed(this)},F.prototype.iadd=function(I,D){this._verify2(I,D);var j=I.iadd(D);return j.cmp(this.m)>=0&&j.isub(this.m),j},F.prototype.sub=function(I,D){this._verify2(I,D);var j=I.sub(D);return j.cmpn(0)<0&&j.iadd(this.m),j._forceRed(this)},F.prototype.isub=function(I,D){this._verify2(I,D);var j=I.isub(D);return j.cmpn(0)<0&&j.iadd(this.m),j},F.prototype.shl=function(I,D){return this._verify1(I),this.imod(I.ushln(D))},F.prototype.imul=function(I,D){return this._verify2(I,D),this.imod(I.imul(D))},F.prototype.mul=function(I,D){return this._verify2(I,D),this.imod(I.mul(D))},F.prototype.isqr=function(I){return this.imul(I,I.clone())},F.prototype.sqr=function(I){return this.mul(I,I)},F.prototype.sqrt=function(I){if(I.isZero())return I.clone();var D=this.m.andln(3);if(S(D%2===1),D===3){var j=this.m.add(new c(1)).iushrn(2);return this.pow(I,j)}for(var Y=this.m.subn(1),q=0;!Y.isZero()&&Y.andln(1)===0;)q++,Y.iushrn(1);S(!Y.isZero());var B=new c(1).toRed(this),R=B.redNeg(),k=this.m.subn(1).iushrn(1),P=this.m.bitLength();for(P=new c(2*P*P).toRed(this);this.pow(P,k).cmp(R)!==0;)P.redIAdd(R);for(var V=this.pow(P,Y),x=this.pow(I,Y.addn(1).iushrn(1)),Q=this.pow(I,Y),te=q;Q.cmp(B)!==0;){for(var ae=Q,de=0;ae.cmp(B)!==0;de++)ae=ae.redSqr();S(de<te);var X=this.pow(V,new c(1).iushln(te-de-1));x=x.redMul(X),V=X.redSqr(),Q=Q.redMul(V),te=de}return x},F.prototype.invm=function(I){var D=I._invmp(this.m);return D.negative!==0?(D.negative=0,this.imod(D).redNeg()):this.imod(D)},F.prototype.pow=function(I,D){if(D.isZero())return new c(1).toRed(this);if(D.cmpn(1)===0)return I.clone();var j=4,Y=new Array(1<<j);Y[0]=new c(1).toRed(this),Y[1]=I;for(var q=2;q<Y.length;q++)Y[q]=this.mul(Y[q-1],I);var B=Y[0],R=0,k=0,P=D.bitLength()%26;for(P===0&&(P=26),q=D.length-1;q>=0;q--){for(var V=D.words[q],x=P-1;x>=0;x--){var Q=V>>x&1;if(B!==Y[0]&&(B=this.sqr(B)),Q===0&&R===0){k=0;continue}R<<=1,R|=Q,k++,!(k!==j&&(q!==0||x!==0))&&(B=this.mul(B,Y[R]),k=0,R=0)}P=26}return B},F.prototype.convertTo=function(I){var D=I.umod(this.m);return D===I?D.clone():D},F.prototype.convertFrom=function(I){var D=I.clone();return D.red=null,D},c.mont=function(I){return new C(I)};function C(O){F.call(this,O),this.shift=this.m.bitLength(),this.shift%26!==0&&(this.shift+=26-this.shift%26),this.r=new c(1).iushln(this.shift),this.r2=this.imod(this.r.sqr()),this.rinv=this.r._invmp(this.m),this.minv=this.rinv.mul(this.r).isubn(1).div(this.m),this.minv=this.minv.umod(this.r),this.minv=this.r.sub(this.minv)}y(C,F),C.prototype.convertTo=function(I){return this.imod(I.ushln(this.shift))},C.prototype.convertFrom=function(I){var D=this.imod(I.mul(this.rinv));return D.red=null,D},C.prototype.imul=function(I,D){if(I.isZero()||D.isZero())return I.words[0]=0,I.length=1,I;var j=I.imul(D),Y=j.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),q=j.isub(Y).iushrn(this.shift),B=q;return q.cmp(this.m)>=0?B=q.isub(this.m):q.cmpn(0)<0&&(B=q.iadd(this.m)),B._forceRed(this)},C.prototype.mul=function(I,D){if(I.isZero()||D.isZero())return new c(0)._forceRed(this);var j=I.mul(D),Y=j.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),q=j.isub(Y).iushrn(this.shift),B=q;return q.cmp(this.m)>=0?B=q.isub(this.m):q.cmpn(0)<0&&(B=q.iadd(this.m)),B._forceRed(this)},C.prototype.invm=function(I){var D=this.imod(I._invmp(this.m).mul(this.r2));return D._forceRed(this)}})(typeof E>"u"||E,this)},{buffer:20}],43:[function(t,E,e){E.exports=t("./browser/algorithms.json")},{"./browser/algorithms.json":44}],44:[function(t,E,e){E.exports={sha224WithRSAEncryption:{sign:"rsa",hash:"sha224",id:"302d300d06096086480165030402040500041c"},"RSA-SHA224":{sign:"ecdsa/rsa",hash:"sha224",id:"302d300d06096086480165030402040500041c"},sha256WithRSAEncryption:{sign:"rsa",hash:"sha256",id:"3031300d060960864801650304020105000420"},"RSA-SHA256":{sign:"ecdsa/rsa",hash:"sha256",id:"3031300d060960864801650304020105000420"},sha384WithRSAEncryption:{sign:"rsa",hash:"sha384",id:"3041300d060960864801650304020205000430"},"RSA-SHA384":{sign:"ecdsa/rsa",hash:"sha384",id:"3041300d060960864801650304020205000430"},sha512WithRSAEncryption:{sign:"rsa",hash:"sha512",id:"3051300d060960864801650304020305000440"},"RSA-SHA512":{sign:"ecdsa/rsa",hash:"sha512",id:"3051300d060960864801650304020305000440"},"RSA-SHA1":{sign:"rsa",hash:"sha1",id:"3021300906052b0e03021a05000414"},"ecdsa-with-SHA1":{sign:"ecdsa",hash:"sha1",id:""},sha256:{sign:"ecdsa",hash:"sha256",id:""},sha224:{sign:"ecdsa",hash:"sha224",id:""},sha384:{sign:"ecdsa",hash:"sha384",id:""},sha512:{sign:"ecdsa",hash:"sha512",id:""},"DSA-SHA":{sign:"dsa",hash:"sha1",id:""},"DSA-SHA1":{sign:"dsa",hash:"sha1",id:""},DSA:{sign:"dsa",hash:"sha1",id:""},"DSA-WITH-SHA224":{sign:"dsa",hash:"sha224",id:""},"DSA-SHA224":{sign:"dsa",hash:"sha224",id:""},"DSA-WITH-SHA256":{sign:"dsa",hash:"sha256",id:""},"DSA-SHA256":{sign:"dsa",hash:"sha256",id:""},"DSA-WITH-SHA384":{sign:"dsa",hash:"sha384",id:""},"DSA-SHA384":{sign:"dsa",hash:"sha384",id:""},"DSA-WITH-SHA512":{sign:"dsa",hash:"sha512",id:""},"DSA-SHA512":{sign:"dsa",hash:"sha512",id:""},"DSA-RIPEMD160":{sign:"dsa",hash:"rmd160",id:""},ripemd160WithRSA:{sign:"rsa",hash:"rmd160",id:"3021300906052b2403020105000414"},"RSA-RIPEMD160":{sign:"rsa",hash:"rmd160",id:"3021300906052b2403020105000414"},md5WithRSAEncryption:{sign:"rsa",hash:"md5",id:"3020300c06082a864886f70d020505000410"},"RSA-MD5":{sign:"rsa",hash:"md5",id:"3020300c06082a864886f70d020505000410"}}},{}],45:[function(t,E,e){E.exports={"1.3.132.0.10":"secp256k1","1.3.132.0.33":"p224","1.2.840.10045.3.1.1":"p192","1.2.840.10045.3.1.7":"p256","1.3.132.0.34":"p384","1.3.132.0.35":"p521"}},{}],46:[function(t,E,e){var u=t("safe-buffer").Buffer,g=t("create-hash"),S=t("readable-stream"),y=t("inherits"),c=t("./sign"),m=t("./verify"),h=t("./algorithms.json");Object.keys(h).forEach(function(i){h[i].id=u.from(h[i].id,"hex"),h[i.toLowerCase()]=h[i]});function d(i){S.Writable.call(this);var r=h[i];if(!r)throw new Error("Unknown message digest");this._hashType=r.hash,this._hash=g(r.hash),this._tag=r.id,this._signType=r.sign}y(d,S.Writable),d.prototype._write=function(r,s,o){this._hash.update(r),o()},d.prototype.update=function(r,s){return typeof r=="string"&&(r=u.from(r,s)),this._hash.update(r),this},d.prototype.sign=function(r,s){this.end();var o=this._hash.digest(),l=c(o,r,this._hashType,this._signType,this._tag);return s?l.toString(s):l};function b(i){S.Writable.call(this);var r=h[i];if(!r)throw new Error("Unknown message digest");this._hash=g(r.hash),this._tag=r.id,this._signType=r.sign}y(b,S.Writable),b.prototype._write=function(r,s,o){this._hash.update(r),o()},b.prototype.update=function(r,s){return typeof r=="string"&&(r=u.from(r,s)),this._hash.update(r),this},b.prototype.verify=function(r,s,o){typeof s=="string"&&(s=u.from(s,o)),this.end();var l=this._hash.digest();return m(s,l,r,this._signType,this._tag)};function a(i){return new d(i)}function n(i){return new b(i)}E.exports={Sign:a,Verify:n,createSign:a,createVerify:n}},{"./algorithms.json":44,"./sign":47,"./verify":48,"create-hash":74,inherits:146,"readable-stream":64,"safe-buffer":250}],47:[function(t,E,e){var u=t("safe-buffer").Buffer,g=t("create-hmac"),S=t("browserify-rsa"),y=t("elliptic").ec,c=t("bn.js"),m=t("parse-asn1"),h=t("./curves.json");function d(v,f,p,_,T){var w=m(f);if(w.curve){if(_!=="ecdsa"&&_!=="ecdsa/rsa")throw new Error("wrong private key type");return b(v,w)}else if(w.type==="dsa"){if(_!=="dsa")throw new Error("wrong private key type");return a(v,w,p)}else if(_!=="rsa"&&_!=="ecdsa/rsa")throw new Error("wrong private key type");v=u.concat([T,v]);for(var M=w.modulus.byteLength(),A=[0,1];v.length+A.length+1<M;)A.push(255);A.push(0);for(var W=-1;++W<v.length;)A.push(v[W]);var ee=S(A,w);return ee}function b(v,f){var p=h[f.curve.join(".")];if(!p)throw new Error("unknown curve "+f.curve.join("."));var _=new y(p),T=_.keyFromPrivate(f.privateKey),w=T.sign(v);return u.from(w.toDER())}function a(v,f,p){for(var _=f.params.priv_key,T=f.params.p,w=f.params.q,M=f.params.g,A=new c(0),W,ee=r(v,w).mod(w),F=!1,C=i(_,w,v,p);F===!1;)W=o(w,C,p),A=l(M,W,T,w),F=W.invm(w).imul(ee.add(_.mul(A))).mod(w),F.cmpn(0)===0&&(F=!1,A=new c(0));return n(A,F)}function n(v,f){v=v.toArray(),f=f.toArray(),v[0]&128&&(v=[0].concat(v)),f[0]&128&&(f=[0].concat(f));var p=v.length+f.length+4,_=[48,p,2,v.length];return _=_.concat(v,[2,f.length],f),u.from(_)}function i(v,f,p,_){if(v=u.from(v.toArray()),v.length<f.byteLength()){var T=u.alloc(f.byteLength()-v.length);v=u.concat([T,v])}var w=p.length,M=s(p,f),A=u.alloc(w);A.fill(1);var W=u.alloc(w);return W=g(_,W).update(A).update(u.from([0])).update(v).update(M).digest(),A=g(_,W).update(A).digest(),W=g(_,W).update(A).update(u.from([1])).update(v).update(M).digest(),A=g(_,W).update(A).digest(),{k:W,v:A}}function r(v,f){var p=new c(v),_=(v.length<<3)-f.bitLength();return _>0&&p.ishrn(_),p}function s(v,f){v=r(v,f),v=v.mod(f);var p=u.from(v.toArray());if(p.length<f.byteLength()){var _=u.alloc(f.byteLength()-p.length);p=u.concat([_,p])}return p}function o(v,f,p){var _,T;do{for(_=u.alloc(0);_.length*8<v.bitLength();)f.v=g(p,f.k).update(f.v).digest(),_=u.concat([_,f.v]);T=r(_,v),f.k=g(p,f.k).update(f.v).update(u.from([0])).digest(),f.v=g(p,f.k).update(f.v).digest()}while(T.cmp(v)!==-1);return T}function l(v,f,p,_){return v.toRed(c.mont(p)).redPow(f).fromRed().mod(_)}E.exports=d,E.exports.getKey=i,E.exports.makeKey=o},{"./curves.json":45,"bn.js":49,"browserify-rsa":41,"create-hmac":76,elliptic:89,"parse-asn1":230,"safe-buffer":250}],48:[function(t,E,e){var u=t("safe-buffer").Buffer,g=t("bn.js"),S=t("elliptic").ec,y=t("parse-asn1"),c=t("./curves.json");function m(a,n,i,r,s){var o=y(i);if(o.type==="ec"){if(r!=="ecdsa"&&r!=="ecdsa/rsa")throw new Error("wrong public key type");return h(a,n,o)}else if(o.type==="dsa"){if(r!=="dsa")throw new Error("wrong public key type");return d(a,n,o)}else if(r!=="rsa"&&r!=="ecdsa/rsa")throw new Error("wrong public key type");n=u.concat([s,n]);for(var l=o.modulus.byteLength(),v=[1],f=0;n.length+v.length+2<l;)v.push(255),f++;v.push(0);for(var p=-1;++p<n.length;)v.push(n[p]);v=u.from(v);var _=g.mont(o.modulus);a=new g(a).toRed(_),a=a.redPow(new g(o.publicExponent)),a=u.from(a.fromRed().toArray());var T=f<8?1:0;for(l=Math.min(a.length,v.length),a.length!==v.length&&(T=1),p=-1;++p<l;)T|=a[p]^v[p];return T===0}function h(a,n,i){var r=c[i.data.algorithm.curve.join(".")];if(!r)throw new Error("unknown curve "+i.data.algorithm.curve.join("."));var s=new S(r),o=i.data.subjectPrivateKey.data;return s.verify(n,a,o)}function d(a,n,i){var r=i.data.p,s=i.data.q,o=i.data.g,l=i.data.pub_key,v=y.signature.decode(a,"der"),f=v.s,p=v.r;b(f,s),b(p,s);var _=g.mont(r),T=f.invm(s),w=o.toRed(_).redPow(new g(n).mul(T).mod(s)).fromRed().mul(l.toRed(_).redPow(p.mul(T).mod(s)).fromRed()).mod(r).mod(s);return w.cmp(p)===0}function b(a,n){if(a.cmpn(0)<=0)throw new Error("invalid sig");if(a.cmp(n)>=n)throw new Error("invalid sig")}E.exports=m},{"./curves.json":45,"bn.js":49,elliptic:89,"parse-asn1":230,"safe-buffer":250}],49:[function(t,E,e){arguments[4][42][0].apply(e,arguments)},{buffer:20,dup:42}],50:[function(t,E,e){function u(d,b){d.prototype=Object.create(b.prototype),d.prototype.constructor=d,d.__proto__=b}var g={};function S(d,b,a){a||(a=Error);function n(r,s,o){return typeof b=="string"?b:b(r,s,o)}var i=function(r){u(s,r);function s(o,l,v){return r.call(this,n(o,l,v))||this}return s}(a);i.prototype.name=a.name,i.prototype.code=d,g[d]=i}function y(d,b){if(Array.isArray(d)){var a=d.length;return d=d.map(function(n){return String(n)}),a>2?"one of ".concat(b," ").concat(d.slice(0,a-1).join(", "),", or ")+d[a-1]:a===2?"one of ".concat(b," ").concat(d[0]," or ").concat(d[1]):"of ".concat(b," ").concat(d[0])}else return"of ".concat(b," ").concat(String(d))}function c(d,b,a){return d.substr(!a||a<0?0:+a,b.length)===b}function m(d,b,a){return(a===void 0||a>d.length)&&(a=d.length),d.substring(a-b.length,a)===b}function h(d,b,a){return typeof a!="number"&&(a=0),a+b.length>d.length?!1:d.indexOf(b,a)!==-1}S("ERR_INVALID_OPT_VALUE",function(d,b){return'The value "'+b+'" is invalid for option "'+d+'"'},TypeError),S("ERR_INVALID_ARG_TYPE",function(d,b,a){var n;typeof b=="string"&&c(b,"not ")?(n="must not be",b=b.replace(/^not /,"")):n="must be";var i;if(m(d," argument"))i="The ".concat(d," ").concat(n," ").concat(y(b,"type"));else{var r=h(d,".")?"property":"argument";i='The "'.concat(d,'" ').concat(r," ").concat(n," ").concat(y(b,"type"))}return i+=". Received type ".concat(typeof a),i},TypeError),S("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),S("ERR_METHOD_NOT_IMPLEMENTED",function(d){return"The "+d+" method is not implemented"}),S("ERR_STREAM_PREMATURE_CLOSE","Premature close"),S("ERR_STREAM_DESTROYED",function(d){return"Cannot call "+d+" after a stream was destroyed"}),S("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),S("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),S("ERR_STREAM_WRITE_AFTER_END","write after end"),S("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),S("ERR_UNKNOWN_ENCODING",function(d){return"Unknown encoding: "+d},TypeError),S("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),E.exports.codes=g},{}],51:[function(t,E,e){(function(u){(function(){var g=Object.keys||function(n){var i=[];for(var r in n)i.push(r);return i};E.exports=d;var S=t("./_stream_readable"),y=t("./_stream_writable");t("inherits")(d,S);for(var c=g(y.prototype),m=0;m<c.length;m++){var h=c[m];d.prototype[h]||(d.prototype[h]=y.prototype[h])}function d(n){if(!(this instanceof d))return new d(n);S.call(this,n),y.call(this,n),this.allowHalfOpen=!0,n&&(n.readable===!1&&(this.readable=!1),n.writable===!1&&(this.writable=!1),n.allowHalfOpen===!1&&(this.allowHalfOpen=!1,this.once("end",b)))}Object.defineProperty(d.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(d.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(d.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function b(){this._writableState.ended||u.nextTick(a,this)}function a(n){n.end()}Object.defineProperty(d.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0||this._writableState===void 0?!1:this._readableState.destroyed&&this._writableState.destroyed},set:function(i){this._readableState===void 0||this._writableState===void 0||(this._readableState.destroyed=i,this._writableState.destroyed=i)}})}).call(this)}).call(this,t("_process"))},{"./_stream_readable":53,"./_stream_writable":55,_process:237,inherits:146}],52:[function(t,E,e){E.exports=g;var u=t("./_stream_transform");t("inherits")(g,u);function g(S){if(!(this instanceof g))return new g(S);u.call(this,S)}g.prototype._transform=function(S,y,c){c(null,S)}},{"./_stream_transform":54,inherits:146}],53:[function(t,E,e){(function(u,g){(function(){E.exports=C;var S;C.ReadableState=F,t("events").EventEmitter;var y=function(G,U){return G.listeners(U).length},c=t("./internal/streams/stream"),m=t("buffer").Buffer,h=g.Uint8Array||function(){};function d(H){return m.from(H)}function b(H){return m.isBuffer(H)||H instanceof h}var a=t("util"),n;a&&a.debuglog?n=a.debuglog("stream"):n=function(){};var i=t("./internal/streams/buffer_list"),r=t("./internal/streams/destroy"),s=t("./internal/streams/state"),o=s.getHighWaterMark,l=t("../errors").codes,v=l.ERR_INVALID_ARG_TYPE,f=l.ERR_STREAM_PUSH_AFTER_EOF,p=l.ERR_METHOD_NOT_IMPLEMENTED,_=l.ERR_STREAM_UNSHIFT_AFTER_END_EVENT,T,w,M;t("inherits")(C,c);var A=r.errorOrDestroy,W=["error","close","destroy","pause","resume"];function ee(H,G,U){if(typeof H.prependListener=="function")return H.prependListener(G,U);!H._events||!H._events[G]?H.on(G,U):Array.isArray(H._events[G])?H._events[G].unshift(U):H._events[G]=[U,H._events[G]]}function F(H,G,U){S=S||t("./_stream_duplex"),H=H||{},typeof U!="boolean"&&(U=G instanceof S),this.objectMode=!!H.objectMode,U&&(this.objectMode=this.objectMode||!!H.readableObjectMode),this.highWaterMark=o(this,H,"readableHighWaterMark",U),this.buffer=new i,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=H.emitClose!==!1,this.autoDestroy=!!H.autoDestroy,this.destroyed=!1,this.defaultEncoding=H.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,H.encoding&&(T||(T=t("string_decoder/").StringDecoder),this.decoder=new T(H.encoding),this.encoding=H.encoding)}function C(H){if(S=S||t("./_stream_duplex"),!(this instanceof C))return new C(H);var G=this instanceof S;this._readableState=new F(H,this,G),this.readable=!0,H&&(typeof H.read=="function"&&(this._read=H.read),typeof H.destroy=="function"&&(this._destroy=H.destroy)),c.call(this)}Object.defineProperty(C.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0?!1:this._readableState.destroyed},set:function(G){this._readableState&&(this._readableState.destroyed=G)}}),C.prototype.destroy=r.destroy,C.prototype._undestroy=r.undestroy,C.prototype._destroy=function(H,G){G(H)},C.prototype.push=function(H,G){var U=this._readableState,L;return U.objectMode?L=!0:typeof H=="string"&&(G=G||U.defaultEncoding,G!==U.encoding&&(H=m.from(H,G),G=""),L=!0),O(this,H,G,!1,L)},C.prototype.unshift=function(H){return O(this,H,null,!0,!1)};function O(H,G,U,L,z){n("readableAddChunk",G);var J=H._readableState;if(G===null)J.reading=!1,B(H,J);else{var ne;if(z||(ne=D(J,G)),ne)A(H,ne);else if(J.objectMode||G&&G.length>0)if(typeof G!="string"&&!J.objectMode&&Object.getPrototypeOf(G)!==m.prototype&&(G=d(G)),L)J.endEmitted?A(H,new _):I(H,J,G,!0);else if(J.ended)A(H,new f);else{if(J.destroyed)return!1;J.reading=!1,J.decoder&&!U?(G=J.decoder.write(G),J.objectMode||G.length!==0?I(H,J,G,!1):P(H,J)):I(H,J,G,!1)}else L||(J.reading=!1,P(H,J))}return!J.ended&&(J.length<J.highWaterMark||J.length===0)}function I(H,G,U,L){G.flowing&&G.length===0&&!G.sync?(G.awaitDrain=0,H.emit("data",U)):(G.length+=G.objectMode?1:U.length,L?G.buffer.unshift(U):G.buffer.push(U),G.needReadable&&R(H)),P(H,G)}function D(H,G){var U;return!b(G)&&typeof G!="string"&&G!==void 0&&!H.objectMode&&(U=new v("chunk",["string","Buffer","Uint8Array"],G)),U}C.prototype.isPaused=function(){return this._readableState.flowing===!1},C.prototype.setEncoding=function(H){T||(T=t("string_decoder/").StringDecoder);var G=new T(H);this._readableState.decoder=G,this._readableState.encoding=this._readableState.decoder.encoding;for(var U=this._readableState.buffer.head,L="";U!==null;)L+=G.write(U.data),U=U.next;return this._readableState.buffer.clear(),L!==""&&this._readableState.buffer.push(L),this._readableState.length=L.length,this};var j=1073741824;function Y(H){return H>=j?H=j:(H--,H|=H>>>1,H|=H>>>2,H|=H>>>4,H|=H>>>8,H|=H>>>16,H++),H}function q(H,G){return H<=0||G.length===0&&G.ended?0:G.objectMode?1:H!==H?G.flowing&&G.length?G.buffer.head.data.length:G.length:(H>G.highWaterMark&&(G.highWaterMark=Y(H)),H<=G.length?H:G.ended?G.length:(G.needReadable=!0,0))}C.prototype.read=function(H){n("read",H),H=parseInt(H,10);var G=this._readableState,U=H;if(H!==0&&(G.emittedReadable=!1),H===0&&G.needReadable&&((G.highWaterMark!==0?G.length>=G.highWaterMark:G.length>0)||G.ended))return n("read: emitReadable",G.length,G.ended),G.length===0&&G.ended?K(this):R(this),null;if(H=q(H,G),H===0&&G.ended)return G.length===0&&K(this),null;var L=G.needReadable;n("need readable",L),(G.length===0||G.length-H<G.highWaterMark)&&(L=!0,n("length less than watermark",L)),G.ended||G.reading?(L=!1,n("reading or ended",L)):L&&(n("do read"),G.reading=!0,G.sync=!0,G.length===0&&(G.needReadable=!0),this._read(G.highWaterMark),G.sync=!1,G.reading||(H=q(U,G)));var z;return H>0?z=$(H,G):z=null,z===null?(G.needReadable=G.length<=G.highWaterMark,H=0):(G.length-=H,G.awaitDrain=0),G.length===0&&(G.ended||(G.needReadable=!0),U!==H&&G.ended&&K(this)),z!==null&&this.emit("data",z),z};function B(H,G){if(n("onEofChunk"),!G.ended){if(G.decoder){var U=G.decoder.end();U&&U.length&&(G.buffer.push(U),G.length+=G.objectMode?1:U.length)}G.ended=!0,G.sync?R(H):(G.needReadable=!1,G.emittedReadable||(G.emittedReadable=!0,k(H)))}}function R(H){var G=H._readableState;n("emitReadable",G.needReadable,G.emittedReadable),G.needReadable=!1,G.emittedReadable||(n("emitReadable",G.flowing),G.emittedReadable=!0,u.nextTick(k,H))}function k(H){var G=H._readableState;n("emitReadable_",G.destroyed,G.length,G.ended),!G.destroyed&&(G.length||G.ended)&&(H.emit("readable"),G.emittedReadable=!1),G.needReadable=!G.flowing&&!G.ended&&G.length<=G.highWaterMark,X(H)}function P(H,G){G.readingMore||(G.readingMore=!0,u.nextTick(V,H,G))}function V(H,G){for(;!G.reading&&!G.ended&&(G.length<G.highWaterMark||G.flowing&&G.length===0);){var U=G.length;if(n("maybeReadMore read 0"),H.read(0),U===G.length)break}G.readingMore=!1}C.prototype._read=function(H){A(this,new p("_read()"))},C.prototype.pipe=function(H,G){var U=this,L=this._readableState;switch(L.pipesCount){case 0:L.pipes=H;break;case 1:L.pipes=[L.pipes,H];break;default:L.pipes.push(H);break}L.pipesCount+=1,n("pipe count=%d opts=%j",L.pipesCount,G);var z=(!G||G.end!==!1)&&H!==u.stdout&&H!==u.stderr,J=z?oe:we;L.endEmitted?u.nextTick(J):U.once("end",J),H.on("unpipe",ne);function ne(me,N){n("onunpipe"),me===U&&N&&N.hasUnpiped===!1&&(N.hasUnpiped=!0,he())}function oe(){n("onend"),H.end()}var ce=x(U);H.on("drain",ce);var pe=!1;function he(){n("cleanup"),H.removeListener("close",ye),H.removeListener("finish",Ee),H.removeListener("drain",ce),H.removeListener("error",ve),H.removeListener("unpipe",ne),U.removeListener("end",oe),U.removeListener("end",we),U.removeListener("data",fe),pe=!0,L.awaitDrain&&(!H._writableState||H._writableState.needDrain)&&ce()}U.on("data",fe);function fe(me){n("ondata");var N=H.write(me);n("dest.write",N),N===!1&&((L.pipesCount===1&&L.pipes===H||L.pipesCount>1&&ue(L.pipes,H)!==-1)&&!pe&&(n("false write response, pause",L.awaitDrain),L.awaitDrain++),U.pause())}function ve(me){n("onerror",me),we(),H.removeListener("error",ve),y(H,"error")===0&&A(H,me)}ee(H,"error",ve);function ye(){H.removeListener("finish",Ee),we()}H.once("close",ye);function Ee(){n("onfinish"),H.removeListener("close",ye),we()}H.once("finish",Ee);function we(){n("unpipe"),U.unpipe(H)}return H.emit("pipe",U),L.flowing||(n("pipe resume"),U.resume()),H};function x(H){return function(){var U=H._readableState;n("pipeOnDrain",U.awaitDrain),U.awaitDrain&&U.awaitDrain--,U.awaitDrain===0&&y(H,"data")&&(U.flowing=!0,X(H))}}C.prototype.unpipe=function(H){var G=this._readableState,U={hasUnpiped:!1};if(G.pipesCount===0)return this;if(G.pipesCount===1)return H&&H!==G.pipes?this:(H||(H=G.pipes),G.pipes=null,G.pipesCount=0,G.flowing=!1,H&&H.emit("unpipe",this,U),this);if(!H){var L=G.pipes,z=G.pipesCount;G.pipes=null,G.pipesCount=0,G.flowing=!1;for(var J=0;J<z;J++)L[J].emit("unpipe",this,{hasUnpiped:!1});return this}var ne=ue(G.pipes,H);return ne===-1?this:(G.pipes.splice(ne,1),G.pipesCount-=1,G.pipesCount===1&&(G.pipes=G.pipes[0]),H.emit("unpipe",this,U),this)},C.prototype.on=function(H,G){var U=c.prototype.on.call(this,H,G),L=this._readableState;return H==="data"?(L.readableListening=this.listenerCount("readable")>0,L.flowing!==!1&&this.resume()):H==="readable"&&!L.endEmitted&&!L.readableListening&&(L.readableListening=L.needReadable=!0,L.flowing=!1,L.emittedReadable=!1,n("on readable",L.length,L.reading),L.length?R(this):L.reading||u.nextTick(te,this)),U},C.prototype.addListener=C.prototype.on,C.prototype.removeListener=function(H,G){var U=c.prototype.removeListener.call(this,H,G);return H==="readable"&&u.nextTick(Q,this),U},C.prototype.removeAllListeners=function(H){var G=c.prototype.removeAllListeners.apply(this,arguments);return(H==="readable"||H===void 0)&&u.nextTick(Q,this),G};function Q(H){var G=H._readableState;G.readableListening=H.listenerCount("readable")>0,G.resumeScheduled&&!G.paused?G.flowing=!0:H.listenerCount("data")>0&&H.resume()}function te(H){n("readable nexttick read 0"),H.read(0)}C.prototype.resume=function(){var H=this._readableState;return H.flowing||(n("resume"),H.flowing=!H.readableListening,ae(this,H)),H.paused=!1,this};function ae(H,G){G.resumeScheduled||(G.resumeScheduled=!0,u.nextTick(de,H,G))}function de(H,G){n("resume",G.reading),G.reading||H.read(0),G.resumeScheduled=!1,H.emit("resume"),X(H),G.flowing&&!G.reading&&H.read(0)}C.prototype.pause=function(){return n("call pause flowing=%j",this._readableState.flowing),this._readableState.flowing!==!1&&(n("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this};function X(H){var G=H._readableState;for(n("flow",G.flowing);G.flowing&&H.read()!==null;);}C.prototype.wrap=function(H){var G=this,U=this._readableState,L=!1;H.on("end",function(){if(n("wrapped end"),U.decoder&&!U.ended){var ne=U.decoder.end();ne&&ne.length&&G.push(ne)}G.push(null)}),H.on("data",function(ne){if(n("wrapped data"),U.decoder&&(ne=U.decoder.write(ne)),!(U.objectMode&&ne==null)&&!(!U.objectMode&&(!ne||!ne.length))){var oe=G.push(ne);oe||(L=!0,H.pause())}});for(var z in H)this[z]===void 0&&typeof H[z]=="function"&&(this[z]=function(oe){return function(){return H[oe].apply(H,arguments)}}(z));for(var J=0;J<W.length;J++)H.on(W[J],this.emit.bind(this,W[J]));return this._read=function(ne){n("wrapped _read",ne),L&&(L=!1,H.resume())},this},typeof Symbol=="function"&&(C.prototype[Symbol.asyncIterator]=function(){return w===void 0&&(w=t("./internal/streams/async_iterator")),w(this)}),Object.defineProperty(C.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(C.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(C.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(G){this._readableState&&(this._readableState.flowing=G)}}),C._fromList=$,Object.defineProperty(C.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}});function $(H,G){if(G.length===0)return null;var U;return G.objectMode?U=G.buffer.shift():!H||H>=G.length?(G.decoder?U=G.buffer.join(""):G.buffer.length===1?U=G.buffer.first():U=G.buffer.concat(G.length),G.buffer.clear()):U=G.buffer.consume(H,G.decoder),U}function K(H){var G=H._readableState;n("endReadable",G.endEmitted),G.endEmitted||(G.ended=!0,u.nextTick(re,G,H))}function re(H,G){if(n("endReadableNT",H.endEmitted,H.length),!H.endEmitted&&H.length===0&&(H.endEmitted=!0,G.readable=!1,G.emit("end"),H.autoDestroy)){var U=G._writableState;(!U||U.autoDestroy&&U.finished)&&G.destroy()}}typeof Symbol=="function"&&(C.from=function(H,G){return M===void 0&&(M=t("./internal/streams/from")),M(C,H,G)});function ue(H,G){for(var U=0,L=H.length;U<L;U++)if(H[U]===G)return U;return-1}}).call(this)}).call(this,t("_process"),typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../errors":50,"./_stream_duplex":51,"./internal/streams/async_iterator":56,"./internal/streams/buffer_list":57,"./internal/streams/destroy":58,"./internal/streams/from":60,"./internal/streams/state":62,"./internal/streams/stream":63,_process:237,buffer:68,events:105,inherits:146,"string_decoder/":279,util:20}],54:[function(t,E,e){E.exports=d;var u=t("../errors").codes,g=u.ERR_METHOD_NOT_IMPLEMENTED,S=u.ERR_MULTIPLE_CALLBACK,y=u.ERR_TRANSFORM_ALREADY_TRANSFORMING,c=u.ERR_TRANSFORM_WITH_LENGTH_0,m=t("./_stream_duplex");t("inherits")(d,m);function h(n,i){var r=this._transformState;r.transforming=!1;var s=r.writecb;if(s===null)return this.emit("error",new S);r.writechunk=null,r.writecb=null,i!=null&&this.push(i),s(n);var o=this._readableState;o.reading=!1,(o.needReadable||o.length<o.highWaterMark)&&this._read(o.highWaterMark)}function d(n){if(!(this instanceof d))return new d(n);m.call(this,n),this._transformState={afterTransform:h.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,n&&(typeof n.transform=="function"&&(this._transform=n.transform),typeof n.flush=="function"&&(this._flush=n.flush)),this.on("prefinish",b)}function b(){var n=this;typeof this._flush=="function"&&!this._readableState.destroyed?this._flush(function(i,r){a(n,i,r)}):a(this,null,null)}d.prototype.push=function(n,i){return this._transformState.needTransform=!1,m.prototype.push.call(this,n,i)},d.prototype._transform=function(n,i,r){r(new g("_transform()"))},d.prototype._write=function(n,i,r){var s=this._transformState;if(s.writecb=r,s.writechunk=n,s.writeencoding=i,!s.transforming){var o=this._readableState;(s.needTransform||o.needReadable||o.length<o.highWaterMark)&&this._read(o.highWaterMark)}},d.prototype._read=function(n){var i=this._transformState;i.writechunk!==null&&!i.transforming?(i.transforming=!0,this._transform(i.writechunk,i.writeencoding,i.afterTransform)):i.needTransform=!0},d.prototype._destroy=function(n,i){m.prototype._destroy.call(this,n,function(r){i(r)})};function a(n,i,r){if(i)return n.emit("error",i);if(r!=null&&n.push(r),n._writableState.length)throw new c;if(n._transformState.transforming)throw new y;return n.push(null)}},{"../errors":50,"./_stream_duplex":51,inherits:146}],55:[function(t,E,e){(function(u,g){(function(){E.exports=F;function S(X){var $=this;this.next=null,this.entry=null,this.finish=function(){de($,X)}}var y;F.WritableState=W;var c={deprecate:t("util-deprecate")},m=t("./internal/streams/stream"),h=t("buffer").Buffer,d=g.Uint8Array||function(){};function b(X){return h.from(X)}function a(X){return h.isBuffer(X)||X instanceof d}var n=t("./internal/streams/destroy"),i=t("./internal/streams/state"),r=i.getHighWaterMark,s=t("../errors").codes,o=s.ERR_INVALID_ARG_TYPE,l=s.ERR_METHOD_NOT_IMPLEMENTED,v=s.ERR_MULTIPLE_CALLBACK,f=s.ERR_STREAM_CANNOT_PIPE,p=s.ERR_STREAM_DESTROYED,_=s.ERR_STREAM_NULL_VALUES,T=s.ERR_STREAM_WRITE_AFTER_END,w=s.ERR_UNKNOWN_ENCODING,M=n.errorOrDestroy;t("inherits")(F,m);function A(){}function W(X,$,K){y=y||t("./_stream_duplex"),X=X||{},typeof K!="boolean"&&(K=$ instanceof y),this.objectMode=!!X.objectMode,K&&(this.objectMode=this.objectMode||!!X.writableObjectMode),this.highWaterMark=r(this,X,"writableHighWaterMark",K),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var re=X.decodeStrings===!1;this.decodeStrings=!re,this.defaultEncoding=X.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(ue){B($,ue)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=X.emitClose!==!1,this.autoDestroy=!!X.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new S(this)}W.prototype.getBuffer=function(){for(var $=this.bufferedRequest,K=[];$;)K.push($),$=$.next;return K},function(){try{Object.defineProperty(W.prototype,"buffer",{get:c.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch{}}();var ee;typeof Symbol=="function"&&Symbol.hasInstance&&typeof Function.prototype[Symbol.hasInstance]=="function"?(ee=Function.prototype[Symbol.hasInstance],Object.defineProperty(F,Symbol.hasInstance,{value:function($){return ee.call(this,$)?!0:this!==F?!1:$&&$._writableState instanceof W}})):ee=function($){return $ instanceof this};function F(X){y=y||t("./_stream_duplex");var $=this instanceof y;if(!$&&!ee.call(F,this))return new F(X);this._writableState=new W(X,this,$),this.writable=!0,X&&(typeof X.write=="function"&&(this._write=X.write),typeof X.writev=="function"&&(this._writev=X.writev),typeof X.destroy=="function"&&(this._destroy=X.destroy),typeof X.final=="function"&&(this._final=X.final)),m.call(this)}F.prototype.pipe=function(){M(this,new f)};function C(X,$){var K=new T;M(X,K),u.nextTick($,K)}function O(X,$,K,re){var ue;return K===null?ue=new _:typeof K!="string"&&!$.objectMode&&(ue=new o("chunk",["string","Buffer"],K)),ue?(M(X,ue),u.nextTick(re,ue),!1):!0}F.prototype.write=function(X,$,K){var re=this._writableState,ue=!1,H=!re.objectMode&&a(X);return H&&!h.isBuffer(X)&&(X=b(X)),typeof $=="function"&&(K=$,$=null),H?$="buffer":$||($=re.defaultEncoding),typeof K!="function"&&(K=A),re.ending?C(this,K):(H||O(this,re,X,K))&&(re.pendingcb++,ue=D(this,re,H,X,$,K)),ue},F.prototype.cork=function(){this._writableState.corked++},F.prototype.uncork=function(){var X=this._writableState;X.corked&&(X.corked--,!X.writing&&!X.corked&&!X.bufferProcessing&&X.bufferedRequest&&P(this,X))},F.prototype.setDefaultEncoding=function($){if(typeof $=="string"&&($=$.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf(($+"").toLowerCase())>-1))throw new w($);return this._writableState.defaultEncoding=$,this},Object.defineProperty(F.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}});function I(X,$,K){return!X.objectMode&&X.decodeStrings!==!1&&typeof $=="string"&&($=h.from($,K)),$}Object.defineProperty(F.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}});function D(X,$,K,re,ue,H){if(!K){var G=I($,re,ue);re!==G&&(K=!0,ue="buffer",re=G)}var U=$.objectMode?1:re.length;$.length+=U;var L=$.length<$.highWaterMark;if(L||($.needDrain=!0),$.writing||$.corked){var z=$.lastBufferedRequest;$.lastBufferedRequest={chunk:re,encoding:ue,isBuf:K,callback:H,next:null},z?z.next=$.lastBufferedRequest:$.bufferedRequest=$.lastBufferedRequest,$.bufferedRequestCount+=1}else j(X,$,!1,U,re,ue,H);return L}function j(X,$,K,re,ue,H,G){$.writelen=re,$.writecb=G,$.writing=!0,$.sync=!0,$.destroyed?$.onwrite(new p("write")):K?X._writev(ue,$.onwrite):X._write(ue,H,$.onwrite),$.sync=!1}function Y(X,$,K,re,ue){--$.pendingcb,K?(u.nextTick(ue,re),u.nextTick(te,X,$),X._writableState.errorEmitted=!0,M(X,re)):(ue(re),X._writableState.errorEmitted=!0,M(X,re),te(X,$))}function q(X){X.writing=!1,X.writecb=null,X.length-=X.writelen,X.writelen=0}function B(X,$){var K=X._writableState,re=K.sync,ue=K.writecb;if(typeof ue!="function")throw new v;if(q(K),$)Y(X,K,re,$,ue);else{var H=V(K)||X.destroyed;!H&&!K.corked&&!K.bufferProcessing&&K.bufferedRequest&&P(X,K),re?u.nextTick(R,X,K,H,ue):R(X,K,H,ue)}}function R(X,$,K,re){K||k(X,$),$.pendingcb--,re(),te(X,$)}function k(X,$){$.length===0&&$.needDrain&&($.needDrain=!1,X.emit("drain"))}function P(X,$){$.bufferProcessing=!0;var K=$.bufferedRequest;if(X._writev&&K&&K.next){var re=$.bufferedRequestCount,ue=new Array(re),H=$.corkedRequestsFree;H.entry=K;for(var G=0,U=!0;K;)ue[G]=K,K.isBuf||(U=!1),K=K.next,G+=1;ue.allBuffers=U,j(X,$,!0,$.length,ue,"",H.finish),$.pendingcb++,$.lastBufferedRequest=null,H.next?($.corkedRequestsFree=H.next,H.next=null):$.corkedRequestsFree=new S($),$.bufferedRequestCount=0}else{for(;K;){var L=K.chunk,z=K.encoding,J=K.callback,ne=$.objectMode?1:L.length;if(j(X,$,!1,ne,L,z,J),K=K.next,$.bufferedRequestCount--,$.writing)break}K===null&&($.lastBufferedRequest=null)}$.bufferedRequest=K,$.bufferProcessing=!1}F.prototype._write=function(X,$,K){K(new l("_write()"))},F.prototype._writev=null,F.prototype.end=function(X,$,K){var re=this._writableState;return typeof X=="function"?(K=X,X=null,$=null):typeof $=="function"&&(K=$,$=null),X!=null&&this.write(X,$),re.corked&&(re.corked=1,this.uncork()),re.ending||ae(this,re,K),this},Object.defineProperty(F.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function V(X){return X.ending&&X.length===0&&X.bufferedRequest===null&&!X.finished&&!X.writing}function x(X,$){X._final(function(K){$.pendingcb--,K&&M(X,K),$.prefinished=!0,X.emit("prefinish"),te(X,$)})}function Q(X,$){!$.prefinished&&!$.finalCalled&&(typeof X._final=="function"&&!$.destroyed?($.pendingcb++,$.finalCalled=!0,u.nextTick(x,X,$)):($.prefinished=!0,X.emit("prefinish")))}function te(X,$){var K=V($);if(K&&(Q(X,$),$.pendingcb===0&&($.finished=!0,X.emit("finish"),$.autoDestroy))){var re=X._readableState;(!re||re.autoDestroy&&re.endEmitted)&&X.destroy()}return K}function ae(X,$,K){$.ending=!0,te(X,$),K&&($.finished?u.nextTick(K):X.once("finish",K)),$.ended=!0,X.writable=!1}function de(X,$,K){var re=X.entry;for(X.entry=null;re;){var ue=re.callback;$.pendingcb--,ue(K),re=re.next}$.corkedRequestsFree.next=X}Object.defineProperty(F.prototype,"destroyed",{enumerable:!1,get:function(){return this._writableState===void 0?!1:this._writableState.destroyed},set:function($){this._writableState&&(this._writableState.destroyed=$)}}),F.prototype.destroy=n.destroy,F.prototype._undestroy=n.undestroy,F.prototype._destroy=function(X,$){$(X)}}).call(this)}).call(this,t("_process"),typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../errors":50,"./_stream_duplex":51,"./internal/streams/destroy":58,"./internal/streams/state":62,"./internal/streams/stream":63,_process:237,buffer:68,inherits:146,"util-deprecate":283}],56:[function(t,E,e){(function(u){(function(){var g;function S(p,_,T){return _ in p?Object.defineProperty(p,_,{value:T,enumerable:!0,configurable:!0,writable:!0}):p[_]=T,p}var y=t("./end-of-stream"),c=Symbol("lastResolve"),m=Symbol("lastReject"),h=Symbol("error"),d=Symbol("ended"),b=Symbol("lastPromise"),a=Symbol("handlePromise"),n=Symbol("stream");function i(p,_){return{value:p,done:_}}function r(p){var _=p[c];if(_!==null){var T=p[n].read();T!==null&&(p[b]=null,p[c]=null,p[m]=null,_(i(T,!1)))}}function s(p){u.nextTick(r,p)}function o(p,_){return function(T,w){p.then(function(){if(_[d]){T(i(void 0,!0));return}_[a](T,w)},w)}}var l=Object.getPrototypeOf(function(){}),v=Object.setPrototypeOf((g={get stream(){return this[n]},next:function(){var _=this,T=this[h];if(T!==null)return Promise.reject(T);if(this[d])return Promise.resolve(i(void 0,!0));if(this[n].destroyed)return new Promise(function(W,ee){u.nextTick(function(){_[h]?ee(_[h]):W(i(void 0,!0))})});var w=this[b],M;if(w)M=new Promise(o(w,this));else{var A=this[n].read();if(A!==null)return Promise.resolve(i(A,!1));M=new Promise(this[a])}return this[b]=M,M}},S(g,Symbol.asyncIterator,function(){return this}),S(g,"return",function(){var _=this;return new Promise(function(T,w){_[n].destroy(null,function(M){if(M){w(M);return}T(i(void 0,!0))})})}),g),l),f=function(_){var T,w=Object.create(v,(T={},S(T,n,{value:_,writable:!0}),S(T,c,{value:null,writable:!0}),S(T,m,{value:null,writable:!0}),S(T,h,{value:null,writable:!0}),S(T,d,{value:_._readableState.endEmitted,writable:!0}),S(T,a,{value:function(A,W){var ee=w[n].read();ee?(w[b]=null,w[c]=null,w[m]=null,A(i(ee,!1))):(w[c]=A,w[m]=W)},writable:!0}),T));return w[b]=null,y(_,function(M){if(M&&M.code!=="ERR_STREAM_PREMATURE_CLOSE"){var A=w[m];A!==null&&(w[b]=null,w[c]=null,w[m]=null,A(M)),w[h]=M;return}var W=w[c];W!==null&&(w[b]=null,w[c]=null,w[m]=null,W(i(void 0,!0))),w[d]=!0}),_.on("readable",s.bind(null,w)),w};E.exports=f}).call(this)}).call(this,t("_process"))},{"./end-of-stream":59,_process:237}],57:[function(t,E,e){function u(r,s){var o=Object.keys(r);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(r);s&&(l=l.filter(function(v){return Object.getOwnPropertyDescriptor(r,v).enumerable})),o.push.apply(o,l)}return o}function g(r){for(var s=1;s<arguments.length;s++){var o=arguments[s]!=null?arguments[s]:{};s%2?u(Object(o),!0).forEach(function(l){S(r,l,o[l])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(o)):u(Object(o)).forEach(function(l){Object.defineProperty(r,l,Object.getOwnPropertyDescriptor(o,l))})}return r}function S(r,s,o){return s in r?Object.defineProperty(r,s,{value:o,enumerable:!0,configurable:!0,writable:!0}):r[s]=o,r}function y(r,s){if(!(r instanceof s))throw new TypeError("Cannot call a class as a function")}function c(r,s){for(var o=0;o<s.length;o++){var l=s[o];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(r,l.key,l)}}function m(r,s,o){return s&&c(r.prototype,s),o&&c(r,o),r}var h=t("buffer"),d=h.Buffer,b=t("util"),a=b.inspect,n=a&&a.custom||"inspect";function i(r,s,o){d.prototype.copy.call(r,s,o)}E.exports=function(){function r(){y(this,r),this.head=null,this.tail=null,this.length=0}return m(r,[{key:"push",value:function(o){var l={data:o,next:null};this.length>0?this.tail.next=l:this.head=l,this.tail=l,++this.length}},{key:"unshift",value:function(o){var l={data:o,next:this.head};this.length===0&&(this.tail=l),this.head=l,++this.length}},{key:"shift",value:function(){if(this.length!==0){var o=this.head.data;return this.length===1?this.head=this.tail=null:this.head=this.head.next,--this.length,o}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(o){if(this.length===0)return"";for(var l=this.head,v=""+l.data;l=l.next;)v+=o+l.data;return v}},{key:"concat",value:function(o){if(this.length===0)return d.alloc(0);for(var l=d.allocUnsafe(o>>>0),v=this.head,f=0;v;)i(v.data,l,f),f+=v.data.length,v=v.next;return l}},{key:"consume",value:function(o,l){var v;return o<this.head.data.length?(v=this.head.data.slice(0,o),this.head.data=this.head.data.slice(o)):o===this.head.data.length?v=this.shift():v=l?this._getString(o):this._getBuffer(o),v}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(o){var l=this.head,v=1,f=l.data;for(o-=f.length;l=l.next;){var p=l.data,_=o>p.length?p.length:o;if(_===p.length?f+=p:f+=p.slice(0,o),o-=_,o===0){_===p.length?(++v,l.next?this.head=l.next:this.head=this.tail=null):(this.head=l,l.data=p.slice(_));break}++v}return this.length-=v,f}},{key:"_getBuffer",value:function(o){var l=d.allocUnsafe(o),v=this.head,f=1;for(v.data.copy(l),o-=v.data.length;v=v.next;){var p=v.data,_=o>p.length?p.length:o;if(p.copy(l,l.length-o,0,_),o-=_,o===0){_===p.length?(++f,v.next?this.head=v.next:this.head=this.tail=null):(this.head=v,v.data=p.slice(_));break}++f}return this.length-=f,l}},{key:n,value:function(o,l){return a(this,g({},l,{depth:0,customInspect:!1}))}}]),r}()},{buffer:68,util:20}],58:[function(t,E,e){(function(u){(function(){function g(d,b){var a=this,n=this._readableState&&this._readableState.destroyed,i=this._writableState&&this._writableState.destroyed;return n||i?(b?b(d):d&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,u.nextTick(m,this,d)):u.nextTick(m,this,d)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(d||null,function(r){!b&&r?a._writableState?a._writableState.errorEmitted?u.nextTick(y,a):(a._writableState.errorEmitted=!0,u.nextTick(S,a,r)):u.nextTick(S,a,r):b?(u.nextTick(y,a),b(r)):u.nextTick(y,a)}),this)}function S(d,b){m(d,b),y(d)}function y(d){d._writableState&&!d._writableState.emitClose||d._readableState&&!d._readableState.emitClose||d.emit("close")}function c(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function m(d,b){d.emit("error",b)}function h(d,b){var a=d._readableState,n=d._writableState;a&&a.autoDestroy||n&&n.autoDestroy?d.destroy(b):d.emit("error",b)}E.exports={destroy:g,undestroy:c,errorOrDestroy:h}}).call(this)}).call(this,t("_process"))},{_process:237}],59:[function(t,E,e){var u=t("../../../errors").codes.ERR_STREAM_PREMATURE_CLOSE;function g(m){var h=!1;return function(){if(!h){h=!0;for(var d=arguments.length,b=new Array(d),a=0;a<d;a++)b[a]=arguments[a];m.apply(this,b)}}}function S(){}function y(m){return m.setHeader&&typeof m.abort=="function"}function c(m,h,d){if(typeof h=="function")return c(m,null,h);h||(h={}),d=g(d||S);var b=h.readable||h.readable!==!1&&m.readable,a=h.writable||h.writable!==!1&&m.writable,n=function(){m.writable||r()},i=m._writableState&&m._writableState.finished,r=function(){a=!1,i=!0,b||d.call(m)},s=m._readableState&&m._readableState.endEmitted,o=function(){b=!1,s=!0,a||d.call(m)},l=function(_){d.call(m,_)},v=function(){var _;if(b&&!s)return(!m._readableState||!m._readableState.ended)&&(_=new u),d.call(m,_);if(a&&!i)return(!m._writableState||!m._writableState.ended)&&(_=new u),d.call(m,_)},f=function(){m.req.on("finish",r)};return y(m)?(m.on("complete",r),m.on("abort",v),m.req?f():m.on("request",f)):a&&!m._writableState&&(m.on("end",n),m.on("close",n)),m.on("end",o),m.on("finish",r),h.error!==!1&&m.on("error",l),m.on("close",v),function(){m.removeListener("complete",r),m.removeListener("abort",v),m.removeListener("request",f),m.req&&m.req.removeListener("finish",r),m.removeListener("end",n),m.removeListener("close",n),m.removeListener("finish",r),m.removeListener("end",o),m.removeListener("error",l),m.removeListener("close",v)}}E.exports=c},{"../../../errors":50}],60:[function(t,E,e){E.exports=function(){throw new Error("Readable.from is not available in the browser")}},{}],61:[function(t,E,e){var u;function g(r){var s=!1;return function(){s||(s=!0,r.apply(void 0,arguments))}}var S=t("../../../errors").codes,y=S.ERR_MISSING_ARGS,c=S.ERR_STREAM_DESTROYED;function m(r){if(r)throw r}function h(r){return r.setHeader&&typeof r.abort=="function"}function d(r,s,o,l){l=g(l);var v=!1;r.on("close",function(){v=!0}),u===void 0&&(u=t("./end-of-stream")),u(r,{readable:s,writable:o},function(p){if(p)return l(p);v=!0,l()});var f=!1;return function(p){if(!v&&!f){if(f=!0,h(r))return r.abort();if(typeof r.destroy=="function")return r.destroy();l(p||new c("pipe"))}}}function b(r){r()}function a(r,s){return r.pipe(s)}function n(r){return!r.length||typeof r[r.length-1]!="function"?m:r.pop()}function i(){for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];var l=n(s);if(Array.isArray(s[0])&&(s=s[0]),s.length<2)throw new y("streams");var v,f=s.map(function(p,_){var T=_<s.length-1,w=_>0;return d(p,T,w,function(M){v||(v=M),M&&f.forEach(b),!T&&(f.forEach(b),l(v))})});return s.reduce(a)}E.exports=i},{"../../../errors":50,"./end-of-stream":59}],62:[function(t,E,e){var u=t("../../../errors").codes.ERR_INVALID_OPT_VALUE;function g(y,c,m){return y.highWaterMark!=null?y.highWaterMark:c?y[m]:null}function S(y,c,m,h){var d=g(c,h,m);if(d!=null){if(!(isFinite(d)&&Math.floor(d)===d)||d<0){var b=h?m:"highWaterMark";throw new u(b,d)}return Math.floor(d)}return y.objectMode?16:16*1024}E.exports={getHighWaterMark:S}},{"../../../errors":50}],63:[function(t,E,e){E.exports=t("events").EventEmitter},{events:105}],64:[function(t,E,e){e=E.exports=t("./lib/_stream_readable.js"),e.Stream=e,e.Readable=e,e.Writable=t("./lib/_stream_writable.js"),e.Duplex=t("./lib/_stream_duplex.js"),e.Transform=t("./lib/_stream_transform.js"),e.PassThrough=t("./lib/_stream_passthrough.js"),e.finished=t("./lib/internal/streams/end-of-stream.js"),e.pipeline=t("./lib/internal/streams/pipeline.js")},{"./lib/_stream_duplex.js":51,"./lib/_stream_passthrough.js":52,"./lib/_stream_readable.js":53,"./lib/_stream_transform.js":54,"./lib/_stream_writable.js":55,"./lib/internal/streams/end-of-stream.js":59,"./lib/internal/streams/pipeline.js":61}],65:[function(t,E,e){const u=t("base-x"),g="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";E.exports=u(g)},{"base-x":66}],66:[function(t,E,e){function u(g){if(g.length>=255)throw new TypeError("Alphabet too long");for(var S=new Uint8Array(256),y=0;y<S.length;y++)S[y]=255;for(var c=0;c<g.length;c++){var m=g.charAt(c),h=m.charCodeAt(0);if(S[h]!==255)throw new TypeError(m+" is ambiguous");S[h]=c}var d=g.length,b=g.charAt(0),a=Math.log(d)/Math.log(256),n=Math.log(256)/Math.log(d);function i(o){if(o instanceof Uint8Array||(ArrayBuffer.isView(o)?o=new Uint8Array(o.buffer,o.byteOffset,o.byteLength):Array.isArray(o)&&(o=Uint8Array.from(o))),!(o instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(o.length===0)return"";for(var l=0,v=0,f=0,p=o.length;f!==p&&o[f]===0;)f++,l++;for(var _=(p-f)*n+1>>>0,T=new Uint8Array(_);f!==p;){for(var w=o[f],M=0,A=_-1;(w!==0||M<v)&&A!==-1;A--,M++)w+=256*T[A]>>>0,T[A]=w%d>>>0,w=w/d>>>0;if(w!==0)throw new Error("Non-zero carry");v=M,f++}for(var W=_-v;W!==_&&T[W]===0;)W++;for(var ee=b.repeat(l);W<_;++W)ee+=g.charAt(T[W]);return ee}function r(o){if(typeof o!="string")throw new TypeError("Expected String");if(o.length===0)return new Uint8Array;for(var l=0,v=0,f=0;o[l]===b;)v++,l++;for(var p=(o.length-l)*a+1>>>0,_=new Uint8Array(p);o[l];){var T=S[o.charCodeAt(l)];if(T===255)return;for(var w=0,M=p-1;(T!==0||w<f)&&M!==-1;M--,w++)T+=d*_[M]>>>0,_[M]=T%256>>>0,T=T/256>>>0;if(T!==0)throw new Error("Non-zero carry");f=w,l++}for(var A=p-f;A!==p&&_[A]===0;)A++;for(var W=new Uint8Array(v+(p-A)),ee=v;A!==p;)W[ee++]=_[A++];return W}function s(o){var l=r(o);if(l)return l;throw new Error("Non-base"+d+" character")}return{encode:i,decodeUnsafe:r,decode:s}}E.exports=u},{}],67:[function(t,E,e){(function(u){(function(){E.exports=function(S,y){for(var c=Math.min(S.length,y.length),m=new u(c),h=0;h<c;++h)m[h]=S[h]^y[h];return m}}).call(this)}).call(this,t("buffer").Buffer)},{buffer:68}],68:[function(t,E,e){(function(u){(function(){var g=t("base64-js"),S=t("ieee754");e.Buffer=h,e.SlowBuffer=v,e.INSPECT_MAX_BYTES=50;var y=2147483647;e.kMaxLength=y,h.TYPED_ARRAY_SUPPORT=c(),!h.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function c(){try{var U=new Uint8Array(1);return U.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},U.foo()===42}catch{return!1}}Object.defineProperty(h.prototype,"parent",{enumerable:!0,get:function(){if(h.isBuffer(this))return this.buffer}}),Object.defineProperty(h.prototype,"offset",{enumerable:!0,get:function(){if(h.isBuffer(this))return this.byteOffset}});function m(U){if(U>y)throw new RangeError('The value "'+U+'" is invalid for option "size"');var L=new Uint8Array(U);return L.__proto__=h.prototype,L}function h(U,L,z){if(typeof U=="number"){if(typeof L=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return n(U)}return d(U,L,z)}typeof Symbol<"u"&&Symbol.species!=null&&h[Symbol.species]===h&&Object.defineProperty(h,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),h.poolSize=8192;function d(U,L,z){if(typeof U=="string")return i(U,L);if(ArrayBuffer.isView(U))return r(U);if(U==null)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof U);if(H(U,ArrayBuffer)||U&&H(U.buffer,ArrayBuffer))return s(U,L,z);if(typeof U=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');var J=U.valueOf&&U.valueOf();if(J!=null&&J!==U)return h.from(J,L,z);var ne=o(U);if(ne)return ne;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof U[Symbol.toPrimitive]=="function")return h.from(U[Symbol.toPrimitive]("string"),L,z);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof U)}h.from=function(U,L,z){return d(U,L,z)},h.prototype.__proto__=Uint8Array.prototype,h.__proto__=Uint8Array;function b(U){if(typeof U!="number")throw new TypeError('"size" argument must be of type number');if(U<0)throw new RangeError('The value "'+U+'" is invalid for option "size"')}function a(U,L,z){return b(U),U<=0?m(U):L!==void 0?typeof z=="string"?m(U).fill(L,z):m(U).fill(L):m(U)}h.alloc=function(U,L,z){return a(U,L,z)};function n(U){return b(U),m(U<0?0:l(U)|0)}h.allocUnsafe=function(U){return n(U)},h.allocUnsafeSlow=function(U){return n(U)};function i(U,L){if((typeof L!="string"||L==="")&&(L="utf8"),!h.isEncoding(L))throw new TypeError("Unknown encoding: "+L);var z=f(U,L)|0,J=m(z),ne=J.write(U,L);return ne!==z&&(J=J.slice(0,ne)),J}function r(U){for(var L=U.length<0?0:l(U.length)|0,z=m(L),J=0;J<L;J+=1)z[J]=U[J]&255;return z}function s(U,L,z){if(L<0||U.byteLength<L)throw new RangeError('"offset" is outside of buffer bounds');if(U.byteLength<L+(z||0))throw new RangeError('"length" is outside of buffer bounds');var J;return L===void 0&&z===void 0?J=new Uint8Array(U):z===void 0?J=new Uint8Array(U,L):J=new Uint8Array(U,L,z),J.__proto__=h.prototype,J}function o(U){if(h.isBuffer(U)){var L=l(U.length)|0,z=m(L);return z.length===0||U.copy(z,0,0,L),z}if(U.length!==void 0)return typeof U.length!="number"||G(U.length)?m(0):r(U);if(U.type==="Buffer"&&Array.isArray(U.data))return r(U.data)}function l(U){if(U>=y)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+y.toString(16)+" bytes");return U|0}function v(U){return+U!=U&&(U=0),h.alloc(+U)}h.isBuffer=function(L){return L!=null&&L._isBuffer===!0&&L!==h.prototype},h.compare=function(L,z){if(H(L,Uint8Array)&&(L=h.from(L,L.offset,L.byteLength)),H(z,Uint8Array)&&(z=h.from(z,z.offset,z.byteLength)),!h.isBuffer(L)||!h.isBuffer(z))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(L===z)return 0;for(var J=L.length,ne=z.length,oe=0,ce=Math.min(J,ne);oe<ce;++oe)if(L[oe]!==z[oe]){J=L[oe],ne=z[oe];break}return J<ne?-1:ne<J?1:0},h.isEncoding=function(L){switch(String(L).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},h.concat=function(L,z){if(!Array.isArray(L))throw new TypeError('"list" argument must be an Array of Buffers');if(L.length===0)return h.alloc(0);var J;if(z===void 0)for(z=0,J=0;J<L.length;++J)z+=L[J].length;var ne=h.allocUnsafe(z),oe=0;for(J=0;J<L.length;++J){var ce=L[J];if(H(ce,Uint8Array)&&(ce=h.from(ce)),!h.isBuffer(ce))throw new TypeError('"list" argument must be an Array of Buffers');ce.copy(ne,oe),oe+=ce.length}return ne};function f(U,L){if(h.isBuffer(U))return U.length;if(ArrayBuffer.isView(U)||H(U,ArrayBuffer))return U.byteLength;if(typeof U!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof U);var z=U.length,J=arguments.length>2&&arguments[2]===!0;if(!J&&z===0)return 0;for(var ne=!1;;)switch(L){case"ascii":case"latin1":case"binary":return z;case"utf8":case"utf-8":return X(U).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return z*2;case"hex":return z>>>1;case"base64":return re(U).length;default:if(ne)return J?-1:X(U).length;L=(""+L).toLowerCase(),ne=!0}}h.byteLength=f;function p(U,L,z){var J=!1;if((L===void 0||L<0)&&(L=0),L>this.length||((z===void 0||z>this.length)&&(z=this.length),z<=0)||(z>>>=0,L>>>=0,z<=L))return"";for(U||(U="utf8");;)switch(U){case"hex":return B(this,L,z);case"utf8":case"utf-8":return I(this,L,z);case"ascii":return Y(this,L,z);case"latin1":case"binary":return q(this,L,z);case"base64":return O(this,L,z);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,L,z);default:if(J)throw new TypeError("Unknown encoding: "+U);U=(U+"").toLowerCase(),J=!0}}h.prototype._isBuffer=!0;function _(U,L,z){var J=U[L];U[L]=U[z],U[z]=J}h.prototype.swap16=function(){var L=this.length;if(L%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var z=0;z<L;z+=2)_(this,z,z+1);return this},h.prototype.swap32=function(){var L=this.length;if(L%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var z=0;z<L;z+=4)_(this,z,z+3),_(this,z+1,z+2);return this},h.prototype.swap64=function(){var L=this.length;if(L%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var z=0;z<L;z+=8)_(this,z,z+7),_(this,z+1,z+6),_(this,z+2,z+5),_(this,z+3,z+4);return this},h.prototype.toString=function(){var L=this.length;return L===0?"":arguments.length===0?I(this,0,L):p.apply(this,arguments)},h.prototype.toLocaleString=h.prototype.toString,h.prototype.equals=function(L){if(!h.isBuffer(L))throw new TypeError("Argument must be a Buffer");return this===L?!0:h.compare(this,L)===0},h.prototype.inspect=function(){var L="",z=e.INSPECT_MAX_BYTES;return L=this.toString("hex",0,z).replace(/(.{2})/g,"$1 ").trim(),this.length>z&&(L+=" ... "),"<Buffer "+L+">"},h.prototype.compare=function(L,z,J,ne,oe){if(H(L,Uint8Array)&&(L=h.from(L,L.offset,L.byteLength)),!h.isBuffer(L))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof L);if(z===void 0&&(z=0),J===void 0&&(J=L?L.length:0),ne===void 0&&(ne=0),oe===void 0&&(oe=this.length),z<0||J>L.length||ne<0||oe>this.length)throw new RangeError("out of range index");if(ne>=oe&&z>=J)return 0;if(ne>=oe)return-1;if(z>=J)return 1;if(z>>>=0,J>>>=0,ne>>>=0,oe>>>=0,this===L)return 0;for(var ce=oe-ne,pe=J-z,he=Math.min(ce,pe),fe=this.slice(ne,oe),ve=L.slice(z,J),ye=0;ye<he;++ye)if(fe[ye]!==ve[ye]){ce=fe[ye],pe=ve[ye];break}return ce<pe?-1:pe<ce?1:0};function T(U,L,z,J,ne){if(U.length===0)return-1;if(typeof z=="string"?(J=z,z=0):z>2147483647?z=2147483647:z<-2147483648&&(z=-2147483648),z=+z,G(z)&&(z=ne?0:U.length-1),z<0&&(z=U.length+z),z>=U.length){if(ne)return-1;z=U.length-1}else if(z<0)if(ne)z=0;else return-1;if(typeof L=="string"&&(L=h.from(L,J)),h.isBuffer(L))return L.length===0?-1:w(U,L,z,J,ne);if(typeof L=="number")return L=L&255,typeof Uint8Array.prototype.indexOf=="function"?ne?Uint8Array.prototype.indexOf.call(U,L,z):Uint8Array.prototype.lastIndexOf.call(U,L,z):w(U,[L],z,J,ne);throw new TypeError("val must be string, number or Buffer")}function w(U,L,z,J,ne){var oe=1,ce=U.length,pe=L.length;if(J!==void 0&&(J=String(J).toLowerCase(),J==="ucs2"||J==="ucs-2"||J==="utf16le"||J==="utf-16le")){if(U.length<2||L.length<2)return-1;oe=2,ce/=2,pe/=2,z/=2}function he(we,me){return oe===1?we[me]:we.readUInt16BE(me*oe)}var fe;if(ne){var ve=-1;for(fe=z;fe<ce;fe++)if(he(U,fe)===he(L,ve===-1?0:fe-ve)){if(ve===-1&&(ve=fe),fe-ve+1===pe)return ve*oe}else ve!==-1&&(fe-=fe-ve),ve=-1}else for(z+pe>ce&&(z=ce-pe),fe=z;fe>=0;fe--){for(var ye=!0,Ee=0;Ee<pe;Ee++)if(he(U,fe+Ee)!==he(L,Ee)){ye=!1;break}if(ye)return fe}return-1}h.prototype.includes=function(L,z,J){return this.indexOf(L,z,J)!==-1},h.prototype.indexOf=function(L,z,J){return T(this,L,z,J,!0)},h.prototype.lastIndexOf=function(L,z,J){return T(this,L,z,J,!1)};function M(U,L,z,J){z=Number(z)||0;var ne=U.length-z;J?(J=Number(J),J>ne&&(J=ne)):J=ne;var oe=L.length;J>oe/2&&(J=oe/2);for(var ce=0;ce<J;++ce){var pe=parseInt(L.substr(ce*2,2),16);if(G(pe))return ce;U[z+ce]=pe}return ce}function A(U,L,z,J){return ue(X(L,U.length-z),U,z,J)}function W(U,L,z,J){return ue($(L),U,z,J)}function ee(U,L,z,J){return W(U,L,z,J)}function F(U,L,z,J){return ue(re(L),U,z,J)}function C(U,L,z,J){return ue(K(L,U.length-z),U,z,J)}h.prototype.write=function(L,z,J,ne){if(z===void 0)ne="utf8",J=this.length,z=0;else if(J===void 0&&typeof z=="string")ne=z,J=this.length,z=0;else if(isFinite(z))z=z>>>0,isFinite(J)?(J=J>>>0,ne===void 0&&(ne="utf8")):(ne=J,J=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");var oe=this.length-z;if((J===void 0||J>oe)&&(J=oe),L.length>0&&(J<0||z<0)||z>this.length)throw new RangeError("Attempt to write outside buffer bounds");ne||(ne="utf8");for(var ce=!1;;)switch(ne){case"hex":return M(this,L,z,J);case"utf8":case"utf-8":return A(this,L,z,J);case"ascii":return W(this,L,z,J);case"latin1":case"binary":return ee(this,L,z,J);case"base64":return F(this,L,z,J);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,L,z,J);default:if(ce)throw new TypeError("Unknown encoding: "+ne);ne=(""+ne).toLowerCase(),ce=!0}},h.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function O(U,L,z){return L===0&&z===U.length?g.fromByteArray(U):g.fromByteArray(U.slice(L,z))}function I(U,L,z){z=Math.min(U.length,z);for(var J=[],ne=L;ne<z;){var oe=U[ne],ce=null,pe=oe>239?4:oe>223?3:oe>191?2:1;if(ne+pe<=z){var he,fe,ve,ye;switch(pe){case 1:oe<128&&(ce=oe);break;case 2:he=U[ne+1],(he&192)===128&&(ye=(oe&31)<<6|he&63,ye>127&&(ce=ye));break;case 3:he=U[ne+1],fe=U[ne+2],(he&192)===128&&(fe&192)===128&&(ye=(oe&15)<<12|(he&63)<<6|fe&63,ye>2047&&(ye<55296||ye>57343)&&(ce=ye));break;case 4:he=U[ne+1],fe=U[ne+2],ve=U[ne+3],(he&192)===128&&(fe&192)===128&&(ve&192)===128&&(ye=(oe&15)<<18|(he&63)<<12|(fe&63)<<6|ve&63,ye>65535&&ye<1114112&&(ce=ye))}}ce===null?(ce=65533,pe=1):ce>65535&&(ce-=65536,J.push(ce>>>10&1023|55296),ce=56320|ce&1023),J.push(ce),ne+=pe}return j(J)}var D=4096;function j(U){var L=U.length;if(L<=D)return String.fromCharCode.apply(String,U);for(var z="",J=0;J<L;)z+=String.fromCharCode.apply(String,U.slice(J,J+=D));return z}function Y(U,L,z){var J="";z=Math.min(U.length,z);for(var ne=L;ne<z;++ne)J+=String.fromCharCode(U[ne]&127);return J}function q(U,L,z){var J="";z=Math.min(U.length,z);for(var ne=L;ne<z;++ne)J+=String.fromCharCode(U[ne]);return J}function B(U,L,z){var J=U.length;(!L||L<0)&&(L=0),(!z||z<0||z>J)&&(z=J);for(var ne="",oe=L;oe<z;++oe)ne+=de(U[oe]);return ne}function R(U,L,z){for(var J=U.slice(L,z),ne="",oe=0;oe<J.length;oe+=2)ne+=String.fromCharCode(J[oe]+J[oe+1]*256);return ne}h.prototype.slice=function(L,z){var J=this.length;L=~~L,z=z===void 0?J:~~z,L<0?(L+=J,L<0&&(L=0)):L>J&&(L=J),z<0?(z+=J,z<0&&(z=0)):z>J&&(z=J),z<L&&(z=L);var ne=this.subarray(L,z);return ne.__proto__=h.prototype,ne};function k(U,L,z){if(U%1!==0||U<0)throw new RangeError("offset is not uint");if(U+L>z)throw new RangeError("Trying to access beyond buffer length")}h.prototype.readUIntLE=function(L,z,J){L=L>>>0,z=z>>>0,J||k(L,z,this.length);for(var ne=this[L],oe=1,ce=0;++ce<z&&(oe*=256);)ne+=this[L+ce]*oe;return ne},h.prototype.readUIntBE=function(L,z,J){L=L>>>0,z=z>>>0,J||k(L,z,this.length);for(var ne=this[L+--z],oe=1;z>0&&(oe*=256);)ne+=this[L+--z]*oe;return ne},h.prototype.readUInt8=function(L,z){return L=L>>>0,z||k(L,1,this.length),this[L]},h.prototype.readUInt16LE=function(L,z){return L=L>>>0,z||k(L,2,this.length),this[L]|this[L+1]<<8},h.prototype.readUInt16BE=function(L,z){return L=L>>>0,z||k(L,2,this.length),this[L]<<8|this[L+1]},h.prototype.readUInt32LE=function(L,z){return L=L>>>0,z||k(L,4,this.length),(this[L]|this[L+1]<<8|this[L+2]<<16)+this[L+3]*16777216},h.prototype.readUInt32BE=function(L,z){return L=L>>>0,z||k(L,4,this.length),this[L]*16777216+(this[L+1]<<16|this[L+2]<<8|this[L+3])},h.prototype.readIntLE=function(L,z,J){L=L>>>0,z=z>>>0,J||k(L,z,this.length);for(var ne=this[L],oe=1,ce=0;++ce<z&&(oe*=256);)ne+=this[L+ce]*oe;return oe*=128,ne>=oe&&(ne-=Math.pow(2,8*z)),ne},h.prototype.readIntBE=function(L,z,J){L=L>>>0,z=z>>>0,J||k(L,z,this.length);for(var ne=z,oe=1,ce=this[L+--ne];ne>0&&(oe*=256);)ce+=this[L+--ne]*oe;return oe*=128,ce>=oe&&(ce-=Math.pow(2,8*z)),ce},h.prototype.readInt8=function(L,z){return L=L>>>0,z||k(L,1,this.length),this[L]&128?(255-this[L]+1)*-1:this[L]},h.prototype.readInt16LE=function(L,z){L=L>>>0,z||k(L,2,this.length);var J=this[L]|this[L+1]<<8;return J&32768?J|4294901760:J},h.prototype.readInt16BE=function(L,z){L=L>>>0,z||k(L,2,this.length);var J=this[L+1]|this[L]<<8;return J&32768?J|4294901760:J},h.prototype.readInt32LE=function(L,z){return L=L>>>0,z||k(L,4,this.length),this[L]|this[L+1]<<8|this[L+2]<<16|this[L+3]<<24},h.prototype.readInt32BE=function(L,z){return L=L>>>0,z||k(L,4,this.length),this[L]<<24|this[L+1]<<16|this[L+2]<<8|this[L+3]},h.prototype.readFloatLE=function(L,z){return L=L>>>0,z||k(L,4,this.length),S.read(this,L,!0,23,4)},h.prototype.readFloatBE=function(L,z){return L=L>>>0,z||k(L,4,this.length),S.read(this,L,!1,23,4)},h.prototype.readDoubleLE=function(L,z){return L=L>>>0,z||k(L,8,this.length),S.read(this,L,!0,52,8)},h.prototype.readDoubleBE=function(L,z){return L=L>>>0,z||k(L,8,this.length),S.read(this,L,!1,52,8)};function P(U,L,z,J,ne,oe){if(!h.isBuffer(U))throw new TypeError('"buffer" argument must be a Buffer instance');if(L>ne||L<oe)throw new RangeError('"value" argument is out of bounds');if(z+J>U.length)throw new RangeError("Index out of range")}h.prototype.writeUIntLE=function(L,z,J,ne){if(L=+L,z=z>>>0,J=J>>>0,!ne){var oe=Math.pow(2,8*J)-1;P(this,L,z,J,oe,0)}var ce=1,pe=0;for(this[z]=L&255;++pe<J&&(ce*=256);)this[z+pe]=L/ce&255;return z+J},h.prototype.writeUIntBE=function(L,z,J,ne){if(L=+L,z=z>>>0,J=J>>>0,!ne){var oe=Math.pow(2,8*J)-1;P(this,L,z,J,oe,0)}var ce=J-1,pe=1;for(this[z+ce]=L&255;--ce>=0&&(pe*=256);)this[z+ce]=L/pe&255;return z+J},h.prototype.writeUInt8=function(L,z,J){return L=+L,z=z>>>0,J||P(this,L,z,1,255,0),this[z]=L&255,z+1},h.prototype.writeUInt16LE=function(L,z,J){return L=+L,z=z>>>0,J||P(this,L,z,2,65535,0),this[z]=L&255,this[z+1]=L>>>8,z+2},h.prototype.writeUInt16BE=function(L,z,J){return L=+L,z=z>>>0,J||P(this,L,z,2,65535,0),this[z]=L>>>8,this[z+1]=L&255,z+2},h.prototype.writeUInt32LE=function(L,z,J){return L=+L,z=z>>>0,J||P(this,L,z,4,4294967295,0),this[z+3]=L>>>24,this[z+2]=L>>>16,this[z+1]=L>>>8,this[z]=L&255,z+4},h.prototype.writeUInt32BE=function(L,z,J){return L=+L,z=z>>>0,J||P(this,L,z,4,4294967295,0),this[z]=L>>>24,this[z+1]=L>>>16,this[z+2]=L>>>8,this[z+3]=L&255,z+4},h.prototype.writeIntLE=function(L,z,J,ne){if(L=+L,z=z>>>0,!ne){var oe=Math.pow(2,8*J-1);P(this,L,z,J,oe-1,-oe)}var ce=0,pe=1,he=0;for(this[z]=L&255;++ce<J&&(pe*=256);)L<0&&he===0&&this[z+ce-1]!==0&&(he=1),this[z+ce]=(L/pe>>0)-he&255;return z+J},h.prototype.writeIntBE=function(L,z,J,ne){if(L=+L,z=z>>>0,!ne){var oe=Math.pow(2,8*J-1);P(this,L,z,J,oe-1,-oe)}var ce=J-1,pe=1,he=0;for(this[z+ce]=L&255;--ce>=0&&(pe*=256);)L<0&&he===0&&this[z+ce+1]!==0&&(he=1),this[z+ce]=(L/pe>>0)-he&255;return z+J},h.prototype.writeInt8=function(L,z,J){return L=+L,z=z>>>0,J||P(this,L,z,1,127,-128),L<0&&(L=255+L+1),this[z]=L&255,z+1},h.prototype.writeInt16LE=function(L,z,J){return L=+L,z=z>>>0,J||P(this,L,z,2,32767,-32768),this[z]=L&255,this[z+1]=L>>>8,z+2},h.prototype.writeInt16BE=function(L,z,J){return L=+L,z=z>>>0,J||P(this,L,z,2,32767,-32768),this[z]=L>>>8,this[z+1]=L&255,z+2},h.prototype.writeInt32LE=function(L,z,J){return L=+L,z=z>>>0,J||P(this,L,z,4,2147483647,-2147483648),this[z]=L&255,this[z+1]=L>>>8,this[z+2]=L>>>16,this[z+3]=L>>>24,z+4},h.prototype.writeInt32BE=function(L,z,J){return L=+L,z=z>>>0,J||P(this,L,z,4,2147483647,-2147483648),L<0&&(L=4294967295+L+1),this[z]=L>>>24,this[z+1]=L>>>16,this[z+2]=L>>>8,this[z+3]=L&255,z+4};function V(U,L,z,J,ne,oe){if(z+J>U.length)throw new RangeError("Index out of range");if(z<0)throw new RangeError("Index out of range")}function x(U,L,z,J,ne){return L=+L,z=z>>>0,ne||V(U,L,z,4),S.write(U,L,z,J,23,4),z+4}h.prototype.writeFloatLE=function(L,z,J){return x(this,L,z,!0,J)},h.prototype.writeFloatBE=function(L,z,J){return x(this,L,z,!1,J)};function Q(U,L,z,J,ne){return L=+L,z=z>>>0,ne||V(U,L,z,8),S.write(U,L,z,J,52,8),z+8}h.prototype.writeDoubleLE=function(L,z,J){return Q(this,L,z,!0,J)},h.prototype.writeDoubleBE=function(L,z,J){return Q(this,L,z,!1,J)},h.prototype.copy=function(L,z,J,ne){if(!h.isBuffer(L))throw new TypeError("argument should be a Buffer");if(J||(J=0),!ne&&ne!==0&&(ne=this.length),z>=L.length&&(z=L.length),z||(z=0),ne>0&&ne<J&&(ne=J),ne===J||L.length===0||this.length===0)return 0;if(z<0)throw new RangeError("targetStart out of bounds");if(J<0||J>=this.length)throw new RangeError("Index out of range");if(ne<0)throw new RangeError("sourceEnd out of bounds");ne>this.length&&(ne=this.length),L.length-z<ne-J&&(ne=L.length-z+J);var oe=ne-J;if(this===L&&typeof Uint8Array.prototype.copyWithin=="function")this.copyWithin(z,J,ne);else if(this===L&&J<z&&z<ne)for(var ce=oe-1;ce>=0;--ce)L[ce+z]=this[ce+J];else Uint8Array.prototype.set.call(L,this.subarray(J,ne),z);return oe},h.prototype.fill=function(L,z,J,ne){if(typeof L=="string"){if(typeof z=="string"?(ne=z,z=0,J=this.length):typeof J=="string"&&(ne=J,J=this.length),ne!==void 0&&typeof ne!="string")throw new TypeError("encoding must be a string");if(typeof ne=="string"&&!h.isEncoding(ne))throw new TypeError("Unknown encoding: "+ne);if(L.length===1){var oe=L.charCodeAt(0);(ne==="utf8"&&oe<128||ne==="latin1")&&(L=oe)}}else typeof L=="number"&&(L=L&255);if(z<0||this.length<z||this.length<J)throw new RangeError("Out of range index");if(J<=z)return this;z=z>>>0,J=J===void 0?this.length:J>>>0,L||(L=0);var ce;if(typeof L=="number")for(ce=z;ce<J;++ce)this[ce]=L;else{var pe=h.isBuffer(L)?L:h.from(L,ne),he=pe.length;if(he===0)throw new TypeError('The value "'+L+'" is invalid for argument "value"');for(ce=0;ce<J-z;++ce)this[ce+z]=pe[ce%he]}return this};var te=/[^+/0-9A-Za-z-_]/g;function ae(U){if(U=U.split("=")[0],U=U.trim().replace(te,""),U.length<2)return"";for(;U.length%4!==0;)U=U+"=";return U}function de(U){return U<16?"0"+U.toString(16):U.toString(16)}function X(U,L){L=L||1/0;for(var z,J=U.length,ne=null,oe=[],ce=0;ce<J;++ce){if(z=U.charCodeAt(ce),z>55295&&z<57344){if(!ne){if(z>56319){(L-=3)>-1&&oe.push(239,191,189);continue}else if(ce+1===J){(L-=3)>-1&&oe.push(239,191,189);continue}ne=z;continue}if(z<56320){(L-=3)>-1&&oe.push(239,191,189),ne=z;continue}z=(ne-55296<<10|z-56320)+65536}else ne&&(L-=3)>-1&&oe.push(239,191,189);if(ne=null,z<128){if((L-=1)<0)break;oe.push(z)}else if(z<2048){if((L-=2)<0)break;oe.push(z>>6|192,z&63|128)}else if(z<65536){if((L-=3)<0)break;oe.push(z>>12|224,z>>6&63|128,z&63|128)}else if(z<1114112){if((L-=4)<0)break;oe.push(z>>18|240,z>>12&63|128,z>>6&63|128,z&63|128)}else throw new Error("Invalid code point")}return oe}function $(U){for(var L=[],z=0;z<U.length;++z)L.push(U.charCodeAt(z)&255);return L}function K(U,L){for(var z,J,ne,oe=[],ce=0;ce<U.length&&!((L-=2)<0);++ce)z=U.charCodeAt(ce),J=z>>8,ne=z%256,oe.push(ne),oe.push(J);return oe}function re(U){return g.toByteArray(ae(U))}function ue(U,L,z,J){for(var ne=0;ne<J&&!(ne+z>=L.length||ne>=U.length);++ne)L[ne+z]=U[ne];return ne}function H(U,L){return U instanceof L||U!=null&&U.constructor!=null&&U.constructor.name!=null&&U.constructor.name===L.name}function G(U){return U!==U}}).call(this)}).call(this,t("buffer").Buffer)},{"base64-js":17,buffer:68,ieee754:145}],69:[function(t,E,e){var u=t("get-intrinsic"),g=t("./"),S=g(u("String.prototype.indexOf"));E.exports=function(c,m){var h=u(c,!!m);return typeof h=="function"&&S(c,".prototype.")>-1?g(h):h}},{"./":70,"get-intrinsic":110}],70:[function(t,E,e){var u=t("function-bind"),g=t("get-intrinsic"),S=g("%Function.prototype.apply%"),y=g("%Function.prototype.call%"),c=g("%Reflect.apply%",!0)||u.call(y,S),m=g("%Object.getOwnPropertyDescriptor%",!0),h=g("%Object.defineProperty%",!0),d=g("%Math.max%");if(h)try{h({},"a",{value:1})}catch{h=null}E.exports=function(n){var i=c(u,y,arguments);if(m&&h){var r=m(i,"length");r.configurable&&h(i,"length",{value:1+d(0,n.length-(arguments.length-1))})}return i};var b=function(){return c(u,S,arguments)};h?h(E.exports,"apply",{value:b}):E.exports.apply=b},{"function-bind":109,"get-intrinsic":110}],71:[function(t,E,e){var u=t("safe-buffer").Buffer,g=t("stream").Transform,S=t("string_decoder").StringDecoder,y=t("inherits");function c(m){g.call(this),this.hashMode=typeof m=="string",this.hashMode?this[m]=this._finalOrDigest:this.final=this._finalOrDigest,this._final&&(this.__final=this._final,this._final=null),this._decoder=null,this._encoding=null}y(c,g),c.prototype.update=function(m,h,d){typeof m=="string"&&(m=u.from(m,h));var b=this._update(m);return this.hashMode?this:(d&&(b=this._toString(b,d)),b)},c.prototype.setAutoPadding=function(){},c.prototype.getAuthTag=function(){throw new Error("trying to get auth tag in unsupported state")},c.prototype.setAuthTag=function(){throw new Error("trying to set auth tag in unsupported state")},c.prototype.setAAD=function(){throw new Error("trying to set aad in unsupported state")},c.prototype._transform=function(m,h,d){var b;try{this.hashMode?this._update(m):this.push(this._update(m))}catch(a){b=a}finally{d(b)}},c.prototype._flush=function(m){var h;try{this.push(this.__final())}catch(d){h=d}m(h)},c.prototype._finalOrDigest=function(m){var h=this.__final()||u.alloc(0);return m&&(h=this._toString(h,m,!0)),h},c.prototype._toString=function(m,h,d){if(this._decoder||(this._decoder=new S(h),this._encoding=h),this._encoding!==h)throw new Error("can't switch encodings");var b=this._decoder.write(m);return d&&(b+=this._decoder.end()),b},E.exports=c},{inherits:146,"safe-buffer":250,stream:264,string_decoder:279}],72:[function(t,E,e){var u=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,g=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,S=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,y=/\\([\u000b\u0020-\u00ff])/g,c=/([\\"])/g,m=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;e.format=h,e.parse=d;function h(i){if(!i||typeof i!="object")throw new TypeError("argument obj is required");var r=i.parameters,s=i.type;if(!s||!m.test(s))throw new TypeError("invalid type");var o=s;if(r&&typeof r=="object")for(var l,v=Object.keys(r).sort(),f=0;f<v.length;f++){if(l=v[f],!S.test(l))throw new TypeError("invalid parameter name");o+="; "+l+"="+a(r[l])}return o}function d(i){if(!i)throw new TypeError("argument string is required");var r=typeof i=="object"?b(i):i;if(typeof r!="string")throw new TypeError("argument string is required to be a string");var s=r.indexOf(";"),o=s!==-1?r.slice(0,s).trim():r.trim();if(!m.test(o))throw new TypeError("invalid media type");var l=new n(o.toLowerCase());if(s!==-1){var v,f,p;for(u.lastIndex=s;f=u.exec(r);){if(f.index!==s)throw new TypeError("invalid parameter format");s+=f[0].length,v=f[1].toLowerCase(),p=f[2],p.charCodeAt(0)===34&&(p=p.slice(1,-1),p.indexOf("\\")!==-1&&(p=p.replace(y,"$1"))),l.parameters[v]=p}if(s!==r.length)throw new TypeError("invalid parameter format")}return l}function b(i){var r;if(typeof i.getHeader=="function"?r=i.getHeader("content-type"):typeof i.headers=="object"&&(r=i.headers&&i.headers["content-type"]),typeof r!="string")throw new TypeError("content-type header is missing from object");return r}function a(i){var r=String(i);if(S.test(r))return r;if(r.length>0&&!g.test(r))throw new TypeError("invalid parameter value");return'"'+r.replace(c,"\\$1")+'"'}function n(i){this.parameters=Object.create(null),this.type=i}},{}],73:[function(t,E,e){(function(u){(function(){var g=t("elliptic"),S=t("bn.js");E.exports=function(d){return new c(d)};var y={secp256k1:{name:"secp256k1",byteLength:32},secp224r1:{name:"p224",byteLength:28},prime256v1:{name:"p256",byteLength:32},prime192v1:{name:"p192",byteLength:24},ed25519:{name:"ed25519",byteLength:32},secp384r1:{name:"p384",byteLength:48},secp521r1:{name:"p521",byteLength:66}};y.p224=y.secp224r1,y.p256=y.secp256r1=y.prime256v1,y.p192=y.secp192r1=y.prime192v1,y.p384=y.secp384r1,y.p521=y.secp521r1;function c(h){this.curveType=y[h],this.curveType||(this.curveType={name:h}),this.curve=new g.ec(this.curveType.name),this.keys=void 0}c.prototype.generateKeys=function(h,d){return this.keys=this.curve.genKeyPair(),this.getPublicKey(h,d)},c.prototype.computeSecret=function(h,d,b){d=d||"utf8",u.isBuffer(h)||(h=new u(h,d));var a=this.curve.keyFromPublic(h).getPublic(),n=a.mul(this.keys.getPrivate()).getX();return m(n,b,this.curveType.byteLength)},c.prototype.getPublicKey=function(h,d){var b=this.keys.getPublic(d==="compressed",!0);return d==="hybrid"&&(b[b.length-1]%2?b[0]=7:b[0]=6),m(b,h)},c.prototype.getPrivateKey=function(h){return m(this.keys.getPrivate(),h)},c.prototype.setPublicKey=function(h,d){return d=d||"utf8",u.isBuffer(h)||(h=new u(h,d)),this.keys._importPublic(h),this},c.prototype.setPrivateKey=function(h,d){d=d||"utf8",u.isBuffer(h)||(h=new u(h,d));var b=new S(h);return b=b.toString(16),this.keys=this.curve.genKeyPair(),this.keys._importPrivate(b),this};function m(h,d,b){Array.isArray(h)||(h=h.toArray());var a=new u(h);if(b&&a.length<b){var n=new u(b-a.length);n.fill(0),a=u.concat([n,a])}return d?a.toString(d):a}}).call(this)}).call(this,t("buffer").Buffer)},{"bn.js":18,buffer:68,elliptic:89}],74:[function(t,E,e){var u=t("inherits"),g=t("md5.js"),S=t("ripemd160"),y=t("sha.js"),c=t("cipher-base");function m(h){c.call(this,"digest"),this._hash=h}u(m,c),m.prototype._update=function(h){this._hash.update(h)},m.prototype._final=function(){return this._hash.digest()},E.exports=function(d){return d=d.toLowerCase(),d==="md5"?new g:d==="rmd160"||d==="ripemd160"?new S:new m(y(d))}},{"cipher-base":71,inherits:146,"md5.js":221,ripemd160:249,"sha.js":257}],75:[function(t,E,e){var u=t("md5.js");E.exports=function(g){return new u().update(g).digest()}},{"md5.js":221}],76:[function(t,E,e){var u=t("inherits"),g=t("./legacy"),S=t("cipher-base"),y=t("safe-buffer").Buffer,c=t("create-hash/md5"),m=t("ripemd160"),h=t("sha.js"),d=y.alloc(128);function b(a,n){S.call(this,"digest"),typeof n=="string"&&(n=y.from(n));var i=a==="sha512"||a==="sha384"?128:64;if(this._alg=a,this._key=n,n.length>i){var r=a==="rmd160"?new m:h(a);n=r.update(n).digest()}else n.length<i&&(n=y.concat([n,d],i));for(var s=this._ipad=y.allocUnsafe(i),o=this._opad=y.allocUnsafe(i),l=0;l<i;l++)s[l]=n[l]^54,o[l]=n[l]^92;this._hash=a==="rmd160"?new m:h(a),this._hash.update(s)}u(b,S),b.prototype._update=function(a){this._hash.update(a)},b.prototype._final=function(){var a=this._hash.digest(),n=this._alg==="rmd160"?new m:h(this._alg);return n.update(this._opad).update(a).digest()},E.exports=function(n,i){return n=n.toLowerCase(),n==="rmd160"||n==="ripemd160"?new b("rmd160",i):n==="md5"?new g(c,i):new b(n,i)}},{"./legacy":77,"cipher-base":71,"create-hash/md5":75,inherits:146,ripemd160:249,"safe-buffer":250,"sha.js":257}],77:[function(t,E,e){var u=t("inherits"),g=t("safe-buffer").Buffer,S=t("cipher-base"),y=g.alloc(128),c=64;function m(h,d){S.call(this,"digest"),typeof d=="string"&&(d=g.from(d)),this._alg=h,this._key=d,d.length>c?d=h(d):d.length<c&&(d=g.concat([d,y],c));for(var b=this._ipad=g.allocUnsafe(c),a=this._opad=g.allocUnsafe(c),n=0;n<c;n++)b[n]=d[n]^54,a[n]=d[n]^92;this._hash=[b]}u(m,S),m.prototype._update=function(h){this._hash.push(h)},m.prototype._final=function(){var h=this._alg(g.concat(this._hash));return this._alg(g.concat([this._opad,h]))},E.exports=m},{"cipher-base":71,inherits:146,"safe-buffer":250}],78:[function(t,E,e){e.randomBytes=e.rng=e.pseudoRandomBytes=e.prng=t("randombytes"),e.createHash=e.Hash=t("create-hash"),e.createHmac=e.Hmac=t("create-hmac");var u=t("browserify-sign/algos"),g=Object.keys(u),S=["sha1","sha224","sha256","sha384","sha512","md5","rmd160"].concat(g);e.getHashes=function(){return S};var y=t("pbkdf2");e.pbkdf2=y.pbkdf2,e.pbkdf2Sync=y.pbkdf2Sync;var c=t("browserify-cipher");e.Cipher=c.Cipher,e.createCipher=c.createCipher,e.Cipheriv=c.Cipheriv,e.createCipheriv=c.createCipheriv,e.Decipher=c.Decipher,e.createDecipher=c.createDecipher,e.Decipheriv=c.Decipheriv,e.createDecipheriv=c.createDecipheriv,e.getCiphers=c.getCiphers,e.listCiphers=c.listCiphers;var m=t("diffie-hellman");e.DiffieHellmanGroup=m.DiffieHellmanGroup,e.createDiffieHellmanGroup=m.createDiffieHellmanGroup,e.getDiffieHellman=m.getDiffieHellman,e.createDiffieHellman=m.createDiffieHellman,e.DiffieHellman=m.DiffieHellman;var h=t("browserify-sign");e.createSign=h.createSign,e.Sign=h.Sign,e.createVerify=h.createVerify,e.Verify=h.Verify,e.createECDH=t("create-ecdh");var d=t("public-encrypt");e.publicEncrypt=d.publicEncrypt,e.privateEncrypt=d.privateEncrypt,e.publicDecrypt=d.publicDecrypt,e.privateDecrypt=d.privateDecrypt;var b=t("randomfill");e.randomFill=b.randomFill,e.randomFillSync=b.randomFillSync,e.createCredentials=function(){throw new Error(["sorry, createCredentials is not implemented yet","we accept pull requests","https://github.com/crypto-browserify/crypto-browserify"].join(`
`))},e.constants={DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,NPN_ENABLED:1,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_SSLV23_PADDING:2,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6}},{"browserify-cipher":38,"browserify-sign":46,"browserify-sign/algos":43,"create-ecdh":73,"create-hash":74,"create-hmac":76,"diffie-hellman":85,pbkdf2:231,"public-encrypt":238,randombytes:244,randomfill:245}],79:[function(t,E,e){e.utils=t("./des/utils"),e.Cipher=t("./des/cipher"),e.DES=t("./des/des"),e.CBC=t("./des/cbc"),e.EDE=t("./des/ede")},{"./des/cbc":80,"./des/cipher":81,"./des/des":82,"./des/ede":83,"./des/utils":84}],80:[function(t,E,e){var u=t("minimalistic-assert"),g=t("inherits"),S={};function y(m){u.equal(m.length,8,"Invalid IV length"),this.iv=new Array(8);for(var h=0;h<this.iv.length;h++)this.iv[h]=m[h]}function c(m){function h(n){m.call(this,n),this._cbcInit()}g(h,m);for(var d=Object.keys(S),b=0;b<d.length;b++){var a=d[b];h.prototype[a]=S[a]}return h.create=function(i){return new h(i)},h}e.instantiate=c,S._cbcInit=function(){var h=new y(this.options.iv);this._cbcState=h},S._update=function(h,d,b,a){var n=this._cbcState,i=this.constructor.super_.prototype,r=n.iv;if(this.type==="encrypt"){for(var s=0;s<this.blockSize;s++)r[s]^=h[d+s];i._update.call(this,r,0,b,a);for(var s=0;s<this.blockSize;s++)r[s]=b[a+s]}else{i._update.call(this,h,d,b,a);for(var s=0;s<this.blockSize;s++)b[a+s]^=r[s];for(var s=0;s<this.blockSize;s++)r[s]=h[d+s]}}},{inherits:146,"minimalistic-assert":223}],81:[function(t,E,e){var u=t("minimalistic-assert");function g(S){this.options=S,this.type=this.options.type,this.blockSize=8,this._init(),this.buffer=new Array(this.blockSize),this.bufferOff=0}E.exports=g,g.prototype._init=function(){},g.prototype.update=function(y){return y.length===0?[]:this.type==="decrypt"?this._updateDecrypt(y):this._updateEncrypt(y)},g.prototype._buffer=function(y,c){for(var m=Math.min(this.buffer.length-this.bufferOff,y.length-c),h=0;h<m;h++)this.buffer[this.bufferOff+h]=y[c+h];return this.bufferOff+=m,m},g.prototype._flushBuffer=function(y,c){return this._update(this.buffer,0,y,c),this.bufferOff=0,this.blockSize},g.prototype._updateEncrypt=function(y){var c=0,m=0,h=(this.bufferOff+y.length)/this.blockSize|0,d=new Array(h*this.blockSize);this.bufferOff!==0&&(c+=this._buffer(y,c),this.bufferOff===this.buffer.length&&(m+=this._flushBuffer(d,m)));for(var b=y.length-(y.length-c)%this.blockSize;c<b;c+=this.blockSize)this._update(y,c,d,m),m+=this.blockSize;for(;c<y.length;c++,this.bufferOff++)this.buffer[this.bufferOff]=y[c];return d},g.prototype._updateDecrypt=function(y){for(var c=0,m=0,h=Math.ceil((this.bufferOff+y.length)/this.blockSize)-1,d=new Array(h*this.blockSize);h>0;h--)c+=this._buffer(y,c),m+=this._flushBuffer(d,m);return c+=this._buffer(y,c),d},g.prototype.final=function(y){var c;y&&(c=this.update(y));var m;return this.type==="encrypt"?m=this._finalEncrypt():m=this._finalDecrypt(),c?c.concat(m):m},g.prototype._pad=function(y,c){if(c===0)return!1;for(;c<y.length;)y[c++]=0;return!0},g.prototype._finalEncrypt=function(){if(!this._pad(this.buffer,this.bufferOff))return[];var y=new Array(this.blockSize);return this._update(this.buffer,0,y,0),y},g.prototype._unpad=function(y){return y},g.prototype._finalDecrypt=function(){u.equal(this.bufferOff,this.blockSize,"Not enough data to decrypt");var y=new Array(this.blockSize);return this._flushBuffer(y,0),this._unpad(y)}},{"minimalistic-assert":223}],82:[function(t,E,e){var u=t("minimalistic-assert"),g=t("inherits"),S=t("./utils"),y=t("./cipher");function c(){this.tmp=new Array(2),this.keys=null}function m(d){y.call(this,d);var b=new c;this._desState=b,this.deriveKeys(b,d.key)}g(m,y),E.exports=m,m.create=function(b){return new m(b)};var h=[1,1,2,2,2,2,2,2,1,2,2,2,2,2,2,1];m.prototype.deriveKeys=function(b,a){b.keys=new Array(16*2),u.equal(a.length,this.blockSize,"Invalid key length");var n=S.readUInt32BE(a,0),i=S.readUInt32BE(a,4);S.pc1(n,i,b.tmp,0),n=b.tmp[0],i=b.tmp[1];for(var r=0;r<b.keys.length;r+=2){var s=h[r>>>1];n=S.r28shl(n,s),i=S.r28shl(i,s),S.pc2(n,i,b.keys,r)}},m.prototype._update=function(b,a,n,i){var r=this._desState,s=S.readUInt32BE(b,a),o=S.readUInt32BE(b,a+4);S.ip(s,o,r.tmp,0),s=r.tmp[0],o=r.tmp[1],this.type==="encrypt"?this._encrypt(r,s,o,r.tmp,0):this._decrypt(r,s,o,r.tmp,0),s=r.tmp[0],o=r.tmp[1],S.writeUInt32BE(n,s,i),S.writeUInt32BE(n,o,i+4)},m.prototype._pad=function(b,a){for(var n=b.length-a,i=a;i<b.length;i++)b[i]=n;return!0},m.prototype._unpad=function(b){for(var a=b[b.length-1],n=b.length-a;n<b.length;n++)u.equal(b[n],a);return b.slice(0,b.length-a)},m.prototype._encrypt=function(b,a,n,i,r){for(var s=a,o=n,l=0;l<b.keys.length;l+=2){var v=b.keys[l],f=b.keys[l+1];S.expand(o,b.tmp,0),v^=b.tmp[0],f^=b.tmp[1];var p=S.substitute(v,f),_=S.permute(p),T=o;o=(s^_)>>>0,s=T}S.rip(o,s,i,r)},m.prototype._decrypt=function(b,a,n,i,r){for(var s=n,o=a,l=b.keys.length-2;l>=0;l-=2){var v=b.keys[l],f=b.keys[l+1];S.expand(s,b.tmp,0),v^=b.tmp[0],f^=b.tmp[1];var p=S.substitute(v,f),_=S.permute(p),T=s;s=(o^_)>>>0,o=T}S.rip(s,o,i,r)}},{"./cipher":81,"./utils":84,inherits:146,"minimalistic-assert":223}],83:[function(t,E,e){var u=t("minimalistic-assert"),g=t("inherits"),S=t("./cipher"),y=t("./des");function c(h,d){u.equal(d.length,24,"Invalid key length");var b=d.slice(0,8),a=d.slice(8,16),n=d.slice(16,24);h==="encrypt"?this.ciphers=[y.create({type:"encrypt",key:b}),y.create({type:"decrypt",key:a}),y.create({type:"encrypt",key:n})]:this.ciphers=[y.create({type:"decrypt",key:n}),y.create({type:"encrypt",key:a}),y.create({type:"decrypt",key:b})]}function m(h){S.call(this,h);var d=new c(this.type,this.options.key);this._edeState=d}g(m,S),E.exports=m,m.create=function(d){return new m(d)},m.prototype._update=function(d,b,a,n){var i=this._edeState;i.ciphers[0]._update(d,b,a,n),i.ciphers[1]._update(a,n,a,n),i.ciphers[2]._update(a,n,a,n)},m.prototype._pad=y.prototype._pad,m.prototype._unpad=y.prototype._unpad},{"./cipher":81,"./des":82,inherits:146,"minimalistic-assert":223}],84:[function(t,E,e){e.readUInt32BE=function(c,m){var h=c[0+m]<<24|c[1+m]<<16|c[2+m]<<8|c[3+m];return h>>>0},e.writeUInt32BE=function(c,m,h){c[0+h]=m>>>24,c[1+h]=m>>>16&255,c[2+h]=m>>>8&255,c[3+h]=m&255},e.ip=function(c,m,h,d){for(var b=0,a=0,n=6;n>=0;n-=2){for(var i=0;i<=24;i+=8)b<<=1,b|=m>>>i+n&1;for(var i=0;i<=24;i+=8)b<<=1,b|=c>>>i+n&1}for(var n=6;n>=0;n-=2){for(var i=1;i<=25;i+=8)a<<=1,a|=m>>>i+n&1;for(var i=1;i<=25;i+=8)a<<=1,a|=c>>>i+n&1}h[d+0]=b>>>0,h[d+1]=a>>>0},e.rip=function(c,m,h,d){for(var b=0,a=0,n=0;n<4;n++)for(var i=24;i>=0;i-=8)b<<=1,b|=m>>>i+n&1,b<<=1,b|=c>>>i+n&1;for(var n=4;n<8;n++)for(var i=24;i>=0;i-=8)a<<=1,a|=m>>>i+n&1,a<<=1,a|=c>>>i+n&1;h[d+0]=b>>>0,h[d+1]=a>>>0},e.pc1=function(c,m,h,d){for(var b=0,a=0,n=7;n>=5;n--){for(var i=0;i<=24;i+=8)b<<=1,b|=m>>i+n&1;for(var i=0;i<=24;i+=8)b<<=1,b|=c>>i+n&1}for(var i=0;i<=24;i+=8)b<<=1,b|=m>>i+n&1;for(var n=1;n<=3;n++){for(var i=0;i<=24;i+=8)a<<=1,a|=m>>i+n&1;for(var i=0;i<=24;i+=8)a<<=1,a|=c>>i+n&1}for(var i=0;i<=24;i+=8)a<<=1,a|=c>>i+n&1;h[d+0]=b>>>0,h[d+1]=a>>>0},e.r28shl=function(c,m){return c<<m&268435455|c>>>28-m};var u=[14,11,17,4,27,23,25,0,13,22,7,18,5,9,16,24,2,20,12,21,1,8,15,26,15,4,25,19,9,1,26,16,5,11,23,8,12,7,17,0,22,3,10,14,6,20,27,24];e.pc2=function(c,m,h,d){for(var b=0,a=0,n=u.length>>>1,i=0;i<n;i++)b<<=1,b|=c>>>u[i]&1;for(var i=n;i<u.length;i++)a<<=1,a|=m>>>u[i]&1;h[d+0]=b>>>0,h[d+1]=a>>>0},e.expand=function(c,m,h){var d=0,b=0;d=(c&1)<<5|c>>>27;for(var a=23;a>=15;a-=4)d<<=6,d|=c>>>a&63;for(var a=11;a>=3;a-=4)b|=c>>>a&63,b<<=6;b|=(c&31)<<1|c>>>31,m[h+0]=d>>>0,m[h+1]=b>>>0};var g=[14,0,4,15,13,7,1,4,2,14,15,2,11,13,8,1,3,10,10,6,6,12,12,11,5,9,9,5,0,3,7,8,4,15,1,12,14,8,8,2,13,4,6,9,2,1,11,7,15,5,12,11,9,3,7,14,3,10,10,0,5,6,0,13,15,3,1,13,8,4,14,7,6,15,11,2,3,8,4,14,9,12,7,0,2,1,13,10,12,6,0,9,5,11,10,5,0,13,14,8,7,10,11,1,10,3,4,15,13,4,1,2,5,11,8,6,12,7,6,12,9,0,3,5,2,14,15,9,10,13,0,7,9,0,14,9,6,3,3,4,15,6,5,10,1,2,13,8,12,5,7,14,11,12,4,11,2,15,8,1,13,1,6,10,4,13,9,0,8,6,15,9,3,8,0,7,11,4,1,15,2,14,12,3,5,11,10,5,14,2,7,12,7,13,13,8,14,11,3,5,0,6,6,15,9,0,10,3,1,4,2,7,8,2,5,12,11,1,12,10,4,14,15,9,10,3,6,15,9,0,0,6,12,10,11,1,7,13,13,8,15,9,1,4,3,5,14,11,5,12,2,7,8,2,4,14,2,14,12,11,4,2,1,12,7,4,10,7,11,13,6,1,8,5,5,0,3,15,15,10,13,3,0,9,14,8,9,6,4,11,2,8,1,12,11,7,10,1,13,14,7,2,8,13,15,6,9,15,12,0,5,9,6,10,3,4,0,5,14,3,12,10,1,15,10,4,15,2,9,7,2,12,6,9,8,5,0,6,13,1,3,13,4,14,14,0,7,11,5,3,11,8,9,4,14,3,15,2,5,12,2,9,8,5,12,15,3,10,7,11,0,14,4,1,10,7,1,6,13,0,11,8,6,13,4,13,11,0,2,11,14,7,15,4,0,9,8,1,13,10,3,14,12,3,9,5,7,12,5,2,10,15,6,8,1,6,1,6,4,11,11,13,13,8,12,1,3,4,7,10,14,7,10,9,15,5,6,0,8,15,0,14,5,2,9,3,2,12,13,1,2,15,8,13,4,8,6,10,15,3,11,7,1,4,10,12,9,5,3,6,14,11,5,0,0,14,12,9,7,2,7,2,11,1,4,14,1,7,9,4,12,10,14,8,2,13,0,15,6,12,10,9,13,0,15,3,3,5,5,6,8,11];e.substitute=function(c,m){for(var h=0,d=0;d<4;d++){var b=c>>>18-d*6&63,a=g[d*64+b];h<<=4,h|=a}for(var d=0;d<4;d++){var b=m>>>18-d*6&63,a=g[4*64+d*64+b];h<<=4,h|=a}return h>>>0};var S=[16,25,12,11,3,20,4,15,31,17,9,6,27,14,1,22,30,24,8,18,0,5,29,23,13,19,2,26,10,21,28,7];e.permute=function(c){for(var m=0,h=0;h<S.length;h++)m<<=1,m|=c>>>S[h]&1;return m>>>0},e.padSplit=function(c,m,h){for(var d=c.toString(2);d.length<m;)d="0"+d;for(var b=[],a=0;a<m;a+=h)b.push(d.slice(a,a+h));return b.join(" ")}},{}],85:[function(t,E,e){(function(u){(function(){var g=t("./lib/generatePrime"),S=t("./lib/primes.json"),y=t("./lib/dh");function c(d){var b=new u(S[d].prime,"hex"),a=new u(S[d].gen,"hex");return new y(b,a)}var m={binary:!0,hex:!0,base64:!0};function h(d,b,a,n){return u.isBuffer(b)||m[b]===void 0?h(d,"binary",b,a):(b=b||"binary",n=n||"binary",a=a||new u([2]),u.isBuffer(a)||(a=new u(a,n)),typeof d=="number"?new y(g(d,a),a,!0):(u.isBuffer(d)||(d=new u(d,b)),new y(d,a,!0)))}e.DiffieHellmanGroup=e.createDiffieHellmanGroup=e.getDiffieHellman=c,e.createDiffieHellman=e.DiffieHellman=h}).call(this)}).call(this,t("buffer").Buffer)},{"./lib/dh":86,"./lib/generatePrime":87,"./lib/primes.json":88,buffer:68}],86:[function(t,E,e){(function(u){(function(){var g=t("bn.js"),S=t("miller-rabin"),y=new S,c=new g(24),m=new g(11),h=new g(10),d=new g(3),b=new g(7),a=t("./generatePrime"),n=t("randombytes");E.exports=l;function i(f,p){return p=p||"utf8",u.isBuffer(f)||(f=new u(f,p)),this._pub=new g(f),this}function r(f,p){return p=p||"utf8",u.isBuffer(f)||(f=new u(f,p)),this._priv=new g(f),this}var s={};function o(f,p){var _=p.toString("hex"),T=[_,f.toString(16)].join("_");if(T in s)return s[T];var w=0;if(f.isEven()||!a.simpleSieve||!a.fermatTest(f)||!y.test(f))return w+=1,_==="02"||_==="05"?w+=8:w+=4,s[T]=w,w;y.test(f.shrn(1))||(w+=2);var M;switch(_){case"02":f.mod(c).cmp(m)&&(w+=8);break;case"05":M=f.mod(h),M.cmp(d)&&M.cmp(b)&&(w+=8);break;default:w+=4}return s[T]=w,w}function l(f,p,_){this.setGenerator(p),this.__prime=new g(f),this._prime=g.mont(this.__prime),this._primeLen=f.length,this._pub=void 0,this._priv=void 0,this._primeCode=void 0,_?(this.setPublicKey=i,this.setPrivateKey=r):this._primeCode=8}Object.defineProperty(l.prototype,"verifyError",{enumerable:!0,get:function(){return typeof this._primeCode!="number"&&(this._primeCode=o(this.__prime,this.__gen)),this._primeCode}}),l.prototype.generateKeys=function(){return this._priv||(this._priv=new g(n(this._primeLen))),this._pub=this._gen.toRed(this._prime).redPow(this._priv).fromRed(),this.getPublicKey()},l.prototype.computeSecret=function(f){f=new g(f),f=f.toRed(this._prime);var p=f.redPow(this._priv).fromRed(),_=new u(p.toArray()),T=this.getPrime();if(_.length<T.length){var w=new u(T.length-_.length);w.fill(0),_=u.concat([w,_])}return _},l.prototype.getPublicKey=function(p){return v(this._pub,p)},l.prototype.getPrivateKey=function(p){return v(this._priv,p)},l.prototype.getPrime=function(f){return v(this.__prime,f)},l.prototype.getGenerator=function(f){return v(this._gen,f)},l.prototype.setGenerator=function(f,p){return p=p||"utf8",u.isBuffer(f)||(f=new u(f,p)),this.__gen=f,this._gen=new g(f),this};function v(f,p){var _=new u(f.toArray());return p?_.toString(p):_}}).call(this)}).call(this,t("buffer").Buffer)},{"./generatePrime":87,"bn.js":18,buffer:68,"miller-rabin":222,randombytes:244}],87:[function(t,E,e){var u=t("randombytes");E.exports=v,v.simpleSieve=o,v.fermatTest=l;var g=t("bn.js"),S=new g(24),y=t("miller-rabin"),c=new y,m=new g(1),h=new g(2),d=new g(5);new g(16),new g(8);var b=new g(10),a=new g(3);new g(7);var n=new g(11),i=new g(4);new g(12);var r=null;function s(){if(r!==null)return r;var f=1048576,p=[];p[0]=2;for(var _=1,T=3;T<f;T+=2){for(var w=Math.ceil(Math.sqrt(T)),M=0;M<_&&p[M]<=w&&T%p[M]!==0;M++);_!==M&&p[M]<=w||(p[_++]=T)}return r=p,p}function o(f){for(var p=s(),_=0;_<p.length;_++)if(f.modn(p[_])===0)return f.cmpn(p[_])===0;return!0}function l(f){var p=g.mont(f);return h.toRed(p).redPow(f.subn(1)).fromRed().cmpn(1)===0}function v(f,p){if(f<16)return p===2||p===5?new g([140,123]):new g([140,39]);p=new g(p);for(var _,T;;){for(_=new g(u(Math.ceil(f/8)));_.bitLength()>f;)_.ishrn(1);if(_.isEven()&&_.iadd(m),_.testn(1)||_.iadd(h),p.cmp(h)){if(!p.cmp(d))for(;_.mod(b).cmp(a);)_.iadd(i)}else for(;_.mod(S).cmp(n);)_.iadd(i);if(T=_.shrn(1),o(T)&&o(_)&&l(T)&&l(_)&&c.test(T)&&c.test(_))return _}}},{"bn.js":18,"miller-rabin":222,randombytes:244}],88:[function(t,E,e){E.exports={modp1:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a63a3620ffffffffffffffff"},modp2:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece65381ffffffffffffffff"},modp5:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca237327ffffffffffffffff"},modp14:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aacaa68ffffffffffffffff"},modp15:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a93ad2caffffffffffffffff"},modp16:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a92108011a723c12a787e6d788719a10bdba5b2699c327186af4e23c1a946834b6150bda2583e9ca2ad44ce8dbbbc2db04de8ef92e8efc141fbecaa6287c59474e6bc05d99b2964fa090c3a2233ba186515be7ed1f612970cee2d7afb81bdd762170481cd0069127d5b05aa993b4ea988d8fddc186ffb7dc90a6c08f4df435c934063199ffffffffffffffff"},modp17:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a92108011a723c12a787e6d788719a10bdba5b2699c327186af4e23c1a946834b6150bda2583e9ca2ad44ce8dbbbc2db04de8ef92e8efc141fbecaa6287c59474e6bc05d99b2964fa090c3a2233ba186515be7ed1f612970cee2d7afb81bdd762170481cd0069127d5b05aa993b4ea988d8fddc186ffb7dc90a6c08f4df435c93402849236c3fab4d27c7026c1d4dcb2602646dec9751e763dba37bdf8ff9406ad9e530ee5db382f413001aeb06a53ed9027d831179727b0865a8918da3edbebcf9b14ed44ce6cbaced4bb1bdb7f1447e6cc254b332051512bd7af426fb8f401378cd2bf5983ca01c64b92ecf032ea15d1721d03f482d7ce6e74fef6d55e702f46980c82b5a84031900b1c9e59e7c97fbec7e8f323a97a7e36cc88be0f1d45b7ff585ac54bd407b22b4154aacc8f6d7ebf48e1d814cc5ed20f8037e0a79715eef29be32806a1d58bb7c5da76f550aa3d8a1fbff0eb19ccb1a313d55cda56c9ec2ef29632387fe8d76e3c0468043e8f663f4860ee12bf2d5b0b7474d6e694f91e6dcc4024ffffffffffffffff"},modp18:{gen:"02",prime:"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a92108011a723c12a787e6d788719a10bdba5b2699c327186af4e23c1a946834b6150bda2583e9ca2ad44ce8dbbbc2db04de8ef92e8efc141fbecaa6287c59474e6bc05d99b2964fa090c3a2233ba186515be7ed1f612970cee2d7afb81bdd762170481cd0069127d5b05aa993b4ea988d8fddc186ffb7dc90a6c08f4df435c93402849236c3fab4d27c7026c1d4dcb2602646dec9751e763dba37bdf8ff9406ad9e530ee5db382f413001aeb06a53ed9027d831179727b0865a8918da3edbebcf9b14ed44ce6cbaced4bb1bdb7f1447e6cc254b332051512bd7af426fb8f401378cd2bf5983ca01c64b92ecf032ea15d1721d03f482d7ce6e74fef6d55e702f46980c82b5a84031900b1c9e59e7c97fbec7e8f323a97a7e36cc88be0f1d45b7ff585ac54bd407b22b4154aacc8f6d7ebf48e1d814cc5ed20f8037e0a79715eef29be32806a1d58bb7c5da76f550aa3d8a1fbff0eb19ccb1a313d55cda56c9ec2ef29632387fe8d76e3c0468043e8f663f4860ee12bf2d5b0b7474d6e694f91e6dbe115974a3926f12fee5e438777cb6a932df8cd8bec4d073b931ba3bc832b68d9dd300741fa7bf8afc47ed2576f6936ba424663aab639c5ae4f5683423b4742bf1c978238f16cbe39d652de3fdb8befc848ad922222e04a4037c0713eb57a81a23f0c73473fc646cea306b4bcbc8862f8385ddfa9d4b7fa2c087e879683303ed5bdd3a062b3cf5b3a278a66d2a13f83f44f82ddf310ee074ab6a364597e899a0255dc164f31cc50846851df9ab48195ded7ea1b1d510bd7ee74d73faf36bc31ecfa268359046f4eb879f924009438b481c6cd7889a002ed5ee382bc9190da6fc026e479558e4475677e9aa9e3050e2765694dfc81f56e880b96e7160c980dd98edd3dfffffffffffffffff"}}},{}],89:[function(t,E,e){var u=e;u.version=t("../package.json").version,u.utils=t("./elliptic/utils"),u.rand=t("brorand"),u.curve=t("./elliptic/curve"),u.curves=t("./elliptic/curves"),u.ec=t("./elliptic/ec"),u.eddsa=t("./elliptic/eddsa")},{"../package.json":104,"./elliptic/curve":92,"./elliptic/curves":95,"./elliptic/ec":96,"./elliptic/eddsa":99,"./elliptic/utils":103,brorand:19}],90:[function(t,E,e){var u=t("bn.js"),g=t("../utils"),S=g.getNAF,y=g.getJSF,c=g.assert;function m(d,b){this.type=d,this.p=new u(b.p,16),this.red=b.prime?u.red(b.prime):u.mont(this.p),this.zero=new u(0).toRed(this.red),this.one=new u(1).toRed(this.red),this.two=new u(2).toRed(this.red),this.n=b.n&&new u(b.n,16),this.g=b.g&&this.pointFromJSON(b.g,b.gRed),this._wnafT1=new Array(4),this._wnafT2=new Array(4),this._wnafT3=new Array(4),this._wnafT4=new Array(4),this._bitLength=this.n?this.n.bitLength():0;var a=this.n&&this.p.div(this.n);!a||a.cmpn(100)>0?this.redN=null:(this._maxwellTrick=!0,this.redN=this.n.toRed(this.red))}E.exports=m,m.prototype.point=function(){throw new Error("Not implemented")},m.prototype.validate=function(){throw new Error("Not implemented")},m.prototype._fixedNafMul=function(b,a){c(b.precomputed);var n=b._getDoubles(),i=S(a,1,this._bitLength),r=(1<<n.step+1)-(n.step%2===0?2:1);r/=3;var s=[],o,l;for(o=0;o<i.length;o+=n.step){l=0;for(var v=o+n.step-1;v>=o;v--)l=(l<<1)+i[v];s.push(l)}for(var f=this.jpoint(null,null,null),p=this.jpoint(null,null,null),_=r;_>0;_--){for(o=0;o<s.length;o++)l=s[o],l===_?p=p.mixedAdd(n.points[o]):l===-_&&(p=p.mixedAdd(n.points[o].neg()));f=f.add(p)}return f.toP()},m.prototype._wnafMul=function(b,a){var n=4,i=b._getNAFPoints(n);n=i.wnd;for(var r=i.points,s=S(a,n,this._bitLength),o=this.jpoint(null,null,null),l=s.length-1;l>=0;l--){for(var v=0;l>=0&&s[l]===0;l--)v++;if(l>=0&&v++,o=o.dblp(v),l<0)break;var f=s[l];c(f!==0),b.type==="affine"?f>0?o=o.mixedAdd(r[f-1>>1]):o=o.mixedAdd(r[-f-1>>1].neg()):f>0?o=o.add(r[f-1>>1]):o=o.add(r[-f-1>>1].neg())}return b.type==="affine"?o.toP():o},m.prototype._wnafMulAdd=function(b,a,n,i,r){var s=this._wnafT1,o=this._wnafT2,l=this._wnafT3,v=0,f,p,_;for(f=0;f<i;f++){_=a[f];var T=_._getNAFPoints(b);s[f]=T.wnd,o[f]=T.points}for(f=i-1;f>=1;f-=2){var w=f-1,M=f;if(s[w]!==1||s[M]!==1){l[w]=S(n[w],s[w],this._bitLength),l[M]=S(n[M],s[M],this._bitLength),v=Math.max(l[w].length,v),v=Math.max(l[M].length,v);continue}var A=[a[w],null,null,a[M]];a[w].y.cmp(a[M].y)===0?(A[1]=a[w].add(a[M]),A[2]=a[w].toJ().mixedAdd(a[M].neg())):a[w].y.cmp(a[M].y.redNeg())===0?(A[1]=a[w].toJ().mixedAdd(a[M]),A[2]=a[w].add(a[M].neg())):(A[1]=a[w].toJ().mixedAdd(a[M]),A[2]=a[w].toJ().mixedAdd(a[M].neg()));var W=[-3,-1,-5,-7,0,7,5,1,3],ee=y(n[w],n[M]);for(v=Math.max(ee[0].length,v),l[w]=new Array(v),l[M]=new Array(v),p=0;p<v;p++){var F=ee[0][p]|0,C=ee[1][p]|0;l[w][p]=W[(F+1)*3+(C+1)],l[M][p]=0,o[w]=A}}var O=this.jpoint(null,null,null),I=this._wnafT4;for(f=v;f>=0;f--){for(var D=0;f>=0;){var j=!0;for(p=0;p<i;p++)I[p]=l[p][f]|0,I[p]!==0&&(j=!1);if(!j)break;D++,f--}if(f>=0&&D++,O=O.dblp(D),f<0)break;for(p=0;p<i;p++){var Y=I[p];Y!==0&&(Y>0?_=o[p][Y-1>>1]:Y<0&&(_=o[p][-Y-1>>1].neg()),_.type==="affine"?O=O.mixedAdd(_):O=O.add(_))}}for(f=0;f<i;f++)o[f]=null;return r?O:O.toP()};function h(d,b){this.curve=d,this.type=b,this.precomputed=null}m.BasePoint=h,h.prototype.eq=function(){throw new Error("Not implemented")},h.prototype.validate=function(){return this.curve.validate(this)},m.prototype.decodePoint=function(b,a){b=g.toArray(b,a);var n=this.p.byteLength();if((b[0]===4||b[0]===6||b[0]===7)&&b.length-1===2*n){b[0]===6?c(b[b.length-1]%2===0):b[0]===7&&c(b[b.length-1]%2===1);var i=this.point(b.slice(1,1+n),b.slice(1+n,1+2*n));return i}else if((b[0]===2||b[0]===3)&&b.length-1===n)return this.pointFromX(b.slice(1,1+n),b[0]===3);throw new Error("Unknown point format")},h.prototype.encodeCompressed=function(b){return this.encode(b,!0)},h.prototype._encode=function(b){var a=this.curve.p.byteLength(),n=this.getX().toArray("be",a);return b?[this.getY().isEven()?2:3].concat(n):[4].concat(n,this.getY().toArray("be",a))},h.prototype.encode=function(b,a){return g.encode(this._encode(a),b)},h.prototype.precompute=function(b){if(this.precomputed)return this;var a={doubles:null,naf:null,beta:null};return a.naf=this._getNAFPoints(8),a.doubles=this._getDoubles(4,b),a.beta=this._getBeta(),this.precomputed=a,this},h.prototype._hasDoubles=function(b){if(!this.precomputed)return!1;var a=this.precomputed.doubles;return a?a.points.length>=Math.ceil((b.bitLength()+1)/a.step):!1},h.prototype._getDoubles=function(b,a){if(this.precomputed&&this.precomputed.doubles)return this.precomputed.doubles;for(var n=[this],i=this,r=0;r<a;r+=b){for(var s=0;s<b;s++)i=i.dbl();n.push(i)}return{step:b,points:n}},h.prototype._getNAFPoints=function(b){if(this.precomputed&&this.precomputed.naf)return this.precomputed.naf;for(var a=[this],n=(1<<b)-1,i=n===1?null:this.dbl(),r=1;r<n;r++)a[r]=a[r-1].add(i);return{wnd:b,points:a}},h.prototype._getBeta=function(){return null},h.prototype.dblp=function(b){for(var a=this,n=0;n<b;n++)a=a.dbl();return a}},{"../utils":103,"bn.js":18}],91:[function(t,E,e){var u=t("../utils"),g=t("bn.js"),S=t("inherits"),y=t("./base"),c=u.assert;function m(d){this.twisted=(d.a|0)!==1,this.mOneA=this.twisted&&(d.a|0)===-1,this.extended=this.mOneA,y.call(this,"edwards",d),this.a=new g(d.a,16).umod(this.red.m),this.a=this.a.toRed(this.red),this.c=new g(d.c,16).toRed(this.red),this.c2=this.c.redSqr(),this.d=new g(d.d,16).toRed(this.red),this.dd=this.d.redAdd(this.d),c(!this.twisted||this.c.fromRed().cmpn(1)===0),this.oneC=(d.c|0)===1}S(m,y),E.exports=m,m.prototype._mulA=function(b){return this.mOneA?b.redNeg():this.a.redMul(b)},m.prototype._mulC=function(b){return this.oneC?b:this.c.redMul(b)},m.prototype.jpoint=function(b,a,n,i){return this.point(b,a,n,i)},m.prototype.pointFromX=function(b,a){b=new g(b,16),b.red||(b=b.toRed(this.red));var n=b.redSqr(),i=this.c2.redSub(this.a.redMul(n)),r=this.one.redSub(this.c2.redMul(this.d).redMul(n)),s=i.redMul(r.redInvm()),o=s.redSqrt();if(o.redSqr().redSub(s).cmp(this.zero)!==0)throw new Error("invalid point");var l=o.fromRed().isOdd();return(a&&!l||!a&&l)&&(o=o.redNeg()),this.point(b,o)},m.prototype.pointFromY=function(b,a){b=new g(b,16),b.red||(b=b.toRed(this.red));var n=b.redSqr(),i=n.redSub(this.c2),r=n.redMul(this.d).redMul(this.c2).redSub(this.a),s=i.redMul(r.redInvm());if(s.cmp(this.zero)===0){if(a)throw new Error("invalid point");return this.point(this.zero,b)}var o=s.redSqrt();if(o.redSqr().redSub(s).cmp(this.zero)!==0)throw new Error("invalid point");return o.fromRed().isOdd()!==a&&(o=o.redNeg()),this.point(o,b)},m.prototype.validate=function(b){if(b.isInfinity())return!0;b.normalize();var a=b.x.redSqr(),n=b.y.redSqr(),i=a.redMul(this.a).redAdd(n),r=this.c2.redMul(this.one.redAdd(this.d.redMul(a).redMul(n)));return i.cmp(r)===0};function h(d,b,a,n,i){y.BasePoint.call(this,d,"projective"),b===null&&a===null&&n===null?(this.x=this.curve.zero,this.y=this.curve.one,this.z=this.curve.one,this.t=this.curve.zero,this.zOne=!0):(this.x=new g(b,16),this.y=new g(a,16),this.z=n?new g(n,16):this.curve.one,this.t=i&&new g(i,16),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)),this.t&&!this.t.red&&(this.t=this.t.toRed(this.curve.red)),this.zOne=this.z===this.curve.one,this.curve.extended&&!this.t&&(this.t=this.x.redMul(this.y),this.zOne||(this.t=this.t.redMul(this.z.redInvm()))))}S(h,y.BasePoint),m.prototype.pointFromJSON=function(b){return h.fromJSON(this,b)},m.prototype.point=function(b,a,n,i){return new h(this,b,a,n,i)},h.fromJSON=function(b,a){return new h(b,a[0],a[1],a[2])},h.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" y: "+this.y.fromRed().toString(16,2)+" z: "+this.z.fromRed().toString(16,2)+">"},h.prototype.isInfinity=function(){return this.x.cmpn(0)===0&&(this.y.cmp(this.z)===0||this.zOne&&this.y.cmp(this.curve.c)===0)},h.prototype._extDbl=function(){var b=this.x.redSqr(),a=this.y.redSqr(),n=this.z.redSqr();n=n.redIAdd(n);var i=this.curve._mulA(b),r=this.x.redAdd(this.y).redSqr().redISub(b).redISub(a),s=i.redAdd(a),o=s.redSub(n),l=i.redSub(a),v=r.redMul(o),f=s.redMul(l),p=r.redMul(l),_=o.redMul(s);return this.curve.point(v,f,_,p)},h.prototype._projDbl=function(){var b=this.x.redAdd(this.y).redSqr(),a=this.x.redSqr(),n=this.y.redSqr(),i,r,s,o,l,v;if(this.curve.twisted){o=this.curve._mulA(a);var f=o.redAdd(n);this.zOne?(i=b.redSub(a).redSub(n).redMul(f.redSub(this.curve.two)),r=f.redMul(o.redSub(n)),s=f.redSqr().redSub(f).redSub(f)):(l=this.z.redSqr(),v=f.redSub(l).redISub(l),i=b.redSub(a).redISub(n).redMul(v),r=f.redMul(o.redSub(n)),s=f.redMul(v))}else o=a.redAdd(n),l=this.curve._mulC(this.z).redSqr(),v=o.redSub(l).redSub(l),i=this.curve._mulC(b.redISub(o)).redMul(v),r=this.curve._mulC(o).redMul(a.redISub(n)),s=o.redMul(v);return this.curve.point(i,r,s)},h.prototype.dbl=function(){return this.isInfinity()?this:this.curve.extended?this._extDbl():this._projDbl()},h.prototype._extAdd=function(b){var a=this.y.redSub(this.x).redMul(b.y.redSub(b.x)),n=this.y.redAdd(this.x).redMul(b.y.redAdd(b.x)),i=this.t.redMul(this.curve.dd).redMul(b.t),r=this.z.redMul(b.z.redAdd(b.z)),s=n.redSub(a),o=r.redSub(i),l=r.redAdd(i),v=n.redAdd(a),f=s.redMul(o),p=l.redMul(v),_=s.redMul(v),T=o.redMul(l);return this.curve.point(f,p,T,_)},h.prototype._projAdd=function(b){var a=this.z.redMul(b.z),n=a.redSqr(),i=this.x.redMul(b.x),r=this.y.redMul(b.y),s=this.curve.d.redMul(i).redMul(r),o=n.redSub(s),l=n.redAdd(s),v=this.x.redAdd(this.y).redMul(b.x.redAdd(b.y)).redISub(i).redISub(r),f=a.redMul(o).redMul(v),p,_;return this.curve.twisted?(p=a.redMul(l).redMul(r.redSub(this.curve._mulA(i))),_=o.redMul(l)):(p=a.redMul(l).redMul(r.redSub(i)),_=this.curve._mulC(o).redMul(l)),this.curve.point(f,p,_)},h.prototype.add=function(b){return this.isInfinity()?b:b.isInfinity()?this:this.curve.extended?this._extAdd(b):this._projAdd(b)},h.prototype.mul=function(b){return this._hasDoubles(b)?this.curve._fixedNafMul(this,b):this.curve._wnafMul(this,b)},h.prototype.mulAdd=function(b,a,n){return this.curve._wnafMulAdd(1,[this,a],[b,n],2,!1)},h.prototype.jmulAdd=function(b,a,n){return this.curve._wnafMulAdd(1,[this,a],[b,n],2,!0)},h.prototype.normalize=function(){if(this.zOne)return this;var b=this.z.redInvm();return this.x=this.x.redMul(b),this.y=this.y.redMul(b),this.t&&(this.t=this.t.redMul(b)),this.z=this.curve.one,this.zOne=!0,this},h.prototype.neg=function(){return this.curve.point(this.x.redNeg(),this.y,this.z,this.t&&this.t.redNeg())},h.prototype.getX=function(){return this.normalize(),this.x.fromRed()},h.prototype.getY=function(){return this.normalize(),this.y.fromRed()},h.prototype.eq=function(b){return this===b||this.getX().cmp(b.getX())===0&&this.getY().cmp(b.getY())===0},h.prototype.eqXToP=function(b){var a=b.toRed(this.curve.red).redMul(this.z);if(this.x.cmp(a)===0)return!0;for(var n=b.clone(),i=this.curve.redN.redMul(this.z);;){if(n.iadd(this.curve.n),n.cmp(this.curve.p)>=0)return!1;if(a.redIAdd(i),this.x.cmp(a)===0)return!0}},h.prototype.toP=h.prototype.normalize,h.prototype.mixedAdd=h.prototype.add},{"../utils":103,"./base":90,"bn.js":18,inherits:146}],92:[function(t,E,e){var u=e;u.base=t("./base"),u.short=t("./short"),u.mont=t("./mont"),u.edwards=t("./edwards")},{"./base":90,"./edwards":91,"./mont":93,"./short":94}],93:[function(t,E,e){var u=t("bn.js"),g=t("inherits"),S=t("./base"),y=t("../utils");function c(h){S.call(this,"mont",h),this.a=new u(h.a,16).toRed(this.red),this.b=new u(h.b,16).toRed(this.red),this.i4=new u(4).toRed(this.red).redInvm(),this.two=new u(2).toRed(this.red),this.a24=this.i4.redMul(this.a.redAdd(this.two))}g(c,S),E.exports=c,c.prototype.validate=function(d){var b=d.normalize().x,a=b.redSqr(),n=a.redMul(b).redAdd(a.redMul(this.a)).redAdd(b),i=n.redSqrt();return i.redSqr().cmp(n)===0};function m(h,d,b){S.BasePoint.call(this,h,"projective"),d===null&&b===null?(this.x=this.curve.one,this.z=this.curve.zero):(this.x=new u(d,16),this.z=new u(b,16),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)))}g(m,S.BasePoint),c.prototype.decodePoint=function(d,b){return this.point(y.toArray(d,b),1)},c.prototype.point=function(d,b){return new m(this,d,b)},c.prototype.pointFromJSON=function(d){return m.fromJSON(this,d)},m.prototype.precompute=function(){},m.prototype._encode=function(){return this.getX().toArray("be",this.curve.p.byteLength())},m.fromJSON=function(d,b){return new m(d,b[0],b[1]||d.one)},m.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" z: "+this.z.fromRed().toString(16,2)+">"},m.prototype.isInfinity=function(){return this.z.cmpn(0)===0},m.prototype.dbl=function(){var d=this.x.redAdd(this.z),b=d.redSqr(),a=this.x.redSub(this.z),n=a.redSqr(),i=b.redSub(n),r=b.redMul(n),s=i.redMul(n.redAdd(this.curve.a24.redMul(i)));return this.curve.point(r,s)},m.prototype.add=function(){throw new Error("Not supported on Montgomery curve")},m.prototype.diffAdd=function(d,b){var a=this.x.redAdd(this.z),n=this.x.redSub(this.z),i=d.x.redAdd(d.z),r=d.x.redSub(d.z),s=r.redMul(a),o=i.redMul(n),l=b.z.redMul(s.redAdd(o).redSqr()),v=b.x.redMul(s.redISub(o).redSqr());return this.curve.point(l,v)},m.prototype.mul=function(d){for(var b=d.clone(),a=this,n=this.curve.point(null,null),i=this,r=[];b.cmpn(0)!==0;b.iushrn(1))r.push(b.andln(1));for(var s=r.length-1;s>=0;s--)r[s]===0?(a=a.diffAdd(n,i),n=n.dbl()):(n=a.diffAdd(n,i),a=a.dbl());return n},m.prototype.mulAdd=function(){throw new Error("Not supported on Montgomery curve")},m.prototype.jumlAdd=function(){throw new Error("Not supported on Montgomery curve")},m.prototype.eq=function(d){return this.getX().cmp(d.getX())===0},m.prototype.normalize=function(){return this.x=this.x.redMul(this.z.redInvm()),this.z=this.curve.one,this},m.prototype.getX=function(){return this.normalize(),this.x.fromRed()}},{"../utils":103,"./base":90,"bn.js":18,inherits:146}],94:[function(t,E,e){var u=t("../utils"),g=t("bn.js"),S=t("inherits"),y=t("./base"),c=u.assert;function m(b){y.call(this,"short",b),this.a=new g(b.a,16).toRed(this.red),this.b=new g(b.b,16).toRed(this.red),this.tinv=this.two.redInvm(),this.zeroA=this.a.fromRed().cmpn(0)===0,this.threeA=this.a.fromRed().sub(this.p).cmpn(-3)===0,this.endo=this._getEndomorphism(b),this._endoWnafT1=new Array(4),this._endoWnafT2=new Array(4)}S(m,y),E.exports=m,m.prototype._getEndomorphism=function(a){if(!(!this.zeroA||!this.g||!this.n||this.p.modn(3)!==1)){var n,i;if(a.beta)n=new g(a.beta,16).toRed(this.red);else{var r=this._getEndoRoots(this.p);n=r[0].cmp(r[1])<0?r[0]:r[1],n=n.toRed(this.red)}if(a.lambda)i=new g(a.lambda,16);else{var s=this._getEndoRoots(this.n);this.g.mul(s[0]).x.cmp(this.g.x.redMul(n))===0?i=s[0]:(i=s[1],c(this.g.mul(i).x.cmp(this.g.x.redMul(n))===0))}var o;return a.basis?o=a.basis.map(function(l){return{a:new g(l.a,16),b:new g(l.b,16)}}):o=this._getEndoBasis(i),{beta:n,lambda:i,basis:o}}},m.prototype._getEndoRoots=function(a){var n=a===this.p?this.red:g.mont(a),i=new g(2).toRed(n).redInvm(),r=i.redNeg(),s=new g(3).toRed(n).redNeg().redSqrt().redMul(i),o=r.redAdd(s).fromRed(),l=r.redSub(s).fromRed();return[o,l]},m.prototype._getEndoBasis=function(a){for(var n=this.n.ushrn(Math.floor(this.n.bitLength()/2)),i=a,r=this.n.clone(),s=new g(1),o=new g(0),l=new g(0),v=new g(1),f,p,_,T,w,M,A,W=0,ee,F;i.cmpn(0)!==0;){var C=r.div(i);ee=r.sub(C.mul(i)),F=l.sub(C.mul(s));var O=v.sub(C.mul(o));if(!_&&ee.cmp(n)<0)f=A.neg(),p=s,_=ee.neg(),T=F;else if(_&&++W===2)break;A=ee,r=i,i=ee,l=s,s=F,v=o,o=O}w=ee.neg(),M=F;var I=_.sqr().add(T.sqr()),D=w.sqr().add(M.sqr());return D.cmp(I)>=0&&(w=f,M=p),_.negative&&(_=_.neg(),T=T.neg()),w.negative&&(w=w.neg(),M=M.neg()),[{a:_,b:T},{a:w,b:M}]},m.prototype._endoSplit=function(a){var n=this.endo.basis,i=n[0],r=n[1],s=r.b.mul(a).divRound(this.n),o=i.b.neg().mul(a).divRound(this.n),l=s.mul(i.a),v=o.mul(r.a),f=s.mul(i.b),p=o.mul(r.b),_=a.sub(l).sub(v),T=f.add(p).neg();return{k1:_,k2:T}},m.prototype.pointFromX=function(a,n){a=new g(a,16),a.red||(a=a.toRed(this.red));var i=a.redSqr().redMul(a).redIAdd(a.redMul(this.a)).redIAdd(this.b),r=i.redSqrt();if(r.redSqr().redSub(i).cmp(this.zero)!==0)throw new Error("invalid point");var s=r.fromRed().isOdd();return(n&&!s||!n&&s)&&(r=r.redNeg()),this.point(a,r)},m.prototype.validate=function(a){if(a.inf)return!0;var n=a.x,i=a.y,r=this.a.redMul(n),s=n.redSqr().redMul(n).redIAdd(r).redIAdd(this.b);return i.redSqr().redISub(s).cmpn(0)===0},m.prototype._endoWnafMulAdd=function(a,n,i){for(var r=this._endoWnafT1,s=this._endoWnafT2,o=0;o<a.length;o++){var l=this._endoSplit(n[o]),v=a[o],f=v._getBeta();l.k1.negative&&(l.k1.ineg(),v=v.neg(!0)),l.k2.negative&&(l.k2.ineg(),f=f.neg(!0)),r[o*2]=v,r[o*2+1]=f,s[o*2]=l.k1,s[o*2+1]=l.k2}for(var p=this._wnafMulAdd(1,r,s,o*2,i),_=0;_<o*2;_++)r[_]=null,s[_]=null;return p};function h(b,a,n,i){y.BasePoint.call(this,b,"affine"),a===null&&n===null?(this.x=null,this.y=null,this.inf=!0):(this.x=new g(a,16),this.y=new g(n,16),i&&(this.x.forceRed(this.curve.red),this.y.forceRed(this.curve.red)),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.inf=!1)}S(h,y.BasePoint),m.prototype.point=function(a,n,i){return new h(this,a,n,i)},m.prototype.pointFromJSON=function(a,n){return h.fromJSON(this,a,n)},h.prototype._getBeta=function(){if(this.curve.endo){var a=this.precomputed;if(a&&a.beta)return a.beta;var n=this.curve.point(this.x.redMul(this.curve.endo.beta),this.y);if(a){var i=this.curve,r=function(s){return i.point(s.x.redMul(i.endo.beta),s.y)};a.beta=n,n.precomputed={beta:null,naf:a.naf&&{wnd:a.naf.wnd,points:a.naf.points.map(r)},doubles:a.doubles&&{step:a.doubles.step,points:a.doubles.points.map(r)}}}return n}},h.prototype.toJSON=function(){return this.precomputed?[this.x,this.y,this.precomputed&&{doubles:this.precomputed.doubles&&{step:this.precomputed.doubles.step,points:this.precomputed.doubles.points.slice(1)},naf:this.precomputed.naf&&{wnd:this.precomputed.naf.wnd,points:this.precomputed.naf.points.slice(1)}}]:[this.x,this.y]},h.fromJSON=function(a,n,i){typeof n=="string"&&(n=JSON.parse(n));var r=a.point(n[0],n[1],i);if(!n[2])return r;function s(l){return a.point(l[0],l[1],i)}var o=n[2];return r.precomputed={beta:null,doubles:o.doubles&&{step:o.doubles.step,points:[r].concat(o.doubles.points.map(s))},naf:o.naf&&{wnd:o.naf.wnd,points:[r].concat(o.naf.points.map(s))}},r},h.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" y: "+this.y.fromRed().toString(16,2)+">"},h.prototype.isInfinity=function(){return this.inf},h.prototype.add=function(a){if(this.inf)return a;if(a.inf)return this;if(this.eq(a))return this.dbl();if(this.neg().eq(a))return this.curve.point(null,null);if(this.x.cmp(a.x)===0)return this.curve.point(null,null);var n=this.y.redSub(a.y);n.cmpn(0)!==0&&(n=n.redMul(this.x.redSub(a.x).redInvm()));var i=n.redSqr().redISub(this.x).redISub(a.x),r=n.redMul(this.x.redSub(i)).redISub(this.y);return this.curve.point(i,r)},h.prototype.dbl=function(){if(this.inf)return this;var a=this.y.redAdd(this.y);if(a.cmpn(0)===0)return this.curve.point(null,null);var n=this.curve.a,i=this.x.redSqr(),r=a.redInvm(),s=i.redAdd(i).redIAdd(i).redIAdd(n).redMul(r),o=s.redSqr().redISub(this.x.redAdd(this.x)),l=s.redMul(this.x.redSub(o)).redISub(this.y);return this.curve.point(o,l)},h.prototype.getX=function(){return this.x.fromRed()},h.prototype.getY=function(){return this.y.fromRed()},h.prototype.mul=function(a){return a=new g(a,16),this.isInfinity()?this:this._hasDoubles(a)?this.curve._fixedNafMul(this,a):this.curve.endo?this.curve._endoWnafMulAdd([this],[a]):this.curve._wnafMul(this,a)},h.prototype.mulAdd=function(a,n,i){var r=[this,n],s=[a,i];return this.curve.endo?this.curve._endoWnafMulAdd(r,s):this.curve._wnafMulAdd(1,r,s,2)},h.prototype.jmulAdd=function(a,n,i){var r=[this,n],s=[a,i];return this.curve.endo?this.curve._endoWnafMulAdd(r,s,!0):this.curve._wnafMulAdd(1,r,s,2,!0)},h.prototype.eq=function(a){return this===a||this.inf===a.inf&&(this.inf||this.x.cmp(a.x)===0&&this.y.cmp(a.y)===0)},h.prototype.neg=function(a){if(this.inf)return this;var n=this.curve.point(this.x,this.y.redNeg());if(a&&this.precomputed){var i=this.precomputed,r=function(s){return s.neg()};n.precomputed={naf:i.naf&&{wnd:i.naf.wnd,points:i.naf.points.map(r)},doubles:i.doubles&&{step:i.doubles.step,points:i.doubles.points.map(r)}}}return n},h.prototype.toJ=function(){if(this.inf)return this.curve.jpoint(null,null,null);var a=this.curve.jpoint(this.x,this.y,this.curve.one);return a};function d(b,a,n,i){y.BasePoint.call(this,b,"jacobian"),a===null&&n===null&&i===null?(this.x=this.curve.one,this.y=this.curve.one,this.z=new g(0)):(this.x=new g(a,16),this.y=new g(n,16),this.z=new g(i,16)),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)),this.zOne=this.z===this.curve.one}S(d,y.BasePoint),m.prototype.jpoint=function(a,n,i){return new d(this,a,n,i)},d.prototype.toP=function(){if(this.isInfinity())return this.curve.point(null,null);var a=this.z.redInvm(),n=a.redSqr(),i=this.x.redMul(n),r=this.y.redMul(n).redMul(a);return this.curve.point(i,r)},d.prototype.neg=function(){return this.curve.jpoint(this.x,this.y.redNeg(),this.z)},d.prototype.add=function(a){if(this.isInfinity())return a;if(a.isInfinity())return this;var n=a.z.redSqr(),i=this.z.redSqr(),r=this.x.redMul(n),s=a.x.redMul(i),o=this.y.redMul(n.redMul(a.z)),l=a.y.redMul(i.redMul(this.z)),v=r.redSub(s),f=o.redSub(l);if(v.cmpn(0)===0)return f.cmpn(0)!==0?this.curve.jpoint(null,null,null):this.dbl();var p=v.redSqr(),_=p.redMul(v),T=r.redMul(p),w=f.redSqr().redIAdd(_).redISub(T).redISub(T),M=f.redMul(T.redISub(w)).redISub(o.redMul(_)),A=this.z.redMul(a.z).redMul(v);return this.curve.jpoint(w,M,A)},d.prototype.mixedAdd=function(a){if(this.isInfinity())return a.toJ();if(a.isInfinity())return this;var n=this.z.redSqr(),i=this.x,r=a.x.redMul(n),s=this.y,o=a.y.redMul(n).redMul(this.z),l=i.redSub(r),v=s.redSub(o);if(l.cmpn(0)===0)return v.cmpn(0)!==0?this.curve.jpoint(null,null,null):this.dbl();var f=l.redSqr(),p=f.redMul(l),_=i.redMul(f),T=v.redSqr().redIAdd(p).redISub(_).redISub(_),w=v.redMul(_.redISub(T)).redISub(s.redMul(p)),M=this.z.redMul(l);return this.curve.jpoint(T,w,M)},d.prototype.dblp=function(a){if(a===0)return this;if(this.isInfinity())return this;if(!a)return this.dbl();var n;if(this.curve.zeroA||this.curve.threeA){var i=this;for(n=0;n<a;n++)i=i.dbl();return i}var r=this.curve.a,s=this.curve.tinv,o=this.x,l=this.y,v=this.z,f=v.redSqr().redSqr(),p=l.redAdd(l);for(n=0;n<a;n++){var _=o.redSqr(),T=p.redSqr(),w=T.redSqr(),M=_.redAdd(_).redIAdd(_).redIAdd(r.redMul(f)),A=o.redMul(T),W=M.redSqr().redISub(A.redAdd(A)),ee=A.redISub(W),F=M.redMul(ee);F=F.redIAdd(F).redISub(w);var C=p.redMul(v);n+1<a&&(f=f.redMul(w)),o=W,v=C,p=F}return this.curve.jpoint(o,p.redMul(s),v)},d.prototype.dbl=function(){return this.isInfinity()?this:this.curve.zeroA?this._zeroDbl():this.curve.threeA?this._threeDbl():this._dbl()},d.prototype._zeroDbl=function(){var a,n,i;if(this.zOne){var r=this.x.redSqr(),s=this.y.redSqr(),o=s.redSqr(),l=this.x.redAdd(s).redSqr().redISub(r).redISub(o);l=l.redIAdd(l);var v=r.redAdd(r).redIAdd(r),f=v.redSqr().redISub(l).redISub(l),p=o.redIAdd(o);p=p.redIAdd(p),p=p.redIAdd(p),a=f,n=v.redMul(l.redISub(f)).redISub(p),i=this.y.redAdd(this.y)}else{var _=this.x.redSqr(),T=this.y.redSqr(),w=T.redSqr(),M=this.x.redAdd(T).redSqr().redISub(_).redISub(w);M=M.redIAdd(M);var A=_.redAdd(_).redIAdd(_),W=A.redSqr(),ee=w.redIAdd(w);ee=ee.redIAdd(ee),ee=ee.redIAdd(ee),a=W.redISub(M).redISub(M),n=A.redMul(M.redISub(a)).redISub(ee),i=this.y.redMul(this.z),i=i.redIAdd(i)}return this.curve.jpoint(a,n,i)},d.prototype._threeDbl=function(){var a,n,i;if(this.zOne){var r=this.x.redSqr(),s=this.y.redSqr(),o=s.redSqr(),l=this.x.redAdd(s).redSqr().redISub(r).redISub(o);l=l.redIAdd(l);var v=r.redAdd(r).redIAdd(r).redIAdd(this.curve.a),f=v.redSqr().redISub(l).redISub(l);a=f;var p=o.redIAdd(o);p=p.redIAdd(p),p=p.redIAdd(p),n=v.redMul(l.redISub(f)).redISub(p),i=this.y.redAdd(this.y)}else{var _=this.z.redSqr(),T=this.y.redSqr(),w=this.x.redMul(T),M=this.x.redSub(_).redMul(this.x.redAdd(_));M=M.redAdd(M).redIAdd(M);var A=w.redIAdd(w);A=A.redIAdd(A);var W=A.redAdd(A);a=M.redSqr().redISub(W),i=this.y.redAdd(this.z).redSqr().redISub(T).redISub(_);var ee=T.redSqr();ee=ee.redIAdd(ee),ee=ee.redIAdd(ee),ee=ee.redIAdd(ee),n=M.redMul(A.redISub(a)).redISub(ee)}return this.curve.jpoint(a,n,i)},d.prototype._dbl=function(){var a=this.curve.a,n=this.x,i=this.y,r=this.z,s=r.redSqr().redSqr(),o=n.redSqr(),l=i.redSqr(),v=o.redAdd(o).redIAdd(o).redIAdd(a.redMul(s)),f=n.redAdd(n);f=f.redIAdd(f);var p=f.redMul(l),_=v.redSqr().redISub(p.redAdd(p)),T=p.redISub(_),w=l.redSqr();w=w.redIAdd(w),w=w.redIAdd(w),w=w.redIAdd(w);var M=v.redMul(T).redISub(w),A=i.redAdd(i).redMul(r);return this.curve.jpoint(_,M,A)},d.prototype.trpl=function(){if(!this.curve.zeroA)return this.dbl().add(this);var a=this.x.redSqr(),n=this.y.redSqr(),i=this.z.redSqr(),r=n.redSqr(),s=a.redAdd(a).redIAdd(a),o=s.redSqr(),l=this.x.redAdd(n).redSqr().redISub(a).redISub(r);l=l.redIAdd(l),l=l.redAdd(l).redIAdd(l),l=l.redISub(o);var v=l.redSqr(),f=r.redIAdd(r);f=f.redIAdd(f),f=f.redIAdd(f),f=f.redIAdd(f);var p=s.redIAdd(l).redSqr().redISub(o).redISub(v).redISub(f),_=n.redMul(p);_=_.redIAdd(_),_=_.redIAdd(_);var T=this.x.redMul(v).redISub(_);T=T.redIAdd(T),T=T.redIAdd(T);var w=this.y.redMul(p.redMul(f.redISub(p)).redISub(l.redMul(v)));w=w.redIAdd(w),w=w.redIAdd(w),w=w.redIAdd(w);var M=this.z.redAdd(l).redSqr().redISub(i).redISub(v);return this.curve.jpoint(T,w,M)},d.prototype.mul=function(a,n){return a=new g(a,n),this.curve._wnafMul(this,a)},d.prototype.eq=function(a){if(a.type==="affine")return this.eq(a.toJ());if(this===a)return!0;var n=this.z.redSqr(),i=a.z.redSqr();if(this.x.redMul(i).redISub(a.x.redMul(n)).cmpn(0)!==0)return!1;var r=n.redMul(this.z),s=i.redMul(a.z);return this.y.redMul(s).redISub(a.y.redMul(r)).cmpn(0)===0},d.prototype.eqXToP=function(a){var n=this.z.redSqr(),i=a.toRed(this.curve.red).redMul(n);if(this.x.cmp(i)===0)return!0;for(var r=a.clone(),s=this.curve.redN.redMul(n);;){if(r.iadd(this.curve.n),r.cmp(this.curve.p)>=0)return!1;if(i.redIAdd(s),this.x.cmp(i)===0)return!0}},d.prototype.inspect=function(){return this.isInfinity()?"<EC JPoint Infinity>":"<EC JPoint x: "+this.x.toString(16,2)+" y: "+this.y.toString(16,2)+" z: "+this.z.toString(16,2)+">"},d.prototype.isInfinity=function(){return this.z.cmpn(0)===0}},{"../utils":103,"./base":90,"bn.js":18,inherits:146}],95:[function(t,E,e){var u=e,g=t("hash.js"),S=t("./curve"),y=t("./utils"),c=y.assert;function m(b){b.type==="short"?this.curve=new S.short(b):b.type==="edwards"?this.curve=new S.edwards(b):this.curve=new S.mont(b),this.g=this.curve.g,this.n=this.curve.n,this.hash=b.hash,c(this.g.validate(),"Invalid curve"),c(this.g.mul(this.n).isInfinity(),"Invalid curve, G*N != O")}u.PresetCurve=m;function h(b,a){Object.defineProperty(u,b,{configurable:!0,enumerable:!0,get:function(){var n=new m(a);return Object.defineProperty(u,b,{configurable:!0,enumerable:!0,value:n}),n}})}h("p192",{type:"short",prime:"p192",p:"ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff",a:"ffffffff ffffffff ffffffff fffffffe ffffffff fffffffc",b:"64210519 e59c80e7 0fa7e9ab 72243049 feb8deec c146b9b1",n:"ffffffff ffffffff ffffffff 99def836 146bc9b1 b4d22831",hash:g.sha256,gRed:!1,g:["188da80e b03090f6 7cbf20eb 43a18800 f4ff0afd 82ff1012","07192b95 ffc8da78 631011ed 6b24cdd5 73f977a1 1e794811"]}),h("p224",{type:"short",prime:"p224",p:"ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001",a:"ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff fffffffe",b:"b4050a85 0c04b3ab f5413256 5044b0b7 d7bfd8ba 270b3943 2355ffb4",n:"ffffffff ffffffff ffffffff ffff16a2 e0b8f03e 13dd2945 5c5c2a3d",hash:g.sha256,gRed:!1,g:["b70e0cbd 6bb4bf7f 321390b9 4a03c1d3 56c21122 343280d6 115c1d21","bd376388 b5f723fb 4c22dfe6 cd4375a0 5a074764 44d58199 85007e34"]}),h("p256",{type:"short",prime:null,p:"ffffffff 00000001 00000000 00000000 00000000 ffffffff ffffffff ffffffff",a:"ffffffff 00000001 00000000 00000000 00000000 ffffffff ffffffff fffffffc",b:"5ac635d8 aa3a93e7 b3ebbd55 769886bc 651d06b0 cc53b0f6 3bce3c3e 27d2604b",n:"ffffffff 00000000 ffffffff ffffffff bce6faad a7179e84 f3b9cac2 fc632551",hash:g.sha256,gRed:!1,g:["6b17d1f2 e12c4247 f8bce6e5 63a440f2 77037d81 2deb33a0 f4a13945 d898c296","4fe342e2 fe1a7f9b 8ee7eb4a 7c0f9e16 2bce3357 6b315ece cbb64068 37bf51f5"]}),h("p384",{type:"short",prime:null,p:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe ffffffff 00000000 00000000 ffffffff",a:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe ffffffff 00000000 00000000 fffffffc",b:"b3312fa7 e23ee7e4 988e056b e3f82d19 181d9c6e fe814112 0314088f 5013875a c656398d 8a2ed19d 2a85c8ed d3ec2aef",n:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff c7634d81 f4372ddf 581a0db2 48b0a77a ecec196a ccc52973",hash:g.sha384,gRed:!1,g:["aa87ca22 be8b0537 8eb1c71e f320ad74 6e1d3b62 8ba79b98 59f741e0 82542a38 5502f25d bf55296c 3a545e38 72760ab7","3617de4a 96262c6f 5d9e98bf 9292dc29 f8f41dbd 289a147c e9da3113 b5f0b8c0 0a60b1ce 1d7e819d 7a431d7c 90ea0e5f"]}),h("p521",{type:"short",prime:null,p:"000001ff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff",a:"000001ff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffc",b:"00000051 953eb961 8e1c9a1f 929a21a0 b68540ee a2da725b 99b315f3 b8b48991 8ef109e1 56193951 ec7e937b 1652c0bd 3bb1bf07 3573df88 3d2c34f1 ef451fd4 6b503f00",n:"000001ff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffa 51868783 bf2f966b 7fcc0148 f709a5d0 3bb5c9b8 899c47ae bb6fb71e 91386409",hash:g.sha512,gRed:!1,g:["000000c6 858e06b7 0404e9cd 9e3ecb66 2395b442 9c648139 053fb521 f828af60 6b4d3dba a14b5e77 efe75928 fe1dc127 a2ffa8de 3348b3c1 856a429b f97e7e31 c2e5bd66","00000118 39296a78 9a3bc004 5c8a5fb4 2c7d1bd9 98f54449 579b4468 17afbd17 273e662c 97ee7299 5ef42640 c550b901 3fad0761 353c7086 a272c240 88be9476 9fd16650"]}),h("curve25519",{type:"mont",prime:"p25519",p:"7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed",a:"76d06",b:"1",n:"1000000000000000 0000000000000000 14def9dea2f79cd6 5812631a5cf5d3ed",hash:g.sha256,gRed:!1,g:["9"]}),h("ed25519",{type:"edwards",prime:"p25519",p:"7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed",a:"-1",c:"1",d:"52036cee2b6ffe73 8cc740797779e898 00700a4d4141d8ab 75eb4dca135978a3",n:"1000000000000000 0000000000000000 14def9dea2f79cd6 5812631a5cf5d3ed",hash:g.sha256,gRed:!1,g:["216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a","6666666666666666666666666666666666666666666666666666666666666658"]});var d;try{d=t("./precomputed/secp256k1")}catch{d=void 0}h("secp256k1",{type:"short",prime:"k256",p:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f",a:"0",b:"7",n:"ffffffff ffffffff ffffffff fffffffe baaedce6 af48a03b bfd25e8c d0364141",h:"1",hash:g.sha256,beta:"7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee",lambda:"5363ad4cc05c30e0a5261c028812645a122e22ea20816678df02967c1b23bd72",basis:[{a:"3086d221a7d46bcde86c90e49284eb15",b:"-e4437ed6010e88286f547fa90abfe4c3"},{a:"114ca50f7a8e2f3f657c1108d9d44cfd8",b:"3086d221a7d46bcde86c90e49284eb15"}],gRed:!1,g:["79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798","483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8",d]})},{"./curve":92,"./precomputed/secp256k1":102,"./utils":103,"hash.js":132}],96:[function(t,E,e){var u=t("bn.js"),g=t("hmac-drbg"),S=t("../utils"),y=t("../curves"),c=t("brorand"),m=S.assert,h=t("./key"),d=t("./signature");function b(a){if(!(this instanceof b))return new b(a);typeof a=="string"&&(m(Object.prototype.hasOwnProperty.call(y,a),"Unknown curve "+a),a=y[a]),a instanceof y.PresetCurve&&(a={curve:a}),this.curve=a.curve.curve,this.n=this.curve.n,this.nh=this.n.ushrn(1),this.g=this.curve.g,this.g=a.curve.g,this.g.precompute(a.curve.n.bitLength()+1),this.hash=a.hash||a.curve.hash}E.exports=b,b.prototype.keyPair=function(n){return new h(this,n)},b.prototype.keyFromPrivate=function(n,i){return h.fromPrivate(this,n,i)},b.prototype.keyFromPublic=function(n,i){return h.fromPublic(this,n,i)},b.prototype.genKeyPair=function(n){n||(n={});for(var i=new g({hash:this.hash,pers:n.pers,persEnc:n.persEnc||"utf8",entropy:n.entropy||c(this.hash.hmacStrength),entropyEnc:n.entropy&&n.entropyEnc||"utf8",nonce:this.n.toArray()}),r=this.n.byteLength(),s=this.n.sub(new u(2));;){var o=new u(i.generate(r));if(!(o.cmp(s)>0))return o.iaddn(1),this.keyFromPrivate(o)}},b.prototype._truncateToN=function(n,i){var r=n.byteLength()*8-this.n.bitLength();return r>0&&(n=n.ushrn(r)),!i&&n.cmp(this.n)>=0?n.sub(this.n):n},b.prototype.sign=function(n,i,r,s){typeof r=="object"&&(s=r,r=null),s||(s={}),i=this.keyFromPrivate(i,r),n=this._truncateToN(new u(n,16));for(var o=this.n.byteLength(),l=i.getPrivate().toArray("be",o),v=n.toArray("be",o),f=new g({hash:this.hash,entropy:l,nonce:v,pers:s.pers,persEnc:s.persEnc||"utf8"}),p=this.n.sub(new u(1)),_=0;;_++){var T=s.k?s.k(_):new u(f.generate(this.n.byteLength()));if(T=this._truncateToN(T,!0),!(T.cmpn(1)<=0||T.cmp(p)>=0)){var w=this.g.mul(T);if(!w.isInfinity()){var M=w.getX(),A=M.umod(this.n);if(A.cmpn(0)!==0){var W=T.invm(this.n).mul(A.mul(i.getPrivate()).iadd(n));if(W=W.umod(this.n),W.cmpn(0)!==0){var ee=(w.getY().isOdd()?1:0)|(M.cmp(A)!==0?2:0);return s.canonical&&W.cmp(this.nh)>0&&(W=this.n.sub(W),ee^=1),new d({r:A,s:W,recoveryParam:ee})}}}}}},b.prototype.verify=function(n,i,r,s){n=this._truncateToN(new u(n,16)),r=this.keyFromPublic(r,s),i=new d(i,"hex");var o=i.r,l=i.s;if(o.cmpn(1)<0||o.cmp(this.n)>=0||l.cmpn(1)<0||l.cmp(this.n)>=0)return!1;var v=l.invm(this.n),f=v.mul(n).umod(this.n),p=v.mul(o).umod(this.n),_;return this.curve._maxwellTrick?(_=this.g.jmulAdd(f,r.getPublic(),p),_.isInfinity()?!1:_.eqXToP(o)):(_=this.g.mulAdd(f,r.getPublic(),p),_.isInfinity()?!1:_.getX().umod(this.n).cmp(o)===0)},b.prototype.recoverPubKey=function(a,n,i,r){m((3&i)===i,"The recovery param is more than two bits"),n=new d(n,r);var s=this.n,o=new u(a),l=n.r,v=n.s,f=i&1,p=i>>1;if(l.cmp(this.curve.p.umod(this.curve.n))>=0&&p)throw new Error("Unable to find sencond key candinate");p?l=this.curve.pointFromX(l.add(this.curve.n),f):l=this.curve.pointFromX(l,f);var _=n.r.invm(s),T=s.sub(o).mul(_).umod(s),w=v.mul(_).umod(s);return this.g.mulAdd(T,l,w)},b.prototype.getKeyRecoveryParam=function(a,n,i,r){if(n=new d(n,r),n.recoveryParam!==null)return n.recoveryParam;for(var s=0;s<4;s++){var o;try{o=this.recoverPubKey(a,n,s)}catch{continue}if(o.eq(i))return s}throw new Error("Unable to find valid recovery factor")}},{"../curves":95,"../utils":103,"./key":97,"./signature":98,"bn.js":18,brorand:19,"hmac-drbg":144}],97:[function(t,E,e){var u=t("bn.js"),g=t("../utils"),S=g.assert;function y(c,m){this.ec=c,this.priv=null,this.pub=null,m.priv&&this._importPrivate(m.priv,m.privEnc),m.pub&&this._importPublic(m.pub,m.pubEnc)}E.exports=y,y.fromPublic=function(m,h,d){return h instanceof y?h:new y(m,{pub:h,pubEnc:d})},y.fromPrivate=function(m,h,d){return h instanceof y?h:new y(m,{priv:h,privEnc:d})},y.prototype.validate=function(){var m=this.getPublic();return m.isInfinity()?{result:!1,reason:"Invalid public key"}:m.validate()?m.mul(this.ec.curve.n).isInfinity()?{result:!0,reason:null}:{result:!1,reason:"Public key * N != O"}:{result:!1,reason:"Public key is not a point"}},y.prototype.getPublic=function(m,h){return typeof m=="string"&&(h=m,m=null),this.pub||(this.pub=this.ec.g.mul(this.priv)),h?this.pub.encode(h,m):this.pub},y.prototype.getPrivate=function(m){return m==="hex"?this.priv.toString(16,2):this.priv},y.prototype._importPrivate=function(m,h){this.priv=new u(m,h||16),this.priv=this.priv.umod(this.ec.curve.n)},y.prototype._importPublic=function(m,h){if(m.x||m.y){this.ec.curve.type==="mont"?S(m.x,"Need x coordinate"):(this.ec.curve.type==="short"||this.ec.curve.type==="edwards")&&S(m.x&&m.y,"Need both x and y coordinate"),this.pub=this.ec.curve.point(m.x,m.y);return}this.pub=this.ec.curve.decodePoint(m,h)},y.prototype.derive=function(m){return m.validate()||S(m.validate(),"public point not validated"),m.mul(this.priv).getX()},y.prototype.sign=function(m,h,d){return this.ec.sign(m,this,h,d)},y.prototype.verify=function(m,h){return this.ec.verify(m,h,this)},y.prototype.inspect=function(){return"<Key priv: "+(this.priv&&this.priv.toString(16,2))+" pub: "+(this.pub&&this.pub.inspect())+" >"}},{"../utils":103,"bn.js":18}],98:[function(t,E,e){var u=t("bn.js"),g=t("../utils"),S=g.assert;function y(b,a){if(b instanceof y)return b;this._importDER(b,a)||(S(b.r&&b.s,"Signature without r or s"),this.r=new u(b.r,16),this.s=new u(b.s,16),b.recoveryParam===void 0?this.recoveryParam=null:this.recoveryParam=b.recoveryParam)}E.exports=y;function c(){this.place=0}function m(b,a){var n=b[a.place++];if(!(n&128))return n;var i=n&15;if(i===0||i>4)return!1;for(var r=0,s=0,o=a.place;s<i;s++,o++)r<<=8,r|=b[o],r>>>=0;return r<=127?!1:(a.place=o,r)}function h(b){for(var a=0,n=b.length-1;!b[a]&&!(b[a+1]&128)&&a<n;)a++;return a===0?b:b.slice(a)}y.prototype._importDER=function(a,n){a=g.toArray(a,n);var i=new c;if(a[i.place++]!==48)return!1;var r=m(a,i);if(r===!1||r+i.place!==a.length||a[i.place++]!==2)return!1;var s=m(a,i);if(s===!1)return!1;var o=a.slice(i.place,s+i.place);if(i.place+=s,a[i.place++]!==2)return!1;var l=m(a,i);if(l===!1||a.length!==l+i.place)return!1;var v=a.slice(i.place,l+i.place);if(o[0]===0)if(o[1]&128)o=o.slice(1);else return!1;if(v[0]===0)if(v[1]&128)v=v.slice(1);else return!1;return this.r=new u(o),this.s=new u(v),this.recoveryParam=null,!0};function d(b,a){if(a<128){b.push(a);return}var n=1+(Math.log(a)/Math.LN2>>>3);for(b.push(n|128);--n;)b.push(a>>>(n<<3)&255);b.push(a)}y.prototype.toDER=function(a){var n=this.r.toArray(),i=this.s.toArray();for(n[0]&128&&(n=[0].concat(n)),i[0]&128&&(i=[0].concat(i)),n=h(n),i=h(i);!i[0]&&!(i[1]&128);)i=i.slice(1);var r=[2];d(r,n.length),r=r.concat(n),r.push(2),d(r,i.length);var s=r.concat(i),o=[48];return d(o,s.length),o=o.concat(s),g.encode(o,a)}},{"../utils":103,"bn.js":18}],99:[function(t,E,e){var u=t("hash.js"),g=t("../curves"),S=t("../utils"),y=S.assert,c=S.parseBytes,m=t("./key"),h=t("./signature");function d(b){if(y(b==="ed25519","only tested with ed25519 so far"),!(this instanceof d))return new d(b);b=g[b].curve,this.curve=b,this.g=b.g,this.g.precompute(b.n.bitLength()+1),this.pointClass=b.point().constructor,this.encodingLength=Math.ceil(b.n.bitLength()/8),this.hash=u.sha512}E.exports=d,d.prototype.sign=function(a,n){a=c(a);var i=this.keyFromSecret(n),r=this.hashInt(i.messagePrefix(),a),s=this.g.mul(r),o=this.encodePoint(s),l=this.hashInt(o,i.pubBytes(),a).mul(i.priv()),v=r.add(l).umod(this.curve.n);return this.makeSignature({R:s,S:v,Rencoded:o})},d.prototype.verify=function(a,n,i){a=c(a),n=this.makeSignature(n);var r=this.keyFromPublic(i),s=this.hashInt(n.Rencoded(),r.pubBytes(),a),o=this.g.mul(n.S()),l=n.R().add(r.pub().mul(s));return l.eq(o)},d.prototype.hashInt=function(){for(var a=this.hash(),n=0;n<arguments.length;n++)a.update(arguments[n]);return S.intFromLE(a.digest()).umod(this.curve.n)},d.prototype.keyFromPublic=function(a){return m.fromPublic(this,a)},d.prototype.keyFromSecret=function(a){return m.fromSecret(this,a)},d.prototype.makeSignature=function(a){return a instanceof h?a:new h(this,a)},d.prototype.encodePoint=function(a){var n=a.getY().toArray("le",this.encodingLength);return n[this.encodingLength-1]|=a.getX().isOdd()?128:0,n},d.prototype.decodePoint=function(a){a=S.parseBytes(a);var n=a.length-1,i=a.slice(0,n).concat(a[n]&-129),r=(a[n]&128)!==0,s=S.intFromLE(i);return this.curve.pointFromY(s,r)},d.prototype.encodeInt=function(a){return a.toArray("le",this.encodingLength)},d.prototype.decodeInt=function(a){return S.intFromLE(a)},d.prototype.isPoint=function(a){return a instanceof this.pointClass}},{"../curves":95,"../utils":103,"./key":100,"./signature":101,"hash.js":132}],100:[function(t,E,e){var u=t("../utils"),g=u.assert,S=u.parseBytes,y=u.cachedProperty;function c(m,h){this.eddsa=m,this._secret=S(h.secret),m.isPoint(h.pub)?this._pub=h.pub:this._pubBytes=S(h.pub)}c.fromPublic=function(h,d){return d instanceof c?d:new c(h,{pub:d})},c.fromSecret=function(h,d){return d instanceof c?d:new c(h,{secret:d})},c.prototype.secret=function(){return this._secret},y(c,"pubBytes",function(){return this.eddsa.encodePoint(this.pub())}),y(c,"pub",function(){return this._pubBytes?this.eddsa.decodePoint(this._pubBytes):this.eddsa.g.mul(this.priv())}),y(c,"privBytes",function(){var h=this.eddsa,d=this.hash(),b=h.encodingLength-1,a=d.slice(0,h.encodingLength);return a[0]&=248,a[b]&=127,a[b]|=64,a}),y(c,"priv",function(){return this.eddsa.decodeInt(this.privBytes())}),y(c,"hash",function(){return this.eddsa.hash().update(this.secret()).digest()}),y(c,"messagePrefix",function(){return this.hash().slice(this.eddsa.encodingLength)}),c.prototype.sign=function(h){return g(this._secret,"KeyPair can only verify"),this.eddsa.sign(h,this)},c.prototype.verify=function(h,d){return this.eddsa.verify(h,d,this)},c.prototype.getSecret=function(h){return g(this._secret,"KeyPair is public only"),u.encode(this.secret(),h)},c.prototype.getPublic=function(h){return u.encode(this.pubBytes(),h)},E.exports=c},{"../utils":103}],101:[function(t,E,e){var u=t("bn.js"),g=t("../utils"),S=g.assert,y=g.cachedProperty,c=g.parseBytes;function m(h,d){this.eddsa=h,typeof d!="object"&&(d=c(d)),Array.isArray(d)&&(d={R:d.slice(0,h.encodingLength),S:d.slice(h.encodingLength)}),S(d.R&&d.S,"Signature without R or S"),h.isPoint(d.R)&&(this._R=d.R),d.S instanceof u&&(this._S=d.S),this._Rencoded=Array.isArray(d.R)?d.R:d.Rencoded,this._Sencoded=Array.isArray(d.S)?d.S:d.Sencoded}y(m,"S",function(){return this.eddsa.decodeInt(this.Sencoded())}),y(m,"R",function(){return this.eddsa.decodePoint(this.Rencoded())}),y(m,"Rencoded",function(){return this.eddsa.encodePoint(this.R())}),y(m,"Sencoded",function(){return this.eddsa.encodeInt(this.S())}),m.prototype.toBytes=function(){return this.Rencoded().concat(this.Sencoded())},m.prototype.toHex=function(){return g.encode(this.toBytes(),"hex").toUpperCase()},E.exports=m},{"../utils":103,"bn.js":18}],102:[function(t,E,e){E.exports={doubles:{step:4,points:[["e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a","f7e3507399e595929db99f34f57937101296891e44d23f0be1f32cce69616821"],["8282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508","11f8a8098557dfe45e8256e830b60ace62d613ac2f7b17bed31b6eaff6e26caf"],["175e159f728b865a72f99cc6c6fc846de0b93833fd2222ed73fce5b551e5b739","d3506e0d9e3c79eba4ef97a51ff71f5eacb5955add24345c6efa6ffee9fed695"],["363d90d447b00c9c99ceac05b6262ee053441c7e55552ffe526bad8f83ff4640","4e273adfc732221953b445397f3363145b9a89008199ecb62003c7f3bee9de9"],["8b4b5f165df3c2be8c6244b5b745638843e4a781a15bcd1b69f79a55dffdf80c","4aad0a6f68d308b4b3fbd7813ab0da04f9e336546162ee56b3eff0c65fd4fd36"],["723cbaa6e5db996d6bf771c00bd548c7b700dbffa6c0e77bcb6115925232fcda","96e867b5595cc498a921137488824d6e2660a0653779494801dc069d9eb39f5f"],["eebfa4d493bebf98ba5feec812c2d3b50947961237a919839a533eca0e7dd7fa","5d9a8ca3970ef0f269ee7edaf178089d9ae4cdc3a711f712ddfd4fdae1de8999"],["100f44da696e71672791d0a09b7bde459f1215a29b3c03bfefd7835b39a48db0","cdd9e13192a00b772ec8f3300c090666b7ff4a18ff5195ac0fbd5cd62bc65a09"],["e1031be262c7ed1b1dc9227a4a04c017a77f8d4464f3b3852c8acde6e534fd2d","9d7061928940405e6bb6a4176597535af292dd419e1ced79a44f18f29456a00d"],["feea6cae46d55b530ac2839f143bd7ec5cf8b266a41d6af52d5e688d9094696d","e57c6b6c97dce1bab06e4e12bf3ecd5c981c8957cc41442d3155debf18090088"],["da67a91d91049cdcb367be4be6ffca3cfeed657d808583de33fa978bc1ec6cb1","9bacaa35481642bc41f463f7ec9780e5dec7adc508f740a17e9ea8e27a68be1d"],["53904faa0b334cdda6e000935ef22151ec08d0f7bb11069f57545ccc1a37b7c0","5bc087d0bc80106d88c9eccac20d3c1c13999981e14434699dcb096b022771c8"],["8e7bcd0bd35983a7719cca7764ca906779b53a043a9b8bcaeff959f43ad86047","10b7770b2a3da4b3940310420ca9514579e88e2e47fd68b3ea10047e8460372a"],["385eed34c1cdff21e6d0818689b81bde71a7f4f18397e6690a841e1599c43862","283bebc3e8ea23f56701de19e9ebf4576b304eec2086dc8cc0458fe5542e5453"],["6f9d9b803ecf191637c73a4413dfa180fddf84a5947fbc9c606ed86c3fac3a7","7c80c68e603059ba69b8e2a30e45c4d47ea4dd2f5c281002d86890603a842160"],["3322d401243c4e2582a2147c104d6ecbf774d163db0f5e5313b7e0e742d0e6bd","56e70797e9664ef5bfb019bc4ddaf9b72805f63ea2873af624f3a2e96c28b2a0"],["85672c7d2de0b7da2bd1770d89665868741b3f9af7643397721d74d28134ab83","7c481b9b5b43b2eb6374049bfa62c2e5e77f17fcc5298f44c8e3094f790313a6"],["948bf809b1988a46b06c9f1919413b10f9226c60f668832ffd959af60c82a0a","53a562856dcb6646dc6b74c5d1c3418c6d4dff08c97cd2bed4cb7f88d8c8e589"],["6260ce7f461801c34f067ce0f02873a8f1b0e44dfc69752accecd819f38fd8e8","bc2da82b6fa5b571a7f09049776a1ef7ecd292238051c198c1a84e95b2b4ae17"],["e5037de0afc1d8d43d8348414bbf4103043ec8f575bfdc432953cc8d2037fa2d","4571534baa94d3b5f9f98d09fb990bddbd5f5b03ec481f10e0e5dc841d755bda"],["e06372b0f4a207adf5ea905e8f1771b4e7e8dbd1c6a6c5b725866a0ae4fce725","7a908974bce18cfe12a27bb2ad5a488cd7484a7787104870b27034f94eee31dd"],["213c7a715cd5d45358d0bbf9dc0ce02204b10bdde2a3f58540ad6908d0559754","4b6dad0b5ae462507013ad06245ba190bb4850f5f36a7eeddff2c27534b458f2"],["4e7c272a7af4b34e8dbb9352a5419a87e2838c70adc62cddf0cc3a3b08fbd53c","17749c766c9d0b18e16fd09f6def681b530b9614bff7dd33e0b3941817dcaae6"],["fea74e3dbe778b1b10f238ad61686aa5c76e3db2be43057632427e2840fb27b6","6e0568db9b0b13297cf674deccb6af93126b596b973f7b77701d3db7f23cb96f"],["76e64113f677cf0e10a2570d599968d31544e179b760432952c02a4417bdde39","c90ddf8dee4e95cf577066d70681f0d35e2a33d2b56d2032b4b1752d1901ac01"],["c738c56b03b2abe1e8281baa743f8f9a8f7cc643df26cbee3ab150242bcbb891","893fb578951ad2537f718f2eacbfbbbb82314eef7880cfe917e735d9699a84c3"],["d895626548b65b81e264c7637c972877d1d72e5f3a925014372e9f6588f6c14b","febfaa38f2bc7eae728ec60818c340eb03428d632bb067e179363ed75d7d991f"],["b8da94032a957518eb0f6433571e8761ceffc73693e84edd49150a564f676e03","2804dfa44805a1e4d7c99cc9762808b092cc584d95ff3b511488e4e74efdf6e7"],["e80fea14441fb33a7d8adab9475d7fab2019effb5156a792f1a11778e3c0df5d","eed1de7f638e00771e89768ca3ca94472d155e80af322ea9fcb4291b6ac9ec78"],["a301697bdfcd704313ba48e51d567543f2a182031efd6915ddc07bbcc4e16070","7370f91cfb67e4f5081809fa25d40f9b1735dbf7c0a11a130c0d1a041e177ea1"],["90ad85b389d6b936463f9d0512678de208cc330b11307fffab7ac63e3fb04ed4","e507a3620a38261affdcbd9427222b839aefabe1582894d991d4d48cb6ef150"],["8f68b9d2f63b5f339239c1ad981f162ee88c5678723ea3351b7b444c9ec4c0da","662a9f2dba063986de1d90c2b6be215dbbea2cfe95510bfdf23cbf79501fff82"],["e4f3fb0176af85d65ff99ff9198c36091f48e86503681e3e6686fd5053231e11","1e63633ad0ef4f1c1661a6d0ea02b7286cc7e74ec951d1c9822c38576feb73bc"],["8c00fa9b18ebf331eb961537a45a4266c7034f2f0d4e1d0716fb6eae20eae29e","efa47267fea521a1a9dc343a3736c974c2fadafa81e36c54e7d2a4c66702414b"],["e7a26ce69dd4829f3e10cec0a9e98ed3143d084f308b92c0997fddfc60cb3e41","2a758e300fa7984b471b006a1aafbb18d0a6b2c0420e83e20e8a9421cf2cfd51"],["b6459e0ee3662ec8d23540c223bcbdc571cbcb967d79424f3cf29eb3de6b80ef","67c876d06f3e06de1dadf16e5661db3c4b3ae6d48e35b2ff30bf0b61a71ba45"],["d68a80c8280bb840793234aa118f06231d6f1fc67e73c5a5deda0f5b496943e8","db8ba9fff4b586d00c4b1f9177b0e28b5b0e7b8f7845295a294c84266b133120"],["324aed7df65c804252dc0270907a30b09612aeb973449cea4095980fc28d3d5d","648a365774b61f2ff130c0c35aec1f4f19213b0c7e332843967224af96ab7c84"],["4df9c14919cde61f6d51dfdbe5fee5dceec4143ba8d1ca888e8bd373fd054c96","35ec51092d8728050974c23a1d85d4b5d506cdc288490192ebac06cad10d5d"],["9c3919a84a474870faed8a9c1cc66021523489054d7f0308cbfc99c8ac1f98cd","ddb84f0f4a4ddd57584f044bf260e641905326f76c64c8e6be7e5e03d4fc599d"],["6057170b1dd12fdf8de05f281d8e06bb91e1493a8b91d4cc5a21382120a959e5","9a1af0b26a6a4807add9a2daf71df262465152bc3ee24c65e899be932385a2a8"],["a576df8e23a08411421439a4518da31880cef0fba7d4df12b1a6973eecb94266","40a6bf20e76640b2c92b97afe58cd82c432e10a7f514d9f3ee8be11ae1b28ec8"],["7778a78c28dec3e30a05fe9629de8c38bb30d1f5cf9a3a208f763889be58ad71","34626d9ab5a5b22ff7098e12f2ff580087b38411ff24ac563b513fc1fd9f43ac"],["928955ee637a84463729fd30e7afd2ed5f96274e5ad7e5cb09eda9c06d903ac","c25621003d3f42a827b78a13093a95eeac3d26efa8a8d83fc5180e935bcd091f"],["85d0fef3ec6db109399064f3a0e3b2855645b4a907ad354527aae75163d82751","1f03648413a38c0be29d496e582cf5663e8751e96877331582c237a24eb1f962"],["ff2b0dce97eece97c1c9b6041798b85dfdfb6d8882da20308f5404824526087e","493d13fef524ba188af4c4dc54d07936c7b7ed6fb90e2ceb2c951e01f0c29907"],["827fbbe4b1e880ea9ed2b2e6301b212b57f1ee148cd6dd28780e5e2cf856e241","c60f9c923c727b0b71bef2c67d1d12687ff7a63186903166d605b68baec293ec"],["eaa649f21f51bdbae7be4ae34ce6e5217a58fdce7f47f9aa7f3b58fa2120e2b3","be3279ed5bbbb03ac69a80f89879aa5a01a6b965f13f7e59d47a5305ba5ad93d"],["e4a42d43c5cf169d9391df6decf42ee541b6d8f0c9a137401e23632dda34d24f","4d9f92e716d1c73526fc99ccfb8ad34ce886eedfa8d8e4f13a7f7131deba9414"],["1ec80fef360cbdd954160fadab352b6b92b53576a88fea4947173b9d4300bf19","aeefe93756b5340d2f3a4958a7abbf5e0146e77f6295a07b671cdc1cc107cefd"],["146a778c04670c2f91b00af4680dfa8bce3490717d58ba889ddb5928366642be","b318e0ec3354028add669827f9d4b2870aaa971d2f7e5ed1d0b297483d83efd0"],["fa50c0f61d22e5f07e3acebb1aa07b128d0012209a28b9776d76a8793180eef9","6b84c6922397eba9b72cd2872281a68a5e683293a57a213b38cd8d7d3f4f2811"],["da1d61d0ca721a11b1a5bf6b7d88e8421a288ab5d5bba5220e53d32b5f067ec2","8157f55a7c99306c79c0766161c91e2966a73899d279b48a655fba0f1ad836f1"],["a8e282ff0c9706907215ff98e8fd416615311de0446f1e062a73b0610d064e13","7f97355b8db81c09abfb7f3c5b2515888b679a3e50dd6bd6cef7c73111f4cc0c"],["174a53b9c9a285872d39e56e6913cab15d59b1fa512508c022f382de8319497c","ccc9dc37abfc9c1657b4155f2c47f9e6646b3a1d8cb9854383da13ac079afa73"],["959396981943785c3d3e57edf5018cdbe039e730e4918b3d884fdff09475b7ba","2e7e552888c331dd8ba0386a4b9cd6849c653f64c8709385e9b8abf87524f2fd"],["d2a63a50ae401e56d645a1153b109a8fcca0a43d561fba2dbb51340c9d82b151","e82d86fb6443fcb7565aee58b2948220a70f750af484ca52d4142174dcf89405"],["64587e2335471eb890ee7896d7cfdc866bacbdbd3839317b3436f9b45617e073","d99fcdd5bf6902e2ae96dd6447c299a185b90a39133aeab358299e5e9faf6589"],["8481bde0e4e4d885b3a546d3e549de042f0aa6cea250e7fd358d6c86dd45e458","38ee7b8cba5404dd84a25bf39cecb2ca900a79c42b262e556d64b1b59779057e"],["13464a57a78102aa62b6979ae817f4637ffcfed3c4b1ce30bcd6303f6caf666b","69be159004614580ef7e433453ccb0ca48f300a81d0942e13f495a907f6ecc27"],["bc4a9df5b713fe2e9aef430bcc1dc97a0cd9ccede2f28588cada3a0d2d83f366","d3a81ca6e785c06383937adf4b798caa6e8a9fbfa547b16d758d666581f33c1"],["8c28a97bf8298bc0d23d8c749452a32e694b65e30a9472a3954ab30fe5324caa","40a30463a3305193378fedf31f7cc0eb7ae784f0451cb9459e71dc73cbef9482"],["8ea9666139527a8c1dd94ce4f071fd23c8b350c5a4bb33748c4ba111faccae0","620efabbc8ee2782e24e7c0cfb95c5d735b783be9cf0f8e955af34a30e62b945"],["dd3625faef5ba06074669716bbd3788d89bdde815959968092f76cc4eb9a9787","7a188fa3520e30d461da2501045731ca941461982883395937f68d00c644a573"],["f710d79d9eb962297e4f6232b40e8f7feb2bc63814614d692c12de752408221e","ea98e67232d3b3295d3b535532115ccac8612c721851617526ae47a9c77bfc82"]]},naf:{wnd:7,points:[["f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9","388f7b0f632de8140fe337e62a37f3566500a99934c2231b6cb9fd7584b8e672"],["2f8bde4d1a07209355b4a7250a5c5128e88b84bddc619ab7cba8d569b240efe4","d8ac222636e5e3d6d4dba9dda6c9c426f788271bab0d6840dca87d3aa6ac62d6"],["5cbdf0646e5db4eaa398f365f2ea7a0e3d419b7e0330e39ce92bddedcac4f9bc","6aebca40ba255960a3178d6d861a54dba813d0b813fde7b5a5082628087264da"],["acd484e2f0c7f65309ad178a9f559abde09796974c57e714c35f110dfc27ccbe","cc338921b0a7d9fd64380971763b61e9add888a4375f8e0f05cc262ac64f9c37"],["774ae7f858a9411e5ef4246b70c65aac5649980be5c17891bbec17895da008cb","d984a032eb6b5e190243dd56d7b7b365372db1e2dff9d6a8301d74c9c953c61b"],["f28773c2d975288bc7d1d205c3748651b075fbc6610e58cddeeddf8f19405aa8","ab0902e8d880a89758212eb65cdaf473a1a06da521fa91f29b5cb52db03ed81"],["d7924d4f7d43ea965a465ae3095ff41131e5946f3c85f79e44adbcf8e27e080e","581e2872a86c72a683842ec228cc6defea40af2bd896d3a5c504dc9ff6a26b58"],["defdea4cdb677750a420fee807eacf21eb9898ae79b9768766e4faa04a2d4a34","4211ab0694635168e997b0ead2a93daeced1f4a04a95c0f6cfb199f69e56eb77"],["2b4ea0a797a443d293ef5cff444f4979f06acfebd7e86d277475656138385b6c","85e89bc037945d93b343083b5a1c86131a01f60c50269763b570c854e5c09b7a"],["352bbf4a4cdd12564f93fa332ce333301d9ad40271f8107181340aef25be59d5","321eb4075348f534d59c18259dda3e1f4a1b3b2e71b1039c67bd3d8bcf81998c"],["2fa2104d6b38d11b0230010559879124e42ab8dfeff5ff29dc9cdadd4ecacc3f","2de1068295dd865b64569335bd5dd80181d70ecfc882648423ba76b532b7d67"],["9248279b09b4d68dab21a9b066edda83263c3d84e09572e269ca0cd7f5453714","73016f7bf234aade5d1aa71bdea2b1ff3fc0de2a887912ffe54a32ce97cb3402"],["daed4f2be3a8bf278e70132fb0beb7522f570e144bf615c07e996d443dee8729","a69dce4a7d6c98e8d4a1aca87ef8d7003f83c230f3afa726ab40e52290be1c55"],["c44d12c7065d812e8acf28d7cbb19f9011ecd9e9fdf281b0e6a3b5e87d22e7db","2119a460ce326cdc76c45926c982fdac0e106e861edf61c5a039063f0e0e6482"],["6a245bf6dc698504c89a20cfded60853152b695336c28063b61c65cbd269e6b4","e022cf42c2bd4a708b3f5126f16a24ad8b33ba48d0423b6efd5e6348100d8a82"],["1697ffa6fd9de627c077e3d2fe541084ce13300b0bec1146f95ae57f0d0bd6a5","b9c398f186806f5d27561506e4557433a2cf15009e498ae7adee9d63d01b2396"],["605bdb019981718b986d0f07e834cb0d9deb8360ffb7f61df982345ef27a7479","2972d2de4f8d20681a78d93ec96fe23c26bfae84fb14db43b01e1e9056b8c49"],["62d14dab4150bf497402fdc45a215e10dcb01c354959b10cfe31c7e9d87ff33d","80fc06bd8cc5b01098088a1950eed0db01aa132967ab472235f5642483b25eaf"],["80c60ad0040f27dade5b4b06c408e56b2c50e9f56b9b8b425e555c2f86308b6f","1c38303f1cc5c30f26e66bad7fe72f70a65eed4cbe7024eb1aa01f56430bd57a"],["7a9375ad6167ad54aa74c6348cc54d344cc5dc9487d847049d5eabb0fa03c8fb","d0e3fa9eca8726909559e0d79269046bdc59ea10c70ce2b02d499ec224dc7f7"],["d528ecd9b696b54c907a9ed045447a79bb408ec39b68df504bb51f459bc3ffc9","eecf41253136e5f99966f21881fd656ebc4345405c520dbc063465b521409933"],["49370a4b5f43412ea25f514e8ecdad05266115e4a7ecb1387231808f8b45963","758f3f41afd6ed428b3081b0512fd62a54c3f3afbb5b6764b653052a12949c9a"],["77f230936ee88cbbd73df930d64702ef881d811e0e1498e2f1c13eb1fc345d74","958ef42a7886b6400a08266e9ba1b37896c95330d97077cbbe8eb3c7671c60d6"],["f2dac991cc4ce4b9ea44887e5c7c0bce58c80074ab9d4dbaeb28531b7739f530","e0dedc9b3b2f8dad4da1f32dec2531df9eb5fbeb0598e4fd1a117dba703a3c37"],["463b3d9f662621fb1b4be8fbbe2520125a216cdfc9dae3debcba4850c690d45b","5ed430d78c296c3543114306dd8622d7c622e27c970a1de31cb377b01af7307e"],["f16f804244e46e2a09232d4aff3b59976b98fac14328a2d1a32496b49998f247","cedabd9b82203f7e13d206fcdf4e33d92a6c53c26e5cce26d6579962c4e31df6"],["caf754272dc84563b0352b7a14311af55d245315ace27c65369e15f7151d41d1","cb474660ef35f5f2a41b643fa5e460575f4fa9b7962232a5c32f908318a04476"],["2600ca4b282cb986f85d0f1709979d8b44a09c07cb86d7c124497bc86f082120","4119b88753c15bd6a693b03fcddbb45d5ac6be74ab5f0ef44b0be9475a7e4b40"],["7635ca72d7e8432c338ec53cd12220bc01c48685e24f7dc8c602a7746998e435","91b649609489d613d1d5e590f78e6d74ecfc061d57048bad9e76f302c5b9c61"],["754e3239f325570cdbbf4a87deee8a66b7f2b33479d468fbc1a50743bf56cc18","673fb86e5bda30fb3cd0ed304ea49a023ee33d0197a695d0c5d98093c536683"],["e3e6bd1071a1e96aff57859c82d570f0330800661d1c952f9fe2694691d9b9e8","59c9e0bba394e76f40c0aa58379a3cb6a5a2283993e90c4167002af4920e37f5"],["186b483d056a033826ae73d88f732985c4ccb1f32ba35f4b4cc47fdcf04aa6eb","3b952d32c67cf77e2e17446e204180ab21fb8090895138b4a4a797f86e80888b"],["df9d70a6b9876ce544c98561f4be4f725442e6d2b737d9c91a8321724ce0963f","55eb2dafd84d6ccd5f862b785dc39d4ab157222720ef9da217b8c45cf2ba2417"],["5edd5cc23c51e87a497ca815d5dce0f8ab52554f849ed8995de64c5f34ce7143","efae9c8dbc14130661e8cec030c89ad0c13c66c0d17a2905cdc706ab7399a868"],["290798c2b6476830da12fe02287e9e777aa3fba1c355b17a722d362f84614fba","e38da76dcd440621988d00bcf79af25d5b29c094db2a23146d003afd41943e7a"],["af3c423a95d9f5b3054754efa150ac39cd29552fe360257362dfdecef4053b45","f98a3fd831eb2b749a93b0e6f35cfb40c8cd5aa667a15581bc2feded498fd9c6"],["766dbb24d134e745cccaa28c99bf274906bb66b26dcf98df8d2fed50d884249a","744b1152eacbe5e38dcc887980da38b897584a65fa06cedd2c924f97cbac5996"],["59dbf46f8c94759ba21277c33784f41645f7b44f6c596a58ce92e666191abe3e","c534ad44175fbc300f4ea6ce648309a042ce739a7919798cd85e216c4a307f6e"],["f13ada95103c4537305e691e74e9a4a8dd647e711a95e73cb62dc6018cfd87b8","e13817b44ee14de663bf4bc808341f326949e21a6a75c2570778419bdaf5733d"],["7754b4fa0e8aced06d4167a2c59cca4cda1869c06ebadfb6488550015a88522c","30e93e864e669d82224b967c3020b8fa8d1e4e350b6cbcc537a48b57841163a2"],["948dcadf5990e048aa3874d46abef9d701858f95de8041d2a6828c99e2262519","e491a42537f6e597d5d28a3224b1bc25df9154efbd2ef1d2cbba2cae5347d57e"],["7962414450c76c1689c7b48f8202ec37fb224cf5ac0bfa1570328a8a3d7c77ab","100b610ec4ffb4760d5c1fc133ef6f6b12507a051f04ac5760afa5b29db83437"],["3514087834964b54b15b160644d915485a16977225b8847bb0dd085137ec47ca","ef0afbb2056205448e1652c48e8127fc6039e77c15c2378b7e7d15a0de293311"],["d3cc30ad6b483e4bc79ce2c9dd8bc54993e947eb8df787b442943d3f7b527eaf","8b378a22d827278d89c5e9be8f9508ae3c2ad46290358630afb34db04eede0a4"],["1624d84780732860ce1c78fcbfefe08b2b29823db913f6493975ba0ff4847610","68651cf9b6da903e0914448c6cd9d4ca896878f5282be4c8cc06e2a404078575"],["733ce80da955a8a26902c95633e62a985192474b5af207da6df7b4fd5fc61cd4","f5435a2bd2badf7d485a4d8b8db9fcce3e1ef8e0201e4578c54673bc1dc5ea1d"],["15d9441254945064cf1a1c33bbd3b49f8966c5092171e699ef258dfab81c045c","d56eb30b69463e7234f5137b73b84177434800bacebfc685fc37bbe9efe4070d"],["a1d0fcf2ec9de675b612136e5ce70d271c21417c9d2b8aaaac138599d0717940","edd77f50bcb5a3cab2e90737309667f2641462a54070f3d519212d39c197a629"],["e22fbe15c0af8ccc5780c0735f84dbe9a790badee8245c06c7ca37331cb36980","a855babad5cd60c88b430a69f53a1a7a38289154964799be43d06d77d31da06"],["311091dd9860e8e20ee13473c1155f5f69635e394704eaa74009452246cfa9b3","66db656f87d1f04fffd1f04788c06830871ec5a64feee685bd80f0b1286d8374"],["34c1fd04d301be89b31c0442d3e6ac24883928b45a9340781867d4232ec2dbdf","9414685e97b1b5954bd46f730174136d57f1ceeb487443dc5321857ba73abee"],["f219ea5d6b54701c1c14de5b557eb42a8d13f3abbcd08affcc2a5e6b049b8d63","4cb95957e83d40b0f73af4544cccf6b1f4b08d3c07b27fb8d8c2962a400766d1"],["d7b8740f74a8fbaab1f683db8f45de26543a5490bca627087236912469a0b448","fa77968128d9c92ee1010f337ad4717eff15db5ed3c049b3411e0315eaa4593b"],["32d31c222f8f6f0ef86f7c98d3a3335ead5bcd32abdd94289fe4d3091aa824bf","5f3032f5892156e39ccd3d7915b9e1da2e6dac9e6f26e961118d14b8462e1661"],["7461f371914ab32671045a155d9831ea8793d77cd59592c4340f86cbc18347b5","8ec0ba238b96bec0cbdddcae0aa442542eee1ff50c986ea6b39847b3cc092ff6"],["ee079adb1df1860074356a25aa38206a6d716b2c3e67453d287698bad7b2b2d6","8dc2412aafe3be5c4c5f37e0ecc5f9f6a446989af04c4e25ebaac479ec1c8c1e"],["16ec93e447ec83f0467b18302ee620f7e65de331874c9dc72bfd8616ba9da6b5","5e4631150e62fb40d0e8c2a7ca5804a39d58186a50e497139626778e25b0674d"],["eaa5f980c245f6f038978290afa70b6bd8855897f98b6aa485b96065d537bd99","f65f5d3e292c2e0819a528391c994624d784869d7e6ea67fb18041024edc07dc"],["78c9407544ac132692ee1910a02439958ae04877151342ea96c4b6b35a49f51","f3e0319169eb9b85d5404795539a5e68fa1fbd583c064d2462b675f194a3ddb4"],["494f4be219a1a77016dcd838431aea0001cdc8ae7a6fc688726578d9702857a5","42242a969283a5f339ba7f075e36ba2af925ce30d767ed6e55f4b031880d562c"],["a598a8030da6d86c6bc7f2f5144ea549d28211ea58faa70ebf4c1e665c1fe9b5","204b5d6f84822c307e4b4a7140737aec23fc63b65b35f86a10026dbd2d864e6b"],["c41916365abb2b5d09192f5f2dbeafec208f020f12570a184dbadc3e58595997","4f14351d0087efa49d245b328984989d5caf9450f34bfc0ed16e96b58fa9913"],["841d6063a586fa475a724604da03bc5b92a2e0d2e0a36acfe4c73a5514742881","73867f59c0659e81904f9a1c7543698e62562d6744c169ce7a36de01a8d6154"],["5e95bb399a6971d376026947f89bde2f282b33810928be4ded112ac4d70e20d5","39f23f366809085beebfc71181313775a99c9aed7d8ba38b161384c746012865"],["36e4641a53948fd476c39f8a99fd974e5ec07564b5315d8bf99471bca0ef2f66","d2424b1b1abe4eb8164227b085c9aa9456ea13493fd563e06fd51cf5694c78fc"],["336581ea7bfbbb290c191a2f507a41cf5643842170e914faeab27c2c579f726","ead12168595fe1be99252129b6e56b3391f7ab1410cd1e0ef3dcdcabd2fda224"],["8ab89816dadfd6b6a1f2634fcf00ec8403781025ed6890c4849742706bd43ede","6fdcef09f2f6d0a044e654aef624136f503d459c3e89845858a47a9129cdd24e"],["1e33f1a746c9c5778133344d9299fcaa20b0938e8acff2544bb40284b8c5fb94","60660257dd11b3aa9c8ed618d24edff2306d320f1d03010e33a7d2057f3b3b6"],["85b7c1dcb3cec1b7ee7f30ded79dd20a0ed1f4cc18cbcfcfa410361fd8f08f31","3d98a9cdd026dd43f39048f25a8847f4fcafad1895d7a633c6fed3c35e999511"],["29df9fbd8d9e46509275f4b125d6d45d7fbe9a3b878a7af872a2800661ac5f51","b4c4fe99c775a606e2d8862179139ffda61dc861c019e55cd2876eb2a27d84b"],["a0b1cae06b0a847a3fea6e671aaf8adfdfe58ca2f768105c8082b2e449fce252","ae434102edde0958ec4b19d917a6a28e6b72da1834aff0e650f049503a296cf2"],["4e8ceafb9b3e9a136dc7ff67e840295b499dfb3b2133e4ba113f2e4c0e121e5","cf2174118c8b6d7a4b48f6d534ce5c79422c086a63460502b827ce62a326683c"],["d24a44e047e19b6f5afb81c7ca2f69080a5076689a010919f42725c2b789a33b","6fb8d5591b466f8fc63db50f1c0f1c69013f996887b8244d2cdec417afea8fa3"],["ea01606a7a6c9cdd249fdfcfacb99584001edd28abbab77b5104e98e8e3b35d4","322af4908c7312b0cfbfe369f7a7b3cdb7d4494bc2823700cfd652188a3ea98d"],["af8addbf2b661c8a6c6328655eb96651252007d8c5ea31be4ad196de8ce2131f","6749e67c029b85f52a034eafd096836b2520818680e26ac8f3dfbcdb71749700"],["e3ae1974566ca06cc516d47e0fb165a674a3dabcfca15e722f0e3450f45889","2aeabe7e4531510116217f07bf4d07300de97e4874f81f533420a72eeb0bd6a4"],["591ee355313d99721cf6993ffed1e3e301993ff3ed258802075ea8ced397e246","b0ea558a113c30bea60fc4775460c7901ff0b053d25ca2bdeee98f1a4be5d196"],["11396d55fda54c49f19aa97318d8da61fa8584e47b084945077cf03255b52984","998c74a8cd45ac01289d5833a7beb4744ff536b01b257be4c5767bea93ea57a4"],["3c5d2a1ba39c5a1790000738c9e0c40b8dcdfd5468754b6405540157e017aa7a","b2284279995a34e2f9d4de7396fc18b80f9b8b9fdd270f6661f79ca4c81bd257"],["cc8704b8a60a0defa3a99a7299f2e9c3fbc395afb04ac078425ef8a1793cc030","bdd46039feed17881d1e0862db347f8cf395b74fc4bcdc4e940b74e3ac1f1b13"],["c533e4f7ea8555aacd9777ac5cad29b97dd4defccc53ee7ea204119b2889b197","6f0a256bc5efdf429a2fb6242f1a43a2d9b925bb4a4b3a26bb8e0f45eb596096"],["c14f8f2ccb27d6f109f6d08d03cc96a69ba8c34eec07bbcf566d48e33da6593","c359d6923bb398f7fd4473e16fe1c28475b740dd098075e6c0e8649113dc3a38"],["a6cbc3046bc6a450bac24789fa17115a4c9739ed75f8f21ce441f72e0b90e6ef","21ae7f4680e889bb130619e2c0f95a360ceb573c70603139862afd617fa9b9f"],["347d6d9a02c48927ebfb86c1359b1caf130a3c0267d11ce6344b39f99d43cc38","60ea7f61a353524d1c987f6ecec92f086d565ab687870cb12689ff1e31c74448"],["da6545d2181db8d983f7dcb375ef5866d47c67b1bf31c8cf855ef7437b72656a","49b96715ab6878a79e78f07ce5680c5d6673051b4935bd897fea824b77dc208a"],["c40747cc9d012cb1a13b8148309c6de7ec25d6945d657146b9d5994b8feb1111","5ca560753be2a12fc6de6caf2cb489565db936156b9514e1bb5e83037e0fa2d4"],["4e42c8ec82c99798ccf3a610be870e78338c7f713348bd34c8203ef4037f3502","7571d74ee5e0fb92a7a8b33a07783341a5492144cc54bcc40a94473693606437"],["3775ab7089bc6af823aba2e1af70b236d251cadb0c86743287522a1b3b0dedea","be52d107bcfa09d8bcb9736a828cfa7fac8db17bf7a76a2c42ad961409018cf7"],["cee31cbf7e34ec379d94fb814d3d775ad954595d1314ba8846959e3e82f74e26","8fd64a14c06b589c26b947ae2bcf6bfa0149ef0be14ed4d80f448a01c43b1c6d"],["b4f9eaea09b6917619f6ea6a4eb5464efddb58fd45b1ebefcdc1a01d08b47986","39e5c9925b5a54b07433a4f18c61726f8bb131c012ca542eb24a8ac07200682a"],["d4263dfc3d2df923a0179a48966d30ce84e2515afc3dccc1b77907792ebcc60e","62dfaf07a0f78feb30e30d6295853ce189e127760ad6cf7fae164e122a208d54"],["48457524820fa65a4f8d35eb6930857c0032acc0a4a2de422233eeda897612c4","25a748ab367979d98733c38a1fa1c2e7dc6cc07db2d60a9ae7a76aaa49bd0f77"],["dfeeef1881101f2cb11644f3a2afdfc2045e19919152923f367a1767c11cceda","ecfb7056cf1de042f9420bab396793c0c390bde74b4bbdff16a83ae09a9a7517"],["6d7ef6b17543f8373c573f44e1f389835d89bcbc6062ced36c82df83b8fae859","cd450ec335438986dfefa10c57fea9bcc521a0959b2d80bbf74b190dca712d10"],["e75605d59102a5a2684500d3b991f2e3f3c88b93225547035af25af66e04541f","f5c54754a8f71ee540b9b48728473e314f729ac5308b06938360990e2bfad125"],["eb98660f4c4dfaa06a2be453d5020bc99a0c2e60abe388457dd43fefb1ed620c","6cb9a8876d9cb8520609af3add26cd20a0a7cd8a9411131ce85f44100099223e"],["13e87b027d8514d35939f2e6892b19922154596941888336dc3563e3b8dba942","fef5a3c68059a6dec5d624114bf1e91aac2b9da568d6abeb2570d55646b8adf1"],["ee163026e9fd6fe017c38f06a5be6fc125424b371ce2708e7bf4491691e5764a","1acb250f255dd61c43d94ccc670d0f58f49ae3fa15b96623e5430da0ad6c62b2"],["b268f5ef9ad51e4d78de3a750c2dc89b1e626d43505867999932e5db33af3d80","5f310d4b3c99b9ebb19f77d41c1dee018cf0d34fd4191614003e945a1216e423"],["ff07f3118a9df035e9fad85eb6c7bfe42b02f01ca99ceea3bf7ffdba93c4750d","438136d603e858a3a5c440c38eccbaddc1d2942114e2eddd4740d098ced1f0d8"],["8d8b9855c7c052a34146fd20ffb658bea4b9f69e0d825ebec16e8c3ce2b526a1","cdb559eedc2d79f926baf44fb84ea4d44bcf50fee51d7ceb30e2e7f463036758"],["52db0b5384dfbf05bfa9d472d7ae26dfe4b851ceca91b1eba54263180da32b63","c3b997d050ee5d423ebaf66a6db9f57b3180c902875679de924b69d84a7b375"],["e62f9490d3d51da6395efd24e80919cc7d0f29c3f3fa48c6fff543becbd43352","6d89ad7ba4876b0b22c2ca280c682862f342c8591f1daf5170e07bfd9ccafa7d"],["7f30ea2476b399b4957509c88f77d0191afa2ff5cb7b14fd6d8e7d65aaab1193","ca5ef7d4b231c94c3b15389a5f6311e9daff7bb67b103e9880ef4bff637acaec"],["5098ff1e1d9f14fb46a210fada6c903fef0fb7b4a1dd1d9ac60a0361800b7a00","9731141d81fc8f8084d37c6e7542006b3ee1b40d60dfe5362a5b132fd17ddc0"],["32b78c7de9ee512a72895be6b9cbefa6e2f3c4ccce445c96b9f2c81e2778ad58","ee1849f513df71e32efc3896ee28260c73bb80547ae2275ba497237794c8753c"],["e2cb74fddc8e9fbcd076eef2a7c72b0ce37d50f08269dfc074b581550547a4f7","d3aa2ed71c9dd2247a62df062736eb0baddea9e36122d2be8641abcb005cc4a4"],["8438447566d4d7bedadc299496ab357426009a35f235cb141be0d99cd10ae3a8","c4e1020916980a4da5d01ac5e6ad330734ef0d7906631c4f2390426b2edd791f"],["4162d488b89402039b584c6fc6c308870587d9c46f660b878ab65c82c711d67e","67163e903236289f776f22c25fb8a3afc1732f2b84b4e95dbda47ae5a0852649"],["3fad3fa84caf0f34f0f89bfd2dcf54fc175d767aec3e50684f3ba4a4bf5f683d","cd1bc7cb6cc407bb2f0ca647c718a730cf71872e7d0d2a53fa20efcdfe61826"],["674f2600a3007a00568c1a7ce05d0816c1fb84bf1370798f1c69532faeb1a86b","299d21f9413f33b3edf43b257004580b70db57da0b182259e09eecc69e0d38a5"],["d32f4da54ade74abb81b815ad1fb3b263d82d6c692714bcff87d29bd5ee9f08f","f9429e738b8e53b968e99016c059707782e14f4535359d582fc416910b3eea87"],["30e4e670435385556e593657135845d36fbb6931f72b08cb1ed954f1e3ce3ff6","462f9bce619898638499350113bbc9b10a878d35da70740dc695a559eb88db7b"],["be2062003c51cc3004682904330e4dee7f3dcd10b01e580bf1971b04d4cad297","62188bc49d61e5428573d48a74e1c655b1c61090905682a0d5558ed72dccb9bc"],["93144423ace3451ed29e0fb9ac2af211cb6e84a601df5993c419859fff5df04a","7c10dfb164c3425f5c71a3f9d7992038f1065224f72bb9d1d902a6d13037b47c"],["b015f8044f5fcbdcf21ca26d6c34fb8197829205c7b7d2a7cb66418c157b112c","ab8c1e086d04e813744a655b2df8d5f83b3cdc6faa3088c1d3aea1454e3a1d5f"],["d5e9e1da649d97d89e4868117a465a3a4f8a18de57a140d36b3f2af341a21b52","4cb04437f391ed73111a13cc1d4dd0db1693465c2240480d8955e8592f27447a"],["d3ae41047dd7ca065dbf8ed77b992439983005cd72e16d6f996a5316d36966bb","bd1aeb21ad22ebb22a10f0303417c6d964f8cdd7df0aca614b10dc14d125ac46"],["463e2763d885f958fc66cdd22800f0a487197d0a82e377b49f80af87c897b065","bfefacdb0e5d0fd7df3a311a94de062b26b80c61fbc97508b79992671ef7ca7f"],["7985fdfd127c0567c6f53ec1bb63ec3158e597c40bfe747c83cddfc910641917","603c12daf3d9862ef2b25fe1de289aed24ed291e0ec6708703a5bd567f32ed03"],["74a1ad6b5f76e39db2dd249410eac7f99e74c59cb83d2d0ed5ff1543da7703e9","cc6157ef18c9c63cd6193d83631bbea0093e0968942e8c33d5737fd790e0db08"],["30682a50703375f602d416664ba19b7fc9bab42c72747463a71d0896b22f6da3","553e04f6b018b4fa6c8f39e7f311d3176290d0e0f19ca73f17714d9977a22ff8"],["9e2158f0d7c0d5f26c3791efefa79597654e7a2b2464f52b1ee6c1347769ef57","712fcdd1b9053f09003a3481fa7762e9ffd7c8ef35a38509e2fbf2629008373"],["176e26989a43c9cfeba4029c202538c28172e566e3c4fce7322857f3be327d66","ed8cc9d04b29eb877d270b4878dc43c19aefd31f4eee09ee7b47834c1fa4b1c3"],["75d46efea3771e6e68abb89a13ad747ecf1892393dfc4f1b7004788c50374da8","9852390a99507679fd0b86fd2b39a868d7efc22151346e1a3ca4726586a6bed8"],["809a20c67d64900ffb698c4c825f6d5f2310fb0451c869345b7319f645605721","9e994980d9917e22b76b061927fa04143d096ccc54963e6a5ebfa5f3f8e286c1"],["1b38903a43f7f114ed4500b4eac7083fdefece1cf29c63528d563446f972c180","4036edc931a60ae889353f77fd53de4a2708b26b6f5da72ad3394119daf408f9"]]}}},{}],103:[function(t,E,e){var u=e,g=t("bn.js"),S=t("minimalistic-assert"),y=t("minimalistic-crypto-utils");u.assert=S,u.toArray=y.toArray,u.zero2=y.zero2,u.toHex=y.toHex,u.encode=y.encode;function c(a,n,i){var r=new Array(Math.max(a.bitLength(),i)+1);r.fill(0);for(var s=1<<n+1,o=a.clone(),l=0;l<r.length;l++){var v,f=o.andln(s-1);o.isOdd()?(f>(s>>1)-1?v=(s>>1)-f:v=f,o.isubn(v)):v=0,r[l]=v,o.iushrn(1)}return r}u.getNAF=c;function m(a,n){var i=[[],[]];a=a.clone(),n=n.clone();for(var r=0,s=0,o;a.cmpn(-r)>0||n.cmpn(-s)>0;){var l=a.andln(3)+r&3,v=n.andln(3)+s&3;l===3&&(l=-1),v===3&&(v=-1);var f;l&1?(o=a.andln(7)+r&7,(o===3||o===5)&&v===2?f=-l:f=l):f=0,i[0].push(f);var p;v&1?(o=n.andln(7)+s&7,(o===3||o===5)&&l===2?p=-v:p=v):p=0,i[1].push(p),2*r===f+1&&(r=1-r),2*s===p+1&&(s=1-s),a.iushrn(1),n.iushrn(1)}return i}u.getJSF=m;function h(a,n,i){var r="_"+n;a.prototype[n]=function(){return this[r]!==void 0?this[r]:this[r]=i.call(this)}}u.cachedProperty=h;function d(a){return typeof a=="string"?u.toArray(a,"hex"):a}u.parseBytes=d;function b(a){return new g(a,"hex","le")}u.intFromLE=b},{"bn.js":18,"minimalistic-assert":223,"minimalistic-crypto-utils":224}],104:[function(t,E,e){E.exports={name:"elliptic",version:"6.5.4",description:"EC cryptography",main:"lib/elliptic.js",files:["lib"],scripts:{lint:"eslint lib test","lint:fix":"npm run lint -- --fix",unit:"istanbul test _mocha --reporter=spec test/index.js",test:"npm run lint && npm run unit",version:"grunt dist && git add dist/"},repository:{type:"git",url:"git@github.com:indutny/elliptic"},keywords:["EC","Elliptic","curve","Cryptography"],author:"Fedor Indutny <fedor@indutny.com>",license:"MIT",bugs:{url:"https://github.com/indutny/elliptic/issues"},homepage:"https://github.com/indutny/elliptic",devDependencies:{brfs:"^2.0.2",coveralls:"^3.1.0",eslint:"^7.6.0",grunt:"^1.2.1","grunt-browserify":"^5.3.0","grunt-cli":"^1.3.2","grunt-contrib-connect":"^3.0.0","grunt-contrib-copy":"^1.0.0","grunt-contrib-uglify":"^5.0.0","grunt-mocha-istanbul":"^5.0.2","grunt-saucelabs":"^9.0.1",istanbul:"^0.4.5",mocha:"^8.0.1"},dependencies:{"bn.js":"^4.11.9",brorand:"^1.1.0","hash.js":"^1.0.0","hmac-drbg":"^1.0.1",inherits:"^2.0.4","minimalistic-assert":"^1.0.1","minimalistic-crypto-utils":"^1.0.1"}}},{}],105:[function(t,E,e){var u=typeof Reflect=="object"?Reflect:null,g=u&&typeof u.apply=="function"?u.apply:function(w,M,A){return Function.prototype.apply.call(w,M,A)},S;u&&typeof u.ownKeys=="function"?S=u.ownKeys:Object.getOwnPropertySymbols?S=function(w){return Object.getOwnPropertyNames(w).concat(Object.getOwnPropertySymbols(w))}:S=function(w){return Object.getOwnPropertyNames(w)};function y(T){console&&console.warn&&console.warn(T)}var c=Number.isNaN||function(w){return w!==w};function m(){m.init.call(this)}E.exports=m,E.exports.once=f,m.EventEmitter=m,m.prototype._events=void 0,m.prototype._eventsCount=0,m.prototype._maxListeners=void 0;var h=10;function d(T){if(typeof T!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof T)}Object.defineProperty(m,"defaultMaxListeners",{enumerable:!0,get:function(){return h},set:function(T){if(typeof T!="number"||T<0||c(T))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+T+".");h=T}}),m.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},m.prototype.setMaxListeners=function(w){if(typeof w!="number"||w<0||c(w))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+w+".");return this._maxListeners=w,this};function b(T){return T._maxListeners===void 0?m.defaultMaxListeners:T._maxListeners}m.prototype.getMaxListeners=function(){return b(this)},m.prototype.emit=function(w){for(var M=[],A=1;A<arguments.length;A++)M.push(arguments[A]);var W=w==="error",ee=this._events;if(ee!==void 0)W=W&&ee.error===void 0;else if(!W)return!1;if(W){var F;if(M.length>0&&(F=M[0]),F instanceof Error)throw F;var C=new Error("Unhandled error."+(F?" ("+F.message+")":""));throw C.context=F,C}var O=ee[w];if(O===void 0)return!1;if(typeof O=="function")g(O,this,M);else for(var I=O.length,D=o(O,I),A=0;A<I;++A)g(D[A],this,M);return!0};function a(T,w,M,A){var W,ee,F;if(d(M),ee=T._events,ee===void 0?(ee=T._events=Object.create(null),T._eventsCount=0):(ee.newListener!==void 0&&(T.emit("newListener",w,M.listener?M.listener:M),ee=T._events),F=ee[w]),F===void 0)F=ee[w]=M,++T._eventsCount;else if(typeof F=="function"?F=ee[w]=A?[M,F]:[F,M]:A?F.unshift(M):F.push(M),W=b(T),W>0&&F.length>W&&!F.warned){F.warned=!0;var C=new Error("Possible EventEmitter memory leak detected. "+F.length+" "+String(w)+" listeners added. Use emitter.setMaxListeners() to increase limit");C.name="MaxListenersExceededWarning",C.emitter=T,C.type=w,C.count=F.length,y(C)}return T}m.prototype.addListener=function(w,M){return a(this,w,M,!1)},m.prototype.on=m.prototype.addListener,m.prototype.prependListener=function(w,M){return a(this,w,M,!0)};function n(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function i(T,w,M){var A={fired:!1,wrapFn:void 0,target:T,type:w,listener:M},W=n.bind(A);return W.listener=M,A.wrapFn=W,W}m.prototype.once=function(w,M){return d(M),this.on(w,i(this,w,M)),this},m.prototype.prependOnceListener=function(w,M){return d(M),this.prependListener(w,i(this,w,M)),this},m.prototype.removeListener=function(w,M){var A,W,ee,F,C;if(d(M),W=this._events,W===void 0)return this;if(A=W[w],A===void 0)return this;if(A===M||A.listener===M)--this._eventsCount===0?this._events=Object.create(null):(delete W[w],W.removeListener&&this.emit("removeListener",w,A.listener||M));else if(typeof A!="function"){for(ee=-1,F=A.length-1;F>=0;F--)if(A[F]===M||A[F].listener===M){C=A[F].listener,ee=F;break}if(ee<0)return this;ee===0?A.shift():l(A,ee),A.length===1&&(W[w]=A[0]),W.removeListener!==void 0&&this.emit("removeListener",w,C||M)}return this},m.prototype.off=m.prototype.removeListener,m.prototype.removeAllListeners=function(w){var M,A,W;if(A=this._events,A===void 0)return this;if(A.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):A[w]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete A[w]),this;if(arguments.length===0){var ee=Object.keys(A),F;for(W=0;W<ee.length;++W)F=ee[W],F!=="removeListener"&&this.removeAllListeners(F);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(M=A[w],typeof M=="function")this.removeListener(w,M);else if(M!==void 0)for(W=M.length-1;W>=0;W--)this.removeListener(w,M[W]);return this};function r(T,w,M){var A=T._events;if(A===void 0)return[];var W=A[w];return W===void 0?[]:typeof W=="function"?M?[W.listener||W]:[W]:M?v(W):o(W,W.length)}m.prototype.listeners=function(w){return r(this,w,!0)},m.prototype.rawListeners=function(w){return r(this,w,!1)},m.listenerCount=function(T,w){return typeof T.listenerCount=="function"?T.listenerCount(w):s.call(T,w)},m.prototype.listenerCount=s;function s(T){var w=this._events;if(w!==void 0){var M=w[T];if(typeof M=="function")return 1;if(M!==void 0)return M.length}return 0}m.prototype.eventNames=function(){return this._eventsCount>0?S(this._events):[]};function o(T,w){for(var M=new Array(w),A=0;A<w;++A)M[A]=T[A];return M}function l(T,w){for(;w+1<T.length;w++)T[w]=T[w+1];T.pop()}function v(T){for(var w=new Array(T.length),M=0;M<w.length;++M)w[M]=T[M].listener||T[M];return w}function f(T,w){return new Promise(function(M,A){function W(F){T.removeListener(w,ee),A(F)}function ee(){typeof T.removeListener=="function"&&T.removeListener("error",W),M([].slice.call(arguments))}_(T,w,ee,{once:!0}),w!=="error"&&p(T,W,{once:!0})})}function p(T,w,M){typeof T.on=="function"&&_(T,"error",w,M)}function _(T,w,M,A){if(typeof T.on=="function")A.once?T.once(w,M):T.on(w,M);else if(typeof T.addEventListener=="function")T.addEventListener(w,function W(ee){A.once&&T.removeEventListener(w,W),M(ee)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof T)}},{}],106:[function(t,E,e){var u=t("safe-buffer").Buffer,g=t("md5.js");function S(y,c,m,h){if(u.isBuffer(y)||(y=u.from(y,"binary")),c&&(u.isBuffer(c)||(c=u.from(c,"binary")),c.length!==8))throw new RangeError("salt should be Buffer with 8 byte length");for(var d=m/8,b=u.alloc(d),a=u.alloc(h||0),n=u.alloc(0);d>0||h>0;){var i=new g;i.update(n),i.update(y),c&&i.update(c),n=i.digest();var r=0;if(d>0){var s=b.length-d;r=Math.min(d,n.length),n.copy(b,s,0,r),d-=r}if(r<n.length&&h>0){var o=a.length-h,l=Math.min(h,n.length-r);n.copy(a,o,r,r+l),h-=l}}return n.fill(0),{key:b,iv:a}}E.exports=S},{"md5.js":221,"safe-buffer":250}],107:[function(t,E,e){var u=t("is-callable"),g=Object.prototype.toString,S=Object.prototype.hasOwnProperty,y=function(b,a,n){for(var i=0,r=b.length;i<r;i++)S.call(b,i)&&(n==null?a(b[i],i,b):a.call(n,b[i],i,b))},c=function(b,a,n){for(var i=0,r=b.length;i<r;i++)n==null?a(b.charAt(i),i,b):a.call(n,b.charAt(i),i,b)},m=function(b,a,n){for(var i in b)S.call(b,i)&&(n==null?a(b[i],i,b):a.call(n,b[i],i,b))},h=function(b,a,n){if(!u(a))throw new TypeError("iterator must be a function");var i;arguments.length>=3&&(i=n),g.call(b)==="[object Array]"?y(b,a,i):typeof b=="string"?c(b,a,i):m(b,a,i)};E.exports=h},{"is-callable":148}],108:[function(t,E,e){var u="Function.prototype.bind called on incompatible ",g=Array.prototype.slice,S=Object.prototype.toString,y="[object Function]";E.exports=function(m){var h=this;if(typeof h!="function"||S.call(h)!==y)throw new TypeError(u+h);for(var d=g.call(arguments,1),b,a=function(){if(this instanceof b){var o=h.apply(this,d.concat(g.call(arguments)));return Object(o)===o?o:this}else return h.apply(m,d.concat(g.call(arguments)))},n=Math.max(0,h.length-d.length),i=[],r=0;r<n;r++)i.push("$"+r);if(b=Function("binder","return function ("+i.join(",")+"){ return binder.apply(this,arguments); }")(a),h.prototype){var s=function(){};s.prototype=h.prototype,b.prototype=new s,s.prototype=null}return b}},{}],109:[function(t,E,e){var u=t("./implementation");E.exports=Function.prototype.bind||u},{"./implementation":108}],110:[function(t,E,e){var u,g=SyntaxError,S=Function,y=TypeError,c=function(C){try{return S('"use strict"; return ('+C+").constructor;")()}catch{}},m=Object.getOwnPropertyDescriptor;if(m)try{m({},"")}catch{m=null}var h=function(){throw new y},d=m?function(){try{return arguments.callee,h}catch{try{return m(arguments,"callee").get}catch{return h}}}():h,b=t("has-symbols")(),a=Object.getPrototypeOf||function(C){return C.__proto__},n={},i=typeof Uint8Array>"u"?u:a(Uint8Array),r={"%AggregateError%":typeof AggregateError>"u"?u:AggregateError,"%Array%":Array,"%ArrayBuffer%":typeof ArrayBuffer>"u"?u:ArrayBuffer,"%ArrayIteratorPrototype%":b?a([][Symbol.iterator]()):u,"%AsyncFromSyncIteratorPrototype%":u,"%AsyncFunction%":n,"%AsyncGenerator%":n,"%AsyncGeneratorFunction%":n,"%AsyncIteratorPrototype%":n,"%Atomics%":typeof Atomics>"u"?u:Atomics,"%BigInt%":typeof BigInt>"u"?u:BigInt,"%BigInt64Array%":typeof BigInt64Array>"u"?u:BigInt64Array,"%BigUint64Array%":typeof BigUint64Array>"u"?u:BigUint64Array,"%Boolean%":Boolean,"%DataView%":typeof DataView>"u"?u:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":typeof Float32Array>"u"?u:Float32Array,"%Float64Array%":typeof Float64Array>"u"?u:Float64Array,"%FinalizationRegistry%":typeof FinalizationRegistry>"u"?u:FinalizationRegistry,"%Function%":S,"%GeneratorFunction%":n,"%Int8Array%":typeof Int8Array>"u"?u:Int8Array,"%Int16Array%":typeof Int16Array>"u"?u:Int16Array,"%Int32Array%":typeof Int32Array>"u"?u:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":b?a(a([][Symbol.iterator]())):u,"%JSON%":typeof JSON=="object"?JSON:u,"%Map%":typeof Map>"u"?u:Map,"%MapIteratorPrototype%":typeof Map>"u"||!b?u:a(new Map()[Symbol.iterator]()),"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":typeof Promise>"u"?u:Promise,"%Proxy%":typeof Proxy>"u"?u:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":typeof Reflect>"u"?u:Reflect,"%RegExp%":RegExp,"%Set%":typeof Set>"u"?u:Set,"%SetIteratorPrototype%":typeof Set>"u"||!b?u:a(new Set()[Symbol.iterator]()),"%SharedArrayBuffer%":typeof SharedArrayBuffer>"u"?u:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":b?a(""[Symbol.iterator]()):u,"%Symbol%":b?Symbol:u,"%SyntaxError%":g,"%ThrowTypeError%":d,"%TypedArray%":i,"%TypeError%":y,"%Uint8Array%":typeof Uint8Array>"u"?u:Uint8Array,"%Uint8ClampedArray%":typeof Uint8ClampedArray>"u"?u:Uint8ClampedArray,"%Uint16Array%":typeof Uint16Array>"u"?u:Uint16Array,"%Uint32Array%":typeof Uint32Array>"u"?u:Uint32Array,"%URIError%":URIError,"%WeakMap%":typeof WeakMap>"u"?u:WeakMap,"%WeakRef%":typeof WeakRef>"u"?u:WeakRef,"%WeakSet%":typeof WeakSet>"u"?u:WeakSet};try{null.error}catch(C){var s=a(a(C));r["%Error.prototype%"]=s}var o=function C(O){var I;if(O==="%AsyncFunction%")I=c("async function () {}");else if(O==="%GeneratorFunction%")I=c("function* () {}");else if(O==="%AsyncGeneratorFunction%")I=c("async function* () {}");else if(O==="%AsyncGenerator%"){var D=C("%AsyncGeneratorFunction%");D&&(I=D.prototype)}else if(O==="%AsyncIteratorPrototype%"){var j=C("%AsyncGenerator%");j&&(I=a(j.prototype))}return r[O]=I,I},l={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},v=t("function-bind"),f=t("has"),p=v.call(Function.call,Array.prototype.concat),_=v.call(Function.apply,Array.prototype.splice),T=v.call(Function.call,String.prototype.replace),w=v.call(Function.call,String.prototype.slice),M=v.call(Function.call,RegExp.prototype.exec),A=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,W=/\\(\\)?/g,ee=function(O){var I=w(O,0,1),D=w(O,-1);if(I==="%"&&D!=="%")throw new g("invalid intrinsic syntax, expected closing `%`");if(D==="%"&&I!=="%")throw new g("invalid intrinsic syntax, expected opening `%`");var j=[];return T(O,A,function(Y,q,B,R){j[j.length]=B?T(R,W,"$1"):q||Y}),j},F=function(O,I){var D=O,j;if(f(l,D)&&(j=l[D],D="%"+j[0]+"%"),f(r,D)){var Y=r[D];if(Y===n&&(Y=o(D)),typeof Y>"u"&&!I)throw new y("intrinsic "+O+" exists, but is not available. Please file an issue!");return{alias:j,name:D,value:Y}}throw new g("intrinsic "+O+" does not exist!")};E.exports=function(O,I){if(typeof O!="string"||O.length===0)throw new y("intrinsic name must be a non-empty string");if(arguments.length>1&&typeof I!="boolean")throw new y('"allowMissing" argument must be a boolean');if(M(/^%?[^%]*%?$/,O)===null)throw new g("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var D=ee(O),j=D.length>0?D[0]:"",Y=F("%"+j+"%",I),q=Y.name,B=Y.value,R=!1,k=Y.alias;k&&(j=k[0],_(D,p([0,1],k)));for(var P=1,V=!0;P<D.length;P+=1){var x=D[P],Q=w(x,0,1),te=w(x,-1);if((Q==='"'||Q==="'"||Q==="`"||te==='"'||te==="'"||te==="`")&&Q!==te)throw new g("property names with quotes must have matching quotes");if((x==="constructor"||!V)&&(R=!0),j+="."+x,q="%"+j+"%",f(r,q))B=r[q];else if(B!=null){if(!(x in B)){if(!I)throw new y("base intrinsic for "+O+" exists, but the property is not available.");return}if(m&&P+1>=D.length){var ae=m(B,x);V=!!ae,V&&"get"in ae&&!("originalValue"in ae.get)?B=ae.get:B=B[x]}else V=f(B,x),B=B[x];V&&!R&&(r[q]=B)}}return B}},{"function-bind":109,has:115,"has-symbols":112}],111:[function(t,E,e){var u=t("get-intrinsic"),g=u("%Object.getOwnPropertyDescriptor%",!0);if(g)try{g([],"length")}catch{g=null}E.exports=g},{"get-intrinsic":110}],112:[function(t,E,e){var u=typeof Symbol<"u"&&Symbol,g=t("./shams");E.exports=function(){return typeof u!="function"||typeof Symbol!="function"||typeof u("foo")!="symbol"||typeof Symbol("bar")!="symbol"?!1:g()}},{"./shams":113}],113:[function(t,E,e){E.exports=function(){if(typeof Symbol!="function"||typeof Object.getOwnPropertySymbols!="function")return!1;if(typeof Symbol.iterator=="symbol")return!0;var g={},S=Symbol("test"),y=Object(S);if(typeof S=="string"||Object.prototype.toString.call(S)!=="[object Symbol]"||Object.prototype.toString.call(y)!=="[object Symbol]")return!1;var c=42;g[S]=c;for(S in g)return!1;if(typeof Object.keys=="function"&&Object.keys(g).length!==0||typeof Object.getOwnPropertyNames=="function"&&Object.getOwnPropertyNames(g).length!==0)return!1;var m=Object.getOwnPropertySymbols(g);if(m.length!==1||m[0]!==S||!Object.prototype.propertyIsEnumerable.call(g,S))return!1;if(typeof Object.getOwnPropertyDescriptor=="function"){var h=Object.getOwnPropertyDescriptor(g,S);if(h.value!==c||h.enumerable!==!0)return!1}return!0}},{}],114:[function(t,E,e){var u=t("has-symbols/shams");E.exports=function(){return u()&&!!Symbol.toStringTag}},{"has-symbols/shams":113}],115:[function(t,E,e){var u=t("function-bind");E.exports=u.call(Function.call,Object.prototype.hasOwnProperty)},{"function-bind":109}],116:[function(t,E,e){var u=t("safe-buffer").Buffer,g=t("readable-stream").Transform,S=t("inherits");function y(m,h){if(!u.isBuffer(m)&&typeof m!="string")throw new TypeError(h+" must be a string or a buffer")}function c(m){g.call(this),this._block=u.allocUnsafe(m),this._blockSize=m,this._blockOffset=0,this._length=[0,0,0,0],this._finalized=!1}S(c,g),c.prototype._transform=function(m,h,d){var b=null;try{this.update(m,h)}catch(a){b=a}d(b)},c.prototype._flush=function(m){var h=null;try{this.push(this.digest())}catch(d){h=d}m(h)},c.prototype.update=function(m,h){if(y(m,"Data"),this._finalized)throw new Error("Digest already called");u.isBuffer(m)||(m=u.from(m,h));for(var d=this._block,b=0;this._blockOffset+m.length-b>=this._blockSize;){for(var a=this._blockOffset;a<this._blockSize;)d[a++]=m[b++];this._update(),this._blockOffset=0}for(;b<m.length;)d[this._blockOffset++]=m[b++];for(var n=0,i=m.length*8;i>0;++n)this._length[n]+=i,i=this._length[n]/4294967296|0,i>0&&(this._length[n]-=4294967296*i);return this},c.prototype._update=function(){throw new Error("_update is not implemented")},c.prototype.digest=function(m){if(this._finalized)throw new Error("Digest already called");this._finalized=!0;var h=this._digest();m!==void 0&&(h=h.toString(m)),this._block.fill(0),this._blockOffset=0;for(var d=0;d<4;++d)this._length[d]=0;return h},c.prototype._digest=function(){throw new Error("_digest is not implemented")},E.exports=c},{inherits:146,"readable-stream":131,"safe-buffer":250}],117:[function(t,E,e){arguments[4][50][0].apply(e,arguments)},{dup:50}],118:[function(t,E,e){(function(u){(function(){var g=Object.keys||function(n){var i=[];for(var r in n)i.push(r);return i};E.exports=d;var S=t("./_stream_readable"),y=t("./_stream_writable");t("inherits")(d,S);for(var c=g(y.prototype),m=0;m<c.length;m++){var h=c[m];d.prototype[h]||(d.prototype[h]=y.prototype[h])}function d(n){if(!(this instanceof d))return new d(n);S.call(this,n),y.call(this,n),this.allowHalfOpen=!0,n&&(n.readable===!1&&(this.readable=!1),n.writable===!1&&(this.writable=!1),n.allowHalfOpen===!1&&(this.allowHalfOpen=!1,this.once("end",b)))}Object.defineProperty(d.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(d.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(d.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function b(){this._writableState.ended||u.nextTick(a,this)}function a(n){n.end()}Object.defineProperty(d.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0||this._writableState===void 0?!1:this._readableState.destroyed&&this._writableState.destroyed},set:function(i){this._readableState===void 0||this._writableState===void 0||(this._readableState.destroyed=i,this._writableState.destroyed=i)}})}).call(this)}).call(this,t("_process"))},{"./_stream_readable":120,"./_stream_writable":122,_process:237,inherits:146}],119:[function(t,E,e){arguments[4][52][0].apply(e,arguments)},{"./_stream_transform":121,dup:52,inherits:146}],120:[function(t,E,e){(function(u,g){(function(){E.exports=C;var S;C.ReadableState=F,t("events").EventEmitter;var y=function(G,U){return G.listeners(U).length},c=t("./internal/streams/stream"),m=t("buffer").Buffer,h=g.Uint8Array||function(){};function d(H){return m.from(H)}function b(H){return m.isBuffer(H)||H instanceof h}var a=t("util"),n;a&&a.debuglog?n=a.debuglog("stream"):n=function(){};var i=t("./internal/streams/buffer_list"),r=t("./internal/streams/destroy"),s=t("./internal/streams/state"),o=s.getHighWaterMark,l=t("../errors").codes,v=l.ERR_INVALID_ARG_TYPE,f=l.ERR_STREAM_PUSH_AFTER_EOF,p=l.ERR_METHOD_NOT_IMPLEMENTED,_=l.ERR_STREAM_UNSHIFT_AFTER_END_EVENT,T,w,M;t("inherits")(C,c);var A=r.errorOrDestroy,W=["error","close","destroy","pause","resume"];function ee(H,G,U){if(typeof H.prependListener=="function")return H.prependListener(G,U);!H._events||!H._events[G]?H.on(G,U):Array.isArray(H._events[G])?H._events[G].unshift(U):H._events[G]=[U,H._events[G]]}function F(H,G,U){S=S||t("./_stream_duplex"),H=H||{},typeof U!="boolean"&&(U=G instanceof S),this.objectMode=!!H.objectMode,U&&(this.objectMode=this.objectMode||!!H.readableObjectMode),this.highWaterMark=o(this,H,"readableHighWaterMark",U),this.buffer=new i,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=H.emitClose!==!1,this.autoDestroy=!!H.autoDestroy,this.destroyed=!1,this.defaultEncoding=H.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,H.encoding&&(T||(T=t("string_decoder/").StringDecoder),this.decoder=new T(H.encoding),this.encoding=H.encoding)}function C(H){if(S=S||t("./_stream_duplex"),!(this instanceof C))return new C(H);var G=this instanceof S;this._readableState=new F(H,this,G),this.readable=!0,H&&(typeof H.read=="function"&&(this._read=H.read),typeof H.destroy=="function"&&(this._destroy=H.destroy)),c.call(this)}Object.defineProperty(C.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0?!1:this._readableState.destroyed},set:function(G){this._readableState&&(this._readableState.destroyed=G)}}),C.prototype.destroy=r.destroy,C.prototype._undestroy=r.undestroy,C.prototype._destroy=function(H,G){G(H)},C.prototype.push=function(H,G){var U=this._readableState,L;return U.objectMode?L=!0:typeof H=="string"&&(G=G||U.defaultEncoding,G!==U.encoding&&(H=m.from(H,G),G=""),L=!0),O(this,H,G,!1,L)},C.prototype.unshift=function(H){return O(this,H,null,!0,!1)};function O(H,G,U,L,z){n("readableAddChunk",G);var J=H._readableState;if(G===null)J.reading=!1,B(H,J);else{var ne;if(z||(ne=D(J,G)),ne)A(H,ne);else if(J.objectMode||G&&G.length>0)if(typeof G!="string"&&!J.objectMode&&Object.getPrototypeOf(G)!==m.prototype&&(G=d(G)),L)J.endEmitted?A(H,new _):I(H,J,G,!0);else if(J.ended)A(H,new f);else{if(J.destroyed)return!1;J.reading=!1,J.decoder&&!U?(G=J.decoder.write(G),J.objectMode||G.length!==0?I(H,J,G,!1):P(H,J)):I(H,J,G,!1)}else L||(J.reading=!1,P(H,J))}return!J.ended&&(J.length<J.highWaterMark||J.length===0)}function I(H,G,U,L){G.flowing&&G.length===0&&!G.sync?(G.awaitDrain=0,H.emit("data",U)):(G.length+=G.objectMode?1:U.length,L?G.buffer.unshift(U):G.buffer.push(U),G.needReadable&&R(H)),P(H,G)}function D(H,G){var U;return!b(G)&&typeof G!="string"&&G!==void 0&&!H.objectMode&&(U=new v("chunk",["string","Buffer","Uint8Array"],G)),U}C.prototype.isPaused=function(){return this._readableState.flowing===!1},C.prototype.setEncoding=function(H){T||(T=t("string_decoder/").StringDecoder);var G=new T(H);this._readableState.decoder=G,this._readableState.encoding=this._readableState.decoder.encoding;for(var U=this._readableState.buffer.head,L="";U!==null;)L+=G.write(U.data),U=U.next;return this._readableState.buffer.clear(),L!==""&&this._readableState.buffer.push(L),this._readableState.length=L.length,this};var j=1073741824;function Y(H){return H>=j?H=j:(H--,H|=H>>>1,H|=H>>>2,H|=H>>>4,H|=H>>>8,H|=H>>>16,H++),H}function q(H,G){return H<=0||G.length===0&&G.ended?0:G.objectMode?1:H!==H?G.flowing&&G.length?G.buffer.head.data.length:G.length:(H>G.highWaterMark&&(G.highWaterMark=Y(H)),H<=G.length?H:G.ended?G.length:(G.needReadable=!0,0))}C.prototype.read=function(H){n("read",H),H=parseInt(H,10);var G=this._readableState,U=H;if(H!==0&&(G.emittedReadable=!1),H===0&&G.needReadable&&((G.highWaterMark!==0?G.length>=G.highWaterMark:G.length>0)||G.ended))return n("read: emitReadable",G.length,G.ended),G.length===0&&G.ended?K(this):R(this),null;if(H=q(H,G),H===0&&G.ended)return G.length===0&&K(this),null;var L=G.needReadable;n("need readable",L),(G.length===0||G.length-H<G.highWaterMark)&&(L=!0,n("length less than watermark",L)),G.ended||G.reading?(L=!1,n("reading or ended",L)):L&&(n("do read"),G.reading=!0,G.sync=!0,G.length===0&&(G.needReadable=!0),this._read(G.highWaterMark),G.sync=!1,G.reading||(H=q(U,G)));var z;return H>0?z=$(H,G):z=null,z===null?(G.needReadable=G.length<=G.highWaterMark,H=0):(G.length-=H,G.awaitDrain=0),G.length===0&&(G.ended||(G.needReadable=!0),U!==H&&G.ended&&K(this)),z!==null&&this.emit("data",z),z};function B(H,G){if(n("onEofChunk"),!G.ended){if(G.decoder){var U=G.decoder.end();U&&U.length&&(G.buffer.push(U),G.length+=G.objectMode?1:U.length)}G.ended=!0,G.sync?R(H):(G.needReadable=!1,G.emittedReadable||(G.emittedReadable=!0,k(H)))}}function R(H){var G=H._readableState;n("emitReadable",G.needReadable,G.emittedReadable),G.needReadable=!1,G.emittedReadable||(n("emitReadable",G.flowing),G.emittedReadable=!0,u.nextTick(k,H))}function k(H){var G=H._readableState;n("emitReadable_",G.destroyed,G.length,G.ended),!G.destroyed&&(G.length||G.ended)&&(H.emit("readable"),G.emittedReadable=!1),G.needReadable=!G.flowing&&!G.ended&&G.length<=G.highWaterMark,X(H)}function P(H,G){G.readingMore||(G.readingMore=!0,u.nextTick(V,H,G))}function V(H,G){for(;!G.reading&&!G.ended&&(G.length<G.highWaterMark||G.flowing&&G.length===0);){var U=G.length;if(n("maybeReadMore read 0"),H.read(0),U===G.length)break}G.readingMore=!1}C.prototype._read=function(H){A(this,new p("_read()"))},C.prototype.pipe=function(H,G){var U=this,L=this._readableState;switch(L.pipesCount){case 0:L.pipes=H;break;case 1:L.pipes=[L.pipes,H];break;default:L.pipes.push(H);break}L.pipesCount+=1,n("pipe count=%d opts=%j",L.pipesCount,G);var z=(!G||G.end!==!1)&&H!==u.stdout&&H!==u.stderr,J=z?oe:we;L.endEmitted?u.nextTick(J):U.once("end",J),H.on("unpipe",ne);function ne(me,N){n("onunpipe"),me===U&&N&&N.hasUnpiped===!1&&(N.hasUnpiped=!0,he())}function oe(){n("onend"),H.end()}var ce=x(U);H.on("drain",ce);var pe=!1;function he(){n("cleanup"),H.removeListener("close",ye),H.removeListener("finish",Ee),H.removeListener("drain",ce),H.removeListener("error",ve),H.removeListener("unpipe",ne),U.removeListener("end",oe),U.removeListener("end",we),U.removeListener("data",fe),pe=!0,L.awaitDrain&&(!H._writableState||H._writableState.needDrain)&&ce()}U.on("data",fe);function fe(me){n("ondata");var N=H.write(me);n("dest.write",N),N===!1&&((L.pipesCount===1&&L.pipes===H||L.pipesCount>1&&ue(L.pipes,H)!==-1)&&!pe&&(n("false write response, pause",L.awaitDrain),L.awaitDrain++),U.pause())}function ve(me){n("onerror",me),we(),H.removeListener("error",ve),y(H,"error")===0&&A(H,me)}ee(H,"error",ve);function ye(){H.removeListener("finish",Ee),we()}H.once("close",ye);function Ee(){n("onfinish"),H.removeListener("close",ye),we()}H.once("finish",Ee);function we(){n("unpipe"),U.unpipe(H)}return H.emit("pipe",U),L.flowing||(n("pipe resume"),U.resume()),H};function x(H){return function(){var U=H._readableState;n("pipeOnDrain",U.awaitDrain),U.awaitDrain&&U.awaitDrain--,U.awaitDrain===0&&y(H,"data")&&(U.flowing=!0,X(H))}}C.prototype.unpipe=function(H){var G=this._readableState,U={hasUnpiped:!1};if(G.pipesCount===0)return this;if(G.pipesCount===1)return H&&H!==G.pipes?this:(H||(H=G.pipes),G.pipes=null,G.pipesCount=0,G.flowing=!1,H&&H.emit("unpipe",this,U),this);if(!H){var L=G.pipes,z=G.pipesCount;G.pipes=null,G.pipesCount=0,G.flowing=!1;for(var J=0;J<z;J++)L[J].emit("unpipe",this,{hasUnpiped:!1});return this}var ne=ue(G.pipes,H);return ne===-1?this:(G.pipes.splice(ne,1),G.pipesCount-=1,G.pipesCount===1&&(G.pipes=G.pipes[0]),H.emit("unpipe",this,U),this)},C.prototype.on=function(H,G){var U=c.prototype.on.call(this,H,G),L=this._readableState;return H==="data"?(L.readableListening=this.listenerCount("readable")>0,L.flowing!==!1&&this.resume()):H==="readable"&&!L.endEmitted&&!L.readableListening&&(L.readableListening=L.needReadable=!0,L.flowing=!1,L.emittedReadable=!1,n("on readable",L.length,L.reading),L.length?R(this):L.reading||u.nextTick(te,this)),U},C.prototype.addListener=C.prototype.on,C.prototype.removeListener=function(H,G){var U=c.prototype.removeListener.call(this,H,G);return H==="readable"&&u.nextTick(Q,this),U},C.prototype.removeAllListeners=function(H){var G=c.prototype.removeAllListeners.apply(this,arguments);return(H==="readable"||H===void 0)&&u.nextTick(Q,this),G};function Q(H){var G=H._readableState;G.readableListening=H.listenerCount("readable")>0,G.resumeScheduled&&!G.paused?G.flowing=!0:H.listenerCount("data")>0&&H.resume()}function te(H){n("readable nexttick read 0"),H.read(0)}C.prototype.resume=function(){var H=this._readableState;return H.flowing||(n("resume"),H.flowing=!H.readableListening,ae(this,H)),H.paused=!1,this};function ae(H,G){G.resumeScheduled||(G.resumeScheduled=!0,u.nextTick(de,H,G))}function de(H,G){n("resume",G.reading),G.reading||H.read(0),G.resumeScheduled=!1,H.emit("resume"),X(H),G.flowing&&!G.reading&&H.read(0)}C.prototype.pause=function(){return n("call pause flowing=%j",this._readableState.flowing),this._readableState.flowing!==!1&&(n("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this};function X(H){var G=H._readableState;for(n("flow",G.flowing);G.flowing&&H.read()!==null;);}C.prototype.wrap=function(H){var G=this,U=this._readableState,L=!1;H.on("end",function(){if(n("wrapped end"),U.decoder&&!U.ended){var ne=U.decoder.end();ne&&ne.length&&G.push(ne)}G.push(null)}),H.on("data",function(ne){if(n("wrapped data"),U.decoder&&(ne=U.decoder.write(ne)),!(U.objectMode&&ne==null)&&!(!U.objectMode&&(!ne||!ne.length))){var oe=G.push(ne);oe||(L=!0,H.pause())}});for(var z in H)this[z]===void 0&&typeof H[z]=="function"&&(this[z]=function(oe){return function(){return H[oe].apply(H,arguments)}}(z));for(var J=0;J<W.length;J++)H.on(W[J],this.emit.bind(this,W[J]));return this._read=function(ne){n("wrapped _read",ne),L&&(L=!1,H.resume())},this},typeof Symbol=="function"&&(C.prototype[Symbol.asyncIterator]=function(){return w===void 0&&(w=t("./internal/streams/async_iterator")),w(this)}),Object.defineProperty(C.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(C.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(C.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(G){this._readableState&&(this._readableState.flowing=G)}}),C._fromList=$,Object.defineProperty(C.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}});function $(H,G){if(G.length===0)return null;var U;return G.objectMode?U=G.buffer.shift():!H||H>=G.length?(G.decoder?U=G.buffer.join(""):G.buffer.length===1?U=G.buffer.first():U=G.buffer.concat(G.length),G.buffer.clear()):U=G.buffer.consume(H,G.decoder),U}function K(H){var G=H._readableState;n("endReadable",G.endEmitted),G.endEmitted||(G.ended=!0,u.nextTick(re,G,H))}function re(H,G){if(n("endReadableNT",H.endEmitted,H.length),!H.endEmitted&&H.length===0&&(H.endEmitted=!0,G.readable=!1,G.emit("end"),H.autoDestroy)){var U=G._writableState;(!U||U.autoDestroy&&U.finished)&&G.destroy()}}typeof Symbol=="function"&&(C.from=function(H,G){return M===void 0&&(M=t("./internal/streams/from")),M(C,H,G)});function ue(H,G){for(var U=0,L=H.length;U<L;U++)if(H[U]===G)return U;return-1}}).call(this)}).call(this,t("_process"),typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../errors":117,"./_stream_duplex":118,"./internal/streams/async_iterator":123,"./internal/streams/buffer_list":124,"./internal/streams/destroy":125,"./internal/streams/from":127,"./internal/streams/state":129,"./internal/streams/stream":130,_process:237,buffer:68,events:105,inherits:146,"string_decoder/":279,util:20}],121:[function(t,E,e){arguments[4][54][0].apply(e,arguments)},{"../errors":117,"./_stream_duplex":118,dup:54,inherits:146}],122:[function(t,E,e){(function(u,g){(function(){E.exports=F;function S(X){var $=this;this.next=null,this.entry=null,this.finish=function(){de($,X)}}var y;F.WritableState=W;var c={deprecate:t("util-deprecate")},m=t("./internal/streams/stream"),h=t("buffer").Buffer,d=g.Uint8Array||function(){};function b(X){return h.from(X)}function a(X){return h.isBuffer(X)||X instanceof d}var n=t("./internal/streams/destroy"),i=t("./internal/streams/state"),r=i.getHighWaterMark,s=t("../errors").codes,o=s.ERR_INVALID_ARG_TYPE,l=s.ERR_METHOD_NOT_IMPLEMENTED,v=s.ERR_MULTIPLE_CALLBACK,f=s.ERR_STREAM_CANNOT_PIPE,p=s.ERR_STREAM_DESTROYED,_=s.ERR_STREAM_NULL_VALUES,T=s.ERR_STREAM_WRITE_AFTER_END,w=s.ERR_UNKNOWN_ENCODING,M=n.errorOrDestroy;t("inherits")(F,m);function A(){}function W(X,$,K){y=y||t("./_stream_duplex"),X=X||{},typeof K!="boolean"&&(K=$ instanceof y),this.objectMode=!!X.objectMode,K&&(this.objectMode=this.objectMode||!!X.writableObjectMode),this.highWaterMark=r(this,X,"writableHighWaterMark",K),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var re=X.decodeStrings===!1;this.decodeStrings=!re,this.defaultEncoding=X.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(ue){B($,ue)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=X.emitClose!==!1,this.autoDestroy=!!X.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new S(this)}W.prototype.getBuffer=function(){for(var $=this.bufferedRequest,K=[];$;)K.push($),$=$.next;return K},function(){try{Object.defineProperty(W.prototype,"buffer",{get:c.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch{}}();var ee;typeof Symbol=="function"&&Symbol.hasInstance&&typeof Function.prototype[Symbol.hasInstance]=="function"?(ee=Function.prototype[Symbol.hasInstance],Object.defineProperty(F,Symbol.hasInstance,{value:function($){return ee.call(this,$)?!0:this!==F?!1:$&&$._writableState instanceof W}})):ee=function($){return $ instanceof this};function F(X){y=y||t("./_stream_duplex");var $=this instanceof y;if(!$&&!ee.call(F,this))return new F(X);this._writableState=new W(X,this,$),this.writable=!0,X&&(typeof X.write=="function"&&(this._write=X.write),typeof X.writev=="function"&&(this._writev=X.writev),typeof X.destroy=="function"&&(this._destroy=X.destroy),typeof X.final=="function"&&(this._final=X.final)),m.call(this)}F.prototype.pipe=function(){M(this,new f)};function C(X,$){var K=new T;M(X,K),u.nextTick($,K)}function O(X,$,K,re){var ue;return K===null?ue=new _:typeof K!="string"&&!$.objectMode&&(ue=new o("chunk",["string","Buffer"],K)),ue?(M(X,ue),u.nextTick(re,ue),!1):!0}F.prototype.write=function(X,$,K){var re=this._writableState,ue=!1,H=!re.objectMode&&a(X);return H&&!h.isBuffer(X)&&(X=b(X)),typeof $=="function"&&(K=$,$=null),H?$="buffer":$||($=re.defaultEncoding),typeof K!="function"&&(K=A),re.ending?C(this,K):(H||O(this,re,X,K))&&(re.pendingcb++,ue=D(this,re,H,X,$,K)),ue},F.prototype.cork=function(){this._writableState.corked++},F.prototype.uncork=function(){var X=this._writableState;X.corked&&(X.corked--,!X.writing&&!X.corked&&!X.bufferProcessing&&X.bufferedRequest&&P(this,X))},F.prototype.setDefaultEncoding=function($){if(typeof $=="string"&&($=$.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf(($+"").toLowerCase())>-1))throw new w($);return this._writableState.defaultEncoding=$,this},Object.defineProperty(F.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}});function I(X,$,K){return!X.objectMode&&X.decodeStrings!==!1&&typeof $=="string"&&($=h.from($,K)),$}Object.defineProperty(F.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}});function D(X,$,K,re,ue,H){if(!K){var G=I($,re,ue);re!==G&&(K=!0,ue="buffer",re=G)}var U=$.objectMode?1:re.length;$.length+=U;var L=$.length<$.highWaterMark;if(L||($.needDrain=!0),$.writing||$.corked){var z=$.lastBufferedRequest;$.lastBufferedRequest={chunk:re,encoding:ue,isBuf:K,callback:H,next:null},z?z.next=$.lastBufferedRequest:$.bufferedRequest=$.lastBufferedRequest,$.bufferedRequestCount+=1}else j(X,$,!1,U,re,ue,H);return L}function j(X,$,K,re,ue,H,G){$.writelen=re,$.writecb=G,$.writing=!0,$.sync=!0,$.destroyed?$.onwrite(new p("write")):K?X._writev(ue,$.onwrite):X._write(ue,H,$.onwrite),$.sync=!1}function Y(X,$,K,re,ue){--$.pendingcb,K?(u.nextTick(ue,re),u.nextTick(te,X,$),X._writableState.errorEmitted=!0,M(X,re)):(ue(re),X._writableState.errorEmitted=!0,M(X,re),te(X,$))}function q(X){X.writing=!1,X.writecb=null,X.length-=X.writelen,X.writelen=0}function B(X,$){var K=X._writableState,re=K.sync,ue=K.writecb;if(typeof ue!="function")throw new v;if(q(K),$)Y(X,K,re,$,ue);else{var H=V(K)||X.destroyed;!H&&!K.corked&&!K.bufferProcessing&&K.bufferedRequest&&P(X,K),re?u.nextTick(R,X,K,H,ue):R(X,K,H,ue)}}function R(X,$,K,re){K||k(X,$),$.pendingcb--,re(),te(X,$)}function k(X,$){$.length===0&&$.needDrain&&($.needDrain=!1,X.emit("drain"))}function P(X,$){$.bufferProcessing=!0;var K=$.bufferedRequest;if(X._writev&&K&&K.next){var re=$.bufferedRequestCount,ue=new Array(re),H=$.corkedRequestsFree;H.entry=K;for(var G=0,U=!0;K;)ue[G]=K,K.isBuf||(U=!1),K=K.next,G+=1;ue.allBuffers=U,j(X,$,!0,$.length,ue,"",H.finish),$.pendingcb++,$.lastBufferedRequest=null,H.next?($.corkedRequestsFree=H.next,H.next=null):$.corkedRequestsFree=new S($),$.bufferedRequestCount=0}else{for(;K;){var L=K.chunk,z=K.encoding,J=K.callback,ne=$.objectMode?1:L.length;if(j(X,$,!1,ne,L,z,J),K=K.next,$.bufferedRequestCount--,$.writing)break}K===null&&($.lastBufferedRequest=null)}$.bufferedRequest=K,$.bufferProcessing=!1}F.prototype._write=function(X,$,K){K(new l("_write()"))},F.prototype._writev=null,F.prototype.end=function(X,$,K){var re=this._writableState;return typeof X=="function"?(K=X,X=null,$=null):typeof $=="function"&&(K=$,$=null),X!=null&&this.write(X,$),re.corked&&(re.corked=1,this.uncork()),re.ending||ae(this,re,K),this},Object.defineProperty(F.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function V(X){return X.ending&&X.length===0&&X.bufferedRequest===null&&!X.finished&&!X.writing}function x(X,$){X._final(function(K){$.pendingcb--,K&&M(X,K),$.prefinished=!0,X.emit("prefinish"),te(X,$)})}function Q(X,$){!$.prefinished&&!$.finalCalled&&(typeof X._final=="function"&&!$.destroyed?($.pendingcb++,$.finalCalled=!0,u.nextTick(x,X,$)):($.prefinished=!0,X.emit("prefinish")))}function te(X,$){var K=V($);if(K&&(Q(X,$),$.pendingcb===0&&($.finished=!0,X.emit("finish"),$.autoDestroy))){var re=X._readableState;(!re||re.autoDestroy&&re.endEmitted)&&X.destroy()}return K}function ae(X,$,K){$.ending=!0,te(X,$),K&&($.finished?u.nextTick(K):X.once("finish",K)),$.ended=!0,X.writable=!1}function de(X,$,K){var re=X.entry;for(X.entry=null;re;){var ue=re.callback;$.pendingcb--,ue(K),re=re.next}$.corkedRequestsFree.next=X}Object.defineProperty(F.prototype,"destroyed",{enumerable:!1,get:function(){return this._writableState===void 0?!1:this._writableState.destroyed},set:function($){this._writableState&&(this._writableState.destroyed=$)}}),F.prototype.destroy=n.destroy,F.prototype._undestroy=n.undestroy,F.prototype._destroy=function(X,$){$(X)}}).call(this)}).call(this,t("_process"),typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../errors":117,"./_stream_duplex":118,"./internal/streams/destroy":125,"./internal/streams/state":129,"./internal/streams/stream":130,_process:237,buffer:68,inherits:146,"util-deprecate":283}],123:[function(t,E,e){(function(u){(function(){var g;function S(p,_,T){return _ in p?Object.defineProperty(p,_,{value:T,enumerable:!0,configurable:!0,writable:!0}):p[_]=T,p}var y=t("./end-of-stream"),c=Symbol("lastResolve"),m=Symbol("lastReject"),h=Symbol("error"),d=Symbol("ended"),b=Symbol("lastPromise"),a=Symbol("handlePromise"),n=Symbol("stream");function i(p,_){return{value:p,done:_}}function r(p){var _=p[c];if(_!==null){var T=p[n].read();T!==null&&(p[b]=null,p[c]=null,p[m]=null,_(i(T,!1)))}}function s(p){u.nextTick(r,p)}function o(p,_){return function(T,w){p.then(function(){if(_[d]){T(i(void 0,!0));return}_[a](T,w)},w)}}var l=Object.getPrototypeOf(function(){}),v=Object.setPrototypeOf((g={get stream(){return this[n]},next:function(){var _=this,T=this[h];if(T!==null)return Promise.reject(T);if(this[d])return Promise.resolve(i(void 0,!0));if(this[n].destroyed)return new Promise(function(W,ee){u.nextTick(function(){_[h]?ee(_[h]):W(i(void 0,!0))})});var w=this[b],M;if(w)M=new Promise(o(w,this));else{var A=this[n].read();if(A!==null)return Promise.resolve(i(A,!1));M=new Promise(this[a])}return this[b]=M,M}},S(g,Symbol.asyncIterator,function(){return this}),S(g,"return",function(){var _=this;return new Promise(function(T,w){_[n].destroy(null,function(M){if(M){w(M);return}T(i(void 0,!0))})})}),g),l),f=function(_){var T,w=Object.create(v,(T={},S(T,n,{value:_,writable:!0}),S(T,c,{value:null,writable:!0}),S(T,m,{value:null,writable:!0}),S(T,h,{value:null,writable:!0}),S(T,d,{value:_._readableState.endEmitted,writable:!0}),S(T,a,{value:function(A,W){var ee=w[n].read();ee?(w[b]=null,w[c]=null,w[m]=null,A(i(ee,!1))):(w[c]=A,w[m]=W)},writable:!0}),T));return w[b]=null,y(_,function(M){if(M&&M.code!=="ERR_STREAM_PREMATURE_CLOSE"){var A=w[m];A!==null&&(w[b]=null,w[c]=null,w[m]=null,A(M)),w[h]=M;return}var W=w[c];W!==null&&(w[b]=null,w[c]=null,w[m]=null,W(i(void 0,!0))),w[d]=!0}),_.on("readable",s.bind(null,w)),w};E.exports=f}).call(this)}).call(this,t("_process"))},{"./end-of-stream":126,_process:237}],124:[function(t,E,e){arguments[4][57][0].apply(e,arguments)},{buffer:68,dup:57,util:20}],125:[function(t,E,e){(function(u){(function(){function g(d,b){var a=this,n=this._readableState&&this._readableState.destroyed,i=this._writableState&&this._writableState.destroyed;return n||i?(b?b(d):d&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,u.nextTick(m,this,d)):u.nextTick(m,this,d)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(d||null,function(r){!b&&r?a._writableState?a._writableState.errorEmitted?u.nextTick(y,a):(a._writableState.errorEmitted=!0,u.nextTick(S,a,r)):u.nextTick(S,a,r):b?(u.nextTick(y,a),b(r)):u.nextTick(y,a)}),this)}function S(d,b){m(d,b),y(d)}function y(d){d._writableState&&!d._writableState.emitClose||d._readableState&&!d._readableState.emitClose||d.emit("close")}function c(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function m(d,b){d.emit("error",b)}function h(d,b){var a=d._readableState,n=d._writableState;a&&a.autoDestroy||n&&n.autoDestroy?d.destroy(b):d.emit("error",b)}E.exports={destroy:g,undestroy:c,errorOrDestroy:h}}).call(this)}).call(this,t("_process"))},{_process:237}],126:[function(t,E,e){arguments[4][59][0].apply(e,arguments)},{"../../../errors":117,dup:59}],127:[function(t,E,e){arguments[4][60][0].apply(e,arguments)},{dup:60}],128:[function(t,E,e){arguments[4][61][0].apply(e,arguments)},{"../../../errors":117,"./end-of-stream":126,dup:61}],129:[function(t,E,e){arguments[4][62][0].apply(e,arguments)},{"../../../errors":117,dup:62}],130:[function(t,E,e){arguments[4][63][0].apply(e,arguments)},{dup:63,events:105}],131:[function(t,E,e){arguments[4][64][0].apply(e,arguments)},{"./lib/_stream_duplex.js":118,"./lib/_stream_passthrough.js":119,"./lib/_stream_readable.js":120,"./lib/_stream_transform.js":121,"./lib/_stream_writable.js":122,"./lib/internal/streams/end-of-stream.js":126,"./lib/internal/streams/pipeline.js":128,dup:64}],132:[function(t,E,e){var u=e;u.utils=t("./hash/utils"),u.common=t("./hash/common"),u.sha=t("./hash/sha"),u.ripemd=t("./hash/ripemd"),u.hmac=t("./hash/hmac"),u.sha1=u.sha.sha1,u.sha256=u.sha.sha256,u.sha224=u.sha.sha224,u.sha384=u.sha.sha384,u.sha512=u.sha.sha512,u.ripemd160=u.ripemd.ripemd160},{"./hash/common":133,"./hash/hmac":134,"./hash/ripemd":135,"./hash/sha":136,"./hash/utils":143}],133:[function(t,E,e){var u=t("./utils"),g=t("minimalistic-assert");function S(){this.pending=null,this.pendingTotal=0,this.blockSize=this.constructor.blockSize,this.outSize=this.constructor.outSize,this.hmacStrength=this.constructor.hmacStrength,this.padLength=this.constructor.padLength/8,this.endian="big",this._delta8=this.blockSize/8,this._delta32=this.blockSize/32}e.BlockHash=S,S.prototype.update=function(c,m){if(c=u.toArray(c,m),this.pending?this.pending=this.pending.concat(c):this.pending=c,this.pendingTotal+=c.length,this.pending.length>=this._delta8){c=this.pending;var h=c.length%this._delta8;this.pending=c.slice(c.length-h,c.length),this.pending.length===0&&(this.pending=null),c=u.join32(c,0,c.length-h,this.endian);for(var d=0;d<c.length;d+=this._delta32)this._update(c,d,d+this._delta32)}return this},S.prototype.digest=function(c){return this.update(this._pad()),g(this.pending===null),this._digest(c)},S.prototype._pad=function(){var c=this.pendingTotal,m=this._delta8,h=m-(c+this.padLength)%m,d=new Array(h+this.padLength);d[0]=128;for(var b=1;b<h;b++)d[b]=0;if(c<<=3,this.endian==="big"){for(var a=8;a<this.padLength;a++)d[b++]=0;d[b++]=0,d[b++]=0,d[b++]=0,d[b++]=0,d[b++]=c>>>24&255,d[b++]=c>>>16&255,d[b++]=c>>>8&255,d[b++]=c&255}else for(d[b++]=c&255,d[b++]=c>>>8&255,d[b++]=c>>>16&255,d[b++]=c>>>24&255,d[b++]=0,d[b++]=0,d[b++]=0,d[b++]=0,a=8;a<this.padLength;a++)d[b++]=0;return d}},{"./utils":143,"minimalistic-assert":223}],134:[function(t,E,e){var u=t("./utils"),g=t("minimalistic-assert");function S(y,c,m){if(!(this instanceof S))return new S(y,c,m);this.Hash=y,this.blockSize=y.blockSize/8,this.outSize=y.outSize/8,this.inner=null,this.outer=null,this._init(u.toArray(c,m))}E.exports=S,S.prototype._init=function(c){c.length>this.blockSize&&(c=new this.Hash().update(c).digest()),g(c.length<=this.blockSize);for(var m=c.length;m<this.blockSize;m++)c.push(0);for(m=0;m<c.length;m++)c[m]^=54;for(this.inner=new this.Hash().update(c),m=0;m<c.length;m++)c[m]^=106;this.outer=new this.Hash().update(c)},S.prototype.update=function(c,m){return this.inner.update(c,m),this},S.prototype.digest=function(c){return this.outer.update(this.inner.digest()),this.outer.digest(c)}},{"./utils":143,"minimalistic-assert":223}],135:[function(t,E,e){var u=t("./utils"),g=t("./common"),S=u.rotl32,y=u.sum32,c=u.sum32_3,m=u.sum32_4,h=g.BlockHash;function d(){if(!(this instanceof d))return new d;h.call(this),this.h=[1732584193,4023233417,2562383102,271733878,3285377520],this.endian="little"}u.inherits(d,h),e.ripemd160=d,d.blockSize=512,d.outSize=160,d.hmacStrength=192,d.padLength=64,d.prototype._update=function(v,f){for(var p=this.h[0],_=this.h[1],T=this.h[2],w=this.h[3],M=this.h[4],A=p,W=_,ee=T,F=w,C=M,O=0;O<80;O++){var I=y(S(m(p,b(O,_,T,w),v[i[O]+f],a(O)),s[O]),M);p=M,M=w,w=S(T,10),T=_,_=I,I=y(S(m(A,b(79-O,W,ee,F),v[r[O]+f],n(O)),o[O]),C),A=C,C=F,F=S(ee,10),ee=W,W=I}I=c(this.h[1],T,F),this.h[1]=c(this.h[2],w,C),this.h[2]=c(this.h[3],M,A),this.h[3]=c(this.h[4],p,W),this.h[4]=c(this.h[0],_,ee),this.h[0]=I},d.prototype._digest=function(v){return v==="hex"?u.toHex32(this.h,"little"):u.split32(this.h,"little")};function b(l,v,f,p){return l<=15?v^f^p:l<=31?v&f|~v&p:l<=47?(v|~f)^p:l<=63?v&p|f&~p:v^(f|~p)}function a(l){return l<=15?0:l<=31?1518500249:l<=47?1859775393:l<=63?2400959708:2840853838}function n(l){return l<=15?1352829926:l<=31?1548603684:l<=47?1836072691:l<=63?2053994217:0}var i=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13],r=[5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11],s=[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6],o=[8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]},{"./common":133,"./utils":143}],136:[function(t,E,e){e.sha1=t("./sha/1"),e.sha224=t("./sha/224"),e.sha256=t("./sha/256"),e.sha384=t("./sha/384"),e.sha512=t("./sha/512")},{"./sha/1":137,"./sha/224":138,"./sha/256":139,"./sha/384":140,"./sha/512":141}],137:[function(t,E,e){var u=t("../utils"),g=t("../common"),S=t("./common"),y=u.rotl32,c=u.sum32,m=u.sum32_5,h=S.ft_1,d=g.BlockHash,b=[1518500249,1859775393,2400959708,3395469782];function a(){if(!(this instanceof a))return new a;d.call(this),this.h=[1732584193,4023233417,2562383102,271733878,3285377520],this.W=new Array(80)}u.inherits(a,d),E.exports=a,a.blockSize=512,a.outSize=160,a.hmacStrength=80,a.padLength=64,a.prototype._update=function(i,r){for(var s=this.W,o=0;o<16;o++)s[o]=i[r+o];for(;o<s.length;o++)s[o]=y(s[o-3]^s[o-8]^s[o-14]^s[o-16],1);var l=this.h[0],v=this.h[1],f=this.h[2],p=this.h[3],_=this.h[4];for(o=0;o<s.length;o++){var T=~~(o/20),w=m(y(l,5),h(T,v,f,p),_,s[o],b[T]);_=p,p=f,f=y(v,30),v=l,l=w}this.h[0]=c(this.h[0],l),this.h[1]=c(this.h[1],v),this.h[2]=c(this.h[2],f),this.h[3]=c(this.h[3],p),this.h[4]=c(this.h[4],_)},a.prototype._digest=function(i){return i==="hex"?u.toHex32(this.h,"big"):u.split32(this.h,"big")}},{"../common":133,"../utils":143,"./common":142}],138:[function(t,E,e){var u=t("../utils"),g=t("./256");function S(){if(!(this instanceof S))return new S;g.call(this),this.h=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]}u.inherits(S,g),E.exports=S,S.blockSize=512,S.outSize=224,S.hmacStrength=192,S.padLength=64,S.prototype._digest=function(c){return c==="hex"?u.toHex32(this.h.slice(0,7),"big"):u.split32(this.h.slice(0,7),"big")}},{"../utils":143,"./256":139}],139:[function(t,E,e){var u=t("../utils"),g=t("../common"),S=t("./common"),y=t("minimalistic-assert"),c=u.sum32,m=u.sum32_4,h=u.sum32_5,d=S.ch32,b=S.maj32,a=S.s0_256,n=S.s1_256,i=S.g0_256,r=S.g1_256,s=g.BlockHash,o=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function l(){if(!(this instanceof l))return new l;s.call(this),this.h=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],this.k=o,this.W=new Array(64)}u.inherits(l,s),E.exports=l,l.blockSize=512,l.outSize=256,l.hmacStrength=192,l.padLength=64,l.prototype._update=function(f,p){for(var _=this.W,T=0;T<16;T++)_[T]=f[p+T];for(;T<_.length;T++)_[T]=m(r(_[T-2]),_[T-7],i(_[T-15]),_[T-16]);var w=this.h[0],M=this.h[1],A=this.h[2],W=this.h[3],ee=this.h[4],F=this.h[5],C=this.h[6],O=this.h[7];for(y(this.k.length===_.length),T=0;T<_.length;T++){var I=h(O,n(ee),d(ee,F,C),this.k[T],_[T]),D=c(a(w),b(w,M,A));O=C,C=F,F=ee,ee=c(W,I),W=A,A=M,M=w,w=c(I,D)}this.h[0]=c(this.h[0],w),this.h[1]=c(this.h[1],M),this.h[2]=c(this.h[2],A),this.h[3]=c(this.h[3],W),this.h[4]=c(this.h[4],ee),this.h[5]=c(this.h[5],F),this.h[6]=c(this.h[6],C),this.h[7]=c(this.h[7],O)},l.prototype._digest=function(f){return f==="hex"?u.toHex32(this.h,"big"):u.split32(this.h,"big")}},{"../common":133,"../utils":143,"./common":142,"minimalistic-assert":223}],140:[function(t,E,e){var u=t("../utils"),g=t("./512");function S(){if(!(this instanceof S))return new S;g.call(this),this.h=[3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428]}u.inherits(S,g),E.exports=S,S.blockSize=1024,S.outSize=384,S.hmacStrength=192,S.padLength=128,S.prototype._digest=function(c){return c==="hex"?u.toHex32(this.h.slice(0,12),"big"):u.split32(this.h.slice(0,12),"big")}},{"../utils":143,"./512":141}],141:[function(t,E,e){var u=t("../utils"),g=t("../common"),S=t("minimalistic-assert"),y=u.rotr64_hi,c=u.rotr64_lo,m=u.shr64_hi,h=u.shr64_lo,d=u.sum64,b=u.sum64_hi,a=u.sum64_lo,n=u.sum64_4_hi,i=u.sum64_4_lo,r=u.sum64_5_hi,s=u.sum64_5_lo,o=g.BlockHash,l=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function v(){if(!(this instanceof v))return new v;o.call(this),this.h=[1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209],this.k=l,this.W=new Array(160)}u.inherits(v,o),E.exports=v,v.blockSize=1024,v.outSize=512,v.hmacStrength=192,v.padLength=128,v.prototype._prepareBlock=function(D,j){for(var Y=this.W,q=0;q<32;q++)Y[q]=D[j+q];for(;q<Y.length;q+=2){var B=C(Y[q-4],Y[q-3]),R=O(Y[q-4],Y[q-3]),k=Y[q-14],P=Y[q-13],V=ee(Y[q-30],Y[q-29]),x=F(Y[q-30],Y[q-29]),Q=Y[q-32],te=Y[q-31];Y[q]=n(B,R,k,P,V,x,Q,te),Y[q+1]=i(B,R,k,P,V,x,Q,te)}},v.prototype._update=function(D,j){this._prepareBlock(D,j);var Y=this.W,q=this.h[0],B=this.h[1],R=this.h[2],k=this.h[3],P=this.h[4],V=this.h[5],x=this.h[6],Q=this.h[7],te=this.h[8],ae=this.h[9],de=this.h[10],X=this.h[11],$=this.h[12],K=this.h[13],re=this.h[14],ue=this.h[15];S(this.k.length===Y.length);for(var H=0;H<Y.length;H+=2){var G=re,U=ue,L=A(te,ae),z=W(te,ae),J=f(te,ae,de,X,$),ne=p(te,ae,de,X,$,K),oe=this.k[H],ce=this.k[H+1],pe=Y[H],he=Y[H+1],fe=r(G,U,L,z,J,ne,oe,ce,pe,he),ve=s(G,U,L,z,J,ne,oe,ce,pe,he);G=w(q,B),U=M(q,B),L=_(q,B,R,k,P),z=T(q,B,R,k,P,V);var ye=b(G,U,L,z),Ee=a(G,U,L,z);re=$,ue=K,$=de,K=X,de=te,X=ae,te=b(x,Q,fe,ve),ae=a(Q,Q,fe,ve),x=P,Q=V,P=R,V=k,R=q,k=B,q=b(fe,ve,ye,Ee),B=a(fe,ve,ye,Ee)}d(this.h,0,q,B),d(this.h,2,R,k),d(this.h,4,P,V),d(this.h,6,x,Q),d(this.h,8,te,ae),d(this.h,10,de,X),d(this.h,12,$,K),d(this.h,14,re,ue)},v.prototype._digest=function(D){return D==="hex"?u.toHex32(this.h,"big"):u.split32(this.h,"big")};function f(I,D,j,Y,q){var B=I&j^~I&q;return B<0&&(B+=4294967296),B}function p(I,D,j,Y,q,B){var R=D&Y^~D&B;return R<0&&(R+=4294967296),R}function _(I,D,j,Y,q){var B=I&j^I&q^j&q;return B<0&&(B+=4294967296),B}function T(I,D,j,Y,q,B){var R=D&Y^D&B^Y&B;return R<0&&(R+=4294967296),R}function w(I,D){var j=y(I,D,28),Y=y(D,I,2),q=y(D,I,7),B=j^Y^q;return B<0&&(B+=4294967296),B}function M(I,D){var j=c(I,D,28),Y=c(D,I,2),q=c(D,I,7),B=j^Y^q;return B<0&&(B+=4294967296),B}function A(I,D){var j=y(I,D,14),Y=y(I,D,18),q=y(D,I,9),B=j^Y^q;return B<0&&(B+=4294967296),B}function W(I,D){var j=c(I,D,14),Y=c(I,D,18),q=c(D,I,9),B=j^Y^q;return B<0&&(B+=4294967296),B}function ee(I,D){var j=y(I,D,1),Y=y(I,D,8),q=m(I,D,7),B=j^Y^q;return B<0&&(B+=4294967296),B}function F(I,D){var j=c(I,D,1),Y=c(I,D,8),q=h(I,D,7),B=j^Y^q;return B<0&&(B+=4294967296),B}function C(I,D){var j=y(I,D,19),Y=y(D,I,29),q=m(I,D,6),B=j^Y^q;return B<0&&(B+=4294967296),B}function O(I,D){var j=c(I,D,19),Y=c(D,I,29),q=h(I,D,6),B=j^Y^q;return B<0&&(B+=4294967296),B}},{"../common":133,"../utils":143,"minimalistic-assert":223}],142:[function(t,E,e){var u=t("../utils"),g=u.rotr32;function S(n,i,r,s){if(n===0)return y(i,r,s);if(n===1||n===3)return m(i,r,s);if(n===2)return c(i,r,s)}e.ft_1=S;function y(n,i,r){return n&i^~n&r}e.ch32=y;function c(n,i,r){return n&i^n&r^i&r}e.maj32=c;function m(n,i,r){return n^i^r}e.p32=m;function h(n){return g(n,2)^g(n,13)^g(n,22)}e.s0_256=h;function d(n){return g(n,6)^g(n,11)^g(n,25)}e.s1_256=d;function b(n){return g(n,7)^g(n,18)^n>>>3}e.g0_256=b;function a(n){return g(n,17)^g(n,19)^n>>>10}e.g1_256=a},{"../utils":143}],143:[function(t,E,e){var u=t("minimalistic-assert"),g=t("inherits");e.inherits=g;function S(O,I){return(O.charCodeAt(I)&64512)!==55296||I<0||I+1>=O.length?!1:(O.charCodeAt(I+1)&64512)===56320}function y(O,I){if(Array.isArray(O))return O.slice();if(!O)return[];var D=[];if(typeof O=="string")if(I){if(I==="hex")for(O=O.replace(/[^a-z0-9]+/ig,""),O.length%2!==0&&(O="0"+O),Y=0;Y<O.length;Y+=2)D.push(parseInt(O[Y]+O[Y+1],16))}else for(var j=0,Y=0;Y<O.length;Y++){var q=O.charCodeAt(Y);q<128?D[j++]=q:q<2048?(D[j++]=q>>6|192,D[j++]=q&63|128):S(O,Y)?(q=65536+((q&1023)<<10)+(O.charCodeAt(++Y)&1023),D[j++]=q>>18|240,D[j++]=q>>12&63|128,D[j++]=q>>6&63|128,D[j++]=q&63|128):(D[j++]=q>>12|224,D[j++]=q>>6&63|128,D[j++]=q&63|128)}else for(Y=0;Y<O.length;Y++)D[Y]=O[Y]|0;return D}e.toArray=y;function c(O){for(var I="",D=0;D<O.length;D++)I+=d(O[D].toString(16));return I}e.toHex=c;function m(O){var I=O>>>24|O>>>8&65280|O<<8&16711680|(O&255)<<24;return I>>>0}e.htonl=m;function h(O,I){for(var D="",j=0;j<O.length;j++){var Y=O[j];I==="little"&&(Y=m(Y)),D+=b(Y.toString(16))}return D}e.toHex32=h;function d(O){return O.length===1?"0"+O:O}e.zero2=d;function b(O){return O.length===7?"0"+O:O.length===6?"00"+O:O.length===5?"000"+O:O.length===4?"0000"+O:O.length===3?"00000"+O:O.length===2?"000000"+O:O.length===1?"0000000"+O:O}e.zero8=b;function a(O,I,D,j){var Y=D-I;u(Y%4===0);for(var q=new Array(Y/4),B=0,R=I;B<q.length;B++,R+=4){var k;j==="big"?k=O[R]<<24|O[R+1]<<16|O[R+2]<<8|O[R+3]:k=O[R+3]<<24|O[R+2]<<16|O[R+1]<<8|O[R],q[B]=k>>>0}return q}e.join32=a;function n(O,I){for(var D=new Array(O.length*4),j=0,Y=0;j<O.length;j++,Y+=4){var q=O[j];I==="big"?(D[Y]=q>>>24,D[Y+1]=q>>>16&255,D[Y+2]=q>>>8&255,D[Y+3]=q&255):(D[Y+3]=q>>>24,D[Y+2]=q>>>16&255,D[Y+1]=q>>>8&255,D[Y]=q&255)}return D}e.split32=n;function i(O,I){return O>>>I|O<<32-I}e.rotr32=i;function r(O,I){return O<<I|O>>>32-I}e.rotl32=r;function s(O,I){return O+I>>>0}e.sum32=s;function o(O,I,D){return O+I+D>>>0}e.sum32_3=o;function l(O,I,D,j){return O+I+D+j>>>0}e.sum32_4=l;function v(O,I,D,j,Y){return O+I+D+j+Y>>>0}e.sum32_5=v;function f(O,I,D,j){var Y=O[I],q=O[I+1],B=j+q>>>0,R=(B<j?1:0)+D+Y;O[I]=R>>>0,O[I+1]=B}e.sum64=f;function p(O,I,D,j){var Y=I+j>>>0,q=(Y<I?1:0)+O+D;return q>>>0}e.sum64_hi=p;function _(O,I,D,j){var Y=I+j;return Y>>>0}e.sum64_lo=_;function T(O,I,D,j,Y,q,B,R){var k=0,P=I;P=P+j>>>0,k+=P<I?1:0,P=P+q>>>0,k+=P<q?1:0,P=P+R>>>0,k+=P<R?1:0;var V=O+D+Y+B+k;return V>>>0}e.sum64_4_hi=T;function w(O,I,D,j,Y,q,B,R){var k=I+j+q+R;return k>>>0}e.sum64_4_lo=w;function M(O,I,D,j,Y,q,B,R,k,P){var V=0,x=I;x=x+j>>>0,V+=x<I?1:0,x=x+q>>>0,V+=x<q?1:0,x=x+R>>>0,V+=x<R?1:0,x=x+P>>>0,V+=x<P?1:0;var Q=O+D+Y+B+k+V;return Q>>>0}e.sum64_5_hi=M;function A(O,I,D,j,Y,q,B,R,k,P){var V=I+j+q+R+P;return V>>>0}e.sum64_5_lo=A;function W(O,I,D){var j=I<<32-D|O>>>D;return j>>>0}e.rotr64_hi=W;function ee(O,I,D){var j=O<<32-D|I>>>D;return j>>>0}e.rotr64_lo=ee;function F(O,I,D){return O>>>D}e.shr64_hi=F;function C(O,I,D){var j=O<<32-D|I>>>D;return j>>>0}e.shr64_lo=C},{inherits:146,"minimalistic-assert":223}],144:[function(t,E,e){var u=t("hash.js"),g=t("minimalistic-crypto-utils"),S=t("minimalistic-assert");function y(c){if(!(this instanceof y))return new y(c);this.hash=c.hash,this.predResist=!!c.predResist,this.outLen=this.hash.outSize,this.minEntropy=c.minEntropy||this.hash.hmacStrength,this._reseed=null,this.reseedInterval=null,this.K=null,this.V=null;var m=g.toArray(c.entropy,c.entropyEnc||"hex"),h=g.toArray(c.nonce,c.nonceEnc||"hex"),d=g.toArray(c.pers,c.persEnc||"hex");S(m.length>=this.minEntropy/8,"Not enough entropy. Minimum is: "+this.minEntropy+" bits"),this._init(m,h,d)}E.exports=y,y.prototype._init=function(m,h,d){var b=m.concat(h).concat(d);this.K=new Array(this.outLen/8),this.V=new Array(this.outLen/8);for(var a=0;a<this.V.length;a++)this.K[a]=0,this.V[a]=1;this._update(b),this._reseed=1,this.reseedInterval=281474976710656},y.prototype._hmac=function(){return new u.hmac(this.hash,this.K)},y.prototype._update=function(m){var h=this._hmac().update(this.V).update([0]);m&&(h=h.update(m)),this.K=h.digest(),this.V=this._hmac().update(this.V).digest(),m&&(this.K=this._hmac().update(this.V).update([1]).update(m).digest(),this.V=this._hmac().update(this.V).digest())},y.prototype.reseed=function(m,h,d,b){typeof h!="string"&&(b=d,d=h,h=null),m=g.toArray(m,h),d=g.toArray(d,b),S(m.length>=this.minEntropy/8,"Not enough entropy. Minimum is: "+this.minEntropy+" bits"),this._update(m.concat(d||[])),this._reseed=1},y.prototype.generate=function(m,h,d,b){if(this._reseed>this.reseedInterval)throw new Error("Reseed is required");typeof h!="string"&&(b=d,d=h,h=null),d&&(d=g.toArray(d,b||"hex"),this._update(d));for(var a=[];a.length<m;)this.V=this._hmac().update(this.V).digest(),a=a.concat(this.V);var n=a.slice(0,m);return this._update(d),this._reseed++,g.encode(n,h)}},{"hash.js":132,"minimalistic-assert":223,"minimalistic-crypto-utils":224}],145:[function(t,E,e){/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */e.read=function(u,g,S,y,c){var m,h,d=c*8-y-1,b=(1<<d)-1,a=b>>1,n=-7,i=S?c-1:0,r=S?-1:1,s=u[g+i];for(i+=r,m=s&(1<<-n)-1,s>>=-n,n+=d;n>0;m=m*256+u[g+i],i+=r,n-=8);for(h=m&(1<<-n)-1,m>>=-n,n+=y;n>0;h=h*256+u[g+i],i+=r,n-=8);if(m===0)m=1-a;else{if(m===b)return h?NaN:(s?-1:1)*(1/0);h=h+Math.pow(2,y),m=m-a}return(s?-1:1)*h*Math.pow(2,m-y)},e.write=function(u,g,S,y,c,m){var h,d,b,a=m*8-c-1,n=(1<<a)-1,i=n>>1,r=c===23?Math.pow(2,-24)-Math.pow(2,-77):0,s=y?0:m-1,o=y?1:-1,l=g<0||g===0&&1/g<0?1:0;for(g=Math.abs(g),isNaN(g)||g===1/0?(d=isNaN(g)?1:0,h=n):(h=Math.floor(Math.log(g)/Math.LN2),g*(b=Math.pow(2,-h))<1&&(h--,b*=2),h+i>=1?g+=r/b:g+=r*Math.pow(2,1-i),g*b>=2&&(h++,b/=2),h+i>=n?(d=0,h=n):h+i>=1?(d=(g*b-1)*Math.pow(2,c),h=h+i):(d=g*Math.pow(2,i-1)*Math.pow(2,c),h=0));c>=8;u[S+s]=d&255,s+=o,d/=256,c-=8);for(h=h<<c|d,a+=c;a>0;u[S+s]=h&255,s+=o,h/=256,a-=8);u[S+s-o]|=l*128}},{}],146:[function(t,E,e){typeof Object.create=="function"?E.exports=function(g,S){S&&(g.super_=S,g.prototype=Object.create(S.prototype,{constructor:{value:g,enumerable:!1,writable:!0,configurable:!0}}))}:E.exports=function(g,S){if(S){g.super_=S;var y=function(){};y.prototype=S.prototype,g.prototype=new y,g.prototype.constructor=g}}},{}],147:[function(t,E,e){var u=t("has-tostringtag/shams")(),g=t("call-bind/callBound"),S=g("Object.prototype.toString"),y=function(d){return u&&d&&typeof d=="object"&&Symbol.toStringTag in d?!1:S(d)==="[object Arguments]"},c=function(d){return y(d)?!0:d!==null&&typeof d=="object"&&typeof d.length=="number"&&d.length>=0&&S(d)!=="[object Array]"&&S(d.callee)==="[object Function]"},m=function(){return y(arguments)}();y.isLegacyArguments=c,E.exports=m?y:c},{"call-bind/callBound":69,"has-tostringtag/shams":114}],148:[function(t,E,e){var u=Function.prototype.toString,g=typeof Reflect=="object"&&Reflect!==null&&Reflect.apply,S,y;if(typeof g=="function"&&typeof Object.defineProperty=="function")try{S=Object.defineProperty({},"length",{get:function(){throw y}}),y={},g(function(){throw 42},null,S)}catch(p){p!==y&&(g=null)}else g=null;var c=/^\s*class\b/,m=function(_){try{var T=u.call(_);return c.test(T)}catch{return!1}},h=function(_){try{return m(_)?!1:(u.call(_),!0)}catch{return!1}},d=Object.prototype.toString,b="[object Object]",a="[object Function]",n="[object GeneratorFunction]",i="[object HTMLAllCollection]",r="[object HTML document.all class]",s="[object HTMLCollection]",o=typeof Symbol=="function"&&!!Symbol.toStringTag,l=!(0 in[,]),v=function(){return!1};if(typeof document=="object"){var f=document.all;d.call(f)===d.call(document.all)&&(v=function(_){if((l||!_)&&(typeof _>"u"||typeof _=="object"))try{var T=d.call(_);return(T===i||T===r||T===s||T===b)&&_("")==null}catch{}return!1})}E.exports=g?function(_){if(v(_))return!0;if(!_||typeof _!="function"&&typeof _!="object")return!1;try{g(_,null,S)}catch(T){if(T!==y)return!1}return!m(_)&&h(_)}:function(_){if(v(_))return!0;if(!_||typeof _!="function"&&typeof _!="object")return!1;if(o)return h(_);if(m(_))return!1;var T=d.call(_);return T!==a&&T!==n&&!/^\[object HTML/.test(T)?!1:h(_)}},{}],149:[function(t,E,e){var u=Object.prototype.toString,g=Function.prototype.toString,S=/^\s*(?:function)?\*/,y=t("has-tostringtag/shams")(),c=Object.getPrototypeOf,m=function(){if(!y)return!1;try{return Function("return function*() {}")()}catch{}},h;E.exports=function(b){if(typeof b!="function")return!1;if(S.test(g.call(b)))return!0;if(!y){var a=u.call(b);return a==="[object GeneratorFunction]"}if(!c)return!1;if(typeof h>"u"){var n=m();h=n?c(n):!1}return c(b)===h}},{"has-tostringtag/shams":114}],150:[function(t,E,e){(function(u){(function(){var g=t("for-each"),S=t("available-typed-arrays"),y=t("call-bind/callBound"),c=y("Object.prototype.toString"),m=t("has-tostringtag/shams")(),h=t("gopd"),d=typeof globalThis>"u"?u:globalThis,b=S(),a=y("Array.prototype.indexOf",!0)||function(l,v){for(var f=0;f<l.length;f+=1)if(l[f]===v)return f;return-1},n=y("String.prototype.slice"),i={},r=Object.getPrototypeOf;m&&h&&r&&g(b,function(o){var l=new d[o];if(Symbol.toStringTag in l){var v=r(l),f=h(v,Symbol.toStringTag);if(!f){var p=r(v);f=h(p,Symbol.toStringTag)}i[o]=f.get}});var s=function(l){var v=!1;return g(i,function(f,p){if(!v)try{v=f.call(l)===p}catch{}}),v};E.exports=function(l){if(!l||typeof l!="object")return!1;if(!m||!(Symbol.toStringTag in l)){var v=n(c(l),8,-1);return a(b,v)>-1}return h?s(l):!1}}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"available-typed-arrays":16,"call-bind/callBound":69,"for-each":107,gopd:111,"has-tostringtag/shams":114}],151:[function(t,E,e){(function(u,g){typeof define=="function"&&define.amd?define(g):typeof E=="object"&&E.exports?E.exports=g():u.log=g()})(this,function(){var u=function(){},g="undefined",S=typeof window!==g&&typeof window.navigator!==g&&/Trident\/|MSIE /.test(window.navigator.userAgent),y=["trace","debug","info","warn","error"];function c(o,l){var v=o[l];if(typeof v.bind=="function")return v.bind(o);try{return Function.prototype.bind.call(v,o)}catch{return function(){return Function.prototype.apply.apply(v,[o,arguments])}}}function m(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function h(o){return o==="debug"&&(o="log"),typeof console===g?!1:o==="trace"&&S?m:console[o]!==void 0?c(console,o):console.log!==void 0?c(console,"log"):u}function d(o,l){for(var v=0;v<y.length;v++){var f=y[v];this[f]=v<o?u:this.methodFactory(f,o,l)}this.log=this.debug}function b(o,l,v){return function(){typeof console!==g&&(d.call(this,l,v),this[o].apply(this,arguments))}}function a(o,l,v){return h(o)||b.apply(this,arguments)}function n(o,l,v){var f=this,p;l=l??"WARN";var _="loglevel";typeof o=="string"?_+=":"+o:typeof o=="symbol"&&(_=void 0);function T(W){var ee=(y[W]||"silent").toUpperCase();if(!(typeof window===g||!_)){try{window.localStorage[_]=ee;return}catch{}try{window.document.cookie=encodeURIComponent(_)+"="+ee+";"}catch{}}}function w(){var W;if(!(typeof window===g||!_)){try{W=window.localStorage[_]}catch{}if(typeof W===g)try{var ee=window.document.cookie,F=ee.indexOf(encodeURIComponent(_)+"=");F!==-1&&(W=/^([^;]+)/.exec(ee.slice(F))[1])}catch{}return f.levels[W]===void 0&&(W=void 0),W}}function M(){if(!(typeof window===g||!_)){try{window.localStorage.removeItem(_);return}catch{}try{window.document.cookie=encodeURIComponent(_)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}f.name=o,f.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},f.methodFactory=v||a,f.getLevel=function(){return p},f.setLevel=function(W,ee){if(typeof W=="string"&&f.levels[W.toUpperCase()]!==void 0&&(W=f.levels[W.toUpperCase()]),typeof W=="number"&&W>=0&&W<=f.levels.SILENT){if(p=W,ee!==!1&&T(W),d.call(f,W,o),typeof console===g&&W<f.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+W},f.setDefaultLevel=function(W){l=W,w()||f.setLevel(W,!1)},f.resetLevel=function(){f.setLevel(l,!1),M()},f.enableAll=function(W){f.setLevel(f.levels.TRACE,W)},f.disableAll=function(W){f.setLevel(f.levels.SILENT,W)};var A=w();A==null&&(A=l),f.setLevel(A,!1)}var i=new n,r={};i.getLogger=function(l){if(typeof l!="symbol"&&typeof l!="string"||l==="")throw new TypeError("You must supply a name when creating a logger.");var v=r[l];return v||(v=r[l]=new n(l,i.getLevel(),i.methodFactory)),v};var s=typeof window!==g?window.log:void 0;return i.noConflict=function(){return typeof window!==g&&window.log===i&&(window.log=s),i},i.getLoggers=function(){return r},i.default=i,i})},{}],152:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ExtensibleEvents=void 0;var u=t("./NamespacedMap"),g=t("./InvalidEventError"),S=t("./interpreters/legacy/MRoomMessage"),y=t("./interpreters/modern/MMessage"),c=t("./events/message_types"),m=t("./events/poll_types"),h=t("./interpreters/modern/MPoll");function d(l,v){var f=typeof Symbol<"u"&&l[Symbol.iterator]||l["@@iterator"];if(!f){if(Array.isArray(l)||(f=b(l))||v&&l&&typeof l.length=="number"){f&&(l=f);var p=0,_=function(){};return{s:_,n:function(){return p>=l.length?{done:!0}:{done:!1,value:l[p++]}},e:function(W){throw W},f:_}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var T=!0,w=!1,M;return{s:function(){f=f.call(l)},n:function(){var W=f.next();return T=W.done,W},e:function(W){w=!0,M=W},f:function(){try{!T&&f.return!=null&&f.return()}finally{if(w)throw M}}}}function b(l,v){if(l){if(typeof l=="string")return a(l,v);var f=Object.prototype.toString.call(l).slice(8,-1);if(f==="Object"&&l.constructor&&(f=l.constructor.name),f==="Map"||f==="Set")return Array.from(l);if(f==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(f))return a(l,v)}}function a(l,v){(v==null||v>l.length)&&(v=l.length);for(var f=0,p=new Array(v);f<v;f++)p[f]=l[f];return p}function n(l,v){if(!(l instanceof v))throw new TypeError("Cannot call a class as a function")}function i(l,v){for(var f=0;f<v.length;f++){var p=v[f];p.enumerable=p.enumerable||!1,p.configurable=!0,"value"in p&&(p.writable=!0),Object.defineProperty(l,p.key,p)}}function r(l,v,f){return v&&i(l.prototype,v),f&&i(l,f),Object.defineProperty(l,"prototype",{writable:!1}),l}function s(l,v,f){return v in l?Object.defineProperty(l,v,{value:f,enumerable:!0,configurable:!0,writable:!0}):l[v]=f,l}var o=function(){function l(){n(this,l),s(this,"interpreters",new u.NamespacedMap([[S.LEGACY_M_ROOM_MESSAGE,S.parseMRoomMessage],[c.M_MESSAGE,y.parseMMessage],[c.M_EMOTE,y.parseMMessage],[c.M_NOTICE,y.parseMMessage],[m.M_POLL_START,h.parseMPoll],[m.M_POLL_RESPONSE,h.parseMPoll],[m.M_POLL_END,h.parseMPoll]])),s(this,"_unknownInterpretOrder",[c.M_MESSAGE])}return r(l,[{key:"unknownInterpretOrder",get:function(){var f;return(f=this._unknownInterpretOrder)!==null&&f!==void 0?f:[]},set:function(f){this._unknownInterpretOrder=f}},{key:"registerInterpreter",value:function(f,p){this.interpreters.set(f,p)}},{key:"parse",value:function(f){try{if(this.interpreters.hasNamespaced(f.type))return this.interpreters.getNamespaced(f.type)(f);var p=d(this.unknownInterpretOrder),_;try{for(p.s();!(_=p.n()).done;){var T=_.value;if(this.interpreters.has(T)){var w=this.interpreters.get(T)(f);if(w)return w}}}catch(M){p.e(M)}finally{p.f()}return null}catch(M){if(M instanceof g.InvalidEventError)return null;throw M}}}],[{key:"defaultInstance",get:function(){return l._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return l.defaultInstance.unknownInterpretOrder},set:function(f){l.defaultInstance.unknownInterpretOrder=f}},{key:"registerInterpreter",value:function(f,p){l.defaultInstance.registerInterpreter(f,p)}},{key:"parse",value:function(f){return l.defaultInstance.parse(f)}}]),l}();e.ExtensibleEvents=o,s(o,"_defaultInstance",new o)},{"./InvalidEventError":154,"./NamespacedMap":155,"./events/message_types":164,"./events/poll_types":165,"./interpreters/legacy/MRoomMessage":168,"./interpreters/modern/MMessage":169,"./interpreters/modern/MPoll":170}],153:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0})},{}],154:[function(t,E,e){function u(l){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(v){return typeof v}:function(v){return v&&typeof Symbol=="function"&&v.constructor===Symbol&&v!==Symbol.prototype?"symbol":typeof v},u(l)}Object.defineProperty(e,"__esModule",{value:!0}),e.InvalidEventError=void 0;function g(l,v){for(var f=0;f<v.length;f++){var p=v[f];p.enumerable=p.enumerable||!1,p.configurable=!0,"value"in p&&(p.writable=!0),Object.defineProperty(l,p.key,p)}}function S(l,v,f){return v&&g(l.prototype,v),f&&g(l,f),Object.defineProperty(l,"prototype",{writable:!1}),l}function y(l,v){if(!(l instanceof v))throw new TypeError("Cannot call a class as a function")}function c(l,v){if(typeof v!="function"&&v!==null)throw new TypeError("Super expression must either be null or a function");l.prototype=Object.create(v&&v.prototype,{constructor:{value:l,writable:!0,configurable:!0}}),Object.defineProperty(l,"prototype",{writable:!1}),v&&r(l,v)}function m(l){var v=n();return function(){var p=s(l),_;if(v){var T=s(this).constructor;_=Reflect.construct(p,arguments,T)}else _=p.apply(this,arguments);return h(this,_)}}function h(l,v){if(v&&(u(v)==="object"||typeof v=="function"))return v;if(v!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return d(l)}function d(l){if(l===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return l}function b(l){var v=typeof Map=="function"?new Map:void 0;return b=function(p){if(p===null||!i(p))return p;if(typeof p!="function")throw new TypeError("Super expression must either be null or a function");if(typeof v<"u"){if(v.has(p))return v.get(p);v.set(p,_)}function _(){return a(p,arguments,s(this).constructor)}return _.prototype=Object.create(p.prototype,{constructor:{value:_,enumerable:!1,writable:!0,configurable:!0}}),r(_,p)},b(l)}function a(l,v,f){return n()?a=Reflect.construct:a=function(_,T,w){var M=[null];M.push.apply(M,T);var A=Function.bind.apply(_,M),W=new A;return w&&r(W,w.prototype),W},a.apply(null,arguments)}function n(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function i(l){return Function.toString.call(l).indexOf("[native code]")!==-1}function r(l,v){return r=Object.setPrototypeOf||function(p,_){return p.__proto__=_,p},r(l,v)}function s(l){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(f){return f.__proto__||Object.getPrototypeOf(f)},s(l)}var o=function(l){c(f,l);var v=m(f);function f(p){return y(this,f),v.call(this,p)}return S(f)}(b(Error));e.InvalidEventError=o},{}],155:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.NamespacedMap=void 0;function u(b,a){var n=typeof Symbol<"u"&&b[Symbol.iterator]||b["@@iterator"];if(!n){if(Array.isArray(b)||(n=g(b))||a&&b&&typeof b.length=="number"){n&&(b=n);var i=0,r=function(){};return{s:r,n:function(){return i>=b.length?{done:!0}:{done:!1,value:b[i++]}},e:function(f){throw f},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var s=!0,o=!1,l;return{s:function(){n=n.call(b)},n:function(){var f=n.next();return s=f.done,f},e:function(f){o=!0,l=f},f:function(){try{!s&&n.return!=null&&n.return()}finally{if(o)throw l}}}}function g(b,a){if(b){if(typeof b=="string")return S(b,a);var n=Object.prototype.toString.call(b).slice(8,-1);if(n==="Object"&&b.constructor&&(n=b.constructor.name),n==="Map"||n==="Set")return Array.from(b);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return S(b,a)}}function S(b,a){(a==null||a>b.length)&&(a=b.length);for(var n=0,i=new Array(a);n<a;n++)i[n]=b[n];return i}function y(b,a){if(!(b instanceof a))throw new TypeError("Cannot call a class as a function")}function c(b,a){for(var n=0;n<a.length;n++){var i=a[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(b,i.key,i)}}function m(b,a,n){return a&&c(b.prototype,a),n&&c(b,n),Object.defineProperty(b,"prototype",{writable:!1}),b}function h(b,a,n){return a in b?Object.defineProperty(b,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):b[a]=n,b}var d=function(){function b(a){if(y(this,b),h(this,"internalMap",new Map),a){var n=u(a),i;try{for(n.s();!(i=n.n()).done;){var r=i.value;this.set(r[0],r[1])}}catch(s){n.e(s)}finally{n.f()}}}return m(b,[{key:"get",value:function(n){return n.name&&this.internalMap.has(n.name)?this.internalMap.get(n.name):n.altName&&this.internalMap.has(n.altName)?this.internalMap.get(n.altName):null}},{key:"set",value:function(n,i){n.name&&this.internalMap.set(n.name,i),n.altName&&this.internalMap.set(n.altName,i)}},{key:"has",value:function(n){return!!this.get(n)}},{key:"delete",value:function(n){n.name&&this.internalMap.delete(n.name),n.altName&&this.internalMap.delete(n.altName)}},{key:"hasNamespaced",value:function(n){return this.internalMap.has(n)}},{key:"getNamespaced",value:function(n){return this.internalMap.get(n)}}]),b}();e.NamespacedMap=d},{}],156:[function(t,E,e){function u(s){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(o){return typeof o}:function(o){return o&&typeof Symbol=="function"&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},u(s)}Object.defineProperty(e,"__esModule",{value:!0}),e.UnstableValue=e.NamespacedValue=void 0;function g(s,o){if(typeof o!="function"&&o!==null)throw new TypeError("Super expression must either be null or a function");s.prototype=Object.create(o&&o.prototype,{constructor:{value:s,writable:!0,configurable:!0}}),Object.defineProperty(s,"prototype",{writable:!1}),o&&S(s,o)}function S(s,o){return S=Object.setPrototypeOf||function(v,f){return v.__proto__=f,v},S(s,o)}function y(s){var o=h();return function(){var v=d(s),f;if(o){var p=d(this).constructor;f=Reflect.construct(v,arguments,p)}else f=v.apply(this,arguments);return c(this,f)}}function c(s,o){if(o&&(u(o)==="object"||typeof o=="function"))return o;if(o!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return m(s)}function m(s){if(s===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return s}function h(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function d(s){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(l){return l.__proto__||Object.getPrototypeOf(l)},d(s)}function b(s,o){if(!(s instanceof o))throw new TypeError("Cannot call a class as a function")}function a(s,o){for(var l=0;l<o.length;l++){var v=o[l];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(s,v.key,v)}}function n(s,o,l){return o&&a(s.prototype,o),l&&a(s,l),Object.defineProperty(s,"prototype",{writable:!1}),s}var i=function(){function s(o,l){if(b(this,s),this.stable=o,this.unstable=l,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return n(s,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(l){return!!this.name&&this.name===l||!!this.altName&&this.altName===l}},{key:"findIn",value:function(l){var v;return this.name&&(v=l==null?void 0:l[this.name]),!v&&this.altName&&(v=l==null?void 0:l[this.altName]),v}},{key:"includedIn",value:function(l){var v=!1;return this.name&&(v=l.includes(this.name)),!v&&this.altName&&(v=l.includes(this.altName)),v}}]),s}();e.NamespacedValue=i;var r=function(s){g(l,s);var o=y(l);function l(v,f){var p;if(b(this,l),p=o.call(this,v,f),!p.unstable)throw new Error("Unstable value must be supplied");return p}return n(l,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),l}(i);e.UnstableValue=r},{}],157:[function(t,E,e){function u(p){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(_){return typeof _}:function(_){return _&&typeof Symbol=="function"&&_.constructor===Symbol&&_!==Symbol.prototype?"symbol":typeof _},u(p)}Object.defineProperty(e,"__esModule",{value:!0}),e.EmoteEvent=void 0;var g=t("./MessageEvent"),S=t("./message_types"),y=t("../utility/events");function c(p,_,T){return _ in p?Object.defineProperty(p,_,{value:T,enumerable:!0,configurable:!0,writable:!0}):p[_]=T,p}function m(p,_){if(!(p instanceof _))throw new TypeError("Cannot call a class as a function")}function h(p,_){for(var T=0;T<_.length;T++){var w=_[T];w.enumerable=w.enumerable||!1,w.configurable=!0,"value"in w&&(w.writable=!0),Object.defineProperty(p,w.key,w)}}function d(p,_,T){return _&&h(p.prototype,_),T&&h(p,T),Object.defineProperty(p,"prototype",{writable:!1}),p}function b(){return typeof Reflect<"u"&&Reflect.get?b=Reflect.get:b=function(_,T,w){var M=a(_,T);if(M){var A=Object.getOwnPropertyDescriptor(M,T);return A.get?A.get.call(arguments.length<3?_:w):A.value}},b.apply(this,arguments)}function a(p,_){for(;!Object.prototype.hasOwnProperty.call(p,_)&&(p=v(p),p!==null););return p}function n(p,_){if(typeof _!="function"&&_!==null)throw new TypeError("Super expression must either be null or a function");p.prototype=Object.create(_&&_.prototype,{constructor:{value:p,writable:!0,configurable:!0}}),Object.defineProperty(p,"prototype",{writable:!1}),_&&i(p,_)}function i(p,_){return i=Object.setPrototypeOf||function(w,M){return w.__proto__=M,w},i(p,_)}function r(p){var _=l();return function(){var w=v(p),M;if(_){var A=v(this).constructor;M=Reflect.construct(w,arguments,A)}else M=w.apply(this,arguments);return s(this,M)}}function s(p,_){if(_&&(u(_)==="object"||typeof _=="function"))return _;if(_!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return o(p)}function o(p){if(p===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return p}function l(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function v(p){return v=Object.setPrototypeOf?Object.getPrototypeOf:function(T){return T.__proto__||Object.getPrototypeOf(T)},v(p)}var f=function(p){n(T,p);var _=r(T);function T(w){return m(this,T),_.call(this,w)}return d(T,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(M){return(0,y.isEventTypeSame)(M,S.M_EMOTE)||b(v(T.prototype),"isEquivalentTo",this).call(this,M)}},{key:"serialize",value:function(){var M=b(v(T.prototype),"serialize",this).call(this);return M.content.msgtype="m.emote",M}}],[{key:"from",value:function(M,A){var W;return new T({type:S.M_EMOTE.name,content:(W={},c(W,S.M_TEXT.name,M),c(W,S.M_HTML.name,A),W)})}}]),T}(g.MessageEvent);e.EmoteEvent=f},{"../utility/events":173,"./MessageEvent":159,"./message_types":164}],158:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ExtensibleEvent=void 0;function u(c,m){if(!(c instanceof m))throw new TypeError("Cannot call a class as a function")}function g(c,m){for(var h=0;h<m.length;h++){var d=m[h];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(c,d.key,d)}}function S(c,m,h){return m&&g(c.prototype,m),h&&g(c,h),Object.defineProperty(c,"prototype",{writable:!1}),c}var y=function(){function c(m){u(this,c),this.wireFormat=m}return S(c,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),c}();e.ExtensibleEvent=y},{}],159:[function(t,E,e){function u(T){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(w){return typeof w}:function(w){return w&&typeof Symbol=="function"&&w.constructor===Symbol&&w!==Symbol.prototype?"symbol":typeof w},u(T)}Object.defineProperty(e,"__esModule",{value:!0}),e.MessageEvent=void 0;var g=t("./ExtensibleEvent"),S=t("../types"),y=t("../InvalidEventError"),c=t("./message_types"),m=t("../utility/events");function h(T,w){var M=Object.keys(T);if(Object.getOwnPropertySymbols){var A=Object.getOwnPropertySymbols(T);w&&(A=A.filter(function(W){return Object.getOwnPropertyDescriptor(T,W).enumerable})),M.push.apply(M,A)}return M}function d(T){for(var w=1;w<arguments.length;w++){var M=arguments[w]!=null?arguments[w]:{};w%2?h(Object(M),!0).forEach(function(A){p(T,A,M[A])}):Object.getOwnPropertyDescriptors?Object.defineProperties(T,Object.getOwnPropertyDescriptors(M)):h(Object(M)).forEach(function(A){Object.defineProperty(T,A,Object.getOwnPropertyDescriptor(M,A))})}return T}function b(T,w){if(!(T instanceof w))throw new TypeError("Cannot call a class as a function")}function a(T,w){for(var M=0;M<w.length;M++){var A=w[M];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(T,A.key,A)}}function n(T,w,M){return w&&a(T.prototype,w),M&&a(T,M),Object.defineProperty(T,"prototype",{writable:!1}),T}function i(T,w){if(typeof w!="function"&&w!==null)throw new TypeError("Super expression must either be null or a function");T.prototype=Object.create(w&&w.prototype,{constructor:{value:T,writable:!0,configurable:!0}}),Object.defineProperty(T,"prototype",{writable:!1}),w&&r(T,w)}function r(T,w){return r=Object.setPrototypeOf||function(A,W){return A.__proto__=W,A},r(T,w)}function s(T){var w=v();return function(){var A=f(T),W;if(w){var ee=f(this).constructor;W=Reflect.construct(A,arguments,ee)}else W=A.apply(this,arguments);return o(this,W)}}function o(T,w){if(w&&(u(w)==="object"||typeof w=="function"))return w;if(w!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return l(T)}function l(T){if(T===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return T}function v(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function f(T){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(M){return M.__proto__||Object.getPrototypeOf(M)},f(T)}function p(T,w,M){return w in T?Object.defineProperty(T,w,{value:M,enumerable:!0,configurable:!0,writable:!0}):T[w]=M,T}var _=function(T){i(M,T);var w=s(M);function M(A){var W;b(this,M),W=w.call(this,A),p(l(W),"text",void 0),p(l(W),"html",void 0),p(l(W),"renderings",void 0);var ee=c.M_MESSAGE.findIn(W.wireContent),F=c.M_TEXT.findIn(W.wireContent),C=c.M_HTML.findIn(W.wireContent);if((0,S.isProvided)(ee)){if(!Array.isArray(ee))throw new y.InvalidEventError("m.message contents must be an array");var O=ee.find(function(D){return!(0,S.isProvided)(D.mimetype)||D.mimetype==="text/plain"}),I=ee.find(function(D){return D.mimetype==="text/html"});if(!O)throw new y.InvalidEventError("m.message is missing a plain text representation");W.text=O.body,W.html=I==null?void 0:I.body,W.renderings=ee}else if((0,S.isOptionalAString)(F))W.text=F,W.html=C,W.renderings=[{body:F,mimetype:"text/plain"}],W.html&&W.renderings.push({body:W.html,mimetype:"text/html"});else throw new y.InvalidEventError("Missing textual representation for event");return W}return n(M,[{key:"isEmote",get:function(){return c.M_EMOTE.matches(this.wireFormat.type)||(0,S.isProvided)(c.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return c.M_NOTICE.matches(this.wireFormat.type)||(0,S.isProvided)(c.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(W){return(0,m.isEventTypeSame)(W,c.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var W=p({},c.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var ee=this.renderings[0].mimetype;(ee===void 0||ee==="text/plain")&&(W=p({},c.M_TEXT.name,this.renderings[0].body))}return W}},{key:"serialize",value:function(){var W;return{type:"m.room.message",content:d(d({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(W=this.html)!==null&&W!==void 0?W:void 0})}}}],[{key:"from",value:function(W,ee){var F;return new M({type:c.M_MESSAGE.name,content:(F={},p(F,c.M_TEXT.name,W),p(F,c.M_HTML.name,ee),F)})}}]),M}(g.ExtensibleEvent);e.MessageEvent=_},{"../InvalidEventError":154,"../types":171,"../utility/events":173,"./ExtensibleEvent":158,"./message_types":164}],160:[function(t,E,e){function u(p){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(_){return typeof _}:function(_){return _&&typeof Symbol=="function"&&_.constructor===Symbol&&_!==Symbol.prototype?"symbol":typeof _},u(p)}Object.defineProperty(e,"__esModule",{value:!0}),e.NoticeEvent=void 0;var g=t("./MessageEvent"),S=t("./message_types"),y=t("../utility/events");function c(p,_,T){return _ in p?Object.defineProperty(p,_,{value:T,enumerable:!0,configurable:!0,writable:!0}):p[_]=T,p}function m(p,_){if(!(p instanceof _))throw new TypeError("Cannot call a class as a function")}function h(p,_){for(var T=0;T<_.length;T++){var w=_[T];w.enumerable=w.enumerable||!1,w.configurable=!0,"value"in w&&(w.writable=!0),Object.defineProperty(p,w.key,w)}}function d(p,_,T){return _&&h(p.prototype,_),T&&h(p,T),Object.defineProperty(p,"prototype",{writable:!1}),p}function b(){return typeof Reflect<"u"&&Reflect.get?b=Reflect.get:b=function(_,T,w){var M=a(_,T);if(M){var A=Object.getOwnPropertyDescriptor(M,T);return A.get?A.get.call(arguments.length<3?_:w):A.value}},b.apply(this,arguments)}function a(p,_){for(;!Object.prototype.hasOwnProperty.call(p,_)&&(p=v(p),p!==null););return p}function n(p,_){if(typeof _!="function"&&_!==null)throw new TypeError("Super expression must either be null or a function");p.prototype=Object.create(_&&_.prototype,{constructor:{value:p,writable:!0,configurable:!0}}),Object.defineProperty(p,"prototype",{writable:!1}),_&&i(p,_)}function i(p,_){return i=Object.setPrototypeOf||function(w,M){return w.__proto__=M,w},i(p,_)}function r(p){var _=l();return function(){var w=v(p),M;if(_){var A=v(this).constructor;M=Reflect.construct(w,arguments,A)}else M=w.apply(this,arguments);return s(this,M)}}function s(p,_){if(_&&(u(_)==="object"||typeof _=="function"))return _;if(_!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return o(p)}function o(p){if(p===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return p}function l(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function v(p){return v=Object.setPrototypeOf?Object.getPrototypeOf:function(T){return T.__proto__||Object.getPrototypeOf(T)},v(p)}var f=function(p){n(T,p);var _=r(T);function T(w){return m(this,T),_.call(this,w)}return d(T,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(M){return(0,y.isEventTypeSame)(M,S.M_NOTICE)||b(v(T.prototype),"isEquivalentTo",this).call(this,M)}},{key:"serialize",value:function(){var M=b(v(T.prototype),"serialize",this).call(this);return M.content.msgtype="m.notice",M}}],[{key:"from",value:function(M,A){var W;return new T({type:S.M_NOTICE.name,content:(W={},c(W,S.M_TEXT.name,M),c(W,S.M_HTML.name,A),W)})}}]),T}(g.MessageEvent);e.NoticeEvent=f},{"../utility/events":173,"./MessageEvent":159,"./message_types":164}],161:[function(t,E,e){function u(M){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(A){return typeof A}:function(A){return A&&typeof Symbol=="function"&&A.constructor===Symbol&&A!==Symbol.prototype?"symbol":typeof A},u(M)}Object.defineProperty(e,"__esModule",{value:!0}),e.PollEndEvent=void 0;var g=t("./poll_types"),S=t("../InvalidEventError"),y=t("./relationship_types"),c=t("./MessageEvent"),m=t("./message_types"),h=t("../utility/events"),d=t("./ExtensibleEvent");function b(M,A){var W=Object.keys(M);if(Object.getOwnPropertySymbols){var ee=Object.getOwnPropertySymbols(M);A&&(ee=ee.filter(function(F){return Object.getOwnPropertyDescriptor(M,F).enumerable})),W.push.apply(W,ee)}return W}function a(M){for(var A=1;A<arguments.length;A++){var W=arguments[A]!=null?arguments[A]:{};A%2?b(Object(W),!0).forEach(function(ee){T(M,ee,W[ee])}):Object.getOwnPropertyDescriptors?Object.defineProperties(M,Object.getOwnPropertyDescriptors(W)):b(Object(W)).forEach(function(ee){Object.defineProperty(M,ee,Object.getOwnPropertyDescriptor(W,ee))})}return M}function n(M,A){if(!(M instanceof A))throw new TypeError("Cannot call a class as a function")}function i(M,A){for(var W=0;W<A.length;W++){var ee=A[W];ee.enumerable=ee.enumerable||!1,ee.configurable=!0,"value"in ee&&(ee.writable=!0),Object.defineProperty(M,ee.key,ee)}}function r(M,A,W){return A&&i(M.prototype,A),W&&i(M,W),Object.defineProperty(M,"prototype",{writable:!1}),M}function s(M,A){if(typeof A!="function"&&A!==null)throw new TypeError("Super expression must either be null or a function");M.prototype=Object.create(A&&A.prototype,{constructor:{value:M,writable:!0,configurable:!0}}),Object.defineProperty(M,"prototype",{writable:!1}),A&&o(M,A)}function o(M,A){return o=Object.setPrototypeOf||function(ee,F){return ee.__proto__=F,ee},o(M,A)}function l(M){var A=p();return function(){var ee=_(M),F;if(A){var C=_(this).constructor;F=Reflect.construct(ee,arguments,C)}else F=ee.apply(this,arguments);return v(this,F)}}function v(M,A){if(A&&(u(A)==="object"||typeof A=="function"))return A;if(A!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return f(M)}function f(M){if(M===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return M}function p(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function _(M){return _=Object.setPrototypeOf?Object.getPrototypeOf:function(W){return W.__proto__||Object.getPrototypeOf(W)},_(M)}function T(M,A,W){return A in M?Object.defineProperty(M,A,{value:W,enumerable:!0,configurable:!0,writable:!0}):M[A]=W,M}var w=function(M){s(W,M);var A=l(W);function W(ee){var F;n(this,W),F=A.call(this,ee),T(f(F),"pollEventId",void 0),T(f(F),"closingMessage",void 0);var C=F.wireContent["m.relates_to"];if(!y.REFERENCE_RELATION.matches(C==null?void 0:C.rel_type)||typeof(C==null?void 0:C.event_id)!="string")throw new S.InvalidEventError("Relationship must be a reference to an event");return F.pollEventId=C.event_id,F.closingMessage=new c.MessageEvent(F.wireFormat),F}return r(W,[{key:"isEquivalentTo",value:function(F){return(0,h.isEventTypeSame)(F,g.M_POLL_END)}},{key:"serialize",value:function(){return{type:g.M_POLL_END.name,content:a(T({"m.relates_to":{rel_type:y.REFERENCE_RELATION.name,event_id:this.pollEventId}},g.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(F,C){var O;return new W({type:g.M_POLL_END.name,content:(O={"m.relates_to":{rel_type:y.REFERENCE_RELATION.name,event_id:F}},T(O,g.M_POLL_END.name,{}),T(O,m.M_TEXT.name,C),O)})}}]),W}(d.ExtensibleEvent);e.PollEndEvent=w},{"../InvalidEventError":154,"../utility/events":173,"./ExtensibleEvent":158,"./MessageEvent":159,"./message_types":164,"./poll_types":165,"./relationship_types":166}],162:[function(t,E,e){function u(p){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(_){return typeof _}:function(_){return _&&typeof Symbol=="function"&&_.constructor===Symbol&&_!==Symbol.prototype?"symbol":typeof _},u(p)}Object.defineProperty(e,"__esModule",{value:!0}),e.PollResponseEvent=void 0;var g=t("./ExtensibleEvent"),S=t("./poll_types"),y=t("../InvalidEventError"),c=t("./relationship_types"),m=t("../utility/events");function h(p,_){if(!(p instanceof _))throw new TypeError("Cannot call a class as a function")}function d(p,_){for(var T=0;T<_.length;T++){var w=_[T];w.enumerable=w.enumerable||!1,w.configurable=!0,"value"in w&&(w.writable=!0),Object.defineProperty(p,w.key,w)}}function b(p,_,T){return _&&d(p.prototype,_),T&&d(p,T),Object.defineProperty(p,"prototype",{writable:!1}),p}function a(p,_){if(typeof _!="function"&&_!==null)throw new TypeError("Super expression must either be null or a function");p.prototype=Object.create(_&&_.prototype,{constructor:{value:p,writable:!0,configurable:!0}}),Object.defineProperty(p,"prototype",{writable:!1}),_&&n(p,_)}function n(p,_){return n=Object.setPrototypeOf||function(w,M){return w.__proto__=M,w},n(p,_)}function i(p){var _=o();return function(){var w=l(p),M;if(_){var A=l(this).constructor;M=Reflect.construct(w,arguments,A)}else M=w.apply(this,arguments);return r(this,M)}}function r(p,_){if(_&&(u(_)==="object"||typeof _=="function"))return _;if(_!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return s(p)}function s(p){if(p===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return p}function o(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function l(p){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(T){return T.__proto__||Object.getPrototypeOf(T)},l(p)}function v(p,_,T){return _ in p?Object.defineProperty(p,_,{value:T,enumerable:!0,configurable:!0,writable:!0}):p[_]=T,p}var f=function(p){a(T,p);var _=i(T);function T(w){var M;h(this,T),M=_.call(this,w),v(s(M),"internalAnswerIds",void 0),v(s(M),"internalSpoiled",void 0),v(s(M),"pollEventId",void 0);var A=M.wireContent["m.relates_to"];if(!c.REFERENCE_RELATION.matches(A==null?void 0:A.rel_type)||typeof(A==null?void 0:A.event_id)!="string")throw new y.InvalidEventError("Relationship must be a reference to an event");return M.pollEventId=A.event_id,M.validateAgainst(null),M}return b(T,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(M){var A=S.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(A==null?void 0:A.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var W=A.answers;if(W.some(function(ee){return typeof ee!="string"})||W.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(M){if(W.some(function(ee){return!M.answers.some(function(F){return F.id===ee})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}W=W.slice(0,M.maxSelections)}this.internalAnswerIds=W,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(M){return(0,m.isEventTypeSame)(M,S.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:S.M_POLL_RESPONSE.name,content:v({"m.relates_to":{rel_type:c.REFERENCE_RELATION.name,event_id:this.pollEventId}},S.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(M,A){return new T({type:S.M_POLL_RESPONSE.name,content:v({"m.relates_to":{rel_type:c.REFERENCE_RELATION.name,event_id:A}},S.M_POLL_RESPONSE.name,{answers:M})})}}]),T}(g.ExtensibleEvent);e.PollResponseEvent=f},{"../InvalidEventError":154,"../utility/events":173,"./ExtensibleEvent":158,"./poll_types":165,"./relationship_types":166}],163:[function(t,E,e){function u(j){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(Y){return typeof Y}:function(Y){return Y&&typeof Symbol=="function"&&Y.constructor===Symbol&&Y!==Symbol.prototype?"symbol":typeof Y},u(j)}Object.defineProperty(e,"__esModule",{value:!0}),e.PollStartEvent=e.PollAnswerSubevent=void 0;var g=t("./poll_types"),S=t("./MessageEvent"),y=t("./message_types"),c=t("../InvalidEventError"),m=t("../NamespacedValue"),h=t("../utility/events"),d=t("./ExtensibleEvent");function b(j){return r(j)||i(j)||n(j)||a()}function a(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function n(j,Y){if(j){if(typeof j=="string")return s(j,Y);var q=Object.prototype.toString.call(j).slice(8,-1);if(q==="Object"&&j.constructor&&(q=j.constructor.name),q==="Map"||q==="Set")return Array.from(j);if(q==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(q))return s(j,Y)}}function i(j){if(typeof Symbol<"u"&&j[Symbol.iterator]!=null||j["@@iterator"]!=null)return Array.from(j)}function r(j){if(Array.isArray(j))return s(j)}function s(j,Y){(Y==null||Y>j.length)&&(Y=j.length);for(var q=0,B=new Array(Y);q<Y;q++)B[q]=j[q];return B}function o(j,Y){var q=Object.keys(j);if(Object.getOwnPropertySymbols){var B=Object.getOwnPropertySymbols(j);Y&&(B=B.filter(function(R){return Object.getOwnPropertyDescriptor(j,R).enumerable})),q.push.apply(q,B)}return q}function l(j){for(var Y=1;Y<arguments.length;Y++){var q=arguments[Y]!=null?arguments[Y]:{};Y%2?o(Object(q),!0).forEach(function(B){F(j,B,q[B])}):Object.getOwnPropertyDescriptors?Object.defineProperties(j,Object.getOwnPropertyDescriptors(q)):o(Object(q)).forEach(function(B){Object.defineProperty(j,B,Object.getOwnPropertyDescriptor(q,B))})}return j}function v(j,Y){if(!(j instanceof Y))throw new TypeError("Cannot call a class as a function")}function f(j,Y){for(var q=0;q<Y.length;q++){var B=Y[q];B.enumerable=B.enumerable||!1,B.configurable=!0,"value"in B&&(B.writable=!0),Object.defineProperty(j,B.key,B)}}function p(j,Y,q){return Y&&f(j.prototype,Y),q&&f(j,q),Object.defineProperty(j,"prototype",{writable:!1}),j}function _(j,Y){if(typeof Y!="function"&&Y!==null)throw new TypeError("Super expression must either be null or a function");j.prototype=Object.create(Y&&Y.prototype,{constructor:{value:j,writable:!0,configurable:!0}}),Object.defineProperty(j,"prototype",{writable:!1}),Y&&T(j,Y)}function T(j,Y){return T=Object.setPrototypeOf||function(B,R){return B.__proto__=R,B},T(j,Y)}function w(j){var Y=W();return function(){var B=ee(j),R;if(Y){var k=ee(this).constructor;R=Reflect.construct(B,arguments,k)}else R=B.apply(this,arguments);return M(this,R)}}function M(j,Y){if(Y&&(u(Y)==="object"||typeof Y=="function"))return Y;if(Y!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return A(j)}function A(j){if(j===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return j}function W(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ee(j){return ee=Object.setPrototypeOf?Object.getPrototypeOf:function(q){return q.__proto__||Object.getPrototypeOf(q)},ee(j)}function F(j,Y,q){return Y in j?Object.defineProperty(j,Y,{value:q,enumerable:!0,configurable:!0,writable:!0}):j[Y]=q,j}var C=function(j){_(q,j);var Y=w(q);function q(B){var R;v(this,q),R=Y.call(this,B),F(A(R),"id",void 0);var k=B.content.id;if(!k||typeof k!="string")throw new c.InvalidEventError("Answer ID must be a non-empty string");return R.id=k,R}return p(q,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:l({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(R,k){return new q({type:"org.matrix.sdk.poll.answer",content:F({id:R},y.M_TEXT.name,k)})}}]),q}(S.MessageEvent);e.PollAnswerSubevent=C;var O=function(j){_(q,j);var Y=w(q);function q(B){var R;v(this,q),R=Y.call(this,B),F(A(R),"question",void 0),F(A(R),"kind",void 0),F(A(R),"rawKind",void 0),F(A(R),"maxSelections",void 0),F(A(R),"answers",void 0);var k=g.M_POLL_START.findIn(R.wireContent);if(!k.question)throw new c.InvalidEventError("A question is required");if(R.question=new S.MessageEvent({type:"org.matrix.sdk.poll.question",content:k.question}),R.rawKind=k.kind,g.M_POLL_KIND_DISCLOSED.matches(R.rawKind)?R.kind=g.M_POLL_KIND_DISCLOSED:R.kind=g.M_POLL_KIND_UNDISCLOSED,R.maxSelections=Number.isFinite(k.max_selections)&&k.max_selections>0?k.max_selections:1,!Array.isArray(k.answers))throw new c.InvalidEventError("Poll answers must be an array");var P=k.answers.slice(0,20).map(function(V){return new C({type:"org.matrix.sdk.poll.answer",content:V})});if(P.length<=0)throw new c.InvalidEventError("No answers available");return R.answers=P,R}return p(q,[{key:"isEquivalentTo",value:function(R){return(0,h.isEventTypeSame)(R,g.M_POLL_START)}},{key:"serialize",value:function(){var R;return{type:g.M_POLL_START.name,content:(R={},F(R,g.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(k){return k.serialize().content})}),F(R,y.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(k,P){return"".concat(P+1,". ").concat(k.text)}).join(`
`))),R)}}}],[{key:"from",value:function(R,k,P){var V,x=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new q({type:g.M_POLL_START.name,content:(V={},F(V,y.M_TEXT.name,R),F(V,g.M_POLL_START.name,{question:F({},y.M_TEXT.name,R),kind:P instanceof m.NamespacedValue?P.name:P,max_selections:x,answers:k.map(function(Q){return F({id:D()},y.M_TEXT.name,Q)})}),V)})}}]),q}(d.ExtensibleEvent);e.PollStartEvent=O;var I="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function D(){return b(Array(16)).map(function(){return I.charAt(Math.floor(Math.random()*I.length))}).join("")}},{"../InvalidEventError":154,"../NamespacedValue":156,"../utility/events":173,"./ExtensibleEvent":158,"./MessageEvent":159,"./message_types":164,"./poll_types":165}],164:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.M_TEXT=e.M_NOTICE=e.M_MESSAGE=e.M_HTML=e.M_EMOTE=void 0;var u=t("../NamespacedValue"),g=new u.UnstableValue("m.message","org.matrix.msc1767.message");e.M_MESSAGE=g;var S=new u.UnstableValue("m.text","org.matrix.msc1767.text");e.M_TEXT=S;var y=new u.UnstableValue("m.html","org.matrix.msc1767.html");e.M_HTML=y;var c=new u.UnstableValue("m.emote","org.matrix.msc1767.emote");e.M_EMOTE=c;var m=new u.UnstableValue("m.notice","org.matrix.msc1767.notice");e.M_NOTICE=m},{"../NamespacedValue":156}],165:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.M_POLL_START=e.M_POLL_RESPONSE=e.M_POLL_KIND_UNDISCLOSED=e.M_POLL_KIND_DISCLOSED=e.M_POLL_END=void 0;var u=t("../NamespacedValue"),g=new u.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");e.M_POLL_KIND_DISCLOSED=g;var S=new u.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");e.M_POLL_KIND_UNDISCLOSED=S;var y=new u.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");e.M_POLL_START=y;var c=new u.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");e.M_POLL_RESPONSE=c;var m=new u.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");e.M_POLL_END=m},{"../NamespacedValue":156}],166:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.REFERENCE_RELATION=void 0;var u=t("../NamespacedValue"),g=new u.NamespacedValue("m.reference");e.REFERENCE_RELATION=g},{"../NamespacedValue":156}],167:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0});var u=t("./ExtensibleEvents");Object.keys(u).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===u[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return u[w]}})});var g=t("./IPartialEvent");Object.keys(g).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===g[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return g[w]}})});var S=t("./InvalidEventError");Object.keys(S).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===S[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return S[w]}})});var y=t("./NamespacedValue");Object.keys(y).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===y[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return y[w]}})});var c=t("./NamespacedMap");Object.keys(c).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===c[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return c[w]}})});var m=t("./types");Object.keys(m).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===m[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return m[w]}})});var h=t("./utility/MessageMatchers");Object.keys(h).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===h[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return h[w]}})});var d=t("./utility/events");Object.keys(d).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===d[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return d[w]}})});var b=t("./interpreters/legacy/MRoomMessage");Object.keys(b).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===b[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return b[w]}})});var a=t("./interpreters/modern/MMessage");Object.keys(a).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===a[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return a[w]}})});var n=t("./interpreters/modern/MPoll");Object.keys(n).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===n[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return n[w]}})});var i=t("./events/relationship_types");Object.keys(i).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===i[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return i[w]}})});var r=t("./events/ExtensibleEvent");Object.keys(r).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===r[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return r[w]}})});var s=t("./events/message_types");Object.keys(s).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===s[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return s[w]}})});var o=t("./events/MessageEvent");Object.keys(o).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===o[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return o[w]}})});var l=t("./events/EmoteEvent");Object.keys(l).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===l[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return l[w]}})});var v=t("./events/NoticeEvent");Object.keys(v).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===v[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return v[w]}})});var f=t("./events/poll_types");Object.keys(f).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===f[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return f[w]}})});var p=t("./events/PollStartEvent");Object.keys(p).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===p[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return p[w]}})});var _=t("./events/PollResponseEvent");Object.keys(_).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===_[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return _[w]}})});var T=t("./events/PollEndEvent");Object.keys(T).forEach(function(w){w==="default"||w==="__esModule"||w in e&&e[w]===T[w]||Object.defineProperty(e,w,{enumerable:!0,get:function(){return T[w]}})})},{"./ExtensibleEvents":152,"./IPartialEvent":153,"./InvalidEventError":154,"./NamespacedMap":155,"./NamespacedValue":156,"./events/EmoteEvent":157,"./events/ExtensibleEvent":158,"./events/MessageEvent":159,"./events/NoticeEvent":160,"./events/PollEndEvent":161,"./events/PollResponseEvent":162,"./events/PollStartEvent":163,"./events/message_types":164,"./events/poll_types":165,"./events/relationship_types":166,"./interpreters/legacy/MRoomMessage":168,"./interpreters/modern/MMessage":169,"./interpreters/modern/MPoll":170,"./types":171,"./utility/MessageMatchers":172,"./utility/events":173}],168:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.LEGACY_M_ROOM_MESSAGE=void 0,e.parseMRoomMessage=a;var u=t("../../events/MessageEvent"),g=t("../../events/NoticeEvent"),S=t("../../events/EmoteEvent"),y=t("../../NamespacedValue"),c=t("../../events/message_types");function m(n,i){var r=Object.keys(n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(n);i&&(s=s.filter(function(o){return Object.getOwnPropertyDescriptor(n,o).enumerable})),r.push.apply(r,s)}return r}function h(n){for(var i=1;i<arguments.length;i++){var r=arguments[i]!=null?arguments[i]:{};i%2?m(Object(r),!0).forEach(function(s){d(n,s,r[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach(function(s){Object.defineProperty(n,s,Object.getOwnPropertyDescriptor(r,s))})}return n}function d(n,i,r){return i in n?Object.defineProperty(n,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[i]=r,n}var b=new y.NamespacedValue("m.room.message");e.LEGACY_M_ROOM_MESSAGE=b;function a(n){var i,r,s;if(c.M_MESSAGE.findIn(n.content)||c.M_TEXT.findIn(n.content))return new u.MessageEvent(n);var o=(i=n.content)===null||i===void 0?void 0:i.msgtype,l=(r=n.content)===null||r===void 0?void 0:r.body,v=((s=n.content)===null||s===void 0?void 0:s.format)==="org.matrix.custom.html"?n.content.formatted_body:null;if(o==="m.text"){var f;return new u.MessageEvent(h(h({},n),{},{content:h(h({},n.content),{},(f={},d(f,c.M_TEXT.name,l),d(f,c.M_HTML.name,v),f))}))}else if(o==="m.notice"){var p;return new g.NoticeEvent(h(h({},n),{},{content:h(h({},n.content),{},(p={},d(p,c.M_TEXT.name,l),d(p,c.M_HTML.name,v),p))}))}else if(o==="m.emote"){var _;return new S.EmoteEvent(h(h({},n),{},{content:h(h({},n.content),{},(_={},d(_,c.M_TEXT.name,l),d(_,c.M_HTML.name,v),_))}))}else return null}},{"../../NamespacedValue":156,"../../events/EmoteEvent":157,"../../events/MessageEvent":159,"../../events/NoticeEvent":160,"../../events/message_types":164}],169:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.parseMMessage=c;var u=t("../../events/MessageEvent"),g=t("../../events/message_types"),S=t("../../events/EmoteEvent"),y=t("../../events/NoticeEvent");function c(m){return g.M_EMOTE.matches(m.type)?new S.EmoteEvent(m):g.M_NOTICE.matches(m.type)?new y.NoticeEvent(m):new u.MessageEvent(m)}},{"../../events/EmoteEvent":157,"../../events/MessageEvent":159,"../../events/NoticeEvent":160,"../../events/message_types":164}],170:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.parseMPoll=c;var u=t("../../events/poll_types"),g=t("../../events/PollStartEvent"),S=t("../../events/PollResponseEvent"),y=t("../../events/PollEndEvent");function c(m){return u.M_POLL_START.matches(m.type)?new g.PollStartEvent(m):u.M_POLL_RESPONSE.matches(m.type)?new S.PollResponseEvent(m):u.M_POLL_END.matches(m.type)?new y.PollEndEvent(m):null}},{"../../events/PollEndEvent":161,"../../events/PollResponseEvent":162,"../../events/PollStartEvent":163,"../../events/poll_types":165}],171:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isOptionalAString=u,e.isProvided=g;function u(S){return g(S)&&typeof S=="string"}function g(S){return S!=null}},{}],172:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.LegacyMsgType=void 0,e.isEventLike=S;var u=t("../events/message_types"),g;e.LegacyMsgType=g,function(y){y.Text="m.text",y.Notice="m.notice",y.Emote="m.emote"}(g||(e.LegacyMsgType=g={}));function S(y,c){var m=y.content;return c===g.Text?u.M_MESSAGE.matches(y.type)||y.type==="m.room.message"&&(m==null?void 0:m.msgtype)==="m.text":c===g.Emote?u.M_EMOTE.matches(y.type)||y.type==="m.room.message"&&(m==null?void 0:m.msgtype)==="m.emote":c===g.Notice?u.M_NOTICE.matches(y.type)||y.type==="m.room.message"&&(m==null?void 0:m.msgtype)==="m.notice":!1}},{"../events/message_types":164}],173:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isEventTypeSame=u;function u(g,S){if(typeof g=="string")return typeof S=="string"?S===g:S.matches(g);if(typeof S=="string")return g.matches(S);var y=S,c=g;return y.matches(c.name)||y.matches(c.altName)}},{}],174:[function(t,E,e){function u(q){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(B){return typeof B}:function(B){return B&&typeof Symbol=="function"&&B.constructor===Symbol&&B!==Symbol.prototype?"symbol":typeof B},u(q)}Object.defineProperty(e,"__esModule",{value:!0}),e.ClientWidgetApi=void 0;var g=t("events"),S=t("./transport/PostmessageTransport"),y=t("./interfaces/WidgetApiDirection"),c=t("./interfaces/WidgetApiAction"),m=t("./interfaces/Capabilities"),h=t("./interfaces/ApiVersion"),d=t("./models/WidgetEventCapability"),b=t("./interfaces/GetOpenIDAction"),a=t("./util/SimpleObservable"),n=t("./Symbols");function i(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */i=function(){return q};var q={},B=Object.prototype,R=B.hasOwnProperty,k=typeof Symbol=="function"?Symbol:{},P=k.iterator||"@@iterator",V=k.asyncIterator||"@@asyncIterator",x=k.toStringTag||"@@toStringTag";function Q(he,fe,ve){return Object.defineProperty(he,fe,{value:ve,enumerable:!0,configurable:!0,writable:!0}),he[fe]}try{Q({},"")}catch{Q=function(ve,ye,Ee){return ve[ye]=Ee}}function te(he,fe,ve,ye){var Ee=fe&&fe.prototype instanceof X?fe:X,we=Object.create(Ee.prototype),me=new oe(ye||[]);return we._invoke=function(N,Z,ie){var se="suspendedStart";return function(le,ge){if(se==="executing")throw new Error("Generator is already running");if(se==="completed"){if(le==="throw")throw ge;return pe()}for(ie.method=le,ie.arg=ge;;){var be=ie.delegate;if(be){var Se=z(be,ie);if(Se){if(Se===de)continue;return Se}}if(ie.method==="next")ie.sent=ie._sent=ie.arg;else if(ie.method==="throw"){if(se==="suspendedStart")throw se="completed",ie.arg;ie.dispatchException(ie.arg)}else ie.method==="return"&&ie.abrupt("return",ie.arg);se="executing";var _e=ae(N,Z,ie);if(_e.type==="normal"){if(se=ie.done?"completed":"suspendedYield",_e.arg===de)continue;return{value:_e.arg,done:ie.done}}_e.type==="throw"&&(se="completed",ie.method="throw",ie.arg=_e.arg)}}}(he,ve,me),we}function ae(he,fe,ve){try{return{type:"normal",arg:he.call(fe,ve)}}catch(ye){return{type:"throw",arg:ye}}}q.wrap=te;var de={};function X(){}function $(){}function K(){}var re={};Q(re,P,function(){return this});var ue=Object.getPrototypeOf,H=ue&&ue(ue(ce([])));H&&H!==B&&R.call(H,P)&&(re=H);var G=K.prototype=X.prototype=Object.create(re);function U(he){["next","throw","return"].forEach(function(fe){Q(he,fe,function(ve){return this._invoke(fe,ve)})})}function L(he,fe){function ve(Ee,we,me,N){var Z=ae(he[Ee],he,we);if(Z.type!=="throw"){var ie=Z.arg,se=ie.value;return se&&u(se)=="object"&&R.call(se,"__await")?fe.resolve(se.__await).then(function(le){ve("next",le,me,N)},function(le){ve("throw",le,me,N)}):fe.resolve(se).then(function(le){ie.value=le,me(ie)},function(le){return ve("throw",le,me,N)})}N(Z.arg)}var ye;this._invoke=function(Ee,we){function me(){return new fe(function(N,Z){ve(Ee,we,N,Z)})}return ye=ye?ye.then(me,me):me()}}function z(he,fe){var ve=he.iterator[fe.method];if(ve===void 0){if(fe.delegate=null,fe.method==="throw"){if(he.iterator.return&&(fe.method="return",fe.arg=void 0,z(he,fe),fe.method==="throw"))return de;fe.method="throw",fe.arg=new TypeError("The iterator does not provide a 'throw' method")}return de}var ye=ae(ve,he.iterator,fe.arg);if(ye.type==="throw")return fe.method="throw",fe.arg=ye.arg,fe.delegate=null,de;var Ee=ye.arg;return Ee?Ee.done?(fe[he.resultName]=Ee.value,fe.next=he.nextLoc,fe.method!=="return"&&(fe.method="next",fe.arg=void 0),fe.delegate=null,de):Ee:(fe.method="throw",fe.arg=new TypeError("iterator result is not an object"),fe.delegate=null,de)}function J(he){var fe={tryLoc:he[0]};1 in he&&(fe.catchLoc=he[1]),2 in he&&(fe.finallyLoc=he[2],fe.afterLoc=he[3]),this.tryEntries.push(fe)}function ne(he){var fe=he.completion||{};fe.type="normal",delete fe.arg,he.completion=fe}function oe(he){this.tryEntries=[{tryLoc:"root"}],he.forEach(J,this),this.reset(!0)}function ce(he){if(he){var fe=he[P];if(fe)return fe.call(he);if(typeof he.next=="function")return he;if(!isNaN(he.length)){var ve=-1,ye=function Ee(){for(;++ve<he.length;)if(R.call(he,ve))return Ee.value=he[ve],Ee.done=!1,Ee;return Ee.value=void 0,Ee.done=!0,Ee};return ye.next=ye}}return{next:pe}}function pe(){return{value:void 0,done:!0}}return $.prototype=K,Q(G,"constructor",K),Q(K,"constructor",$),$.displayName=Q(K,x,"GeneratorFunction"),q.isGeneratorFunction=function(he){var fe=typeof he=="function"&&he.constructor;return!!fe&&(fe===$||(fe.displayName||fe.name)==="GeneratorFunction")},q.mark=function(he){return Object.setPrototypeOf?Object.setPrototypeOf(he,K):(he.__proto__=K,Q(he,x,"GeneratorFunction")),he.prototype=Object.create(G),he},q.awrap=function(he){return{__await:he}},U(L.prototype),Q(L.prototype,V,function(){return this}),q.AsyncIterator=L,q.async=function(he,fe,ve,ye,Ee){Ee===void 0&&(Ee=Promise);var we=new L(te(he,fe,ve,ye),Ee);return q.isGeneratorFunction(fe)?we:we.next().then(function(me){return me.done?me.value:we.next()})},U(G),Q(G,x,"Generator"),Q(G,P,function(){return this}),Q(G,"toString",function(){return"[object Generator]"}),q.keys=function(he){var fe=[];for(var ve in he)fe.push(ve);return fe.reverse(),function ye(){for(;fe.length;){var Ee=fe.pop();if(Ee in he)return ye.value=Ee,ye.done=!1,ye}return ye.done=!0,ye}},q.values=ce,oe.prototype={constructor:oe,reset:function(fe){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(ne),!fe)for(var ve in this)ve.charAt(0)==="t"&&R.call(this,ve)&&!isNaN(+ve.slice(1))&&(this[ve]=void 0)},stop:function(){this.done=!0;var fe=this.tryEntries[0].completion;if(fe.type==="throw")throw fe.arg;return this.rval},dispatchException:function(fe){if(this.done)throw fe;var ve=this;function ye(ie,se){return me.type="throw",me.arg=fe,ve.next=ie,se&&(ve.method="next",ve.arg=void 0),!!se}for(var Ee=this.tryEntries.length-1;Ee>=0;--Ee){var we=this.tryEntries[Ee],me=we.completion;if(we.tryLoc==="root")return ye("end");if(we.tryLoc<=this.prev){var N=R.call(we,"catchLoc"),Z=R.call(we,"finallyLoc");if(N&&Z){if(this.prev<we.catchLoc)return ye(we.catchLoc,!0);if(this.prev<we.finallyLoc)return ye(we.finallyLoc)}else if(N){if(this.prev<we.catchLoc)return ye(we.catchLoc,!0)}else{if(!Z)throw new Error("try statement without catch or finally");if(this.prev<we.finallyLoc)return ye(we.finallyLoc)}}}},abrupt:function(fe,ve){for(var ye=this.tryEntries.length-1;ye>=0;--ye){var Ee=this.tryEntries[ye];if(Ee.tryLoc<=this.prev&&R.call(Ee,"finallyLoc")&&this.prev<Ee.finallyLoc){var we=Ee;break}}we&&(fe==="break"||fe==="continue")&&we.tryLoc<=ve&&ve<=we.finallyLoc&&(we=null);var me=we?we.completion:{};return me.type=fe,me.arg=ve,we?(this.method="next",this.next=we.finallyLoc,de):this.complete(me)},complete:function(fe,ve){if(fe.type==="throw")throw fe.arg;return fe.type==="break"||fe.type==="continue"?this.next=fe.arg:fe.type==="return"?(this.rval=this.arg=fe.arg,this.method="return",this.next="end"):fe.type==="normal"&&ve&&(this.next=ve),de},finish:function(fe){for(var ve=this.tryEntries.length-1;ve>=0;--ve){var ye=this.tryEntries[ve];if(ye.finallyLoc===fe)return this.complete(ye.completion,ye.afterLoc),ne(ye),de}},catch:function(fe){for(var ve=this.tryEntries.length-1;ve>=0;--ve){var ye=this.tryEntries[ve];if(ye.tryLoc===fe){var Ee=ye.completion;if(Ee.type==="throw"){var we=Ee.arg;ne(ye)}return we}}throw new Error("illegal catch attempt")},delegateYield:function(fe,ve,ye){return this.delegate={iterator:ce(fe),resultName:ve,nextLoc:ye},this.method==="next"&&(this.arg=void 0),de}},q}function r(q,B,R,k,P,V,x){try{var Q=q[V](x),te=Q.value}catch(ae){R(ae);return}Q.done?B(te):Promise.resolve(te).then(k,P)}function s(q){return function(){var B=this,R=arguments;return new Promise(function(k,P){var V=q.apply(B,R);function x(te){r(V,k,P,x,Q,"next",te)}function Q(te){r(V,k,P,x,Q,"throw",te)}x(void 0)})}}function o(q,B){var R=typeof Symbol<"u"&&q[Symbol.iterator]||q["@@iterator"];if(!R){if(Array.isArray(q)||(R=l(q))||B&&q&&typeof q.length=="number"){R&&(q=R);var k=0,P=function(){};return{s:P,n:function(){return k>=q.length?{done:!0}:{done:!1,value:q[k++]}},e:function(ae){throw ae},f:P}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var V=!0,x=!1,Q;return{s:function(){R=R.call(q)},n:function(){var ae=R.next();return V=ae.done,ae},e:function(ae){x=!0,Q=ae},f:function(){try{!V&&R.return!=null&&R.return()}finally{if(x)throw Q}}}}function l(q,B){if(q){if(typeof q=="string")return v(q,B);var R=Object.prototype.toString.call(q).slice(8,-1);if(R==="Object"&&q.constructor&&(R=q.constructor.name),R==="Map"||R==="Set")return Array.from(q);if(R==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(R))return v(q,B)}}function v(q,B){(B==null||B>q.length)&&(B=q.length);for(var R=0,k=new Array(B);R<B;R++)k[R]=q[R];return k}function f(q,B){var R=Object.keys(q);if(Object.getOwnPropertySymbols){var k=Object.getOwnPropertySymbols(q);B&&(k=k.filter(function(P){return Object.getOwnPropertyDescriptor(q,P).enumerable})),R.push.apply(R,k)}return R}function p(q){for(var B=1;B<arguments.length;B++){var R=arguments[B]!=null?arguments[B]:{};B%2?f(Object(R),!0).forEach(function(k){I(q,k,R[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(q,Object.getOwnPropertyDescriptors(R)):f(Object(R)).forEach(function(k){Object.defineProperty(q,k,Object.getOwnPropertyDescriptor(R,k))})}return q}function _(q,B){if(!(q instanceof B))throw new TypeError("Cannot call a class as a function")}function T(q,B){for(var R=0;R<B.length;R++){var k=B[R];k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(q,k.key,k)}}function w(q,B,R){return B&&T(q.prototype,B),R&&T(q,R),Object.defineProperty(q,"prototype",{writable:!1}),q}function M(q,B){if(typeof B!="function"&&B!==null)throw new TypeError("Super expression must either be null or a function");q.prototype=Object.create(B&&B.prototype,{constructor:{value:q,writable:!0,configurable:!0}}),Object.defineProperty(q,"prototype",{writable:!1}),B&&A(q,B)}function A(q,B){return A=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(k,P){return k.__proto__=P,k},A(q,B)}function W(q){var B=C();return function(){var k=O(q),P;if(B){var V=O(this).constructor;P=Reflect.construct(k,arguments,V)}else P=k.apply(this,arguments);return ee(this,P)}}function ee(q,B){if(B&&(u(B)==="object"||typeof B=="function"))return B;if(B!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return F(q)}function F(q){if(q===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return q}function C(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function O(q){return O=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(R){return R.__proto__||Object.getPrototypeOf(R)},O(q)}function I(q,B,R){return B in q?Object.defineProperty(q,B,{value:R,enumerable:!0,configurable:!0,writable:!0}):q[B]=R,q}function D(q){var B,R,k,P=2;for(typeof Symbol<"u"&&(R=Symbol.asyncIterator,k=Symbol.iterator);P--;){if(R&&(B=q[R])!=null)return B.call(q);if(k&&(B=q[k])!=null)return new j(B.call(q));R="@@asyncIterator",k="@@iterator"}throw new TypeError("Object is not async iterable")}function j(q){function B(R){if(Object(R)!==R)return Promise.reject(new TypeError(R+" is not an object."));var k=R.done;return Promise.resolve(R.value).then(function(P){return{value:P,done:k}})}return j=function(k){this.s=k,this.n=k.next},j.prototype={s:null,n:null,next:function(){return B(this.n.apply(this.s,arguments))},return:function(k){var P=this.s.return;return P===void 0?Promise.resolve({value:k,done:!0}):B(P.apply(this.s,arguments))},throw:function(k){var P=this.s.return;return P===void 0?Promise.reject(k):B(P.apply(this.s,arguments))}},new j(q)}var Y=function(q){M(R,q);var B=W(R);function R(k,P,V){var x;if(_(this,R),x=B.call(this),x.widget=k,x.iframe=P,x.driver=V,I(F(x),"transport",void 0),I(F(x),"contentLoadedActionSent",!1),I(F(x),"allowedCapabilities",new Set),I(F(x),"allowedEvents",[]),I(F(x),"isStopped",!1),I(F(x),"turnServers",null),!(P!=null&&P.contentWindow))throw new Error("No iframe supplied");if(!k)throw new Error("Invalid widget");if(!V)throw new Error("Invalid driver");return x.transport=new S.PostmessageTransport(y.WidgetApiDirection.ToWidget,k.id,P.contentWindow,window),x.transport.targetOrigin=k.origin,x.transport.on("message",x.handleMessage.bind(F(x))),P.addEventListener("load",x.onIframeLoad.bind(F(x))),x.transport.start(),x}return w(R,[{key:"hasCapability",value:function(P){return this.allowedCapabilities.has(P)}},{key:"canUseRoomTimeline",value:function(P){return this.hasCapability("org.matrix.msc2762.timeline:".concat(n.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(P))}},{key:"canSendRoomEvent",value:function(P){var V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(x){return x.matchesAsRoomEvent(d.EventDirection.Send,P,V)})}},{key:"canSendStateEvent",value:function(P,V){return this.allowedEvents.some(function(x){return x.matchesAsStateEvent(d.EventDirection.Send,P,V)})}},{key:"canSendToDeviceEvent",value:function(P){return this.allowedEvents.some(function(V){return V.matchesAsToDeviceEvent(d.EventDirection.Send,P)})}},{key:"canReceiveRoomEvent",value:function(P){var V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(x){return x.matchesAsRoomEvent(d.EventDirection.Receive,P,V)})}},{key:"canReceiveStateEvent",value:function(P,V){return this.allowedEvents.some(function(x){return x.matchesAsStateEvent(d.EventDirection.Receive,P,V)})}},{key:"canReceiveToDeviceEvent",value:function(P){return this.allowedEvents.some(function(V){return V.matchesAsToDeviceEvent(d.EventDirection.Receive,P)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"beginCapabilities",value:function(){var P=this;this.emit("preparing");var V;this.transport.send(c.WidgetApiToWidgetAction.Capabilities,{}).then(function(x){return V=x.capabilities,P.driver.validateCapabilities(new Set(x.capabilities))}).then(function(x){console.log("Widget ".concat(P.widget.id," is allowed capabilities:"),Array.from(x)),P.allowedCapabilities=x,P.allowedEvents=d.WidgetEventCapability.findEventCapabilities(x),P.notifyCapabilities(V),P.emit("ready")})}},{key:"notifyCapabilities",value:function(P){var V=this;this.transport.send(c.WidgetApiToWidgetAction.NotifyCapabilities,{requested:P,approved:Array.from(this.allowedCapabilities)}).catch(function(x){console.warn("non-fatal error notifying widget of approved capabilities:",x)}).then(function(){V.emit("capabilitiesNotified")})}},{key:"onIframeLoad",value:function(P){this.widget.waitForIframeLoad?this.beginCapabilities():this.contentLoadedActionSent=!1}},{key:"handleContentLoadedAction",value:function(P){if(this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be send once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(P,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframLoad is true (default=true)"}}):(this.transport.reply(P,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(P){this.transport.reply(P,{supported_versions:h.CurrentApiVersions})}},{key:"handleCapabilitiesRenegotiate",value:function(P){var V,x=this;this.transport.reply(P,{});var Q=((V=P.data)===null||V===void 0?void 0:V.capabilities)||[],te=new Set(Q.filter(function(ae){return!x.hasCapability(ae)}));if(te.size===0)return this.notifyCapabilities([]);this.driver.validateCapabilities(te).then(function(ae){ae.forEach(function(X){return x.allowedCapabilities.add(X)});var de=d.WidgetEventCapability.findEventCapabilities(ae);return de.forEach(function(X){return x.allowedEvents.push(X)}),x.notifyCapabilities(Array.from(te))})}},{key:"handleNavigate",value:function(P){var V,x,Q=this;if(!this.hasCapability(m.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(P,{error:{message:"Missing capability"}});if(!((V=P.data)!==null&&V!==void 0&&V.uri)||!((x=P.data)!==null&&x!==void 0&&x.uri.toString().startsWith("https://matrix.to/#")))return this.transport.reply(P,{error:{message:"Invalid matrix.to URI"}});var te=function(de){return console.error("[ClientWidgetApi] Failed to handle navigation: ",de),Q.transport.reply(P,{error:{message:"Error handling navigation"}})};try{this.driver.navigate(P.data.uri.toString()).catch(function(ae){return te(ae)}).then(function(){return Q.transport.reply(P,{})})}catch(ae){return te(ae)}}},{key:"handleOIDC",value:function(P){var V=this,x=1,Q=function(X,$){return $=$||{},x>1?V.transport.send(c.WidgetApiToWidgetAction.OpenIDCredentials,p({state:X,original_request_id:P.requestId},$)):V.transport.reply(P,p({state:X},$))},te=function(X){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",X),x>1?Q(b.OpenIDRequestState.Blocked):V.transport.reply(P,{error:{message:X}})},ae=new a.SimpleObservable(function(de){if(de.state===b.OpenIDRequestState.PendingUserConfirmation&&x>1)return ae.close(),te("client provided out-of-phase response to OIDC flow");if(de.state===b.OpenIDRequestState.PendingUserConfirmation){Q(de.state),x++;return}return de.state===b.OpenIDRequestState.Allowed&&!de.token?te("client provided invalid OIDC token for an allowed request"):(de.state===b.OpenIDRequestState.Blocked&&(de.token=void 0),ae.close(),Q(de.state,de.token))});this.driver.askOpenID(ae)}},{key:"handleReadEvents",value:function(P){var V=this;if(!P.data.type)return this.transport.reply(P,{error:{message:"Invalid request - missing event type"}});if(P.data.limit!==void 0&&(!P.data.limit||P.data.limit<0))return this.transport.reply(P,{error:{message:"Invalid request - limit out of range"}});var x=null;if(P.data.room_ids){x=P.data.room_ids,Array.isArray(x)||(x=[x]);var Q=o(x),te;try{for(Q.s();!(te=Q.n()).done;){var ae=te.value;if(!this.canUseRoomTimeline(ae))return this.transport.reply(P,{error:{message:"Unable to access room timeline: ".concat(ae)}})}}catch(K){Q.e(K)}finally{Q.f()}}var de=P.data.limit||0,X=Promise.resolve([]);if(P.data.state_key!==void 0){var $=P.data.state_key===!0?void 0:P.data.state_key.toString();if(!this.canReceiveStateEvent(P.data.type,$??null))return this.transport.reply(P,{error:{message:"Cannot read state events of this type"}});X=this.driver.readStateEvents(P.data.type,$,de,x)}else{if(!this.canReceiveRoomEvent(P.data.type,P.data.msgtype))return this.transport.reply(P,{error:{message:"Cannot read room events of this type"}});X=this.driver.readRoomEvents(P.data.type,P.data.msgtype,de,x)}return X.then(function(K){return V.transport.reply(P,{events:K})})}},{key:"handleSendEvent",value:function(P){var V=this;if(!P.data.type)return this.transport.reply(P,{error:{message:"Invalid request - missing event type"}});if(P.data.room_id&&!this.canUseRoomTimeline(P.data.room_id))return this.transport.reply(P,{error:{message:"Unable to access room timeline: ".concat(P.data.room_id)}});var x=P.data.state_key!==null&&P.data.state_key!==void 0,Q;if(x){if(!this.canSendStateEvent(P.data.type,P.data.state_key))return this.transport.reply(P,{error:{message:"Cannot send state events of this type"}});Q=this.driver.sendEvent(P.data.type,P.data.content||{},P.data.state_key,P.data.room_id)}else{var te=P.data.content||{},ae=te.msgtype;if(!this.canSendRoomEvent(P.data.type,ae))return this.transport.reply(P,{error:{message:"Cannot send room events of this type"}});Q=this.driver.sendEvent(P.data.type,te,null,P.data.room_id)}Q.then(function(de){return V.transport.reply(P,{room_id:de.roomId,event_id:de.eventId})}).catch(function(de){return console.error("error sending event: ",de),V.transport.reply(P,{error:{message:"Error sending event"}})})}},{key:"handleSendToDevice",value:function(){var k=s(i().mark(function V(x){return i().wrap(function(te){for(;;)switch(te.prev=te.next){case 0:if(x.data.type){te.next=5;break}return te.next=3,this.transport.reply(x,{error:{message:"Invalid request - missing event type"}});case 3:te.next=32;break;case 5:if(x.data.messages){te.next=10;break}return te.next=8,this.transport.reply(x,{error:{message:"Invalid request - missing event contents"}});case 8:te.next=32;break;case 10:if(typeof x.data.encrypted=="boolean"){te.next=15;break}return te.next=13,this.transport.reply(x,{error:{message:"Invalid request - missing encryption flag"}});case 13:te.next=32;break;case 15:if(this.canSendToDeviceEvent(x.data.type)){te.next=20;break}return te.next=18,this.transport.reply(x,{error:{message:"Cannot send to-device events of this type"}});case 18:te.next=32;break;case 20:return te.prev=20,te.next=23,this.driver.sendToDevice(x.data.type,x.data.encrypted,x.data.messages);case 23:return te.next=25,this.transport.reply(x,{});case 25:te.next=32;break;case 27:return te.prev=27,te.t0=te.catch(20),console.error("error sending to-device event",te.t0),te.next=32,this.transport.reply(x,{error:{message:"Error sending event"}});case 32:case"end":return te.stop()}},V,this,[[20,27]])}));function P(V){return k.apply(this,arguments)}return P}()},{key:"pollTurnServers",value:function(){var k=s(i().mark(function V(x,Q){var te,ae,de,X,$,K;return i().wrap(function(ue){for(;;)switch(ue.prev=ue.next){case 0:return ue.prev=0,ue.next=3,this.transport.send(c.WidgetApiToWidgetAction.UpdateTurnServers,Q);case 3:te=!1,ae=!1,ue.prev=5,X=D(x);case 7:return ue.next=9,X.next();case 9:if(!(te=!($=ue.sent).done)){ue.next=16;break}return K=$.value,ue.next=13,this.transport.send(c.WidgetApiToWidgetAction.UpdateTurnServers,K);case 13:te=!1,ue.next=7;break;case 16:ue.next=22;break;case 18:ue.prev=18,ue.t0=ue.catch(5),ae=!0,de=ue.t0;case 22:if(ue.prev=22,ue.prev=23,!(te&&X.return!=null)){ue.next=27;break}return ue.next=27,X.return();case 27:if(ue.prev=27,!ae){ue.next=30;break}throw de;case 30:return ue.finish(27);case 31:return ue.finish(22);case 32:ue.next=37;break;case 34:ue.prev=34,ue.t1=ue.catch(0),console.error("error polling for TURN servers",ue.t1);case 37:case"end":return ue.stop()}},V,this,[[0,34],[5,18,22,32],[23,,27,31]])}));function P(V,x){return k.apply(this,arguments)}return P}()},{key:"handleWatchTurnServers",value:function(){var k=s(i().mark(function V(x){var Q,te,ae,de;return i().wrap(function($){for(;;)switch($.prev=$.next){case 0:if(this.hasCapability(m.MatrixCapabilities.MSC3846TurnServers)){$.next=5;break}return $.next=3,this.transport.reply(x,{error:{message:"Missing capability"}});case 3:$.next=30;break;case 5:if(!this.turnServers){$.next=10;break}return $.next=8,this.transport.reply(x,{});case 8:$.next=30;break;case 10:return $.prev=10,Q=this.driver.getTurnServers(),$.next=14,Q.next();case 14:if(te=$.sent,ae=te.done,de=te.value,!ae){$.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return $.next=21,this.transport.reply(x,{});case 21:this.pollTurnServers(Q,de),this.turnServers=Q,$.next=30;break;case 25:return $.prev=25,$.t0=$.catch(10),console.error("error getting first TURN server results",$.t0),$.next=30,this.transport.reply(x,{error:{message:"TURN servers not available"}});case 30:case"end":return $.stop()}},V,this,[[10,25]])}));function P(V){return k.apply(this,arguments)}return P}()},{key:"handleUnwatchTurnServers",value:function(){var k=s(i().mark(function V(x){return i().wrap(function(te){for(;;)switch(te.prev=te.next){case 0:if(this.hasCapability(m.MatrixCapabilities.MSC3846TurnServers)){te.next=5;break}return te.next=3,this.transport.reply(x,{error:{message:"Missing capability"}});case 3:te.next=15;break;case 5:if(this.turnServers){te.next=10;break}return te.next=8,this.transport.reply(x,{});case 8:te.next=15;break;case 10:return te.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,te.next=15,this.transport.reply(x,{});case 15:case"end":return te.stop()}},V,this)}));function P(V){return k.apply(this,arguments)}return P}()},{key:"handleReadRelations",value:function(){var k=s(i().mark(function V(x){var Q=this,te,ae;return i().wrap(function(X){for(;;)switch(X.prev=X.next){case 0:if(x.data.event_id){X.next=2;break}return X.abrupt("return",this.transport.reply(x,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(x.data.limit!==void 0&&x.data.limit<0)){X.next=4;break}return X.abrupt("return",this.transport.reply(x,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(x.data.room_id!==void 0&&!this.canUseRoomTimeline(x.data.room_id))){X.next=6;break}return X.abrupt("return",this.transport.reply(x,{error:{message:"Unable to access room timeline: ".concat(x.data.room_id)}}));case 6:return X.prev=6,X.next=9,this.driver.readEventRelations(x.data.event_id,x.data.room_id,x.data.rel_type,x.data.event_type,x.data.from,x.data.to,x.data.limit,x.data.direction);case 9:return te=X.sent,ae=te.chunk.filter(function($){return $.state_key!==void 0?Q.canReceiveStateEvent($.type,$.state_key):Q.canReceiveRoomEvent($.type,$.content.msgtype)}),X.abrupt("return",this.transport.reply(x,{chunk:ae,prev_batch:te.prevBatch,next_batch:te.nextBatch}));case 14:return X.prev=14,X.t0=X.catch(6),console.error("error getting the relations",X.t0),X.next=19,this.transport.reply(x,{error:{message:"Unexpected error while reading relations"}});case 19:case"end":return X.stop()}},V,this,[[6,14]])}));function P(V){return k.apply(this,arguments)}return P}()},{key:"handleUserDirectorySearch",value:function(){var k=s(i().mark(function V(x){var Q;return i().wrap(function(ae){for(;;)switch(ae.prev=ae.next){case 0:if(this.hasCapability(m.MatrixCapabilities.MSC3973UserDirectorySearch)){ae.next=2;break}return ae.abrupt("return",this.transport.reply(x,{error:{message:"Missing capability"}}));case 2:if(typeof x.data.search_term=="string"){ae.next=4;break}return ae.abrupt("return",this.transport.reply(x,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(x.data.limit!==void 0&&x.data.limit<0)){ae.next=6;break}return ae.abrupt("return",this.transport.reply(x,{error:{message:"Invalid request - limit out of range"}}));case 6:return ae.prev=6,ae.next=9,this.driver.searchUserDirectory(x.data.search_term,x.data.limit);case 9:return Q=ae.sent,ae.abrupt("return",this.transport.reply(x,{limited:Q.limited,results:Q.results.map(function(de){return{user_id:de.userId,display_name:de.displayName,avatar_url:de.avatarUrl}})}));case 13:return ae.prev=13,ae.t0=ae.catch(6),console.error("error searching in the user directory",ae.t0),ae.next=18,this.transport.reply(x,{error:{message:"Unexpected error while searching in the user directory"}});case 18:case"end":return ae.stop()}},V,this,[[6,13]])}));function P(V){return k.apply(this,arguments)}return P}()},{key:"handleMessage",value:function(P){if(!this.isStopped){var V=new CustomEvent("action:".concat(P.detail.action),{detail:P.detail,cancelable:!0});if(this.emit("action:".concat(P.detail.action),V),!V.defaultPrevented)switch(P.detail.action){case c.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(P.detail);case c.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(P.detail);case c.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(P.detail);case c.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(P.detail);case c.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(P.detail);case c.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(P.detail);case c.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(P.detail);case c.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(P.detail);case c.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(P.detail);case c.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(P.detail);case c.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(P.detail);case c.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(P.detail);default:return this.transport.reply(P.detail,{error:{message:"Unknown or unsupported action: "+P.detail.action}})}}}},{key:"takeScreenshot",value:function(){return this.transport.send(c.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(P){return this.transport.send(c.WidgetApiToWidgetAction.UpdateVisibility,{visible:P})}},{key:"sendWidgetConfig",value:function(P){return this.transport.send(c.WidgetApiToWidgetAction.WidgetConfig,P).then()}},{key:"notifyModalWidgetButtonClicked",value:function(P){return this.transport.send(c.WidgetApiToWidgetAction.ButtonClicked,{id:P}).then()}},{key:"notifyModalWidgetClose",value:function(P){return this.transport.send(c.WidgetApiToWidgetAction.CloseModalWidget,P).then()}},{key:"feedEvent",value:function(){var k=s(i().mark(function V(x,Q){var te;return i().wrap(function(de){for(;;)switch(de.prev=de.next){case 0:if(!(x.room_id!==Q&&!this.canUseRoomTimeline(x.room_id))){de.next=2;break}return de.abrupt("return");case 2:if(!(x.state_key!==void 0&&x.state_key!==null)){de.next=7;break}if(this.canReceiveStateEvent(x.type,x.state_key)){de.next=5;break}return de.abrupt("return");case 5:de.next=9;break;case 7:if(this.canReceiveRoomEvent(x.type,(te=x.content)===null||te===void 0?void 0:te.msgtype)){de.next=9;break}return de.abrupt("return");case 9:return de.next=11,this.transport.send(c.WidgetApiToWidgetAction.SendEvent,x);case 11:case"end":return de.stop()}},V,this)}));function P(V,x){return k.apply(this,arguments)}return P}()},{key:"feedToDevice",value:function(){var k=s(i().mark(function V(x,Q){return i().wrap(function(ae){for(;;)switch(ae.prev=ae.next){case 0:if(!this.canReceiveToDeviceEvent(x.type)){ae.next=3;break}return ae.next=3,this.transport.send(c.WidgetApiToWidgetAction.SendToDevice,p(p({},x),{},{encrypted:Q}));case 3:case"end":return ae.stop()}},V,this)}));function P(V,x){return k.apply(this,arguments)}return P}()}]),R}(g.EventEmitter);e.ClientWidgetApi=Y},{"./Symbols":175,"./interfaces/ApiVersion":179,"./interfaces/Capabilities":180,"./interfaces/GetOpenIDAction":183,"./interfaces/WidgetApiAction":207,"./interfaces/WidgetApiDirection":208,"./models/WidgetEventCapability":213,"./transport/PostmessageTransport":219,"./util/SimpleObservable":220,events:105}],175:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Symbols=void 0;var u;e.Symbols=u,function(g){g.AnyRoom="*"}(u||(e.Symbols=u={}))},{}],176:[function(t,E,e){function u(D){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(j){return typeof j}:function(j){return j&&typeof Symbol=="function"&&j.constructor===Symbol&&j!==Symbol.prototype?"symbol":typeof j},u(D)}Object.defineProperty(e,"__esModule",{value:!0}),e.WidgetApi=void 0;var g=t("events"),S=t("./interfaces/WidgetApiDirection"),y=t("./interfaces/ApiVersion"),c=t("./transport/PostmessageTransport"),m=t("./interfaces/WidgetApiAction"),h=t("./interfaces/GetOpenIDAction"),d=t("./interfaces/WidgetType"),b=t("./interfaces/ModalWidgetActions"),a=t("./models/WidgetEventCapability"),n=t("./Symbols");function i(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */i=function(){return D};var D={},j=Object.prototype,Y=j.hasOwnProperty,q=typeof Symbol=="function"?Symbol:{},B=q.iterator||"@@iterator",R=q.asyncIterator||"@@asyncIterator",k=q.toStringTag||"@@toStringTag";function P(oe,ce,pe){return Object.defineProperty(oe,ce,{value:pe,enumerable:!0,configurable:!0,writable:!0}),oe[ce]}try{P({},"")}catch{P=function(pe,he,fe){return pe[he]=fe}}function V(oe,ce,pe,he){var fe=ce&&ce.prototype instanceof te?ce:te,ve=Object.create(fe.prototype),ye=new z(he||[]);return ve._invoke=function(Ee,we,me){var N="suspendedStart";return function(Z,ie){if(N==="executing")throw new Error("Generator is already running");if(N==="completed"){if(Z==="throw")throw ie;return ne()}for(me.method=Z,me.arg=ie;;){var se=me.delegate;if(se){var le=G(se,me);if(le){if(le===Q)continue;return le}}if(me.method==="next")me.sent=me._sent=me.arg;else if(me.method==="throw"){if(N==="suspendedStart")throw N="completed",me.arg;me.dispatchException(me.arg)}else me.method==="return"&&me.abrupt("return",me.arg);N="executing";var ge=x(Ee,we,me);if(ge.type==="normal"){if(N=me.done?"completed":"suspendedYield",ge.arg===Q)continue;return{value:ge.arg,done:me.done}}ge.type==="throw"&&(N="completed",me.method="throw",me.arg=ge.arg)}}}(oe,pe,ye),ve}function x(oe,ce,pe){try{return{type:"normal",arg:oe.call(ce,pe)}}catch(he){return{type:"throw",arg:he}}}D.wrap=V;var Q={};function te(){}function ae(){}function de(){}var X={};P(X,B,function(){return this});var $=Object.getPrototypeOf,K=$&&$($(J([])));K&&K!==j&&Y.call(K,B)&&(X=K);var re=de.prototype=te.prototype=Object.create(X);function ue(oe){["next","throw","return"].forEach(function(ce){P(oe,ce,function(pe){return this._invoke(ce,pe)})})}function H(oe,ce){function pe(fe,ve,ye,Ee){var we=x(oe[fe],oe,ve);if(we.type!=="throw"){var me=we.arg,N=me.value;return N&&u(N)=="object"&&Y.call(N,"__await")?ce.resolve(N.__await).then(function(Z){pe("next",Z,ye,Ee)},function(Z){pe("throw",Z,ye,Ee)}):ce.resolve(N).then(function(Z){me.value=Z,ye(me)},function(Z){return pe("throw",Z,ye,Ee)})}Ee(we.arg)}var he;this._invoke=function(fe,ve){function ye(){return new ce(function(Ee,we){pe(fe,ve,Ee,we)})}return he=he?he.then(ye,ye):ye()}}function G(oe,ce){var pe=oe.iterator[ce.method];if(pe===void 0){if(ce.delegate=null,ce.method==="throw"){if(oe.iterator.return&&(ce.method="return",ce.arg=void 0,G(oe,ce),ce.method==="throw"))return Q;ce.method="throw",ce.arg=new TypeError("The iterator does not provide a 'throw' method")}return Q}var he=x(pe,oe.iterator,ce.arg);if(he.type==="throw")return ce.method="throw",ce.arg=he.arg,ce.delegate=null,Q;var fe=he.arg;return fe?fe.done?(ce[oe.resultName]=fe.value,ce.next=oe.nextLoc,ce.method!=="return"&&(ce.method="next",ce.arg=void 0),ce.delegate=null,Q):fe:(ce.method="throw",ce.arg=new TypeError("iterator result is not an object"),ce.delegate=null,Q)}function U(oe){var ce={tryLoc:oe[0]};1 in oe&&(ce.catchLoc=oe[1]),2 in oe&&(ce.finallyLoc=oe[2],ce.afterLoc=oe[3]),this.tryEntries.push(ce)}function L(oe){var ce=oe.completion||{};ce.type="normal",delete ce.arg,oe.completion=ce}function z(oe){this.tryEntries=[{tryLoc:"root"}],oe.forEach(U,this),this.reset(!0)}function J(oe){if(oe){var ce=oe[B];if(ce)return ce.call(oe);if(typeof oe.next=="function")return oe;if(!isNaN(oe.length)){var pe=-1,he=function fe(){for(;++pe<oe.length;)if(Y.call(oe,pe))return fe.value=oe[pe],fe.done=!1,fe;return fe.value=void 0,fe.done=!0,fe};return he.next=he}}return{next:ne}}function ne(){return{value:void 0,done:!0}}return ae.prototype=de,P(re,"constructor",de),P(de,"constructor",ae),ae.displayName=P(de,k,"GeneratorFunction"),D.isGeneratorFunction=function(oe){var ce=typeof oe=="function"&&oe.constructor;return!!ce&&(ce===ae||(ce.displayName||ce.name)==="GeneratorFunction")},D.mark=function(oe){return Object.setPrototypeOf?Object.setPrototypeOf(oe,de):(oe.__proto__=de,P(oe,k,"GeneratorFunction")),oe.prototype=Object.create(re),oe},D.awrap=function(oe){return{__await:oe}},ue(H.prototype),P(H.prototype,R,function(){return this}),D.AsyncIterator=H,D.async=function(oe,ce,pe,he,fe){fe===void 0&&(fe=Promise);var ve=new H(V(oe,ce,pe,he),fe);return D.isGeneratorFunction(ce)?ve:ve.next().then(function(ye){return ye.done?ye.value:ve.next()})},ue(re),P(re,k,"Generator"),P(re,B,function(){return this}),P(re,"toString",function(){return"[object Generator]"}),D.keys=function(oe){var ce=[];for(var pe in oe)ce.push(pe);return ce.reverse(),function he(){for(;ce.length;){var fe=ce.pop();if(fe in oe)return he.value=fe,he.done=!1,he}return he.done=!0,he}},D.values=J,z.prototype={constructor:z,reset:function(ce){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(L),!ce)for(var pe in this)pe.charAt(0)==="t"&&Y.call(this,pe)&&!isNaN(+pe.slice(1))&&(this[pe]=void 0)},stop:function(){this.done=!0;var ce=this.tryEntries[0].completion;if(ce.type==="throw")throw ce.arg;return this.rval},dispatchException:function(ce){if(this.done)throw ce;var pe=this;function he(me,N){return ye.type="throw",ye.arg=ce,pe.next=me,N&&(pe.method="next",pe.arg=void 0),!!N}for(var fe=this.tryEntries.length-1;fe>=0;--fe){var ve=this.tryEntries[fe],ye=ve.completion;if(ve.tryLoc==="root")return he("end");if(ve.tryLoc<=this.prev){var Ee=Y.call(ve,"catchLoc"),we=Y.call(ve,"finallyLoc");if(Ee&&we){if(this.prev<ve.catchLoc)return he(ve.catchLoc,!0);if(this.prev<ve.finallyLoc)return he(ve.finallyLoc)}else if(Ee){if(this.prev<ve.catchLoc)return he(ve.catchLoc,!0)}else{if(!we)throw new Error("try statement without catch or finally");if(this.prev<ve.finallyLoc)return he(ve.finallyLoc)}}}},abrupt:function(ce,pe){for(var he=this.tryEntries.length-1;he>=0;--he){var fe=this.tryEntries[he];if(fe.tryLoc<=this.prev&&Y.call(fe,"finallyLoc")&&this.prev<fe.finallyLoc){var ve=fe;break}}ve&&(ce==="break"||ce==="continue")&&ve.tryLoc<=pe&&pe<=ve.finallyLoc&&(ve=null);var ye=ve?ve.completion:{};return ye.type=ce,ye.arg=pe,ve?(this.method="next",this.next=ve.finallyLoc,Q):this.complete(ye)},complete:function(ce,pe){if(ce.type==="throw")throw ce.arg;return ce.type==="break"||ce.type==="continue"?this.next=ce.arg:ce.type==="return"?(this.rval=this.arg=ce.arg,this.method="return",this.next="end"):ce.type==="normal"&&pe&&(this.next=pe),Q},finish:function(ce){for(var pe=this.tryEntries.length-1;pe>=0;--pe){var he=this.tryEntries[pe];if(he.finallyLoc===ce)return this.complete(he.completion,he.afterLoc),L(he),Q}},catch:function(ce){for(var pe=this.tryEntries.length-1;pe>=0;--pe){var he=this.tryEntries[pe];if(he.tryLoc===ce){var fe=he.completion;if(fe.type==="throw"){var ve=fe.arg;L(he)}return ve}}throw new Error("illegal catch attempt")},delegateYield:function(ce,pe,he){return this.delegate={iterator:J(ce),resultName:pe,nextLoc:he},this.method==="next"&&(this.arg=void 0),Q}},D}function r(D,j,Y,q,B,R,k){try{var P=D[R](k),V=P.value}catch(x){Y(x);return}P.done?j(V):Promise.resolve(V).then(q,B)}function s(D){return function(){var j=this,Y=arguments;return new Promise(function(q,B){var R=D.apply(j,Y);function k(V){r(R,q,B,k,P,"next",V)}function P(V){r(R,q,B,k,P,"throw",V)}k(void 0)})}}function o(D,j){if(!(D instanceof j))throw new TypeError("Cannot call a class as a function")}function l(D,j){for(var Y=0;Y<j.length;Y++){var q=j[Y];q.enumerable=q.enumerable||!1,q.configurable=!0,"value"in q&&(q.writable=!0),Object.defineProperty(D,q.key,q)}}function v(D,j,Y){return j&&l(D.prototype,j),Y&&l(D,Y),Object.defineProperty(D,"prototype",{writable:!1}),D}function f(D,j){if(typeof j!="function"&&j!==null)throw new TypeError("Super expression must either be null or a function");D.prototype=Object.create(j&&j.prototype,{constructor:{value:D,writable:!0,configurable:!0}}),Object.defineProperty(D,"prototype",{writable:!1}),j&&p(D,j)}function p(D,j){return p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(q,B){return q.__proto__=B,q},p(D,j)}function _(D){var j=M();return function(){var q=A(D),B;if(j){var R=A(this).constructor;B=Reflect.construct(q,arguments,R)}else B=q.apply(this,arguments);return T(this,B)}}function T(D,j){if(j&&(u(j)==="object"||typeof j=="function"))return j;if(j!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return w(D)}function w(D){if(D===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return D}function M(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function A(D){return A=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(Y){return Y.__proto__||Object.getPrototypeOf(Y)},A(D)}function W(D,j,Y){return j in D?Object.defineProperty(D,j,{value:Y,enumerable:!0,configurable:!0,writable:!0}):D[j]=Y,D}function ee(D){return new O(D)}function F(D){return function(){return new C(D.apply(this,arguments))}}function C(D){var j,Y;function q(k,P){return new Promise(function(V,x){var Q={key:k,arg:P,resolve:V,reject:x,next:null};Y?Y=Y.next=Q:(j=Y=Q,B(k,P))})}function B(k,P){try{var V=D[k](P),x=V.value,Q=x instanceof O;Promise.resolve(Q?x.wrapped:x).then(function(te){if(Q){B(k==="return"?"return":"next",te);return}R(V.done?"return":"normal",te)},function(te){B("throw",te)})}catch(te){R("throw",te)}}function R(k,P){switch(k){case"return":j.resolve({value:P,done:!0});break;case"throw":j.reject(P);break;default:j.resolve({value:P,done:!1});break}j=j.next,j?B(j.key,j.arg):Y=null}this._invoke=q,typeof D.return!="function"&&(this.return=void 0)}C.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},C.prototype.next=function(D){return this._invoke("next",D)},C.prototype.throw=function(D){return this._invoke("throw",D)},C.prototype.return=function(D){return this._invoke("return",D)};function O(D){this.wrapped=D}var I=function(D){f(Y,D);var j=_(Y);function Y(){var q,B=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,R=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(o(this,Y),q=j.call(this),q.clientOrigin=R,W(w(q),"transport",void 0),W(w(q),"capabilitiesFinished",!1),W(w(q),"supportsMSC2974Renegotiate",!1),W(w(q),"requestedCapabilities",[]),W(w(q),"approvedCapabilities",void 0),W(w(q),"cachedClientVersions",void 0),W(w(q),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return q.transport=new c.PostmessageTransport(S.WidgetApiDirection.FromWidget,B,window.parent,window),q.transport.targetOrigin=R,q.transport.on("message",q.handleMessage.bind(w(q))),q}return v(Y,[{key:"hasCapability",value:function(B){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(B):this.requestedCapabilities.includes(B)}},{key:"requestCapability",value:function(B){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(B)}},{key:"requestCapabilities",value:function(B){var R=this;B.forEach(function(k){return R.requestCapability(k)})}},{key:"requestCapabilityForRoomTimeline",value:function(B){this.requestCapability("org.matrix.msc2762.timeline:".concat(B))}},{key:"requestCapabilityToSendState",value:function(B,R){this.requestCapability(a.WidgetEventCapability.forStateEvent(a.EventDirection.Send,B,R).raw)}},{key:"requestCapabilityToReceiveState",value:function(B,R){this.requestCapability(a.WidgetEventCapability.forStateEvent(a.EventDirection.Receive,B,R).raw)}},{key:"requestCapabilityToSendToDevice",value:function(B){this.requestCapability(a.WidgetEventCapability.forToDeviceEvent(a.EventDirection.Send,B).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(B){this.requestCapability(a.WidgetEventCapability.forToDeviceEvent(a.EventDirection.Receive,B).raw)}},{key:"requestCapabilityToSendEvent",value:function(B){this.requestCapability(a.WidgetEventCapability.forRoomEvent(a.EventDirection.Send,B).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(B){this.requestCapability(a.WidgetEventCapability.forRoomEvent(a.EventDirection.Receive,B).raw)}},{key:"requestCapabilityToSendMessage",value:function(B){this.requestCapability(a.WidgetEventCapability.forRoomMessageEvent(a.EventDirection.Send,B).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(B){this.requestCapability(a.WidgetEventCapability.forRoomMessageEvent(a.EventDirection.Receive,B).raw)}},{key:"requestOpenIDConnectToken",value:function(){var B=this;return new Promise(function(R,k){B.transport.sendComplete(m.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(P){var V=P.response;if(V.state===h.OpenIDRequestState.Allowed)R(V);else if(V.state===h.OpenIDRequestState.Blocked)k(new Error("User declined to verify their identity"));else if(V.state===h.OpenIDRequestState.PendingUserConfirmation){var x=function Q(te){te.preventDefault();var ae=te.detail;ae.data.original_request_id===P.requestId&&(ae.data.state===h.OpenIDRequestState.Allowed?(R(ae.data),B.transport.reply(ae,{})):ae.data.state===h.OpenIDRequestState.Blocked?(k(new Error("User declined to verify their identity")),B.transport.reply(ae,{})):(k(new Error("Invalid state on reply: "+V.state)),B.transport.reply(ae,{error:{message:"Invalid state"}})),B.off("action:".concat(m.WidgetApiToWidgetAction.OpenIDCredentials),Q))};B.on("action:".concat(m.WidgetApiToWidgetAction.OpenIDCredentials),x)}else k(new Error("Invalid state: "+V.state))}).catch(k)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(m.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(m.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(B){return this.transport.send(m.WidgetApiFromWidgetAction.SendSticker,B).then()}},{key:"setAlwaysOnScreen",value:function(B){return this.transport.send(m.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:B}).then(function(R){return R.success})}},{key:"openModalWidget",value:function(B,R){var k=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],P=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},V=arguments.length>4&&arguments[4]!==void 0?arguments[4]:d.MatrixWidgetType.Custom;return this.transport.send(m.WidgetApiFromWidgetAction.OpenModalWidget,{type:V,url:B,name:R,buttons:k,data:P}).then()}},{key:"closeModalWidget",value:function(){var B=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.transport.send(m.WidgetApiFromWidgetAction.CloseModalWidget,B).then()}},{key:"sendRoomEvent",value:function(B,R,k){return this.transport.send(m.WidgetApiFromWidgetAction.SendEvent,{type:B,content:R,room_id:k})}},{key:"sendStateEvent",value:function(B,R,k,P){return this.transport.send(m.WidgetApiFromWidgetAction.SendEvent,{type:B,content:k,state_key:R,room_id:P})}},{key:"sendToDevice",value:function(B,R,k){return this.transport.send(m.WidgetApiFromWidgetAction.SendToDevice,{type:B,encrypted:R,messages:k})}},{key:"readRoomEvents",value:function(B,R,k,P){var V={type:B,msgtype:k};return R!==void 0&&(V.limit=R),P&&(P.includes(n.Symbols.AnyRoom)?V.room_ids=n.Symbols.AnyRoom:V.room_ids=P),this.transport.send(m.WidgetApiFromWidgetAction.MSC2876ReadEvents,V).then(function(x){return x.events})}},{key:"readEventRelations",value:function(){var q=s(i().mark(function R(k,P,V,x,Q,te,ae,de){var X,$;return i().wrap(function(re){for(;;)switch(re.prev=re.next){case 0:return re.next=2,this.getClientVersions();case 2:if(X=re.sent,X.includes(y.UnstableApiVersion.MSC3869)){re.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return $={event_id:k,rel_type:V,event_type:x,room_id:P,to:ae,from:te,limit:Q,direction:de},re.abrupt("return",this.transport.send(m.WidgetApiFromWidgetAction.MSC3869ReadRelations,$));case 7:case"end":return re.stop()}},R,this)}));function B(R,k,P,V,x,Q,te,ae){return q.apply(this,arguments)}return B}()},{key:"readStateEvents",value:function(B,R,k,P){var V={type:B,state_key:k===void 0?!0:k};return R!==void 0&&(V.limit=R),P&&(P.includes(n.Symbols.AnyRoom)?V.room_ids=n.Symbols.AnyRoom:V.room_ids=P),this.transport.send(m.WidgetApiFromWidgetAction.MSC2876ReadEvents,V).then(function(x){return x.events})}},{key:"setModalButtonEnabled",value:function(B,R){if(B===b.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(m.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:B,enabled:R}).then()}},{key:"navigateTo",value:function(B){if(!B||!B.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(m.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:B}).then()}},{key:"getTurnServers",value:function(){var B=this;return F(i().mark(function R(){var k,P;return i().wrap(function(x){for(;;)switch(x.prev=x.next){case 0:if(P=function(){var Q=s(i().mark(function te(ae){return i().wrap(function(X){for(;;)switch(X.prev=X.next){case 0:return ae.preventDefault(),k(ae.detail.data),X.next=4,B.transport.reply(ae.detail,{});case 4:case"end":return X.stop()}},te)}));return function(ae){return Q.apply(this,arguments)}}(),B.on("action:".concat(m.WidgetApiToWidgetAction.UpdateTurnServers),P),B.turnServerWatchers!==0){x.next=12;break}return x.prev=3,x.next=6,ee(B.transport.send(m.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:x.next=12;break;case 8:throw x.prev=8,x.t0=x.catch(3),B.off("action:".concat(m.WidgetApiToWidgetAction.UpdateTurnServers),P),x.t0;case 12:B.turnServerWatchers++,x.prev=13;case 14:return x.next=17,ee(new Promise(function(Q){return k=Q}));case 17:return x.next=19,x.sent;case 19:x.next=14;break;case 21:if(x.prev=21,B.off("action:".concat(m.WidgetApiToWidgetAction.UpdateTurnServers),P),B.turnServerWatchers--,B.turnServerWatchers!==0){x.next=27;break}return x.next=27,ee(B.transport.send(m.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return x.finish(21);case 28:case"end":return x.stop()}},R,null,[[3,8],[13,,21,28]])}))()}},{key:"searchUserDirectory",value:function(){var q=s(i().mark(function R(k,P){var V,x;return i().wrap(function(te){for(;;)switch(te.prev=te.next){case 0:return te.next=2,this.getClientVersions();case 2:if(V=te.sent,V.includes(y.UnstableApiVersion.MSC3973)){te.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return x={search_term:k,limit:P},te.abrupt("return",this.transport.send(m.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,x));case 7:case"end":return te.stop()}},R,this)}));function B(R,k){return q.apply(this,arguments)}return B}()},{key:"start",value:function(){var B=this;this.transport.start(),this.getClientVersions().then(function(R){R.includes(y.UnstableApiVersion.MSC2974)&&(B.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(B){var R=new CustomEvent("action:".concat(B.detail.action),{detail:B.detail,cancelable:!0});if(this.emit("action:".concat(B.detail.action),R),!R.defaultPrevented)switch(B.detail.action){case m.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(B.detail);case m.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(B.detail);case m.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(B.detail,{});case m.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(B.detail,{});default:return this.transport.reply(B.detail,{error:{message:"Unknown or unsupported action: "+B.detail.action}})}}},{key:"replyVersions",value:function(B){this.transport.reply(B,{supported_versions:y.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var B=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(m.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(R){return B.cachedClientVersions=R.supported_versions,R.supported_versions}).catch(function(R){return console.warn("non-fatal error getting supported client versions: ",R),[]})}},{key:"handleCapabilities",value:function(B){var R=this;return this.capabilitiesFinished?this.transport.reply(B,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(k){return k.includes(y.UnstableApiVersion.MSC2871)?R.once("action:".concat(m.WidgetApiToWidgetAction.NotifyCapabilities),function(P){R.approvedCapabilities=P.detail.data.approved,R.emit("ready")}):R.emit("ready"),R.capabilitiesFinished=!0,R.transport.reply(B,{capabilities:R.requestedCapabilities})})}}]),Y}(g.EventEmitter);e.WidgetApi=I},{"./Symbols":175,"./interfaces/ApiVersion":179,"./interfaces/GetOpenIDAction":183,"./interfaces/ModalWidgetActions":193,"./interfaces/WidgetApiAction":207,"./interfaces/WidgetApiDirection":208,"./interfaces/WidgetType":211,"./models/WidgetEventCapability":213,"./transport/PostmessageTransport":219,events:105}],177:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.WidgetDriver=void 0;var u=t("..");function g(m,h){if(!(m instanceof h))throw new TypeError("Cannot call a class as a function")}function S(m,h){for(var d=0;d<h.length;d++){var b=h[d];b.enumerable=b.enumerable||!1,b.configurable=!0,"value"in b&&(b.writable=!0),Object.defineProperty(m,b.key,b)}}function y(m,h,d){return h&&S(m.prototype,h),d&&S(m,d),Object.defineProperty(m,"prototype",{writable:!1}),m}var c=function(){function m(){g(this,m)}return y(m,[{key:"validateCapabilities",value:function(d){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(d,b){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(d,b,a){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomEvents",value:function(d,b,a){return Promise.resolve([])}},{key:"readStateEvents",value:function(d,b,a){return Promise.resolve([])}},{key:"readEventRelations",value:function(d,b,a,n,i,r,s,o){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(d){d.update({state:u.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(d){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(d,b){return Promise.resolve({limited:!1,results:[]})}}]),m}();e.WidgetDriver=c},{"..":178}],178:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0});var u=t("./WidgetApi");Object.keys(u).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===u[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return u[K]}})});var g=t("./ClientWidgetApi");Object.keys(g).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===g[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return g[K]}})});var S=t("./Symbols");Object.keys(S).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===S[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return S[K]}})});var y=t("./transport/ITransport");Object.keys(y).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===y[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return y[K]}})});var c=t("./transport/PostmessageTransport");Object.keys(c).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===c[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return c[K]}})});var m=t("./interfaces/ICustomWidgetData");Object.keys(m).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===m[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return m[K]}})});var h=t("./interfaces/IJitsiWidgetData");Object.keys(h).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===h[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return h[K]}})});var d=t("./interfaces/IStickerpickerWidgetData");Object.keys(d).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===d[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return d[K]}})});var b=t("./interfaces/IWidget");Object.keys(b).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===b[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return b[K]}})});var a=t("./interfaces/WidgetType");Object.keys(a).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===a[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return a[K]}})});var n=t("./interfaces/IWidgetApiErrorResponse");Object.keys(n).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===n[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return n[K]}})});var i=t("./interfaces/IWidgetApiRequest");Object.keys(i).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===i[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return i[K]}})});var r=t("./interfaces/IWidgetApiResponse");Object.keys(r).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===r[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return r[K]}})});var s=t("./interfaces/WidgetApiAction");Object.keys(s).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===s[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return s[K]}})});var o=t("./interfaces/WidgetApiDirection");Object.keys(o).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===o[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return o[K]}})});var l=t("./interfaces/ApiVersion");Object.keys(l).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===l[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return l[K]}})});var v=t("./interfaces/Capabilities");Object.keys(v).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===v[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return v[K]}})});var f=t("./interfaces/CapabilitiesAction");Object.keys(f).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===f[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return f[K]}})});var p=t("./interfaces/ContentLoadedAction");Object.keys(p).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===p[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return p[K]}})});var _=t("./interfaces/ScreenshotAction");Object.keys(_).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===_[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return _[K]}})});var T=t("./interfaces/StickerAction");Object.keys(T).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===T[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return T[K]}})});var w=t("./interfaces/StickyAction");Object.keys(w).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===w[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return w[K]}})});var M=t("./interfaces/SupportedVersionsAction");Object.keys(M).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===M[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return M[K]}})});var A=t("./interfaces/VisibilityAction");Object.keys(A).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===A[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return A[K]}})});var W=t("./interfaces/GetOpenIDAction");Object.keys(W).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===W[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return W[K]}})});var ee=t("./interfaces/OpenIDCredentialsAction");Object.keys(ee).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===ee[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return ee[K]}})});var F=t("./interfaces/WidgetKind");Object.keys(F).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===F[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return F[K]}})});var C=t("./interfaces/ModalButtonKind");Object.keys(C).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===C[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return C[K]}})});var O=t("./interfaces/ModalWidgetActions");Object.keys(O).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===O[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return O[K]}})});var I=t("./interfaces/SetModalButtonEnabledAction");Object.keys(I).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===I[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return I[K]}})});var D=t("./interfaces/WidgetConfigAction");Object.keys(D).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===D[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return D[K]}})});var j=t("./interfaces/SendEventAction");Object.keys(j).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===j[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return j[K]}})});var Y=t("./interfaces/SendToDeviceAction");Object.keys(Y).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===Y[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return Y[K]}})});var q=t("./interfaces/ReadEventAction");Object.keys(q).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===q[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return q[K]}})});var B=t("./interfaces/IRoomEvent");Object.keys(B).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===B[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return B[K]}})});var R=t("./interfaces/NavigateAction");Object.keys(R).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===R[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return R[K]}})});var k=t("./interfaces/TurnServerActions");Object.keys(k).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===k[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return k[K]}})});var P=t("./interfaces/ReadRelationsAction");Object.keys(P).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===P[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return P[K]}})});var V=t("./models/WidgetEventCapability");Object.keys(V).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===V[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return V[K]}})});var x=t("./models/validation/url");Object.keys(x).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===x[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return x[K]}})});var Q=t("./models/validation/utils");Object.keys(Q).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===Q[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return Q[K]}})});var te=t("./models/Widget");Object.keys(te).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===te[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return te[K]}})});var ae=t("./models/WidgetParser");Object.keys(ae).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===ae[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return ae[K]}})});var de=t("./templating/url-template");Object.keys(de).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===de[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return de[K]}})});var X=t("./util/SimpleObservable");Object.keys(X).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===X[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return X[K]}})});var $=t("./driver/WidgetDriver");Object.keys($).forEach(function(K){K==="default"||K==="__esModule"||K in e&&e[K]===$[K]||Object.defineProperty(e,K,{enumerable:!0,get:function(){return $[K]}})})},{"./ClientWidgetApi":174,"./Symbols":175,"./WidgetApi":176,"./driver/WidgetDriver":177,"./interfaces/ApiVersion":179,"./interfaces/Capabilities":180,"./interfaces/CapabilitiesAction":181,"./interfaces/ContentLoadedAction":182,"./interfaces/GetOpenIDAction":183,"./interfaces/ICustomWidgetData":184,"./interfaces/IJitsiWidgetData":185,"./interfaces/IRoomEvent":186,"./interfaces/IStickerpickerWidgetData":187,"./interfaces/IWidget":188,"./interfaces/IWidgetApiErrorResponse":189,"./interfaces/IWidgetApiRequest":190,"./interfaces/IWidgetApiResponse":191,"./interfaces/ModalButtonKind":192,"./interfaces/ModalWidgetActions":193,"./interfaces/NavigateAction":194,"./interfaces/OpenIDCredentialsAction":195,"./interfaces/ReadEventAction":196,"./interfaces/ReadRelationsAction":197,"./interfaces/ScreenshotAction":198,"./interfaces/SendEventAction":199,"./interfaces/SendToDeviceAction":200,"./interfaces/SetModalButtonEnabledAction":201,"./interfaces/StickerAction":202,"./interfaces/StickyAction":203,"./interfaces/SupportedVersionsAction":204,"./interfaces/TurnServerActions":205,"./interfaces/VisibilityAction":206,"./interfaces/WidgetApiAction":207,"./interfaces/WidgetApiDirection":208,"./interfaces/WidgetConfigAction":209,"./interfaces/WidgetKind":210,"./interfaces/WidgetType":211,"./models/Widget":212,"./models/WidgetEventCapability":213,"./models/WidgetParser":214,"./models/validation/url":215,"./models/validation/utils":216,"./templating/url-template":217,"./transport/ITransport":218,"./transport/PostmessageTransport":219,"./util/SimpleObservable":220}],179:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.UnstableApiVersion=e.MatrixApiVersion=e.CurrentApiVersions=void 0;var u;e.MatrixApiVersion=u,function(y){y.Prerelease1="0.0.1",y.Prerelease2="0.0.2"}(u||(e.MatrixApiVersion=u={}));var g;e.UnstableApiVersion=g,function(y){y.MSC2762="org.matrix.msc2762",y.MSC2871="org.matrix.msc2871",y.MSC2931="org.matrix.msc2931",y.MSC2974="org.matrix.msc2974",y.MSC2876="org.matrix.msc2876",y.MSC3819="org.matrix.msc3819",y.MSC3846="town.robin.msc3846",y.MSC3869="org.matrix.msc3869",y.MSC3973="org.matrix.msc3973"}(g||(e.UnstableApiVersion=g={}));var S=[u.Prerelease1,u.Prerelease2,g.MSC2762,g.MSC2871,g.MSC2931,g.MSC2974,g.MSC2876,g.MSC3819,g.MSC3846,g.MSC3869,g.MSC3973];e.CurrentApiVersions=S},{}],180:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.VideoConferenceCapabilities=e.StickerpickerCapabilities=e.MatrixCapabilities=void 0,e.getTimelineRoomIDFromCapability=m,e.isTimelineCapability=y,e.isTimelineCapabilityFor=c;var u;e.MatrixCapabilities=u,function(h){h.Screenshots="m.capability.screenshot",h.StickerSending="m.sticker",h.AlwaysOnScreen="m.always_on_screen",h.RequiresClient="io.element.requires_client",h.MSC2931Navigate="org.matrix.msc2931.navigate",h.MSC3846TurnServers="town.robin.msc3846.turn_servers",h.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search"}(u||(e.MatrixCapabilities=u={}));var g=[u.StickerSending];e.StickerpickerCapabilities=g;var S=[u.AlwaysOnScreen];e.VideoConferenceCapabilities=S;function y(h){return h==null?void 0:h.startsWith("org.matrix.msc2762.timeline:")}function c(h,d){return h==="org.matrix.msc2762.timeline:".concat(d)}function m(h){return h.substring(h.indexOf(":")+1)}},{}],181:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],182:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],183:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.OpenIDRequestState=void 0;var u;e.OpenIDRequestState=u,function(g){g.Allowed="allowed",g.Blocked="blocked",g.PendingUserConfirmation="request"}(u||(e.OpenIDRequestState=u={}))},{}],184:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],185:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],186:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],187:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],188:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],189:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isErrorResponse=u;function u(g){if("error"in g){var S=g;return!!S.error.message}return!1}},{}],190:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],191:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],192:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ModalButtonKind=void 0;var u;e.ModalButtonKind=u,function(g){g.Primary="m.primary",g.Secondary="m.secondary",g.Warning="m.warning",g.Danger="m.danger",g.Link="m.link"}(u||(e.ModalButtonKind=u={}))},{}],193:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.BuiltInModalButtonID=void 0;var u;e.BuiltInModalButtonID=u,function(g){g.Close="m.close"}(u||(e.BuiltInModalButtonID=u={}))},{}],194:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],195:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],196:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],197:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],198:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],199:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],200:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],201:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],202:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],203:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],204:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],205:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],206:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],207:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.WidgetApiToWidgetAction=e.WidgetApiFromWidgetAction=void 0;var u;e.WidgetApiToWidgetAction=u,function(S){S.SupportedApiVersions="supported_api_versions",S.Capabilities="capabilities",S.NotifyCapabilities="notify_capabilities",S.TakeScreenshot="screenshot",S.UpdateVisibility="visibility",S.OpenIDCredentials="openid_credentials",S.WidgetConfig="widget_config",S.CloseModalWidget="close_modal",S.ButtonClicked="button_clicked",S.SendEvent="send_event",S.SendToDevice="send_to_device",S.UpdateTurnServers="update_turn_servers"}(u||(e.WidgetApiToWidgetAction=u={}));var g;e.WidgetApiFromWidgetAction=g,function(S){S.SupportedApiVersions="supported_api_versions",S.ContentLoaded="content_loaded",S.SendSticker="m.sticker",S.UpdateAlwaysOnScreen="set_always_on_screen",S.GetOpenIDCredentials="get_openid",S.CloseModalWidget="close_modal",S.OpenModalWidget="open_modal",S.SetModalButtonEnabled="set_button_enabled",S.SendEvent="send_event",S.SendToDevice="send_to_device",S.WatchTurnServers="watch_turn_servers",S.UnwatchTurnServers="unwatch_turn_servers",S.MSC2876ReadEvents="org.matrix.msc2876.read_events",S.MSC2931Navigate="org.matrix.msc2931.navigate",S.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",S.MSC3869ReadRelations="org.matrix.msc3869.read_relations",S.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search"}(g||(e.WidgetApiFromWidgetAction=g={}))},{}],208:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.WidgetApiDirection=void 0,e.invertedDirection=g;var u;e.WidgetApiDirection=u,function(S){S.ToWidget="toWidget",S.FromWidget="fromWidget"}(u||(e.WidgetApiDirection=u={}));function g(S){if(S===u.ToWidget)return u.FromWidget;if(S===u.FromWidget)return u.ToWidget;throw new Error("Invalid direction")}},{}],209:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],210:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.WidgetKind=void 0;var u;e.WidgetKind=u,function(g){g.Room="room",g.Account="account",g.Modal="modal"}(u||(e.WidgetKind=u={}))},{}],211:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.MatrixWidgetType=void 0;var u;e.MatrixWidgetType=u,function(g){g.Custom="m.custom",g.JitsiMeet="m.jitsi",g.Stickerpicker="m.stickerpicker"}(u||(e.MatrixWidgetType=u={}))},{}],212:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Widget=void 0;var u=t("./validation/utils"),g=t("..");function S(h,d){if(!(h instanceof d))throw new TypeError("Cannot call a class as a function")}function y(h,d){for(var b=0;b<d.length;b++){var a=d[b];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(h,a.key,a)}}function c(h,d,b){return d&&y(h.prototype,d),b&&y(h,b),Object.defineProperty(h,"prototype",{writable:!1}),h}var m=function(){function h(d){if(S(this,h),this.definition=d,!this.definition)throw new Error("Definition is required");(0,u.assertPresent)(d,"id"),(0,u.assertPresent)(d,"creatorUserId"),(0,u.assertPresent)(d,"type"),(0,u.assertPresent)(d,"url")}return c(h,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return this.definition.waitForIframeLoad===!1?!1:(this.definition.waitForIframeLoad===!0,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(b){return(0,g.runTemplate)(this.templateUrl,this.definition,b)}}]),h}();e.Widget=m},{"..":178,"./validation/utils":216}],213:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.WidgetEventCapability=e.EventKind=e.EventDirection=void 0;function u(a,n){var i=typeof Symbol<"u"&&a[Symbol.iterator]||a["@@iterator"];if(!i){if(Array.isArray(a)||(i=g(a))||n&&a&&typeof a.length=="number"){i&&(a=i);var r=0,s=function(){};return{s,n:function(){return r>=a.length?{done:!0}:{done:!1,value:a[r++]}},e:function(p){throw p},f:s}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var o=!0,l=!1,v;return{s:function(){i=i.call(a)},n:function(){var p=i.next();return o=p.done,p},e:function(p){l=!0,v=p},f:function(){try{!o&&i.return!=null&&i.return()}finally{if(l)throw v}}}}function g(a,n){if(a){if(typeof a=="string")return S(a,n);var i=Object.prototype.toString.call(a).slice(8,-1);if(i==="Object"&&a.constructor&&(i=a.constructor.name),i==="Map"||i==="Set")return Array.from(a);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return S(a,n)}}function S(a,n){(n==null||n>a.length)&&(n=a.length);for(var i=0,r=new Array(n);i<n;i++)r[i]=a[i];return r}function y(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}function c(a,n){for(var i=0;i<n.length;i++){var r=n[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(a,r.key,r)}}function m(a,n,i){return n&&c(a.prototype,n),i&&c(a,i),Object.defineProperty(a,"prototype",{writable:!1}),a}var h;e.EventKind=h,function(a){a.Event="event",a.State="state_event",a.ToDevice="to_device"}(h||(e.EventKind=h={}));var d;e.EventDirection=d,function(a){a.Send="send",a.Receive="receive"}(d||(e.EventDirection=d={}));var b=function(){function a(n,i,r,s,o){y(this,a),this.direction=n,this.eventType=i,this.kind=r,this.keyStr=s,this.raw=o}return m(a,[{key:"matchesAsStateEvent",value:function(i,r,s){return this.kind!==h.State||this.direction!==i||this.eventType!==r?!1:this.keyStr===null||this.keyStr===s}},{key:"matchesAsToDeviceEvent",value:function(i,r){return!(this.kind!==h.ToDevice||this.direction!==i||this.eventType!==r)}},{key:"matchesAsRoomEvent",value:function(i,r){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;if(this.kind!==h.Event||this.direction!==i||this.eventType!==r)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===s)return!0}else return!0;return!1}}],[{key:"forStateEvent",value:function(i,r,s){r=r.replace(/#/g,"\\#"),s=s!=null?"#".concat(s):"";var o="org.matrix.msc2762.".concat(i,".state_event:").concat(r).concat(s);return a.findEventCapabilities([o])[0]}},{key:"forToDeviceEvent",value:function(i,r){var s="org.matrix.msc3819.".concat(i,".to_device:").concat(r);return a.findEventCapabilities([s])[0]}},{key:"forRoomEvent",value:function(i,r){var s="org.matrix.msc2762.".concat(i,".event:").concat(r);return a.findEventCapabilities([s])[0]}},{key:"forRoomMessageEvent",value:function(i,r){r=r??"";var s="org.matrix.msc2762.".concat(i,".event:m.room.message#").concat(r);return a.findEventCapabilities([s])[0]}},{key:"findEventCapabilities",value:function(i){var r=[],s=u(i),o;try{for(s.s();!(o=s.n()).done;){var l=o.value,v=null,f=void 0,p=null;if(l.startsWith("org.matrix.msc2762.send.event:")?(v=d.Send,p=h.Event,f=l.substring(30)):l.startsWith("org.matrix.msc2762.send.state_event:")?(v=d.Send,p=h.State,f=l.substring(36)):l.startsWith("org.matrix.msc3819.send.to_device:")?(v=d.Send,p=h.ToDevice,f=l.substring(34)):l.startsWith("org.matrix.msc2762.receive.event:")?(v=d.Receive,p=h.Event,f=l.substring(33)):l.startsWith("org.matrix.msc2762.receive.state_event:")?(v=d.Receive,p=h.State,f=l.substring(39)):l.startsWith("org.matrix.msc3819.receive.to_device:")&&(v=d.Receive,p=h.ToDevice,f=l.substring(37)),!(v===null||p===null||f===void 0)){var _=f.startsWith("m.room.message#")||p===h.State,T=null;if(f.includes("#")&&_){var w=f.split("#"),M=w.findIndex(function(A){return!A.endsWith("\\")});f=w.slice(0,M+1).map(function(A){return A.endsWith("\\")?A.substring(0,A.length-1):A}).join("#"),T=w.slice(M+1).join("#")}r.push(new a(v,f,p,T,l))}}}catch(A){s.e(A)}finally{s.f()}return r}}]),a}();e.WidgetEventCapability=b},{}],214:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.WidgetParser=void 0;var u=t("./Widget"),g=t("./validation/url");function S(a,n){var i=typeof Symbol<"u"&&a[Symbol.iterator]||a["@@iterator"];if(!i){if(Array.isArray(a)||(i=y(a))||n&&a&&typeof a.length=="number"){i&&(a=i);var r=0,s=function(){};return{s,n:function(){return r>=a.length?{done:!0}:{done:!1,value:a[r++]}},e:function(p){throw p},f:s}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var o=!0,l=!1,v;return{s:function(){i=i.call(a)},n:function(){var p=i.next();return o=p.done,p},e:function(p){l=!0,v=p},f:function(){try{!o&&i.return!=null&&i.return()}finally{if(l)throw v}}}}function y(a,n){if(a){if(typeof a=="string")return c(a,n);var i=Object.prototype.toString.call(a).slice(8,-1);if(i==="Object"&&a.constructor&&(i=a.constructor.name),i==="Map"||i==="Set")return Array.from(a);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return c(a,n)}}function c(a,n){(n==null||n>a.length)&&(n=a.length);for(var i=0,r=new Array(n);i<n;i++)r[i]=a[i];return r}function m(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}function h(a,n){for(var i=0;i<n.length;i++){var r=n[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(a,r.key,r)}}function d(a,n,i){return n&&h(a.prototype,n),i&&h(a,i),Object.defineProperty(a,"prototype",{writable:!1}),a}var b=function(){function a(){m(this,a)}return d(a,null,[{key:"parseAccountData",value:function(i){if(!i)return[];for(var r=[],s=0,o=Object.keys(i);s<o.length;s++){var l=o[s],v=i[l];if(v&&!(v.type!=="m.widget"&&v.type!=="im.vector.modular.widgets")&&v.sender){var f=v.state_key||v.id;if(f===l){var p={content:v.content,sender:v.sender,type:"m.widget",state_key:l,event_id:"$example",room_id:"!example",origin_server_ts:1},_=a.parseRoomWidget(p);_&&r.push(_)}}}return r}},{key:"parseWidgetsFromRoomState",value:function(i){if(!i)return[];var r=[],s=S(i),o;try{for(s.s();!(o=s.n()).done;){var l=o.value,v=a.parseRoomWidget(l);v&&r.push(v)}}catch(f){s.e(f)}finally{s.f()}return r}},{key:"parseRoomWidget",value:function(i){if(!i||i.type!=="m.widget"&&i.type!=="im.vector.modular.widgets")return null;var r=i.content||{},s={id:i.state_key,creatorUserId:r.creatorUserId||i.sender,name:r.name,type:r.type,url:r.url,waitForIframeLoad:r.waitForIframeLoad,data:r.data};return a.processEstimatedWidget(s)}},{key:"processEstimatedWidget",value:function(i){return!i.id||!i.creatorUserId||!i.type||!(0,g.isValidUrl)(i.url)?null:new u.Widget(i)}}]),a}();e.WidgetParser=b},{"./Widget":212,"./validation/url":215}],215:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isValidUrl=u;function u(g){if(!g)return!1;try{var S=new URL(g);return!(S.protocol!=="http"&&S.protocol!=="https")}catch(y){if(y instanceof TypeError)return!1;throw y}}},{}],216:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.assertPresent=u;function u(g,S){if(!g[S])throw new Error("".concat(S," is required"))}},{}],217:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.runTemplate=u,e.toString=g;function u(S,y,c){for(var m=Object.assign({},y.data,{matrix_room_id:c.widgetRoomId||"",matrix_user_id:c.currentUserId,matrix_display_name:c.userDisplayName||c.currentUserId,matrix_avatar_url:c.userHttpAvatarUrl||"",matrix_widget_id:y.id,"org.matrix.msc2873.client_id":c.clientId||"","org.matrix.msc2873.client_theme":c.clientTheme||"","org.matrix.msc2873.client_language":c.clientLanguage||""}),h=S,d=0,b=Object.keys(m);d<b.length;d++){var a=b[d],n="$".concat(a).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(n,"g");h=h.replace(i,encodeURIComponent(g(m[a])))}return h}function g(S){return S==null?"".concat(S):String(S)}},{}],218:[function(t,E,e){arguments[4][153][0].apply(e,arguments)},{dup:153}],219:[function(t,E,e){function u(f){return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(p){return typeof p}:function(p){return p&&typeof Symbol=="function"&&p.constructor===Symbol&&p!==Symbol.prototype?"symbol":typeof p},u(f)}Object.defineProperty(e,"__esModule",{value:!0}),e.PostmessageTransport=void 0;var g=t("events"),S=t("..");function y(f,p){var _=Object.keys(f);if(Object.getOwnPropertySymbols){var T=Object.getOwnPropertySymbols(f);p&&(T=T.filter(function(w){return Object.getOwnPropertyDescriptor(f,w).enumerable})),_.push.apply(_,T)}return _}function c(f){for(var p=1;p<arguments.length;p++){var _=arguments[p]!=null?arguments[p]:{};p%2?y(Object(_),!0).forEach(function(T){l(f,T,_[T])}):Object.getOwnPropertyDescriptors?Object.defineProperties(f,Object.getOwnPropertyDescriptors(_)):y(Object(_)).forEach(function(T){Object.defineProperty(f,T,Object.getOwnPropertyDescriptor(_,T))})}return f}function m(f,p){if(!(f instanceof p))throw new TypeError("Cannot call a class as a function")}function h(f,p){for(var _=0;_<p.length;_++){var T=p[_];T.enumerable=T.enumerable||!1,T.configurable=!0,"value"in T&&(T.writable=!0),Object.defineProperty(f,T.key,T)}}function d(f,p,_){return p&&h(f.prototype,p),_&&h(f,_),Object.defineProperty(f,"prototype",{writable:!1}),f}function b(f,p){if(typeof p!="function"&&p!==null)throw new TypeError("Super expression must either be null or a function");f.prototype=Object.create(p&&p.prototype,{constructor:{value:f,writable:!0,configurable:!0}}),Object.defineProperty(f,"prototype",{writable:!1}),p&&a(f,p)}function a(f,p){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(T,w){return T.__proto__=w,T},a(f,p)}function n(f){var p=s();return function(){var T=o(f),w;if(p){var M=o(this).constructor;w=Reflect.construct(T,arguments,M)}else w=T.apply(this,arguments);return i(this,w)}}function i(f,p){if(p&&(u(p)==="object"||typeof p=="function"))return p;if(p!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return r(f)}function r(f){if(f===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return f}function s(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function o(f){return o=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(_){return _.__proto__||Object.getPrototypeOf(_)},o(f)}function l(f,p,_){return p in f?Object.defineProperty(f,p,{value:_,enumerable:!0,configurable:!0,writable:!0}):f[p]=_,f}var v=function(f){b(_,f);var p=n(_);function _(T,w,M,A){var W;return m(this,_),W=p.call(this),W.sendDirection=T,W.initialWidgetId=w,W.transportWindow=M,W.inboundWindow=A,l(r(W),"strictOriginCheck",!1),l(r(W),"targetOrigin","*"),l(r(W),"timeoutSeconds",10),l(r(W),"_ready",!1),l(r(W),"_widgetId",null),l(r(W),"outboundRequests",new Map),l(r(W),"stopController",new AbortController),W._widgetId=w,W}return d(_,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var w="widgetapi-".concat(Date.now()),M=0,A=w;this.outboundRequests.has(A);)A="".concat(w,"-").concat(M++);return this.outboundRequests.set(A,null),A}},{key:"sendInternal",value:function(w){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),w),this.transportWindow.postMessage(w,this.targetOrigin)}},{key:"reply",value:function(w,M){return this.sendInternal(c(c({},w),{},{response:M}))}},{key:"send",value:function(w,M){return this.sendComplete(w,M).then(function(A){return A.response})}},{key:"sendComplete",value:function(w,M){var A=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var W={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:w,data:M};return w===S.WidgetApiToWidgetAction.UpdateVisibility&&(W.visible=M.visible),new Promise(function(ee,F){var C=function(q){j(),ee(q)},O=function(q){j(),F(q)},I=setTimeout(function(){return O(new Error("Request timed out"))},(A.timeoutSeconds||1)*1e3),D=function(){return O(new Error("Transport stopped"))};A.stopController.signal.addEventListener("abort",D);var j=function(){A.outboundRequests.delete(W.requestId),clearTimeout(I),A.stopController.signal.removeEventListener("abort",D)};A.outboundRequests.set(W.requestId,{request:W,resolve:C,reject:O}),A.sendInternal(W)})}},{key:"start",value:function(){var w=this;this.inboundWindow.addEventListener("message",function(M){w.handleMessage(M)}),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(w){if(!this.stopController.signal.aborted&&w.data&&!(this.strictOriginCheck&&w.origin!==window.origin)){var M=w.data;if(!(!M.action||!M.requestId||!M.widgetId))if(M.response){if(M.api!==this.sendDirection)return;this.handleResponse(M)}else{var A=M;if(A.api!==(0,S.invertedDirection)(this.sendDirection))return;this.handleRequest(A)}}}},{key:"handleRequest",value:function(w){if(this.widgetId){if(this.widgetId!==w.widgetId)return}else this._widgetId=w.widgetId;this.emit("message",new CustomEvent("message",{detail:w}))}},{key:"handleResponse",value:function(w){if(w.widgetId===this.widgetId){var M=this.outboundRequests.get(w.requestId);if(M)if((0,S.isErrorResponse)(w.response)){var A=w.response;M.reject(new Error(A.error.message))}else M.resolve(w)}}}]),_}(g.EventEmitter);e.PostmessageTransport=v},{"..":178,events:105}],220:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SimpleObservable=void 0;function u(b,a){var n=typeof Symbol<"u"&&b[Symbol.iterator]||b["@@iterator"];if(!n){if(Array.isArray(b)||(n=g(b))||a&&b&&typeof b.length=="number"){n&&(b=n);var i=0,r=function(){};return{s:r,n:function(){return i>=b.length?{done:!0}:{done:!1,value:b[i++]}},e:function(f){throw f},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var s=!0,o=!1,l;return{s:function(){n=n.call(b)},n:function(){var f=n.next();return s=f.done,f},e:function(f){o=!0,l=f},f:function(){try{!s&&n.return!=null&&n.return()}finally{if(o)throw l}}}}function g(b,a){if(b){if(typeof b=="string")return S(b,a);var n=Object.prototype.toString.call(b).slice(8,-1);if(n==="Object"&&b.constructor&&(n=b.constructor.name),n==="Map"||n==="Set")return Array.from(b);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return S(b,a)}}function S(b,a){(a==null||a>b.length)&&(a=b.length);for(var n=0,i=new Array(a);n<a;n++)i[n]=b[n];return i}function y(b,a){if(!(b instanceof a))throw new TypeError("Cannot call a class as a function")}function c(b,a){for(var n=0;n<a.length;n++){var i=a[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(b,i.key,i)}}function m(b,a,n){return a&&c(b.prototype,a),n&&c(b,n),Object.defineProperty(b,"prototype",{writable:!1}),b}function h(b,a,n){return a in b?Object.defineProperty(b,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):b[a]=n,b}var d=function(){function b(a){y(this,b),h(this,"listeners",[]),a&&this.listeners.push(a)}return m(b,[{key:"onUpdate",value:function(n){this.listeners.push(n)}},{key:"update",value:function(n){var i=u(this.listeners),r;try{for(i.s();!(r=i.n()).done;){var s=r.value;s(n)}}catch(o){i.e(o)}finally{i.f()}}},{key:"close",value:function(){this.listeners=[]}}]),b}();e.SimpleObservable=d},{}],221:[function(t,E,e){var u=t("inherits"),g=t("hash-base"),S=t("safe-buffer").Buffer,y=new Array(16);function c(){g.call(this,64),this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878}u(c,g),c.prototype._update=function(){for(var n=y,i=0;i<16;++i)n[i]=this._block.readInt32LE(i*4);var r=this._a,s=this._b,o=this._c,l=this._d;r=h(r,s,o,l,n[0],3614090360,7),l=h(l,r,s,o,n[1],3905402710,12),o=h(o,l,r,s,n[2],606105819,17),s=h(s,o,l,r,n[3],3250441966,22),r=h(r,s,o,l,n[4],4118548399,7),l=h(l,r,s,o,n[5],1200080426,12),o=h(o,l,r,s,n[6],2821735955,17),s=h(s,o,l,r,n[7],4249261313,22),r=h(r,s,o,l,n[8],1770035416,7),l=h(l,r,s,o,n[9],2336552879,12),o=h(o,l,r,s,n[10],4294925233,17),s=h(s,o,l,r,n[11],2304563134,22),r=h(r,s,o,l,n[12],1804603682,7),l=h(l,r,s,o,n[13],4254626195,12),o=h(o,l,r,s,n[14],2792965006,17),s=h(s,o,l,r,n[15],1236535329,22),r=d(r,s,o,l,n[1],4129170786,5),l=d(l,r,s,o,n[6],3225465664,9),o=d(o,l,r,s,n[11],643717713,14),s=d(s,o,l,r,n[0],3921069994,20),r=d(r,s,o,l,n[5],3593408605,5),l=d(l,r,s,o,n[10],38016083,9),o=d(o,l,r,s,n[15],3634488961,14),s=d(s,o,l,r,n[4],3889429448,20),r=d(r,s,o,l,n[9],568446438,5),l=d(l,r,s,o,n[14],3275163606,9),o=d(o,l,r,s,n[3],4107603335,14),s=d(s,o,l,r,n[8],1163531501,20),r=d(r,s,o,l,n[13],2850285829,5),l=d(l,r,s,o,n[2],4243563512,9),o=d(o,l,r,s,n[7],1735328473,14),s=d(s,o,l,r,n[12],2368359562,20),r=b(r,s,o,l,n[5],4294588738,4),l=b(l,r,s,o,n[8],2272392833,11),o=b(o,l,r,s,n[11],1839030562,16),s=b(s,o,l,r,n[14],4259657740,23),r=b(r,s,o,l,n[1],2763975236,4),l=b(l,r,s,o,n[4],1272893353,11),o=b(o,l,r,s,n[7],4139469664,16),s=b(s,o,l,r,n[10],3200236656,23),r=b(r,s,o,l,n[13],681279174,4),l=b(l,r,s,o,n[0],3936430074,11),o=b(o,l,r,s,n[3],3572445317,16),s=b(s,o,l,r,n[6],76029189,23),r=b(r,s,o,l,n[9],3654602809,4),l=b(l,r,s,o,n[12],3873151461,11),o=b(o,l,r,s,n[15],530742520,16),s=b(s,o,l,r,n[2],3299628645,23),r=a(r,s,o,l,n[0],4096336452,6),l=a(l,r,s,o,n[7],1126891415,10),o=a(o,l,r,s,n[14],2878612391,15),s=a(s,o,l,r,n[5],4237533241,21),r=a(r,s,o,l,n[12],1700485571,6),l=a(l,r,s,o,n[3],2399980690,10),o=a(o,l,r,s,n[10],4293915773,15),s=a(s,o,l,r,n[1],2240044497,21),r=a(r,s,o,l,n[8],1873313359,6),l=a(l,r,s,o,n[15],4264355552,10),o=a(o,l,r,s,n[6],2734768916,15),s=a(s,o,l,r,n[13],1309151649,21),r=a(r,s,o,l,n[4],4149444226,6),l=a(l,r,s,o,n[11],3174756917,10),o=a(o,l,r,s,n[2],718787259,15),s=a(s,o,l,r,n[9],3951481745,21),this._a=this._a+r|0,this._b=this._b+s|0,this._c=this._c+o|0,this._d=this._d+l|0},c.prototype._digest=function(){this._block[this._blockOffset++]=128,this._blockOffset>56&&(this._block.fill(0,this._blockOffset,64),this._update(),this._blockOffset=0),this._block.fill(0,this._blockOffset,56),this._block.writeUInt32LE(this._length[0],56),this._block.writeUInt32LE(this._length[1],60),this._update();var n=S.allocUnsafe(16);return n.writeInt32LE(this._a,0),n.writeInt32LE(this._b,4),n.writeInt32LE(this._c,8),n.writeInt32LE(this._d,12),n};function m(n,i){return n<<i|n>>>32-i}function h(n,i,r,s,o,l,v){return m(n+(i&r|~i&s)+o+l|0,v)+i|0}function d(n,i,r,s,o,l,v){return m(n+(i&s|r&~s)+o+l|0,v)+i|0}function b(n,i,r,s,o,l,v){return m(n+(i^r^s)+o+l|0,v)+i|0}function a(n,i,r,s,o,l,v){return m(n+(r^(i|~s))+o+l|0,v)+i|0}E.exports=c},{"hash-base":116,inherits:146,"safe-buffer":250}],222:[function(t,E,e){var u=t("bn.js"),g=t("brorand");function S(y){this.rand=y||new g.Rand}E.exports=S,S.create=function(c){return new S(c)},S.prototype._randbelow=function(c){var m=c.bitLength(),h=Math.ceil(m/8);do var d=new u(this.rand.generate(h));while(d.cmp(c)>=0);return d},S.prototype._randrange=function(c,m){var h=m.sub(c);return c.add(this._randbelow(h))},S.prototype.test=function(c,m,h){var d=c.bitLength(),b=u.mont(c),a=new u(1).toRed(b);m||(m=Math.max(1,d/48|0));for(var n=c.subn(1),i=0;!n.testn(i);i++);for(var r=c.shrn(i),s=n.toRed(b),o=!0;m>0;m--){var l=this._randrange(new u(2),n);h&&h(l);var v=l.toRed(b).redPow(r);if(!(v.cmp(a)===0||v.cmp(s)===0)){for(var f=1;f<i;f++){if(v=v.redSqr(),v.cmp(a)===0)return!1;if(v.cmp(s)===0)break}if(f===i)return!1}}return o},S.prototype.getDivisor=function(c,m){var h=c.bitLength(),d=u.mont(c),b=new u(1).toRed(d);m||(m=Math.max(1,h/48|0));for(var a=c.subn(1),n=0;!a.testn(n);n++);for(var i=c.shrn(n),r=a.toRed(d);m>0;m--){var s=this._randrange(new u(2),a),o=c.gcd(s);if(o.cmpn(1)!==0)return o;var l=s.toRed(d).redPow(i);if(!(l.cmp(b)===0||l.cmp(r)===0)){for(var v=1;v<n;v++){if(l=l.redSqr(),l.cmp(b)===0)return l.fromRed().subn(1).gcd(c);if(l.cmp(r)===0)break}if(v===n)return l=l.redSqr(),l.fromRed().subn(1).gcd(c)}}return!1}},{"bn.js":18,brorand:19}],223:[function(t,E,e){E.exports=u;function u(g,S){if(!g)throw new Error(S||"Assertion failed")}u.equal=function(S,y,c){if(S!=y)throw new Error(c||"Assertion failed: "+S+" != "+y)}},{}],224:[function(t,E,e){var u=e;function g(c,m){if(Array.isArray(c))return c.slice();if(!c)return[];var h=[];if(typeof c!="string"){for(var d=0;d<c.length;d++)h[d]=c[d]|0;return h}if(m==="hex"){c=c.replace(/[^a-z0-9]+/ig,""),c.length%2!==0&&(c="0"+c);for(var d=0;d<c.length;d+=2)h.push(parseInt(c[d]+c[d+1],16))}else for(var d=0;d<c.length;d++){var b=c.charCodeAt(d),a=b>>8,n=b&255;a?h.push(a,n):h.push(n)}return h}u.toArray=g;function S(c){return c.length===1?"0"+c:c}u.zero2=S;function y(c){for(var m="",h=0;h<c.length;h++)m+=S(c[h].toString(16));return m}u.toHex=y,u.encode=function(m,h){return h==="hex"?y(m):m}},{}],225:[function(t,E,e){const u=t("retry"),g=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class S extends Error{constructor(d){super(),d instanceof Error?(this.originalError=d,{message:d}=d):(this.originalError=new Error(d),this.originalError.stack=this.stack),this.name="AbortError",this.message=d}}const y=(h,d,b)=>{const a=b.retries-(d-1);return h.attemptNumber=d,h.retriesLeft=a,h},c=h=>g.includes(h),m=(h,d)=>new Promise((b,a)=>{d={onFailedAttempt:()=>{},retries:10,...d};const n=u.operation(d);n.attempt(async i=>{try{b(await h(i))}catch(r){if(!(r instanceof Error)){a(new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`));return}if(r instanceof S)n.stop(),a(r.originalError);else if(r instanceof TypeError&&!c(r.message))n.stop(),a(r);else{y(r,i,d);try{await d.onFailedAttempt(r)}catch(s){a(s);return}n.retry(r)||a(n.mainError())}}})});E.exports=m,E.exports.default=m,E.exports.AbortError=S},{retry:246}],226:[function(t,E,e){E.exports={"2.16.840.1.101.3.4.1.1":"aes-128-ecb","2.16.840.1.101.3.4.1.2":"aes-128-cbc","2.16.840.1.101.3.4.1.3":"aes-128-ofb","2.16.840.1.101.3.4.1.4":"aes-128-cfb","2.16.840.1.101.3.4.1.21":"aes-192-ecb","2.16.840.1.101.3.4.1.22":"aes-192-cbc","2.16.840.1.101.3.4.1.23":"aes-192-ofb","2.16.840.1.101.3.4.1.24":"aes-192-cfb","2.16.840.1.101.3.4.1.41":"aes-256-ecb","2.16.840.1.101.3.4.1.42":"aes-256-cbc","2.16.840.1.101.3.4.1.43":"aes-256-ofb","2.16.840.1.101.3.4.1.44":"aes-256-cfb"}},{}],227:[function(t,E,e){var u=t("asn1.js");e.certificate=t("./certificate");var g=u.define("RSAPrivateKey",function(){this.seq().obj(this.key("version").int(),this.key("modulus").int(),this.key("publicExponent").int(),this.key("privateExponent").int(),this.key("prime1").int(),this.key("prime2").int(),this.key("exponent1").int(),this.key("exponent2").int(),this.key("coefficient").int())});e.RSAPrivateKey=g;var S=u.define("RSAPublicKey",function(){this.seq().obj(this.key("modulus").int(),this.key("publicExponent").int())});e.RSAPublicKey=S;var y=u.define("SubjectPublicKeyInfo",function(){this.seq().obj(this.key("algorithm").use(c),this.key("subjectPublicKey").bitstr())});e.PublicKey=y;var c=u.define("AlgorithmIdentifier",function(){this.seq().obj(this.key("algorithm").objid(),this.key("none").null_().optional(),this.key("curve").objid().optional(),this.key("params").seq().obj(this.key("p").int(),this.key("q").int(),this.key("g").int()).optional())}),m=u.define("PrivateKeyInfo",function(){this.seq().obj(this.key("version").int(),this.key("algorithm").use(c),this.key("subjectPrivateKey").octstr())});e.PrivateKey=m;var h=u.define("EncryptedPrivateKeyInfo",function(){this.seq().obj(this.key("algorithm").seq().obj(this.key("id").objid(),this.key("decrypt").seq().obj(this.key("kde").seq().obj(this.key("id").objid(),this.key("kdeparams").seq().obj(this.key("salt").octstr(),this.key("iters").int())),this.key("cipher").seq().obj(this.key("algo").objid(),this.key("iv").octstr()))),this.key("subjectPrivateKey").octstr())});e.EncryptedPrivateKey=h;var d=u.define("DSAPrivateKey",function(){this.seq().obj(this.key("version").int(),this.key("p").int(),this.key("q").int(),this.key("g").int(),this.key("pub_key").int(),this.key("priv_key").int())});e.DSAPrivateKey=d,e.DSAparam=u.define("DSAparam",function(){this.int()});var b=u.define("ECPrivateKey",function(){this.seq().obj(this.key("version").int(),this.key("privateKey").octstr(),this.key("parameters").optional().explicit(0).use(a),this.key("publicKey").optional().explicit(1).bitstr())});e.ECPrivateKey=b;var a=u.define("ECParameters",function(){this.choice({namedCurve:this.objid()})});e.signature=u.define("signature",function(){this.seq().obj(this.key("r").int(),this.key("s").int())})},{"./certificate":228,"asn1.js":2}],228:[function(t,E,e){var u=t("asn1.js"),g=u.define("Time",function(){this.choice({utcTime:this.utctime(),generalTime:this.gentime()})}),S=u.define("AttributeTypeValue",function(){this.seq().obj(this.key("type").objid(),this.key("value").any())}),y=u.define("AlgorithmIdentifier",function(){this.seq().obj(this.key("algorithm").objid(),this.key("parameters").optional(),this.key("curve").objid().optional())}),c=u.define("SubjectPublicKeyInfo",function(){this.seq().obj(this.key("algorithm").use(y),this.key("subjectPublicKey").bitstr())}),m=u.define("RelativeDistinguishedName",function(){this.setof(S)}),h=u.define("RDNSequence",function(){this.seqof(m)}),d=u.define("Name",function(){this.choice({rdnSequence:this.use(h)})}),b=u.define("Validity",function(){this.seq().obj(this.key("notBefore").use(g),this.key("notAfter").use(g))}),a=u.define("Extension",function(){this.seq().obj(this.key("extnID").objid(),this.key("critical").bool().def(!1),this.key("extnValue").octstr())}),n=u.define("TBSCertificate",function(){this.seq().obj(this.key("version").explicit(0).int().optional(),this.key("serialNumber").int(),this.key("signature").use(y),this.key("issuer").use(d),this.key("validity").use(b),this.key("subject").use(d),this.key("subjectPublicKeyInfo").use(c),this.key("issuerUniqueID").implicit(1).bitstr().optional(),this.key("subjectUniqueID").implicit(2).bitstr().optional(),this.key("extensions").explicit(3).seqof(a).optional())}),i=u.define("X509Certificate",function(){this.seq().obj(this.key("tbsCertificate").use(n),this.key("signatureAlgorithm").use(y),this.key("signatureValue").bitstr())});E.exports=i},{"asn1.js":2}],229:[function(t,E,e){var u=/Proc-Type: 4,ENCRYPTED[\n\r]+DEK-Info: AES-((?:128)|(?:192)|(?:256))-CBC,([0-9A-H]+)[\n\r]+([0-9A-z\n\r+/=]+)[\n\r]+/m,g=/^-----BEGIN ((?:.*? KEY)|CERTIFICATE)-----/m,S=/^-----BEGIN ((?:.*? KEY)|CERTIFICATE)-----([0-9A-z\n\r+/=]+)-----END \1-----$/m,y=t("evp_bytestokey"),c=t("browserify-aes"),m=t("safe-buffer").Buffer;E.exports=function(h,d){var b=h.toString(),a=b.match(u),n;if(a){var r="aes"+a[1],s=m.from(a[2],"hex"),o=m.from(a[3].replace(/[\r\n]/g,""),"base64"),l=y(d,s.slice(0,8),parseInt(a[1],10)).key,v=[],f=c.createDecipheriv(r,l,s);v.push(f.update(o)),v.push(f.final()),n=m.concat(v)}else{var i=b.match(S);n=m.from(i[2].replace(/[\r\n]/g,""),"base64")}var p=b.match(g)[1];return{tag:p,data:n}}},{"browserify-aes":23,evp_bytestokey:106,"safe-buffer":250}],230:[function(t,E,e){var u=t("./asn1"),g=t("./aesid.json"),S=t("./fixProc"),y=t("browserify-aes"),c=t("pbkdf2"),m=t("safe-buffer").Buffer;E.exports=h;function h(b){var a;typeof b=="object"&&!m.isBuffer(b)&&(a=b.passphrase,b=b.key),typeof b=="string"&&(b=m.from(b));var n=S(b,a),i=n.tag,r=n.data,s,o;switch(i){case"CERTIFICATE":o=u.certificate.decode(r,"der").tbsCertificate.subjectPublicKeyInfo;case"PUBLIC KEY":switch(o||(o=u.PublicKey.decode(r,"der")),s=o.algorithm.algorithm.join("."),s){case"1.2.840.113549.1.1.1":return u.RSAPublicKey.decode(o.subjectPublicKey.data,"der");case"1.2.840.10045.2.1":return o.subjectPrivateKey=o.subjectPublicKey,{type:"ec",data:o};case"1.2.840.10040.4.1":return o.algorithm.params.pub_key=u.DSAparam.decode(o.subjectPublicKey.data,"der"),{type:"dsa",data:o.algorithm.params};default:throw new Error("unknown key id "+s)}case"ENCRYPTED PRIVATE KEY":r=u.EncryptedPrivateKey.decode(r,"der"),r=d(r,a);case"PRIVATE KEY":switch(o=u.PrivateKey.decode(r,"der"),s=o.algorithm.algorithm.join("."),s){case"1.2.840.113549.1.1.1":return u.RSAPrivateKey.decode(o.subjectPrivateKey,"der");case"1.2.840.10045.2.1":return{curve:o.algorithm.curve,privateKey:u.ECPrivateKey.decode(o.subjectPrivateKey,"der").privateKey};case"1.2.840.10040.4.1":return o.algorithm.params.priv_key=u.DSAparam.decode(o.subjectPrivateKey,"der"),{type:"dsa",params:o.algorithm.params};default:throw new Error("unknown key id "+s)}case"RSA PUBLIC KEY":return u.RSAPublicKey.decode(r,"der");case"RSA PRIVATE KEY":return u.RSAPrivateKey.decode(r,"der");case"DSA PRIVATE KEY":return{type:"dsa",params:u.DSAPrivateKey.decode(r,"der")};case"EC PRIVATE KEY":return r=u.ECPrivateKey.decode(r,"der"),{curve:r.parameters.value,privateKey:r.privateKey};default:throw new Error("unknown key type "+i)}}h.signature=u.signature;function d(b,a){var n=b.algorithm.decrypt.kde.kdeparams.salt,i=parseInt(b.algorithm.decrypt.kde.kdeparams.iters.toString(),10),r=g[b.algorithm.decrypt.cipher.algo.join(".")],s=b.algorithm.decrypt.cipher.iv,o=b.subjectPrivateKey,l=parseInt(r.split("-")[1],10)/8,v=c.pbkdf2Sync(a,n,i,l,"sha1"),f=y.createDecipheriv(r,v,s),p=[];return p.push(f.update(o)),p.push(f.final()),m.concat(p)}},{"./aesid.json":226,"./asn1":227,"./fixProc":229,"browserify-aes":23,pbkdf2:231,"safe-buffer":250}],231:[function(t,E,e){e.pbkdf2=t("./lib/async"),e.pbkdf2Sync=t("./lib/sync")},{"./lib/async":232,"./lib/sync":235}],232:[function(t,E,e){(function(u){(function(){var g=t("safe-buffer").Buffer,S=t("./precondition"),y=t("./default-encoding"),c=t("./sync"),m=t("./to-buffer"),h,d=u.crypto&&u.crypto.subtle,b={sha:"SHA-1","sha-1":"SHA-1",sha1:"SHA-1",sha256:"SHA-256","sha-256":"SHA-256",sha384:"SHA-384","sha-384":"SHA-384","sha-512":"SHA-512",sha512:"SHA-512"},a=[];function n(l){if(u.process&&!u.process.browser||!d||!d.importKey||!d.deriveBits)return Promise.resolve(!1);if(a[l]!==void 0)return a[l];h=h||g.alloc(8);var v=s(h,h,10,128,l).then(function(){return!0}).catch(function(){return!1});return a[l]=v,v}var i;function r(){return i||(u.process&&u.process.nextTick?i=u.process.nextTick:u.queueMicrotask?i=u.queueMicrotask:u.setImmediate?i=u.setImmediate:i=u.setTimeout,i)}function s(l,v,f,p,_){return d.importKey("raw",l,{name:"PBKDF2"},!1,["deriveBits"]).then(function(T){return d.deriveBits({name:"PBKDF2",salt:v,iterations:f,hash:{name:_}},T,p<<3)}).then(function(T){return g.from(T)})}function o(l,v){l.then(function(f){r()(function(){v(null,f)})},function(f){r()(function(){v(f)})})}E.exports=function(l,v,f,p,_,T){typeof _=="function"&&(T=_,_=void 0),_=_||"sha1";var w=b[_.toLowerCase()];if(!w||typeof u.Promise!="function"){r()(function(){var M;try{M=c(l,v,f,p,_)}catch(A){return T(A)}T(null,M)});return}if(S(f,p),l=m(l,y,"Password"),v=m(v,y,"Salt"),typeof T!="function")throw new Error("No callback provided to pbkdf2");o(n(w).then(function(M){return M?s(l,v,f,p,w):c(l,v,f,p,_)}),T)}}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./default-encoding":233,"./precondition":234,"./sync":235,"./to-buffer":236,"safe-buffer":250}],233:[function(t,E,e){(function(u,g){(function(){var S;if(g.process&&g.process.browser)S="utf-8";else if(g.process&&g.process.version){var y=parseInt(u.version.split(".")[0].slice(1),10);S=y>=6?"utf-8":"binary"}else S="utf-8";E.exports=S}).call(this)}).call(this,t("_process"),typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{_process:237}],234:[function(t,E,e){var u=Math.pow(2,30)-1;E.exports=function(g,S){if(typeof g!="number")throw new TypeError("Iterations not a number");if(g<0)throw new TypeError("Bad iterations");if(typeof S!="number")throw new TypeError("Key length not a number");if(S<0||S>u||S!==S)throw new TypeError("Bad key length")}},{}],235:[function(t,E,e){var u=t("create-hash/md5"),g=t("ripemd160"),S=t("sha.js"),y=t("safe-buffer").Buffer,c=t("./precondition"),m=t("./default-encoding"),h=t("./to-buffer"),d=y.alloc(128),b={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,rmd160:20,ripemd160:20};function a(r,s,o){var l=n(r),v=r==="sha512"||r==="sha384"?128:64;s.length>v?s=l(s):s.length<v&&(s=y.concat([s,d],v));for(var f=y.allocUnsafe(v+b[r]),p=y.allocUnsafe(v+b[r]),_=0;_<v;_++)f[_]=s[_]^54,p[_]=s[_]^92;var T=y.allocUnsafe(v+o+4);f.copy(T,0,0,v),this.ipad1=T,this.ipad2=f,this.opad=p,this.alg=r,this.blocksize=v,this.hash=l,this.size=b[r]}a.prototype.run=function(r,s){r.copy(s,this.blocksize);var o=this.hash(s);return o.copy(this.opad,this.blocksize),this.hash(this.opad)};function n(r){function s(l){return S(r).update(l).digest()}function o(l){return new g().update(l).digest()}return r==="rmd160"||r==="ripemd160"?o:r==="md5"?u:s}function i(r,s,o,l,v){c(o,l),r=h(r,m,"Password"),s=h(s,m,"Salt"),v=v||"sha1";var f=new a(v,r,s.length),p=y.allocUnsafe(l),_=y.allocUnsafe(s.length+4);s.copy(_,0,0,s.length);for(var T=0,w=b[v],M=Math.ceil(l/w),A=1;A<=M;A++){_.writeUInt32BE(A,s.length);for(var W=f.run(_,f.ipad1),ee=W,F=1;F<o;F++){ee=f.run(ee,f.ipad2);for(var C=0;C<w;C++)W[C]^=ee[C]}W.copy(p,T),T+=w}return p}E.exports=i},{"./default-encoding":233,"./precondition":234,"./to-buffer":236,"create-hash/md5":75,ripemd160:249,"safe-buffer":250,"sha.js":257}],236:[function(t,E,e){var u=t("safe-buffer").Buffer;E.exports=function(g,S,y){if(u.isBuffer(g))return g;if(typeof g=="string")return u.from(g,S);if(ArrayBuffer.isView(g))return u.from(g.buffer);throw new TypeError(y+" must be a string, a Buffer, a typed array or a DataView")}},{"safe-buffer":250}],237:[function(t,E,e){var u=E.exports={},g,S;function y(){throw new Error("setTimeout has not been defined")}function c(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?g=setTimeout:g=y}catch{g=y}try{typeof clearTimeout=="function"?S=clearTimeout:S=c}catch{S=c}})();function m(l){if(g===setTimeout)return setTimeout(l,0);if((g===y||!g)&&setTimeout)return g=setTimeout,setTimeout(l,0);try{return g(l,0)}catch{try{return g.call(null,l,0)}catch{return g.call(this,l,0)}}}function h(l){if(S===clearTimeout)return clearTimeout(l);if((S===c||!S)&&clearTimeout)return S=clearTimeout,clearTimeout(l);try{return S(l)}catch{try{return S.call(null,l)}catch{return S.call(this,l)}}}var d=[],b=!1,a,n=-1;function i(){!b||!a||(b=!1,a.length?d=a.concat(d):n=-1,d.length&&r())}function r(){if(!b){var l=m(i);b=!0;for(var v=d.length;v;){for(a=d,d=[];++n<v;)a&&a[n].run();n=-1,v=d.length}a=null,b=!1,h(l)}}u.nextTick=function(l){var v=new Array(arguments.length-1);if(arguments.length>1)for(var f=1;f<arguments.length;f++)v[f-1]=arguments[f];d.push(new s(l,v)),d.length===1&&!b&&m(r)};function s(l,v){this.fun=l,this.array=v}s.prototype.run=function(){this.fun.apply(null,this.array)},u.title="browser",u.browser=!0,u.env={},u.argv=[],u.version="",u.versions={};function o(){}u.on=o,u.addListener=o,u.once=o,u.off=o,u.removeListener=o,u.removeAllListeners=o,u.emit=o,u.prependListener=o,u.prependOnceListener=o,u.listeners=function(l){return[]},u.binding=function(l){throw new Error("process.binding is not supported")},u.cwd=function(){return"/"},u.chdir=function(l){throw new Error("process.chdir is not supported")},u.umask=function(){return 0}},{}],238:[function(t,E,e){e.publicEncrypt=t("./publicEncrypt"),e.privateDecrypt=t("./privateDecrypt"),e.privateEncrypt=function(g,S){return e.publicEncrypt(g,S,!0)},e.publicDecrypt=function(g,S){return e.privateDecrypt(g,S,!0)}},{"./privateDecrypt":240,"./publicEncrypt":241}],239:[function(t,E,e){var u=t("create-hash"),g=t("safe-buffer").Buffer;E.exports=function(y,c){for(var m=g.alloc(0),h=0,d;m.length<c;)d=S(h++),m=g.concat([m,u("sha1").update(y).update(d).digest()]);return m.slice(0,c)};function S(y){var c=g.allocUnsafe(4);return c.writeUInt32BE(y,0),c}},{"create-hash":74,"safe-buffer":250}],240:[function(t,E,e){var u=t("parse-asn1"),g=t("./mgf"),S=t("./xor"),y=t("bn.js"),c=t("browserify-rsa"),m=t("create-hash"),h=t("./withPublic"),d=t("safe-buffer").Buffer;E.exports=function(r,s,o){var l;r.padding?l=r.padding:o?l=1:l=4;var v=u(r),f=v.modulus.byteLength();if(s.length>f||new y(s).cmp(v.modulus)>=0)throw new Error("decryption error");var p;o?p=h(new y(s),v):p=c(s,v);var _=d.alloc(f-p.length);if(p=d.concat([_,p],f),l===4)return b(v,p);if(l===1)return a(v,p,o);if(l===3)return p;throw new Error("unknown padding")};function b(i,r){var s=i.modulus.byteLength(),o=m("sha1").update(d.alloc(0)).digest(),l=o.length;if(r[0]!==0)throw new Error("decryption error");var v=r.slice(1,l+1),f=r.slice(l+1),p=S(v,g(f,l)),_=S(f,g(p,s-l-1));if(n(o,_.slice(0,l)))throw new Error("decryption error");for(var T=l;_[T]===0;)T++;if(_[T++]!==1)throw new Error("decryption error");return _.slice(T)}function a(i,r,s){for(var o=r.slice(0,2),l=2,v=0;r[l++]!==0;)if(l>=r.length){v++;break}var f=r.slice(2,l-1);if((o.toString("hex")!=="0002"&&!s||o.toString("hex")!=="0001"&&s)&&v++,f.length<8&&v++,v)throw new Error("decryption error");return r.slice(l)}function n(i,r){i=d.from(i),r=d.from(r);var s=0,o=i.length;i.length!==r.length&&(s++,o=Math.min(i.length,r.length));for(var l=-1;++l<o;)s+=i[l]^r[l];return s}},{"./mgf":239,"./withPublic":242,"./xor":243,"bn.js":18,"browserify-rsa":41,"create-hash":74,"parse-asn1":230,"safe-buffer":250}],241:[function(t,E,e){var u=t("parse-asn1"),g=t("randombytes"),S=t("create-hash"),y=t("./mgf"),c=t("./xor"),m=t("bn.js"),h=t("./withPublic"),d=t("browserify-rsa"),b=t("safe-buffer").Buffer;E.exports=function(s,o,l){var v;s.padding?v=s.padding:l?v=1:v=4;var f=u(s),p;if(v===4)p=a(f,o);else if(v===1)p=n(f,o,l);else if(v===3){if(p=new m(o),p.cmp(f.modulus)>=0)throw new Error("data too long for modulus")}else throw new Error("unknown padding");return l?d(p,f):h(p,f)};function a(r,s){var o=r.modulus.byteLength(),l=s.length,v=S("sha1").update(b.alloc(0)).digest(),f=v.length,p=2*f;if(l>o-p-2)throw new Error("message too long");var _=b.alloc(o-l-p-2),T=o-f-1,w=g(f),M=c(b.concat([v,_,b.alloc(1,1),s],T),y(w,T)),A=c(w,y(M,f));return new m(b.concat([b.alloc(1),A,M],o))}function n(r,s,o){var l=s.length,v=r.modulus.byteLength();if(l>v-11)throw new Error("message too long");var f;return o?f=b.alloc(v-l-3,255):f=i(v-l-3),new m(b.concat([b.from([0,o?1:2]),f,b.alloc(1),s],v))}function i(r){for(var s=b.allocUnsafe(r),o=0,l=g(r*2),v=0,f;o<r;)v===l.length&&(l=g(r*2),v=0),f=l[v++],f&&(s[o++]=f);return s}},{"./mgf":239,"./withPublic":242,"./xor":243,"bn.js":18,"browserify-rsa":41,"create-hash":74,"parse-asn1":230,randombytes:244,"safe-buffer":250}],242:[function(t,E,e){var u=t("bn.js"),g=t("safe-buffer").Buffer;function S(y,c){return g.from(y.toRed(u.mont(c.modulus)).redPow(new u(c.publicExponent)).fromRed().toArray())}E.exports=S},{"bn.js":18,"safe-buffer":250}],243:[function(t,E,e){E.exports=function(g,S){for(var y=g.length,c=-1;++c<y;)g[c]^=S[c];return g}},{}],244:[function(t,E,e){(function(u,g){(function(){var S=65536,y=4294967295;function c(){throw new Error(`Secure random number generation is not supported by this browser.
Use Chrome, Firefox or Internet Explorer 11`)}var m=t("safe-buffer").Buffer,h=g.crypto||g.msCrypto;h&&h.getRandomValues?E.exports=d:E.exports=c;function d(b,a){if(b>y)throw new RangeError("requested too many random bytes");var n=m.allocUnsafe(b);if(b>0)if(b>S)for(var i=0;i<b;i+=S)h.getRandomValues(n.slice(i,i+S));else h.getRandomValues(n);return typeof a=="function"?u.nextTick(function(){a(null,n)}):n}}).call(this)}).call(this,t("_process"),typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{_process:237,"safe-buffer":250}],245:[function(t,E,e){(function(u,g){(function(){function S(){throw new Error(`secure random number generation not supported by this browser
use chrome, FireFox or Internet Explorer 11`)}var y=t("safe-buffer"),c=t("randombytes"),m=y.Buffer,h=y.kMaxLength,d=g.crypto||g.msCrypto,b=Math.pow(2,32)-1;function a(o,l){if(typeof o!="number"||o!==o)throw new TypeError("offset must be a number");if(o>b||o<0)throw new TypeError("offset must be a uint32");if(o>h||o>l)throw new RangeError("offset out of range")}function n(o,l,v){if(typeof o!="number"||o!==o)throw new TypeError("size must be a number");if(o>b||o<0)throw new TypeError("size must be a uint32");if(o+l>v||o>h)throw new RangeError("buffer too small")}d&&d.getRandomValues||!u.browser?(e.randomFill=i,e.randomFillSync=s):(e.randomFill=S,e.randomFillSync=S);function i(o,l,v,f){if(!m.isBuffer(o)&&!(o instanceof g.Uint8Array))throw new TypeError('"buf" argument must be a Buffer or Uint8Array');if(typeof l=="function")f=l,l=0,v=o.length;else if(typeof v=="function")f=v,v=o.length-l;else if(typeof f!="function")throw new TypeError('"cb" argument must be a function');return a(l,o.length),n(v,l,o.length),r(o,l,v,f)}function r(o,l,v,f){if(u.browser){var p=o.buffer,_=new Uint8Array(p,l,v);if(d.getRandomValues(_),f){u.nextTick(function(){f(null,o)});return}return o}if(f){c(v,function(w,M){if(w)return f(w);M.copy(o,l),f(null,o)});return}var T=c(v);return T.copy(o,l),o}function s(o,l,v){if(typeof l>"u"&&(l=0),!m.isBuffer(o)&&!(o instanceof g.Uint8Array))throw new TypeError('"buf" argument must be a Buffer or Uint8Array');return a(l,o.length),v===void 0&&(v=o.length-l),n(v,l,o.length),r(o,l,v)}}).call(this)}).call(this,t("_process"),typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{_process:237,randombytes:244,"safe-buffer":250}],246:[function(t,E,e){E.exports=t("./lib/retry")},{"./lib/retry":247}],247:[function(t,E,e){var u=t("./retry_operation");e.operation=function(g){var S=e.timeouts(g);return new u(S,{forever:g&&(g.forever||g.retries===1/0),unref:g&&g.unref,maxRetryTime:g&&g.maxRetryTime})},e.timeouts=function(g){if(g instanceof Array)return[].concat(g);var S={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var y in g)S[y]=g[y];if(S.minTimeout>S.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var c=[],m=0;m<S.retries;m++)c.push(this.createTimeout(m,S));return g&&g.forever&&!c.length&&c.push(this.createTimeout(m,S)),c.sort(function(h,d){return h-d}),c},e.createTimeout=function(g,S){var y=S.randomize?Math.random()+1:1,c=Math.round(y*Math.max(S.minTimeout,1)*Math.pow(S.factor,g));return c=Math.min(c,S.maxTimeout),c},e.wrap=function(g,S,y){if(S instanceof Array&&(y=S,S=null),!y){y=[];for(var c in g)typeof g[c]=="function"&&y.push(c)}for(var m=0;m<y.length;m++){var h=y[m],d=g[h];g[h]=function(a){var n=e.operation(S),i=Array.prototype.slice.call(arguments,1),r=i.pop();i.push(function(s){n.retry(s)||(s&&(arguments[0]=n.mainError()),r.apply(this,arguments))}),n.attempt(function(){a.apply(g,i)})}.bind(g,d),g[h].options=S}}},{"./retry_operation":248}],248:[function(t,E,e){function u(g,S){typeof S=="boolean"&&(S={forever:S}),this._originalTimeouts=JSON.parse(JSON.stringify(g)),this._timeouts=g,this._options=S||{},this._maxRetryTime=S&&S.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}E.exports=u,u.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},u.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},u.prototype.retry=function(g){if(this._timeout&&clearTimeout(this._timeout),!g)return!1;var S=new Date().getTime();if(g&&S-this._operationStart>=this._maxRetryTime)return this._errors.push(g),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(g);var y=this._timeouts.shift();if(y===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),y=this._cachedTimeouts.slice(-1);else return!1;var c=this;return this._timer=setTimeout(function(){c._attempts++,c._operationTimeoutCb&&(c._timeout=setTimeout(function(){c._operationTimeoutCb(c._attempts)},c._operationTimeout),c._options.unref&&c._timeout.unref()),c._fn(c._attempts)},y),this._options.unref&&this._timer.unref(),!0},u.prototype.attempt=function(g,S){this._fn=g,S&&(S.timeout&&(this._operationTimeout=S.timeout),S.cb&&(this._operationTimeoutCb=S.cb));var y=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){y._operationTimeoutCb()},y._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},u.prototype.try=function(g){console.log("Using RetryOperation.try() is deprecated"),this.attempt(g)},u.prototype.start=function(g){console.log("Using RetryOperation.start() is deprecated"),this.attempt(g)},u.prototype.start=u.prototype.try,u.prototype.errors=function(){return this._errors},u.prototype.attempts=function(){return this._attempts},u.prototype.mainError=function(){if(this._errors.length===0)return null;for(var g={},S=null,y=0,c=0;c<this._errors.length;c++){var m=this._errors[c],h=m.message,d=(g[h]||0)+1;g[h]=d,d>=y&&(S=m,y=d)}return S}},{}],249:[function(t,E,e){var u=t("buffer").Buffer,g=t("inherits"),S=t("hash-base"),y=new Array(16),c=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13],m=[5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11],h=[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6],d=[8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11],b=[0,1518500249,1859775393,2400959708,2840853838],a=[1352829926,1548603684,1836072691,2053994217,0];function n(){S.call(this,64),this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520}g(n,S),n.prototype._update=function(){for(var f=y,p=0;p<16;++p)f[p]=this._block.readInt32LE(p*4);for(var _=this._a|0,T=this._b|0,w=this._c|0,M=this._d|0,A=this._e|0,W=this._a|0,ee=this._b|0,F=this._c|0,C=this._d|0,O=this._e|0,I=0;I<80;I+=1){var D,j;I<16?(D=r(_,T,w,M,A,f[c[I]],b[0],h[I]),j=v(W,ee,F,C,O,f[m[I]],a[0],d[I])):I<32?(D=s(_,T,w,M,A,f[c[I]],b[1],h[I]),j=l(W,ee,F,C,O,f[m[I]],a[1],d[I])):I<48?(D=o(_,T,w,M,A,f[c[I]],b[2],h[I]),j=o(W,ee,F,C,O,f[m[I]],a[2],d[I])):I<64?(D=l(_,T,w,M,A,f[c[I]],b[3],h[I]),j=s(W,ee,F,C,O,f[m[I]],a[3],d[I])):(D=v(_,T,w,M,A,f[c[I]],b[4],h[I]),j=r(W,ee,F,C,O,f[m[I]],a[4],d[I])),_=A,A=M,M=i(w,10),w=T,T=D,W=O,O=C,C=i(F,10),F=ee,ee=j}var Y=this._b+w+C|0;this._b=this._c+M+O|0,this._c=this._d+A+W|0,this._d=this._e+_+ee|0,this._e=this._a+T+F|0,this._a=Y},n.prototype._digest=function(){this._block[this._blockOffset++]=128,this._blockOffset>56&&(this._block.fill(0,this._blockOffset,64),this._update(),this._blockOffset=0),this._block.fill(0,this._blockOffset,56),this._block.writeUInt32LE(this._length[0],56),this._block.writeUInt32LE(this._length[1],60),this._update();var f=u.alloc?u.alloc(20):new u(20);return f.writeInt32LE(this._a,0),f.writeInt32LE(this._b,4),f.writeInt32LE(this._c,8),f.writeInt32LE(this._d,12),f.writeInt32LE(this._e,16),f};function i(f,p){return f<<p|f>>>32-p}function r(f,p,_,T,w,M,A,W){return i(f+(p^_^T)+M+A|0,W)+w|0}function s(f,p,_,T,w,M,A,W){return i(f+(p&_|~p&T)+M+A|0,W)+w|0}function o(f,p,_,T,w,M,A,W){return i(f+((p|~_)^T)+M+A|0,W)+w|0}function l(f,p,_,T,w,M,A,W){return i(f+(p&T|_&~T)+M+A|0,W)+w|0}function v(f,p,_,T,w,M,A,W){return i(f+(p^(_|~T))+M+A|0,W)+w|0}E.exports=n},{buffer:68,"hash-base":116,inherits:146}],250:[function(t,E,e){/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */var u=t("buffer"),g=u.Buffer;function S(c,m){for(var h in c)m[h]=c[h]}g.from&&g.alloc&&g.allocUnsafe&&g.allocUnsafeSlow?E.exports=u:(S(u,e),e.Buffer=y);function y(c,m,h){return g(c,m,h)}y.prototype=Object.create(g.prototype),S(g,y),y.from=function(c,m,h){if(typeof c=="number")throw new TypeError("Argument must not be a number");return g(c,m,h)},y.alloc=function(c,m,h){if(typeof c!="number")throw new TypeError("Argument must be a number");var d=g(c);return m!==void 0?typeof h=="string"?d.fill(m,h):d.fill(m):d.fill(0),d},y.allocUnsafe=function(c){if(typeof c!="number")throw new TypeError("Argument must be a number");return g(c)},y.allocUnsafeSlow=function(c){if(typeof c!="number")throw new TypeError("Argument must be a number");return u.SlowBuffer(c)}},{buffer:68}],251:[function(t,E,e){(function(u){(function(){var g=t("buffer"),S=g.Buffer,y={},c;for(c in g)g.hasOwnProperty(c)&&(c==="SlowBuffer"||c==="Buffer"||(y[c]=g[c]));var m=y.Buffer={};for(c in S)S.hasOwnProperty(c)&&(c==="allocUnsafe"||c==="allocUnsafeSlow"||(m[c]=S[c]));if(y.Buffer.prototype=S.prototype,(!m.from||m.from===Uint8Array.from)&&(m.from=function(h,d,b){if(typeof h=="number")throw new TypeError('The "value" argument must not be of type number. Received type '+typeof h);if(h&&typeof h.length>"u")throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof h);return S(h,d,b)}),m.alloc||(m.alloc=function(h,d,b){if(typeof h!="number")throw new TypeError('The "size" argument must be of type number. Received type '+typeof h);if(h<0||h>=2*(1<<30))throw new RangeError('The value "'+h+'" is invalid for option "size"');var a=S(h);return!d||d.length===0?a.fill(0):typeof b=="string"?a.fill(d,b):a.fill(d),a}),!y.kStringMaxLength)try{y.kStringMaxLength=u.binding("buffer").kStringMaxLength}catch{}y.constants||(y.constants={MAX_LENGTH:y.kMaxLength},y.kStringMaxLength&&(y.constants.MAX_STRING_LENGTH=y.kStringMaxLength)),E.exports=y}).call(this)}).call(this,t("_process"))},{_process:237,buffer:68}],252:[function(t,E,e){var u=E.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(g){return g.encoding?"rtpmap:%d %s/%s/%s":g.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(g){return g.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(g){return g.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(g){return"extmap:%d"+(g.direction?"/%s":"%v")+(g["encrypt-uri"]?" %s":"%v")+" %s"+(g.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(g){return g.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(g){var S="candidate:%s %d %s %d %s %d typ %s";return S+=g.raddr!=null?" raddr %s rport %d":"%v%v",S+=g.tcptype!=null?" tcptype %s":"%v",g.generation!=null&&(S+=" generation %d"),S+=g["network-id"]!=null?" network-id %d":"%v",S+=g["network-cost"]!=null?" network-cost %d":"%v",S}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(g){var S="ssrc:%d";return g.attribute!=null&&(S+=" %s",g.value!=null&&(S+=":%s")),S}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(g){return g.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(g){return g.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(g){return"imageattr:%s %s %s"+(g.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(g){return"simulcast:%s %s"+(g.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(g){return"ts-refclk:%s"+(g.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(g){var S="mediaclk:";return S+=g.id!=null?"id=%s %s":"%v%s",S+=g.mediaClockValue!=null?"=%s":"",S+=g.rateNumerator!=null?" rate=%s":"",S+=g.rateDenominator!=null?"/%s":"",S}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(u).forEach(function(g){var S=u[g];S.forEach(function(y){y.reg||(y.reg=/(.*)/),y.format||(y.format="%s")})})},{}],253:[function(t,E,e){var u=t("./parser"),g=t("./writer");e.write=g,e.parse=u.parse,e.parseParams=u.parseParams,e.parseFmtpConfig=u.parseFmtpConfig,e.parsePayloads=u.parsePayloads,e.parseRemoteCandidates=u.parseRemoteCandidates,e.parseImageAttributes=u.parseImageAttributes,e.parseSimulcastStreamList=u.parseSimulcastStreamList},{"./parser":254,"./writer":255}],254:[function(t,E,e){var u=function(h){return String(Number(h))===h?Number(h):h},g=function(h,d,b,a){if(a&&!b)d[a]=u(h[1]);else for(var n=0;n<b.length;n+=1)h[n+1]!=null&&(d[b[n]]=u(h[n+1]))},S=function(h,d,b){var a=h.name&&h.names;h.push&&!d[h.push]?d[h.push]=[]:a&&!d[h.name]&&(d[h.name]={});var n=h.push?{}:a?d[h.name]:d;g(b.match(h.reg),n,h.names,h.name),h.push&&d[h.push].push(n)},y=t("./grammar"),c=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(h){var d={},b=[],a=d;return h.split(/(\r\n|\r|\n)/).filter(c).forEach(function(n){var i=n[0],r=n.slice(2);i==="m"&&(b.push({rtp:[],fmtp:[]}),a=b[b.length-1]);for(var s=0;s<(y[i]||[]).length;s+=1){var o=y[i][s];if(o.reg.test(r))return S(o,a,r)}}),d.media=b,d};var m=function(h,d){var b=d.split(/=(.+)/,2);return b.length===2?h[b[0]]=u(b[1]):b.length===1&&d.length>1&&(h[b[0]]=void 0),h};e.parseParams=function(h){return h.split(/;\s?/).reduce(m,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(h){return h.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(h){for(var d=[],b=h.split(" ").map(u),a=0;a<b.length;a+=3)d.push({component:b[a],ip:b[a+1],port:b[a+2]});return d},e.parseImageAttributes=function(h){return h.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(m,{})})},e.parseSimulcastStreamList=function(h){return h.split(";").map(function(d){return d.split(",").map(function(b){var a,n=!1;return b[0]!=="~"?a=u(b):(a=u(b.substring(1,b.length)),n=!0),{scid:a,paused:n}})})}},{"./grammar":252}],255:[function(t,E,e){var u=t("./grammar"),g=/%[sdv%]/g,S=function(h){var d=1,b=arguments,a=b.length;return h.replace(g,function(n){if(d>=a)return n;var i=b[d];switch(d+=1,n){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}})},y=function(h,d,b){var a=d.format instanceof Function?d.format(d.push?b:b[d.name]):d.format,n=[h+"="+a];if(d.names)for(var i=0;i<d.names.length;i+=1){var r=d.names[i];d.name?n.push(b[d.name][r]):n.push(b[d.names[i]])}else n.push(b[d.name]);return S.apply(null,n)},c=["v","o","s","i","u","e","p","c","b","t","r","z","a"],m=["i","c","b","a"];E.exports=function(h,d){d=d||{},h.version==null&&(h.version=0),h.name==null&&(h.name=" "),h.media.forEach(function(i){i.payloads==null&&(i.payloads="")});var b=d.outerOrder||c,a=d.innerOrder||m,n=[];return b.forEach(function(i){u[i].forEach(function(r){r.name in h&&h[r.name]!=null?n.push(y(i,r,h)):r.push in h&&h[r.push]!=null&&h[r.push].forEach(function(s){n.push(y(i,r,s))})})}),h.media.forEach(function(i){n.push(y("m",u.m[0],i)),a.forEach(function(r){u[r].forEach(function(s){s.name in i&&i[s.name]!=null?n.push(y(r,s,i)):s.push in i&&i[s.push]!=null&&i[s.push].forEach(function(o){n.push(y(r,s,o))})})})}),n.join(`\r
`)+`\r
`}},{"./grammar":252}],256:[function(t,E,e){var u=t("safe-buffer").Buffer;function g(S,y){this._block=u.alloc(S),this._finalSize=y,this._blockSize=S,this._len=0}g.prototype.update=function(S,y){typeof S=="string"&&(y=y||"utf8",S=u.from(S,y));for(var c=this._block,m=this._blockSize,h=S.length,d=this._len,b=0;b<h;){for(var a=d%m,n=Math.min(h-b,m-a),i=0;i<n;i++)c[a+i]=S[b+i];d+=n,b+=n,d%m===0&&this._update(c)}return this._len+=h,this},g.prototype.digest=function(S){var y=this._len%this._blockSize;this._block[y]=128,this._block.fill(0,y+1),y>=this._finalSize&&(this._update(this._block),this._block.fill(0));var c=this._len*8;if(c<=4294967295)this._block.writeUInt32BE(c,this._blockSize-4);else{var m=(c&4294967295)>>>0,h=(c-m)/4294967296;this._block.writeUInt32BE(h,this._blockSize-8),this._block.writeUInt32BE(m,this._blockSize-4)}this._update(this._block);var d=this._hash();return S?d.toString(S):d},g.prototype._update=function(){throw new Error("_update must be implemented by subclass")},E.exports=g},{"safe-buffer":250}],257:[function(t,E,u){var u=E.exports=function(S){S=S.toLowerCase();var y=u[S];if(!y)throw new Error(S+" is not supported (we accept pull requests)");return new y};u.sha=t("./sha"),u.sha1=t("./sha1"),u.sha224=t("./sha224"),u.sha256=t("./sha256"),u.sha384=t("./sha384"),u.sha512=t("./sha512")},{"./sha":258,"./sha1":259,"./sha224":260,"./sha256":261,"./sha384":262,"./sha512":263}],258:[function(t,E,e){var u=t("inherits"),g=t("./hash"),S=t("safe-buffer").Buffer,y=[1518500249,1859775393,-1894007588,-899497514],c=new Array(80);function m(){this.init(),this._w=c,g.call(this,64,56)}u(m,g),m.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function h(a){return a<<5|a>>>27}function d(a){return a<<30|a>>>2}function b(a,n,i,r){return a===0?n&i|~n&r:a===2?n&i|n&r|i&r:n^i^r}m.prototype._update=function(a){for(var n=this._w,i=this._a|0,r=this._b|0,s=this._c|0,o=this._d|0,l=this._e|0,v=0;v<16;++v)n[v]=a.readInt32BE(v*4);for(;v<80;++v)n[v]=n[v-3]^n[v-8]^n[v-14]^n[v-16];for(var f=0;f<80;++f){var p=~~(f/20),_=h(i)+b(p,r,s,o)+l+n[f]+y[p]|0;l=o,o=s,s=d(r),r=i,i=_}this._a=i+this._a|0,this._b=r+this._b|0,this._c=s+this._c|0,this._d=o+this._d|0,this._e=l+this._e|0},m.prototype._hash=function(){var a=S.allocUnsafe(20);return a.writeInt32BE(this._a|0,0),a.writeInt32BE(this._b|0,4),a.writeInt32BE(this._c|0,8),a.writeInt32BE(this._d|0,12),a.writeInt32BE(this._e|0,16),a},E.exports=m},{"./hash":256,inherits:146,"safe-buffer":250}],259:[function(t,E,e){var u=t("inherits"),g=t("./hash"),S=t("safe-buffer").Buffer,y=[1518500249,1859775393,-1894007588,-899497514],c=new Array(80);function m(){this.init(),this._w=c,g.call(this,64,56)}u(m,g),m.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function h(n){return n<<1|n>>>31}function d(n){return n<<5|n>>>27}function b(n){return n<<30|n>>>2}function a(n,i,r,s){return n===0?i&r|~i&s:n===2?i&r|i&s|r&s:i^r^s}m.prototype._update=function(n){for(var i=this._w,r=this._a|0,s=this._b|0,o=this._c|0,l=this._d|0,v=this._e|0,f=0;f<16;++f)i[f]=n.readInt32BE(f*4);for(;f<80;++f)i[f]=h(i[f-3]^i[f-8]^i[f-14]^i[f-16]);for(var p=0;p<80;++p){var _=~~(p/20),T=d(r)+a(_,s,o,l)+v+i[p]+y[_]|0;v=l,l=o,o=b(s),s=r,r=T}this._a=r+this._a|0,this._b=s+this._b|0,this._c=o+this._c|0,this._d=l+this._d|0,this._e=v+this._e|0},m.prototype._hash=function(){var n=S.allocUnsafe(20);return n.writeInt32BE(this._a|0,0),n.writeInt32BE(this._b|0,4),n.writeInt32BE(this._c|0,8),n.writeInt32BE(this._d|0,12),n.writeInt32BE(this._e|0,16),n},E.exports=m},{"./hash":256,inherits:146,"safe-buffer":250}],260:[function(t,E,e){var u=t("inherits"),g=t("./sha256"),S=t("./hash"),y=t("safe-buffer").Buffer,c=new Array(64);function m(){this.init(),this._w=c,S.call(this,64,56)}u(m,g),m.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},m.prototype._hash=function(){var h=y.allocUnsafe(28);return h.writeInt32BE(this._a,0),h.writeInt32BE(this._b,4),h.writeInt32BE(this._c,8),h.writeInt32BE(this._d,12),h.writeInt32BE(this._e,16),h.writeInt32BE(this._f,20),h.writeInt32BE(this._g,24),h},E.exports=m},{"./hash":256,"./sha256":261,inherits:146,"safe-buffer":250}],261:[function(t,E,e){var u=t("inherits"),g=t("./hash"),S=t("safe-buffer").Buffer,y=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],c=new Array(64);function m(){this.init(),this._w=c,g.call(this,64,56)}u(m,g),m.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function h(r,s,o){return o^r&(s^o)}function d(r,s,o){return r&s|o&(r|s)}function b(r){return(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10)}function a(r){return(r>>>6|r<<26)^(r>>>11|r<<21)^(r>>>25|r<<7)}function n(r){return(r>>>7|r<<25)^(r>>>18|r<<14)^r>>>3}function i(r){return(r>>>17|r<<15)^(r>>>19|r<<13)^r>>>10}m.prototype._update=function(r){for(var s=this._w,o=this._a|0,l=this._b|0,v=this._c|0,f=this._d|0,p=this._e|0,_=this._f|0,T=this._g|0,w=this._h|0,M=0;M<16;++M)s[M]=r.readInt32BE(M*4);for(;M<64;++M)s[M]=i(s[M-2])+s[M-7]+n(s[M-15])+s[M-16]|0;for(var A=0;A<64;++A){var W=w+a(p)+h(p,_,T)+y[A]+s[A]|0,ee=b(o)+d(o,l,v)|0;w=T,T=_,_=p,p=f+W|0,f=v,v=l,l=o,o=W+ee|0}this._a=o+this._a|0,this._b=l+this._b|0,this._c=v+this._c|0,this._d=f+this._d|0,this._e=p+this._e|0,this._f=_+this._f|0,this._g=T+this._g|0,this._h=w+this._h|0},m.prototype._hash=function(){var r=S.allocUnsafe(32);return r.writeInt32BE(this._a,0),r.writeInt32BE(this._b,4),r.writeInt32BE(this._c,8),r.writeInt32BE(this._d,12),r.writeInt32BE(this._e,16),r.writeInt32BE(this._f,20),r.writeInt32BE(this._g,24),r.writeInt32BE(this._h,28),r},E.exports=m},{"./hash":256,inherits:146,"safe-buffer":250}],262:[function(t,E,e){var u=t("inherits"),g=t("./sha512"),S=t("./hash"),y=t("safe-buffer").Buffer,c=new Array(160);function m(){this.init(),this._w=c,S.call(this,128,112)}u(m,g),m.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},m.prototype._hash=function(){var h=y.allocUnsafe(48);function d(b,a,n){h.writeInt32BE(b,n),h.writeInt32BE(a,n+4)}return d(this._ah,this._al,0),d(this._bh,this._bl,8),d(this._ch,this._cl,16),d(this._dh,this._dl,24),d(this._eh,this._el,32),d(this._fh,this._fl,40),h},E.exports=m},{"./hash":256,"./sha512":263,inherits:146,"safe-buffer":250}],263:[function(t,E,e){var u=t("inherits"),g=t("./hash"),S=t("safe-buffer").Buffer,y=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],c=new Array(160);function m(){this.init(),this._w=c,g.call(this,128,112)}u(m,g),m.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function h(l,v,f){return f^l&(v^f)}function d(l,v,f){return l&v|f&(l|v)}function b(l,v){return(l>>>28|v<<4)^(v>>>2|l<<30)^(v>>>7|l<<25)}function a(l,v){return(l>>>14|v<<18)^(l>>>18|v<<14)^(v>>>9|l<<23)}function n(l,v){return(l>>>1|v<<31)^(l>>>8|v<<24)^l>>>7}function i(l,v){return(l>>>1|v<<31)^(l>>>8|v<<24)^(l>>>7|v<<25)}function r(l,v){return(l>>>19|v<<13)^(v>>>29|l<<3)^l>>>6}function s(l,v){return(l>>>19|v<<13)^(v>>>29|l<<3)^(l>>>6|v<<26)}function o(l,v){return l>>>0<v>>>0?1:0}m.prototype._update=function(l){for(var v=this._w,f=this._ah|0,p=this._bh|0,_=this._ch|0,T=this._dh|0,w=this._eh|0,M=this._fh|0,A=this._gh|0,W=this._hh|0,ee=this._al|0,F=this._bl|0,C=this._cl|0,O=this._dl|0,I=this._el|0,D=this._fl|0,j=this._gl|0,Y=this._hl|0,q=0;q<32;q+=2)v[q]=l.readInt32BE(q*4),v[q+1]=l.readInt32BE(q*4+4);for(;q<160;q+=2){var B=v[q-30],R=v[q-15*2+1],k=n(B,R),P=i(R,B);B=v[q-2*2],R=v[q-2*2+1];var V=r(B,R),x=s(R,B),Q=v[q-7*2],te=v[q-7*2+1],ae=v[q-16*2],de=v[q-16*2+1],X=P+te|0,$=k+Q+o(X,P)|0;X=X+x|0,$=$+V+o(X,x)|0,X=X+de|0,$=$+ae+o(X,de)|0,v[q]=$,v[q+1]=X}for(var K=0;K<160;K+=2){$=v[K],X=v[K+1];var re=d(f,p,_),ue=d(ee,F,C),H=b(f,ee),G=b(ee,f),U=a(w,I),L=a(I,w),z=y[K],J=y[K+1],ne=h(w,M,A),oe=h(I,D,j),ce=Y+L|0,pe=W+U+o(ce,Y)|0;ce=ce+oe|0,pe=pe+ne+o(ce,oe)|0,ce=ce+J|0,pe=pe+z+o(ce,J)|0,ce=ce+X|0,pe=pe+$+o(ce,X)|0;var he=G+ue|0,fe=H+re+o(he,G)|0;W=A,Y=j,A=M,j=D,M=w,D=I,I=O+ce|0,w=T+pe+o(I,O)|0,T=_,O=C,_=p,C=F,p=f,F=ee,ee=ce+he|0,f=pe+fe+o(ee,ce)|0}this._al=this._al+ee|0,this._bl=this._bl+F|0,this._cl=this._cl+C|0,this._dl=this._dl+O|0,this._el=this._el+I|0,this._fl=this._fl+D|0,this._gl=this._gl+j|0,this._hl=this._hl+Y|0,this._ah=this._ah+f+o(this._al,ee)|0,this._bh=this._bh+p+o(this._bl,F)|0,this._ch=this._ch+_+o(this._cl,C)|0,this._dh=this._dh+T+o(this._dl,O)|0,this._eh=this._eh+w+o(this._el,I)|0,this._fh=this._fh+M+o(this._fl,D)|0,this._gh=this._gh+A+o(this._gl,j)|0,this._hh=this._hh+W+o(this._hl,Y)|0},m.prototype._hash=function(){var l=S.allocUnsafe(64);function v(f,p,_){l.writeInt32BE(f,_),l.writeInt32BE(p,_+4)}return v(this._ah,this._al,0),v(this._bh,this._bl,8),v(this._ch,this._cl,16),v(this._dh,this._dl,24),v(this._eh,this._el,32),v(this._fh,this._fl,40),v(this._gh,this._gl,48),v(this._hh,this._hl,56),l},E.exports=m},{"./hash":256,inherits:146,"safe-buffer":250}],264:[function(t,E,e){E.exports=S;var u=t("events").EventEmitter,g=t("inherits");g(S,u),S.Readable=t("readable-stream/lib/_stream_readable.js"),S.Writable=t("readable-stream/lib/_stream_writable.js"),S.Duplex=t("readable-stream/lib/_stream_duplex.js"),S.Transform=t("readable-stream/lib/_stream_transform.js"),S.PassThrough=t("readable-stream/lib/_stream_passthrough.js"),S.finished=t("readable-stream/lib/internal/streams/end-of-stream.js"),S.pipeline=t("readable-stream/lib/internal/streams/pipeline.js"),S.Stream=S;function S(){u.call(this)}S.prototype.pipe=function(y,c){var m=this;function h(s){y.writable&&y.write(s)===!1&&m.pause&&m.pause()}m.on("data",h);function d(){m.readable&&m.resume&&m.resume()}y.on("drain",d),!y._isStdio&&(!c||c.end!==!1)&&(m.on("end",a),m.on("close",n));var b=!1;function a(){b||(b=!0,y.end())}function n(){b||(b=!0,typeof y.destroy=="function"&&y.destroy())}function i(s){if(r(),u.listenerCount(this,"error")===0)throw s}m.on("error",i),y.on("error",i);function r(){m.removeListener("data",h),y.removeListener("drain",d),m.removeListener("end",a),m.removeListener("close",n),m.removeListener("error",i),y.removeListener("error",i),m.removeListener("end",r),m.removeListener("close",r),y.removeListener("close",r)}return m.on("end",r),m.on("close",r),y.on("close",r),y.emit("pipe",m),y}},{events:105,inherits:146,"readable-stream/lib/_stream_duplex.js":266,"readable-stream/lib/_stream_passthrough.js":267,"readable-stream/lib/_stream_readable.js":268,"readable-stream/lib/_stream_transform.js":269,"readable-stream/lib/_stream_writable.js":270,"readable-stream/lib/internal/streams/end-of-stream.js":274,"readable-stream/lib/internal/streams/pipeline.js":276}],265:[function(t,E,e){arguments[4][50][0].apply(e,arguments)},{dup:50}],266:[function(t,E,e){(function(u){(function(){var g=Object.keys||function(n){var i=[];for(var r in n)i.push(r);return i};E.exports=d;var S=t("./_stream_readable"),y=t("./_stream_writable");t("inherits")(d,S);for(var c=g(y.prototype),m=0;m<c.length;m++){var h=c[m];d.prototype[h]||(d.prototype[h]=y.prototype[h])}function d(n){if(!(this instanceof d))return new d(n);S.call(this,n),y.call(this,n),this.allowHalfOpen=!0,n&&(n.readable===!1&&(this.readable=!1),n.writable===!1&&(this.writable=!1),n.allowHalfOpen===!1&&(this.allowHalfOpen=!1,this.once("end",b)))}Object.defineProperty(d.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(d.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(d.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function b(){this._writableState.ended||u.nextTick(a,this)}function a(n){n.end()}Object.defineProperty(d.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0||this._writableState===void 0?!1:this._readableState.destroyed&&this._writableState.destroyed},set:function(i){this._readableState===void 0||this._writableState===void 0||(this._readableState.destroyed=i,this._writableState.destroyed=i)}})}).call(this)}).call(this,t("_process"))},{"./_stream_readable":268,"./_stream_writable":270,_process:237,inherits:146}],267:[function(t,E,e){arguments[4][52][0].apply(e,arguments)},{"./_stream_transform":269,dup:52,inherits:146}],268:[function(t,E,e){(function(u,g){(function(){E.exports=C;var S;C.ReadableState=F,t("events").EventEmitter;var y=function(G,U){return G.listeners(U).length},c=t("./internal/streams/stream"),m=t("buffer").Buffer,h=g.Uint8Array||function(){};function d(H){return m.from(H)}function b(H){return m.isBuffer(H)||H instanceof h}var a=t("util"),n;a&&a.debuglog?n=a.debuglog("stream"):n=function(){};var i=t("./internal/streams/buffer_list"),r=t("./internal/streams/destroy"),s=t("./internal/streams/state"),o=s.getHighWaterMark,l=t("../errors").codes,v=l.ERR_INVALID_ARG_TYPE,f=l.ERR_STREAM_PUSH_AFTER_EOF,p=l.ERR_METHOD_NOT_IMPLEMENTED,_=l.ERR_STREAM_UNSHIFT_AFTER_END_EVENT,T,w,M;t("inherits")(C,c);var A=r.errorOrDestroy,W=["error","close","destroy","pause","resume"];function ee(H,G,U){if(typeof H.prependListener=="function")return H.prependListener(G,U);!H._events||!H._events[G]?H.on(G,U):Array.isArray(H._events[G])?H._events[G].unshift(U):H._events[G]=[U,H._events[G]]}function F(H,G,U){S=S||t("./_stream_duplex"),H=H||{},typeof U!="boolean"&&(U=G instanceof S),this.objectMode=!!H.objectMode,U&&(this.objectMode=this.objectMode||!!H.readableObjectMode),this.highWaterMark=o(this,H,"readableHighWaterMark",U),this.buffer=new i,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=H.emitClose!==!1,this.autoDestroy=!!H.autoDestroy,this.destroyed=!1,this.defaultEncoding=H.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,H.encoding&&(T||(T=t("string_decoder/").StringDecoder),this.decoder=new T(H.encoding),this.encoding=H.encoding)}function C(H){if(S=S||t("./_stream_duplex"),!(this instanceof C))return new C(H);var G=this instanceof S;this._readableState=new F(H,this,G),this.readable=!0,H&&(typeof H.read=="function"&&(this._read=H.read),typeof H.destroy=="function"&&(this._destroy=H.destroy)),c.call(this)}Object.defineProperty(C.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0?!1:this._readableState.destroyed},set:function(G){this._readableState&&(this._readableState.destroyed=G)}}),C.prototype.destroy=r.destroy,C.prototype._undestroy=r.undestroy,C.prototype._destroy=function(H,G){G(H)},C.prototype.push=function(H,G){var U=this._readableState,L;return U.objectMode?L=!0:typeof H=="string"&&(G=G||U.defaultEncoding,G!==U.encoding&&(H=m.from(H,G),G=""),L=!0),O(this,H,G,!1,L)},C.prototype.unshift=function(H){return O(this,H,null,!0,!1)};function O(H,G,U,L,z){n("readableAddChunk",G);var J=H._readableState;if(G===null)J.reading=!1,B(H,J);else{var ne;if(z||(ne=D(J,G)),ne)A(H,ne);else if(J.objectMode||G&&G.length>0)if(typeof G!="string"&&!J.objectMode&&Object.getPrototypeOf(G)!==m.prototype&&(G=d(G)),L)J.endEmitted?A(H,new _):I(H,J,G,!0);else if(J.ended)A(H,new f);else{if(J.destroyed)return!1;J.reading=!1,J.decoder&&!U?(G=J.decoder.write(G),J.objectMode||G.length!==0?I(H,J,G,!1):P(H,J)):I(H,J,G,!1)}else L||(J.reading=!1,P(H,J))}return!J.ended&&(J.length<J.highWaterMark||J.length===0)}function I(H,G,U,L){G.flowing&&G.length===0&&!G.sync?(G.awaitDrain=0,H.emit("data",U)):(G.length+=G.objectMode?1:U.length,L?G.buffer.unshift(U):G.buffer.push(U),G.needReadable&&R(H)),P(H,G)}function D(H,G){var U;return!b(G)&&typeof G!="string"&&G!==void 0&&!H.objectMode&&(U=new v("chunk",["string","Buffer","Uint8Array"],G)),U}C.prototype.isPaused=function(){return this._readableState.flowing===!1},C.prototype.setEncoding=function(H){T||(T=t("string_decoder/").StringDecoder);var G=new T(H);this._readableState.decoder=G,this._readableState.encoding=this._readableState.decoder.encoding;for(var U=this._readableState.buffer.head,L="";U!==null;)L+=G.write(U.data),U=U.next;return this._readableState.buffer.clear(),L!==""&&this._readableState.buffer.push(L),this._readableState.length=L.length,this};var j=1073741824;function Y(H){return H>=j?H=j:(H--,H|=H>>>1,H|=H>>>2,H|=H>>>4,H|=H>>>8,H|=H>>>16,H++),H}function q(H,G){return H<=0||G.length===0&&G.ended?0:G.objectMode?1:H!==H?G.flowing&&G.length?G.buffer.head.data.length:G.length:(H>G.highWaterMark&&(G.highWaterMark=Y(H)),H<=G.length?H:G.ended?G.length:(G.needReadable=!0,0))}C.prototype.read=function(H){n("read",H),H=parseInt(H,10);var G=this._readableState,U=H;if(H!==0&&(G.emittedReadable=!1),H===0&&G.needReadable&&((G.highWaterMark!==0?G.length>=G.highWaterMark:G.length>0)||G.ended))return n("read: emitReadable",G.length,G.ended),G.length===0&&G.ended?K(this):R(this),null;if(H=q(H,G),H===0&&G.ended)return G.length===0&&K(this),null;var L=G.needReadable;n("need readable",L),(G.length===0||G.length-H<G.highWaterMark)&&(L=!0,n("length less than watermark",L)),G.ended||G.reading?(L=!1,n("reading or ended",L)):L&&(n("do read"),G.reading=!0,G.sync=!0,G.length===0&&(G.needReadable=!0),this._read(G.highWaterMark),G.sync=!1,G.reading||(H=q(U,G)));var z;return H>0?z=$(H,G):z=null,z===null?(G.needReadable=G.length<=G.highWaterMark,H=0):(G.length-=H,G.awaitDrain=0),G.length===0&&(G.ended||(G.needReadable=!0),U!==H&&G.ended&&K(this)),z!==null&&this.emit("data",z),z};function B(H,G){if(n("onEofChunk"),!G.ended){if(G.decoder){var U=G.decoder.end();U&&U.length&&(G.buffer.push(U),G.length+=G.objectMode?1:U.length)}G.ended=!0,G.sync?R(H):(G.needReadable=!1,G.emittedReadable||(G.emittedReadable=!0,k(H)))}}function R(H){var G=H._readableState;n("emitReadable",G.needReadable,G.emittedReadable),G.needReadable=!1,G.emittedReadable||(n("emitReadable",G.flowing),G.emittedReadable=!0,u.nextTick(k,H))}function k(H){var G=H._readableState;n("emitReadable_",G.destroyed,G.length,G.ended),!G.destroyed&&(G.length||G.ended)&&(H.emit("readable"),G.emittedReadable=!1),G.needReadable=!G.flowing&&!G.ended&&G.length<=G.highWaterMark,X(H)}function P(H,G){G.readingMore||(G.readingMore=!0,u.nextTick(V,H,G))}function V(H,G){for(;!G.reading&&!G.ended&&(G.length<G.highWaterMark||G.flowing&&G.length===0);){var U=G.length;if(n("maybeReadMore read 0"),H.read(0),U===G.length)break}G.readingMore=!1}C.prototype._read=function(H){A(this,new p("_read()"))},C.prototype.pipe=function(H,G){var U=this,L=this._readableState;switch(L.pipesCount){case 0:L.pipes=H;break;case 1:L.pipes=[L.pipes,H];break;default:L.pipes.push(H);break}L.pipesCount+=1,n("pipe count=%d opts=%j",L.pipesCount,G);var z=(!G||G.end!==!1)&&H!==u.stdout&&H!==u.stderr,J=z?oe:we;L.endEmitted?u.nextTick(J):U.once("end",J),H.on("unpipe",ne);function ne(me,N){n("onunpipe"),me===U&&N&&N.hasUnpiped===!1&&(N.hasUnpiped=!0,he())}function oe(){n("onend"),H.end()}var ce=x(U);H.on("drain",ce);var pe=!1;function he(){n("cleanup"),H.removeListener("close",ye),H.removeListener("finish",Ee),H.removeListener("drain",ce),H.removeListener("error",ve),H.removeListener("unpipe",ne),U.removeListener("end",oe),U.removeListener("end",we),U.removeListener("data",fe),pe=!0,L.awaitDrain&&(!H._writableState||H._writableState.needDrain)&&ce()}U.on("data",fe);function fe(me){n("ondata");var N=H.write(me);n("dest.write",N),N===!1&&((L.pipesCount===1&&L.pipes===H||L.pipesCount>1&&ue(L.pipes,H)!==-1)&&!pe&&(n("false write response, pause",L.awaitDrain),L.awaitDrain++),U.pause())}function ve(me){n("onerror",me),we(),H.removeListener("error",ve),y(H,"error")===0&&A(H,me)}ee(H,"error",ve);function ye(){H.removeListener("finish",Ee),we()}H.once("close",ye);function Ee(){n("onfinish"),H.removeListener("close",ye),we()}H.once("finish",Ee);function we(){n("unpipe"),U.unpipe(H)}return H.emit("pipe",U),L.flowing||(n("pipe resume"),U.resume()),H};function x(H){return function(){var U=H._readableState;n("pipeOnDrain",U.awaitDrain),U.awaitDrain&&U.awaitDrain--,U.awaitDrain===0&&y(H,"data")&&(U.flowing=!0,X(H))}}C.prototype.unpipe=function(H){var G=this._readableState,U={hasUnpiped:!1};if(G.pipesCount===0)return this;if(G.pipesCount===1)return H&&H!==G.pipes?this:(H||(H=G.pipes),G.pipes=null,G.pipesCount=0,G.flowing=!1,H&&H.emit("unpipe",this,U),this);if(!H){var L=G.pipes,z=G.pipesCount;G.pipes=null,G.pipesCount=0,G.flowing=!1;for(var J=0;J<z;J++)L[J].emit("unpipe",this,{hasUnpiped:!1});return this}var ne=ue(G.pipes,H);return ne===-1?this:(G.pipes.splice(ne,1),G.pipesCount-=1,G.pipesCount===1&&(G.pipes=G.pipes[0]),H.emit("unpipe",this,U),this)},C.prototype.on=function(H,G){var U=c.prototype.on.call(this,H,G),L=this._readableState;return H==="data"?(L.readableListening=this.listenerCount("readable")>0,L.flowing!==!1&&this.resume()):H==="readable"&&!L.endEmitted&&!L.readableListening&&(L.readableListening=L.needReadable=!0,L.flowing=!1,L.emittedReadable=!1,n("on readable",L.length,L.reading),L.length?R(this):L.reading||u.nextTick(te,this)),U},C.prototype.addListener=C.prototype.on,C.prototype.removeListener=function(H,G){var U=c.prototype.removeListener.call(this,H,G);return H==="readable"&&u.nextTick(Q,this),U},C.prototype.removeAllListeners=function(H){var G=c.prototype.removeAllListeners.apply(this,arguments);return(H==="readable"||H===void 0)&&u.nextTick(Q,this),G};function Q(H){var G=H._readableState;G.readableListening=H.listenerCount("readable")>0,G.resumeScheduled&&!G.paused?G.flowing=!0:H.listenerCount("data")>0&&H.resume()}function te(H){n("readable nexttick read 0"),H.read(0)}C.prototype.resume=function(){var H=this._readableState;return H.flowing||(n("resume"),H.flowing=!H.readableListening,ae(this,H)),H.paused=!1,this};function ae(H,G){G.resumeScheduled||(G.resumeScheduled=!0,u.nextTick(de,H,G))}function de(H,G){n("resume",G.reading),G.reading||H.read(0),G.resumeScheduled=!1,H.emit("resume"),X(H),G.flowing&&!G.reading&&H.read(0)}C.prototype.pause=function(){return n("call pause flowing=%j",this._readableState.flowing),this._readableState.flowing!==!1&&(n("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this};function X(H){var G=H._readableState;for(n("flow",G.flowing);G.flowing&&H.read()!==null;);}C.prototype.wrap=function(H){var G=this,U=this._readableState,L=!1;H.on("end",function(){if(n("wrapped end"),U.decoder&&!U.ended){var ne=U.decoder.end();ne&&ne.length&&G.push(ne)}G.push(null)}),H.on("data",function(ne){if(n("wrapped data"),U.decoder&&(ne=U.decoder.write(ne)),!(U.objectMode&&ne==null)&&!(!U.objectMode&&(!ne||!ne.length))){var oe=G.push(ne);oe||(L=!0,H.pause())}});for(var z in H)this[z]===void 0&&typeof H[z]=="function"&&(this[z]=function(oe){return function(){return H[oe].apply(H,arguments)}}(z));for(var J=0;J<W.length;J++)H.on(W[J],this.emit.bind(this,W[J]));return this._read=function(ne){n("wrapped _read",ne),L&&(L=!1,H.resume())},this},typeof Symbol=="function"&&(C.prototype[Symbol.asyncIterator]=function(){return w===void 0&&(w=t("./internal/streams/async_iterator")),w(this)}),Object.defineProperty(C.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(C.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(C.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(G){this._readableState&&(this._readableState.flowing=G)}}),C._fromList=$,Object.defineProperty(C.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}});function $(H,G){if(G.length===0)return null;var U;return G.objectMode?U=G.buffer.shift():!H||H>=G.length?(G.decoder?U=G.buffer.join(""):G.buffer.length===1?U=G.buffer.first():U=G.buffer.concat(G.length),G.buffer.clear()):U=G.buffer.consume(H,G.decoder),U}function K(H){var G=H._readableState;n("endReadable",G.endEmitted),G.endEmitted||(G.ended=!0,u.nextTick(re,G,H))}function re(H,G){if(n("endReadableNT",H.endEmitted,H.length),!H.endEmitted&&H.length===0&&(H.endEmitted=!0,G.readable=!1,G.emit("end"),H.autoDestroy)){var U=G._writableState;(!U||U.autoDestroy&&U.finished)&&G.destroy()}}typeof Symbol=="function"&&(C.from=function(H,G){return M===void 0&&(M=t("./internal/streams/from")),M(C,H,G)});function ue(H,G){for(var U=0,L=H.length;U<L;U++)if(H[U]===G)return U;return-1}}).call(this)}).call(this,t("_process"),typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../errors":265,"./_stream_duplex":266,"./internal/streams/async_iterator":271,"./internal/streams/buffer_list":272,"./internal/streams/destroy":273,"./internal/streams/from":275,"./internal/streams/state":277,"./internal/streams/stream":278,_process:237,buffer:68,events:105,inherits:146,"string_decoder/":279,util:20}],269:[function(t,E,e){arguments[4][54][0].apply(e,arguments)},{"../errors":265,"./_stream_duplex":266,dup:54,inherits:146}],270:[function(t,E,e){(function(u,g){(function(){E.exports=F;function S(X){var $=this;this.next=null,this.entry=null,this.finish=function(){de($,X)}}var y;F.WritableState=W;var c={deprecate:t("util-deprecate")},m=t("./internal/streams/stream"),h=t("buffer").Buffer,d=g.Uint8Array||function(){};function b(X){return h.from(X)}function a(X){return h.isBuffer(X)||X instanceof d}var n=t("./internal/streams/destroy"),i=t("./internal/streams/state"),r=i.getHighWaterMark,s=t("../errors").codes,o=s.ERR_INVALID_ARG_TYPE,l=s.ERR_METHOD_NOT_IMPLEMENTED,v=s.ERR_MULTIPLE_CALLBACK,f=s.ERR_STREAM_CANNOT_PIPE,p=s.ERR_STREAM_DESTROYED,_=s.ERR_STREAM_NULL_VALUES,T=s.ERR_STREAM_WRITE_AFTER_END,w=s.ERR_UNKNOWN_ENCODING,M=n.errorOrDestroy;t("inherits")(F,m);function A(){}function W(X,$,K){y=y||t("./_stream_duplex"),X=X||{},typeof K!="boolean"&&(K=$ instanceof y),this.objectMode=!!X.objectMode,K&&(this.objectMode=this.objectMode||!!X.writableObjectMode),this.highWaterMark=r(this,X,"writableHighWaterMark",K),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var re=X.decodeStrings===!1;this.decodeStrings=!re,this.defaultEncoding=X.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(ue){B($,ue)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=X.emitClose!==!1,this.autoDestroy=!!X.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new S(this)}W.prototype.getBuffer=function(){for(var $=this.bufferedRequest,K=[];$;)K.push($),$=$.next;return K},function(){try{Object.defineProperty(W.prototype,"buffer",{get:c.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch{}}();var ee;typeof Symbol=="function"&&Symbol.hasInstance&&typeof Function.prototype[Symbol.hasInstance]=="function"?(ee=Function.prototype[Symbol.hasInstance],Object.defineProperty(F,Symbol.hasInstance,{value:function($){return ee.call(this,$)?!0:this!==F?!1:$&&$._writableState instanceof W}})):ee=function($){return $ instanceof this};function F(X){y=y||t("./_stream_duplex");var $=this instanceof y;if(!$&&!ee.call(F,this))return new F(X);this._writableState=new W(X,this,$),this.writable=!0,X&&(typeof X.write=="function"&&(this._write=X.write),typeof X.writev=="function"&&(this._writev=X.writev),typeof X.destroy=="function"&&(this._destroy=X.destroy),typeof X.final=="function"&&(this._final=X.final)),m.call(this)}F.prototype.pipe=function(){M(this,new f)};function C(X,$){var K=new T;M(X,K),u.nextTick($,K)}function O(X,$,K,re){var ue;return K===null?ue=new _:typeof K!="string"&&!$.objectMode&&(ue=new o("chunk",["string","Buffer"],K)),ue?(M(X,ue),u.nextTick(re,ue),!1):!0}F.prototype.write=function(X,$,K){var re=this._writableState,ue=!1,H=!re.objectMode&&a(X);return H&&!h.isBuffer(X)&&(X=b(X)),typeof $=="function"&&(K=$,$=null),H?$="buffer":$||($=re.defaultEncoding),typeof K!="function"&&(K=A),re.ending?C(this,K):(H||O(this,re,X,K))&&(re.pendingcb++,ue=D(this,re,H,X,$,K)),ue},F.prototype.cork=function(){this._writableState.corked++},F.prototype.uncork=function(){var X=this._writableState;X.corked&&(X.corked--,!X.writing&&!X.corked&&!X.bufferProcessing&&X.bufferedRequest&&P(this,X))},F.prototype.setDefaultEncoding=function($){if(typeof $=="string"&&($=$.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf(($+"").toLowerCase())>-1))throw new w($);return this._writableState.defaultEncoding=$,this},Object.defineProperty(F.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}});function I(X,$,K){return!X.objectMode&&X.decodeStrings!==!1&&typeof $=="string"&&($=h.from($,K)),$}Object.defineProperty(F.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}});function D(X,$,K,re,ue,H){if(!K){var G=I($,re,ue);re!==G&&(K=!0,ue="buffer",re=G)}var U=$.objectMode?1:re.length;$.length+=U;var L=$.length<$.highWaterMark;if(L||($.needDrain=!0),$.writing||$.corked){var z=$.lastBufferedRequest;$.lastBufferedRequest={chunk:re,encoding:ue,isBuf:K,callback:H,next:null},z?z.next=$.lastBufferedRequest:$.bufferedRequest=$.lastBufferedRequest,$.bufferedRequestCount+=1}else j(X,$,!1,U,re,ue,H);return L}function j(X,$,K,re,ue,H,G){$.writelen=re,$.writecb=G,$.writing=!0,$.sync=!0,$.destroyed?$.onwrite(new p("write")):K?X._writev(ue,$.onwrite):X._write(ue,H,$.onwrite),$.sync=!1}function Y(X,$,K,re,ue){--$.pendingcb,K?(u.nextTick(ue,re),u.nextTick(te,X,$),X._writableState.errorEmitted=!0,M(X,re)):(ue(re),X._writableState.errorEmitted=!0,M(X,re),te(X,$))}function q(X){X.writing=!1,X.writecb=null,X.length-=X.writelen,X.writelen=0}function B(X,$){var K=X._writableState,re=K.sync,ue=K.writecb;if(typeof ue!="function")throw new v;if(q(K),$)Y(X,K,re,$,ue);else{var H=V(K)||X.destroyed;!H&&!K.corked&&!K.bufferProcessing&&K.bufferedRequest&&P(X,K),re?u.nextTick(R,X,K,H,ue):R(X,K,H,ue)}}function R(X,$,K,re){K||k(X,$),$.pendingcb--,re(),te(X,$)}function k(X,$){$.length===0&&$.needDrain&&($.needDrain=!1,X.emit("drain"))}function P(X,$){$.bufferProcessing=!0;var K=$.bufferedRequest;if(X._writev&&K&&K.next){var re=$.bufferedRequestCount,ue=new Array(re),H=$.corkedRequestsFree;H.entry=K;for(var G=0,U=!0;K;)ue[G]=K,K.isBuf||(U=!1),K=K.next,G+=1;ue.allBuffers=U,j(X,$,!0,$.length,ue,"",H.finish),$.pendingcb++,$.lastBufferedRequest=null,H.next?($.corkedRequestsFree=H.next,H.next=null):$.corkedRequestsFree=new S($),$.bufferedRequestCount=0}else{for(;K;){var L=K.chunk,z=K.encoding,J=K.callback,ne=$.objectMode?1:L.length;if(j(X,$,!1,ne,L,z,J),K=K.next,$.bufferedRequestCount--,$.writing)break}K===null&&($.lastBufferedRequest=null)}$.bufferedRequest=K,$.bufferProcessing=!1}F.prototype._write=function(X,$,K){K(new l("_write()"))},F.prototype._writev=null,F.prototype.end=function(X,$,K){var re=this._writableState;return typeof X=="function"?(K=X,X=null,$=null):typeof $=="function"&&(K=$,$=null),X!=null&&this.write(X,$),re.corked&&(re.corked=1,this.uncork()),re.ending||ae(this,re,K),this},Object.defineProperty(F.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function V(X){return X.ending&&X.length===0&&X.bufferedRequest===null&&!X.finished&&!X.writing}function x(X,$){X._final(function(K){$.pendingcb--,K&&M(X,K),$.prefinished=!0,X.emit("prefinish"),te(X,$)})}function Q(X,$){!$.prefinished&&!$.finalCalled&&(typeof X._final=="function"&&!$.destroyed?($.pendingcb++,$.finalCalled=!0,u.nextTick(x,X,$)):($.prefinished=!0,X.emit("prefinish")))}function te(X,$){var K=V($);if(K&&(Q(X,$),$.pendingcb===0&&($.finished=!0,X.emit("finish"),$.autoDestroy))){var re=X._readableState;(!re||re.autoDestroy&&re.endEmitted)&&X.destroy()}return K}function ae(X,$,K){$.ending=!0,te(X,$),K&&($.finished?u.nextTick(K):X.once("finish",K)),$.ended=!0,X.writable=!1}function de(X,$,K){var re=X.entry;for(X.entry=null;re;){var ue=re.callback;$.pendingcb--,ue(K),re=re.next}$.corkedRequestsFree.next=X}Object.defineProperty(F.prototype,"destroyed",{enumerable:!1,get:function(){return this._writableState===void 0?!1:this._writableState.destroyed},set:function($){this._writableState&&(this._writableState.destroyed=$)}}),F.prototype.destroy=n.destroy,F.prototype._undestroy=n.undestroy,F.prototype._destroy=function(X,$){$(X)}}).call(this)}).call(this,t("_process"),typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../errors":265,"./_stream_duplex":266,"./internal/streams/destroy":273,"./internal/streams/state":277,"./internal/streams/stream":278,_process:237,buffer:68,inherits:146,"util-deprecate":283}],271:[function(t,E,e){(function(u){(function(){var g;function S(p,_,T){return _ in p?Object.defineProperty(p,_,{value:T,enumerable:!0,configurable:!0,writable:!0}):p[_]=T,p}var y=t("./end-of-stream"),c=Symbol("lastResolve"),m=Symbol("lastReject"),h=Symbol("error"),d=Symbol("ended"),b=Symbol("lastPromise"),a=Symbol("handlePromise"),n=Symbol("stream");function i(p,_){return{value:p,done:_}}function r(p){var _=p[c];if(_!==null){var T=p[n].read();T!==null&&(p[b]=null,p[c]=null,p[m]=null,_(i(T,!1)))}}function s(p){u.nextTick(r,p)}function o(p,_){return function(T,w){p.then(function(){if(_[d]){T(i(void 0,!0));return}_[a](T,w)},w)}}var l=Object.getPrototypeOf(function(){}),v=Object.setPrototypeOf((g={get stream(){return this[n]},next:function(){var _=this,T=this[h];if(T!==null)return Promise.reject(T);if(this[d])return Promise.resolve(i(void 0,!0));if(this[n].destroyed)return new Promise(function(W,ee){u.nextTick(function(){_[h]?ee(_[h]):W(i(void 0,!0))})});var w=this[b],M;if(w)M=new Promise(o(w,this));else{var A=this[n].read();if(A!==null)return Promise.resolve(i(A,!1));M=new Promise(this[a])}return this[b]=M,M}},S(g,Symbol.asyncIterator,function(){return this}),S(g,"return",function(){var _=this;return new Promise(function(T,w){_[n].destroy(null,function(M){if(M){w(M);return}T(i(void 0,!0))})})}),g),l),f=function(_){var T,w=Object.create(v,(T={},S(T,n,{value:_,writable:!0}),S(T,c,{value:null,writable:!0}),S(T,m,{value:null,writable:!0}),S(T,h,{value:null,writable:!0}),S(T,d,{value:_._readableState.endEmitted,writable:!0}),S(T,a,{value:function(A,W){var ee=w[n].read();ee?(w[b]=null,w[c]=null,w[m]=null,A(i(ee,!1))):(w[c]=A,w[m]=W)},writable:!0}),T));return w[b]=null,y(_,function(M){if(M&&M.code!=="ERR_STREAM_PREMATURE_CLOSE"){var A=w[m];A!==null&&(w[b]=null,w[c]=null,w[m]=null,A(M)),w[h]=M;return}var W=w[c];W!==null&&(w[b]=null,w[c]=null,w[m]=null,W(i(void 0,!0))),w[d]=!0}),_.on("readable",s.bind(null,w)),w};E.exports=f}).call(this)}).call(this,t("_process"))},{"./end-of-stream":274,_process:237}],272:[function(t,E,e){arguments[4][57][0].apply(e,arguments)},{buffer:68,dup:57,util:20}],273:[function(t,E,e){(function(u){(function(){function g(d,b){var a=this,n=this._readableState&&this._readableState.destroyed,i=this._writableState&&this._writableState.destroyed;return n||i?(b?b(d):d&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,u.nextTick(m,this,d)):u.nextTick(m,this,d)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(d||null,function(r){!b&&r?a._writableState?a._writableState.errorEmitted?u.nextTick(y,a):(a._writableState.errorEmitted=!0,u.nextTick(S,a,r)):u.nextTick(S,a,r):b?(u.nextTick(y,a),b(r)):u.nextTick(y,a)}),this)}function S(d,b){m(d,b),y(d)}function y(d){d._writableState&&!d._writableState.emitClose||d._readableState&&!d._readableState.emitClose||d.emit("close")}function c(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function m(d,b){d.emit("error",b)}function h(d,b){var a=d._readableState,n=d._writableState;a&&a.autoDestroy||n&&n.autoDestroy?d.destroy(b):d.emit("error",b)}E.exports={destroy:g,undestroy:c,errorOrDestroy:h}}).call(this)}).call(this,t("_process"))},{_process:237}],274:[function(t,E,e){arguments[4][59][0].apply(e,arguments)},{"../../../errors":265,dup:59}],275:[function(t,E,e){arguments[4][60][0].apply(e,arguments)},{dup:60}],276:[function(t,E,e){arguments[4][61][0].apply(e,arguments)},{"../../../errors":265,"./end-of-stream":274,dup:61}],277:[function(t,E,e){arguments[4][62][0].apply(e,arguments)},{"../../../errors":265,dup:62}],278:[function(t,E,e){arguments[4][63][0].apply(e,arguments)},{dup:63,events:105}],279:[function(t,E,e){var u=t("safe-buffer").Buffer,g=u.isEncoding||function(f){switch(f=""+f,f&&f.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function S(f){if(!f)return"utf8";for(var p;;)switch(f){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return f;default:if(p)return;f=(""+f).toLowerCase(),p=!0}}function y(f){var p=S(f);if(typeof p!="string"&&(u.isEncoding===g||!g(f)))throw new Error("Unknown encoding: "+f);return p||f}e.StringDecoder=c;function c(f){this.encoding=y(f);var p;switch(this.encoding){case"utf16le":this.text=i,this.end=r,p=4;break;case"utf8":this.fillLast=b,p=4;break;case"base64":this.text=s,this.end=o,p=3;break;default:this.write=l,this.end=v;return}this.lastNeed=0,this.lastTotal=0,this.lastChar=u.allocUnsafe(p)}c.prototype.write=function(f){if(f.length===0)return"";var p,_;if(this.lastNeed){if(p=this.fillLast(f),p===void 0)return"";_=this.lastNeed,this.lastNeed=0}else _=0;return _<f.length?p?p+this.text(f,_):this.text(f,_):p||""},c.prototype.end=n,c.prototype.text=a,c.prototype.fillLast=function(f){if(this.lastNeed<=f.length)return f.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);f.copy(this.lastChar,this.lastTotal-this.lastNeed,0,f.length),this.lastNeed-=f.length};function m(f){return f<=127?0:f>>5===6?2:f>>4===14?3:f>>3===30?4:f>>6===2?-1:-2}function h(f,p,_){var T=p.length-1;if(T<_)return 0;var w=m(p[T]);return w>=0?(w>0&&(f.lastNeed=w-1),w):--T<_||w===-2?0:(w=m(p[T]),w>=0?(w>0&&(f.lastNeed=w-2),w):--T<_||w===-2?0:(w=m(p[T]),w>=0?(w>0&&(w===2?w=0:f.lastNeed=w-3),w):0))}function d(f,p,_){if((p[0]&192)!==128)return f.lastNeed=0,"";if(f.lastNeed>1&&p.length>1){if((p[1]&192)!==128)return f.lastNeed=1,"";if(f.lastNeed>2&&p.length>2&&(p[2]&192)!==128)return f.lastNeed=2,""}}function b(f){var p=this.lastTotal-this.lastNeed,_=d(this,f);if(_!==void 0)return _;if(this.lastNeed<=f.length)return f.copy(this.lastChar,p,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);f.copy(this.lastChar,p,0,f.length),this.lastNeed-=f.length}function a(f,p){var _=h(this,f,p);if(!this.lastNeed)return f.toString("utf8",p);this.lastTotal=_;var T=f.length-(_-this.lastNeed);return f.copy(this.lastChar,0,T),f.toString("utf8",p,T)}function n(f){var p=f&&f.length?this.write(f):"";return this.lastNeed?p+"":p}function i(f,p){if((f.length-p)%2===0){var _=f.toString("utf16le",p);if(_){var T=_.charCodeAt(_.length-1);if(T>=55296&&T<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=f[f.length-2],this.lastChar[1]=f[f.length-1],_.slice(0,-1)}return _}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=f[f.length-1],f.toString("utf16le",p,f.length-1)}function r(f){var p=f&&f.length?this.write(f):"";if(this.lastNeed){var _=this.lastTotal-this.lastNeed;return p+this.lastChar.toString("utf16le",0,_)}return p}function s(f,p){var _=(f.length-p)%3;return _===0?f.toString("base64",p):(this.lastNeed=3-_,this.lastTotal=3,_===1?this.lastChar[0]=f[f.length-1]:(this.lastChar[0]=f[f.length-2],this.lastChar[1]=f[f.length-1]),f.toString("base64",p,f.length-_))}function o(f){var p=f&&f.length?this.write(f):"";return this.lastNeed?p+this.lastChar.toString("base64",0,3-this.lastNeed):p}function l(f){return f.toString(this.encoding)}function v(f){return f&&f.length?this.write(f):""}},{"safe-buffer":250}],280:[function(t,E,e){(function(u,g){(function(){var S=t("process/browser.js").nextTick,y=Function.prototype.apply,c=Array.prototype.slice,m={},h=0;e.setTimeout=function(){return new d(y.call(setTimeout,window,arguments),clearTimeout)},e.setInterval=function(){return new d(y.call(setInterval,window,arguments),clearInterval)},e.clearTimeout=e.clearInterval=function(b){b.close()};function d(b,a){this._id=b,this._clearFn=a}d.prototype.unref=d.prototype.ref=function(){},d.prototype.close=function(){this._clearFn.call(window,this._id)},e.enroll=function(b,a){clearTimeout(b._idleTimeoutId),b._idleTimeout=a},e.unenroll=function(b){clearTimeout(b._idleTimeoutId),b._idleTimeout=-1},e._unrefActive=e.active=function(b){clearTimeout(b._idleTimeoutId);var a=b._idleTimeout;a>=0&&(b._idleTimeoutId=setTimeout(function(){b._onTimeout&&b._onTimeout()},a))},e.setImmediate=typeof u=="function"?u:function(b){var a=h++,n=arguments.length<2?!1:c.call(arguments,1);return m[a]=!0,S(function(){m[a]&&(n?b.apply(null,n):b.call(null),e.clearImmediate(a))}),a},e.clearImmediate=typeof g=="function"?g:function(b){delete m[b]}}).call(this)}).call(this,t("timers").setImmediate,t("timers").clearImmediate)},{"process/browser.js":237,timers:280}],281:[function(t,E,e){E.exports={0:"O",1:"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\u2028":" ","\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":",:":","":":","":"::=","":":","":"!",:"!","":"!","":"!!","":"!?",:"?","":"?","":"?",:"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"<","":">",:">",:">",:"4",:"b",:"b",:"d",:"J",:"L",:"P",:"U",:"V",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","`":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'",:"'",:"'",:"'",:"'","":"'",:"'","":"'","":"'",:"'",:"'","":"'","":"'","":"''",'"':"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''",:"''",:"''","":"'''","":"'''","":"''''",:"'B",:"'D",:"'n",:"'P",:"'T",:"'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"/","":"/",:"/",:"/","":"/","":"/","":"//","":"///","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\",:"\\","":"\\","":"\\\\","":"\\\\","":"\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<",:"<",:"<","":"<","":"<",:"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">",:">","":">",:">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"$","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2",:"2",:"2","":"2",:"2","":"2","":"","":"","":"","":"","":"","":"",:"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3",:"3",:"3","":"3","":"3",:"3",:"3","":"3","":"3","":"","":"","":"","":"",:"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4",:"4","":"4","":"","":"","":"","":"4,","":"4.",:"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5",:"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6",:"6",:"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8",:"8",:"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a",:"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a",:"a",:"a","":"a","":"a","":"a","":"a","":"a",:"a","":"",:"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A",:"A","":"A","":"A","":"A","":"A","":"A",:"A",:"A",:"A","":"A","":"A","":"A","":"a",:"",:"",:"",:"",:"","":"a/c","":"a/s","":"aa","":"AA",:"ae",:"ae",:"AE",:"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"",:"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b",:"b",:"b",:"b",:"b",:"b",:"B",:"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B",:"B","":"B","":"B","":"B","":"B","":"B",:"B",:"B",:"B","":"B","":"B","":"B","":"B",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b'",:"bl",:"","":"",:"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c",:"c","":"c",:"c","":"c","":"c","":"","":"C","":"C","":"C",:"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"C",:"c",:"c",:"C",:"C",:"C'","":"c/o","":"c/u","":"	","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d",:"d",:"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D",:"D",:"D",:"D","":"D",:"d",:"d",:"d",:"d",:"D",:"D",:"D","":"d","":"",:"d",:"d'",:"d",:"dz",:"dz",:"Dz",:"DZ",:"d",:"D",:"D",:"d","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"e",:"e",:"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e",:"e",:"e","":"","":"E",:"E",:"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E",:"E","":"E","":"E","":"E","":"E",:"",:"","":"e","":"E",:"e","":"",:"",:"","":"","":"","":"",:"","":"o","":"o","":"o",:"","":"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f",:"f","":"f",:"f","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F",:"F","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F",:"f",:"F","":"f","":"FAX",:"ff",:"ffi",:"ffl",:"fi",:"fl",:"f",:"","":"","":"",:"",:"g",:"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g",:"g","":"g",:"g",:"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G",:"G",:"G","":"G","":"",:"g",:"",:"",:"",:"g",:"G",:"G'","":"","":"","":"",:"h",:"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h",:"h",:"h",:"h",:"H",:"H",:"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H",:"H",:"H","":"H","":"H","":"",:"h","":"h",:"h","":"H",:"H",:"h",:"h",:"h",:"H","":"H",:"H",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"i","":"i",:"i","":"i",:"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i",:"i",:"i",:"i",:"i",:"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i","":"i","":"i",:"i","":"i","":"","":"i",:"",:"",:"i","":"i","":"i","":"ii","":"iii",:"ij","":"iv","":"ix",:"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j",:"j",:"j",:"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J",:"J",:"J",:"J","":"J","":"j","":"J",:"J","":"",:"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k",:"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K",:"K",:"K","":"K","":"K",:"k","":"K",:"K","":"K","":"K",:"K",:"K'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",I:"l",:"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l",:"l",:"l",:"l","":"l","":"l",:"l",:"l","":"l","":"l",:"l","":"l","":"l","":"l","":"l","":"L","":"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L",:"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L",:"l",:"l",:"l",:"L",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l","":"l,","":"l.",:"l'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9",:"lj",:"lJ",:"Lj",:"LJ","":"ll","":"ll","":"ll",:"ll",:"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll",:"lO","":"lO.","":"lO","":"lO","":"lO",:"ls","":"lt","":"lV","":"lX",:"l",:"lz",:"l",:"l",:"l",:"l",:"l",:"l",:"lo","":"l","":"l","":"l","":"","":"","":"",:"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M",:"M",:"M",:"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n",:"n",:"n",:"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"n",:"n",:"n","":"n","":"n","":"n","":"n","":"n",:"N","":"n",:"nj",:"Nj",:"NJ","":"No","":"",:"","":"",:"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o",:"o",:"o",:"o","":"o","":"o","":"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"",:"",:"","":"o",:"",:"o","":"o",:"O","":"O",:"O",:"o","":"o",:"o",:"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"o",:"o","":"O,","":"O.",:"o'",:"O'",:"O'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"oe",:"OE",:"o","":"oo","":"oo","":"oo","":"OO","":"OO",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"oo",:"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P",:"P",:"P","":"P","":"P",:"p","":"p",:"p",:"P'","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q",:"q",:"q",:"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q",:"q","":"QE","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r",:"r","":"r","":"R",:"R",:"R",:"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R",:"R",:"R",:"R","":"R",:"R","":"R","":"R",:"r",:"r","":"r",:"r","":"r",:"r'","":"rn",m:"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn",:"rn","":"rn","":"Rs","":"","":"",:"","":"","":"",:"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s",:"s",:"s","":"s","":"s","":"s",:"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S",:"S",:"S",:"S",:"S","":"S","":"S","":"S","":"S",:"s","":"s","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"sss",:"st","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"t","":"T","":"T",:"",:"T",:"T","":"T",:"t",:"T","":"t",:"","":"T3",:"t","":"TEL","":"tf",:"ts",:"t","":"t",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u",:"u",:"u","":"u","":"u","":"u","":"u","":"u",:"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U",:"U",:"U","":"U",:"U","":"U","":"U","":"U",:"",:"","":"u","":"u","":"U",:"U",:"U",:"U'","":"ue","":"uo",:"",:"",:"","":"",:"",:"","":"","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v",:"v",:"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"V",:"V",:"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w",:"w","":"w",:"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W",:"W",:"W","":"W",:"w","":"w","":"W","":"w","":"",:"","":"","":"","":"x","":"x","":"x","":"x","":"x",:"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x",:"x",:"x",:"x","":"","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"x",:"X","":"X","":"xi","":"xii","":"Xl","":"Xll",:"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y","":"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y",:"y",:"y","":"y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y",:"y","":"y",:"y","":"Y","":"Y",:"Y",:"","":"","":"",:"",:"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z",:"Z",:"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z",:"z",:"z",:"Z",:"z",:"Z","":"z",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"i","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"",:"",:"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"l","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"",:"",:"'",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"l","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo o ",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"l",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"l",:"l",:"l",:"l",:"l",:"l",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"l",:"l",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"","":"",:"",:"'","":"/","":"",:"","":"","":"",:"",:"'",:"",:"",:"'",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"<",:"b",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"b",:"b",:"d",:"P",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"J",:"",:"",:"",:"",:"",:"",:"",:"J",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"",:"","":"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":""}},{}],282:[function(t,E,e){var u=t("./data.json");function g(m){return m.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var S=RegExp(Object.keys(u).map(g).join("|"),"g");function y(m){return u[m]}function c(m){return m.replace(S,y)}E.exports=c},{"./data.json":281}],283:[function(t,E,e){(function(u){(function(){E.exports=g;function g(y,c){if(S("noDeprecation"))return y;var m=!1;function h(){if(!m){if(S("throwDeprecation"))throw new Error(c);S("traceDeprecation")?console.trace(c):console.warn(c),m=!0}return y.apply(this,arguments)}return h}function S(y){try{if(!u.localStorage)return!1}catch{return!1}var c=u.localStorage[y];return c==null?!1:String(c).toLowerCase()==="true"}}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{}],284:[function(t,E,e){E.exports=function(g){return g&&typeof g=="object"&&typeof g.copy=="function"&&typeof g.fill=="function"&&typeof g.readUInt8=="function"}},{}],285:[function(t,E,e){var u=t("is-arguments"),g=t("is-generator-function"),S=t("which-typed-array"),y=t("is-typed-array");function c(J){return J.call.bind(J)}var m=typeof BigInt<"u",h=typeof Symbol<"u",d=c(Object.prototype.toString),b=c(Number.prototype.valueOf),a=c(String.prototype.valueOf),n=c(Boolean.prototype.valueOf);if(m)var i=c(BigInt.prototype.valueOf);if(h)var r=c(Symbol.prototype.valueOf);function s(J,ne){if(typeof J!="object")return!1;try{return ne(J),!0}catch{return!1}}e.isArgumentsObject=u,e.isGeneratorFunction=g,e.isTypedArray=y;function o(J){return typeof Promise<"u"&&J instanceof Promise||J!==null&&typeof J=="object"&&typeof J.then=="function"&&typeof J.catch=="function"}e.isPromise=o;function l(J){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(J):y(J)||V(J)}e.isArrayBufferView=l;function v(J){return S(J)==="Uint8Array"}e.isUint8Array=v;function f(J){return S(J)==="Uint8ClampedArray"}e.isUint8ClampedArray=f;function p(J){return S(J)==="Uint16Array"}e.isUint16Array=p;function _(J){return S(J)==="Uint32Array"}e.isUint32Array=_;function T(J){return S(J)==="Int8Array"}e.isInt8Array=T;function w(J){return S(J)==="Int16Array"}e.isInt16Array=w;function M(J){return S(J)==="Int32Array"}e.isInt32Array=M;function A(J){return S(J)==="Float32Array"}e.isFloat32Array=A;function W(J){return S(J)==="Float64Array"}e.isFloat64Array=W;function ee(J){return S(J)==="BigInt64Array"}e.isBigInt64Array=ee;function F(J){return S(J)==="BigUint64Array"}e.isBigUint64Array=F;function C(J){return d(J)==="[object Map]"}C.working=typeof Map<"u"&&C(new Map);function O(J){return typeof Map>"u"?!1:C.working?C(J):J instanceof Map}e.isMap=O;function I(J){return d(J)==="[object Set]"}I.working=typeof Set<"u"&&I(new Set);function D(J){return typeof Set>"u"?!1:I.working?I(J):J instanceof Set}e.isSet=D;function j(J){return d(J)==="[object WeakMap]"}j.working=typeof WeakMap<"u"&&j(new WeakMap);function Y(J){return typeof WeakMap>"u"?!1:j.working?j(J):J instanceof WeakMap}e.isWeakMap=Y;function q(J){return d(J)==="[object WeakSet]"}q.working=typeof WeakSet<"u"&&q(new WeakSet);function B(J){return q(J)}e.isWeakSet=B;function R(J){return d(J)==="[object ArrayBuffer]"}R.working=typeof ArrayBuffer<"u"&&R(new ArrayBuffer);function k(J){return typeof ArrayBuffer>"u"?!1:R.working?R(J):J instanceof ArrayBuffer}e.isArrayBuffer=k;function P(J){return d(J)==="[object DataView]"}P.working=typeof ArrayBuffer<"u"&&typeof DataView<"u"&&P(new DataView(new ArrayBuffer(1),0,1));function V(J){return typeof DataView>"u"?!1:P.working?P(J):J instanceof DataView}e.isDataView=V;var x=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:void 0;function Q(J){return d(J)==="[object SharedArrayBuffer]"}function te(J){return typeof x>"u"?!1:(typeof Q.working>"u"&&(Q.working=Q(new x)),Q.working?Q(J):J instanceof x)}e.isSharedArrayBuffer=te;function ae(J){return d(J)==="[object AsyncFunction]"}e.isAsyncFunction=ae;function de(J){return d(J)==="[object Map Iterator]"}e.isMapIterator=de;function X(J){return d(J)==="[object Set Iterator]"}e.isSetIterator=X;function $(J){return d(J)==="[object Generator]"}e.isGeneratorObject=$;function K(J){return d(J)==="[object WebAssembly.Module]"}e.isWebAssemblyCompiledModule=K;function re(J){return s(J,b)}e.isNumberObject=re;function ue(J){return s(J,a)}e.isStringObject=ue;function H(J){return s(J,n)}e.isBooleanObject=H;function G(J){return m&&s(J,i)}e.isBigIntObject=G;function U(J){return h&&s(J,r)}e.isSymbolObject=U;function L(J){return re(J)||ue(J)||H(J)||G(J)||U(J)}e.isBoxedPrimitive=L;function z(J){return typeof Uint8Array<"u"&&(k(J)||te(J))}e.isAnyArrayBuffer=z,["isProxy","isExternal","isModuleNamespaceObject"].forEach(function(J){Object.defineProperty(e,J,{enumerable:!1,value:function(){throw new Error(J+" is not supported in userland")}})})},{"is-arguments":147,"is-generator-function":149,"is-typed-array":150,"which-typed-array":303}],286:[function(t,E,e){(function(u){(function(){var g=Object.getOwnPropertyDescriptors||function(x){for(var Q=Object.keys(x),te={},ae=0;ae<Q.length;ae++)te[Q[ae]]=Object.getOwnPropertyDescriptor(x,Q[ae]);return te},S=/%[sdj%]/g;e.format=function(V){if(!w(V)){for(var x=[],Q=0;Q<arguments.length;Q++)x.push(h(arguments[Q]));return x.join(" ")}for(var Q=1,te=arguments,ae=te.length,de=String(V).replace(S,function($){if($==="%%")return"%";if(Q>=ae)return $;switch($){case"%s":return String(te[Q++]);case"%d":return Number(te[Q++]);case"%j":try{return JSON.stringify(te[Q++])}catch{return"[Circular]"}default:return $}}),X=te[Q];Q<ae;X=te[++Q])p(X)||!ee(X)?de+=" "+X:de+=" "+h(X);return de},e.deprecate=function(V,x){if(typeof u<"u"&&u.noDeprecation===!0)return V;if(typeof u>"u")return function(){return e.deprecate(V,x).apply(this,arguments)};var Q=!1;function te(){if(!Q){if(u.throwDeprecation)throw new Error(x);u.traceDeprecation?console.trace(x):console.error(x),Q=!0}return V.apply(this,arguments)}return te};var y={},c=/^$/;if({}.NODE_DEBUG){var m={}.NODE_DEBUG;m=m.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),c=new RegExp("^"+m+"$","i")}e.debuglog=function(V){if(V=V.toUpperCase(),!y[V])if(c.test(V)){var x=u.pid;y[V]=function(){var Q=e.format.apply(e,arguments);console.error("%s %d: %s",V,x,Q)}}else y[V]=function(){};return y[V]};function h(V,x){var Q={seen:[],stylize:b};return arguments.length>=3&&(Q.depth=arguments[2]),arguments.length>=4&&(Q.colors=arguments[3]),f(x)?Q.showHidden=x:x&&e._extend(Q,x),A(Q.showHidden)&&(Q.showHidden=!1),A(Q.depth)&&(Q.depth=2),A(Q.colors)&&(Q.colors=!1),A(Q.customInspect)&&(Q.customInspect=!0),Q.colors&&(Q.stylize=d),n(Q,V,Q.depth)}e.inspect=h,h.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},h.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};function d(V,x){var Q=h.styles[x];return Q?"\x1B["+h.colors[Q][0]+"m"+V+"\x1B["+h.colors[Q][1]+"m":V}function b(V,x){return V}function a(V){var x={};return V.forEach(function(Q,te){x[Q]=!0}),x}function n(V,x,Q){if(V.customInspect&&x&&O(x.inspect)&&x.inspect!==e.inspect&&!(x.constructor&&x.constructor.prototype===x)){var te=x.inspect(Q,V);return w(te)||(te=n(V,te,Q)),te}var ae=i(V,x);if(ae)return ae;var de=Object.keys(x),X=a(de);if(V.showHidden&&(de=Object.getOwnPropertyNames(x)),C(x)&&(de.indexOf("message")>=0||de.indexOf("description")>=0))return r(x);if(de.length===0){if(O(x)){var $=x.name?": "+x.name:"";return V.stylize("[Function"+$+"]","special")}if(W(x))return V.stylize(RegExp.prototype.toString.call(x),"regexp");if(F(x))return V.stylize(Date.prototype.toString.call(x),"date");if(C(x))return r(x)}var K="",re=!1,ue=["{","}"];if(v(x)&&(re=!0,ue=["[","]"]),O(x)){var H=x.name?": "+x.name:"";K=" [Function"+H+"]"}if(W(x)&&(K=" "+RegExp.prototype.toString.call(x)),F(x)&&(K=" "+Date.prototype.toUTCString.call(x)),C(x)&&(K=" "+r(x)),de.length===0&&(!re||x.length==0))return ue[0]+K+ue[1];if(Q<0)return W(x)?V.stylize(RegExp.prototype.toString.call(x),"regexp"):V.stylize("[Object]","special");V.seen.push(x);var G;return re?G=s(V,x,Q,X,de):G=de.map(function(U){return o(V,x,Q,X,U,re)}),V.seen.pop(),l(G,K,ue)}function i(V,x){if(A(x))return V.stylize("undefined","undefined");if(w(x)){var Q="'"+JSON.stringify(x).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return V.stylize(Q,"string")}if(T(x))return V.stylize(""+x,"number");if(f(x))return V.stylize(""+x,"boolean");if(p(x))return V.stylize("null","null")}function r(V){return"["+Error.prototype.toString.call(V)+"]"}function s(V,x,Q,te,ae){for(var de=[],X=0,$=x.length;X<$;++X)B(x,String(X))?de.push(o(V,x,Q,te,String(X),!0)):de.push("");return ae.forEach(function(K){K.match(/^\d+$/)||de.push(o(V,x,Q,te,K,!0))}),de}function o(V,x,Q,te,ae,de){var X,$,K;if(K=Object.getOwnPropertyDescriptor(x,ae)||{value:x[ae]},K.get?K.set?$=V.stylize("[Getter/Setter]","special"):$=V.stylize("[Getter]","special"):K.set&&($=V.stylize("[Setter]","special")),B(te,ae)||(X="["+ae+"]"),$||(V.seen.indexOf(K.value)<0?(p(Q)?$=n(V,K.value,null):$=n(V,K.value,Q-1),$.indexOf(`
`)>-1&&(de?$=$.split(`
`).map(function(re){return"  "+re}).join(`
`).slice(2):$=`
`+$.split(`
`).map(function(re){return"   "+re}).join(`
`))):$=V.stylize("[Circular]","special")),A(X)){if(de&&ae.match(/^\d+$/))return $;X=JSON.stringify(""+ae),X.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(X=X.slice(1,-1),X=V.stylize(X,"name")):(X=X.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),X=V.stylize(X,"string"))}return X+": "+$}function l(V,x,Q){var te=V.reduce(function(ae,de){return de.indexOf(`
`)>=0,ae+de.replace(/\u001b\[\d\d?m/g,"").length+1},0);return te>60?Q[0]+(x===""?"":x+`
 `)+" "+V.join(`,
  `)+" "+Q[1]:Q[0]+x+" "+V.join(", ")+" "+Q[1]}e.types=t("./support/types");function v(V){return Array.isArray(V)}e.isArray=v;function f(V){return typeof V=="boolean"}e.isBoolean=f;function p(V){return V===null}e.isNull=p;function _(V){return V==null}e.isNullOrUndefined=_;function T(V){return typeof V=="number"}e.isNumber=T;function w(V){return typeof V=="string"}e.isString=w;function M(V){return typeof V=="symbol"}e.isSymbol=M;function A(V){return V===void 0}e.isUndefined=A;function W(V){return ee(V)&&D(V)==="[object RegExp]"}e.isRegExp=W,e.types.isRegExp=W;function ee(V){return typeof V=="object"&&V!==null}e.isObject=ee;function F(V){return ee(V)&&D(V)==="[object Date]"}e.isDate=F,e.types.isDate=F;function C(V){return ee(V)&&(D(V)==="[object Error]"||V instanceof Error)}e.isError=C,e.types.isNativeError=C;function O(V){return typeof V=="function"}e.isFunction=O;function I(V){return V===null||typeof V=="boolean"||typeof V=="number"||typeof V=="string"||typeof V=="symbol"||typeof V>"u"}e.isPrimitive=I,e.isBuffer=t("./support/isBuffer");function D(V){return Object.prototype.toString.call(V)}function j(V){return V<10?"0"+V.toString(10):V.toString(10)}var Y=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function q(){var V=new Date,x=[j(V.getHours()),j(V.getMinutes()),j(V.getSeconds())].join(":");return[V.getDate(),Y[V.getMonth()],x].join(" ")}e.log=function(){console.log("%s - %s",q(),e.format.apply(e,arguments))},e.inherits=t("inherits"),e._extend=function(V,x){if(!x||!ee(x))return V;for(var Q=Object.keys(x),te=Q.length;te--;)V[Q[te]]=x[Q[te]];return V};function B(V,x){return Object.prototype.hasOwnProperty.call(V,x)}var R=typeof Symbol<"u"?Symbol("util.promisify.custom"):void 0;e.promisify=function(x){if(typeof x!="function")throw new TypeError('The "original" argument must be of type Function');if(R&&x[R]){var Q=x[R];if(typeof Q!="function")throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(Q,R,{value:Q,enumerable:!1,writable:!1,configurable:!0}),Q}function Q(){for(var te,ae,de=new Promise(function(K,re){te=K,ae=re}),X=[],$=0;$<arguments.length;$++)X.push(arguments[$]);X.push(function(K,re){K?ae(K):te(re)});try{x.apply(this,X)}catch(K){ae(K)}return de}return Object.setPrototypeOf(Q,Object.getPrototypeOf(x)),R&&Object.defineProperty(Q,R,{value:Q,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(Q,g(x))},e.promisify.custom=R;function k(V,x){if(!V){var Q=new Error("Promise was rejected with a falsy value");Q.reason=V,V=Q}return x(V)}function P(V){if(typeof V!="function")throw new TypeError('The "original" argument must be of type Function');function x(){for(var Q=[],te=0;te<arguments.length;te++)Q.push(arguments[te]);var ae=Q.pop();if(typeof ae!="function")throw new TypeError("The last argument must be of type Function");var de=this,X=function(){return ae.apply(de,arguments)};V.apply(this,Q).then(function($){u.nextTick(X.bind(null,null,$))},function($){u.nextTick(k.bind(null,$,X))})}return Object.setPrototypeOf(x,Object.getPrototypeOf(V)),Object.defineProperties(x,g(V)),x}e.callbackify=P}).call(this)}).call(this,t("_process"))},{"./support/isBuffer":284,"./support/types":285,_process:237,inherits:146}],287:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),Object.defineProperty(e,"NIL",{enumerable:!0,get:function(){return c.default}}),Object.defineProperty(e,"parse",{enumerable:!0,get:function(){return b.default}}),Object.defineProperty(e,"stringify",{enumerable:!0,get:function(){return d.default}}),Object.defineProperty(e,"v1",{enumerable:!0,get:function(){return u.default}}),Object.defineProperty(e,"v3",{enumerable:!0,get:function(){return g.default}}),Object.defineProperty(e,"v4",{enumerable:!0,get:function(){return S.default}}),Object.defineProperty(e,"v5",{enumerable:!0,get:function(){return y.default}}),Object.defineProperty(e,"validate",{enumerable:!0,get:function(){return h.default}}),Object.defineProperty(e,"version",{enumerable:!0,get:function(){return m.default}});var u=a(t("./v1.js")),g=a(t("./v3.js")),S=a(t("./v4.js")),y=a(t("./v5.js")),c=a(t("./nil.js")),m=a(t("./version.js")),h=a(t("./validate.js")),d=a(t("./stringify.js")),b=a(t("./parse.js"));function a(n){return n&&n.__esModule?n:{default:n}}},{"./nil.js":290,"./parse.js":291,"./stringify.js":295,"./v1.js":296,"./v3.js":297,"./v4.js":299,"./v5.js":300,"./validate.js":301,"./version.js":302}],288:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;function u(s){if(typeof s=="string"){const o=unescape(encodeURIComponent(s));s=new Uint8Array(o.length);for(let l=0;l<o.length;++l)s[l]=o.charCodeAt(l)}return g(y(c(s),s.length*8))}function g(s){const o=[],l=s.length*32,v="0123456789abcdef";for(let f=0;f<l;f+=8){const p=s[f>>5]>>>f%32&255,_=parseInt(v.charAt(p>>>4&15)+v.charAt(p&15),16);o.push(_)}return o}function S(s){return(s+64>>>9<<4)+14+1}function y(s,o){s[o>>5]|=128<<o%32,s[S(o)-1]=o;let l=1732584193,v=-271733879,f=-1732584194,p=271733878;for(let _=0;_<s.length;_+=16){const T=l,w=v,M=f,A=p;l=b(l,v,f,p,s[_],7,-680876936),p=b(p,l,v,f,s[_+1],12,-389564586),f=b(f,p,l,v,s[_+2],17,606105819),v=b(v,f,p,l,s[_+3],22,-1044525330),l=b(l,v,f,p,s[_+4],7,-176418897),p=b(p,l,v,f,s[_+5],12,1200080426),f=b(f,p,l,v,s[_+6],17,-1473231341),v=b(v,f,p,l,s[_+7],22,-45705983),l=b(l,v,f,p,s[_+8],7,1770035416),p=b(p,l,v,f,s[_+9],12,-1958414417),f=b(f,p,l,v,s[_+10],17,-42063),v=b(v,f,p,l,s[_+11],22,-1990404162),l=b(l,v,f,p,s[_+12],7,1804603682),p=b(p,l,v,f,s[_+13],12,-40341101),f=b(f,p,l,v,s[_+14],17,-1502002290),v=b(v,f,p,l,s[_+15],22,1236535329),l=a(l,v,f,p,s[_+1],5,-165796510),p=a(p,l,v,f,s[_+6],9,-1069501632),f=a(f,p,l,v,s[_+11],14,643717713),v=a(v,f,p,l,s[_],20,-373897302),l=a(l,v,f,p,s[_+5],5,-701558691),p=a(p,l,v,f,s[_+10],9,38016083),f=a(f,p,l,v,s[_+15],14,-660478335),v=a(v,f,p,l,s[_+4],20,-405537848),l=a(l,v,f,p,s[_+9],5,568446438),p=a(p,l,v,f,s[_+14],9,-1019803690),f=a(f,p,l,v,s[_+3],14,-187363961),v=a(v,f,p,l,s[_+8],20,1163531501),l=a(l,v,f,p,s[_+13],5,-1444681467),p=a(p,l,v,f,s[_+2],9,-51403784),f=a(f,p,l,v,s[_+7],14,1735328473),v=a(v,f,p,l,s[_+12],20,-1926607734),l=n(l,v,f,p,s[_+5],4,-378558),p=n(p,l,v,f,s[_+8],11,-2022574463),f=n(f,p,l,v,s[_+11],16,1839030562),v=n(v,f,p,l,s[_+14],23,-35309556),l=n(l,v,f,p,s[_+1],4,-1530992060),p=n(p,l,v,f,s[_+4],11,1272893353),f=n(f,p,l,v,s[_+7],16,-155497632),v=n(v,f,p,l,s[_+10],23,-1094730640),l=n(l,v,f,p,s[_+13],4,681279174),p=n(p,l,v,f,s[_],11,-358537222),f=n(f,p,l,v,s[_+3],16,-722521979),v=n(v,f,p,l,s[_+6],23,76029189),l=n(l,v,f,p,s[_+9],4,-640364487),p=n(p,l,v,f,s[_+12],11,-421815835),f=n(f,p,l,v,s[_+15],16,530742520),v=n(v,f,p,l,s[_+2],23,-995338651),l=i(l,v,f,p,s[_],6,-198630844),p=i(p,l,v,f,s[_+7],10,1126891415),f=i(f,p,l,v,s[_+14],15,-1416354905),v=i(v,f,p,l,s[_+5],21,-57434055),l=i(l,v,f,p,s[_+12],6,1700485571),p=i(p,l,v,f,s[_+3],10,-1894986606),f=i(f,p,l,v,s[_+10],15,-1051523),v=i(v,f,p,l,s[_+1],21,-2054922799),l=i(l,v,f,p,s[_+8],6,1873313359),p=i(p,l,v,f,s[_+15],10,-30611744),f=i(f,p,l,v,s[_+6],15,-1560198380),v=i(v,f,p,l,s[_+13],21,1309151649),l=i(l,v,f,p,s[_+4],6,-145523070),p=i(p,l,v,f,s[_+11],10,-1120210379),f=i(f,p,l,v,s[_+2],15,718787259),v=i(v,f,p,l,s[_+9],21,-343485551),l=m(l,T),v=m(v,w),f=m(f,M),p=m(p,A)}return[l,v,f,p]}function c(s){if(s.length===0)return[];const o=s.length*8,l=new Uint32Array(S(o));for(let v=0;v<o;v+=8)l[v>>5]|=(s[v/8]&255)<<v%32;return l}function m(s,o){const l=(s&65535)+(o&65535);return(s>>16)+(o>>16)+(l>>16)<<16|l&65535}function h(s,o){return s<<o|s>>>32-o}function d(s,o,l,v,f,p){return m(h(m(m(o,s),m(v,p)),f),l)}function b(s,o,l,v,f,p,_){return d(o&l|~o&v,s,o,f,p,_)}function a(s,o,l,v,f,p,_){return d(o&v|l&~v,s,o,f,p,_)}function n(s,o,l,v,f,p,_){return d(o^l^v,s,o,f,p,_)}function i(s,o,l,v,f,p,_){return d(l^(o|~v),s,o,f,p,_)}var r=u;e.default=r},{}],289:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var g={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};e.default=g},{}],290:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var u="00000000-0000-0000-0000-000000000000";e.default=u},{}],291:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var u=g(t("./validate.js"));function g(c){return c&&c.__esModule?c:{default:c}}function S(c){if(!(0,u.default)(c))throw TypeError("Invalid UUID");let m;const h=new Uint8Array(16);return h[0]=(m=parseInt(c.slice(0,8),16))>>>24,h[1]=m>>>16&255,h[2]=m>>>8&255,h[3]=m&255,h[4]=(m=parseInt(c.slice(9,13),16))>>>8,h[5]=m&255,h[6]=(m=parseInt(c.slice(14,18),16))>>>8,h[7]=m&255,h[8]=(m=parseInt(c.slice(19,23),16))>>>8,h[9]=m&255,h[10]=(m=parseInt(c.slice(24,36),16))/1099511627776&255,h[11]=m/4294967296&255,h[12]=m>>>24&255,h[13]=m>>>16&255,h[14]=m>>>8&255,h[15]=m&255,h}var y=S;e.default=y},{"./validate.js":301}],292:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var u=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;e.default=u},{}],293:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=S;let u;const g=new Uint8Array(16);function S(){if(!u&&(u=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!u))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return u(g)}},{}],294:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;function u(c,m,h,d){switch(c){case 0:return m&h^~m&d;case 1:return m^h^d;case 2:return m&h^m&d^h&d;case 3:return m^h^d}}function g(c,m){return c<<m|c>>>32-m}function S(c){const m=[1518500249,1859775393,2400959708,3395469782],h=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof c=="string"){const n=unescape(encodeURIComponent(c));c=[];for(let i=0;i<n.length;++i)c.push(n.charCodeAt(i))}else Array.isArray(c)||(c=Array.prototype.slice.call(c));c.push(128);const d=c.length/4+2,b=Math.ceil(d/16),a=new Array(b);for(let n=0;n<b;++n){const i=new Uint32Array(16);for(let r=0;r<16;++r)i[r]=c[n*64+r*4]<<24|c[n*64+r*4+1]<<16|c[n*64+r*4+2]<<8|c[n*64+r*4+3];a[n]=i}a[b-1][14]=(c.length-1)*8/Math.pow(2,32),a[b-1][14]=Math.floor(a[b-1][14]),a[b-1][15]=(c.length-1)*8&4294967295;for(let n=0;n<b;++n){const i=new Uint32Array(80);for(let f=0;f<16;++f)i[f]=a[n][f];for(let f=16;f<80;++f)i[f]=g(i[f-3]^i[f-8]^i[f-14]^i[f-16],1);let r=h[0],s=h[1],o=h[2],l=h[3],v=h[4];for(let f=0;f<80;++f){const p=Math.floor(f/20),_=g(r,5)+u(p,s,o,l)+v+m[p]+i[f]>>>0;v=l,l=o,o=g(s,30)>>>0,s=r,r=_}h[0]=h[0]+r>>>0,h[1]=h[1]+s>>>0,h[2]=h[2]+o>>>0,h[3]=h[3]+l>>>0,h[4]=h[4]+v>>>0}return[h[0]>>24&255,h[0]>>16&255,h[0]>>8&255,h[0]&255,h[1]>>24&255,h[1]>>16&255,h[1]>>8&255,h[1]&255,h[2]>>24&255,h[2]>>16&255,h[2]>>8&255,h[2]&255,h[3]>>24&255,h[3]>>16&255,h[3]>>8&255,h[3]&255,h[4]>>24&255,h[4]>>16&255,h[4]>>8&255,h[4]&255]}var y=S;e.default=y},{}],295:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,e.unsafeStringify=y;var u=g(t("./validate.js"));function g(h){return h&&h.__esModule?h:{default:h}}const S=[];for(let h=0;h<256;++h)S.push((h+256).toString(16).slice(1));function y(h,d=0){return(S[h[d+0]]+S[h[d+1]]+S[h[d+2]]+S[h[d+3]]+"-"+S[h[d+4]]+S[h[d+5]]+"-"+S[h[d+6]]+S[h[d+7]]+"-"+S[h[d+8]]+S[h[d+9]]+"-"+S[h[d+10]]+S[h[d+11]]+S[h[d+12]]+S[h[d+13]]+S[h[d+14]]+S[h[d+15]]).toLowerCase()}function c(h,d=0){const b=y(h,d);if(!(0,u.default)(b))throw TypeError("Stringified UUID is invalid");return b}var m=c;e.default=m},{"./validate.js":301}],296:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var u=S(t("./rng.js")),g=t("./stringify.js");function S(a){return a&&a.__esModule?a:{default:a}}let y,c,m=0,h=0;function d(a,n,i){let r=n&&i||0;const s=n||new Array(16);a=a||{};let o=a.node||y,l=a.clockseq!==void 0?a.clockseq:c;if(o==null||l==null){const w=a.random||(a.rng||u.default)();o==null&&(o=y=[w[0]|1,w[1],w[2],w[3],w[4],w[5]]),l==null&&(l=c=(w[6]<<8|w[7])&16383)}let v=a.msecs!==void 0?a.msecs:Date.now(),f=a.nsecs!==void 0?a.nsecs:h+1;const p=v-m+(f-h)/1e4;if(p<0&&a.clockseq===void 0&&(l=l+1&16383),(p<0||v>m)&&a.nsecs===void 0&&(f=0),f>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");m=v,h=f,c=l,v+=122192928e5;const _=((v&268435455)*1e4+f)%4294967296;s[r++]=_>>>24&255,s[r++]=_>>>16&255,s[r++]=_>>>8&255,s[r++]=_&255;const T=v/4294967296*1e4&268435455;s[r++]=T>>>8&255,s[r++]=T&255,s[r++]=T>>>24&15|16,s[r++]=T>>>16&255,s[r++]=l>>>8|128,s[r++]=l&255;for(let w=0;w<6;++w)s[r+w]=o[w];return n||(0,g.unsafeStringify)(s)}var b=d;e.default=b},{"./rng.js":293,"./stringify.js":295}],297:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var u=S(t("./v35.js")),g=S(t("./md5.js"));function S(m){return m&&m.__esModule?m:{default:m}}var c=(0,u.default)("v3",48,g.default);e.default=c},{"./md5.js":288,"./v35.js":298}],298:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.URL=e.DNS=void 0,e.default=h;var u=t("./stringify.js"),g=S(t("./parse.js"));function S(d){return d&&d.__esModule?d:{default:d}}function y(d){d=unescape(encodeURIComponent(d));const b=[];for(let a=0;a<d.length;++a)b.push(d.charCodeAt(a));return b}const c="6ba7b810-9dad-11d1-80b4-00c04fd430c8";e.DNS=c;const m="6ba7b811-9dad-11d1-80b4-00c04fd430c8";e.URL=m;function h(d,b,a){function n(i,r,s,o){var l;if(typeof i=="string"&&(i=y(i)),typeof r=="string"&&(r=(0,g.default)(r)),((l=r)===null||l===void 0?void 0:l.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let v=new Uint8Array(16+i.length);if(v.set(r),v.set(i,r.length),v=a(v),v[6]=v[6]&15|b,v[8]=v[8]&63|128,s){o=o||0;for(let f=0;f<16;++f)s[o+f]=v[f];return s}return(0,u.unsafeStringify)(v)}try{n.name=d}catch{}return n.DNS=c,n.URL=m,n}},{"./parse.js":291,"./stringify.js":295}],299:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var u=y(t("./native.js")),g=y(t("./rng.js")),S=t("./stringify.js");function y(h){return h&&h.__esModule?h:{default:h}}function c(h,d,b){if(u.default.randomUUID&&!d&&!h)return u.default.randomUUID();h=h||{};const a=h.random||(h.rng||g.default)();if(a[6]=a[6]&15|64,a[8]=a[8]&63|128,d){b=b||0;for(let n=0;n<16;++n)d[b+n]=a[n];return d}return(0,S.unsafeStringify)(a)}var m=c;e.default=m},{"./native.js":289,"./rng.js":293,"./stringify.js":295}],300:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var u=S(t("./v35.js")),g=S(t("./sha1.js"));function S(m){return m&&m.__esModule?m:{default:m}}var c=(0,u.default)("v5",80,g.default);e.default=c},{"./sha1.js":294,"./v35.js":298}],301:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var u=g(t("./regex.js"));function g(c){return c&&c.__esModule?c:{default:c}}function S(c){return typeof c=="string"&&u.default.test(c)}var y=S;e.default=y},{"./regex.js":292}],302:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var u=g(t("./validate.js"));function g(c){return c&&c.__esModule?c:{default:c}}function S(c){if(!(0,u.default)(c))throw TypeError("Invalid UUID");return parseInt(c.slice(14,15),16)}var y=S;e.default=y},{"./validate.js":301}],303:[function(t,E,e){(function(u){(function(){var g=t("for-each"),S=t("available-typed-arrays"),y=t("call-bind/callBound"),c=t("gopd"),m=y("Object.prototype.toString"),h=t("has-tostringtag/shams")(),d=typeof globalThis>"u"?u:globalThis,b=S(),a=y("String.prototype.slice"),n={},i=Object.getPrototypeOf;h&&c&&i&&g(b,function(o){if(typeof d[o]=="function"){var l=new d[o];if(Symbol.toStringTag in l){var v=i(l),f=c(v,Symbol.toStringTag);if(!f){var p=i(v);f=c(p,Symbol.toStringTag)}n[o]=f.get}}});var r=function(l){var v=!1;return g(n,function(f,p){if(!v)try{var _=f.call(l);_===p&&(v=_)}catch{}}),v},s=t("is-typed-array");E.exports=function(l){return s(l)?!h||!(Symbol.toStringTag in l)?a(m(l),8,-1):r(l):!1}}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"available-typed-arrays":16,"call-bind/callBound":69,"for-each":107,gopd:111,"has-tostringtag/shams":114,"is-typed-array":150}],304:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.RuleId=e.PushRuleKind=e.ConditionKind=e.isDmMemberCountCondition=e.DMMemberCountCondition=e.ConditionOperator=e.TweakName=e.PushRuleActionName=void 0,function(g){g.DontNotify="dont_notify",g.Notify="notify",g.Coalesce="coalesce"}(e.PushRuleActionName||(e.PushRuleActionName={})),function(g){g.Highlight="highlight",g.Sound="sound"}(e.TweakName||(e.TweakName={})),function(g){g.ExactEquals="==",g.LessThan="<",g.GreaterThan=">",g.GreaterThanOrEqual=">=",g.LessThanOrEqual="<="}(e.ConditionOperator||(e.ConditionOperator={})),e.DMMemberCountCondition="2";function u(g){return g==="==2"||g==="2"}e.isDmMemberCountCondition=u,function(g){g.EventMatch="event_match",g.EventPropertyIs="event_property_is",g.EventPropertyContains="event_property_contains",g.ContainsDisplayName="contains_display_name",g.RoomMemberCount="room_member_count",g.SenderNotificationPermission="sender_notification_permission",g.CallStarted="call_started",g.CallStartedPrefix="org.matrix.msc3914.call_started"}(e.ConditionKind||(e.ConditionKind={})),function(g){g.Override="override",g.ContentSpecific="content",g.RoomSpecific="room",g.SenderSpecific="sender",g.Underride="underride"}(e.PushRuleKind||(e.PushRuleKind={})),function(g){g.Master=".m.rule.master",g.IsUserMention=".org.matrix.msc3952.is_user_mention",g.IsRoomMention=".org.matrix.msc3952.is_room_mention",g.ContainsDisplayName=".m.rule.contains_display_name",g.ContainsUserName=".m.rule.contains_user_name",g.AtRoomNotification=".m.rule.roomnotif",g.DM=".m.rule.room_one_to_one",g.EncryptedDM=".m.rule.encrypted_room_one_to_one",g.Message=".m.rule.message",g.EncryptedMessage=".m.rule.encrypted",g.InviteToSelf=".m.rule.invite_for_me",g.MemberEvent=".m.rule.member_event",g.IncomingCall=".m.rule.call",g.SuppressNotices=".m.rule.suppress_notices",g.Tombstone=".m.rule.tombstone",g.PollStart=".m.rule.poll_start",g.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",g.PollEnd=".m.rule.poll_end",g.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",g.PollStartOneToOne=".m.rule.poll_start_one_to_one",g.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",g.PollEndOneToOne=".m.rule.poll_end_one_to_one",g.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one"}(e.RuleId||(e.RuleId={}))},{}],305:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.M_BEACON=e.M_BEACON_INFO=void 0;const u=t("../NamespacedValue");e.M_BEACON_INFO=new u.UnstableValue("m.beacon_info","org.matrix.msc3672.beacon_info"),e.M_BEACON=new u.UnstableValue("m.beacon","org.matrix.msc3672.beacon")},{"../NamespacedValue":316}],306:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.LOCAL_NOTIFICATION_SETTINGS_PREFIX=e.PUSHER_DEVICE_ID=e.PUSHER_ENABLED=e.EVENT_VISIBILITY_CHANGE_TYPE=e.UNSTABLE_ELEMENT_FUNCTIONAL_USERS=e.MSC3912_RELATION_BASED_REDACTIONS_PROP=e.UNSTABLE_MSC2716_MARKER=e.UNSTABLE_MSC3089_BRANCH=e.UNSTABLE_MSC3089_LEAF=e.UNSTABLE_MSC3089_TREE_SUBTYPE=e.UNSTABLE_MSC3088_ENABLED=e.UNSTABLE_MSC3088_PURPOSE=e.ToDeviceMessageId=e.RoomType=e.RoomCreateTypeField=e.MsgType=e.RelationType=e.EventType=void 0;const u=t("../NamespacedValue");(function(g){g.RoomCanonicalAlias="m.room.canonical_alias",g.RoomCreate="m.room.create",g.RoomJoinRules="m.room.join_rules",g.RoomMember="m.room.member",g.RoomThirdPartyInvite="m.room.third_party_invite",g.RoomPowerLevels="m.room.power_levels",g.RoomName="m.room.name",g.RoomTopic="m.room.topic",g.RoomAvatar="m.room.avatar",g.RoomPinnedEvents="m.room.pinned_events",g.RoomEncryption="m.room.encryption",g.RoomHistoryVisibility="m.room.history_visibility",g.RoomGuestAccess="m.room.guest_access",g.RoomServerAcl="m.room.server_acl",g.RoomTombstone="m.room.tombstone",g.RoomPredecessor="org.matrix.msc3946.room_predecessor",g.SpaceChild="m.space.child",g.SpaceParent="m.space.parent",g.RoomRedaction="m.room.redaction",g.RoomMessage="m.room.message",g.RoomMessageEncrypted="m.room.encrypted",g.Sticker="m.sticker",g.CallInvite="m.call.invite",g.CallCandidates="m.call.candidates",g.CallAnswer="m.call.answer",g.CallHangup="m.call.hangup",g.CallReject="m.call.reject",g.CallSelectAnswer="m.call.select_answer",g.CallNegotiate="m.call.negotiate",g.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",g.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",g.CallReplaces="m.call.replaces",g.CallAssertedIdentity="m.call.asserted_identity",g.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",g.KeyVerificationRequest="m.key.verification.request",g.KeyVerificationStart="m.key.verification.start",g.KeyVerificationCancel="m.key.verification.cancel",g.KeyVerificationMac="m.key.verification.mac",g.KeyVerificationDone="m.key.verification.done",g.KeyVerificationKey="m.key.verification.key",g.KeyVerificationAccept="m.key.verification.accept",g.KeyVerificationReady="m.key.verification.ready",g.RoomMessageFeedback="m.room.message.feedback",g.Reaction="m.reaction",g.PollStart="org.matrix.msc3381.poll.start",g.Typing="m.typing",g.Receipt="m.receipt",g.Presence="m.presence",g.FullyRead="m.fully_read",g.Tag="m.tag",g.SpaceOrder="org.matrix.msc3230.space_order",g.PushRules="m.push_rules",g.Direct="m.direct",g.IgnoredUserList="m.ignored_user_list",g.RoomKey="m.room_key",g.RoomKeyRequest="m.room_key_request",g.ForwardedRoomKey="m.forwarded_room_key",g.Dummy="m.dummy",g.GroupCallPrefix="org.matrix.msc3401.call",g.GroupCallMemberPrefix="org.matrix.msc3401.call.member"})(e.EventType||(e.EventType={})),function(g){g.Annotation="m.annotation",g.Replace="m.replace",g.Reference="m.reference",g.Thread="m.thread"}(e.RelationType||(e.RelationType={})),function(g){g.Text="m.text",g.Emote="m.emote",g.Notice="m.notice",g.Image="m.image",g.File="m.file",g.Audio="m.audio",g.Location="m.location",g.Video="m.video",g.KeyVerificationRequest="m.key.verification.request"}(e.MsgType||(e.MsgType={})),e.RoomCreateTypeField="type",function(g){g.Space="m.space",g.UnstableCall="org.matrix.msc3417.call",g.ElementVideo="io.element.video"}(e.RoomType||(e.RoomType={})),e.ToDeviceMessageId="org.matrix.msgid",e.UNSTABLE_MSC3088_PURPOSE=new u.UnstableValue("m.room.purpose","org.matrix.msc3088.purpose"),e.UNSTABLE_MSC3088_ENABLED=new u.UnstableValue("m.enabled","org.matrix.msc3088.enabled"),e.UNSTABLE_MSC3089_TREE_SUBTYPE=new u.UnstableValue("m.data_tree","org.matrix.msc3089.data_tree"),e.UNSTABLE_MSC3089_LEAF=new u.UnstableValue("m.leaf","org.matrix.msc3089.leaf"),e.UNSTABLE_MSC3089_BRANCH=new u.UnstableValue("m.branch","org.matrix.msc3089.branch"),e.UNSTABLE_MSC2716_MARKER=new u.UnstableValue("m.room.marker","org.matrix.msc2716.marker"),e.MSC3912_RELATION_BASED_REDACTIONS_PROP=new u.UnstableValue("with_relations","org.matrix.msc3912.with_relations"),e.UNSTABLE_ELEMENT_FUNCTIONAL_USERS=new u.UnstableValue("io.element.functional_members","io.element.functional_members"),e.EVENT_VISIBILITY_CHANGE_TYPE=new u.UnstableValue("m.visibility","org.matrix.msc3531.visibility"),e.PUSHER_ENABLED=new u.UnstableValue("enabled","org.matrix.msc3881.enabled"),e.PUSHER_DEVICE_ID=new u.UnstableValue("device_id","org.matrix.msc3881.device_id"),e.LOCAL_NOTIFICATION_SETTINGS_PREFIX=new u.UnstableValue("m.local_notification_settings","org.matrix.msc3890.local_notification_settings")},{"../NamespacedValue":316}],307:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isEventTypeSame=e.REFERENCE_RELATION=e.M_HTML=e.M_TEXT=e.M_MESSAGE=void 0;const u=t("matrix-events-sdk"),g=t("../extensible_events_v1/utilities");e.M_MESSAGE=new u.UnstableValue("m.message","org.matrix.msc1767.message"),e.M_TEXT=new u.UnstableValue("m.text","org.matrix.msc1767.text"),e.M_HTML=new u.UnstableValue("m.html","org.matrix.msc1767.html"),e.REFERENCE_RELATION=new u.NamespacedValue("m.reference");function S(y,c){if(typeof y=="string")return typeof c=="string"?c===y:c.matches(y);if(typeof c=="string")return y.matches(c);{const m=c,h=y;return m.matches(h.name)||(0,g.isProvided)(h.altName)&&m.matches(h.altName)}}e.isEventTypeSame=S},{"../extensible_events_v1/utilities":361,"matrix-events-sdk":167}],308:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.M_LOCATION=e.M_TIMESTAMP=e.M_ASSET=e.LocationAssetType=void 0;const u=t("../NamespacedValue");t("./extensible_events"),function(g){g.Self="m.self",g.Pin="m.pin"}(e.LocationAssetType||(e.LocationAssetType={})),e.M_ASSET=new u.UnstableValue("m.asset","org.matrix.msc3488.asset"),e.M_TIMESTAMP=new u.UnstableValue("m.ts","org.matrix.msc3488.ts"),e.M_LOCATION=new u.UnstableValue("m.location","org.matrix.msc3488.location")},{"../NamespacedValue":316,"./extensible_events":307}],309:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.HistoryVisibility=e.GuestAccess=e.RestrictedAllowType=e.JoinRule=e.Preset=e.Visibility=void 0,function(u){u.Public="public",u.Private="private"}(e.Visibility||(e.Visibility={})),function(u){u.PrivateChat="private_chat",u.TrustedPrivateChat="trusted_private_chat",u.PublicChat="public_chat"}(e.Preset||(e.Preset={})),function(u){u.Public="public",u.Invite="invite",u.Private="private",u.Knock="knock",u.Restricted="restricted"}(e.JoinRule||(e.JoinRule={})),function(u){u.RoomMembership="m.room_membership"}(e.RestrictedAllowType||(e.RestrictedAllowType={})),function(u){u.CanJoin="can_join",u.Forbidden="forbidden"}(e.GuestAccess||(e.GuestAccess={})),function(u){u.Invited="invited",u.Joined="joined",u.Shared="shared",u.WorldReadable="world_readable"}(e.HistoryVisibility||(e.HistoryVisibility={}))},{}],310:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.M_POLL_END=e.M_POLL_RESPONSE=e.M_POLL_START=e.M_POLL_KIND_UNDISCLOSED=e.M_POLL_KIND_DISCLOSED=void 0;const u=t("matrix-events-sdk");e.M_POLL_KIND_DISCLOSED=new u.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),e.M_POLL_KIND_UNDISCLOSED=new u.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),e.M_POLL_START=new u.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),e.M_POLL_RESPONSE=new u.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),e.M_POLL_END=new u.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end")},{"matrix-events-sdk":167}],311:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.MAIN_ROOM_TIMELINE=e.ReceiptType=void 0,function(u){u.Read="m.read",u.FullyRead="m.fully_read",u.ReadPrivate="m.read.private"}(e.ReceiptType||(e.ReceiptType={})),e.MAIN_ROOM_TIMELINE="main"},{}],312:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0})},{}],313:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SearchOrderBy=void 0;var u;(function(g){g.RoomId="room_id",g.Sender="sender"})(u||(u={})),function(g){g.Recent="recent",g.Rank="rank"}(e.SearchOrderBy||(e.SearchOrderBy={}))},{}],314:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.UNREAD_THREAD_NOTIFICATIONS=void 0;const u=t("../NamespacedValue");e.UNREAD_THREAD_NOTIFICATIONS=new u.ServerControlledNamespacedValue("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications")},{"../NamespacedValue":316}],315:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.M_TOPIC=void 0;const u=t("../NamespacedValue");e.M_TOPIC=new u.UnstableValue("m.topic","org.matrix.msc3765.topic")},{"../NamespacedValue":316}],316:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.UnstableValue=e.ServerControlledNamespacedValue=e.NamespacedValue=void 0;class u{constructor(c,m){if(this.stable=c,this.unstable=m,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){const c=[this.name],m=this.altName;return m&&c.push(m),c}matches(c){return this.name===c||this.altName===c}findIn(c){let m;return this.name&&(m=c==null?void 0:c[this.name]),!m&&this.altName&&(m=c==null?void 0:c[this.altName]),m}includedIn(c){let m=!1;return this.name&&(m=c.includes(this.name)),!m&&this.altName&&(m=c.includes(this.altName)),m}}e.NamespacedValue=u;class g extends u{constructor(){super(...arguments),this.preferUnstable=!1}setPreferUnstable(c){this.preferUnstable=c}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}e.ServerControlledNamespacedValue=g;class S extends u{constructor(c,m){if(super(c,m),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}e.UnstableValue=S},{}],317:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.TypedReEmitter=e.ReEmitter=void 0;class u{constructor(y){this.target=y,this.reEmitters=new Map}reEmit(y,c){let m=this.reEmitters.get(y);m||(m=new Map,this.reEmitters.set(y,m));for(const h of c){const d=(...b)=>{h==="error"&&this.target.listenerCount("error")===0||this.target.emit(h,...b,y)};y.on(h,d),m.set(h,d)}}stopReEmitting(y,c){const m=this.reEmitters.get(y);if(m){for(const h of c)y.off(h,m.get(h)),m.delete(h);m.size===0&&this.reEmitters.delete(y)}}}e.ReEmitter=u;class g extends u{constructor(y){super(y)}reEmit(y,c){super.reEmit(y,c)}stopReEmitting(y,c){super.stopReEmitting(y,c)}}e.TypedReEmitter=g},{}],318:[function(t,E,e){var u=this&&this.__awaiter||function(a,n,i,r){function s(o){return o instanceof i?o:new i(function(l){l(o)})}return new(i||(i=Promise))(function(o,l){function v(_){try{p(r.next(_))}catch(T){l(T)}}function f(_){try{p(r.throw(_))}catch(T){l(T)}}function p(_){_.done?o(_.value):s(_.value).then(v,f)}p((r=r.apply(a,n||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.ToDeviceMessageQueue=void 0;const g=t("./@types/event"),S=t("./logger"),y=t("./client"),c=t("./scheduler"),m=t("./sync"),h=t("./utils"),d=20;class b{constructor(n){this.client=n,this.sending=!1,this.running=!0,this.retryTimeout=null,this.retryAttempts=0,this.sendQueue=()=>u(this,void 0,void 0,function*(){if(this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.sending||!this.running)return;S.logger.debug("Attempting to send queued to-device messages"),this.sending=!0;let i;try{for(;this.running&&(i=yield this.client.store.getOldestToDeviceBatch(),i!==null);)yield this.sendBatch(i),yield this.client.store.removeToDeviceBatch(i.id),this.retryAttempts=0;if(!this.running)return;S.logger.debug("All queued to-device messages sent")}catch(r){++this.retryAttempts;const s=c.MatrixScheduler.RETRY_BACKOFF_RATELIMIT(null,this.retryAttempts,r);if(s===-1){Math.floor(r.httpStatus/100)===4?(S.logger.error("Fatal error when sending to-device message - dropping to-device batch!",r),yield this.client.store.removeToDeviceBatch(i.id)):S.logger.info("Automatic retry limit reached for to-device messages.");return}S.logger.info(`Failed to send batch of to-device messages. Will retry in ${s}ms`,r),this.retryTimeout=setTimeout(this.sendQueue,s)}finally{this.sending=!1}}),this.onResumedSync=(i,r)=>{i===m.SyncState.Syncing&&r!==m.SyncState.Syncing&&(S.logger.info("Resuming queue after resumed sync"),this.sendQueue())}}start(){this.running=!0,this.sendQueue(),this.client.on(y.ClientEvent.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(y.ClientEvent.Sync,this.onResumedSync)}queueBatch(n){return u(this,void 0,void 0,function*(){const i=[];for(let r=0;r<n.batch.length;r+=d){const s={eventType:n.eventType,batch:n.batch.slice(r,r+d),txnId:this.client.makeTxnId()};i.push(s);const o=s.batch.map(l=>`${l.userId}/${l.deviceId} (msgid ${l.payload[g.ToDeviceMessageId]})`);S.logger.info(`Enqueuing batch of to-device messages. type=${n.eventType} txnid=${s.txnId}`,o)}yield this.client.store.saveToDeviceBatches(i),this.sendQueue()})}sendBatch(n){return u(this,void 0,void 0,function*(){const i=new h.MapWithDefault(()=>new Map);for(const r of n.batch)i.getOrCreate(r.userId).set(r.deviceId,r.payload);S.logger.info(`Sending batch of ${n.batch.length} to-device messages with ID ${n.id} and txnId ${n.txnId}`),yield this.client.sendToDevice(n.eventType,i,n.txnId)})}}e.ToDeviceMessageQueue=b},{"./@types/event":306,"./client":321,"./logger":374,"./scheduler":403,"./sync":414,"./utils":416}],319:[function(t,E,e){(function(u){(function(){var g=this&&this.__awaiter||function(d,b,a,n){function i(r){return r instanceof a?r:new a(function(s){s(r)})}return new(a||(a=Promise))(function(r,s){function o(f){try{v(n.next(f))}catch(p){s(p)}}function l(f){try{v(n.throw(f))}catch(p){s(p)}}function v(f){f.done?r(f.value):i(f.value).then(o,l)}v((n=n.apply(d,b||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.AutoDiscovery=e.AutoDiscoveryAction=void 0;const S=t("./logger"),y=t("./http-api");var c;(function(d){d.SUCCESS="SUCCESS",d.IGNORE="IGNORE",d.PROMPT="PROMPT",d.FAIL_PROMPT="FAIL_PROMPT",d.FAIL_ERROR="FAIL_ERROR"})(c=e.AutoDiscoveryAction||(e.AutoDiscoveryAction={}));var m;(function(d){d.Invalid="Invalid homeserver discovery response",d.GenericFailure="Failed to get autodiscovery configuration from server",d.InvalidHsBaseUrl="Invalid base_url for m.homeserver",d.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",d.InvalidIsBaseUrl="Invalid base_url for m.identity_server",d.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",d.InvalidIs="Invalid identity server discovery response",d.MissingWellknown="No .well-known JSON file found",d.InvalidJson="Invalid JSON"})(m||(m={}));class h{static fromDiscoveryConfig(b){var a;return g(this,void 0,void 0,function*(){const n={"m.homeserver":{state:h.FAIL_ERROR,error:h.ERROR_INVALID,base_url:null},"m.identity_server":{state:h.PROMPT,error:null,base_url:null}};if(!b||!b["m.homeserver"])return S.logger.error("No m.homeserver key in config"),n["m.homeserver"].state=h.FAIL_PROMPT,n["m.homeserver"].error=h.ERROR_INVALID,Promise.resolve(n);if(!b["m.homeserver"].base_url)return S.logger.error("No m.homeserver base_url in config"),n["m.homeserver"].state=h.FAIL_PROMPT,n["m.homeserver"].error=h.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);const i=this.sanitizeWellKnownUrl(b["m.homeserver"].base_url);if(!i)return S.logger.error("Invalid base_url for m.homeserver"),n["m.homeserver"].error=h.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);const r=yield this.fetchWellKnownObject(`${i}/_matrix/client/versions`);if(!r||!(!((a=r.raw)===null||a===void 0)&&a.versions))return S.logger.error("Invalid /versions response"),n["m.homeserver"].error=h.ERROR_INVALID_HOMESERVER,n["m.homeserver"].base_url=i,Promise.resolve(n);n["m.homeserver"]={state:h.SUCCESS,error:null,base_url:i};let s="";if(b["m.identity_server"]){const o={"m.homeserver":n["m.homeserver"],"m.identity_server":{state:h.FAIL_PROMPT,error:h.ERROR_INVALID_IS,base_url:null}};if(s=this.sanitizeWellKnownUrl(b["m.identity_server"].base_url),!s)return S.logger.error("Invalid base_url for m.identity_server"),o["m.identity_server"].error=h.ERROR_INVALID_IS_BASE_URL,Promise.resolve(o);const l=yield this.fetchWellKnownObject(`${s}/_matrix/identity/v2`);if(!(l!=null&&l.raw)||l.action!==c.SUCCESS)return S.logger.error("Invalid /v2 response"),o["m.identity_server"].error=h.ERROR_INVALID_IDENTITY_SERVER,o["m.identity_server"].base_url=s,Promise.resolve(o)}return s&&s.toString().length>0&&(n["m.identity_server"]={state:h.SUCCESS,error:null,base_url:s}),Object.keys(b).forEach(o=>{if(o==="m.homeserver"||o==="m.identity_server"){const l=["error","state","base_url"];for(const v of Object.keys(b[o]))l.includes(v)||(n[o][v]=b[o][v])}else n[o]=b[o]}),Promise.resolve(n)})}static findClientConfig(b){return g(this,void 0,void 0,function*(){if(!b||typeof b!="string"||b.length===0)throw new Error("'domain' must be a string of non-zero length");const a={"m.homeserver":{state:h.FAIL_ERROR,error:h.ERROR_INVALID,base_url:null},"m.identity_server":{state:h.PROMPT,error:null,base_url:null}},n=yield this.fetchWellKnownObject(`https://${b}/.well-known/matrix/client`);return!n||n.action!==c.SUCCESS?(S.logger.error("No response or error when parsing .well-known"),n.reason&&S.logger.error(n.reason),n.action===c.IGNORE?a["m.homeserver"]={state:h.PROMPT,error:null,base_url:null}:(a["m.homeserver"].state=h.FAIL_PROMPT,a["m.homeserver"].error=h.ERROR_INVALID),Promise.resolve(a)):h.fromDiscoveryConfig(n.raw)})}static getRawClientConfig(b){return g(this,void 0,void 0,function*(){if(!b||typeof b!="string"||b.length===0)throw new Error("'domain' must be a string of non-zero length");const a=yield this.fetchWellKnownObject(`https://${b}/.well-known/matrix/client`);return a?a.raw||{}:{}})}static sanitizeWellKnownUrl(b){if(!b)return!1;try{let a;try{a=new URL(b)}catch(s){S.logger.error("Could not parse url",s)}if(!(a!=null&&a.hostname)||a.protocol!=="http:"&&a.protocol!=="https:")return!1;const n=a.port?`:${a.port}`:"",i=a.pathname?a.pathname:"";let r=`${a.protocol}//${a.hostname}${n}${i}`;return r.endsWith("/")&&(r=r.substring(0,r.length-1)),r}catch(a){return S.logger.error(a),!1}}static fetch(b,a){return this.fetchFn?this.fetchFn(b,a):u.fetch(b,a)}static setFetchFn(b){h.fetchFn=b}static fetchWellKnownObject(b){return g(this,void 0,void 0,function*(){let a;try{if(a=yield h.fetch(b,{method:y.Method.Get,signal:(0,y.timeoutSignal)(5e3)}),a.status===404)return{raw:{},action:c.IGNORE,reason:h.ERROR_MISSING_WELLKNOWN};if(!a.ok)return{raw:{},action:c.FAIL_PROMPT,reason:"General failure"}}catch(n){const i=n;let r="";return typeof i=="object"&&(r=i==null?void 0:i.message),{error:i,raw:{},action:c.FAIL_PROMPT,reason:r||"General failure"}}try{return{raw:yield a.json(),action:c.SUCCESS}}catch(n){const i=n;return{error:i,raw:{},action:c.FAIL_PROMPT,reason:(i==null?void 0:i.name)==="SyntaxError"?h.ERROR_INVALID_JSON:h.ERROR_INVALID}}})}}e.AutoDiscovery=h,h.ERROR_INVALID=m.Invalid,h.ERROR_GENERIC_FAILURE=m.GenericFailure,h.ERROR_INVALID_HS_BASE_URL=m.InvalidHsBaseUrl,h.ERROR_INVALID_HOMESERVER=m.InvalidHomeserver,h.ERROR_INVALID_IS_BASE_URL=m.InvalidIsBaseUrl,h.ERROR_INVALID_IDENTITY_SERVER=m.InvalidIdentityServer,h.ERROR_INVALID_IS=m.InvalidIs,h.ERROR_MISSING_WELLKNOWN=m.MissingWellknown,h.ERROR_INVALID_JSON=m.InvalidJson,h.ALL_ERRORS=Object.keys(m),h.FAIL_ERROR=c.FAIL_ERROR,h.FAIL_PROMPT=c.FAIL_PROMPT,h.PROMPT=c.PROMPT,h.SUCCESS=c.SUCCESS}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./http-api":367,"./logger":374}],320:[function(t,E,e){(function(u){(function(){var g=this&&this.__createBinding||(Object.create?function(d,b,a,n){n===void 0&&(n=a);var i=Object.getOwnPropertyDescriptor(b,a);(!i||("get"in i?!b.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return b[a]}}),Object.defineProperty(d,n,i)}:function(d,b,a,n){n===void 0&&(n=a),d[n]=b[a]}),S=this&&this.__setModuleDefault||(Object.create?function(d,b){Object.defineProperty(d,"default",{enumerable:!0,value:b})}:function(d,b){d.default=b}),y=this&&this.__importStar||function(d){if(d&&d.__esModule)return d;var b={};if(d!=null)for(var a in d)a!=="default"&&Object.prototype.hasOwnProperty.call(d,a)&&g(b,d,a);return S(b,d),b},c=this&&this.__exportStar||function(d,b){for(var a in d)a!=="default"&&!Object.prototype.hasOwnProperty.call(b,a)&&g(b,d,a)};Object.defineProperty(e,"__esModule",{value:!0});const m=y(t("./matrix"));if(u.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");u.__js_sdk_entrypoint=!0;let h;try{h=u.indexedDB}catch{}h&&m.setCryptoStoreFactory(()=>new m.IndexedDBCryptoStore(h,"matrix-js-sdk:crypto")),c(t("./matrix"),e),e.default=m,u.matrixcs=m}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./matrix":375}],321:[function(t,E,e){(function(u){(function(){var g=this&&this.__createBinding||(Object.create?function(me,N,Z,ie){ie===void 0&&(ie=Z);var se=Object.getOwnPropertyDescriptor(N,Z);(!se||("get"in se?!N.__esModule:se.writable||se.configurable))&&(se={enumerable:!0,get:function(){return N[Z]}}),Object.defineProperty(me,ie,se)}:function(me,N,Z,ie){ie===void 0&&(ie=Z),me[ie]=N[Z]}),S=this&&this.__setModuleDefault||(Object.create?function(me,N){Object.defineProperty(me,"default",{enumerable:!0,value:N})}:function(me,N){me.default=N}),y=this&&this.__importStar||function(me){if(me&&me.__esModule)return me;var N={};if(me!=null)for(var Z in me)Z!=="default"&&Object.prototype.hasOwnProperty.call(me,Z)&&g(N,me,Z);return S(N,me),N},c=this&&this.__awaiter||function(me,N,Z,ie){function se(le){return le instanceof Z?le:new Z(function(ge){ge(le)})}return new(Z||(Z=Promise))(function(le,ge){function be(Re){try{_e(ie.next(Re))}catch(Ie){ge(Ie)}}function Se(Re){try{_e(ie.throw(Re))}catch(Ie){ge(Ie)}}function _e(Re){Re.done?le(Re.value):se(Re.value).then(be,Se)}_e((ie=ie.apply(me,N||[])).next())})},m=this&&this.__rest||function(me,N){var Z={};for(var ie in me)Object.prototype.hasOwnProperty.call(me,ie)&&N.indexOf(ie)<0&&(Z[ie]=me[ie]);if(me!=null&&typeof Object.getOwnPropertySymbols=="function")for(var se=0,ie=Object.getOwnPropertySymbols(me);se<ie.length;se++)N.indexOf(ie[se])<0&&Object.prototype.propertyIsEnumerable.call(me,ie[se])&&(Z[ie[se]]=me[ie[se]]);return Z};Object.defineProperty(e,"__esModule",{value:!0}),e.fixNotificationCountOnDecryption=e.MatrixClient=e.ClientEvent=e.M_AUTHENTICATION=e.RoomVersionStability=e.PendingEventOrdering=e.UNSTABLE_MSC3852_LAST_SEEN_UA=e.CRYPTO_ENABLED=void 0;const h=t("./sync"),d=t("./models/event"),b=t("./store/stub"),a=t("./webrtc/call"),n=t("./filter"),i=t("./webrtc/callEventHandler"),r=y(t("./utils")),s=t("./utils"),o=t("./models/event-timeline"),l=t("./pushprocessor"),v=t("./autodiscovery"),f=y(t("./crypto/olmlib")),p=t("./crypto/olmlib"),_=t("./ReEmitter"),T=t("./crypto/RoomList"),w=t("./logger"),M=t("./service-types"),A=t("./http-api"),W=t("./crypto"),ee=t("./crypto/recoverykey"),F=t("./crypto/key_passphrase"),C=t("./models/user"),O=t("./content-repo"),I=t("./models/search-result"),D=t("./crypto/dehydration"),j=t("./crypto/api"),Y=y(t("./content-helpers")),q=t("./models/room"),B=t("./models/room-member"),R=t("./@types/event"),k=t("./@types/partials"),P=t("./event-mapper"),V=t("./randomstring"),x=t("./crypto/backup"),Q=t("./models/MSC3089TreeSpace"),te=t("./@types/search"),ae=t("./@types/PushRules"),de=t("./webrtc/groupCall"),X=t("./webrtc/mediaHandler"),$=t("./webrtc/groupCallEventHandler"),K=t("./models/typed-event-emitter"),re=t("./@types/read_receipts"),ue=t("./sliding-sync-sdk"),H=t("./models/thread"),G=t("./@types/beacon"),U=t("./NamespacedValue"),L=t("./ToDeviceMessageQueue"),z=t("./models/invites-ignorer"),J=t("./feature"),ne=t("./rust-crypto/constants"),oe=3e3;e.CRYPTO_ENABLED=(0,W.isCryptoAvailable)();const ce=216e5,pe=10*60*1e3;e.UNSTABLE_MSC3852_LAST_SEEN_UA=new U.UnstableValue("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),function(me){me.Chronological="chronological",me.Detached="detached"}(e.PendingEventOrdering||(e.PendingEventOrdering={})),function(me){me.Stable="stable",me.Unstable="unstable"}(e.RoomVersionStability||(e.RoomVersionStability={}));var he;(function(me){me.MasterKey="master_key",me.SelfSigningKey="self_signing_key",me.UserSigningKey="user_signing_key"})(he||(he={})),e.M_AUTHENTICATION=new U.UnstableValue("m.authentication","org.matrix.msc2965.authentication");const fe="$";var ve;(function(me){me.Sync="sync",me.Event="event",me.ToDeviceEvent="toDeviceEvent",me.AccountData="accountData",me.Room="Room",me.DeleteRoom="deleteRoom",me.SyncUnexpectedError="sync.unexpectedError",me.ClientWellKnown="WellKnown.client",me.ReceivedVoipEvent="received_voip_event",me.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",me.TurnServers="turnServers",me.TurnServersError="turnServers.error"})(ve=e.ClientEvent||(e.ClientEvent={}));const ye=new U.UnstableValue("action","org.matrix.msc3824.action");class Ee extends K.TypedEventEmitter{constructor(N){var Z;super(),this.reEmitter=new _.TypedReEmitter(this),this.olmVersion=null,this.usingExternalCrypto=!1,this.clientRunning=!1,this.timelineSupport=!1,this.urlPreviewCache={},this.supportsCallTransfer=!1,this.forceTURN=!1,this.iceCandidatePoolSize=0,this.canSupportVoip=!1,this.peekSync=null,this.isGuestAccount=!1,this.ongoingScrollbacks={},this.notifTimelineSet=null,this.fallbackICEServerAllowed=!1,this.syncedLeftRooms=!1,this.canSupport=new Map,this.pushProcessor=new l.PushProcessor(this),this.turnServers=[],this.turnServersExpiry=0,this.txnCtr=0,this.mediaHandler=new X.MediaHandler(this),this.pendingEventEncryption=new Map,this.useE2eForGroupCall=!0,this.startCallEventHandler=()=>{this.isInitialSyncComplete()&&(this.callEventHandler.start(),this.groupCallEventHandler.start(),this.off(ve.Sync,this.startCallEventHandler))},this.fixupRoomNotifications=()=>{var se;if(this.isInitialSyncComplete()){const le=((se=this.getRooms())!==null&&se!==void 0?se:[]).filter(ge=>ge.getUnreadNotificationCount(q.NotificationCountType.Total)>0);for(const ge of le){const be=this.getSafeUserId();ge.fixupNotifications(be)}this.off(ve.Sync,this.fixupRoomNotifications)}},N.baseUrl=r.ensureNoTrailingSlash(N.baseUrl),N.idBaseUrl=r.ensureNoTrailingSlash(N.idBaseUrl),this.baseUrl=N.baseUrl,this.idBaseUrl=N.idBaseUrl,this.identityServer=N.identityServer,this.usingExternalCrypto=(Z=N.usingExternalCrypto)!==null&&Z!==void 0?Z:!1,this.store=N.store||new b.StubStore,this.deviceId=N.deviceId||null,this.sessionId=(0,V.randomString)(10);const ie=N.userId||null;this.credentials={userId:ie},this.http=new A.MatrixHttpApi(this,{fetchFn:N.fetchFn,baseUrl:N.baseUrl,idBaseUrl:N.idBaseUrl,accessToken:N.accessToken,prefix:A.ClientPrefix.R0,onlyData:!0,extraParams:N.queryParams,localTimeoutMs:N.localTimeoutMs,useAuthorizationHeader:N.useAuthorizationHeader}),N.deviceToImport?this.deviceId?w.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?w.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):N.deviceToImport.deviceId?(this.deviceId=N.deviceToImport.deviceId,this.credentials.userId=N.deviceToImport.userId,this.exportedOlmDeviceToImport=N.deviceToImport.olmDevice):w.logger.warn("not importing device because no device ID in exported data"):N.pickleKey&&(this.pickleKey=N.pickleKey),this.scheduler=N.scheduler,this.scheduler&&this.scheduler.setProcessFunction(se=>c(this,void 0,void 0,function*(){const le=this.getRoom(se.getRoomId());se.status!==d.EventStatus.SENDING&&this.updatePendingEventStatus(le,se,d.EventStatus.SENDING);const ge=yield this.sendEventHttpRequest(se);return le&&le.updatePendingEvent(se,d.EventStatus.SENT,ge.event_id),ge})),(0,a.supportsMatrixCall)()&&(this.callEventHandler=new i.CallEventHandler(this),this.groupCallEventHandler=new $.GroupCallEventHandler(this),this.canSupportVoip=!0,this.on(ve.Sync,this.startCallEventHandler)),this.on(ve.Sync,this.fixupRoomNotifications),this.timelineSupport=!!N.timelineSupport,this.cryptoStore=N.cryptoStore,this.verificationMethods=N.verificationMethods,this.cryptoCallbacks=N.cryptoCallbacks||{},this.forceTURN=N.forceTURN||!1,this.iceCandidatePoolSize=N.iceCandidatePoolSize===void 0?0:N.iceCandidatePoolSize,this.supportsCallTransfer=N.supportsCallTransfer||!1,this.fallbackICEServerAllowed=N.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=N.isVoipWithNoMediaAllowed||!1,N.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=N.useE2eForGroupCall),this.roomList=new T.RoomList(this.cryptoStore),this.roomNameGenerator=N.roomNameGenerator,this.toDeviceMessageQueue=new L.ToDeviceMessageQueue(this),this.on(d.MatrixEventEvent.Decrypted,se=>{we(this,se)}),this.on(q.RoomEvent.Receipt,(se,le)=>{var ge;if(le&&this.isRoomEncrypted(le.roomId)){const be=se.getContent();if(!(Object.keys(be).filter(Ce=>{for(const[Me,Ae]of Object.entries(be[Ce]))if(r.isSupportedReceiptType(Me)&&Ae&&Object.keys(Ae).includes(this.getUserId()))return!0;return!1}).length>0))return;const _e=20,Re=le.getLiveTimeline().getEvents();let Ie=0;for(let Ce=Re.length-1;Ce>=0;Ce--){if(Ce===Re.length-_e)return;const Me=Re[Ce];if(le.hasUserReadEvent(this.getUserId(),Me.getId()))break;const Ae=this.getPushActionsForEvent(Me);Ie+=!((ge=Ae==null?void 0:Ae.tweaks)===null||ge===void 0)&&ge.highlight?1:0}le.setUnreadNotificationCount(q.NotificationCountType.Highlight,Ie)}}),this.ignoredInvites=new z.IgnoredInvites(this)}startClient(N){return c(this,void 0,void 0,function*(){if(this.clientRunning)return;this.clientRunning=!0,typeof N=="number"&&(N={initialSyncLimit:N});const Z=this.getUserId();Z&&this.store.storeUser(new C.User(Z)),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval(()=>{this.checkTurnServers()},pe),this.checkTurnServers()),this.syncApi&&(w.logger.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop());try{yield this.getVersions();const{threads:ie,list:se,fwdPagination:le}=yield this.doesServerSupportThread();H.Thread.setServerSideSupport(ie),H.Thread.setServerSideListSupport(se),H.Thread.setServerSideFwdPaginationSupport(le)}catch(ie){w.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",ie)}this.clientOpts=N??{},this.clientOpts.slidingSync?this.syncApi=new ue.SlidingSyncSdk(this.clientOpts.slidingSync,this,this.clientOpts,this.buildSyncApiOptions()):this.syncApi=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions()),this.clientOpts.hasOwnProperty("experimentalThreadSupport")&&w.logger.warn("`experimentalThreadSupport` has been deprecated, use `threadSupport` instead"),!this.clientOpts.hasOwnProperty("threadSupport")&&this.clientOpts.hasOwnProperty("experimentalThreadSupport")&&(this.clientOpts.threadSupport=this.clientOpts.experimentalThreadSupport),this.syncApi.sync(),this.clientOpts.clientWellKnownPollPeriod!==void 0&&(this.clientWellKnownIntervalID=setInterval(()=>{this.fetchClientWellKnown()},1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown()),this.toDeviceMessageQueue.start()})}buildSyncApiOptions(){return{crypto:this.crypto,cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:N=>this.canResetTimelineCallback?this.canResetTimelineCallback(N):!1}}stopClient(){var N,Z,ie,se,le;(N=this.cryptoBackend)===null||N===void 0||N.stop(),this.clientRunning&&(w.logger.log("stopping MatrixClient"),this.clientRunning=!1,(Z=this.syncApi)===null||Z===void 0||Z.stop(),this.syncApi=void 0,(ie=this.peekSync)===null||ie===void 0||ie.stopPeeking(),(se=this.callEventHandler)===null||se===void 0||se.stop(),(le=this.groupCallEventHandler)===null||le===void 0||le.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,u.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&u.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop())}rehydrateDevice(){return c(this,void 0,void 0,function*(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const N=yield this.getDehydratedDevice();if(!N)return;if(!N.device_data||!N.device_id){w.logger.info("no dehydrated device found");return}const Z=new u.Olm.Account;try{const ie=N.device_data;if(ie.algorithm!==D.DEHYDRATION_ALGORITHM){w.logger.warn("Wrong algorithm for dehydrated device");return}w.logger.log("unpickling dehydrated device");const se=yield this.cryptoCallbacks.getDehydrationKey(ie,ge=>{Z.unpickle(new Uint8Array(ge),ie.account)});if(Z.unpickle(se,ie.account),w.logger.log("unpickled device"),(yield this.http.authedRequest(A.Method.Post,"/dehydrated_device/claim",void 0,{device_id:N.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=N.device_id,w.logger.info("using dehydrated device");const ge=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:Z.pickle(ge),sessions:[],pickleKey:ge},Z.free(),this.deviceId}else{Z.free(),w.logger.info("not using dehydrated device");return}}catch(ie){Z.free(),w.logger.warn("could not unpickle",ie)}})}getDehydratedDevice(){return c(this,void 0,void 0,function*(){try{return yield this.http.authedRequest(A.Method.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(N){w.logger.info("could not get dehydrated device",N);return}})}setDehydrationKey(N,Z,ie){return c(this,void 0,void 0,function*(){if(!this.crypto){w.logger.warn("not dehydrating device if crypto is not enabled");return}return this.crypto.dehydrationManager.setKeyAndQueueDehydration(N,Z,ie)})}createDehydratedDevice(N,Z,ie){return c(this,void 0,void 0,function*(){if(!this.crypto){w.logger.warn("not dehydrating device if crypto is not enabled");return}return yield this.crypto.dehydrationManager.setKey(N,Z,ie),this.crypto.dehydrationManager.dehydrateDevice()})}exportDevice(){return c(this,void 0,void 0,function*(){if(!this.crypto){w.logger.warn("not exporting device if crypto is not enabled");return}return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:yield this.crypto.olmDevice.export()}})}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const N=[];N.push(this.store.deleteAllData()),this.cryptoStore&&N.push(this.cryptoStore.deleteAllData());const Z=()=>c(this,void 0,void 0,function*(){let ie;try{ie=u.indexedDB}catch{return}for(const se of[`${ne.RUST_SDK_STORE_PREFIX}::matrix-sdk-crypto`,`${ne.RUST_SDK_STORE_PREFIX}::matrix-sdk-crypto-meta`])yield new Promise((ge,be)=>{w.logger.info(`Removing IndexedDB instance ${se}`);const Se=ie.deleteDatabase(se);Se.onsuccess=_e=>{w.logger.info(`Removed IndexedDB instance ${se}`),ge(0)},Se.onerror=_e=>{w.logger.warn(`Failed to remove IndexedDB instance ${se}:`,_e),ge(0)},Se.onblocked=_e=>{w.logger.info(`cannot yet remove IndexedDB instance ${se}`)}})});return N.push(Z()),Promise.all(N).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getSafeUserId(){const N=this.getUserId();if(!N)throw new Error("Expected logged in user but found none.");return N}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(N){this.forceTURN=N}setSupportsCallTransfer(N){this.supportsCallTransfer=N}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(N){return(0,a.createNewMatrixCall)(this,N)}createGroupCall(N,Z,ie,se,le,ge){return c(this,void 0,void 0,function*(){if(this.getGroupCallForRoom(N))throw new Error(`${N} already has an existing group call`);const be=this.getRoom(N);if(!be)throw new Error(`Cannot find room ${N}`);return new de.GroupCall(this,be,Z,ie,se,void 0,le||this.isVoipWithNoMediaAllowed,ge,this.isVoipWithNoMediaAllowed).create()})}waitUntilRoomReadyForGroupCalls(N){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(N)}getGroupCallForRoom(N){return this.groupCallEventHandler.groupCalls.get(N)||null}getSyncState(){var N,Z;return(Z=(N=this.syncApi)===null||N===void 0?void 0:N.getSyncState())!==null&&Z!==void 0?Z:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const N=this.getSyncState();return N?N===h.SyncState.Prepared||N===h.SyncState.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(N){this.isGuestAccount=N}getScheduler(){return this.scheduler}retryImmediately(){var N,Z;return this.toDeviceMessageQueue.sendQueue(),(Z=(N=this.syncApi)===null||N===void 0?void 0:N.retryImmediately())!==null&&Z!==void 0?Z:!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(N){this.notifTimelineSet=N}getCapabilities(N=!1){const Z=new Date().getTime();return this.cachedCapabilities&&!N&&Z<this.cachedCapabilities.expiration?(w.logger.log("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(A.Method.Get,"/capabilities").catch(ie=>(w.logger.error(ie),{})).then((ie={})=>{const se=ie.capabilities||{},le=Object.keys(se).length?ce:6e4+Math.random()*5e3;return this.cachedCapabilities={capabilities:se,expiration:Z+le},w.logger.log("Caching capabilities: ",se),se})}initCrypto(){return c(this,void 0,void 0,function*(){if(!(0,W.isCryptoAvailable)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.cryptoBackend){w.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");w.logger.log("Crypto: Starting up crypto store..."),yield this.cryptoStore.startup(),w.logger.log("Crypto: initialising roomlist..."),yield this.roomList.init();const N=this.getUserId();if(N===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(this.deviceId===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const Z=new W.Crypto(this,N,this.deviceId,this.store,this.cryptoStore,this.roomList,this.verificationMethods);this.reEmitter.reEmit(Z,[W.CryptoEvent.KeyBackupFailed,W.CryptoEvent.KeyBackupSessionsRemaining,W.CryptoEvent.RoomKeyRequest,W.CryptoEvent.RoomKeyRequestCancellation,W.CryptoEvent.Warning,W.CryptoEvent.DevicesUpdated,W.CryptoEvent.WillUpdateDevices,W.CryptoEvent.DeviceVerificationChanged,W.CryptoEvent.UserTrustStatusChanged,W.CryptoEvent.KeysChanged]),w.logger.log("Crypto: initialising crypto object..."),yield Z.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=W.Crypto.getOlmVersion(),Z.registerEventHandlers(this),this.cryptoBackend=this.crypto=Z,this.crypto.uploadDeviceKeys().catch(ie=>{w.logger.error("Error uploading device keys",ie)})})}initRustCrypto(){return c(this,void 0,void 0,function*(){if(this.cryptoBackend){w.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}const N=this.getUserId();if(N===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");const Z=this.getDeviceId();if(Z===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const se=yield(yield Promise.resolve().then(()=>y(t("./rust-crypto")))).initRustCrypto(this.http,N,Z);this.cryptoBackend=se,this.on(B.RoomMemberEvent.Membership,se.onRoomMembership.bind(se))})}getCrypto(){return this.cryptoBackend}isCryptoEnabled(){return!!this.cryptoBackend}getDeviceEd25519Key(){var N,Z;return(Z=(N=this.crypto)===null||N===void 0?void 0:N.getDeviceEd25519Key())!==null&&Z!==void 0?Z:null}getDeviceCurve25519Key(){var N,Z;return(Z=(N=this.crypto)===null||N===void 0?void 0:N.getDeviceCurve25519Key())!==null&&Z!==void 0?Z:null}uploadKeys(){return c(this,void 0,void 0,function*(){w.logger.warn("MatrixClient.uploadKeys is deprecated")})}downloadKeys(N,Z){return this.crypto?this.crypto.downloadKeys(N,Z):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(N)||[]}getStoredDevice(N,Z){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(N,Z)||null}setDeviceVerified(N,Z,ie=!0){const se=this.setDeviceVerification(N,Z,ie,null,null);return N==this.credentials.userId&&this.checkKeyBackup(),se}setDeviceBlocked(N,Z,ie=!0){return this.setDeviceVerification(N,Z,null,ie,null)}setDeviceKnown(N,Z,ie=!0){return this.setDeviceVerification(N,Z,null,null,ie)}setDeviceVerification(N,Z,ie,se,le){return c(this,void 0,void 0,function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");yield this.crypto.setDeviceVerification(N,Z,ie,se,le)})}requestVerificationDM(N,Z){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(N,Z)}findVerificationRequestDMInProgress(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(N)}getVerificationRequestsToDeviceInProgress(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(N)}requestVerification(N,Z){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(N,Z)}beginKeyVerification(N,Z,ie){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(N,Z,ie)}checkSecretStorageKey(N,Z){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStorageKey(N,Z)}setGlobalBlacklistUnverifiedDevices(N){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices=N,N}getGlobalBlacklistUnverifiedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(N){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.globalErrorOnUnknownDevices=N}getGlobalErrorOnUnknownDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalErrorOnUnknownDevices}getCrossSigningId(N=j.CrossSigningKey.Master){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(N)}getStoredCrossSigningForUser(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredCrossSigningForUser(N)}checkUserTrust(N){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkUserTrust(N)}checkDeviceTrust(N,Z){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkDeviceTrust(N,Z)}checkIfOwnDeviceCrossSigned(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(N)}checkOwnCrossSigningTrust(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkOwnCrossSigningTrust(N)}checkCrossSigningPrivateKey(N,Z){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(N,Z)}legacyDeviceVerification(N,Z,ie){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(N,Z,ie)}prepareToEncrypt(N){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.prepareToEncrypt(N)}userHasCrossSigningKeys(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.userHasCrossSigningKeys()}isCrossSigningReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isCrossSigningReady()}bootstrapCrossSigning(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapCrossSigning(N)}getCryptoTrustCrossSignedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCryptoTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.setCryptoTrustCrossSignedDevices(N)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(N){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getEventEncryptionInfo(N)}createRecoveryKeyFromPassphrase(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.createRecoveryKeyFromPassphrase(N)}isSecretStorageReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStorageReady()}bootstrapSecretStorage(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapSecretStorage(N)}addSecretStorageKey(N,Z,ie){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.addSecretStorageKey(N,Z,ie)}hasSecretStorageKey(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.hasSecretStorageKey(N)}storeSecret(N,Z,ie){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.storeSecret(N,Z,ie)}getSecret(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getSecret(N)}isSecretStored(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStored(N)}requestSecret(N,Z){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(N,Z)}getDefaultSecretStorageKeyId(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getDefaultSecretStorageKeyId()}setDefaultSecretStorageKeyId(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setDefaultSecretStorageKeyId(N)}checkSecretStoragePrivateKey(N,Z){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(N,Z)}getEventSenderDeviceInfo(N){return c(this,void 0,void 0,function*(){return this.crypto?this.crypto.getEventSenderDeviceInfo(N):null})}isEventSenderVerified(N){return c(this,void 0,void 0,function*(){const Z=yield this.getEventSenderDeviceInfo(N);return Z?Z.isVerified():!1})}getOutgoingRoomKeyRequest(N){if(!this.crypto)throw new Error("End-to-End encryption disabled");const Z=N.getWireContent(),ie={session_id:Z.session_id,sender_key:Z.sender_key,algorithm:Z.algorithm,room_id:N.getRoomId()};return!ie.session_id||!ie.sender_key||!ie.algorithm||!ie.room_id?Promise.resolve(null):this.crypto.cryptoStore.getOutgoingRoomKeyRequest(ie)}cancelAndResendEventRoomKeyRequest(N){if(!this.crypto)throw new Error("End-to-End encryption disabled");return N.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(N,Z){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(N,Z)}isRoomEncrypted(N){const Z=this.getRoom(N);return Z?Z.currentState.getStateEvents(R.EventType.RoomEncryption,"")?!0:this.roomList.isRoomEncrypted(N):!1}encryptAndSendToDevices(N,Z){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(N,Z)}forceDiscardSession(N){if(!this.cryptoBackend)throw new Error("End-to-End encryption disabled");this.cryptoBackend.forceDiscardSession(N)}exportRoomKeys(){return this.cryptoBackend?this.cryptoBackend.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(N,Z){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.importRoomKeys(N,Z)}checkKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.checkKeyBackup()}getKeyBackupVersion(){return c(this,void 0,void 0,function*(){let N;try{N=yield this.http.authedRequest(A.Method.Get,"/room_keys/version",void 0,void 0,{prefix:A.ClientPrefix.V3})}catch(Z){if(Z.errcode==="M_NOT_FOUND")return null;throw Z}return x.BackupManager.checkBackupVersion(N),N})}isKeyBackupTrusted(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.isKeyBackupTrusted(N)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(N){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(N)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}prepareKeyBackupVersion(N,Z={secureSecretStorage:!1}){return c(this,void 0,void 0,function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:ie,auth_data:se,recovery_key:le,privateKey:ge}=yield this.crypto.backupManager.prepareKeyBackupVersion(N);return Z.secureSecretStorage&&(yield this.storeSecret("m.megolm_backup.v1",(0,p.encodeBase64)(ge)),w.logger.info("Key backup private key stored in secret storage")),{algorithm:ie,auth_data:se,recovery_key:le}})}isKeyBackupKeyStored(){return Promise.resolve(this.isSecretStored("m.megolm_backup.v1"))}createKeyBackupVersion(N){return c(this,void 0,void 0,function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");yield this.crypto.backupManager.createKeyBackupVersion(N);const Z={algorithm:N.algorithm,auth_data:N.auth_data};yield this.crypto.signObject(Z.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&(yield this.crypto.crossSigningInfo.signObject(Z.auth_data,"master"));const ie=yield this.http.authedRequest(A.Method.Post,"/room_keys/version",void 0,Z,{prefix:A.ClientPrefix.V3});return yield this.checkKeyBackup(),this.getKeyBackupEnabled()||w.logger.error("Key backup not usable even though we just created it"),ie})}deleteKeyBackupVersion(N){return c(this,void 0,void 0,function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.version&&this.crypto.backupManager.disableKeyBackup();const Z=r.encodeUri("/room_keys/version/$version",{$version:N});yield this.http.authedRequest(A.Method.Delete,Z,void 0,void 0,{prefix:A.ClientPrefix.V3})})}makeKeyBackupPath(N,Z,ie){let se;return Z!==void 0?se=r.encodeUri("/room_keys/keys/$roomId/$sessionId",{$roomId:N,$sessionId:Z}):N!==void 0?se=r.encodeUri("/room_keys/keys/$roomId",{$roomId:N}):se="/room_keys/keys",{path:se,queryData:ie===void 0?void 0:{version:ie}}}sendKeyBackup(N,Z,ie,se){return c(this,void 0,void 0,function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");const le=this.makeKeyBackupPath(N,Z,ie);yield this.http.authedRequest(A.Method.Put,le.path,le.queryData,se,{prefix:A.ClientPrefix.V3})})}scheduleAllGroupSessionsForBackup(){return c(this,void 0,void 0,function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");yield this.crypto.backupManager.scheduleAllGroupSessionsForBackup()})}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(N){try{return(0,ee.decodeRecoveryKey)(N),!0}catch{return!1}}keyBackupKeyFromPassword(N,Z){return(0,F.keyFromAuthData)(Z.auth_data,N)}keyBackupKeyFromRecoveryKey(N){return(0,ee.decodeRecoveryKey)(N)}restoreKeyBackupWithPassword(N,Z,ie,se,le){return c(this,void 0,void 0,function*(){const ge=yield(0,F.keyFromAuthData)(se.auth_data,N);return this.restoreKeyBackup(ge,Z,ie,se,le)})}restoreKeyBackupWithSecretStorage(N,Z,ie,se){return c(this,void 0,void 0,function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");const le=yield this.getSecret("m.megolm_backup.v1"),ge=(0,W.fixBackupKey)(le);if(ge){const Se=yield this.crypto.getSecretStorageKey();yield this.storeSecret("m.megolm_backup.v1",ge,[Se[0]])}const be=(0,p.decodeBase64)(ge||le);return this.restoreKeyBackup(be,Z,ie,N,se)})}restoreKeyBackupWithRecoveryKey(N,Z,ie,se,le){const ge=(0,ee.decodeRecoveryKey)(N);return this.restoreKeyBackup(ge,Z,ie,se,le)}restoreKeyBackupWithCache(N,Z,ie,se){return c(this,void 0,void 0,function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");const le=yield this.crypto.getSessionBackupPrivateKey();if(!le)throw new Error("Couldn't get key");return this.restoreKeyBackup(le,N,Z,ie,se)})}restoreKeyBackup(N,Z,ie,se,le){return c(this,void 0,void 0,function*(){const ge=le==null?void 0:le.cacheCompleteCallback,be=le==null?void 0:le.progressCallback;if(!this.crypto)throw new Error("End-to-end encryption disabled");let Se=0,_e=[];const Re=this.makeKeyBackupPath(Z,ie,se.version),Ie=yield x.BackupManager.makeAlgorithm(se,()=>c(this,void 0,void 0,function*(){return N})),Ce=Ie.untrusted;try{if(!(yield Ie.keyMatches(N)))return Promise.reject(new A.MatrixError({errcode:Ee.RESTORE_BACKUP_ERROR_BAD_KEY}));this.crypto.storeSessionBackupPrivateKey(N).catch(Ae=>{w.logger.warn("Error caching session backup key:",Ae)}).then(ge),be&&be({stage:"fetch"});const Me=yield this.http.authedRequest(A.Method.Get,Re.path,Re.queryData,void 0,{prefix:A.ClientPrefix.V3});if(Me.rooms){const Ae=Me.rooms;for(const[ke,xe]of Object.entries(Ae)){if(!xe.sessions)continue;Se+=Object.keys(xe.sessions).length;const Pe=yield Ie.decryptSessions(xe.sessions);for(const De of Pe)De.room_id=ke,_e.push(De)}}else if(Me.sessions){const Ae=Me.sessions;Se=Object.keys(Ae).length,_e=yield Ie.decryptSessions(Ae);for(const ke of _e)ke.room_id=Z}else{Se=1;try{const[Ae]=yield Ie.decryptSessions({[ie]:Me});Ae.room_id=Z,Ae.session_id=ie,_e.push(Ae)}catch(Ae){w.logger.log("Failed to decrypt megolm session from backup",Ae)}}}finally{Ie.free()}return yield this.importRoomKeys(_e,{progressCallback:be,untrusted:Ce,source:"backup"}),yield this.checkKeyBackup(),{total:Se,imported:_e.length}})}deleteKeysFromBackup(N,Z,ie){return c(this,void 0,void 0,function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");const se=this.makeKeyBackupPath(N,Z,ie);yield this.http.authedRequest(A.Method.Delete,se.path,se.queryData,void 0,{prefix:A.ClientPrefix.V3})})}sendSharedHistoryKeys(N,Z){return c(this,void 0,void 0,function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");const ie=this.roomList.getRoomEncryption(N);if(!ie){w.logger.error("Unknown room.  Not sharing decryption keys");return}const se=yield this.crypto.downloadKeys(Z),le=new Map;for(const[be,Se]of se)le.set(be,Array.from(Se.values()));const ge=this.crypto.getRoomDecryptor(N,ie.algorithm);ge.sendSharedHistoryInboundSessions?yield ge.sendSharedHistoryInboundSessions(le):w.logger.warn("Algorithm does not support sharing previous keys",ie.algorithm)})}getMediaConfig(){return this.http.authedRequest(A.Method.Get,"/config",void 0,void 0,{prefix:A.MediaPrefix.R0})}getRoom(N){return N?this.store.getRoom(N):null}getRooms(){return this.store.getRooms()}getVisibleRooms(N=!1){var Z;const ie=this.store.getRooms(),se=new Set;for(const le of ie){const ge=(Z=le.findPredecessor(N))===null||Z===void 0?void 0:Z.roomId;ge&&se.add(ge)}return ie.filter(le=>!(le.currentState.getStateEvents(R.EventType.RoomTombstone,"")&&se.has(le.roomId)))}getUser(N){return this.store.getUser(N)}getUsers(){return this.store.getUsers()}setAccountData(N,Z){const ie=r.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:N});return(0,A.retryNetworkOperation)(5,()=>this.http.authedRequest(A.Method.Put,ie,void 0,Z))}getAccountData(N){return this.store.getAccountData(N)}getAccountDataFromServer(N){var Z;return c(this,void 0,void 0,function*(){if(this.isInitialSyncComplete()){const se=this.store.getAccountData(N);return se?se.getContent():null}const ie=r.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:N});try{return yield this.http.authedRequest(A.Method.Get,ie)}catch(se){if(((Z=se.data)===null||Z===void 0?void 0:Z.errcode)==="M_NOT_FOUND")return null;throw se}})}deleteAccountData(N){return c(this,void 0,void 0,function*(){const Z=this.canSupport.get(J.Feature.AccountDataDeletion);if(Z===J.ServerSupport.Unsupported){yield this.setAccountData(N,{});return}const ie=r.encodeUri("/user/$userId/account_data/$type",{$userId:this.getSafeUserId(),$type:N}),se=Z===J.ServerSupport.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield this.http.authedRequest(A.Method.Delete,ie,void 0,void 0,se)})}getIgnoredUsers(){const N=this.getAccountData("m.ignored_user_list");return!N||!N.getContent()||!N.getContent().ignored_users?[]:Object.keys(N.getContent().ignored_users)}setIgnoredUsers(N){const Z={ignored_users:{}};return N.forEach(ie=>{Z.ignored_users[ie]={}}),this.setAccountData("m.ignored_user_list",Z)}isUserIgnored(N){return this.getIgnoredUsers().includes(N)}joinRoom(N,Z={}){return c(this,void 0,void 0,function*(){Z.syncRoom===void 0&&(Z.syncRoom=!0);const ie=this.getRoom(N);if(ie!=null&&ie.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(ie);let se=Promise.resolve();if(Z.inviteSignUrl){const ge=new URL(Z.inviteSignUrl);ge.searchParams.set("mxid",this.credentials.userId),se=this.http.requestOtherUrl(A.Method.Post,ge)}const le={};Z.viaServers&&(le.server_name=Z.viaServers);try{const ge={},be=yield se;be&&(ge.third_party_signed=be);const Se=r.encodeUri("/join/$roomid",{$roomid:N}),Re=(yield this.http.authedRequest(A.Method.Post,Se,le,ge)).room_id,Ce=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions()).createRoom(Re);return Z.syncRoom,Ce}catch(ge){throw ge}})}resendEvent(N,Z){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(Z,N,d.EventStatus.SENDING),this.encryptAndSendEvent(Z,N)}cancelPendingEvent(N){if(![d.EventStatus.QUEUED,d.EventStatus.NOT_SENT,d.EventStatus.ENCRYPTING].includes(N.status))throw new Error("cannot cancel an event with status "+N.status);N.status===d.EventStatus.ENCRYPTING?this.pendingEventEncryption.delete(N.getId()):this.scheduler&&N.status===d.EventStatus.QUEUED&&this.scheduler.removeEventFromQueue(N);const Z=this.getRoom(N.getRoomId());this.updatePendingEventStatus(Z,N,d.EventStatus.CANCELLED)}setRoomName(N,Z){return this.sendStateEvent(N,R.EventType.RoomName,{name:Z})}setRoomTopic(N,Z,ie){const se=Y.makeTopicContent(Z,ie);return this.sendStateEvent(N,R.EventType.RoomTopic,se)}getRoomTags(N){const Z=r.encodeUri("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:N});return this.http.authedRequest(A.Method.Get,Z)}setRoomTag(N,Z,ie){const se=r.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:N,$tag:Z});return this.http.authedRequest(A.Method.Put,se,void 0,ie)}deleteRoomTag(N,Z){const ie=r.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:N,$tag:Z});return this.http.authedRequest(A.Method.Delete,ie)}setRoomAccountData(N,Z,ie){const se=r.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:N,$type:Z});return this.http.authedRequest(A.Method.Put,se,void 0,ie)}setPowerLevel(N,Z,ie,se){let le={users:{}};(se==null?void 0:se.getType())===R.EventType.RoomPowerLevels&&(le=r.deepCopy(se.getContent()));const ge=Array.isArray(Z)?Z:[Z];for(const Se of ge)ie==null?delete le.users[Se]:le.users[Se]=ie;const be=r.encodeUri("/rooms/$roomId/state/m.room.power_levels",{$roomId:N});return this.http.authedRequest(A.Method.Put,be,void 0,le)}unstable_createLiveBeacon(N,Z){return c(this,void 0,void 0,function*(){return this.unstable_setLiveBeacon(N,Z)})}unstable_setLiveBeacon(N,Z){return c(this,void 0,void 0,function*(){return this.sendStateEvent(N,G.M_BEACON_INFO.name,Z,this.getUserId())})}sendEvent(N,Z,ie,se,le){var ge,be,Se,_e,Re;let Ie,Ce,Me,Ae;if(!(Z!=null&&Z.startsWith(fe))&&Z!==null?(Ae=se,Me=ie,Ce=Z,Ie=null):(Ae=le,Me=se,Ce=ie,Ie=Z),Ie&&!(!((ge=Me["m.relates_to"])===null||ge===void 0)&&ge.rel_type)){const ke=!!(!((be=Me["m.relates_to"])===null||be===void 0)&&be["m.in_reply_to"]);Me["m.relates_to"]=Object.assign(Object.assign({},Me["m.relates_to"]),{rel_type:H.THREAD_RELATION_TYPE.name,event_id:Ie,is_falling_back:!ke});const xe=(Se=this.getRoom(N))===null||Se===void 0?void 0:Se.getThread(Ie);xe&&!ke&&(Me["m.relates_to"]["m.in_reply_to"]={event_id:(Re=(_e=xe.lastReply(Pe=>Pe.isRelation(H.THREAD_RELATION_TYPE.name)&&!Pe.status))===null||_e===void 0?void 0:_e.getId())!==null&&Re!==void 0?Re:Ie})}return this.sendCompleteEvent(N,Ie,{type:Ce,content:Me},Ae)}sendCompleteEvent(N,Z,ie,se){se||(se=this.makeTxnId());const le=new d.MatrixEvent(Object.assign(ie,{event_id:"~"+N+":"+se,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:N,origin_server_ts:new Date().getTime()})),ge=this.getRoom(N),be=Z?ge==null?void 0:ge.getThread(Z):void 0;be&&le.setThread(be),this.reEmitter.reEmit(le,[d.MatrixEventEvent.Replaced,d.MatrixEventEvent.VisibilityChange]),ge==null||ge.reEmitter.reEmit(le,[d.MatrixEventEvent.BeforeRedaction]);const Se=le.getAssociatedId();if(Se!=null&&Se.startsWith("~")){const Re=ge==null?void 0:ge.getPendingEvents().find(Ie=>Ie.getId()===Se);Re==null||Re.once(d.MatrixEventEvent.LocalEventIdReplaced,()=>{le.updateAssociatedId(Re.getId())})}const _e=le.getType();return w.logger.log(`sendEvent of type ${_e} in ${N} with txnId ${se}`),le.setTxnId(se),le.setStatus(d.EventStatus.SENDING),ge==null||ge.addPendingEvent(le,se),le.status===d.EventStatus.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(ge,le)}encryptAndSendEvent(N,Z){let ie=!1;return Promise.resolve().then(()=>{const se=this.encryptEventIfNeeded(Z,N??void 0);return se?(this.pendingEventEncryption.set(Z.getId(),se),this.updatePendingEventStatus(N,Z,d.EventStatus.ENCRYPTING),se.then(()=>{if(!this.pendingEventEncryption.has(Z.getId())){ie=!0;return}this.updatePendingEventStatus(N,Z,d.EventStatus.SENDING)})):null}).then(()=>{if(ie)return{};let se=null;return this.scheduler&&(se=this.scheduler.queueEvent(Z),se&&this.scheduler.getQueueForEvent(Z).length>1&&this.updatePendingEventStatus(N,Z,d.EventStatus.QUEUED)),se||(se=this.sendEventHttpRequest(Z),N&&(se=se.then(le=>(N.updatePendingEvent(Z,d.EventStatus.SENT,le.event_id),le)))),se}).catch(se=>{w.logger.error("Error sending event",se.stack||se);try{Z.error=se,this.updatePendingEventStatus(N,Z,d.EventStatus.NOT_SENT)}catch(le){w.logger.error("Exception in error handler!",le.stack||se)}throw se instanceof A.MatrixError&&(se.event=Z),se})}encryptEventIfNeeded(N,Z){if(N.isEncrypted()||N.isRedaction()||!Z||!this.isRoomEncrypted(N.getRoomId())||!this.cryptoBackend&&this.usingExternalCrypto||N.getType()===R.EventType.Reaction)return null;if(!this.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return this.cryptoBackend.encryptEvent(N,Z)}getEncryptedIfNeededEventType(N,Z){return Z===R.EventType.Reaction?Z:this.isRoomEncrypted(N)?R.EventType.RoomMessageEncrypted:Z}updatePendingEventStatus(N,Z,ie){N?N.updatePendingEvent(Z,ie):Z.setStatus(ie)}sendEventHttpRequest(N){let Z=N.getTxnId();Z||(Z=this.makeTxnId(),N.setTxnId(Z));const ie={$roomId:N.getRoomId(),$eventType:N.getWireType(),$stateKey:N.getStateKey(),$txnId:Z};let se;if(N.isState()){let le="/rooms/$roomId/state/$eventType";N.getStateKey()&&N.getStateKey().length>0&&(le="/rooms/$roomId/state/$eventType/$stateKey"),se=r.encodeUri(le,ie)}else if(N.isRedaction()){const le="/rooms/$roomId/redact/$redactsEventId/$txnId";se=r.encodeUri(le,Object.assign({$redactsEventId:N.event.redacts},ie))}else se=r.encodeUri("/rooms/$roomId/send/$eventType/$txnId",ie);return this.http.authedRequest(A.Method.Put,se,void 0,N.getWireContent()).then(le=>(w.logger.log(`Event sent to ${N.getRoomId()} with event id ${le.event_id}`),le))}redactEvent(N,Z,ie,se,le){ie!=null&&ie.startsWith(fe)||(le=se,se=ie,ie=Z,Z=null);const ge=le==null?void 0:le.reason;if(le!=null&&le.with_relations&&this.canSupport.get(J.Feature.RelationBasedRedactions)===J.ServerSupport.Unsupported)throw new Error(`Server does not support relation based redactions roomId ${N} eventId ${ie} txnId: ${se} threadId ${Z}`);const be=le!=null&&le.with_relations?{[this.canSupport.get(J.Feature.RelationBasedRedactions)===J.ServerSupport.Stable?R.MSC3912_RELATION_BASED_REDACTIONS_PROP.stable:R.MSC3912_RELATION_BASED_REDACTIONS_PROP.unstable]:le==null?void 0:le.with_relations}:{};return this.sendCompleteEvent(N,Z,{type:R.EventType.RoomRedaction,content:Object.assign(Object.assign({},be),{reason:ge}),redacts:ie},se)}sendMessage(N,Z,ie,se){typeof Z!="string"&&Z!==null&&(se=ie,ie=Z,Z=null);const le=R.EventType.RoomMessage,ge=ie;return this.sendEvent(N,Z,le,ge,se)}sendTextMessage(N,Z,ie,se){!(Z!=null&&Z.startsWith(fe))&&Z!==null&&(se=ie,ie=Z,Z=null);const le=Y.makeTextMessage(ie);return this.sendMessage(N,Z,le,se)}sendNotice(N,Z,ie,se){!(Z!=null&&Z.startsWith(fe))&&Z!==null&&(se=ie,ie=Z,Z=null);const le=Y.makeNotice(ie);return this.sendMessage(N,Z,le,se)}sendEmoteMessage(N,Z,ie,se){!(Z!=null&&Z.startsWith(fe))&&Z!==null&&(se=ie,ie=Z,Z=null);const le=Y.makeEmoteMessage(ie);return this.sendMessage(N,Z,le,se)}sendImageMessage(N,Z,ie,se,le="Image"){!(Z!=null&&Z.startsWith(fe))&&Z!==null&&(le=se||"Image",se=ie,ie=Z,Z=null);const ge={msgtype:R.MsgType.Image,url:ie,info:se,body:le};return this.sendMessage(N,Z,ge)}sendStickerMessage(N,Z,ie,se,le="Sticker"){!(Z!=null&&Z.startsWith(fe))&&Z!==null&&(le=se||"Sticker",se=ie,ie=Z,Z=null);const ge={url:ie,info:se,body:le};return this.sendEvent(N,Z,R.EventType.Sticker,ge)}sendHtmlMessage(N,Z,ie,se){!(Z!=null&&Z.startsWith(fe))&&Z!==null&&(se=ie,ie=Z,Z=null);const le=Y.makeHtmlMessage(ie,se);return this.sendMessage(N,Z,le)}sendHtmlNotice(N,Z,ie,se){!(Z!=null&&Z.startsWith(fe))&&Z!==null&&(se=ie,ie=Z,Z=null);const le=Y.makeHtmlNotice(ie,se);return this.sendMessage(N,Z,le)}sendHtmlEmote(N,Z,ie,se){!(Z!=null&&Z.startsWith(fe))&&Z!==null&&(se=ie,ie=Z,Z=null);const le=Y.makeHtmlEmote(ie,se);return this.sendMessage(N,Z,le)}sendReceipt(N,Z,ie,se=!1){return c(this,void 0,void 0,function*(){if(this.isGuest())return Promise.resolve({});const le=r.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:N.getRoomId(),$receiptType:Z,$eventId:N.getId()});if(!se){const Se=!!N.threadRootId;ie=Object.assign(Object.assign({},ie),{thread_id:Se?N.threadRootId:re.MAIN_ROOM_TIMELINE})}const ge=this.http.authedRequest(A.Method.Post,le,void 0,ie||{}),be=this.getRoom(N.getRoomId());return be&&this.credentials.userId&&be.addLocalEchoReceipt(this.credentials.userId,N,Z),ge})}sendReadReceipt(N,Z=re.ReceiptType.Read,ie=!1){return c(this,void 0,void 0,function*(){if(!N)return;const se=N.getId(),le=this.getRoom(N.getRoomId());if(le!=null&&le.hasPendingEvent(se))throw new Error(`Cannot set read receipt to a pending event (${se})`);return this.sendReceipt(N,Z,{},ie)})}setRoomReadMarkers(N,Z,ie,se){return c(this,void 0,void 0,function*(){const le=this.getRoom(N);if(le&&le.hasPendingEvent(Z))throw new Error(`Cannot set read marker to a pending event (${Z})`);let ge;if(ie){if(ge=ie.getId(),le!=null&&le.hasPendingEvent(ge))throw new Error(`Cannot set read receipt to a pending event (${ge})`);le==null||le.addLocalEchoReceipt(this.credentials.userId,ie,re.ReceiptType.Read)}let be;if(se){if(be=se.getId(),le!=null&&le.hasPendingEvent(be))throw new Error(`Cannot set read receipt to a pending event (${be})`);le==null||le.addLocalEchoReceipt(this.credentials.userId,se,re.ReceiptType.ReadPrivate)}return yield this.setRoomReadMarkersHttpRequest(N,Z,ge,be)})}getUrlPreview(N,Z){Z=Math.floor(Z/6e4)*6e4;const ie=new URL(N);ie.hash="",N=ie.toString();const se=Z+"_"+N,le=this.urlPreviewCache[se];if(le)return le;const ge=this.http.authedRequest(A.Method.Get,"/preview_url",{url:N,ts:Z.toString()},void 0,{prefix:A.MediaPrefix.R0});return this.urlPreviewCache[se]=ge,ge}sendTyping(N,Z,ie){if(this.isGuest())return Promise.resolve({});const se=r.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:N,$userId:this.getUserId()}),le={typing:Z};return Z&&(le.timeout=ie||2e4),this.http.authedRequest(A.Method.Put,se,void 0,le)}getRoomUpgradeHistory(N,Z=!1,ie=!1){const se=this.getRoom(N);if(!se)return[];const le=this.findPredecessorRooms(se,Z,ie),ge=this.findSuccessorRooms(se,Z,ie);return[...le,se,...ge]}findPredecessorRooms(N,Z,ie){var se,le;const ge=[];let be=(se=N.findPredecessor(ie))===null||se===void 0?void 0:se.roomId;for(;be!==null;){const Se=this.getRoom(be);if(Se===null)break;if(Z){const _e=Se.currentState.getStateEvents(R.EventType.RoomTombstone,"");if(!_e||_e.getContent().replacement_room!==N.roomId)break}ge.splice(0,0,Se),N=Se,be=(le=N.findPredecessor(ie))===null||le===void 0?void 0:le.roomId}return ge}findSuccessorRooms(N,Z,ie){var se;const le=[];let ge=N.currentState.getStateEvents(R.EventType.RoomTombstone,"");for(;ge;){const be=this.getRoom(ge.getContent().replacement_room);if(!be||be.roomId===N.roomId)break;if(Z){const _e=(se=be.findPredecessor(ie))===null||se===void 0?void 0:se.roomId;if(!_e||_e!==N.roomId)break}if(le.push(be),new Set(le.map(_e=>_e.roomId)).size<le.length)return le.slice(0,le.length-1);N=be,ge=N.currentState.getStateEvents(R.EventType.RoomTombstone,"")}return le}invite(N,Z,ie){return this.membershipChange(N,Z,"invite",ie)}inviteByEmail(N,Z){return this.inviteByThreePid(N,"email",Z)}inviteByThreePid(N,Z,ie){var se;return c(this,void 0,void 0,function*(){const le=r.encodeUri("/rooms/$roomId/invite",{$roomId:N}),ge=this.getIdentityServerUrl(!0);if(!ge)return Promise.reject(new A.MatrixError({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const be={id_server:ge,medium:Z,address:ie};if(!((se=this.identityServer)===null||se===void 0)&&se.getAccessToken&&(yield this.doesServerAcceptIdentityAccessToken())){const Se=yield this.identityServer.getAccessToken();Se&&(be.id_access_token=Se)}return this.http.authedRequest(A.Method.Post,le,void 0,be)})}leave(N){return this.membershipChange(N,void 0,"leave")}leaveRoomChain(N,Z=!0){const ie=this.getRoomUpgradeHistory(N);let se=ie;if(!Z){se=[];for(const Se of ie)if(se.push(Se),Se.roomId===N)break}const le={},ge=[],be=Se=>this.leave(Se).then(()=>{delete le[Se]}).catch(_e=>{le[Se]=_e});for(const Se of se)ge.push(be(Se.roomId));return Promise.all(ge).then(()=>le)}ban(N,Z,ie){return this.membershipChange(N,Z,"ban",ie)}forget(N,Z=!0){const ie=this.membershipChange(N,void 0,"forget");return Z?ie.then(se=>(this.store.removeRoom(N),this.emit(ve.DeleteRoom,N),se)):ie}unban(N,Z){const ie=r.encodeUri("/rooms/$roomId/unban",{$roomId:N}),se={user_id:Z};return this.http.authedRequest(A.Method.Post,ie,void 0,se)}kick(N,Z,ie){const se=r.encodeUri("/rooms/$roomId/kick",{$roomId:N}),le={user_id:Z,reason:ie};return this.http.authedRequest(A.Method.Post,se,void 0,le)}membershipChange(N,Z,ie,se){const le=r.encodeUri("/rooms/$room_id/$membership",{$room_id:N,$membership:ie});return this.http.authedRequest(A.Method.Post,le,void 0,{user_id:Z,reason:se})}getPushActionsForEvent(N,Z=!1){return(!N.getPushActions()||Z)&&N.setPushActions(this.pushProcessor.actionsForEvent(N)),N.getPushActions()}setProfileInfo(N,Z){const ie=r.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:N});return this.http.authedRequest(A.Method.Put,ie,void 0,Z)}setDisplayName(N){return c(this,void 0,void 0,function*(){const Z=yield this.setProfileInfo("displayname",{displayname:N}),ie=this.getUser(this.getUserId());return ie&&(ie.displayName=N,ie.emit(C.UserEvent.DisplayName,ie.events.presence,ie)),Z})}setAvatarUrl(N){return c(this,void 0,void 0,function*(){const Z=yield this.setProfileInfo("avatar_url",{avatar_url:N}),ie=this.getUser(this.getUserId());return ie&&(ie.avatarUrl=N,ie.emit(C.UserEvent.AvatarUrl,ie.events.presence,ie)),Z})}mxcUrlToHttp(N,Z,ie,se,le){return(0,O.getHttpUriForMxc)(this.baseUrl,N,Z,ie,se,le)}setPresence(N){return c(this,void 0,void 0,function*(){const Z=r.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});if(["offline","online","unavailable"].indexOf(N.presence)===-1)throw new Error("Bad presence value: "+N.presence);yield this.http.authedRequest(A.Method.Put,Z,void 0,N)})}getPresence(N){const Z=r.encodeUri("/presence/$userId/status",{$userId:N});return this.http.authedRequest(A.Method.Get,Z)}scrollback(N,Z=30){let ie=0,se=this.ongoingScrollbacks[N.roomId]||{};if(se.promise)return se.promise;if(se.errorTs){const be=Date.now()-se.errorTs;ie=Math.max(oe-be,0)}if(N.oldState.paginationToken===null)return Promise.resolve(N);const le=this.store.scrollback(N,Z).length;if(le===Z)return Promise.resolve(N);Z=Z-le;const ge=new Promise((be,Se)=>{(0,s.sleep)(ie).then(()=>this.createMessagesRequest(N.roomId,N.oldState.paginationToken,Z,o.Direction.Backward)).then(_e=>{var Re,Ie;const Ce=_e.chunk.map(this.getEventMapper());if(_e.state){const ke=_e.state.map(this.getEventMapper());N.currentState.setUnknownStateEvents(ke)}const[Me,Ae]=N.partitionThreadedEvents(Ce);this.processAggregatedTimelineEvents(N,Me),N.addEventsToTimeline(Me,!0,N.getLiveTimeline()),this.processThreadEvents(N,Ae,!0),N.oldState.paginationToken=(Re=_e.end)!==null&&Re!==void 0?Re:null,_e.chunk.length===0&&(N.oldState.paginationToken=null),this.store.storeEvents(N,Ce,(Ie=_e.end)!==null&&Ie!==void 0?Ie:null,!0),delete this.ongoingScrollbacks[N.roomId],be(N)}).catch(_e=>{this.ongoingScrollbacks[N.roomId]={errorTs:Date.now()},Se(_e)})});return se={promise:ge},this.ongoingScrollbacks[N.roomId]=se,ge}getEventMapper(N){return(0,P.eventMapperFor)(this,N||{})}getEventTimeline(N,Z){var ie,se,le,ge;return c(this,void 0,void 0,function*(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(N!=null&&N.room))throw new Error("getEventTimeline only supports room timelines");if(N.getTimelineForEvent(Z))return N.getTimelineForEvent(Z);if(N.thread&&this.supportsThreads())return this.getThreadTimeline(N,Z);const be=r.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:N.room.roomId,$eventId:Z});let Se;!((ie=this.clientOpts)===null||ie===void 0)&&ie.lazyLoadMembers&&(Se={filter:JSON.stringify(n.Filter.LAZY_LOADING_MESSAGES_FILTER)});const _e=yield this.http.authedRequest(A.Method.Get,be,Se);if(!_e.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(N.getTimelineForEvent(Z))return N.getTimelineForEvent(Z);const Re=this.getEventMapper(),Ie=Re(_e.event);if(Ie.isRelation(H.THREAD_RELATION_TYPE.name)){w.logger.warn("Tried loading a regular timeline at the position of a thread event");return}const Ce=[..._e.events_after.reverse().map(Re),Ie,..._e.events_before.map(Re)];let Me=N.getTimelineForEvent(Ce[0].getId());Me?Me.getState(o.EventTimeline.BACKWARDS).setUnknownStateEvents(_e.state.map(Re)):(Me=N.addTimeline(),Me.initialiseState(_e.state.map(Re)),Me.getState(o.EventTimeline.FORWARDS).paginationToken=_e.end);const[Ae,ke]=N.room.partitionThreadedEvents(Ce);return N.addEventsToTimeline(Ae,!0,Me,_e.start),this.processThreadEvents(N.room,ke,!0),this.processAggregatedTimelineEvents(N.room,Ae),(ge=(se=N.getTimelineForEvent(Z))!==null&&se!==void 0?se:(le=N.room.findThreadForEvent(Ie))===null||le===void 0?void 0:le.liveTimeline)!==null&&ge!==void 0?ge:Me})}getThreadTimeline(N,Z){var ie,se,le,ge,be,Se,_e,Re;return c(this,void 0,void 0,function*(){if(!this.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!N.room)throw new Error("could not get thread timeline: not a room timeline");if(!N.thread)throw new Error("could not get thread timeline: not a thread timeline");const Ie=r.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:N.room.roomId,$eventId:Z}),Ce={limit:"0"};!((ie=this.clientOpts)===null||ie===void 0)&&ie.lazyLoadMembers&&(Ce.filter=JSON.stringify(n.Filter.LAZY_LOADING_MESSAGES_FILTER));const Me=yield this.http.authedRequest(A.Method.Get,Ie,Ce),Ae=this.getEventMapper(),ke=Ae(Me.event);if(N.canContain(ke)&&H.Thread.hasServerSideSupport)if(H.Thread.hasServerSideFwdPaginationSupport){if(!N.thread)throw new Error("could not get thread timeline: not a thread timeline");const xe=N.thread,Pe=yield this.fetchRelations(N.room.roomId,xe.id,H.THREAD_RELATION_TYPE.name,null,{dir:o.Direction.Backward,from:Me.start}),De=yield this.fetchRelations(N.room.roomId,xe.id,H.THREAD_RELATION_TYPE.name,null,{dir:o.Direction.Forward,from:Me.end}),je=[...De.chunk.reverse().map(Ae),ke,...Pe.chunk.map(Ae)];for(const Oe of je)yield(se=N.thread)===null||se===void 0?void 0:se.processEvent(Oe);let Be=N.getTimelineForEvent(ke.getId());if(Be?Be.getState(o.EventTimeline.BACKWARDS).setUnknownStateEvents(Me.state.map(Ae)):(Be=N.addTimeline(),Be.initialiseState(Me.state.map(Ae))),N.addEventsToTimeline(je,!0,Be,De.next_batch),!Pe.next_batch){const Oe=yield this.fetchRoomEvent(N.room.roomId,xe.id);N.addEventsToTimeline([Ae(Oe)],!0,Be,null)}return Be.setPaginationToken((le=Pe.next_batch)!==null&&le!==void 0?le:null,o.Direction.Backward),Be.setPaginationToken((ge=De.next_batch)!==null&&ge!==void 0?ge:null,o.Direction.Forward),this.processAggregatedTimelineEvents(N.room,je),(be=N.getTimelineForEvent(Z))!==null&&be!==void 0?be:Be}else{const xe=N.thread,Pe=yield this.fetchRelations(N.room.roomId,xe.id,H.THREAD_RELATION_TYPE.name,null,{dir:o.Direction.Backward,from:Me.start}),De=[];let je=Me.end;for(;je;){const Ue=yield this.fetchRelations(N.room.roomId,xe.id,H.THREAD_RELATION_TYPE.name,null,{dir:o.Direction.Forward,from:je});je=(Se=Ue.next_batch)!==null&&Se!==void 0?Se:null,De.push(...Ue.chunk)}const Be=[...De.reverse().map(Ae),ke,...Pe.chunk.map(Ae)];for(const Ue of Be)yield(_e=N.thread)===null||_e===void 0?void 0:_e.processEvent(Ue);const Oe=N.getLiveTimeline();if(Oe.getState(o.EventTimeline.BACKWARDS).setUnknownStateEvents(Me.state.map(Ae)),N.addEventsToTimeline(Be,!0,Oe,null),!Pe.next_batch){const Ue=yield this.fetchRoomEvent(N.room.roomId,xe.id);N.addEventsToTimeline([Ae(Ue)],!0,Oe,null)}return Oe.setPaginationToken((Re=Pe.next_batch)!==null&&Re!==void 0?Re:null,o.Direction.Backward),Oe.setPaginationToken(null,o.Direction.Forward),this.processAggregatedTimelineEvents(N.room,Be),Oe}})}getLatestTimeline(N){var Z,ie,se,le;return c(this,void 0,void 0,function*(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!N.room)throw new Error("getLatestTimeline only supports room timelines");let ge;if(N.threadListType!==null)ge=(Z=(yield this.createThreadListMessagesRequest(N.room.roomId,null,1,o.Direction.Backward,N.threadListType,N.getFilter())).chunk)===null||Z===void 0?void 0:Z[0];else if(N.thread&&H.Thread.hasServerSideSupport)ge=(ie=(yield this.fetchRelations(N.room.roomId,N.thread.id,H.THREAD_RELATION_TYPE.name,null,{dir:o.Direction.Backward,limit:1})).chunk)===null||ie===void 0?void 0:ie[0];else{const be=r.encodeUri("/rooms/$roomId/messages",{$roomId:N.room.roomId}),Se={dir:"b"};!((se=this.clientOpts)===null||se===void 0)&&se.lazyLoadMembers&&(Se.filter=JSON.stringify(n.Filter.LAZY_LOADING_MESSAGES_FILTER)),ge=(le=(yield this.http.authedRequest(A.Method.Get,be,Se)).chunk)===null||le===void 0?void 0:le[0]}if(!ge)throw new Error("No message returned when trying to construct getLatestTimeline");return this.getEventTimeline(N,ge.event_id)})}createMessagesRequest(N,Z,ie=30,se,le){var ge,be;const Se=r.encodeUri("/rooms/$roomId/messages",{$roomId:N}),_e={limit:ie.toString(),dir:se};Z&&(_e.from=Z);let Re=null;return!((ge=this.clientOpts)===null||ge===void 0)&&ge.lazyLoadMembers&&(Re=Object.assign({},n.Filter.LAZY_LOADING_MESSAGES_FILTER)),le&&(Re=Re||{},Object.assign(Re,(be=le.getRoomTimelineFilterComponent())===null||be===void 0?void 0:be.toJSON())),Re&&(_e.filter=JSON.stringify(Re)),this.http.authedRequest(A.Method.Get,Se,_e)}createThreadListMessagesRequest(N,Z,ie=30,se=o.Direction.Backward,le=H.ThreadFilterType.All,ge){var be,Se;const _e=r.encodeUri("/rooms/$roomId/threads",{$roomId:N}),Re={limit:ie.toString(),dir:se,include:(0,H.threadFilterTypeToFilter)(le)};Z&&(Re.from=Z);let Ie={};!((be=this.clientOpts)===null||be===void 0)&&be.lazyLoadMembers&&(Ie=Object.assign({},n.Filter.LAZY_LOADING_MESSAGES_FILTER)),ge&&(Ie=Object.assign(Object.assign({},Ie),(Se=ge.getRoomTimelineFilterComponent())===null||Se===void 0?void 0:Se.toJSON())),Object.keys(Ie).length&&(Re.filter=JSON.stringify(Ie));const Ce={prefix:H.Thread.hasServerSideListSupport===H.FeatureSupport.Stable?"/_matrix/client/v1":"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(A.Method.Get,_e,Re,void 0,Ce).then(Me=>{var Ae;return Object.assign(Object.assign({},Me),{chunk:(Ae=Me.chunk)===null||Ae===void 0?void 0:Ae.reverse(),start:Me.prev_batch,end:Me.next_batch})})}paginateEventTimeline(N,Z){var ie,se,le;const ge=N.getTimelineSet()===this.notifTimelineSet,be=this.getRoom(N.getRoomId()),Se=N.getTimelineSet().threadListType,_e=N.getTimelineSet().thread;Z=Z||{};const Re=Z.backwards||!1;if(ge&&!Re)throw new Error("paginateNotifTimeline can only paginate backwards");const Ie=Re?o.EventTimeline.BACKWARDS:o.EventTimeline.FORWARDS,Ce=N.getPaginationToken(Ie),Me=N.paginationRequests[Ie];if(Me)return Me;let Ae,ke,xe;if(ge)Ae="/notifications",ke={limit:((ie=Z.limit)!==null&&ie!==void 0?ie:30).toString(),only:"highlight"},Ce&&Ce!=="end"&&(ke.from=Ce),xe=this.http.authedRequest(A.Method.Get,Ae,ke).then(Pe=>c(this,void 0,void 0,function*(){const De=Pe.next_token,je=[];Pe.notifications=Pe.notifications.filter(s.noUnsafeEventProps);for(let Oe=0;Oe<Pe.notifications.length;Oe++){const Ue=Pe.notifications[Oe],Ve=this.getEventMapper()(Ue.event);Ve.setPushActions(l.PushProcessor.actionListToActionsObject(Ue.actions)),Ve.event.room_id=Ue.room_id,je[Oe]=Ve}const Be=N.getTimelineSet();return Be.addEventsToTimeline(je,Re,N,De),this.processAggregatedTimelineEvents(Be.room,je),Re&&!Pe.next_token&&N.setPaginationToken(null,Ie),!!Pe.next_token})).finally(()=>{N.paginationRequests[Ie]=null}),N.paginationRequests[Ie]=xe;else if(Se!==null){if(!be)throw new Error("Unknown room "+N.getRoomId());if(!H.Thread.hasServerSideFwdPaginationSupport&&Ie===o.Direction.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");xe=this.createThreadListMessagesRequest(N.getRoomId(),Ce,Z.limit,Ie,Se,N.getFilter()).then(Pe=>{if(Pe.state){const Oe=N.getState(Ie),Ue=Pe.state.filter(s.noUnsafeEventProps).map(this.getEventMapper());Oe.setUnknownStateEvents(Ue)}const De=Pe.end,je=Pe.chunk.filter(s.noUnsafeEventProps).map(this.getEventMapper());return N.getTimelineSet().addEventsToTimeline(je,Re,N,De),this.processAggregatedTimelineEvents(be,je),this.processThreadRoots(be,je,Re),Re&&Pe.end==Pe.start&&N.setPaginationToken(null,Ie),Pe.end!==Pe.start}).finally(()=>{N.paginationRequests[Ie]=null}),N.paginationRequests[Ie]=xe}else if(_e){const Pe=this.getRoom((se=N.getRoomId())!==null&&se!==void 0?se:void 0);if(!Pe)throw new Error("Unknown room "+N.getRoomId());xe=this.fetchRelations((le=N.getRoomId())!==null&&le!==void 0?le:"",_e.id,H.THREAD_RELATION_TYPE.name,null,{dir:Ie,limit:Z.limit,from:Ce??void 0}).then(De=>c(this,void 0,void 0,function*(){var je;const Be=this.getEventMapper(),Oe=De.chunk.filter(s.noUnsafeEventProps).map(Be);for(const Ne of Oe.slice().reverse()){yield _e==null?void 0:_e.processEvent(Ne);const Je=Ne.getSender();(!Re||(_e==null?void 0:_e.getEventReadUpTo(Je))===null)&&Pe.addLocalEchoReceipt(Je,Ne,re.ReceiptType.Read)}const Ue=De.next_batch,Ve=N.getTimelineSet();if(Ve.addEventsToTimeline(Oe,Re,N,Ue??null),!Ue&&Re){const Ne=yield this.fetchRoomEvent((je=N.getRoomId())!==null&&je!==void 0?je:"",_e.id);Ve.addEventsToTimeline([Be(Ne)],!0,N,null)}return this.processAggregatedTimelineEvents(Ve.room,Oe),Re&&!Ue&&N.setPaginationToken(null,Ie),!!Ue})).finally(()=>{N.paginationRequests[Ie]=null}),N.paginationRequests[Ie]=xe}else{if(!be)throw new Error("Unknown room "+N.getRoomId());xe=this.createMessagesRequest(N.getRoomId(),Ce,Z.limit,Ie,N.getFilter()).then(Pe=>{if(Pe.state){const Ve=N.getState(Ie),Ne=Pe.state.filter(s.noUnsafeEventProps).map(this.getEventMapper());Ve.setUnknownStateEvents(Ne)}const De=Pe.end,je=Pe.chunk.filter(s.noUnsafeEventProps).map(this.getEventMapper()),Be=N.getTimelineSet(),[Oe]=be.partitionThreadedEvents(je);Be.addEventsToTimeline(Oe,Re,N,De),this.processAggregatedTimelineEvents(be,Oe),this.processThreadRoots(be,Oe.filter(Ve=>Ve.getServerAggregatedRelation(H.THREAD_RELATION_TYPE.name)),!1);const Ue=Pe.end===void 0||Pe.end===Pe.start;return Re&&Ue&&N.setPaginationToken(null,Ie),!Ue}).finally(()=>{N.paginationRequests[Ie]=null}),N.paginationRequests[Ie]=xe}return xe}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(N){var Z;return(Z=this.peekSync)===null||Z===void 0||Z.stopPeeking(),this.peekSync=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(N)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(N,Z){const ie=this.sendStateEvent(N,R.EventType.RoomGuestAccess,{guest_access:Z.allowJoin?"can_join":"forbidden"},"");let se=Promise.resolve(void 0);return Z.allowRead&&(se=this.sendStateEvent(N,R.EventType.RoomHistoryVisibility,{history_visibility:"world_readable"},"")),Promise.all([se,ie]).then()}requestRegisterEmailToken(N,Z,ie,se){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:N,client_secret:Z,send_attempt:ie,next_link:se})}requestRegisterMsisdnToken(N,Z,ie,se,le){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:N,phone_number:Z,client_secret:ie,send_attempt:se,next_link:le})}requestAdd3pidEmailToken(N,Z,ie,se){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:N,client_secret:Z,send_attempt:ie,next_link:se})}requestAdd3pidMsisdnToken(N,Z,ie,se,le){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:N,phone_number:Z,client_secret:ie,send_attempt:se,next_link:le})}requestPasswordEmailToken(N,Z,ie,se){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:N,client_secret:Z,send_attempt:ie,next_link:se})}requestPasswordMsisdnToken(N,Z,ie,se,le){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:N,phone_number:Z,client_secret:ie,send_attempt:se,next_link:le})}requestTokenFromEndpoint(N,Z){var ie;return c(this,void 0,void 0,function*(){const se=Object.assign({},Z);if(!(yield this.doesServerSupportSeparateAddAndBind())&&this.idBaseUrl){const le=new URL(this.idBaseUrl);if(se.id_server=le.host,!((ie=this.identityServer)===null||ie===void 0)&&ie.getAccessToken&&(yield this.doesServerAcceptIdentityAccessToken())){const ge=yield this.identityServer.getAccessToken();ge&&(se.id_access_token=ge)}}return this.http.request(A.Method.Post,N,void 0,se)})}getRoomPushRule(N,Z){var ie,se;if(this.pushRules)return(se=(ie=this.pushRules[N])===null||ie===void 0?void 0:ie.room)===null||se===void 0?void 0:se.find(le=>le.rule_id===Z);throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(N,Z,ie){let se,le=!1;const ge=this.getRoomPushRule(N,Z);if(ge!=null&&ge.actions.includes(ae.PushRuleActionName.DontNotify)&&(le=!0),!ie)le&&(se=this.deletePushRule(N,ae.PushRuleKind.RoomSpecific,ge.rule_id));else if(!ge)se=this.addPushRule(N,ae.PushRuleKind.RoomSpecific,Z,{actions:[ae.PushRuleActionName.DontNotify]});else if(!le){const be=r.defer();this.deletePushRule(N,ae.PushRuleKind.RoomSpecific,ge.rule_id).then(()=>{this.addPushRule(N,ae.PushRuleKind.RoomSpecific,Z,{actions:[ae.PushRuleActionName.DontNotify]}).then(()=>{be.resolve()}).catch(Se=>{be.reject(Se)})}).catch(Se=>{be.reject(Se)}),se=be.promise}if(se)return new Promise((be,Se)=>{se.then(()=>{this.getPushRules().then(_e=>{this.pushRules=_e,be()}).catch(_e=>{Se(_e)})}).catch(_e=>{this.getPushRules().then(Re=>{this.pushRules=Re,Se(_e)}).catch(Re=>{Se(_e)})})})}searchMessageText(N){const Z={search_term:N.query};return"keys"in N&&(Z.keys=N.keys),this.search({body:{search_categories:{room_events:Z}}})}searchRoomEvents(N){const Z={search_categories:{room_events:{search_term:N.term,filter:N.filter,order_by:te.SearchOrderBy.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},ie={_query:Z,results:[],highlights:[]};return this.search({body:Z}).then(se=>this.processRoomEventsSearch(ie,se))}backPaginateRoomEventsSearch(N){if(!N.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(N.pendingRequest)return N.pendingRequest;const Z={body:N._query,next_batch:N.next_batch},ie=this.search(Z,N.abortSignal).then(se=>this.processRoomEventsSearch(N,se)).finally(()=>{N.pendingRequest=void 0});return N.pendingRequest=ie,ie}processRoomEventsSearch(N,Z){var ie,se;const le=Z.search_categories.room_events;N.count=le.count,N.next_batch=le.next_batch;const ge=new Set(le.highlights);N.highlights.forEach(_e=>{ge.add(_e)}),N.highlights=Array.from(ge);const be=this.getEventMapper(),Se=(se=(ie=le.results)===null||ie===void 0?void 0:ie.length)!==null&&se!==void 0?se:0;for(let _e=0;_e<Se;_e++){const Re=I.SearchResult.fromJson(le.results[_e],be),Ie=this.getRoom(Re.context.getEvent().getRoomId());if(Ie)for(const Ce of Re.context.getTimeline()){const Me=Ie.getMember(Ce.getSender());!Ce.sender&&Me&&(Ce.sender=Me)}N.results.push(Re)}return N}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const N=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=N.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{w.logger.log("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(N){const Z=r.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(A.Method.Post,Z,void 0,N).then(ie=>{const se=n.Filter.fromJson(this.credentials.userId,ie.filter_id,N);return this.store.storeFilter(se),se})}getFilter(N,Z,ie){if(ie){const le=this.store.getFilter(N,Z);if(le)return Promise.resolve(le)}const se=r.encodeUri("/user/$userId/filter/$filterId",{$userId:N,$filterId:Z});return this.http.authedRequest(A.Method.Get,se).then(le=>{const ge=n.Filter.fromJson(N,Z,le);return this.store.storeFilter(ge),ge})}getOrCreateFilter(N,Z){return c(this,void 0,void 0,function*(){const ie=this.store.getFilterIdByName(N);let se;if(ie){try{const ge=yield this.getFilter(this.credentials.userId,ie,!0);if(ge){const be=ge.getDefinition(),Se=Z.getDefinition();r.deepCompare(be,Se)&&(se=ie)}}catch(ge){if(ge.errcode!=="M_UNKNOWN"&&ge.errcode!=="M_NOT_FOUND")throw ge}se||this.store.setFilterIdByName(N,void 0)}if(se)return se;const le=yield this.createFilter(Z.getDefinition());return this.store.setFilterIdByName(N,le.filterId),le.filterId})}getOpenIdToken(){const N=r.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(A.Method.Post,N,void 0,{})}turnServer(){return this.http.authedRequest(A.Method.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}checkTurnServers(){return c(this,void 0,void 0,function*(){if(!this.canSupportVoip)return;let N=!1;const Z=this.turnServersExpiry-Date.now();if(Z>pe)w.logger.debug("TURN creds are valid for another "+Z+" ms: not fetching new ones."),N=!0;else{w.logger.debug("Fetching new TURN credentials");try{const ie=yield this.turnServer();if(ie.uris){w.logger.log("Got TURN URIs: "+ie.uris+" refresh in "+ie.ttl+" secs");const se={urls:ie.uris,username:ie.username,credential:ie.password};this.turnServers=[se],this.turnServersExpiry=Date.now()+ie.ttl*1e3,N=!0,this.emit(ve.TurnServers,this.turnServers)}}catch(ie){w.logger.error("Failed to get TURN URIs",ie),ie.httpStatus===403?(w.logger.info("TURN access unavailable for this account: stopping credentials checks"),this.checkTurnServersIntervalID!==null&&u.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.emit(ve.TurnServersError,ie,!0)):this.emit(ve.TurnServersError,ie,!1)}}return N})}setFallbackICEServerAllowed(N){this.fallbackICEServerAllowed=N}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const N=r.encodeUri("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(A.Method.Get,N,void 0,void 0,{prefix:""}).then(Z=>Z.admin)}whoisSynapseUser(N){const Z=r.encodeUri("/_synapse/admin/v1/whois/$userId",{$userId:N});return this.http.authedRequest(A.Method.Get,Z,void 0,void 0,{prefix:""})}deactivateSynapseUser(N){const Z=r.encodeUri("/_synapse/admin/v1/deactivate/$userId",{$userId:N});return this.http.authedRequest(A.Method.Post,Z,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var N;return c(this,void 0,void 0,function*(){this.clientWellKnownPromise=v.AutoDiscovery.getRawClientConfig((N=this.getDomain())!==null&&N!==void 0?N:void 0),this.clientWellKnown=yield this.clientWellKnownPromise,this.emit(ve.ClientWellKnown,this.clientWellKnown)})}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){const N=["boolean","string","number"],Z=Object.entries(this.clientOpts).filter(([ie,se])=>N.includes(typeof se)).reduce((ie,[se,le])=>(ie[se]=le,ie),{});return this.store.storeClientOptions(Z)}_unstable_getSharedRooms(N){return c(this,void 0,void 0,function*(){const Z=yield this.doesServerSupportUnstableFeature("uk.half-shot.msc2666"),ie=yield this.doesServerSupportUnstableFeature("uk.half-shot.msc2666.mutual_rooms");if(!Z&&!ie)throw Error("Server does not support mutual_rooms API");const se=r.encodeUri(`/uk.half-shot.msc2666/user/${ie?"mutual_rooms":"shared_rooms"}/$userId`,{$userId:N});return(yield this.http.authedRequest(A.Method.Get,se,void 0,void 0,{prefix:A.ClientPrefix.Unstable})).joined})}getVersions(){return c(this,void 0,void 0,function*(){if(this.serverVersionsPromise)return this.serverVersionsPromise;this.serverVersionsPromise=this.http.request(A.Method.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(Z=>{throw this.serverVersionsPromise=void 0,Z});const N=yield this.serverVersionsPromise;return this.canSupport=yield(0,J.buildFeatureSupportMap)(N),this.serverVersionsPromise})}isVersionSupported(N){return c(this,void 0,void 0,function*(){const{versions:Z}=yield this.getVersions();return Z&&Z.includes(N)})}doesServerSupportLazyLoading(){return c(this,void 0,void 0,function*(){const N=yield this.getVersions();if(!N)return!1;const Z=N.versions,ie=N.unstable_features;return Z&&Z.includes("r0.5.0")||ie&&ie["m.lazy_load_members"]})}doesServerRequireIdServerParam(){return c(this,void 0,void 0,function*(){const N=yield this.getVersions();if(!N)return!0;const Z=N.versions;if(Z&&Z.includes("r0.6.0"))return!1;const ie=N.unstable_features;return!ie||ie["m.require_identity_server"]===void 0?!0:ie["m.require_identity_server"]})}doesServerAcceptIdentityAccessToken(){return c(this,void 0,void 0,function*(){const N=yield this.getVersions();if(!N)return!1;const Z=N.versions,ie=N.unstable_features;return Z&&Z.includes("r0.6.0")||ie&&ie["m.id_access_token"]})}doesServerSupportSeparateAddAndBind(){return c(this,void 0,void 0,function*(){const N=yield this.getVersions();if(!N)return!1;const Z=N.versions,ie=N.unstable_features;return(Z==null?void 0:Z.includes("r0.6.0"))||(ie==null?void 0:ie["m.separate_add_and_bind"])})}doesServerSupportUnstableFeature(N){return c(this,void 0,void 0,function*(){const Z=yield this.getVersions();if(!Z)return!1;const ie=Z.unstable_features;return ie&&!!ie[N]})}doesServerForceEncryptionForPreset(N){return c(this,void 0,void 0,function*(){const Z=yield this.getVersions();if(!Z)return!1;const ie=Z.unstable_features,se=N.includes("_chat")?N.substring(0,N.indexOf("_chat")):N;return ie&&!!ie[`io.element.e2ee_forced.${se}`]})}doesServerSupportThread(){return c(this,void 0,void 0,function*(){if(yield this.isVersionSupported("v1.4"))return{threads:H.FeatureSupport.Stable,list:H.FeatureSupport.Stable,fwdPagination:H.FeatureSupport.Stable};try{const[N,Z,ie,se,le,ge]=yield Promise.all([this.doesServerSupportUnstableFeature("org.matrix.msc3440"),this.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3856"),this.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3715"),this.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:(0,H.determineFeatureSupport)(Z,N),list:(0,H.determineFeatureSupport)(se,ie),fwdPagination:(0,H.determineFeatureSupport)(ge,le)}}catch{return{threads:H.FeatureSupport.None,list:H.FeatureSupport.None,fwdPagination:H.FeatureSupport.None}}})}doesServerSupportLogoutDevices(){return this.isVersionSupported("r0.6.1")}hasLazyLoadMembersEnabled(){var N;return!!(!((N=this.clientOpts)===null||N===void 0)&&N.lazyLoadMembers)}setCanResetTimelineCallback(N){this.canResetTimelineCallback=N}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(N,Z,ie,se,le={dir:o.Direction.Backward}){var ge,be;return c(this,void 0,void 0,function*(){const Se=se?this.getEncryptedIfNeededEventType(N,se):null,[_e,Re]=yield Promise.all([this.fetchRoomEvent(N,Z),this.fetchRelations(N,Z,ie,Se,le)]),Ie=this.getEventMapper(),Ce=_e?Ie(_e):void 0;let Me=Re.chunk.map(Ie);if(Se===R.EventType.RoomMessageEncrypted){const Ae=Ce?Me.concat(Ce):Me;yield Promise.all(Ae.map(ke=>this.decryptEventIfNeeded(ke))),se!==null&&(Me=Me.filter(ke=>ke.getType()===se))}return Ce&&ie===R.RelationType.Replace&&(Me=Me.filter(Ae=>Ae.getSender()===Ce.getSender())),{originalEvent:Ce??null,events:Me,nextBatch:(ge=Re.next_batch)!==null&&ge!==void 0?ge:null,prevBatch:(be=Re.prev_batch)!==null&&be!==void 0?be:null}})}getCrossSigningCacheCallbacks(){var N;return(N=this.crypto)===null||N===void 0?void 0:N.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return(0,V.randomString)(32)}decryptEventIfNeeded(N,Z){return N.shouldAttemptDecryption()&&this.isCryptoEnabled()&&N.attemptDecryption(this.cryptoBackend,Z),N.isBeingDecrypted()?N.getDecryptionPromise():Promise.resolve()}termsUrlForService(N,Z){switch(N){case M.SERVICE_TYPES.IS:return this.http.getUrl("/terms",void 0,A.IdentityPrefix.V2,Z);case M.SERVICE_TYPES.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",Z);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(N=!1){var Z,ie;return N&&(!((Z=this.idBaseUrl)===null||Z===void 0)&&Z.startsWith("http://")||!((ie=this.idBaseUrl)===null||ie===void 0)&&ie.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(N){this.idBaseUrl=r.ensureNoTrailingSlash(N),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}setAccessToken(N){this.http.opts.accessToken=N}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(N){return this.http.authedRequest(A.Method.Get,"/register/available",{username:N}).then(Z=>Z.available).catch(Z=>Z.errcode==="M_USER_IN_USE"?!1:Promise.reject(Z))}register(N,Z,ie,se,le,ge,be){le===!0?le={email:!0}:(le==null||le===!1)&&(le={}),ie&&(se.session=ie);const Se={auth:se,refresh_token:!0};return N!=null&&(Se.username=N),Z!=null&&(Se.password=Z),le.email&&(Se.bind_email=!0),le.msisdn&&(Se.bind_msisdn=!0),ge!=null&&(Se.guest_access_token=ge),be!=null&&(Se.inhibit_login=be),Z!=null&&(Se.x_show_msisdn=!0),this.registerRequest(Se)}registerGuest({body:N}={}){return this.registerRequest(N||{},"guest")}registerRequest(N,Z){const ie={};return Z&&(ie.kind=Z),this.http.request(A.Method.Post,"/register",ie,N)}refreshToken(N){return this.http.authedRequest(A.Method.Post,"/refresh",void 0,{refresh_token:N},{prefix:A.ClientPrefix.V1,inhibitLogoutEmit:!0})}loginFlows(){return this.http.request(A.Method.Get,"/login")}login(N,Z){const ie={type:N};return Object.assign(ie,Z),this.http.authedRequest(A.Method.Post,"/login",void 0,ie).then(se=>(se.access_token&&se.user_id&&(this.http.opts.accessToken=se.access_token,this.credentials={userId:se.user_id}),se))}loginWithPassword(N,Z){return this.login("m.login.password",{user:N,password:Z})}loginWithSAML2(N){return this.login("m.login.saml2",{relay_state:N})}getCasLoginUrl(N){return this.getSsoLoginUrl(N,"cas")}getSsoLoginUrl(N,Z="sso",ie,se){let le="/login/"+Z+"/redirect";ie&&(le+="/"+ie);const ge={redirectUrl:N,[ye.unstable]:se};return this.http.getUrl(le,ge,A.ClientPrefix.R0).href}loginWithToken(N){return this.login("m.login.token",{token:N})}logout(N=!1){var Z,ie;return c(this,void 0,void 0,function*(){if(!((ie=(Z=this.crypto)===null||Z===void 0?void 0:Z.backupManager)===null||ie===void 0)&&ie.getKeyBackupEnabled())try{for(;(yield this.crypto.backupManager.backupPendingKeys(200))>0;);}catch(se){w.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",se)}return N&&(this.stopClient(),this.http.abort()),this.http.authedRequest(A.Method.Post,"/logout")})}deactivateAccount(N,Z){const ie={};return N&&(ie.auth=N),Z!==void 0&&(ie.erase=Z),this.http.authedRequest(A.Method.Post,"/account/deactivate",void 0,ie)}requestLoginToken(N){const Z={auth:N};return this.http.authedRequest(A.Method.Post,"/org.matrix.msc3882/login/token",void 0,Z,{prefix:A.ClientPrefix.Unstable})}getFallbackAuthUrl(N,Z){const ie=r.encodeUri("/auth/$loginType/fallback/web",{$loginType:N});return this.http.getUrl(ie,{session:Z},A.ClientPrefix.R0).href}createRoom(N){var Z;return c(this,void 0,void 0,function*(){const ie=(N.invite_3pid||[]).filter(se=>!se.id_access_token);if(ie.length>0&&(!((Z=this.identityServer)===null||Z===void 0)&&Z.getAccessToken)&&(yield this.doesServerAcceptIdentityAccessToken())){const se=yield this.identityServer.getAccessToken();if(se)for(const le of ie)le.id_access_token=se}return this.http.authedRequest(A.Method.Post,"/createRoom",void 0,N)})}fetchRelations(N,Z,ie,se,le={dir:o.Direction.Backward}){let ge=le;H.Thread.hasServerSideFwdPaginationSupport===H.FeatureSupport.Experimental&&(ge=(0,s.replaceParam)("dir","org.matrix.msc3715.dir",ge));const be=r.encodeParams(ge);let Se="/rooms/$roomId/relations/$eventId";ie!==null?(Se+="/$relationType",se!==null&&(Se+="/$eventType")):se!==null&&(w.logger.warn(`eventType: ${se} ignored when fetching
            relations as relationType is null`),se=null);const _e=r.encodeUri(Se+"?"+be,{$roomId:N,$eventId:Z,$relationType:ie,$eventType:se});return this.http.authedRequest(A.Method.Get,_e,void 0,void 0,{prefix:A.ClientPrefix.V1})}roomState(N){const Z=r.encodeUri("/rooms/$roomId/state",{$roomId:N});return this.http.authedRequest(A.Method.Get,Z)}fetchRoomEvent(N,Z){const ie=r.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:N,$eventId:Z});return this.http.authedRequest(A.Method.Get,ie)}members(N,Z,ie,se){const le={};Z&&(le.membership=Z),ie&&(le.not_membership=ie),se&&(le.at=se);const ge=r.encodeParams(le),be=r.encodeUri("/rooms/$roomId/members?"+ge,{$roomId:N});return this.http.authedRequest(A.Method.Get,be)}upgradeRoom(N,Z){const ie=r.encodeUri("/rooms/$roomId/upgrade",{$roomId:N});return this.http.authedRequest(A.Method.Post,ie,void 0,{new_version:Z})}getStateEvent(N,Z,ie){const se={$roomId:N,$eventType:Z,$stateKey:ie};let le=r.encodeUri("/rooms/$roomId/state/$eventType",se);return ie!==void 0&&(le=r.encodeUri(le+"/$stateKey",se)),this.http.authedRequest(A.Method.Get,le)}sendStateEvent(N,Z,ie,se="",le={}){const ge={$roomId:N,$eventType:Z,$stateKey:se};let be=r.encodeUri("/rooms/$roomId/state/$eventType",ge);return se!==void 0&&(be=r.encodeUri(be+"/$stateKey",ge)),this.http.authedRequest(A.Method.Put,be,void 0,ie,le)}roomInitialSync(N,Z){var ie;const se=r.encodeUri("/rooms/$roomId/initialSync",{$roomId:N});return this.http.authedRequest(A.Method.Get,se,{limit:(ie=Z==null?void 0:Z.toString())!==null&&ie!==void 0?ie:"30"})}setRoomReadMarkersHttpRequest(N,Z,ie,se){return c(this,void 0,void 0,function*(){const le=r.encodeUri("/rooms/$roomId/read_markers",{$roomId:N}),ge={[re.ReceiptType.FullyRead]:Z,[re.ReceiptType.Read]:ie};return((yield this.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield this.isVersionSupported("v1.4")))&&(ge[re.ReceiptType.ReadPrivate]=se),this.http.authedRequest(A.Method.Post,le,void 0,ge)})}getJoinedRooms(){const N=r.encodeUri("/joined_rooms",{});return this.http.authedRequest(A.Method.Get,N)}getJoinedRoomMembers(N){const Z=r.encodeUri("/rooms/$roomId/joined_members",{$roomId:N});return this.http.authedRequest(A.Method.Get,Z)}publicRooms(N={}){var{server:Z,limit:ie,since:se}=N,le=m(N,["server","limit","since"]);const ge={server:Z,limit:ie,since:se};return Object.keys(le).length===0?this.http.authedRequest(A.Method.Get,"/publicRooms",ge):this.http.authedRequest(A.Method.Post,"/publicRooms",ge,le)}createAlias(N,Z){const ie=r.encodeUri("/directory/room/$alias",{$alias:N}),se={room_id:Z};return this.http.authedRequest(A.Method.Put,ie,void 0,se)}deleteAlias(N){const Z=r.encodeUri("/directory/room/$alias",{$alias:N});return this.http.authedRequest(A.Method.Delete,Z)}getLocalAliases(N){const Z=r.encodeUri("/rooms/$roomId/aliases",{$roomId:N}),ie=A.ClientPrefix.V3;return this.http.authedRequest(A.Method.Get,Z,void 0,void 0,{prefix:ie})}getRoomIdForAlias(N){const Z=r.encodeUri("/directory/room/$alias",{$alias:N});return this.http.authedRequest(A.Method.Get,Z)}resolveRoomAlias(N){const Z=r.encodeUri("/directory/room/$alias",{$alias:N});return this.http.request(A.Method.Get,Z)}getRoomDirectoryVisibility(N){const Z=r.encodeUri("/directory/list/room/$roomId",{$roomId:N});return this.http.authedRequest(A.Method.Get,Z)}setRoomDirectoryVisibility(N,Z){const ie=r.encodeUri("/directory/list/room/$roomId",{$roomId:N});return this.http.authedRequest(A.Method.Put,ie,void 0,{visibility:Z})}setRoomDirectoryVisibilityAppService(N,Z,ie){const se=r.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:N,$roomId:Z});return this.http.authedRequest(A.Method.Put,se,void 0,{visibility:ie})}searchUserDirectory({term:N,limit:Z}){const ie={search_term:N};return Z!==void 0&&(ie.limit=Z),this.http.authedRequest(A.Method.Post,"/user_directory/search",void 0,ie)}uploadContent(N,Z){return this.http.uploadContent(N,Z)}cancelUpload(N){return this.http.cancelUpload(N)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(N,Z){const ie=Z?r.encodeUri("/profile/$userId/$info",{$userId:N,$info:Z}):r.encodeUri("/profile/$userId",{$userId:N});return this.http.authedRequest(A.Method.Get,ie)}getThreePids(){return this.http.authedRequest(A.Method.Get,"/account/3pid")}addThreePid(N,Z){const ie="/account/3pid",se={threePidCreds:N,bind:Z};return this.http.authedRequest(A.Method.Post,ie,void 0,se)}addThreePidOnly(N){return c(this,void 0,void 0,function*(){const Z="/account/3pid/add",ie=(yield this.isVersionSupported("r0.6.0"))?A.ClientPrefix.R0:A.ClientPrefix.Unstable;return this.http.authedRequest(A.Method.Post,Z,void 0,N,{prefix:ie})})}bindThreePid(N){return c(this,void 0,void 0,function*(){const Z="/account/3pid/bind",ie=(yield this.isVersionSupported("r0.6.0"))?A.ClientPrefix.R0:A.ClientPrefix.Unstable;return this.http.authedRequest(A.Method.Post,Z,void 0,N,{prefix:ie})})}unbindThreePid(N,Z){return c(this,void 0,void 0,function*(){const ie="/account/3pid/unbind",se={medium:N,address:Z,id_server:this.getIdentityServerUrl(!0)},le=(yield this.isVersionSupported("r0.6.0"))?A.ClientPrefix.R0:A.ClientPrefix.Unstable;return this.http.authedRequest(A.Method.Post,ie,void 0,se,{prefix:le})})}deleteThreePid(N,Z){const ie="/account/3pid/delete";return this.http.authedRequest(A.Method.Post,ie,void 0,{medium:N,address:Z})}setPassword(N,Z,ie){const se="/account/password",le={auth:N,new_password:Z,logout_devices:ie};return this.http.authedRequest(A.Method.Post,se,void 0,le)}getDevices(){return this.http.authedRequest(A.Method.Get,"/devices")}getDevice(N){const Z=r.encodeUri("/devices/$device_id",{$device_id:N});return this.http.authedRequest(A.Method.Get,Z)}setDeviceDetails(N,Z){const ie=r.encodeUri("/devices/$device_id",{$device_id:N});return this.http.authedRequest(A.Method.Put,ie,void 0,Z)}deleteDevice(N,Z){const ie=r.encodeUri("/devices/$device_id",{$device_id:N}),se={};return Z&&(se.auth=Z),this.http.authedRequest(A.Method.Delete,ie,void 0,se)}deleteMultipleDevices(N,Z){const ie={devices:N};Z&&(ie.auth=Z);const se="/delete_devices";return this.http.authedRequest(A.Method.Post,se,void 0,ie)}getPushers(){return c(this,void 0,void 0,function*(){const N=yield this.http.authedRequest(A.Method.Get,"/pushers");return(yield this.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(N.pushers=N.pushers.map(Z=>(Z.hasOwnProperty(R.PUSHER_ENABLED.name)||(Z[R.PUSHER_ENABLED.name]=!0),Z))),N})}setPusher(N){const Z="/pushers/set";return this.http.authedRequest(A.Method.Post,Z,void 0,N)}setLocalNotificationSettings(N,Z){const ie=`${R.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name}.${N}`;return this.setAccountData(ie,Z)}getPushRules(){return this.http.authedRequest(A.Method.Get,"/pushrules/").then(N=>(this.setPushRules(N),this.pushRules))}setPushRules(N){this.pushRules=l.PushProcessor.rewriteDefaultRules(N,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(N,Z,ie,se){const le=r.encodeUri("/pushrules/"+N+"/$kind/$ruleId",{$kind:Z,$ruleId:ie});return this.http.authedRequest(A.Method.Put,le,void 0,se)}deletePushRule(N,Z,ie){const se=r.encodeUri("/pushrules/"+N+"/$kind/$ruleId",{$kind:Z,$ruleId:ie});return this.http.authedRequest(A.Method.Delete,se)}setPushRuleEnabled(N,Z,ie,se){const le=r.encodeUri("/pushrules/"+N+"/$kind/$ruleId/enabled",{$kind:Z,$ruleId:ie});return this.http.authedRequest(A.Method.Put,le,void 0,{enabled:se})}setPushRuleActions(N,Z,ie,se){const le=r.encodeUri("/pushrules/"+N+"/$kind/$ruleId/actions",{$kind:Z,$ruleId:ie});return this.http.authedRequest(A.Method.Put,le,void 0,{actions:se})}search({body:N,next_batch:Z},ie){const se={};return Z&&(se.next_batch=Z),this.http.authedRequest(A.Method.Post,"/search",se,N,{abortSignal:ie})}uploadKeysRequest(N,Z){return this.http.authedRequest(A.Method.Post,"/keys/upload",void 0,N)}uploadKeySignatures(N){return this.http.authedRequest(A.Method.Post,"/keys/signatures/upload",void 0,N,{prefix:A.ClientPrefix.V3})}downloadKeysForUsers(N,{token:Z}={}){const ie={device_keys:{}};return Z!==void 0&&(ie.token=Z),N.forEach(se=>{ie.device_keys[se]=[]}),this.http.authedRequest(A.Method.Post,"/keys/query",void 0,ie)}claimOneTimeKeys(N,Z="signed_curve25519",ie){const se={};Z===void 0&&(Z="signed_curve25519");for(const[be,Se]of N){const _e=se[be]||{};se[be]=_e,_e[Se]=Z}const le={one_time_keys:se};ie&&(le.timeout=ie);const ge="/keys/claim";return this.http.authedRequest(A.Method.Post,ge,void 0,le)}getKeyChanges(N,Z){const ie={from:N,to:Z};return this.http.authedRequest(A.Method.Get,"/keys/changes",ie)}uploadDeviceSigningKeys(N,Z){const ie=Object.assign({},Z);return N&&Object.assign(ie,{auth:N}),this.http.authedRequest(A.Method.Post,"/keys/device_signing/upload",void 0,ie,{prefix:A.ClientPrefix.Unstable})}registerWithIdentityServer(N){if(!this.idBaseUrl)throw new Error("No identity server base URL set");const Z=this.http.getUrl("/account/register",void 0,A.IdentityPrefix.V2,this.idBaseUrl);return this.http.requestOtherUrl(A.Method.Post,Z,N)}requestEmailToken(N,Z,ie,se,le){const ge={client_secret:Z,email:N,send_attempt:ie==null?void 0:ie.toString()};return se&&(ge.next_link=se),this.http.idServerRequest(A.Method.Post,"/validate/email/requestToken",ge,A.IdentityPrefix.V2,le)}requestMsisdnToken(N,Z,ie,se,le,ge){const be={client_secret:ie,country:N,phone_number:Z,send_attempt:se==null?void 0:se.toString()};return le&&(be.next_link=le),this.http.idServerRequest(A.Method.Post,"/validate/msisdn/requestToken",be,A.IdentityPrefix.V2,ge)}submitMsisdnToken(N,Z,ie,se){const le={sid:N,client_secret:Z,token:ie};return this.http.idServerRequest(A.Method.Post,"/validate/msisdn/submitToken",le,A.IdentityPrefix.V2,se)}submitMsisdnTokenOtherUrl(N,Z,ie,se){const le={sid:Z,client_secret:ie,token:se};return this.http.requestOtherUrl(A.Method.Post,N,le)}getIdentityHashDetails(N){return this.http.idServerRequest(A.Method.Get,"/hash_details",void 0,A.IdentityPrefix.V2,N)}identityHashedLookup(N,Z){return c(this,void 0,void 0,function*(){const ie={},se=yield this.getIdentityHashDetails(Z);if(!se||!se.lookup_pepper||!se.algorithms)throw new Error("Unsupported identity server: bad response");ie.pepper=se.lookup_pepper;const le={};if(se.algorithms.includes("sha256")){const Se=new u.Olm.Utility;ie.addresses=N.map(_e=>{const Re=_e[0].toLowerCase(),Ie=_e[1].toLowerCase(),Ce=Se.sha256(`${Re} ${Ie} ${ie.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return le[Ce]=_e[0],Ce}),ie.algorithm="sha256"}else if(se.algorithms.includes("none"))ie.addresses=N.map(Se=>{const _e=Se[0].toLowerCase(),Re=Se[1].toLowerCase(),Ie=`${_e} ${Re}`;return le[Ie]=Se[0],Ie}),ie.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");const ge=yield this.http.idServerRequest(A.Method.Post,"/lookup",ie,A.IdentityPrefix.V2,Z);if(!(ge!=null&&ge.mappings))return[];const be=[];for(const Se of Object.keys(ge.mappings)){const _e=ge.mappings[Se],Re=le[Se];if(!Re)throw new Error("Identity server returned more results than expected");be.push({address:Re,mxid:_e})}return be})}lookupThreePid(N,Z,ie){return c(this,void 0,void 0,function*(){const le=(yield this.identityHashedLookup([[Z,N]],ie)).find(be=>be.address===Z);return le?{address:Z,medium:N,mxid:le.mxid}:{}})}bulkLookupThreePids(N,Z){return c(this,void 0,void 0,function*(){const ie=yield this.identityHashedLookup(N.map(le=>[le[1],le[0]]),Z),se=[];for(const le of ie){const ge=N.find(be=>be[1]===le.address);if(!ge)throw new Error("Identity sever returned unexpected results");se.push([ge[0],le.address,le.mxid])}return{threepids:se}})}getIdentityAccount(N){return this.http.idServerRequest(A.Method.Get,"/account",void 0,A.IdentityPrefix.V2,N)}sendToDevice(N,Z,ie){const se=r.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:N,$txnId:ie||this.makeTxnId()}),le={messages:r.recursiveMapToObject(Z)},ge=new Map;for(const[be,Se]of Z)ge.set(be,Array.from(Se.keys()));return w.logger.log(`PUT ${se}`,ge),this.http.authedRequest(A.Method.Put,se,void 0,le)}queueToDevice(N){return this.toDeviceMessageQueue.queueBatch(N)}getThirdpartyProtocols(){return this.http.authedRequest(A.Method.Get,"/thirdparty/protocols").then(N=>{if(!N||typeof N!="object")throw new Error(`/thirdparty/protocols did not return an object: ${N}`);return N})}getThirdpartyLocation(N,Z){const ie=r.encodeUri("/thirdparty/location/$protocol",{$protocol:N});return this.http.authedRequest(A.Method.Get,ie,Z)}getThirdpartyUser(N,Z){const ie=r.encodeUri("/thirdparty/user/$protocol",{$protocol:N});return this.http.authedRequest(A.Method.Get,ie,Z)}getTerms(N,Z){const ie=this.termsUrlForService(N,Z);return this.http.requestOtherUrl(A.Method.Get,ie)}agreeToTerms(N,Z,ie,se){const le=this.termsUrlForService(N,Z),ge={Authorization:"Bearer "+ie};return this.http.requestOtherUrl(A.Method.Post,le,{user_accepts:se},{headers:ge})}reportEvent(N,Z,ie,se){const le=r.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:N,$eventId:Z});return this.http.authedRequest(A.Method.Post,le,void 0,{score:ie,reason:se})}getRoomHierarchy(N,Z,ie,se=!1,le){const ge=r.encodeUri("/rooms/$roomId/hierarchy",{$roomId:N}),be={suggested_only:String(se),max_depth:ie==null?void 0:ie.toString(),from:le,limit:Z==null?void 0:Z.toString()};return this.http.authedRequest(A.Method.Get,ge,be,void 0,{prefix:A.ClientPrefix.V1}).catch(Se=>{if(Se.errcode==="M_UNRECOGNIZED")return this.http.authedRequest(A.Method.Get,ge,be,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw Se})}unstableCreateFileTree(N){return c(this,void 0,void 0,function*(){const{room_id:Z}=yield this.createRoom({name:N,preset:k.Preset.PrivateChat,power_level_content_override:Object.assign(Object.assign({},Q.DEFAULT_TREE_POWER_LEVELS_TEMPLATE),{users:{[this.getUserId()]:100}}),creation_content:{[R.RoomCreateTypeField]:R.RoomType.Space},initial_state:[{type:R.UNSTABLE_MSC3088_PURPOSE.name,state_key:R.UNSTABLE_MSC3089_TREE_SUBTYPE.name,content:{[R.UNSTABLE_MSC3088_ENABLED.name]:!0}},{type:R.EventType.RoomEncryption,state_key:"",content:{algorithm:f.MEGOLM_ALGORITHM}}]});return new Q.MSC3089TreeSpace(this,Z)})}unstableGetFileTreeSpace(N){var Z,ie;const se=this.getRoom(N);if((se==null?void 0:se.getMyMembership())!=="join")return null;const le=se.currentState.getStateEvents(R.EventType.RoomCreate,""),ge=se.currentState.getStateEvents(R.UNSTABLE_MSC3088_PURPOSE.name,R.UNSTABLE_MSC3089_TREE_SUBTYPE.name);if(!le)throw new Error("Expected single room create event");return!(!((Z=ge==null?void 0:ge.getContent())===null||Z===void 0)&&Z[R.UNSTABLE_MSC3088_ENABLED.name])||((ie=le.getContent())===null||ie===void 0?void 0:ie[R.RoomCreateTypeField])!==R.RoomType.Space?null:new Q.MSC3089TreeSpace(this,N)}slidingSync(N,Z,ie){const se={};N.pos&&(se.pos=N.pos,delete N.pos),N.timeout&&(se.timeout=N.timeout,delete N.timeout);const le=N.clientTimeout;return delete N.clientTimeout,this.http.authedRequest(A.Method.Post,"/sync",se,N,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:Z,localTimeoutMs:le,abortSignal:ie})}supportsExperimentalThreads(){var N;return w.logger.warn("supportsExperimentalThreads() is deprecated, use supportThreads() instead"),((N=this.clientOpts)===null||N===void 0?void 0:N.experimentalThreadSupport)||!1}supportsThreads(){var N;return((N=this.clientOpts)===null||N===void 0?void 0:N.threadSupport)||!1}supportsIntentionalMentions(){var N;return((N=this.clientOpts)===null||N===void 0?void 0:N.intentionalMentions)||!1}getRoomSummary(N,Z){return c(this,void 0,void 0,function*(){const ie=r.encodeUri("/rooms/$roomid/summary",{$roomid:N});return this.http.authedRequest(A.Method.Get,ie,{via:Z},void 0,{prefix:"/_matrix/client/unstable/im.nheko.summary"})})}processThreadEvents(N,Z,ie){N.processThreadedEvents(Z,ie)}processThreadRoots(N,Z,ie){N.processThreadRoots(Z,ie)}processBeaconEvents(N,Z){this.processAggregatedTimelineEvents(N,Z)}processAggregatedTimelineEvents(N,Z){Z!=null&&Z.length&&N&&(N.currentState.processBeaconEvents(Z,this),N.processPollEvents(Z))}whoami(){return c(this,void 0,void 0,function*(){return this.http.authedRequest(A.Method.Get,"/account/whoami")})}timestampToEvent(N,Z,ie){return c(this,void 0,void 0,function*(){const se=r.encodeUri("/rooms/$roomId/timestamp_to_event",{$roomId:N}),le={ts:Z.toString(),dir:ie};try{return yield this.http.authedRequest(A.Method.Get,se,le,void 0,{prefix:A.ClientPrefix.V1})}catch(ge){if(ge.errcode==="M_UNRECOGNIZED"&&(ge.httpStatus===400||ge.httpStatus===404||ge.httpStatus===405))return yield this.http.authedRequest(A.Method.Get,se,le,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw ge}})}}e.MatrixClient=Ee,Ee.RESTORE_BACKUP_ERROR_BAD_KEY="RESTORE_BACKUP_ERROR_BAD_KEY";function we(me,N){var Z,ie;const se=me.getUserId(),le=N.getId(),ge=me.getRoom(N.getRoomId());if(!ge||!se||!le)return;const be=N.getPushActions(),Se=me.getPushActionsForEvent(N,!0),_e=!!N.threadRootId&&!N.isThreadRoot,Re=ge.getUnreadCountForEventContext(q.NotificationCountType.Highlight,N),Ie=!!(!((Z=be==null?void 0:be.tweaks)===null||Z===void 0)&&Z.highlight),Ce=!!(!((ie=Se==null?void 0:Se.tweaks)===null||ie===void 0)&&ie.highlight);let Me;if(_e){const xe=ge.getThread(N.threadRootId);Me=xe?xe.hasUserReadEvent(se,le):!0}else Me=ge.hasUserReadEvent(se,le);if(Me)return;if(Ie!==Ce||Re>0){let xe=Re;Ce&&!Ie&&xe++,!Ce&&Ie&&xe--,_e?ge.setThreadUnreadNotificationCount(N.threadRootId,q.NotificationCountType.Highlight,xe):ge.setUnreadNotificationCount(q.NotificationCountType.Highlight,xe)}const Ae=ge.getUnreadCountForEventContext(q.NotificationCountType.Total,N);!!(Se!=null&&Se.notify)&&(_e?ge.setThreadUnreadNotificationCount(N.threadRootId,q.NotificationCountType.Total,Ae+1):ge.setUnreadNotificationCount(q.NotificationCountType.Total,Ae+1))}e.fixNotificationCountOnDecryption=we}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./@types/PushRules":304,"./@types/beacon":305,"./@types/event":306,"./@types/partials":309,"./@types/read_receipts":311,"./@types/search":313,"./NamespacedValue":316,"./ReEmitter":317,"./ToDeviceMessageQueue":318,"./autodiscovery":319,"./content-helpers":322,"./content-repo":323,"./crypto":341,"./crypto/RoomList":329,"./crypto/api":336,"./crypto/backup":337,"./crypto/dehydration":339,"./crypto/key_passphrase":342,"./crypto/olmlib":343,"./crypto/recoverykey":344,"./event-mapper":360,"./feature":362,"./filter":364,"./http-api":367,"./logger":374,"./models/MSC3089TreeSpace":377,"./models/event":383,"./models/event-timeline":382,"./models/invites-ignorer":384,"./models/room":392,"./models/room-member":389,"./models/search-result":393,"./models/thread":394,"./models/typed-event-emitter":395,"./models/user":396,"./pushprocessor":397,"./randomstring":398,"./rust-crypto":402,"./rust-crypto/constants":401,"./service-types":405,"./sliding-sync-sdk":406,"./store/stub":412,"./sync":414,"./utils":416,"./webrtc/call":418,"./webrtc/callEventHandler":419,"./webrtc/groupCall":422,"./webrtc/groupCallEventHandler":423,"./webrtc/mediaHandler":424}],322:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.parseBeaconContent=e.makeBeaconContent=e.parseBeaconInfoContent=e.makeBeaconInfoContent=e.parseTopicContent=e.makeTopicContent=e.parseLocationEvent=e.makeLocationContent=e.getTextForLocationEvent=e.makeEmoteMessage=e.makeNotice=e.makeTextMessage=e.makeHtmlEmote=e.makeHtmlNotice=e.makeHtmlMessage=void 0;const u=t("./@types/event"),g=t("./@types/extensible_events"),S=t("./extensible_events_v1/utilities"),y=t("./@types/location"),c=t("./@types/topic");function m(T,w){return{msgtype:u.MsgType.Text,format:"org.matrix.custom.html",body:T,formatted_body:w}}e.makeHtmlMessage=m;function h(T,w){return{msgtype:u.MsgType.Notice,format:"org.matrix.custom.html",body:T,formatted_body:w}}e.makeHtmlNotice=h;function d(T,w){return{msgtype:u.MsgType.Emote,format:"org.matrix.custom.html",body:T,formatted_body:w}}e.makeHtmlEmote=d;function b(T){return{msgtype:u.MsgType.Text,body:T}}e.makeTextMessage=b;function a(T){return{msgtype:u.MsgType.Notice,body:T}}e.makeNotice=a;function n(T){return{msgtype:u.MsgType.Emote,body:T}}e.makeEmoteMessage=n;const i=(T,w,M,A)=>{const W=`at ${new Date(M).toISOString()}`,ee=w===y.LocationAssetType.Self?"User":void 0,F=A?`"${A}"`:void 0;return[ee,"Location",F,T,W].filter(Boolean).join(" ")};e.getTextForLocationEvent=i;const r=(T,w,M,A,W)=>{const ee=T??(0,e.getTextForLocationEvent)(w,W||y.LocationAssetType.Self,M,A),F=M?{[y.M_TIMESTAMP.name]:M}:{};return Object.assign({msgtype:u.MsgType.Location,body:ee,geo_uri:w,[y.M_LOCATION.name]:{description:A,uri:w},[y.M_ASSET.name]:{type:W||y.LocationAssetType.Self},[g.M_TEXT.name]:ee},F)};e.makeLocationContent=r;const s=T=>{var w,M;const A=y.M_LOCATION.findIn(T),W=y.M_ASSET.findIn(T),ee=y.M_TIMESTAMP.findIn(T),F=g.M_TEXT.findIn(T),C=(w=A==null?void 0:A.uri)!==null&&w!==void 0?w:T==null?void 0:T.geo_uri,O=A==null?void 0:A.description,I=(M=W==null?void 0:W.type)!==null&&M!==void 0?M:y.LocationAssetType.Self,D=F??T.body;return(0,e.makeLocationContent)(D,C,ee??void 0,O,I)};e.parseLocationEvent=s;const o=(T,w)=>{const M=[{body:T,mimetype:"text/plain"}];return(0,S.isProvided)(w)&&M.push({body:w,mimetype:"text/html"}),{topic:T,[c.M_TOPIC.name]:M}};e.makeTopicContent=o;const l=T=>{var w,M,A;const W=c.M_TOPIC.findIn(T);if(!Array.isArray(W))return{text:T.topic};const ee=(M=(w=W==null?void 0:W.find(C=>!(0,S.isProvided)(C.mimetype)||C.mimetype==="text/plain"))===null||w===void 0?void 0:w.body)!==null&&M!==void 0?M:T.topic,F=(A=W==null?void 0:W.find(C=>C.mimetype==="text/html"))===null||A===void 0?void 0:A.body;return{text:ee,html:F}};e.parseTopicContent=l;const v=(T,w,M,A,W)=>({description:M,timeout:T,live:w,[y.M_TIMESTAMP.name]:W||Date.now(),[y.M_ASSET.name]:{type:A??y.LocationAssetType.Self}});e.makeBeaconInfoContent=v;const f=T=>{var w;const{description:M,timeout:A,live:W}=T,ee=(w=y.M_TIMESTAMP.findIn(T))!==null&&w!==void 0?w:void 0,F=y.M_ASSET.findIn(T);return{description:M,timeout:A,live:W,assetType:F==null?void 0:F.type,timestamp:ee}};e.parseBeaconInfoContent=f;const p=(T,w,M,A)=>({[y.M_LOCATION.name]:{description:A,uri:T},[y.M_TIMESTAMP.name]:w,"m.relates_to":{rel_type:g.REFERENCE_RELATION.name,event_id:M}});e.makeBeaconContent=p;const _=T=>{var w;const M=y.M_LOCATION.findIn(T),A=(w=y.M_TIMESTAMP.findIn(T))!==null&&w!==void 0?w:void 0;return{description:M==null?void 0:M.description,uri:M==null?void 0:M.uri,timestamp:A}};e.parseBeaconContent=_},{"./@types/event":306,"./@types/extensible_events":307,"./@types/location":308,"./@types/topic":315,"./extensible_events_v1/utilities":361}],323:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(m,h,d,b){b===void 0&&(b=d);var a=Object.getOwnPropertyDescriptor(h,d);(!a||("get"in a?!h.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return h[d]}}),Object.defineProperty(m,b,a)}:function(m,h,d,b){b===void 0&&(b=d),m[b]=h[d]}),g=this&&this.__setModuleDefault||(Object.create?function(m,h){Object.defineProperty(m,"default",{enumerable:!0,value:h})}:function(m,h){m.default=h}),S=this&&this.__importStar||function(m){if(m&&m.__esModule)return m;var h={};if(m!=null)for(var d in m)d!=="default"&&Object.prototype.hasOwnProperty.call(m,d)&&u(h,m,d);return g(h,m),h};Object.defineProperty(e,"__esModule",{value:!0}),e.getHttpUriForMxc=void 0;const y=S(t("./utils"));function c(m,h,d,b,a,n=!1){if(typeof h!="string"||!h)return"";if(h.indexOf("mxc://")!==0)return n?h:"";let i=h.slice(6),r="/_matrix/media/r0/download/";const s={};d&&(s.width=Math.round(d).toString()),b&&(s.height=Math.round(b).toString()),a&&(s.method=a),Object.keys(s).length>0&&(r="/_matrix/media/r0/thumbnail/");const o=i.indexOf("#");let l="";o>=0&&(l=i.slice(o),i=i.slice(0,o));const v=Object.keys(s).length===0?"":"?"+y.encodeParams(s);return m+r+i+v+l}e.getHttpUriForMxc=c},{"./utils":416}],324:[function(t,E,e){(function(u,g){(function(){var S=this&&this.__awaiter||function(v,f,p,_){function T(w){return w instanceof p?w:new p(function(M){M(w)})}return new(p||(p=Promise))(function(w,M){function A(F){try{ee(_.next(F))}catch(C){M(C)}}function W(F){try{ee(_.throw(F))}catch(C){M(C)}}function ee(F){F.done?w(F.value):T(F.value).then(A,W)}ee((_=_.apply(v,f||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.requestKeysDuringVerification=e.createCryptoStoreCacheCallbacks=e.DeviceTrustLevel=e.UserTrustLevel=e.CrossSigningLevel=e.CrossSigningInfo=void 0;const y=t("./olmlib"),c=t("../logger"),m=t("../crypto/store/indexeddb-crypto-store"),h=t("./aes"),d=1e3*60;function b(v){return Object.values(v.keys)[0]}class a{constructor(f,p={},_={}){this.userId=f,this.callbacks=p,this.cacheCallbacks=_,this.keys={},this.firstUse=!0,this.crossSigningVerifiedBefore=!1}static fromStorage(f,p){const _=new a(p);for(const T in f)f.hasOwnProperty(T)&&(_[T]=f[T]);return _}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}getCrossSigningKey(f,p){return S(this,void 0,void 0,function*(){const _=["master","self_signing","user_signing"].indexOf(f)>=0;if(!this.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");p===void 0&&(p=this.getId(f));function T(W){if(!W)return;const ee=new u.Olm.PkSigning,F=ee.init_with_seed(W);if(F===p)return[F,ee];ee.free()}let w=null;this.cacheCallbacks.getCrossSigningKeyCache&&_&&(w=yield this.cacheCallbacks.getCrossSigningKeyCache(f,p));const M=T(w);if(M)return M;w=yield this.callbacks.getCrossSigningKey(f,p);const A=T(w);if(A)return this.cacheCallbacks.storeCrossSigningKeyCache&&_&&(yield this.cacheCallbacks.storeCrossSigningKeyCache(f,w)),A;throw w?new Error("Key type "+f+" from getCrossSigningKey callback did not match"):new Error("getCrossSigningKey callback for "+f+" returned falsey")})}isStoredInSecretStorage(f){return S(this,void 0,void 0,function*(){const p=(yield f.isStored("m.cross_signing.master"))||{};function _(T){for(const w of Object.keys(p))T[w]||delete p[w]}for(const T of["self_signing","user_signing"])_((yield f.isStored(`m.cross_signing.${T}`))||{});return Object.keys(p).length?p:null})}static storeInSecretStorage(f,p){return S(this,void 0,void 0,function*(){for(const[_,T]of f){const w=(0,y.encodeBase64)(T);yield p.store(`m.cross_signing.${_}`,w)}})}static getFromSecretStorage(f,p){return S(this,void 0,void 0,function*(){const _=yield p.get(`m.cross_signing.${f}`);return _?(0,y.decodeBase64)(_):null})}isStoredInKeyCache(f){var p;return S(this,void 0,void 0,function*(){const _=this.cacheCallbacks;if(!_)return!1;const T=f?[f]:["master","self_signing","user_signing"];for(const w of T)if(!(yield(p=_.getCrossSigningKeyCache)===null||p===void 0?void 0:p.call(_,w)))return!1;return!0})}getCrossSigningKeysFromCache(){var f;return S(this,void 0,void 0,function*(){const p=new Map,_=this.cacheCallbacks;if(!_)return p;for(const T of["master","self_signing","user_signing"]){const w=yield(f=_.getCrossSigningKeyCache)===null||f===void 0?void 0:f.call(_,T);w&&p.set(T,w)}return p})}getId(f="master"){if(!this.keys[f])return null;const p=this.keys[f];return b(p)}resetKeys(f){return S(this,void 0,void 0,function*(){if(!this.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(f===void 0||f&i.MASTER||!this.keys.master)f=i.MASTER|i.USER_SIGNING|i.SELF_SIGNING;else if(f===0)return;const p={},_={};let T,w;try{if(f&i.MASTER?(T=new u.Olm.PkSigning,p.master=T.generate_seed(),w=T.init_with_seed(p.master),_.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+w]:w}}):[w,T]=yield this.getCrossSigningKey("master"),f&i.SELF_SIGNING){const M=new u.Olm.PkSigning;try{p.self_signing=M.generate_seed();const A=M.init_with_seed(p.self_signing);_.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+A]:A}},(0,y.pkSign)(_.self_signing,T,this.userId,w)}finally{M.free()}}if(f&i.USER_SIGNING){const M=new u.Olm.PkSigning;try{p.user_signing=M.generate_seed();const A=M.init_with_seed(p.user_signing);_.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+A]:A}},(0,y.pkSign)(_.user_signing,T,this.userId,w)}finally{M.free()}}Object.assign(this.keys,_),this.callbacks.saveCrossSigningKeys(p)}finally{T&&T.free()}})}clearKeys(){this.keys={}}setKeys(f){const p={};if(f.master){if(f.master.user_id!==this.userId){const T="Mismatched user ID "+f.master.user_id+" in master key from "+this.userId;throw c.logger.error(T),new Error(T)}this.keys.master?b(f.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,p.master=f.master}else if(this.keys.master)p.master=this.keys.master;else throw new Error("Tried to set cross-signing keys without a master key");const _=b(p.master);if(f.user_signing){if(f.user_signing.user_id!==this.userId){const T="Mismatched user ID "+f.master.user_id+" in user_signing key from "+this.userId;throw c.logger.error(T),new Error(T)}try{(0,y.pkVerify)(f.user_signing,_,this.userId)}catch(T){throw c.logger.error("invalid signature on user-signing key"),T}}if(f.self_signing){if(f.self_signing.user_id!==this.userId){const T="Mismatched user ID "+f.master.user_id+" in self_signing key from "+this.userId;throw c.logger.error(T),new Error(T)}try{(0,y.pkVerify)(f.self_signing,_,this.userId)}catch(T){throw c.logger.error("invalid signature on self-signing key"),T}}f.master&&(this.keys.master=f.master,delete this.keys.self_signing,delete this.keys.user_signing),f.self_signing&&(this.keys.self_signing=f.self_signing),f.user_signing&&(this.keys.user_signing=f.user_signing)}updateCrossSigningVerifiedBefore(f){!this.crossSigningVerifiedBefore&&f&&(this.crossSigningVerifiedBefore=!0)}signObject(f,p){return S(this,void 0,void 0,function*(){if(!this.keys[p])throw new Error("Attempted to sign with "+p+" key but no such key present");const[_,T]=yield this.getCrossSigningKey(p);try{return(0,y.pkSign)(f,T,this.userId,_),f}finally{T.free()}})}signUser(f){return S(this,void 0,void 0,function*(){if(!this.keys.user_signing){c.logger.info("No user signing key: not signing user");return}return this.signObject(f.keys.master,"user_signing")})}signDevice(f,p){return S(this,void 0,void 0,function*(){if(f!==this.userId)throw new Error(`Trying to sign ${f}'s device; can only sign our own device`);if(!this.keys.self_signing){c.logger.info("No self signing key: not signing device");return}return this.signObject({algorithms:p.algorithms,keys:p.keys,device_id:p.deviceId,user_id:f},"self_signing")})}checkUserTrust(f){if(this.userId===f.userId&&this.getId()&&this.getId()===f.getId()&&this.getId("self_signing")&&this.getId("self_signing")===f.getId("self_signing"))return new r(!0,!0,this.firstUse);if(!this.keys.user_signing)return new r(!1,!1,f.firstUse);let p;const _=f.keys.master,T=this.getId("user_signing");try{(0,y.pkVerify)(_,T,this.userId),p=!0}catch{p=!1}return new r(p,f.crossSigningVerifiedBefore,f.firstUse)}checkDeviceTrust(f,p,_,T){const w=this.checkUserTrust(f),M=f.keys.self_signing;if(!M)return new s(!1,!1,_,T);const A=n(p,f.userId);try{return(0,y.pkVerify)(M,f.getId(),f.userId),(0,y.pkVerify)(A,b(M),f.userId),s.fromUserTrustLevel(w,_,T)}catch{return new s(!1,!1,_,T)}}getCacheCallbacks(){return this.cacheCallbacks}}e.CrossSigningInfo=a;function n(v,f){return{algorithms:v.algorithms,keys:v.keys,device_id:v.deviceId,user_id:f,signatures:v.signatures}}var i;(function(v){v[v.MASTER=4]="MASTER",v[v.USER_SIGNING=2]="USER_SIGNING",v[v.SELF_SIGNING=1]="SELF_SIGNING"})(i=e.CrossSigningLevel||(e.CrossSigningLevel={}));class r{constructor(f,p,_){this.crossSigningVerified=f,this.crossSigningVerifiedBefore=p,this.tofu=_}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}e.UserTrustLevel=r;class s{constructor(f,p,_,T){this.crossSigningVerified=f,this.tofu=p,this.localVerified=_,this.trustCrossSignedDevices=T}static fromUserTrustLevel(f,p,_){return new s(f.isCrossSigningVerified(),f.isTofu(),p,_)}isVerified(){return!!(this.isLocallyVerified()||this.trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}e.DeviceTrustLevel=s;function o(v,f){return{getCrossSigningKeyCache:function(p,_){return S(this,void 0,void 0,function*(){const T=yield new Promise(w=>v.doTxn("readonly",[m.IndexedDBCryptoStore.STORE_ACCOUNT],M=>{v.getSecretStorePrivateKey(M,w,p)}));if(T&&T.ciphertext){const w=g.from(f.pickleKey),M=yield(0,h.decryptAES)(T,w,p);return(0,y.decodeBase64)(M)}else return T})},storeCrossSigningKeyCache:function(p,_){return S(this,void 0,void 0,function*(){if(!(_ instanceof Uint8Array))throw new Error(`storeCrossSigningKeyCache expects Uint8Array, got ${_}`);const T=g.from(f.pickleKey),w=yield(0,h.encryptAES)((0,y.encodeBase64)(_),T,p);return v.doTxn("readwrite",[m.IndexedDBCryptoStore.STORE_ACCOUNT],M=>{v.storeSecretStorePrivateKey(M,p,w)})})}}}e.createCryptoStoreCacheCallbacks=o;function l(v,f,p){return S(this,void 0,void 0,function*(){if(v.getUserId()===f)return c.logger.log("Cross-signing: Self-verification done; requesting keys"),new Promise((_,T)=>{const w=v,M=w.crypto.crossSigningInfo,A=new a(M.userId,{getCrossSigningKey:F=>S(this,void 0,void 0,function*(){c.logger.debug("Cross-signing: requesting secret",F,p);const{promise:C}=w.requestSecret(`m.cross_signing.${F}`,[p]),O=yield C,I=(0,y.decodeBase64)(O);return Uint8Array.from(I)})},M.getCacheCallbacks());A.keys=M.keys;const W=new Promise(F=>{setTimeout(F,d,new Error("Timeout"))}),ee=(()=>S(this,void 0,void 0,function*(){if(!(yield w.crypto.getSessionBackupPrivateKey())){c.logger.info("No cached backup key found. Requesting...");const O=yield w.requestSecret("m.megolm_backup.v1",[p]).promise;c.logger.info("Got key backup key, decoding...");const I=(0,y.decodeBase64)(O);c.logger.info("Decoded backup key, storing..."),yield w.crypto.storeSessionBackupPrivateKey(Uint8Array.from(I)),c.logger.info("Backup key stored. Starting backup restore...");const D=yield w.getKeyBackupVersion();w.restoreKeyBackupWithCache(void 0,void 0,D).then(()=>{c.logger.info("Backup restored.")})}}))();return Promise.race([Promise.all([A.getCrossSigningKey("master"),A.getCrossSigningKey("self_signing"),A.getCrossSigningKey("user_signing"),ee]),W]).then(_,T)}).catch(_=>{c.logger.warn("Cross-signing: failure while requesting keys:",_)})})}e.requestKeysDuringVerification=l}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer)},{"../crypto/store/indexeddb-crypto-store":346,"../logger":374,"./aes":331,"./olmlib":343,buffer:68}],325:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(f,p,_,T){T===void 0&&(T=_);var w=Object.getOwnPropertyDescriptor(p,_);(!w||("get"in w?!p.__esModule:w.writable||w.configurable))&&(w={enumerable:!0,get:function(){return p[_]}}),Object.defineProperty(f,T,w)}:function(f,p,_,T){T===void 0&&(T=_),f[T]=p[_]}),g=this&&this.__setModuleDefault||(Object.create?function(f,p){Object.defineProperty(f,"default",{enumerable:!0,value:p})}:function(f,p){f.default=p}),S=this&&this.__importStar||function(f){if(f&&f.__esModule)return f;var p={};if(f!=null)for(var _ in f)_!=="default"&&Object.prototype.hasOwnProperty.call(f,_)&&u(p,f,_);return g(p,f),p},y=this&&this.__awaiter||function(f,p,_,T){function w(M){return M instanceof _?M:new _(function(A){A(M)})}return new(_||(_=Promise))(function(M,A){function W(C){try{F(T.next(C))}catch(O){A(O)}}function ee(C){try{F(T.throw(C))}catch(O){A(O)}}function F(C){C.done?M(C.value):w(C.value).then(W,ee)}F((T=T.apply(f,p||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.DeviceList=e.TrackingStatus=void 0;const c=t("../logger"),m=t("./deviceinfo"),h=t("./CrossSigning"),d=S(t("./olmlib")),b=t("./store/indexeddb-crypto-store"),a=t("../utils"),n=t("../models/typed-event-emitter"),i=t("./index");var r;(function(f){f[f.NotTracked=0]="NotTracked",f[f.PendingDownload=1]="PendingDownload",f[f.DownloadInProgress=2]="DownloadInProgress",f[f.UpToDate=3]="UpToDate"})(r=e.TrackingStatus||(e.TrackingStatus={}));class s extends n.TypedEventEmitter{constructor(p,_,T,w=250){super(),this.cryptoStore=_,this.keyDownloadChunkSize=w,this.devices={},this.crossSigningInfo={},this.userByIdentityKey={},this.deviceTrackingStatus={},this.syncToken=null,this.keyDownloadsInProgressByUser=new Map,this.dirty=!1,this.savePromise=null,this.resolveSavePromise=null,this.savePromiseTime=null,this.saveTimer=null,this.hasFetched=null,this.serialiser=new o(p,T,this)}load(){return y(this,void 0,void 0,function*(){yield this.cryptoStore.doTxn("readonly",[b.IndexedDBCryptoStore.STORE_DEVICE_DATA],p=>{this.cryptoStore.getEndToEndDeviceData(p,_=>{var T;this.hasFetched=!!(_&&_.devices),this.devices=_?_.devices:{},this.crossSigningInfo=_?_.crossSigningInfo||{}:{},this.deviceTrackingStatus=_?_.trackingStatus:{},this.syncToken=(T=_==null?void 0:_.syncToken)!==null&&T!==void 0?T:null,this.userByIdentityKey={};for(const w of Object.keys(this.devices)){const M=this.devices[w];for(const A of Object.keys(M)){const W=M[A].keys["curve25519:"+A];W!==void 0&&(this.userByIdentityKey[W]=w)}}})});for(const p of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[p]==r.DownloadInProgress&&(this.deviceTrackingStatus[p]=r.PendingDownload)})}stop(){this.saveTimer!==null&&clearTimeout(this.saveTimer)}saveIfDirty(p=500){return y(this,void 0,void 0,function*(){if(!this.dirty)return Promise.resolve(!1);const _=Date.now()+p;this.savePromiseTime&&_<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let T=this.savePromise;if(T===null&&(T=new Promise(w=>{this.resolveSavePromise=w}),this.savePromise=T),this.saveTimer===null){const w=this.resolveSavePromise;this.savePromiseTime=_,this.saveTimer=setTimeout(()=>{c.logger.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[b.IndexedDBCryptoStore.STORE_DEVICE_DATA],M=>{var A;this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:(A=this.syncToken)!==null&&A!==void 0?A:void 0},M)}).then(()=>{this.dirty=!1,w==null||w(!0)},M=>{c.logger.error("Failed to save device tracking data",this.syncToken),c.logger.error(M)})},p)}return T})}getSyncToken(){return this.syncToken}setSyncToken(p){this.syncToken=p}downloadKeys(p,_){const T=[],w=[];if(p.forEach(M=>{const A=this.deviceTrackingStatus[M];this.keyDownloadsInProgressByUser.has(M)?(c.logger.log(`downloadKeys: already have a download in progress for ${M}: awaiting its result`),w.push(this.keyDownloadsInProgressByUser.get(M))):(_||A!=r.UpToDate)&&T.push(M)}),T.length!=0){c.logger.log("downloadKeys: downloading for",T);const M=this.doKeyDownload(T);w.push(M)}return w.length===0&&c.logger.log("downloadKeys: already have all necessary keys"),Promise.all(w).then(()=>this.getDevicesFromStore(p))}getDevicesFromStore(p){const _=new Map;return p.forEach(T=>{var w;const M=new Map;(w=this.getStoredDevicesForUser(T))===null||w===void 0||w.forEach(function(A){M.set(A.deviceId,A)}),_.set(T,M)}),_}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(p){const _=this.devices[p];if(!_)return null;const T=[];for(const w in _)_.hasOwnProperty(w)&&T.push(m.DeviceInfo.fromStorage(_[w],w));return T}getRawStoredDevicesForUser(p){return this.devices[p]}getStoredCrossSigningForUser(p){return this.crossSigningInfo[p]?h.CrossSigningInfo.fromStorage(this.crossSigningInfo[p],p):null}storeCrossSigningForUser(p,_){this.crossSigningInfo[p]=_,this.dirty=!0}getStoredDevice(p,_){const T=this.devices[p];if(T!=null&&T[_])return m.DeviceInfo.fromStorage(T[_],_)}getUserByIdentityKey(p,_){return p!==d.OLM_ALGORITHM&&p!==d.MEGOLM_ALGORITHM?null:this.userByIdentityKey[_]}getDeviceByIdentityKey(p,_){const T=this.getUserByIdentityKey(p,_);if(!T)return null;const w=this.devices[T];if(!w)return null;for(const M in w){if(!w.hasOwnProperty(M))continue;const A=w[M];for(const W in A.keys){if(!A.keys.hasOwnProperty(W)||W.indexOf("curve25519:")!==0)continue;if(A.keys[W]==_)return m.DeviceInfo.fromStorage(A,M)}}return null}storeDevicesForUser(p,_){this.setRawStoredDevicesForUser(p,_),this.dirty=!0}startTrackingDeviceList(p){if(typeof p!="string")throw new Error("userId must be a string; was "+p);this.deviceTrackingStatus[p]||(c.logger.log("Now tracking device list for "+p),this.deviceTrackingStatus[p]=r.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(p){this.deviceTrackingStatus[p]&&(c.logger.log("No longer tracking device list for "+p),this.deviceTrackingStatus[p]=r.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(const p of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[p]=r.NotTracked;this.dirty=!0}invalidateUserDeviceList(p){this.deviceTrackingStatus[p]&&(c.logger.log("Marking device list outdated for",p),this.deviceTrackingStatus[p]=r.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const p=[];for(const _ of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[_]==r.PendingDownload&&p.push(_);return this.doKeyDownload(p)}setRawStoredDevicesForUser(p,_){if(this.devices[p]!==void 0)for(const[T,w]of Object.entries(this.devices[p])){const M=w.keys["curve25519:"+T];delete this.userByIdentityKey[M]}this.devices[p]=_;for(const[T,w]of Object.entries(_)){const M=w.keys["curve25519:"+T];this.userByIdentityKey[M]=p}}setRawStoredCrossSigningForUser(p,_){this.crossSigningInfo[p]=_}doKeyDownload(p){if(p.length===0)return Promise.resolve();const _=this.serialiser.updateDevicesForUsers(p,this.syncToken).then(()=>{T(!0)},w=>{throw c.logger.error("Error downloading keys for "+p+":",w),T(!1),w});p.forEach(w=>{this.keyDownloadsInProgressByUser.set(w,_),this.deviceTrackingStatus[w]==r.PendingDownload&&(this.deviceTrackingStatus[w]=r.DownloadInProgress)});const T=w=>{this.emit(i.CryptoEvent.WillUpdateDevices,p,!this.hasFetched),p.forEach(M=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser.get(M)!==_){c.logger.log("Another update in the queue for",M,"- not marking up-to-date");return}this.keyDownloadsInProgressByUser.delete(M),this.deviceTrackingStatus[M]==r.DownloadInProgress&&(w?(this.deviceTrackingStatus[M]=r.UpToDate,c.logger.log("Device list for",M,"now up to date")):this.deviceTrackingStatus[M]=r.PendingDownload)}),this.saveIfDirty(),this.emit(i.CryptoEvent.DevicesUpdated,p,!this.hasFetched),this.hasFetched=!0};return _}}e.DeviceList=s;class o{constructor(p,_,T){this.baseApis=p,this.olmDevice=_,this.deviceList=T,this.downloadInProgress=!1,this.keyDownloadsQueuedByUser={}}updateDevicesForUsers(p,_){return p.forEach(T=>{this.keyDownloadsQueuedByUser[T]=!0}),this.queuedQueryDeferred||(this.queuedQueryDeferred=(0,a.defer)()),this.syncToken=_,this.downloadInProgress?(c.logger.log("Queued key download for",p),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");const p=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};const _=this.queuedQueryDeferred;this.queuedQueryDeferred=void 0,c.logger.log("Starting key download for",p),this.downloadInProgress=!0;const T={};this.syncToken&&(T.token=this.syncToken);const w=[];for(let M=0;M<p.length;M+=this.deviceList.keyDownloadChunkSize){const A=p.slice(M,M+this.deviceList.keyDownloadChunkSize);w.push(()=>this.baseApis.downloadKeysForUsers(A,T))}return(0,a.chunkPromises)(w,3).then(M=>y(this,void 0,void 0,function*(){const A=Object.assign({},...M.map(C=>C.device_keys||{})),W=Object.assign({},...M.map(C=>C.master_keys||{})),ee=Object.assign({},...M.map(C=>C.self_signing_keys||{})),F=Object.assign({},...M.map(C=>C.user_signing_keys||{}));for(const C of p){yield(0,a.sleep)(5);try{yield this.processQueryResponseForUser(C,A[C],{master:W==null?void 0:W[C],self_signing:ee==null?void 0:ee[C],user_signing:F==null?void 0:F[C]})}catch(O){c.logger.error(`Error processing keys for ${C}:`,O)}}})).then(()=>{c.logger.log("Completed key download for "+p),this.downloadInProgress=!1,_==null||_.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()},M=>{c.logger.warn("Error downloading keys for "+p+":",M),this.downloadInProgress=!1,_==null||_.reject(M)}),_.promise}processQueryResponseForUser(p,_,T){return y(this,void 0,void 0,function*(){c.logger.log("got device keys for "+p+":",_),c.logger.log("got cross-signing keys for "+p+":",T);{const w={},M=this.deviceList.getRawStoredDevicesForUser(p);M&&Object.keys(M).forEach(W=>{const ee=m.DeviceInfo.fromStorage(M[W],W);w[W]=ee}),yield l(this.olmDevice,p,w,_||{},this.baseApis.getUserId(),this.baseApis.deviceId);const A={};Object.keys(w).forEach(W=>{A[W]=w[W].toStorage()}),this.deviceList.setRawStoredDevicesForUser(p,A)}if(T&&(T.master||T.self_signing||T.user_signing)){const w=this.deviceList.getStoredCrossSigningForUser(p)||new h.CrossSigningInfo(p);w.setKeys(T),this.deviceList.setRawStoredCrossSigningForUser(p,w.toStorage()),this.deviceList.emit(i.CryptoEvent.UserCrossSigningUpdated,p)}})}}function l(f,p,_,T,w,M){return y(this,void 0,void 0,function*(){let A=!1;for(const W in _)if(_.hasOwnProperty(W)&&!(W in T)){if(p===w&&W===M){c.logger.warn(`Local device ${W} missing from sync, skipping removal`);continue}c.logger.log("Device "+p+":"+W+" has been removed"),delete _[W],A=!0}for(const W in T){if(!T.hasOwnProperty(W))continue;const ee=T[W];if(ee.user_id!==p){c.logger.warn("Mismatched user_id "+ee.user_id+" in keys from "+p+":"+W);continue}if(ee.device_id!==W){c.logger.warn("Mismatched device_id "+ee.device_id+" in keys from "+p+":"+W);continue}(yield v(f,_,ee))&&(A=!0)}return A})}function v(f,p,_){return y(this,void 0,void 0,function*(){if(!_.keys)return!1;const T=_.device_id,w=_.user_id,M="ed25519:"+T,A=_.keys[M];if(!A)return c.logger.warn("Device "+w+":"+T+" has no ed25519 key"),!1;const W=_.unsigned||{},ee=_.signatures||{};try{yield d.verifySignature(f,_,w,T,A)}catch(C){return c.logger.warn("Unable to verify signature on device "+w+":"+T+":"+C),!1}let F;if(T in p){if(F=p[T],F.getFingerprint()!=A)return c.logger.warn("Ed25519 key for device "+w+":"+T+" has changed"),!1}else p[T]=F=new m.DeviceInfo(T);return F.keys=_.keys||{},F.algorithms=_.algorithms||[],F.unsigned=W,F.signatures=ee,!0})}},{"../logger":374,"../models/typed-event-emitter":395,"../utils":416,"./CrossSigning":324,"./deviceinfo":340,"./index":341,"./olmlib":343,"./store/indexeddb-crypto-store":346}],326:[function(t,E,e){var u=this&&this.__awaiter||function(s,o,l,v){function f(p){return p instanceof l?p:new l(function(_){_(p)})}return new(l||(l=Promise))(function(p,_){function T(A){try{M(v.next(A))}catch(W){_(W)}}function w(A){try{M(v.throw(A))}catch(W){_(W)}}function M(A){A.done?p(A.value):f(A.value).then(T,w)}M((v=v.apply(s,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.EncryptionSetupOperation=e.EncryptionSetupBuilder=void 0;const g=t("../logger"),S=t("../models/event"),y=t("./CrossSigning"),c=t("./store/indexeddb-crypto-store"),m=t("../http-api"),h=t("../client"),d=t("../models/typed-event-emitter");class b{constructor(o,l){this.accountDataClientAdapter=new n(o),this.crossSigningCallbacks=new i,this.ssssCryptoCallbacks=new r(l)}addCrossSigningKeys(o,l){this.crossSigningKeys={authUpload:o,keys:l}}addSessionBackup(o){this.keyBackupInfo=o}addSessionBackupPrivateKeyToCache(o){this.sessionBackupPrivateKey=o}addKeySignature(o,l,v){this.keySignatures||(this.keySignatures={});const f=this.keySignatures[o]||{};this.keySignatures[o]=f,f[l]=v}setAccountData(o,l){return u(this,void 0,void 0,function*(){yield this.accountDataClientAdapter.setAccountData(o,l)})}buildOperation(){const o=this.accountDataClientAdapter.values;return new a(o,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}persist(o){var l;return u(this,void 0,void 0,function*(){if(this.crossSigningKeys){const v=(0,y.createCryptoStoreCacheCallbacks)(o.cryptoStore,o.olmDevice);for(const f of["master","self_signing","user_signing"]){g.logger.log(`Cache ${f} cross-signing private key locally`);const p=this.crossSigningCallbacks.privateKeys.get(f);yield(l=v.storeCrossSigningKeyCache)===null||l===void 0?void 0:l.call(v,f,p)}yield o.cryptoStore.doTxn("readwrite",[c.IndexedDBCryptoStore.STORE_ACCOUNT],f=>{o.cryptoStore.storeCrossSigningKeys(f,this.crossSigningKeys.keys)})}this.sessionBackupPrivateKey&&(yield o.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey))})}}e.EncryptionSetupBuilder=b;class a{constructor(o,l,v,f){this.accountData=o,this.crossSigningKeys=l,this.keyBackupInfo=v,this.keySignatures=f}apply(o){var l,v;return u(this,void 0,void 0,function*(){const f=o.baseApis;if(this.crossSigningKeys){const p={};for(const[_,T]of Object.entries(this.crossSigningKeys.keys))p[_+"_key"]=T;yield(v=(l=this.crossSigningKeys).authUpload)===null||v===void 0?void 0:v.call(l,_=>f.uploadDeviceSigningKeys(_,p)),o.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(const[p,_]of this.accountData)yield f.setAccountData(p,_);this.keySignatures&&(yield f.uploadKeySignatures(this.keySignatures)),this.keyBackupInfo&&(this.keyBackupInfo.version?yield f.http.authedRequest(m.Method.Put,"/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:m.ClientPrefix.V3}):yield f.http.authedRequest(m.Method.Post,"/room_keys/version",void 0,this.keyBackupInfo,{prefix:m.ClientPrefix.V3}))})}}e.EncryptionSetupOperation=a;class n extends d.TypedEventEmitter{constructor(o){super(),this.existingValues=o,this.values=new Map}getAccountDataFromServer(o){return Promise.resolve(this.getAccountData(o))}getAccountData(o){const l=this.values.get(o);if(l)return l;const v=this.existingValues.get(o);return v?v.getContent():null}setAccountData(o,l){const v=this.values.get(o);return this.values.set(o,l),Promise.resolve().then(()=>{const f=new S.MatrixEvent({type:o,content:l});return this.emit(h.ClientEvent.AccountData,f,v),{}})}}class i{constructor(){this.privateKeys=new Map}getCrossSigningKeyCache(o,l){return this.getCrossSigningKey(o,l)}storeCrossSigningKeyCache(o,l){return this.privateKeys.set(o,l),Promise.resolve()}getCrossSigningKey(o,l){var v;return Promise.resolve((v=this.privateKeys.get(o))!==null&&v!==void 0?v:null)}saveCrossSigningKeys(o){for(const[l,v]of Object.entries(o))this.privateKeys.set(l,v)}}class r{constructor(o){this.delegateCryptoCallbacks=o,this.privateKeys=new Map}getSecretStorageKey({keys:o},l){var v;return u(this,void 0,void 0,function*(){for(const f of Object.keys(o)){const p=this.privateKeys.get(f);if(p)return[f,p]}if(!((v=this===null||this===void 0?void 0:this.delegateCryptoCallbacks)===null||v===void 0)&&v.getSecretStorageKey){const f=yield this.delegateCryptoCallbacks.getSecretStorageKey({keys:o},l);if(f){const[p,_]=f;this.privateKeys.set(p,_)}return f}return null})}addPrivateKey(o,l,v){var f,p;this.privateKeys.set(o,v),(p=(f=this.delegateCryptoCallbacks)===null||f===void 0?void 0:f.cacheSecretStorageKey)===null||p===void 0||p.call(f,o,l,v)}}},{"../client":321,"../http-api":367,"../logger":374,"../models/event":383,"../models/typed-event-emitter":395,"./CrossSigning":324,"./store/indexeddb-crypto-store":346}],327:[function(t,E,e){(function(u){(function(){var g=this&&this.__createBinding||(Object.create?function(s,o,l,v){v===void 0&&(v=l);var f=Object.getOwnPropertyDescriptor(o,l);(!f||("get"in f?!o.__esModule:f.writable||f.configurable))&&(f={enumerable:!0,get:function(){return o[l]}}),Object.defineProperty(s,v,f)}:function(s,o,l,v){v===void 0&&(v=l),s[v]=o[l]}),S=this&&this.__setModuleDefault||(Object.create?function(s,o){Object.defineProperty(s,"default",{enumerable:!0,value:o})}:function(s,o){s.default=o}),y=this&&this.__importStar||function(s){if(s&&s.__esModule)return s;var o={};if(s!=null)for(var l in s)l!=="default"&&Object.prototype.hasOwnProperty.call(s,l)&&g(o,s,l);return S(o,s),o},c=this&&this.__awaiter||function(s,o,l,v){function f(p){return p instanceof l?p:new l(function(_){_(p)})}return new(l||(l=Promise))(function(p,_){function T(A){try{M(v.next(A))}catch(W){_(W)}}function w(A){try{M(v.throw(A))}catch(W){_(W)}}function M(A){A.done?p(A.value):f(A.value).then(T,w)}M((v=v.apply(s,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.WITHHELD_MESSAGES=e.OlmDevice=e.PayloadTooLargeError=void 0;const m=t("../logger"),h=t("./store/indexeddb-crypto-store"),d=y(t("./algorithms")),b=65536*3/4;class a extends Error{constructor(){super(...arguments),this.data={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"}}}e.PayloadTooLargeError=a;function n(s){if(s===void 0)throw new Error("payloadString undefined");if(s.length>b)throw new a(`Message too long (${s.length} bytes). The maximum for an encrypted message is ${b} bytes.`)}class i{constructor(o){this.cryptoStore=o,this.pickleKey="DEFAULT_KEY",this.deviceCurve25519Key=null,this.deviceEd25519Key=null,this.maxOneTimeKeys=null,this.outboundGroupSessionStore={},this.inboundGroupSessionMessageIndexes={},this.sessionsInProgress={},this.olmPrekeyPromise=Promise.resolve()}static getOlmVersion(){return u.Olm.get_library_version()}init({pickleKey:o,fromExportedDevice:l}={}){return c(this,void 0,void 0,function*(){let v;const f=new u.Olm.Account;try{l?(o&&m.logger.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=l.pickleKey,yield this.initialiseFromExportedDevice(l,f)):(o&&(this.pickleKey=o),yield this.initialiseAccount(f)),v=JSON.parse(f.identity_keys()),this.maxOneTimeKeys=f.max_number_of_one_time_keys()}finally{f.free()}this.deviceCurve25519Key=v.curve25519,this.deviceEd25519Key=v.ed25519})}initialiseFromExportedDevice(o,l){return c(this,void 0,void 0,function*(){yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_ACCOUNT,h.IndexedDBCryptoStore.STORE_SESSIONS],v=>{this.cryptoStore.storeAccount(v,o.pickledAccount),o.sessions.forEach(f=>{const{deviceKey:p,sessionId:_}=f,T={session:f.session,lastReceivedMessageTs:f.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(p,_,T,v)})}),l.unpickle(this.pickleKey,o.pickledAccount)})}initialiseAccount(o){return c(this,void 0,void 0,function*(){yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_ACCOUNT],l=>{this.cryptoStore.getAccount(l,v=>{v!==null?o.unpickle(this.pickleKey,v):(o.create(),v=o.pickle(this.pickleKey),this.cryptoStore.storeAccount(l,v))})})})}getAccount(o,l){this.cryptoStore.getAccount(o,v=>{const f=new u.Olm.Account;try{f.unpickle(this.pickleKey,v),l(f)}finally{f.free()}})}storeAccount(o,l){this.cryptoStore.storeAccount(o,l.pickle(this.pickleKey))}export(){return c(this,void 0,void 0,function*(){const o={pickleKey:this.pickleKey};return yield this.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_ACCOUNT,h.IndexedDBCryptoStore.STORE_SESSIONS],l=>{this.cryptoStore.getAccount(l,v=>{o.pickledAccount=v}),o.sessions=[],this.cryptoStore.getAllEndToEndSessions(l,v=>{o.sessions.push(v)})}),o})}getSession(o,l,v,f){this.cryptoStore.getEndToEndSession(o,l,v,p=>{this.unpickleSession(p,f)})}unpickleSession(o,l){const v=new u.Olm.Session;try{v.unpickle(this.pickleKey,o.session);const f=Object.assign({},o,{session:v});l(f)}finally{v.free()}}saveSession(o,l,v){const f=l.session.session_id();m.logger.debug(`Saving Olm session ${f} with device ${o}: ${l.session.describe()}`);const p=Object.assign(l,{session:l.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(o,f,p,v)}getUtility(o){const l=new u.Olm.Utility;try{return o(l)}finally{l.free()}}sign(o){return c(this,void 0,void 0,function*(){let l;return yield this.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_ACCOUNT],v=>{this.getAccount(v,f=>{l=f.sign(o)})}),l})}getOneTimeKeys(){return c(this,void 0,void 0,function*(){let o;return yield this.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_ACCOUNT],l=>{this.getAccount(l,v=>{o=JSON.parse(v.one_time_keys())})}),o})}maxNumberOfOneTimeKeys(){var o;return(o=this.maxOneTimeKeys)!==null&&o!==void 0?o:-1}markKeysAsPublished(){return c(this,void 0,void 0,function*(){yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_ACCOUNT],o=>{this.getAccount(o,l=>{l.mark_keys_as_published(),this.storeAccount(o,l)})})})}generateOneTimeKeys(o){return this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_ACCOUNT],l=>{this.getAccount(l,v=>{v.generate_one_time_keys(o),this.storeAccount(l,v)})})}generateFallbackKey(){return c(this,void 0,void 0,function*(){yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_ACCOUNT],o=>{this.getAccount(o,l=>{l.generate_fallback_key(),this.storeAccount(o,l)})})})}getFallbackKey(){return c(this,void 0,void 0,function*(){let o;return yield this.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_ACCOUNT],l=>{this.getAccount(l,v=>{o=JSON.parse(v.unpublished_fallback_key())})}),o})}forgetOldFallbackKey(){return c(this,void 0,void 0,function*(){yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_ACCOUNT],o=>{this.getAccount(o,l=>{l.forget_old_fallback_key(),this.storeAccount(o,l)})})})}createOutboundSession(o,l){return c(this,void 0,void 0,function*(){let v;return yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_ACCOUNT,h.IndexedDBCryptoStore.STORE_SESSIONS],f=>{this.getAccount(f,p=>{const _=new u.Olm.Session;try{_.create_outbound(p,o,l),v=_.session_id(),this.storeAccount(f,p);const T={session:_,lastReceivedMessageTs:Date.now()};this.saveSession(o,T,f)}finally{_.free()}})},m.logger.withPrefix("[createOutboundSession]")),v})}createInboundSession(o,l,v){return c(this,void 0,void 0,function*(){if(l!==0)throw new Error("Need messageType == 0 to create inbound session");let f;return yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_ACCOUNT,h.IndexedDBCryptoStore.STORE_SESSIONS],p=>{this.getAccount(p,_=>{const T=new u.Olm.Session;try{T.create_inbound_from(_,o,v),_.remove_one_time_keys(T),this.storeAccount(p,_);const w=T.decrypt(l,v),M={session:T,lastReceivedMessageTs:Date.now()};this.saveSession(o,M,p),f={payload:w,session_id:T.session_id()}}finally{T.free()}})},m.logger.withPrefix("[createInboundSession]")),f})}getSessionIdsForDevice(o){return c(this,void 0,void 0,function*(){const l=m.logger.withPrefix("[getSessionIdsForDevice]");if(o in this.sessionsInProgress){l.debug(`Waiting for Olm session for ${o} to be created`);try{yield this.sessionsInProgress[o]}catch{}}let v;return yield this.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_SESSIONS],f=>{this.cryptoStore.getEndToEndSessions(o,f,p=>{v=Object.keys(p)})},l),v})}getSessionIdForDevice(o,l=!1,v){return c(this,void 0,void 0,function*(){const f=yield this.getSessionInfoForDevice(o,l,v);if(f.length===0)return null;let p=0;for(let _=1;_<f.length;_++){const T=f[_],w=T.lastReceivedMessageTs===void 0?0:T.lastReceivedMessageTs,M=f[p],A=M.lastReceivedMessageTs===void 0?0:M.lastReceivedMessageTs;(w>A||w===A&&T.sessionId<M.sessionId)&&(p=_)}return f[p].sessionId})}getSessionInfoForDevice(o,l=!1,v=m.logger){return c(this,void 0,void 0,function*(){if(v=v.withPrefix("[getSessionInfoForDevice]"),o in this.sessionsInProgress&&!l){v.debug(`Waiting for Olm session for ${o} to be created`);try{yield this.sessionsInProgress[o]}catch{}}const f=[];return yield this.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_SESSIONS],p=>{this.cryptoStore.getEndToEndSessions(o,p,_=>{const T=Object.keys(_).sort();for(const w of T)this.unpickleSession(_[w],M=>{f.push({lastReceivedMessageTs:M.lastReceivedMessageTs,hasReceivedMessage:M.session.has_received_message(),sessionId:w})})})},v),f})}encryptMessage(o,l,v){return c(this,void 0,void 0,function*(){n(v);let f;return yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_SESSIONS],p=>{this.getSession(o,l,p,_=>{const T=_.session.describe();m.logger.log("encryptMessage: Olm Session ID "+l+" to "+o+": "+T),f=_.session.encrypt(v),this.saveSession(o,_,p)})},m.logger.withPrefix("[encryptMessage]")),f})}decryptMessage(o,l,v,f){return c(this,void 0,void 0,function*(){let p;return yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_SESSIONS],_=>{this.getSession(o,l,_,T=>{const w=T.session.describe();m.logger.log("decryptMessage: Olm Session ID "+l+" from "+o+": "+w),p=T.session.decrypt(v,f),T.lastReceivedMessageTs=Date.now(),this.saveSession(o,T,_)})},m.logger.withPrefix("[decryptMessage]")),p})}matchesSession(o,l,v,f){return c(this,void 0,void 0,function*(){if(v!==0)return!1;let p;return yield this.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_SESSIONS],_=>{this.getSession(o,l,_,T=>{p=T.session.matches_inbound(f)})},m.logger.withPrefix("[matchesSession]")),p})}recordSessionProblem(o,l,v){return c(this,void 0,void 0,function*(){m.logger.info(`Recording problem on olm session with ${o} of type ${l}. Recreating: ${v}`),yield this.cryptoStore.storeEndToEndSessionProblem(o,l,v)})}sessionMayHaveProblems(o,l){return this.cryptoStore.getEndToEndSessionProblem(o,l)}filterOutNotifiedErrorDevices(o){return this.cryptoStore.filterOutNotifiedErrorDevices(o)}saveOutboundGroupSession(o){this.outboundGroupSessionStore[o.session_id()]=o.pickle(this.pickleKey)}getOutboundGroupSession(o,l){const v=this.outboundGroupSessionStore[o];if(v===void 0)throw new Error("Unknown outbound group session "+o);const f=new u.Olm.OutboundGroupSession;try{return f.unpickle(this.pickleKey,v),l(f)}finally{f.free()}}createOutboundGroupSession(){const o=new u.Olm.OutboundGroupSession;try{return o.create(),this.saveOutboundGroupSession(o),o.session_id()}finally{o.free()}}encryptGroupMessage(o,l){return m.logger.log(`encrypting msg with megolm session ${o}`),n(l),this.getOutboundGroupSession(o,v=>{const f=v.encrypt(l);return this.saveOutboundGroupSession(v),f})}getOutboundGroupSessionKey(o){return this.getOutboundGroupSession(o,function(l){return{chain_index:l.message_index(),key:l.session_key()}})}unpickleInboundGroupSession(o,l){const v=new u.Olm.InboundGroupSession;try{return v.unpickle(this.pickleKey,o.session),l(v)}finally{v.free()}}getInboundGroupSession(o,l,v,f,p){this.cryptoStore.getEndToEndInboundGroupSession(l,v,f,(_,T)=>{if(_===null){p(null,null,T);return}if(o!==null&&o!==_.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+_.room_id+", was "+o+")");this.unpickleInboundGroupSession(_,w=>{p(w,_,T)})})}addInboundGroupSession(o,l,v,f,p,_,T,w={}){return c(this,void 0,void 0,function*(){yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,h.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,h.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],M=>{this.getInboundGroupSession(o,l,f,M,(A,W)=>{const ee=new u.Olm.InboundGroupSession;try{if(T?ee.import_session(p):ee.create(p),f!=ee.session_id())throw new Error("Mismatched group session ID from senderKey: "+l);if(A&&(m.logger.log(`Update for megolm session ${l}|${f}`),A.first_known_index()<=ee.first_known_index())){if(!W.untrusted||w.untrusted){m.logger.log(`Keeping existing megolm session ${l}|${f}`);return}if(A.first_known_index()<ee.first_known_index()){A.export_session(ee.first_known_index())===ee.export_session(ee.first_known_index())?(m.logger.info(`Upgrading trust of existing megolm session ${l}|${f} based on newly-received trusted session`),W.untrusted=!1,this.cryptoStore.storeEndToEndInboundGroupSession(l,f,W,M)):m.logger.warn(`Newly-received megolm session ${l}|$sessionId} does not match existing session! Keeping existing session`);return}}m.logger.info(`Storing megolm session ${l}|${f} with first index `+ee.first_known_index());const F=Object.assign({},w,{room_id:o,session:ee.pickle(this.pickleKey),keysClaimed:_,forwardingCurve25519KeyChain:v});this.cryptoStore.storeEndToEndInboundGroupSession(l,f,F,M),!A&&w.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(o,l,f,M)}finally{ee.free()}})},m.logger.withPrefix("[addInboundGroupSession]"))})}addInboundGroupSessionWithheld(o,l,v,f,p){return c(this,void 0,void 0,function*(){yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],_=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(l,v,{room_id:o,code:f,reason:p},_)})})}decryptGroupMessage(o,l,v,f,p,_){return c(this,void 0,void 0,function*(){let T=null,w;if(yield this.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,h.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],M=>{this.getInboundGroupSession(o,l,v,M,(A,W,ee)=>{if(A===null||W===null){ee&&(w=new d.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",r(ee),{session:l+"|"+v})),T=null;return}let F;try{F=A.decrypt(f)}catch(O){(O==null?void 0:O.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&ee?w=new d.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",r(ee),{session:l+"|"+v}):w=O;return}let C=F.plaintext;if(C===void 0)C=F;else{const O=l+"|"+v+"|"+F.message_index;if(O in this.inboundGroupSessionMessageIndexes){const I=this.inboundGroupSessionMessageIndexes[O];if(I.id!==p||I.timestamp!==_){w=new Error("Duplicate message index, possible replay attack: "+O);return}}this.inboundGroupSessionMessageIndexes[O]={id:p,timestamp:_}}W.session=A.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(l,v,W,M),T={result:C,keysClaimed:W.keysClaimed||{},senderKey:l,forwardingCurve25519KeyChain:W.forwardingCurve25519KeyChain||[],untrusted:!!W.untrusted}})},m.logger.withPrefix("[decryptGroupMessage]")),w)throw w;return T})}hasInboundSessionKeys(o,l,v){return c(this,void 0,void 0,function*(){let f;return yield this.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,h.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],p=>{this.cryptoStore.getEndToEndInboundGroupSession(l,v,p,_=>{if(_===null){f=!1;return}o!==_.room_id?(m.logger.warn(`requested keys for inbound group session ${l}|${v}, with incorrect room_id (expected ${_.room_id}, was ${o})`),f=!1):f=!0})},m.logger.withPrefix("[hasInboundSessionKeys]")),f})}getInboundGroupSessionKey(o,l,v,f){return c(this,void 0,void 0,function*(){let p=null;return yield this.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,h.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],_=>{this.getInboundGroupSession(o,l,v,_,(T,w)=>{if(T===null||w===null){p=null;return}f===void 0&&(f=T.first_known_index());const M=T.export_session(f),W=(w.keysClaimed||{}).ed25519||null,ee=w.forwardingCurve25519KeyChain||[],F="untrusted"in w?w.untrusted:ee.length>0;p={chain_index:f,key:M,forwarding_curve25519_key_chain:ee,sender_claimed_ed25519_key:W,shared_history:w.sharedHistory||!1,untrusted:F}})},m.logger.withPrefix("[getInboundGroupSessionKey]")),p})}exportInboundGroupSession(o,l,v){return this.unpickleInboundGroupSession(v,f=>{const p=f.first_known_index();return{sender_key:o,sender_claimed_keys:v.keysClaimed,room_id:v.room_id,session_id:l,session_key:f.export_session(p),forwarding_curve25519_key_chain:v.forwardingCurve25519KeyChain||[],first_known_index:f.first_known_index(),"org.matrix.msc3061.shared_history":v.sharedHistory||!1}})}getSharedHistoryInboundGroupSessions(o){return c(this,void 0,void 0,function*(){let l;return yield this.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],v=>{l=this.cryptoStore.getSharedHistoryInboundGroupSessions(o,v)},m.logger.withPrefix("[getSharedHistoryInboundGroupSessionsForRoom]")),l})}verifySignature(o,l,v){this.getUtility(function(f){f.ed25519_verify(o,l,v)})}}e.OlmDevice=i,e.WITHHELD_MESSAGES={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function r(s){return s.code&&s.code in e.WITHHELD_MESSAGES?e.WITHHELD_MESSAGES[s.code]:s.reason?s.reason:"decryption key withheld"}}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../logger":374,"./algorithms":333,"./store/indexeddb-crypto-store":346}],328:[function(t,E,e){var u=this&&this.__awaiter||function(n,i,r,s){function o(l){return l instanceof r?l:new r(function(v){v(l)})}return new(r||(r=Promise))(function(l,v){function f(T){try{_(s.next(T))}catch(w){v(w)}}function p(T){try{_(s.throw(T))}catch(w){v(w)}}function _(T){T.done?l(T.value):o(T.value).then(f,p)}_((s=s.apply(n,i||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.OutgoingRoomKeyRequestManager=e.RoomKeyRequestState=void 0;const g=t("uuid"),S=t("../logger"),y=t("../@types/event"),c=t("../utils"),m=500;var h;(function(n){n[n.Unsent=0]="Unsent",n[n.Sent=1]="Sent",n[n.CancellationPending=2]="CancellationPending",n[n.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend"})(h=e.RoomKeyRequestState||(e.RoomKeyRequestState={}));class d{constructor(i,r,s){this.baseApis=i,this.deviceId=r,this.cryptoStore=s,this.sendOutgoingRoomKeyRequestsRunning=!1,this.clientRunning=!0}stop(){S.logger.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}queueRoomKeyRequest(i,r,s=!1){return u(this,void 0,void 0,function*(){const o=yield this.cryptoStore.getOutgoingRoomKeyRequest(i);if(!o)yield this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:i,recipients:r,requestId:this.baseApis.makeTxnId(),state:h.Unsent});else switch(o.state){case h.CancellationPendingAndWillResend:case h.Unsent:return;case h.CancellationPending:{const l=s?h.CancellationPendingAndWillResend:h.Sent;yield this.cryptoStore.updateOutgoingRoomKeyRequest(o.requestId,h.CancellationPending,{state:l,cancellationTxnId:this.baseApis.makeTxnId()});break}case h.Sent:{if(s){const l=h.CancellationPendingAndWillResend,v=yield this.cryptoStore.updateOutgoingRoomKeyRequest(o.requestId,h.Sent,{state:l,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!v)return this.queueRoomKeyRequest(i,r,s);try{yield this.sendOutgoingRoomKeyRequestCancellation(v,!0)}catch(f){S.logger.error("Error sending room key request cancellation; will retry later.",f)}}break}default:throw new Error("unhandled state: "+o.state)}})}cancelRoomKeyRequest(i){return this.cryptoStore.getOutgoingRoomKeyRequest(i).then(r=>{if(r)switch(r.state){case h.CancellationPending:case h.CancellationPendingAndWillResend:return;case h.Unsent:return S.logger.log("deleting unnecessary room key request for "+b(i)),this.cryptoStore.deleteOutgoingRoomKeyRequest(r.requestId,h.Unsent);case h.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(r.requestId,h.Sent,{state:h.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then(s=>{if(!s){S.logger.log("Tried to cancel room key request for "+b(i)+" but it was already cancelled in another tab");return}this.sendOutgoingRoomKeyRequestCancellation(s).catch(o=>{S.logger.error("Error sending room key request cancellation; will retry later.",o),this.startTimer()})});default:throw new Error("unhandled state: "+r.state)}})}getOutgoingSentRoomKeyRequest(i,r){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(i,r,[h.Sent])}cancelAndResendAllOutgoingRequests(){return u(this,void 0,void 0,function*(){const i=yield this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(h.Sent);return Promise.all(i.map(({requestBody:r,recipients:s})=>this.queueRoomKeyRequest(r,s,!0)))})}startTimer(){if(this.sendOutgoingRoomKeyRequestsTimer)return;const i=()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally(()=>{this.sendOutgoingRoomKeyRequestsRunning=!1}).catch(r=>{S.logger.warn(`error in OutgoingRoomKeyRequestManager: ${r}`)})};this.sendOutgoingRoomKeyRequestsTimer=setTimeout(i,m)}sendOutgoingRoomKeyRequests(){return u(this,void 0,void 0,function*(){if(!this.clientRunning){this.sendOutgoingRoomKeyRequestsTimer=void 0;return}const i=yield this.cryptoStore.getOutgoingRoomKeyRequestByState([h.CancellationPending,h.CancellationPendingAndWillResend,h.Unsent]);if(!i){this.sendOutgoingRoomKeyRequestsTimer=void 0;return}try{switch(i.state){case h.Unsent:yield this.sendOutgoingRoomKeyRequest(i);break;case h.CancellationPending:yield this.sendOutgoingRoomKeyRequestCancellation(i);break;case h.CancellationPendingAndWillResend:yield this.sendOutgoingRoomKeyRequestCancellation(i,!0);break}return this.sendOutgoingRoomKeyRequests()}catch(r){S.logger.error("Error sending room key request; will retry later.",r),this.sendOutgoingRoomKeyRequestsTimer=void 0}})}sendOutgoingRoomKeyRequest(i){S.logger.log(`Requesting keys for ${b(i.requestBody)} from ${a(i.recipients)}(id ${i.requestId})`);const r={action:"request",requesting_device_id:this.deviceId,request_id:i.requestId,body:i.requestBody};return this.sendMessageToDevices(r,i.recipients,i.requestTxnId||i.requestId).then(()=>this.cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,h.Unsent,{state:h.Sent}))}sendOutgoingRoomKeyRequestCancellation(i,r=!1){S.logger.log(`Sending cancellation for key request for ${b(i.requestBody)} to ${a(i.recipients)} (cancellation id ${i.cancellationTxnId})`);const s={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:i.requestId};return this.sendMessageToDevices(s,i.recipients,i.cancellationTxnId).then(()=>r?this.cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,h.CancellationPendingAndWillResend,{state:h.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(i.requestId,h.CancellationPending))}sendMessageToDevices(i,r,s){const o=new c.MapWithDefault(()=>new Map);for(const l of r)o.getOrCreate(l.userId).set(l.deviceId,Object.assign(Object.assign({},i),{[y.ToDeviceMessageId]:(0,g.v4)()}));return this.baseApis.sendToDevice(y.EventType.RoomKeyRequest,o,s)}}e.OutgoingRoomKeyRequestManager=d;function b(n){return n.room_id+" / "+n.session_id}function a(n){return`[${n.map(i=>`${i.userId}:${i.deviceId}`).join(",")}]`}},{"../@types/event":306,"../logger":374,"../utils":416,uuid:287}],329:[function(t,E,e){var u=this&&this.__awaiter||function(y,c,m,h){function d(b){return b instanceof m?b:new m(function(a){a(b)})}return new(m||(m=Promise))(function(b,a){function n(s){try{r(h.next(s))}catch(o){a(o)}}function i(s){try{r(h.throw(s))}catch(o){a(o)}}function r(s){s.done?b(s.value):d(s.value).then(n,i)}r((h=h.apply(y,c||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.RoomList=void 0;const g=t("./store/indexeddb-crypto-store");class S{constructor(c){this.cryptoStore=c,this.roomEncryption={}}init(){return u(this,void 0,void 0,function*(){yield this.cryptoStore.doTxn("readwrite",[g.IndexedDBCryptoStore.STORE_ROOMS],c=>{this.cryptoStore.getEndToEndRooms(c,m=>{this.roomEncryption=m})})})}getRoomEncryption(c){return this.roomEncryption[c]||null}isRoomEncrypted(c){return!!this.getRoomEncryption(c)}setRoomEncryption(c,m){return u(this,void 0,void 0,function*(){this.roomEncryption[c]=m,yield this.cryptoStore.doTxn("readwrite",[g.IndexedDBCryptoStore.STORE_ROOMS],h=>{this.cryptoStore.storeEndToEndRoom(c,m,h)})})}}e.RoomList=S},{"./store/indexeddb-crypto-store":346}],330:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(s,o,l,v){v===void 0&&(v=l);var f=Object.getOwnPropertyDescriptor(o,l);(!f||("get"in f?!o.__esModule:f.writable||f.configurable))&&(f={enumerable:!0,get:function(){return o[l]}}),Object.defineProperty(s,v,f)}:function(s,o,l,v){v===void 0&&(v=l),s[v]=o[l]}),g=this&&this.__setModuleDefault||(Object.create?function(s,o){Object.defineProperty(s,"default",{enumerable:!0,value:o})}:function(s,o){s.default=o}),S=this&&this.__importStar||function(s){if(s&&s.__esModule)return s;var o={};if(s!=null)for(var l in s)l!=="default"&&Object.prototype.hasOwnProperty.call(s,l)&&u(o,s,l);return g(o,s),o},y=this&&this.__awaiter||function(s,o,l,v){function f(p){return p instanceof l?p:new l(function(_){_(p)})}return new(l||(l=Promise))(function(p,_){function T(A){try{M(v.next(A))}catch(W){_(W)}}function w(A){try{M(v.throw(A))}catch(W){_(W)}}function M(A){A.done?p(A.value):f(A.value).then(T,w)}M((v=v.apply(s,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.SecretStorage=e.SECRET_STORAGE_ALGORITHM_V1_AES=void 0;const c=t("uuid"),m=t("../logger"),h=S(t("./olmlib")),d=t("../randomstring"),b=t("./aes"),a=t("../client"),n=t("../utils"),i=t("../@types/event");e.SECRET_STORAGE_ALGORITHM_V1_AES="m.secret_storage.v1.aes-hmac-sha2";class r{constructor(o,l,v){this.accountDataAdapter=o,this.cryptoCallbacks=l,this.baseApis=v,this.requests=new Map}getDefaultKeyId(){return y(this,void 0,void 0,function*(){const o=yield this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return o?o.key:null})}setDefaultKeyId(o){return new Promise((l,v)=>{const f=p=>{p.getType()==="m.secret_storage.default_key"&&p.getContent().key===o&&(this.accountDataAdapter.removeListener(a.ClientEvent.AccountData,f),l())};this.accountDataAdapter.on(a.ClientEvent.AccountData,f),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:o}).catch(p=>{this.accountDataAdapter.removeListener(a.ClientEvent.AccountData,f),v(p)})})}addKey(o,l={},v){return y(this,void 0,void 0,function*(){if(o!==e.SECRET_STORAGE_ALGORITHM_V1_AES)throw new Error(`Unknown key algorithm ${o}`);const f={algorithm:o};if(l.name&&(f.name=l.name),l.passphrase&&(f.passphrase=l.passphrase),l.key){const{iv:p,mac:_}=yield(0,b.calculateKeyCheck)(l.key);f.iv=p,f.mac=_}if(!v)do v=(0,d.randomString)(32);while(yield this.accountDataAdapter.getAccountDataFromServer(`m.secret_storage.key.${v}`));return yield this.accountDataAdapter.setAccountData(`m.secret_storage.key.${v}`,f),{keyId:v,keyInfo:f}})}getKey(o){return y(this,void 0,void 0,function*(){if(o||(o=yield this.getDefaultKeyId()),!o)return null;const l=yield this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+o);return l?[o,l]:null})}hasKey(o){return y(this,void 0,void 0,function*(){return!!(yield this.getKey(o))})}checkKey(o,l){return y(this,void 0,void 0,function*(){if(l.algorithm===e.SECRET_STORAGE_ALGORITHM_V1_AES)if(l.mac){const{mac:v}=yield(0,b.calculateKeyCheck)(o,l.iv);return l.mac.replace(/=+$/g,"")===v.replace(/=+$/g,"")}else return!0;else throw new Error("Unknown algorithm")})}store(o,l,v){return y(this,void 0,void 0,function*(){const f={};if(!v){const p=yield this.getDefaultKeyId();if(!p)throw new Error("No keys specified and no default key present");v=[p]}if(v.length===0)throw new Error("Zero keys given to encrypt with!");for(const p of v){const _=yield this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+p);if(!_)throw new Error("Unknown key: "+p);if(_.algorithm===e.SECRET_STORAGE_ALGORITHM_V1_AES){const T={[p]:_},[,w]=yield this.getSecretStorageKey(T,o);f[p]=yield w.encrypt(l)}else m.logger.warn("unknown algorithm for secret storage key "+p+": "+_.algorithm)}yield this.accountDataAdapter.setAccountData(o,{encrypted:f})})}get(o){return y(this,void 0,void 0,function*(){const l=yield this.accountDataAdapter.getAccountDataFromServer(o);if(!l)return;if(!l.encrypted)throw new Error("Content is not encrypted!");const v={};for(const T of Object.keys(l.encrypted)){const w=yield this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+T),M=l.encrypted[T];w.algorithm===e.SECRET_STORAGE_ALGORITHM_V1_AES&&M.iv&&M.ciphertext&&M.mac&&(v[T]=w)}if(Object.keys(v).length===0)throw new Error(`Could not decrypt ${o} because none of the keys it is encrypted with are for a supported algorithm`);const[f,p]=yield this.getSecretStorageKey(v,o),_=l.encrypted[f];return p.decrypt(_)})}isStored(o){return y(this,void 0,void 0,function*(){const l=yield this.accountDataAdapter.getAccountDataFromServer(o);if(!(l!=null&&l.encrypted))return null;const v={};for(const f of Object.keys(l.encrypted)){const p=yield this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+f);if(!p)continue;const _=l.encrypted[f];p.algorithm===e.SECRET_STORAGE_ALGORITHM_V1_AES&&_.iv&&_.ciphertext&&_.mac&&(v[f]=p)}return Object.keys(v).length?v:null})}request(o,l){const v=this.baseApis.makeTxnId(),f=(0,n.defer)();this.requests.set(v,{name:o,devices:l,deferred:f});const p=w=>{const M={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:v},A=new Map;for(const W of l)A.set(W,M);this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),A]])),f.reject(new Error(w||"Cancelled"))},_={name:o,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:v,[i.ToDeviceMessageId]:(0,c.v4)()},T=new Map;for(const w of l)T.set(w,_);return m.logger.info(`Request secret ${o} from ${l}, id ${v}`),this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),T]])),{requestId:v,promise:f.promise,cancel:p}}onRequestReceived(o){return y(this,void 0,void 0,function*(){const l=o.getSender(),v=o.getContent();if(l!==this.baseApis.getUserId()||!(v.name&&v.action&&v.requesting_device_id&&v.request_id))return;const f=v.requesting_device_id;if(v.action!=="request_cancellation"){if(v.action==="request"){if(f===this.baseApis.deviceId||(m.logger.info("received request for secret ("+l+", "+f+", "+v.request_id+")"),!this.cryptoCallbacks.onSecretRequested))return;const p=yield this.cryptoCallbacks.onSecretRequested(l,f,v.request_id,v.name,this.baseApis.checkDeviceTrust(l,f));if(p){m.logger.info(`Preparing ${v.name} secret for ${f}`);const _={type:"m.secret.send",content:{request_id:v.request_id,secret:p}},T={algorithm:h.OLM_ALGORITHM,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{},[i.ToDeviceMessageId]:(0,c.v4)()};yield h.ensureOlmSessionsForDevices(this.baseApis.crypto.olmDevice,this.baseApis,new Map([[l,[this.baseApis.getStoredDevice(l,f)]]])),yield h.encryptMessageForDevice(T.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,l,this.baseApis.getStoredDevice(l,f),_);const w=new Map([[l,new Map([[f,T]])]]);m.logger.info(`Sending ${v.name} secret for ${f}`),this.baseApis.sendToDevice("m.room.encrypted",w)}else m.logger.info(`Request denied for ${v.name} secret for ${f}`)}}})}onSecretReceived(o){if(o.getSender()!==this.baseApis.getUserId())return;if(!h.isOlmEncrypted(o)){m.logger.error("secret event not properly encrypted");return}const l=o.getContent();if(this.baseApis.crypto.deviceList.getUserByIdentityKey(h.OLM_ALGORITHM,o.getSenderKey()||"")!==o.getSender()){m.logger.error("sending device does not belong to the user it claims to be from");return}m.logger.log("got secret share for request",l.request_id);const f=this.requests.get(l.request_id);if(f){const p=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(h.OLM_ALGORITHM,o.getSenderKey());if(!p){m.logger.log("secret share from unknown device with key",o.getSenderKey());return}if(!f.devices.includes(p.deviceId)){m.logger.log("unsolicited secret share from device",p.deviceId);return}if(!this.baseApis.crypto.checkDeviceInfoTrust(o.getSender(),p).isVerified()){m.logger.log("secret share from unverified device");return}m.logger.log(`Successfully received secret ${f.name} from ${p.deviceId}`),f.deferred.resolve(l.secret)}}getSecretStorageKey(o,l){return y(this,void 0,void 0,function*(){if(!this.cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const v=yield this.cryptoCallbacks.getSecretStorageKey({keys:o},l);if(!v)throw new Error("getSecretStorageKey callback returned falsey");if(v.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[f,p]=v;if(!o[f])throw new Error("App returned unknown key from getSecretStorageKey!");if(o[f].algorithm===e.SECRET_STORAGE_ALGORITHM_V1_AES)return[f,{encrypt:function(T){return(0,b.encryptAES)(T,p,l)},decrypt:function(T){return(0,b.decryptAES)(T,p,l)}}];throw new Error("Unknown key type: "+o[f].algorithm)})}}e.SecretStorage=r},{"../@types/event":306,"../client":321,"../logger":374,"../randomstring":398,"../utils":416,"./aes":331,"./olmlib":343,uuid:287}],331:[function(t,E,e){var u=this&&this.__awaiter||function(a,n,i,r){function s(o){return o instanceof i?o:new i(function(l){l(o)})}return new(i||(i=Promise))(function(o,l){function v(_){try{p(r.next(_))}catch(T){l(T)}}function f(_){try{p(r.throw(_))}catch(T){l(T)}}function p(_){_.done?o(_.value):s(_.value).then(v,f)}p((r=r.apply(a,n||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.calculateKeyCheck=e.decryptAES=e.encryptAES=void 0;const g=t("./olmlib"),S=t("./crypto"),y=new Uint8Array(8);function c(a,n,i,r){return u(this,void 0,void 0,function*(){let s;r?s=(0,g.decodeBase64)(r):(s=new Uint8Array(16),S.crypto.getRandomValues(s),s[8]&=127);const[o,l]=yield h(n,i),v=new S.TextEncoder().encode(a),f=yield S.subtleCrypto.encrypt({name:"AES-CTR",counter:s,length:64},o,v),p=yield S.subtleCrypto.sign({name:"HMAC"},l,f);return{iv:(0,g.encodeBase64)(s),ciphertext:(0,g.encodeBase64)(f),mac:(0,g.encodeBase64)(p)}})}e.encryptAES=c;function m(a,n,i){return u(this,void 0,void 0,function*(){const[r,s]=yield h(n,i),o=(0,g.decodeBase64)(a.ciphertext);if(!(yield S.subtleCrypto.verify({name:"HMAC"},s,(0,g.decodeBase64)(a.mac),o)))throw new Error(`Error decrypting secret ${i}: bad MAC`);const l=yield S.subtleCrypto.decrypt({name:"AES-CTR",counter:(0,g.decodeBase64)(a.iv),length:64},r,o);return new TextDecoder().decode(new Uint8Array(l))})}e.decryptAES=m;function h(a,n){return u(this,void 0,void 0,function*(){const i=yield S.subtleCrypto.importKey("raw",a,{name:"HKDF"},!1,["deriveBits"]),r=yield S.subtleCrypto.deriveBits({name:"HKDF",salt:y,info:new S.TextEncoder().encode(n),hash:"SHA-256"},i,512),s=r.slice(0,32),o=r.slice(32),l=S.subtleCrypto.importKey("raw",s,{name:"AES-CTR"},!1,["encrypt","decrypt"]),v=S.subtleCrypto.importKey("raw",o,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([l,v])})}const d="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function b(a,n){return c(d,a,"",n)}e.calculateKeyCheck=b},{"./crypto":338,"./olmlib":343}],332:[function(t,E,e){var u=this&&this.__awaiter||function(d,b,a,n){function i(r){return r instanceof a?r:new a(function(s){s(r)})}return new(a||(a=Promise))(function(r,s){function o(f){try{v(n.next(f))}catch(p){s(p)}}function l(f){try{v(n.throw(f))}catch(p){s(p)}}function v(f){f.done?r(f.value):i(f.value).then(o,l)}v((n=n.apply(d,b||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.registerAlgorithm=e.UnknownDeviceError=e.DecryptionError=e.DecryptionAlgorithm=e.EncryptionAlgorithm=e.DECRYPTION_CLASSES=e.ENCRYPTION_CLASSES=void 0,e.ENCRYPTION_CLASSES=new Map,e.DECRYPTION_CLASSES=new Map;class g{constructor(b){this.userId=b.userId,this.deviceId=b.deviceId,this.crypto=b.crypto,this.olmDevice=b.olmDevice,this.baseApis=b.baseApis,this.roomId=b.roomId}prepareToEncrypt(b){}onRoomMembership(b,a,n){}}e.EncryptionAlgorithm=g;class S{constructor(b){this.userId=b.userId,this.crypto=b.crypto,this.olmDevice=b.olmDevice,this.baseApis=b.baseApis,this.roomId=b.roomId}onRoomKeyEvent(b){return u(this,void 0,void 0,function*(){})}importRoomKey(b,a){return u(this,void 0,void 0,function*(){})}hasKeysForKeyRequest(b){return Promise.resolve(!1)}shareKeysWithDevice(b){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}retryDecryptionFromSender(b){return u(this,void 0,void 0,function*(){return!1})}}e.DecryptionAlgorithm=S;class y extends Error{constructor(b,a,n){super(a),this.code=b,this.code=b,this.name="DecryptionError",this.detailedString=c(this,n)}}e.DecryptionError=y;function c(d,b){let a=d.name+"[msg: "+d.message;return b&&(a+=", "+Object.keys(b).map(n=>n+": "+b[n]).join(", ")),a+="]",a}class m extends Error{constructor(b,a,n){super(b),this.devices=a,this.event=n,this.name="UnknownDeviceError",this.devices=a}}e.UnknownDeviceError=m;function h(d,b,a){e.ENCRYPTION_CLASSES.set(d,b),e.DECRYPTION_CLASSES.set(d,a)}e.registerAlgorithm=h},{}],333:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(S,y,c,m){m===void 0&&(m=c);var h=Object.getOwnPropertyDescriptor(y,c);(!h||("get"in h?!y.__esModule:h.writable||h.configurable))&&(h={enumerable:!0,get:function(){return y[c]}}),Object.defineProperty(S,m,h)}:function(S,y,c,m){m===void 0&&(m=c),S[m]=y[c]}),g=this&&this.__exportStar||function(S,y){for(var c in S)c!=="default"&&!Object.prototype.hasOwnProperty.call(y,c)&&u(y,S,c)};Object.defineProperty(e,"__esModule",{value:!0}),t("./olm"),t("./megolm"),g(t("./base"),e)},{"./base":332,"./megolm":334,"./olm":335}],334:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(p,_,T,w){w===void 0&&(w=T);var M=Object.getOwnPropertyDescriptor(_,T);(!M||("get"in M?!_.__esModule:M.writable||M.configurable))&&(M={enumerable:!0,get:function(){return _[T]}}),Object.defineProperty(p,w,M)}:function(p,_,T,w){w===void 0&&(w=T),p[w]=_[T]}),g=this&&this.__setModuleDefault||(Object.create?function(p,_){Object.defineProperty(p,"default",{enumerable:!0,value:_})}:function(p,_){p.default=_}),S=this&&this.__importStar||function(p){if(p&&p.__esModule)return p;var _={};if(p!=null)for(var T in p)T!=="default"&&Object.prototype.hasOwnProperty.call(p,T)&&u(_,p,T);return g(_,p),_},y=this&&this.__awaiter||function(p,_,T,w){function M(A){return A instanceof T?A:new T(function(W){W(A)})}return new(T||(T=Promise))(function(A,W){function ee(O){try{C(w.next(O))}catch(I){W(I)}}function F(O){try{C(w.throw(O))}catch(I){W(I)}}function C(O){O.done?A(O.value):M(O.value).then(ee,F)}C((w=w.apply(p,_||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.MegolmDecryption=e.MegolmEncryption=e.isRoomSharedHistory=void 0;const c=t("uuid"),m=t("../../logger"),h=S(t("../olmlib")),d=t("./base"),b=t("../OlmDevice"),a=t("../../@types/event"),n=t("../OutgoingRoomKeyRequestManager"),i=t("../../utils");function r(p){var _,T;const w=(_=p==null?void 0:p.currentState)===null||_===void 0?void 0:_.getStateEvents("m.room.history_visibility",""),M=(T=w==null?void 0:w.getContent())===null||T===void 0?void 0:T.history_visibility;return["world_readable","shared"].includes(M)}e.isRoomSharedHistory=r;const s=p=>typeof p.ciphertext=="string"?!!p.ciphertext.length:!!Object.keys(p.ciphertext).length;class o{constructor(_,T=!1){this.sessionId=_,this.sharedHistory=T,this.useCount=0,this.sharedWithDevices=new i.MapWithDefault(()=>new Map),this.blockedDevicesNotified=new i.MapWithDefault(()=>new Map),this.creationTime=new Date().getTime()}needsRotation(_,T){const w=new Date().getTime()-this.creationTime;return this.useCount>=_||w>=T?(m.logger.log("Rotating megolm session after "+this.useCount+" messages, "+w+"ms"),!0):!1}markSharedWithDevice(_,T,w,M){this.sharedWithDevices.getOrCreate(_).set(T,{deviceKey:w,messageIndex:M})}markNotifiedBlockedDevice(_,T){this.blockedDevicesNotified.getOrCreate(_).set(T,!0)}sharedWithTooManyDevices(_){var T;for(const[w,M]of this.sharedWithDevices){if(!_.has(w))return m.logger.log("Starting new megolm session because we shared with "+w),!0;for(const[A]of M)if(!(!((T=_.get(w))===null||T===void 0)&&T.get(A)))return m.logger.log("Starting new megolm session because we shared with "+w+":"+A),!0}return!1}}class l extends d.EncryptionAlgorithm{constructor(_){var T,w,M,A;super(_),this.setupPromise=Promise.resolve(null),this.outboundSessions={},this.roomId=_.roomId,this.prefixedLogger=m.logger.withPrefix(`[${this.roomId} encryption]`),this.sessionRotationPeriodMsgs=(w=(T=_.config)===null||T===void 0?void 0:T.rotation_period_msgs)!==null&&w!==void 0?w:100,this.sessionRotationPeriodMs=(A=(M=_.config)===null||M===void 0?void 0:M.rotation_period_ms)!==null&&A!==void 0?A:7*24*3600*1e3}ensureOutboundSession(_,T,w,M=!1){return y(this,void 0,void 0,function*(){const A=ee=>y(this,void 0,void 0,function*(){const F=r(_),C=yield this.prepareSession(T,F,ee);return yield this.shareSession(T,F,M,w,C),C}),W=this.setupPromise.then(A);return this.setupPromise=W.catch(ee=>(this.prefixedLogger.error("Failed to setup outbound session",ee),null)),W})}prepareSession(_,T,w){return y(this,void 0,void 0,function*(){return w&&T!==w.sharedHistory&&(w=null),w!=null&&w.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(this.prefixedLogger.log("Starting new megolm session because we need to rotate."),w=null),w!=null&&w.sharedWithTooManyDevices(_)&&(w=null),w||(this.prefixedLogger.log("Starting new megolm session"),w=yield this.prepareNewSession(T),this.prefixedLogger.log(`Started new megolm session ${w.sessionId}`),this.outboundSessions[w.sessionId]=w),w})}shareSession(_,T,w,M,A){var W;return y(this,void 0,void 0,function*(){const ee={};for(const[D,j]of _)for(const[Y,q]of j)q.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(!((W=A.sharedWithDevices.get(D))===null||W===void 0)&&W.get(Y)||(ee[D]=ee[D]||[],ee[D].push(q)));const F=this.olmDevice.getOutboundGroupSessionKey(A.sessionId),C={type:"m.room_key",content:{algorithm:h.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:A.sessionId,session_key:F.key,chain_index:F.chain_index,"org.matrix.msc3061.shared_history":T}},[O,I]=yield h.getExistingOlmSessions(this.olmDevice,this.baseApis,ee);yield Promise.all([(()=>y(this,void 0,void 0,function*(){const D=Array.from(I.entries()).map(([j,Y])=>Array.from(Y.entries()).map(([q,B])=>`${j}/${q}: ${B.sessionId}`)).flat(1);this.prefixedLogger.debug("Sharing keys with devices with existing Olm sessions:",D),yield this.shareKeyWithOlmSessions(A,F,C,I),this.prefixedLogger.debug("Shared keys with existing Olm sessions")}))(),(()=>y(this,void 0,void 0,function*(){const D=Array.from(O.entries()).map(([B,R])=>R.map(k=>`${B}/${k.deviceId}`)).flat(1);this.prefixedLogger.debug("Sharing keys (start phase 1) with devices without existing Olm sessions:",D);const j=[],Y=Date.now(),q=[];yield this.shareKeyWithDevices(A,F,C,O,j,w?1e4:2e3,q),this.prefixedLogger.debug("Shared keys (end phase 1) with devices without existing Olm sessions"),!w&&Date.now()-Y<1e4?y(this,void 0,void 0,function*(){const B=new i.MapWithDefault(()=>[]),R=new Set;for(const V of q)R.add(V);const k=[];for(const{userId:V,deviceInfo:x}of j){const Q=V.slice(V.indexOf(":")+1);R.has(Q)?B.getOrCreate(V).push(x):k.push({userId:V,deviceInfo:x})}const P=Array.from(B.entries()).map(([V,x])=>x.map(Q=>`${V}/${Q.deviceId}`)).flat(1);P.length>0&&(this.prefixedLogger.debug("Sharing keys (start phase 2) with devices without existing Olm sessions:",P),yield this.shareKeyWithDevices(A,F,C,B,k,3e4),this.prefixedLogger.debug("Shared keys (end phase 2) with devices without existing Olm sessions")),yield this.notifyFailedOlmDevices(A,F,k)}):yield this.notifyFailedOlmDevices(A,F,j)}))(),(()=>y(this,void 0,void 0,function*(){var D;this.prefixedLogger.debug(`There are ${M.size} blocked devices:`,Array.from(M.entries()).map(([q,B])=>Array.from(B.entries()).map(([R,k])=>`${q}/${R}`)).flat(1));const j=new i.MapWithDefault(()=>new Map);let Y=0;for(const[q,B]of M)for(const[R,k]of B)((D=A.blockedDevicesNotified.get(q))===null||D===void 0?void 0:D.get(R))===void 0&&(j.getOrCreate(q).set(R,{device:k}),Y++);Y&&(this.prefixedLogger.debug(`Notifying ${Y} newly blocked devices:`,Array.from(j.entries()).map(([q,B])=>Object.entries(B).map(([R,k])=>`${q}/${R}`)).flat(1)),yield this.notifyBlockedDevices(A,j),this.prefixedLogger.debug(`Notified ${Y} newly blocked devices`))}))()])})}prepareNewSession(_){return y(this,void 0,void 0,function*(){const T=this.olmDevice.createOutboundGroupSession(),w=this.olmDevice.getOutboundGroupSessionKey(T);return yield this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],T,w.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:_}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,T),new o(T,_)})}getDevicesWithoutSessions(_,T,w=[]){for(const[M,A]of T){const W=_.get(M);for(const ee of A){const F=ee.deviceId,C=W==null?void 0:W.get(F);if(!(C!=null&&C.sessionId)){w.push({userId:M,deviceInfo:ee}),W==null||W.delete(F);continue}}}return w}splitDevices(_){let w=[];const M=[w];for(const[A,W]of _){for(const ee of W.values())w.push({userId:A,deviceInfo:ee.device});w.length>20&&(w=[],M.push(w))}return w.length===0&&M.pop(),M}encryptAndSendKeysToDevices(_,T,w,M){return this.crypto.encryptAndSendToDevices(w,M).then(()=>{for(const A of w)_.markSharedWithDevice(A.userId,A.deviceInfo.deviceId,A.deviceInfo.getIdentityKey(),T)}).catch(A=>{throw this.prefixedLogger.error("failed to encryptAndSendToDevices",A),A})}sendBlockedNotificationsToDevices(_,T,w){return y(this,void 0,void 0,function*(){const M=new i.MapWithDefault(()=>new Map);for(const A of T){const W=A.userId,ee=A.deviceInfo,C=ee.deviceInfo.deviceId,O=Object.assign(Object.assign({},w),{code:ee.code,reason:ee.reason,[a.ToDeviceMessageId]:(0,c.v4)()});O.code==="m.no_olm"&&(delete O.room_id,delete O.session_id),M.getOrCreate(W).set(C,O)}yield this.baseApis.sendToDevice("m.room_key.withheld",M);for(const[A,W]of M)for(const ee of W.keys())_.markNotifiedBlockedDevice(A,ee)})}reshareKeyWithDevice(_,T,w,M){var A;return y(this,void 0,void 0,function*(){const W=this.outboundSessions[T];if(!W){this.prefixedLogger.debug(`megolm session ${_}|${T} not found: not re-sharing keys`);return}if(!W.sharedWithDevices.has(w)){this.prefixedLogger.debug(`megolm session ${_}|${T} never shared with user ${w}`);return}const ee=(A=W.sharedWithDevices.get(w))===null||A===void 0?void 0:A.get(M.deviceId);if(ee===void 0){this.prefixedLogger.debug(`megolm session ${_}|${T} never shared with device ${w}:${M.deviceId}`);return}if(ee.deviceKey!==M.getIdentityKey()){this.prefixedLogger.warn(`Megolm session ${_}|${T} has been shared with device ${M.deviceId} but with identity key ${ee.deviceKey}. Key is now ${M.getIdentityKey()}!`);return}const F=yield this.olmDevice.getInboundGroupSessionKey(this.roomId,_,T,ee.messageIndex);if(!F){this.prefixedLogger.warn(`No inbound session key found for megolm session ${_}|${T}: not re-sharing keys`);return}yield h.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[w,[M]]]));const C={type:"m.forwarded_room_key",content:{algorithm:h.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:T,session_key:F.key,chain_index:F.chain_index,sender_key:_,sender_claimed_ed25519_key:F.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:F.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":F.shared_history||!1}},O={algorithm:h.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.ToDeviceMessageId]:(0,c.v4)()};yield h.encryptMessageForDevice(O.ciphertext,this.userId,this.deviceId,this.olmDevice,w,M,C),yield this.baseApis.sendToDevice("m.room.encrypted",new Map([[w,new Map([[M.deviceId,O]])]])),this.prefixedLogger.debug(`Re-shared key for megolm session ${_}|${T} with ${w}:${M.deviceId}`)})}shareKeyWithDevices(_,T,w,M,A,W,ee){return y(this,void 0,void 0,function*(){const F=yield h.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,M,!1,W,ee,this.prefixedLogger);this.getDevicesWithoutSessions(F,M,A),yield this.shareKeyWithOlmSessions(_,T,w,F)})}shareKeyWithOlmSessions(_,T,w,M){return y(this,void 0,void 0,function*(){const A=this.splitDevices(M);for(let W=0;W<A.length;W++){const ee=`megolm keys for ${_.sessionId} (slice ${W+1}/${A.length})`;try{this.prefixedLogger.debug(`Sharing ${ee}`,A[W].map(F=>`${F.userId}/${F.deviceInfo.deviceId}`)),yield this.encryptAndSendKeysToDevices(_,T.chain_index,A[W],w),this.prefixedLogger.debug(`Shared ${ee}`)}catch(F){throw this.prefixedLogger.error(`Failed to share ${ee}`),F}}})}notifyFailedOlmDevices(_,T,w){return y(this,void 0,void 0,function*(){this.prefixedLogger.debug(`Notifying ${w.length} devices we failed to create Olm sessions`);for(const{userId:W,deviceInfo:ee}of w){const F=ee.deviceId;_.markSharedWithDevice(W,F,ee.getIdentityKey(),T.chain_index)}const M=yield this.olmDevice.filterOutNotifiedErrorDevices(w);this.prefixedLogger.debug(`Need to notify ${M.length} failed devices which haven't been notified before`);const A=new i.MapWithDefault(()=>new Map);for(const{userId:W,deviceInfo:ee}of M)A.getOrCreate(W).set(ee.deviceId,{device:{code:"m.no_olm",reason:b.WITHHELD_MESSAGES["m.no_olm"],deviceInfo:ee}});yield this.notifyBlockedDevices(_,A),this.prefixedLogger.debug(`Notified ${M.length} devices we failed to create Olm sessions`)})}notifyBlockedDevices(_,T){return y(this,void 0,void 0,function*(){const w={room_id:this.roomId,session_id:_.sessionId,algorithm:h.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key},M=this.splitDevices(T);for(let A=0;A<M.length;A++)try{yield this.sendBlockedNotificationsToDevices(_,M[A],w),this.prefixedLogger.log(`Completed blacklist notification for ${_.sessionId} (slice ${A+1}/${M.length})`)}catch(W){throw this.prefixedLogger.log(`blacklist notification for ${_.sessionId} (slice ${A+1}/${M.length}) failed`),W}})}prepareToEncrypt(_){if(_.roomId!==this.roomId)throw new Error("MegolmEncryption.prepareToEncrypt called on unexpected room");if(this.encryptionPreparation!=null){const M=Date.now()-this.encryptionPreparation.startTime;return this.prefixedLogger.debug(`Already started preparing to encrypt for this room ${M}ms ago, skipping`),this.encryptionPreparation.cancel}this.prefixedLogger.debug("Preparing to encrypt events");let T=!1;const w=()=>T;return this.encryptionPreparation={startTime:Date.now(),promise:(()=>y(this,void 0,void 0,function*(){try{const M=yield this.getDevicesInRoom(_,!1,w);if(M===null)return;const[A,W]=M;this.crypto.globalErrorOnUnknownDevices&&this.removeUnknownDevices(A),this.prefixedLogger.debug("Ensuring outbound megolm session"),yield this.ensureOutboundSession(_,A,W,!0),this.prefixedLogger.debug("Ready to encrypt events")}catch(M){this.prefixedLogger.error("Failed to prepare to encrypt events",M)}finally{delete this.encryptionPreparation}}))(),cancel:()=>{T=!0,delete this.encryptionPreparation}},this.encryptionPreparation.cancel}encryptMessage(_,T,w){return y(this,void 0,void 0,function*(){if(this.prefixedLogger.log("Starting to encrypt event"),this.encryptionPreparation!=null)try{yield this.encryptionPreparation.promise}catch{}const M=this.isVerificationEvent(T,w),[A,W]=yield this.getDevicesInRoom(_,M);this.crypto.globalErrorOnUnknownDevices&&this.checkForUnknownDevices(A);const ee=yield this.ensureOutboundSession(_,A,W),F={room_id:this.roomId,type:T,content:w},C=this.olmDevice.encryptGroupMessage(ee.sessionId,JSON.stringify(F)),O={algorithm:h.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:C,session_id:ee.sessionId,device_id:this.deviceId};return ee.useCount++,O})}isVerificationEvent(_,T){switch(_){case a.EventType.KeyVerificationCancel:case a.EventType.KeyVerificationDone:case a.EventType.KeyVerificationMac:case a.EventType.KeyVerificationStart:case a.EventType.KeyVerificationKey:case a.EventType.KeyVerificationReady:case a.EventType.KeyVerificationAccept:return!0;case a.EventType.RoomMessage:return T.msgtype===a.MsgType.KeyVerificationRequest;default:return!1}}forceDiscardSession(){this.setupPromise=this.setupPromise.then(()=>null)}checkForUnknownDevices(_){const T=new i.MapWithDefault(()=>new Map);for(const[w,M]of _)for(const[A,W]of M)W.isUnverified()&&!W.isKnown()&&T.getOrCreate(w).set(A,W);if(T.size)throw new d.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",T)}removeUnknownDevices(_){for(const[T,w]of _){for(const[M,A]of w)A.isUnverified()&&!A.isKnown()&&w.delete(M);w.size===0&&_.delete(T)}}getDevicesInRoom(_,T=!1,w){return y(this,void 0,void 0,function*(){const M=yield _.getEncryptionTargetMembers();this.prefixedLogger.debug(`Encrypting for users (shouldEncryptForInvitedMembers: ${_.shouldEncryptForInvitedMembers()}):`,M.map(O=>`${O.userId} (${O.membership})`));const A=M.map(function(O){return O.userId});let W=this.crypto.globalBlacklistUnverifiedDevices;const ee=_.getBlacklistUnverifiedDevices();typeof ee=="boolean"&&(W=ee);const F=yield this.crypto.downloadKeys(A,!1);if((w==null?void 0:w())===!0)return null;const C=new i.MapWithDefault(()=>new Map);for(const[O,I]of F)for(const[D,j]of I){if(w!==void 0&&(yield(0,i.immediate)()),(w==null?void 0:w())===!0)return null;const Y=this.crypto.checkDeviceTrust(O,D);if(j.isBlocked()||!Y.isVerified()&&W&&!T){const q=C.getOrCreate(O),B=j.isBlocked();q.set(D,{code:B?"m.blacklisted":"m.unverified",reason:b.WITHHELD_MESSAGES[B?"m.blacklisted":"m.unverified"],deviceInfo:j}),I.delete(D)}}return[F,C]})}}e.MegolmEncryption=l;class v extends d.DecryptionAlgorithm{constructor(_){super(_),this.pendingEvents=new Map,this.olmlib=h,this.roomId=_.roomId,this.prefixedLogger=m.logger.withPrefix(`[${this.roomId} decryption]`)}decryptEvent(_){return y(this,void 0,void 0,function*(){const T=_.getWireContent();if(!T.sender_key||!T.session_id||!T.ciphertext)throw new d.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");this.addEventToPendingList(_);let w;try{w=yield this.olmDevice.decryptGroupMessage(_.getRoomId(),T.sender_key,T.session_id,T.ciphertext,_.getId(),_.getTs())}catch(A){if(A.name==="DecryptionError")throw A;let W="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw(A==null?void 0:A.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&(this.requestKeysForEvent(_),W="OLM_UNKNOWN_MESSAGE_INDEX"),new d.DecryptionError(W,A instanceof Error?A.message:"Unknown Error: Error is undefined",{session:T.sender_key+"|"+T.session_id})}if(w===null){this.crypto.backupManager.queryKeyBackupRateLimited(_.getRoomId(),T.session_id).catch(()=>{}),this.requestKeysForEvent(_);const A=yield this.olmDevice.sessionMayHaveProblems(T.sender_key,_.getTs()-12e4);if(A){this.prefixedLogger.info(`When handling UISI from ${_.getSender()} (sender key ${T.sender_key}): recent session problem with that sender:`,A);let W=f[A.type]||f.unknown;throw A.fixed&&(W+=" Trying to create a new secure channel and re-requesting the keys."),new d.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",W,{session:T.sender_key+"|"+T.session_id})}throw new d.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:T.sender_key+"|"+T.session_id})}w.untrusted||this.removeEventFromPendingList(_);const M=JSON.parse(w.result);if(M.room_id!==_.getRoomId())throw new d.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+M.room_id);return{clearEvent:M,senderCurve25519Key:w.senderKey,claimedEd25519Key:w.keysClaimed.ed25519,forwardingCurve25519KeyChain:w.forwardingCurve25519KeyChain,untrusted:w.untrusted}})}requestKeysForEvent(_){const T=_.getWireContent(),w=_.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:_.getRoomId(),algorithm:T.algorithm,sender_key:T.sender_key,session_id:T.session_id},w)}addEventToPendingList(_){var T;const w=_.getWireContent(),M=w.sender_key,A=w.session_id;this.pendingEvents.has(M)||this.pendingEvents.set(M,new Map);const W=this.pendingEvents.get(M);W.has(A)||W.set(A,new Set),(T=W.get(A))===null||T===void 0||T.add(_)}removeEventFromPendingList(_){const T=_.getWireContent(),w=T.sender_key,M=T.session_id,A=this.pendingEvents.get(w),W=A==null?void 0:A.get(M);W&&(W.delete(_),W.size===0&&A.delete(M),A.size===0&&this.pendingEvents.delete(w))}roomKeyFromEvent(_){const T=_.getSenderKey(),w=_.getContent(),M={};if(!w.room_id||!w.session_key||!w.session_id||!w.algorithm){this.prefixedLogger.error("key event is missing fields");return}if(!h.isOlmEncrypted(_)){this.prefixedLogger.error("key event not properly encrypted");return}return w["org.matrix.msc3061.shared_history"]&&(M.sharedHistory=!0),{senderKey:T,sessionId:w.session_id,sessionKey:w.session_key,extraSessionData:M,exportFormat:!1,roomId:w.room_id,algorithm:w.algorithm,forwardingKeyChain:[],keysClaimed:_.getKeysClaimed()}}forwardedRoomKeyFromEvent(_){const T=this.roomKeyFromEvent(_);if(!T)return;const w=_.getSenderKey(),M=_.getContent(),A=this.baseApis.crypto.deviceList.getUserByIdentityKey(h.OLM_ALGORITHM,w),W=M.sender_key,ee=M.sender_claimed_ed25519_key;let F=Array.isArray(M.forwarding_curve25519_key_chain)?M.forwarding_curve25519_key_chain:[];if(F=F.slice(),F.push(w),A!==_.getSender()){this.prefixedLogger.error("sending device does not belong to the user it claims to be from");return}if(!W){this.prefixedLogger.error("forwarded_room_key event is missing sender_key field");return}if(!ee){this.prefixedLogger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");return}const C={ed25519:ee};return T.senderKey=W,T.keysClaimed=C,T.exportFormat=!0,T.forwardingKeyChain=F,T.extraSessionData.untrusted=!0,T}shouldAcceptForwardedKey(_,T){var w;return y(this,void 0,void 0,function*(){const M=_.getSenderKey(),A=(w=this.crypto.deviceList.getDeviceByIdentityKey(h.OLM_ALGORITHM,M))!==null&&w!==void 0?w:void 0,W=this.crypto.checkDeviceInfoTrust(_.getSender(),A),ee=_.getSender()===this.baseApis.getUserId(),F=W.isVerified()&&ee,C=yield this.wasRoomKeyRequested(_,T),O=this.wasRoomKeyForwardedByInviter(_,T),I=this.wasRoomKeyForwardedAsHistory(T);return C&&F||O&&I})}wasRoomKeyRequested(_,T){return y(this,void 0,void 0,function*(){return(yield this.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(_.getSender(),"*",[n.RoomKeyRequestState.Sent])).some(M=>M.requestBody.room_id===T.roomId&&M.requestBody.session_id===T.sessionId)})}wasRoomKeyForwardedByInviter(_,T){var w,M,A;const W=this.baseApis.getRoom(T.roomId),ee=_.getSenderKey();if(!ee)return!1;const F=this.crypto.deviceList.getUserByIdentityKey(h.OLM_ALGORITHM,ee);if(!F)return!1;const C=(w=W==null?void 0:W.getMember(this.userId))===null||w===void 0?void 0:w.events.member,O=(C==null?void 0:C.getSender())===F||((M=C==null?void 0:C.getUnsigned())===null||M===void 0?void 0:M.prev_sender)===F&&((A=C==null?void 0:C.getPrevContent())===null||A===void 0?void 0:A.membership)==="invite";return!!(W&&O)}wasRoomKeyForwardedAsHistory(_){return!!(this.baseApis.getRoom(_.roomId)&&_.extraSessionData.sharedHistory)}shouldParkForwardedKey(_){return!!(!this.baseApis.getRoom(_.roomId)&&_.extraSessionData.sharedHistory)}parkForwardedKey(_,T){return y(this,void 0,void 0,function*(){const w={senderId:_.getSender(),senderKey:T.senderKey,sessionId:T.sessionId,sessionKey:T.sessionKey,keysClaimed:T.keysClaimed,forwardingCurve25519KeyChain:T.forwardingKeyChain};yield this.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],M=>this.crypto.cryptoStore.addParkedSharedHistory(T.roomId,w,M),m.logger.withPrefix("[addParkedSharedHistory]"))})}addRoomKey(_){return y(this,void 0,void 0,function*(){try{yield this.olmDevice.addInboundGroupSession(_.roomId,_.senderKey,_.forwardingKeyChain,_.sessionId,_.sessionKey,_.keysClaimed,_.exportFormat,_.extraSessionData),(yield this.retryDecryption(_.senderKey,_.sessionId,!_.extraSessionData.untrusted))&&this.crypto.cancelRoomKeyRequest({algorithm:_.algorithm,room_id:_.roomId,session_id:_.sessionId,sender_key:_.senderKey}),yield this.crypto.backupManager.backupGroupSession(_.senderKey,_.sessionId)}catch(T){this.prefixedLogger.error(`Error handling m.room_key_event: ${T}`)}})}onForwardedRoomKey(_){return y(this,void 0,void 0,function*(){const T=this.forwardedRoomKeyFromEvent(_);T&&((yield this.shouldAcceptForwardedKey(_,T))?yield this.addRoomKey(T):this.shouldParkForwardedKey(T)&&(yield this.parkForwardedKey(_,T)))})}onRoomKeyEvent(_){return y(this,void 0,void 0,function*(){if(_.getType()=="m.forwarded_room_key")yield this.onForwardedRoomKey(_);else{const T=this.roomKeyFromEvent(_);if(!T)return;yield this.addRoomKey(T)}})}onRoomKeyWithheldEvent(_){return y(this,void 0,void 0,function*(){const T=_.getContent(),w=T.sender_key;T.code==="m.no_olm"?yield this.onNoOlmWithheldEvent(_):T.code==="m.unavailable"||(yield this.olmDevice.addInboundGroupSessionWithheld(T.room_id,w,T.session_id,T.code,T.reason)),T.session_id?yield this.retryDecryption(w,T.session_id):yield this.retryDecryptionFromSender(w)})}onNoOlmWithheldEvent(_){return y(this,void 0,void 0,function*(){const T=_.getContent(),w=T.sender_key,M=_.getSender();if(this.prefixedLogger.warn(`${M}:${w} was unable to establish an olm session with us`),yield this.olmDevice.getSessionIdForDevice(w)){this.prefixedLogger.debug("New session already created.  Not creating a new one."),yield this.olmDevice.recordSessionProblem(w,"no_olm",!0);return}let A=this.crypto.deviceList.getDeviceByIdentityKey(T.algorithm,w);if(!A&&(yield this.crypto.downloadKeys([M],!1),A=this.crypto.deviceList.getDeviceByIdentityKey(T.algorithm,w),!A)){this.prefixedLogger.info("Couldn't find device for identity key "+w+": not establishing session"),yield this.olmDevice.recordSessionProblem(w,"no_olm",!1);return}yield h.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[M,[A]]]),!1);const W={algorithm:h.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.ToDeviceMessageId]:(0,c.v4)()};yield h.encryptMessageForDevice(W.ciphertext,this.userId,void 0,this.olmDevice,M,A,{type:"m.dummy"}),yield this.olmDevice.recordSessionProblem(w,"no_olm",!0),yield this.baseApis.sendToDevice("m.room.encrypted",new Map([[M,new Map([[A.deviceId,W]])]]))})}hasKeysForKeyRequest(_){const T=_.requestBody;return this.olmDevice.hasInboundSessionKeys(T.room_id,T.sender_key,T.session_id)}shareKeysWithDevice(_){const T=_.userId,w=_.deviceId,M=this.crypto.getStoredDevice(T,w),A=_.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[T,[M]]])).then(W=>{var ee;const F=(ee=W.get(T))===null||ee===void 0?void 0:ee.get(w);return F!=null&&F.sessionId?(this.prefixedLogger.log("sharing keys for session "+A.sender_key+"|"+A.session_id+" with device "+T+":"+w),this.buildKeyForwardingMessage(A.room_id,A.sender_key,A.session_id)):null}).then(W=>{const ee={algorithm:h.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.ToDeviceMessageId]:(0,c.v4)()};return this.olmlib.encryptMessageForDevice(ee.ciphertext,this.userId,void 0,this.olmDevice,T,M,W).then(()=>this.baseApis.sendToDevice("m.room.encrypted",new Map([[T,new Map([[w,ee]])]])))})}buildKeyForwardingMessage(_,T,w){return y(this,void 0,void 0,function*(){const M=yield this.olmDevice.getInboundGroupSessionKey(_,T,w);return{type:"m.forwarded_room_key",content:{algorithm:h.MEGOLM_ALGORITHM,room_id:_,sender_key:T,sender_claimed_ed25519_key:M.sender_claimed_ed25519_key,session_id:w,session_key:M.key,chain_index:M.chain_index,forwarding_curve25519_key_chain:M.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":M.shared_history||!1}}})}importRoomKey(_,{untrusted:T,source:w}={}){const M={};return(T||_.untrusted)&&(M.untrusted=!0),_["org.matrix.msc3061.shared_history"]&&(M.sharedHistory=!0),this.olmDevice.addInboundGroupSession(_.room_id,_.sender_key,_.forwarding_curve25519_key_chain,_.session_id,_.session_key,_.sender_claimed_keys,!0,M).then(()=>{w!=="backup"&&this.crypto.backupManager.backupGroupSession(_.sender_key,_.session_id).catch(A=>{this.prefixedLogger.log("Failed to back up megolm session",A)}),this.retryDecryption(_.sender_key,_.session_id,!M.untrusted)})}retryDecryption(_,T,w){var M;return y(this,void 0,void 0,function*(){const A=this.pendingEvents.get(_);if(!A)return!0;const W=A.get(T);if(!W)return!0;const ee=[...W];return this.prefixedLogger.debug("Retrying decryption on events:",ee.map(F=>`${F.getId()}`)),yield Promise.all(ee.map(F=>y(this,void 0,void 0,function*(){try{yield F.attemptDecryption(this.crypto,{isRetry:!0,forceRedecryptIfUntrusted:w})}catch{}}))),!(!((M=this.pendingEvents.get(_))===null||M===void 0)&&M.has(T))})}retryDecryptionFromSender(_){return y(this,void 0,void 0,function*(){const T=this.pendingEvents.get(_);return T?(this.pendingEvents.delete(_),yield Promise.all([...T].map(([w,M])=>y(this,void 0,void 0,function*(){yield Promise.all([...M].map(A=>y(this,void 0,void 0,function*(){try{yield A.attemptDecryption(this.crypto)}catch{}})))}))),!this.pendingEvents.has(_)):!0})}sendSharedHistoryInboundSessions(_){return y(this,void 0,void 0,function*(){yield h.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,_);const T=yield this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);this.prefixedLogger.log(`Sharing history in with users ${Array.from(_.keys())}`,T.map(([w,M])=>`${w}|${M}`));for(const[w,M]of T){const A=yield this.buildKeyForwardingMessage(this.roomId,w,M),W=[],ee=new Map;for(const[F,C]of _){const O=new Map;ee.set(F,O);for(const I of C){const D={algorithm:h.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.ToDeviceMessageId]:(0,c.v4)()};O.set(I.deviceId,D),W.push(h.encryptMessageForDevice(D.ciphertext,this.userId,void 0,this.olmDevice,F,I,A))}}yield Promise.all(W);for(const[F,C]of ee){for(const[O,I]of C)s(I)||(this.prefixedLogger.log("No ciphertext for device "+F+":"+O+": pruning"),C.delete(O));C.size===0&&(this.prefixedLogger.log("Pruned all devices for user "+F),ee.delete(F))}if(ee.size===0){this.prefixedLogger.log("No users left to send to: aborting");return}yield this.baseApis.sendToDevice("m.room.encrypted",ee)}})}}e.MegolmDecryption=v;const f={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};(0,d.registerAlgorithm)(h.MEGOLM_ALGORITHM,l,v)},{"../../@types/event":306,"../../logger":374,"../../utils":416,"../OlmDevice":327,"../OutgoingRoomKeyRequestManager":328,"../olmlib":343,"./base":332,uuid:287}],335:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(i,r,s,o){o===void 0&&(o=s);var l=Object.getOwnPropertyDescriptor(r,s);(!l||("get"in l?!r.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return r[s]}}),Object.defineProperty(i,o,l)}:function(i,r,s,o){o===void 0&&(o=s),i[o]=r[s]}),g=this&&this.__setModuleDefault||(Object.create?function(i,r){Object.defineProperty(i,"default",{enumerable:!0,value:r})}:function(i,r){i.default=r}),S=this&&this.__importStar||function(i){if(i&&i.__esModule)return i;var r={};if(i!=null)for(var s in i)s!=="default"&&Object.prototype.hasOwnProperty.call(i,s)&&u(r,i,s);return g(r,i),r},y=this&&this.__awaiter||function(i,r,s,o){function l(v){return v instanceof s?v:new s(function(f){f(v)})}return new(s||(s=Promise))(function(v,f){function p(w){try{T(o.next(w))}catch(M){f(M)}}function _(w){try{T(o.throw(w))}catch(M){f(M)}}function T(w){w.done?v(w.value):l(w.value).then(p,_)}T((o=o.apply(i,r||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const c=t("../../logger"),m=S(t("../olmlib")),h=t("../deviceinfo"),d=t("./base"),b=h.DeviceInfo.DeviceVerification;class a extends d.EncryptionAlgorithm{constructor(){super(...arguments),this.sessionPrepared=!1,this.prepPromise=null}ensureSession(r){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(r).then(()=>this.crypto.ensureOlmSessionsForUsers(r)).then(()=>{this.sessionPrepared=!0}).finally(()=>{this.prepPromise=null}),this.prepPromise)}encryptMessage(r,s,o){return y(this,void 0,void 0,function*(){const v=(yield r.getEncryptionTargetMembers()).map(function(T){return T.userId});yield this.ensureSession(v);const f={room_id:r.roomId,type:s,content:o},p={algorithm:m.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},_=[];for(const T of v){const w=this.crypto.getStoredDevicesForUser(T)||[];for(const M of w)M.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&M.verified!=b.BLOCKED&&_.push(m.encryptMessageForDevice(p.ciphertext,this.userId,this.deviceId,this.olmDevice,T,M,f))}return Promise.all(_).then(()=>p)})}}class n extends d.DecryptionAlgorithm{decryptEvent(r){return y(this,void 0,void 0,function*(){const s=r.getWireContent(),o=s.sender_key,l=s.ciphertext;if(!l)throw new d.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in l))throw new d.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const v=l[this.olmDevice.deviceCurve25519Key];let f;try{f=yield this.decryptMessage(o,v)}catch(w){throw new d.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:o,err:w})}const p=JSON.parse(f);if(p.recipient!=this.userId)throw new d.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+p.recipient);if(p.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new d.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:p.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});yield this.crypto.deviceList.downloadKeys([r.getSender()],!1);const _=this.crypto.deviceList.getUserByIdentityKey(m.OLM_ALGORITHM,o);if(_!==r.getSender()&&_!=null)throw new d.DecryptionError("OLM_BAD_SENDER","Message claimed to be from "+r.getSender(),{real_sender:_});if(p.sender!=r.getSender())throw new d.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+p.sender,{reported_sender:r.getSender()});if(p.room_id!==r.getRoomId())throw new d.DecryptionError("OLM_BAD_ROOM","Message intended for room "+p.room_id,{reported_room:r.getRoomId()||"ROOM_ID_UNDEFINED"});const T=p.keys||{};return{clearEvent:p,senderCurve25519Key:o,claimedEd25519Key:T.ed25519||null}})}decryptMessage(r,s){if(s.type!==0)return this.reallyDecryptMessage(r,s);{const o=this.olmDevice.olmPrekeyPromise.then(()=>this.reallyDecryptMessage(r,s));return this.olmDevice.olmPrekeyPromise=o.catch(()=>{}),o}}reallyDecryptMessage(r,s){return y(this,void 0,void 0,function*(){const o=yield this.olmDevice.getSessionIdsForDevice(r),l={};for(const f of o)try{const p=yield this.olmDevice.decryptMessage(r,f,s.type,s.body);return c.logger.log("Decrypted Olm message from "+r+" with session "+f),p}catch(p){if(yield this.olmDevice.matchesSession(r,f,s.type,s.body))throw new Error("Error decrypting prekey message with existing session id "+f+": "+p.message);l[f]=p.message}if(s.type!==0)throw o.length===0?new Error("No existing sessions"):new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(l));let v;try{v=yield this.olmDevice.createInboundSession(r,s.type,s.body)}catch(f){throw l["(new)"]=f.message,new Error("Error decrypting prekey message: "+JSON.stringify(l))}return c.logger.log("created new inbound Olm session ID "+v.session_id+" with "+r),v.payload})}}(0,d.registerAlgorithm)(m.OLM_ALGORITHM,a,n)},{"../../logger":374,"../deviceinfo":340,"../olmlib":343,"./base":332}],336:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.CrossSigningKey=void 0,function(u){u.Master="master",u.SelfSigning="self_signing",u.UserSigning="user_signing"}(e.CrossSigningKey||(e.CrossSigningKey={}))},{}],337:[function(t,E,e){(function(u){(function(){var g=this&&this.__awaiter||function(w,M,A,W){function ee(F){return F instanceof A?F:new A(function(C){C(F)})}return new(A||(A=Promise))(function(F,C){function O(j){try{D(W.next(j))}catch(Y){C(Y)}}function I(j){try{D(W.throw(j))}catch(Y){C(Y)}}function D(j){j.done?F(j.value):ee(j.value).then(O,I)}D((W=W.apply(w,M||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.DefaultAlgorithm=e.algorithmsByName=e.Aes256=e.Curve25519=e.BackupManager=void 0;const S=t("../client"),y=t("../logger"),c=t("./olmlib"),m=t("./key_passphrase"),h=t("../utils"),d=t("./store/indexeddb-crypto-store"),b=t("./recoverykey"),a=t("./aes"),n=t("../NamespacedValue"),i=t("./index"),r=t("./crypto"),s=t("../http-api"),o=200,l=5e3;class v{constructor(M,A){this.baseApis=M,this.getKey=A,this.sessionLastCheckAttemptedTime={},this.checkedForBackup=!1,this.sendingBackups=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(M){const A=e.algorithmsByName[M.algorithm];if(!A)throw new Error("Unknown backup algorithm: "+M.algorithm);if(typeof M.auth_data!="object")throw new Error("Invalid backup data returned");return A.checkBackupVersion(M)}static makeAlgorithm(M,A){const W=e.algorithmsByName[M.algorithm];if(!W)throw new Error("Unknown backup algorithm");return W.init(M.auth_data,A)}enableKeyBackup(M){return g(this,void 0,void 0,function*(){this.backupInfo=M,this.algorithm&&this.algorithm.free(),this.algorithm=yield v.makeAlgorithm(M,this.getKey),this.baseApis.emit(i.CryptoEvent.KeyBackupStatus,!0),this.scheduleKeyBackupSend()})}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(i.CryptoEvent.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?!!this.algorithm:null}prepareKeyBackupVersion(M,A){return g(this,void 0,void 0,function*(){const W=A?e.algorithmsByName[A]:e.DefaultAlgorithm;if(!W)throw new Error("Unknown backup algorithm");const[ee,F]=yield W.prepare(M),C=(0,b.encodeRecoveryKey)(ee);return{algorithm:W.algorithmName,auth_data:F,recovery_key:C,privateKey:ee}})}createKeyBackupVersion(M){return g(this,void 0,void 0,function*(){this.algorithm=yield v.makeAlgorithm(M,this.getKey)})}checkAndStart(){var M;return g(this,void 0,void 0,function*(){if(y.logger.log("Checking key backup status..."),this.baseApis.isGuest())return y.logger.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let A;try{A=(M=yield this.baseApis.getKeyBackupVersion())!==null&&M!==void 0?M:void 0}catch(ee){return y.logger.log("Error checking for active key backup",ee),ee.httpStatus===404&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const W=yield this.isKeyBackupTrusted(A);return W.usable&&!this.backupInfo?(y.logger.log(`Found usable key backup v${A.version}: enabling key backups`),yield this.enableKeyBackup(A)):!W.usable&&this.backupInfo?(y.logger.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):!W.usable&&!this.backupInfo?y.logger.log("No usable key backup: not enabling key backup"):W.usable&&this.backupInfo&&(A.version!==this.backupInfo.version?(y.logger.log(`On backup version ${this.backupInfo.version} but found version ${A.version}: switching.`),this.disableKeyBackup(),yield this.enableKeyBackup(A),yield this.scheduleAllGroupSessionsForBackup()):y.logger.log(`Backup version ${A.version} still current`)),{backupInfo:A,trustInfo:W}})}checkKeyBackup(){return g(this,void 0,void 0,function*(){return this.checkedForBackup=!1,this.checkAndStart()})}queryKeyBackupRateLimited(M,A){return g(this,void 0,void 0,function*(){if(!this.backupInfo)return;const W=new Date().getTime();(!this.sessionLastCheckAttemptedTime[A]||W-this.sessionLastCheckAttemptedTime[A]>l)&&(this.sessionLastCheckAttemptedTime[A]=W,yield this.baseApis.restoreKeyBackupWithCache(M,A,this.backupInfo,{}))})}isKeyBackupTrusted(M){return g(this,void 0,void 0,function*(){const A={usable:!1,trusted_locally:!1,sigs:[]};if(!M||!M.algorithm||!M.auth_data||!M.auth_data.signatures)return y.logger.info("Key backup is absent or missing required data"),A;const W=this.baseApis.getUserId(),ee=yield this.baseApis.crypto.getSessionBackupPrivateKey();if(ee){let C=null;try{C=yield v.makeAlgorithm(M,()=>g(this,void 0,void 0,function*(){return ee})),(yield C.keyMatches(ee))&&(y.logger.info("Backup is trusted locally"),A.trusted_locally=!0)}catch{}finally{C==null||C.free()}}const F=M.auth_data.signatures[W]||{};for(const C of Object.keys(F)){const O=C.split(":");if(O[0]!=="ed25519"){y.logger.log("Ignoring unknown signature type: "+O[0]);continue}const I={deviceId:O[1]},D=this.baseApis.crypto.crossSigningInfo.getId();if(D===I.deviceId){I.crossSigningId=!0;try{yield(0,c.verifySignature)(this.baseApis.crypto.olmDevice,M.auth_data,W,I.deviceId,D),I.valid=!0}catch(Y){y.logger.warn("Bad signature from cross signing key "+D,Y),I.valid=!1}A.sigs.push(I);continue}const j=this.baseApis.crypto.deviceList.getStoredDevice(W,I.deviceId);if(j){I.device=j,I.deviceTrust=this.baseApis.checkDeviceTrust(W,I.deviceId);try{yield(0,c.verifySignature)(this.baseApis.crypto.olmDevice,M.auth_data,W,j.deviceId,j.getFingerprint()),I.valid=!0}catch(Y){y.logger.info("Bad signature from key ID "+C+" userID "+this.baseApis.getUserId()+" device ID "+j.deviceId+" fingerprint: "+j.getFingerprint(),M.auth_data,Y),I.valid=!1}}else I.valid=null,y.logger.info("Ignoring signature from unknown key "+C);A.sigs.push(I)}return A.usable=A.sigs.some(C=>{var O;return C.valid&&(C.device&&((O=C.deviceTrust)===null||O===void 0?void 0:O.isVerified())||C.crossSigningId)}),A})}scheduleKeyBackupSend(M=1e4){return g(this,void 0,void 0,function*(){if(!this.sendingBackups){this.sendingBackups=!0;try{const A=Math.random()*M;yield(0,h.sleep)(A);let W=0;for(;;){if(!this.algorithm)return;try{if((yield this.backupPendingKeys(o))===0)return;W=0}catch(ee){if(W++,y.logger.log("Key backup request failed",ee),ee.data&&(ee.data.errcode=="M_NOT_FOUND"||ee.data.errcode=="M_WRONG_ROOM_KEYS_VERSION"))throw yield this.checkKeyBackup(),this.baseApis.crypto.emit(i.CryptoEvent.KeyBackupFailed,ee.data.errcode),ee}W&&(yield(0,h.sleep)(1e3*Math.pow(2,Math.min(W-1,4))))}}finally{this.sendingBackups=!1}}})}backupPendingKeys(M){var A;return g(this,void 0,void 0,function*(){const W=yield this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(M);if(!W.length)return 0;let ee=yield this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit(i.CryptoEvent.KeyBackupSessionsRemaining,ee);const F={};for(const C of W){const O=C.sessionData.room_id;(0,h.safeSet)(F,O,F[O]||{sessions:{}});const I=this.baseApis.crypto.olmDevice.exportInboundGroupSession(C.senderKey,C.sessionId,C.sessionData);I.algorithm=c.MEGOLM_ALGORITHM;const D=(I.forwarding_curve25519_key_chain||[]).length,j=this.baseApis.crypto.deviceList.getUserByIdentityKey(c.MEGOLM_ALGORITHM,C.senderKey),Y=(A=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(c.MEGOLM_ALGORITHM,C.senderKey))!==null&&A!==void 0?A:void 0,q=this.baseApis.crypto.checkDeviceInfoTrust(j,Y).isVerified();(0,h.safeSet)(F[O].sessions,C.sessionId,{first_message_index:I.first_known_index,forwarded_count:D,is_verified:q,session_data:yield this.algorithm.encryptSession(I)})}return yield this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:F}),yield this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(W),ee=yield this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit(i.CryptoEvent.KeyBackupSessionsRemaining,ee),W.length})}backupGroupSession(M,A){return g(this,void 0,void 0,function*(){yield this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:M,sessionId:A}]),this.backupInfo&&this.scheduleKeyBackupSend()})}scheduleAllGroupSessionsForBackup(){return g(this,void 0,void 0,function*(){yield this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)})}flagAllGroupSessionsForBackup(){return g(this,void 0,void 0,function*(){yield this.baseApis.crypto.cryptoStore.doTxn("readwrite",[d.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,d.IndexedDBCryptoStore.STORE_BACKUP],A=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(A,W=>{W!==null&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([W],A)})});const M=yield this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit(i.CryptoEvent.KeyBackupSessionsRemaining,M),M})}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}e.BackupManager=v;class f{constructor(M,A,W){this.authData=M,this.publicKey=A,this.getKey=W}static init(M,A){return g(this,void 0,void 0,function*(){if(!M||!("public_key"in M))throw new Error("auth_data missing required information");const W=new u.Olm.PkEncryption;return W.set_recipient_key(M.public_key),new f(M,W,A)})}static prepare(M){return g(this,void 0,void 0,function*(){const A=new u.Olm.PkDecryption;try{const W={};if(!M)W.public_key=A.generate_key();else if(M instanceof Uint8Array)W.public_key=A.init_with_private_key(M);else{const F=yield(0,m.keyFromPassphrase)(M);W.private_key_salt=F.salt,W.private_key_iterations=F.iterations,W.public_key=A.init_with_private_key(F.key)}return new u.Olm.PkEncryption().set_recipient_key(W.public_key),[A.get_private_key(),W]}finally{A.free()}})}static checkBackupVersion(M){if(!("public_key"in M.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}encryptSession(M){return g(this,void 0,void 0,function*(){const A=Object.assign({},M);return delete A.session_id,delete A.room_id,delete A.first_known_index,this.publicKey.encrypt(JSON.stringify(A))})}decryptSessions(M){return g(this,void 0,void 0,function*(){const A=yield this.getKey(),W=new u.Olm.PkDecryption;try{if(W.init_with_private_key(A)!==this.authData.public_key)throw new s.MatrixError({errcode:S.MatrixClient.RESTORE_BACKUP_ERROR_BAD_KEY});const F=[];for(const[C,O]of Object.entries(M))try{const I=JSON.parse(W.decrypt(O.session_data.ephemeral,O.session_data.mac,O.session_data.ciphertext));I.session_id=C,F.push(I)}catch(I){y.logger.log("Failed to decrypt megolm session from backup",I,O)}return F}finally{W.free()}})}keyMatches(M){return g(this,void 0,void 0,function*(){const A=new u.Olm.PkDecryption;let W;try{W=A.init_with_private_key(M)}finally{A.free()}return W===this.authData.public_key})}free(){this.publicKey.free()}}e.Curve25519=f,f.algorithmName="m.megolm_backup.v1.curve25519-aes-sha2";function p(w){const M=new Uint8Array(w);return r.crypto.getRandomValues(M),M}const _=new n.UnstableValue("m.megolm_backup.v1.aes-hmac-sha2","org.matrix.msc3270.v1.aes-hmac-sha2");class T{constructor(M,A){this.authData=M,this.key=A}static init(M,A){return g(this,void 0,void 0,function*(){if(!M)throw new Error("auth_data missing");const W=yield A();if(M.mac){const{mac:ee}=yield(0,a.calculateKeyCheck)(W,M.iv);if(M.mac.replace(/=+$/g,"")!==ee.replace(/=+/g,""))throw new Error("Key does not match")}return new T(M,W)})}static prepare(M){return g(this,void 0,void 0,function*(){let A;const W={};if(!M)A=p(32);else if(M instanceof Uint8Array)A=new Uint8Array(M);else{const C=yield(0,m.keyFromPassphrase)(M);W.private_key_salt=C.salt,W.private_key_iterations=C.iterations,A=C.key}const{iv:ee,mac:F}=yield(0,a.calculateKeyCheck)(A);return W.iv=ee,W.mac=F,[A,W]})}static checkBackupVersion(M){if(!("iv"in M.auth_data&&"mac"in M.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(M){const A=Object.assign({},M);return delete A.session_id,delete A.room_id,delete A.first_known_index,(0,a.encryptAES)(JSON.stringify(A),this.key,M.session_id)}decryptSessions(M){return g(this,void 0,void 0,function*(){const A=[];for(const[W,ee]of Object.entries(M))try{const F=JSON.parse(yield(0,a.decryptAES)(ee.session_data,this.key,W));F.session_id=W,A.push(F)}catch(F){y.logger.log("Failed to decrypt megolm session from backup",F,ee)}return A})}keyMatches(M){return g(this,void 0,void 0,function*(){if(this.authData.mac){const{mac:A}=yield(0,a.calculateKeyCheck)(M,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===A.replace(/=+/g,"")}else return!0})}free(){this.key.fill(0)}}e.Aes256=T,T.algorithmName=_.name,e.algorithmsByName={[f.algorithmName]:f,[T.algorithmName]:T},e.DefaultAlgorithm=f}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../NamespacedValue":316,"../client":321,"../http-api":367,"../logger":374,"../utils":416,"./aes":331,"./crypto":338,"./index":341,"./key_passphrase":342,"./olmlib":343,"./recoverykey":344,"./store/indexeddb-crypto-store":346}],338:[function(t,E,e){(function(u){(function(){var g,S,y,c,m,h,d;Object.defineProperty(e,"__esModule",{value:!0}),e.setTextEncoder=e.setCrypto=e.TextEncoder=e.subtleCrypto=e.crypto=void 0;const b=t("../logger");if(e.crypto=(g=u.window)===null||g===void 0?void 0:g.crypto,e.subtleCrypto=(c=(y=(S=u.window)===null||S===void 0?void 0:S.crypto)===null||y===void 0?void 0:y.subtle)!==null&&c!==void 0?c:(h=(m=u.window)===null||m===void 0?void 0:m.crypto)===null||h===void 0?void 0:h.webkitSubtle,e.TextEncoder=(d=u.window)===null||d===void 0?void 0:d.TextEncoder,!e.crypto)try{e.crypto=t("crypto").webcrypto}catch(i){b.logger.error("Failed to load webcrypto",i)}if(e.subtleCrypto||(e.subtleCrypto=e.crypto===null||e.crypto===void 0?void 0:e.crypto.subtle),!e.TextEncoder)try{e.TextEncoder=t("util").TextEncoder}catch(i){b.logger.error("Failed to load TextEncoder util",i)}function a(i){var r;e.crypto=i,e.subtleCrypto=(r=i.subtle)!==null&&r!==void 0?r:i.webkitSubtle}e.setCrypto=a;function n(i){e.TextEncoder=i}e.setTextEncoder=n}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../logger":374,crypto:78,util:286}],339:[function(t,E,e){(function(u,g){(function(){var S=this&&this.__awaiter||function(r,s,o,l){function v(f){return f instanceof o?f:new o(function(p){p(f)})}return new(o||(o=Promise))(function(f,p){function _(M){try{w(l.next(M))}catch(A){p(A)}}function T(M){try{w(l.throw(M))}catch(A){p(A)}}function w(M){M.done?f(M.value):v(M.value).then(_,T)}w((l=l.apply(r,s||[])).next())})},y=this&&this.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(e,"__esModule",{value:!0}),e.DehydrationManager=e.DEHYDRATION_ALGORITHM=void 0;const c=y(t("another-json")),m=t("./olmlib"),h=t("../crypto/store/indexeddb-crypto-store"),d=t("./aes"),b=t("../logger"),a=t("../http-api");e.DEHYDRATION_ALGORITHM="org.matrix.msc2697.v1.olm.libolm_pickle";const n=7*24*60*60*1e3;class i{constructor(s){this.crypto=s,this.inProgress=!1,this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){return this.crypto.cryptoStore.doTxn("readonly",[h.IndexedDBCryptoStore.STORE_ACCOUNT],s=>{this.crypto.cryptoStore.getSecretStorePrivateKey(s,o=>S(this,void 0,void 0,function*(){if(o){const{key:l,keyInfo:v,deviceDisplayName:f,time:p}=o,_=g.from(this.crypto.olmDevice.pickleKey),T=yield(0,d.decryptAES)(l,_,e.DEHYDRATION_ALGORITHM);this.key=(0,m.decodeBase64)(T),this.keyInfo=v,this.deviceDisplayName=f;const w=Date.now(),M=Math.max(1,p+n-w);this.timeoutId=u.setTimeout(this.dehydrateDevice.bind(this),M)}}),"dehydration")})}setKeyAndQueueDehydration(s,o={},l){return S(this,void 0,void 0,function*(){(yield this.setKey(s,o,l))||this.dehydrateDevice()})}setKey(s,o={},l){return S(this,void 0,void 0,function*(){if(!s){this.timeoutId&&(u.clearTimeout(this.timeoutId),this.timeoutId=void 0),yield this.crypto.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_ACCOUNT],f=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(f,"dehydration",null)}),this.key=void 0,this.keyInfo=void 0;return}let v=!!this.key&&s.length==this.key.length;for(let f=0;v&&f<s.length;f++)s[f]!=this.key[f]&&(v=!1);return v||(this.key=s,this.keyInfo=o,this.deviceDisplayName=l),v})}dehydrateDevice(){return S(this,void 0,void 0,function*(){if(this.inProgress){b.logger.log("Dehydration already in progress -- not starting new dehydration");return}this.inProgress=!0,this.timeoutId&&(u.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const s=g.from(this.crypto.olmDevice.pickleKey),o=yield(0,d.encryptAES)((0,m.encodeBase64)(this.key),s,e.DEHYDRATION_ALGORITHM);yield this.crypto.cryptoStore.doTxn("readwrite",[h.IndexedDBCryptoStore.STORE_ACCOUNT],O=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(O,"dehydration",{keyInfo:this.keyInfo,key:o,deviceDisplayName:this.deviceDisplayName,time:Date.now()})}),b.logger.log("Attempting to dehydrate device"),b.logger.log("Creating account");const l=new u.Olm.Account;l.create();const v=JSON.parse(l.identity_keys()),f=l.max_number_of_one_time_keys();l.generate_one_time_keys(f/2),l.generate_fallback_key();const p=JSON.parse(l.one_time_keys()),_=JSON.parse(l.fallback_key());l.mark_keys_as_published();const T=l.pickle(new Uint8Array(this.key)),w={algorithm:e.DEHYDRATION_ALGORITHM,account:T};this.keyInfo.passphrase&&(w.passphrase=this.keyInfo.passphrase),b.logger.log("Uploading account to server");const A=(yield this.crypto.baseApis.http.authedRequest(a.Method.Put,"/dehydrated_device",void 0,{device_data:w,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;b.logger.log("Preparing device keys",A);const W={algorithms:this.crypto.supportedAlgorithms,device_id:A,user_id:this.crypto.userId,keys:{[`ed25519:${A}`]:v.ed25519,[`curve25519:${A}`]:v.curve25519}},ee=l.sign(c.default.stringify(W));W.signatures={[this.crypto.userId]:{[`ed25519:${A}`]:ee}},this.crypto.crossSigningInfo.getId("self_signing")&&(yield this.crypto.crossSigningInfo.signObject(W,"self_signing")),b.logger.log("Preparing one-time keys");const F={};for(const[O,I]of Object.entries(p.curve25519)){const D={key:I},j=l.sign(c.default.stringify(D));D.signatures={[this.crypto.userId]:{[`ed25519:${A}`]:j}},F[`signed_curve25519:${O}`]=D}b.logger.log("Preparing fallback keys");const C={};for(const[O,I]of Object.entries(_.curve25519)){const D={key:I,fallback:!0},j=l.sign(c.default.stringify(D));D.signatures={[this.crypto.userId]:{[`ed25519:${A}`]:j}},C[`signed_curve25519:${O}`]=D}return b.logger.log("Uploading keys to server"),yield this.crypto.baseApis.http.authedRequest(a.Method.Post,"/keys/upload/"+encodeURI(A),void 0,{device_keys:W,one_time_keys:F,"org.matrix.msc2732.fallback_keys":C}),b.logger.log("Done dehydrating"),this.timeoutId=u.setTimeout(this.dehydrateDevice.bind(this),n),A}finally{this.inProgress=!1}})}stop(){this.timeoutId&&(u.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}e.DehydrationManager=i}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer)},{"../crypto/store/indexeddb-crypto-store":346,"../http-api":367,"../logger":374,"./aes":331,"./olmlib":343,"another-json":1,buffer:68}],340:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.DeviceInfo=void 0;var u;(function(S){S[S.Blocked=-1]="Blocked",S[S.Unverified=0]="Unverified",S[S.Verified=1]="Verified"})(u||(u={}));class g{static fromStorage(y,c){const m=new g(c);for(const h in y)y.hasOwnProperty(h)&&(m[h]=y[h]);return m}constructor(y){this.deviceId=y,this.algorithms=[],this.keys={},this.verified=u.Unverified,this.known=!1,this.unsigned={},this.signatures={}}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==u.Blocked}isVerified(){return this.verified==u.Verified}isUnverified(){return this.verified==u.Unverified}isKnown(){return this.known===!0}}e.DeviceInfo=g,g.DeviceVerification={VERIFIED:u.Verified,UNVERIFIED:u.Unverified,BLOCKED:u.Blocked}},{}],341:[function(t,E,e){(function(u,g){(function(){var S=this&&this.__createBinding||(Object.create?function(G,U,L,z){z===void 0&&(z=L);var J=Object.getOwnPropertyDescriptor(U,L);(!J||("get"in J?!U.__esModule:J.writable||J.configurable))&&(J={enumerable:!0,get:function(){return U[L]}}),Object.defineProperty(G,z,J)}:function(G,U,L,z){z===void 0&&(z=L),G[z]=U[L]}),y=this&&this.__setModuleDefault||(Object.create?function(G,U){Object.defineProperty(G,"default",{enumerable:!0,value:U})}:function(G,U){G.default=U}),c=this&&this.__importStar||function(G){if(G&&G.__esModule)return G;var U={};if(G!=null)for(var L in G)L!=="default"&&Object.prototype.hasOwnProperty.call(G,L)&&S(U,G,L);return y(U,G),U},m=this&&this.__awaiter||function(G,U,L,z){function J(ne){return ne instanceof L?ne:new L(function(oe){oe(ne)})}return new(L||(L=Promise))(function(ne,oe){function ce(fe){try{he(z.next(fe))}catch(ve){oe(ve)}}function pe(fe){try{he(z.throw(fe))}catch(ve){oe(ve)}}function he(fe){fe.done?ne(fe.value):J(fe.value).then(ce,pe)}he((z=z.apply(G,U||[])).next())})},h=this&&this.__importDefault||function(G){return G&&G.__esModule?G:{default:G}};Object.defineProperty(e,"__esModule",{value:!0}),e.IncomingRoomKeyRequest=e.fixBackupKey=e.Crypto=e.CryptoEvent=e.isCryptoAvailable=e.verificationMethods=void 0;const d=h(t("another-json")),b=t("uuid"),a=t("../@types/event"),n=t("../ReEmitter"),i=t("../logger"),r=t("./OlmDevice"),s=c(t("./olmlib")),o=t("./DeviceList"),l=t("./deviceinfo"),v=c(t("./algorithms")),f=t("./CrossSigning"),p=t("./EncryptionSetup"),_=t("./SecretStorage"),T=t("./OutgoingRoomKeyRequestManager"),w=t("./store/indexeddb-crypto-store"),M=t("./verification/QRCode"),A=t("./verification/SAS"),W=t("./key_passphrase"),ee=t("./recoverykey"),F=t("./verification/request/VerificationRequest"),C=t("./verification/request/InRoomChannel"),O=t("./verification/request/ToDeviceChannel"),I=t("./verification/IllegalMethod"),D=t("../errors"),j=t("./aes"),Y=t("./dehydration"),q=t("./backup"),B=t("../models/room"),R=t("../models/room-member"),k=t("../models/event"),P=t("../client"),V=t("../models/typed-event-emitter"),x=t("../models/room-state"),Q=t("../utils"),te=l.DeviceInfo.DeviceVerification,ae={[M.ReciprocateQRCode.NAME]:M.ReciprocateQRCode,[A.SAS.NAME]:A.SAS,[M.SHOW_QR_CODE_METHOD]:I.IllegalMethod,[M.SCAN_QR_CODE_METHOD]:I.IllegalMethod};e.verificationMethods={RECIPROCATE_QR_CODE:M.ReciprocateQRCode.NAME,SAS:A.SAS.NAME};function de(){return!!u.Olm}e.isCryptoAvailable=de;const X=60*60*1e3;var $;(function(G){G.DeviceVerificationChanged="deviceVerificationChanged",G.UserTrustStatusChanged="userTrustStatusChanged",G.UserCrossSigningUpdated="userCrossSigningUpdated",G.RoomKeyRequest="crypto.roomKeyRequest",G.RoomKeyRequestCancellation="crypto.roomKeyRequestCancellation",G.KeyBackupStatus="crypto.keyBackupStatus",G.KeyBackupFailed="crypto.keyBackupFailed",G.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",G.KeySignatureUploadFailure="crypto.keySignatureUploadFailure",G.VerificationRequest="crypto.verification.request",G.Warning="crypto.warning",G.WillUpdateDevices="crypto.willUpdateDevices",G.DevicesUpdated="crypto.devicesUpdated",G.KeysChanged="crossSigning.keysChanged"})($=e.CryptoEvent||(e.CryptoEvent={}));class K extends V.TypedEventEmitter{static getOlmVersion(){return r.OlmDevice.getOlmVersion()}constructor(U,L,z,J,ne,oe,ce){if(super(),this.baseApis=U,this.userId=L,this.deviceId=z,this.clientStore=J,this.cryptoStore=ne,this.roomList=oe,this.trustCrossSignedDevices=!0,this.lastOneTimeKeyCheck=null,this.oneTimeKeyCheckInProgress=!1,this.roomEncryptors=new Map,this.roomDecryptors=new Map,this.deviceKeys={},this.globalBlacklistUnverifiedDevices=!1,this.globalErrorOnUnknownDevices=!0,this.receivedRoomKeyRequests=[],this.receivedRoomKeyRequestCancellations=[],this.processingRoomKeyRequests=!1,this.lazyLoadMembers=!1,this.roomDeviceTrackingState={},this.lastNewSessionForced=new Q.MapWithDefault(()=>new Q.MapWithDefault(()=>0)),this.sendKeyRequestsImmediately=!1,this.onDeviceListUserCrossSigningUpdated=fe=>m(this,void 0,void 0,function*(){if(fe===this.userId){const ve=this.deviceList.getStoredCrossSigningForUser(fe),ye=ve?ve.getId():null,Ee=this.crossSigningInfo.getId();Ee&&ye&&!(Ee!==ye)?yield this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit($.KeysChanged,{}),this.emit($.UserTrustStatusChanged,this.userId,this.checkUserTrust(fe)))}else{yield this.checkDeviceVerifications(fe);const ve=this.deviceList.getStoredCrossSigningForUser(fe);ve&&(ve.updateCrossSigningVerifiedBefore(this.checkUserTrust(fe).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(fe,ve.toStorage())),this.emit($.UserTrustStatusChanged,fe,this.checkUserTrust(fe))}}),this.onMembership=(fe,ve,ye)=>{try{this.onRoomMembership(fe,ve,ye)}catch(Ee){i.logger.error("Error handling membership change:",Ee)}},this.onToDeviceEvent=fe=>{try{i.logger.log(`received to-device ${fe.getType()} from: ${fe.getSender()} id: ${fe.getContent()[a.ToDeviceMessageId]}`),fe.getType()=="m.room_key"||fe.getType()=="m.forwarded_room_key"?this.onRoomKeyEvent(fe):fe.getType()=="m.room_key_request"?this.onRoomKeyRequestEvent(fe):fe.getType()==="m.secret.request"?this.secretStorage.onRequestReceived(fe):fe.getType()==="m.secret.send"?this.secretStorage.onSecretReceived(fe):fe.getType()==="m.room_key.withheld"?this.onRoomKeyWithheldEvent(fe):fe.getContent().transaction_id?this.onKeyVerificationMessage(fe):fe.getContent().msgtype==="m.bad.encrypted"?this.onToDeviceBadEncrypted(fe):(fe.isBeingDecrypted()||fe.shouldAttemptDecryption())&&(fe.isBeingDecrypted()||fe.attemptDecryption(this),fe.once(k.MatrixEventEvent.Decrypted,ve=>{this.onToDeviceEvent(ve)}))}catch(ve){i.logger.error("Error handling toDeviceEvent:",ve)}},this.onTimelineEvent=(fe,ve,ye,Ee,{liveEvent:we=!0}={})=>{if(!C.InRoomChannel.validateEvent(fe,this.baseApis))return;const me=N=>{const Z=new C.InRoomChannel(this.baseApis,N.getRoomId());return new F.VerificationRequest(Z,this.verificationMethods,this.baseApis)};this.handleVerificationEvent(fe,this.inRoomVerificationRequests,me,we)},this.reEmitter=new n.TypedReEmitter(this),ce){this.verificationMethods=new Map;for(const fe of ce)typeof fe=="string"?ae[fe]&&this.verificationMethods.set(fe,ae[fe]):fe.NAME?this.verificationMethods.set(fe.NAME,fe):i.logger.warn(`Excluding unknown verification method ${fe}`)}else this.verificationMethods=new Map(Object.entries(ae));this.backupManager=new q.BackupManager(U,()=>m(this,void 0,void 0,function*(){const fe=yield this.getSessionBackupPrivateKey();if(fe)return fe;const ve=yield this.getSecret("m.megolm_backup.v1");if(ve){const ye=re(ve);if(ye){const Ee=yield this.getSecretStorageKey();yield this.storeSecret("m.megolm_backup.v1",ye,[Ee[0]])}return s.decodeBase64(ye||ve)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return this.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")})),this.olmDevice=new r.OlmDevice(ne),this.deviceList=new o.DeviceList(U,ne,this.olmDevice),this.deviceList.on($.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[$.DevicesUpdated,$.WillUpdateDevices]),this.supportedAlgorithms=Array.from(v.DECRYPTION_CLASSES.keys()),this.outgoingRoomKeyRequestManager=new T.OutgoingRoomKeyRequestManager(U,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new O.ToDeviceRequests,this.inRoomVerificationRequests=new C.InRoomRequests;const pe=this.baseApis.cryptoCallbacks||{},he=(0,f.createCryptoStoreCacheCallbacks)(ne,this.olmDevice);this.crossSigningInfo=new f.CrossSigningInfo(L,pe,he),this.secretStorage=new _.SecretStorage(U,pe,U),this.dehydrationManager=new Y.DehydrationManager(this),!pe.getCrossSigningKey&&pe.getSecretStorageKey&&(pe.getCrossSigningKey=fe=>m(this,void 0,void 0,function*(){return f.CrossSigningInfo.getFromSecretStorage(fe,this.secretStorage)}))}init({exportedOlmDevice:U,pickleKey:L}={}){return m(this,void 0,void 0,function*(){i.logger.log("Crypto: initialising Olm..."),yield u.Olm.init(),i.logger.log(U?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),yield this.olmDevice.init({fromExportedDevice:U,pickleKey:L}),i.logger.log("Crypto: loading device list..."),yield this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,i.logger.log("Crypto: fetching own devices...");let z=this.deviceList.getRawStoredDevicesForUser(this.userId);if(z||(z={}),!z[this.deviceId]){i.logger.log("Crypto: adding this device to the store...");const J={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:te.VERIFIED,known:!0};z[this.deviceId]=J,this.deviceList.storeDevicesForUser(this.userId,z),this.deviceList.saveIfDirty()}yield this.cryptoStore.doTxn("readonly",[w.IndexedDBCryptoStore.STORE_ACCOUNT],J=>{this.cryptoStore.getCrossSigningKeys(J,ne=>{ne&&Object.keys(ne).length!==0&&(i.logger.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(ne))})}),this.deviceList.startTrackingDeviceList(this.userId),i.logger.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()})}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setCryptoTrustCrossSignedDevices(U){this.trustCrossSignedDevices=U;for(const L of this.deviceList.getKnownUserIds()){const z=this.deviceList.getRawStoredDevicesForUser(L);for(const J of Object.keys(z)){const ne=this.checkDeviceTrust(L,J);if(!ne.isLocallyVerified()&&ne.isCrossSigningVerified()){const oe=this.deviceList.getStoredDevice(L,J);this.emit($.DeviceVerificationChanged,L,J,oe)}}}}createRecoveryKeyFromPassphrase(U){return m(this,void 0,void 0,function*(){const L=new u.Olm.PkDecryption;try{const z={};if(U){const oe=yield(0,W.keyFromPassphrase)(U);z.passphrase={algorithm:"m.pbkdf2",iterations:oe.iterations,salt:oe.salt},z.pubkey=L.init_with_private_key(oe.key)}else z.pubkey=L.generate_key();const J=L.get_private_key(),ne=(0,ee.encodeRecoveryKey)(J);return{keyInfo:z,encodedPrivateKey:ne,privateKey:J}}finally{L==null||L.free()}})}userHasCrossSigningKeys(){return m(this,void 0,void 0,function*(){return yield this.downloadKeys([this.userId]),this.deviceList.getStoredCrossSigningForUser(this.userId)!==null})}isCrossSigningReady(){return m(this,void 0,void 0,function*(){const U=this.crossSigningInfo.getId(),L=(yield this.crossSigningInfo.isStoredInKeyCache())||(yield this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage));return!!(U&&L)})}isSecretStorageReady(){return m(this,void 0,void 0,function*(){const U=yield this.secretStorage.hasKey(),L=yield this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),z=!this.backupManager.getKeyBackupEnabled()||(yield this.baseApis.isKeyBackupKeyStored());return!!(U&&L&&z)})}bootstrapCrossSigning({authUploadDeviceSigningKeys:U,setupNewCrossSigning:L}={}){return m(this,void 0,void 0,function*(){i.logger.log("Bootstrapping cross-signing");const z=this.baseApis.cryptoCallbacks,J=new p.EncryptionSetupBuilder(this.baseApis.store.accountData,z),ne=new f.CrossSigningInfo(this.userId,J.crossSigningCallbacks,J.crossSigningCallbacks),oe=()=>m(this,void 0,void 0,function*(){ne.resetKeys(),yield this.signObject(ne.keys.master),J.addCrossSigningKeys(U,ne.keys);const Ee=this.deviceList.getStoredDevice(this.userId,this.deviceId),we=yield ne.signDevice(this.userId,Ee);J.addKeySignature(this.userId,this.deviceId,we),this.backupManager.backupInfo&&(yield ne.signObject(this.backupManager.backupInfo.auth_data,"master"),J.addSessionBackup(this.backupManager.backupInfo))}),ce=this.crossSigningInfo.getId(),pe=yield this.crossSigningInfo.isStoredInKeyCache(),he=yield this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),fe=pe||he;i.logger.log({setupNewCrossSigning:L,publicKeysOnDevice:ce,privateKeysInCache:pe,privateKeysInStorage:he,privateKeysExistSomewhere:fe}),!fe||L?(i.logger.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),yield oe()):ce&&pe?i.logger.log("Cross-signing public keys trusted and private keys found locally"):he&&(i.logger.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),yield this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const ve=J.crossSigningCallbacks.privateKeys;if(ve.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){const Ee=new _.SecretStorage(J.accountDataClientAdapter,J.ssssCryptoCallbacks,void 0);(yield Ee.hasKey())&&(i.logger.log("Storing new cross-signing private keys in secret storage"),yield f.CrossSigningInfo.storeInSecretStorage(ve,Ee))}yield J.buildOperation().apply(this),yield J.persist(this),i.logger.log("Cross-signing ready")})}bootstrapSecretStorage({createSecretStorageKey:U=()=>m(this,void 0,void 0,function*(){return{}}),keyBackupInfo:L,setupNewKeyBackup:z,setupNewSecretStorage:J,getKeyBackupPassphrase:ne}={}){return m(this,void 0,void 0,function*(){i.logger.log("Bootstrapping Secure Secret Storage");const oe=this.baseApis.cryptoCallbacks,ce=new p.EncryptionSetupBuilder(this.baseApis.store.accountData,oe),pe=new _.SecretStorage(ce.accountDataClientAdapter,ce.ssssCryptoCallbacks,void 0);let he=null;const fe=(se,le)=>m(this,void 0,void 0,function*(){le&&(se.key=le);const{keyId:ge,keyInfo:be}=yield pe.addKey(_.SECRET_STORAGE_ALGORITHM_V1_AES,se);return le&&ce.ssssCryptoCallbacks.addPrivateKey(ge,be,le),yield pe.setDefaultKeyId(ge),ge}),ve=(se,le)=>m(this,void 0,void 0,function*(){var ge,be;if(!le.mac){const Se=yield(be=(ge=this.baseApis.cryptoCallbacks).getSecretStorageKey)===null||be===void 0?void 0:be.call(ge,{keys:{[se]:le}},"");if(Se){const _e=Se[1];ce.ssssCryptoCallbacks.addPrivateKey(se,le,_e);const{iv:Re,mac:Ie}=yield(0,j.calculateKeyCheck)(_e);le.iv=Re,le.mac=Ie,yield ce.setAccountData(`m.secret_storage.key.${se}`,le)}}}),ye=se=>m(this,void 0,void 0,function*(){if(this.crossSigningInfo.getId()&&(yield this.crossSigningInfo.isStoredInKeyCache("master")))try{i.logger.log("Adding cross-signing signature to key backup"),yield this.crossSigningInfo.signObject(se,"master")}catch(le){i.logger.error("Signing key backup with cross-signing keys failed",le)}else i.logger.warn("Cross-signing keys not available, skipping signature on key backup")}),Ee=yield this.getSecretStorageKey(),[we,me]=Ee||[null,null],N=!J&&me&&me.algorithm===_.SECRET_STORAGE_ALGORITHM_V1_AES;if(i.logger.log({keyBackupInfo:L,setupNewKeyBackup:z,setupNewSecretStorage:J,storageExists:N,oldKeyInfo:me}),!N&&!L){i.logger.log("Secret storage does not exist, creating new storage key");const{keyInfo:se={},privateKey:le}=yield U();he=yield fe(se,le)}else if(!N&&L){i.logger.log("Secret storage does not exist, using key backup key");const se=(yield this.getSessionBackupPrivateKey())||(yield ne==null?void 0:ne()),le={};L.auth_data.private_key_salt&&L.auth_data.private_key_iterations&&(le.passphrase={algorithm:"m.pbkdf2",iterations:L.auth_data.private_key_iterations,salt:L.auth_data.private_key_salt,bits:256}),he=yield fe(le,se),yield pe.store("m.megolm_backup.v1",s.encodeBase64(se),[he]),yield ye(L.auth_data),ce.addSessionBackup(L)}else i.logger.log("Secret storage exists"),me&&me.algorithm===_.SECRET_STORAGE_ALGORITHM_V1_AES&&(yield ve(we,me));if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&(yield this.isCrossSigningReady())&&(he||!(yield this.crossSigningInfo.isStoredInSecretStorage(pe)))){i.logger.log("Copying cross-signing private keys from cache to secret storage");const se=yield this.crossSigningInfo.getCrossSigningKeysFromCache();yield f.CrossSigningInfo.storeInSecretStorage(se,pe)}if(z&&!L){i.logger.log("Creating new message key backup version");const se=yield this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),le=(0,ee.decodeRecoveryKey)(se.recovery_key);yield pe.store("m.megolm_backup.v1",s.encodeBase64(le));const ge={algorithm:se.algorithm,auth_data:se.auth_data};yield ye(ge.auth_data),yield this.signObject(ge.auth_data),ce.addSessionBackup(ge)}const Z=yield pe.get("m.megolm_backup.v1");if(Z){i.logger.info("Got session backup key from secret storage: caching");const se=re(Z);if(se){const ge=he||we;yield pe.store("m.megolm_backup.v1",se,ge?[ge]:null)}const le=new Uint8Array(s.decodeBase64(se||Z));ce.addSessionBackupPrivateKeyToCache(le)}else if(this.backupManager.getKeyBackupEnabled()){const se=(yield this.getSessionBackupPrivateKey())||(yield ne==null?void 0:ne());if(!se){i.logger.error("Key backup is enabled but couldn't get key backup key!");return}i.logger.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),yield pe.store("m.megolm_backup.v1",s.encodeBase64(se))}yield ce.buildOperation().apply(this),yield ce.persist(this),i.logger.log("Secure Secret Storage ready")})}addSecretStorageKey(U,L,z){return this.secretStorage.addKey(U,L,z)}hasSecretStorageKey(U){return this.secretStorage.hasKey(U)}getSecretStorageKey(U){return this.secretStorage.getKey(U)}storeSecret(U,L,z){return this.secretStorage.store(U,L,z)}getSecret(U){return this.secretStorage.get(U)}isSecretStored(U){return this.secretStorage.isStored(U)}requestSecret(U,L){return L||(L=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(U,L)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(U){return this.secretStorage.setDefaultKeyId(U)}checkSecretStorageKey(U,L){return this.secretStorage.checkKey(U,L)}checkSecretStoragePrivateKey(U,L){let z=null;try{return z=new u.Olm.PkDecryption,z.init_with_private_key(U)===L}finally{z==null||z.free()}}getSessionBackupPrivateKey(){return m(this,void 0,void 0,function*(){let U=yield new Promise(L=>{this.cryptoStore.doTxn("readonly",[w.IndexedDBCryptoStore.STORE_ACCOUNT],z=>{this.cryptoStore.getSecretStorePrivateKey(z,L,"m.megolm_backup.v1")})});if(U&&typeof U=="string"&&(U=new Uint8Array(s.decodeBase64(re(U)||U)),yield this.storeSessionBackupPrivateKey(U)),U&&U.ciphertext){const L=g.from(this.olmDevice.pickleKey),z=yield(0,j.decryptAES)(U,L,"m.megolm_backup.v1");U=s.decodeBase64(z)}return U})}storeSessionBackupPrivateKey(U){return m(this,void 0,void 0,function*(){if(!(U instanceof Uint8Array))throw new Error(`storeSessionBackupPrivateKey expects Uint8Array, got ${U}`);const L=g.from(this.olmDevice.pickleKey),z=yield(0,j.encryptAES)(s.encodeBase64(U),L,"m.megolm_backup.v1");return this.cryptoStore.doTxn("readwrite",[w.IndexedDBCryptoStore.STORE_ACCOUNT],J=>{this.cryptoStore.storeSecretStorePrivateKey(J,"m.megolm_backup.v1",z)})})}checkCrossSigningPrivateKey(U,L){let z=null;try{return z=new u.Olm.PkSigning,z.init_with_seed(U)===L}finally{z==null||z.free()}}afterCrossSigningLocalKeyChange(){return m(this,void 0,void 0,function*(){i.logger.info("Starting cross-signing key change post-processing");const U=this.deviceList.getStoredDevice(this.userId,this.deviceId),L=yield this.crossSigningInfo.signDevice(this.userId,U);i.logger.info(`Starting background key sig upload for ${this.deviceId}`);const z=({shouldEmit:ne=!1})=>this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:L}}).then(oe=>{const{failures:ce}=oe||{};if(Object.keys(ce||[]).length>0)throw ne&&this.baseApis.emit($.KeySignatureUploadFailure,ce,"afterCrossSigningLocalKeyChange",z),new D.KeySignatureUploadError("Key upload failed",{failures:ce});i.logger.info(`Finished background key sig upload for ${this.deviceId}`)}).catch(oe=>{i.logger.error(`Error during background key sig upload for ${this.deviceId}`,oe)});z({shouldEmit:!0});const J=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(J){i.logger.info("Starting device verification upgrade");const ne={};for(const[oe,ce]of Object.entries(this.deviceList.crossSigningInfo)){const pe=yield this.checkForDeviceVerificationUpgrade(oe,f.CrossSigningInfo.fromStorage(ce,oe));pe&&(ne[oe]=pe)}if(Object.keys(ne).length>0){i.logger.info(`Found ${Object.keys(ne).length} verif users to upgrade`);try{const oe=yield J({users:ne});if(oe)for(const ce of oe)ce in ne&&(yield this.baseApis.setDeviceVerified(ce,ne[ce].crossSigningInfo.getId()))}catch(oe){i.logger.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",oe)}}i.logger.info("Finished device verification upgrade")}i.logger.info("Finished cross-signing key change post-processing")})}checkForDeviceVerificationUpgrade(U,L){return m(this,void 0,void 0,function*(){const z=this.crossSigningInfo.checkUserTrust(L);if(L.firstUse&&!z.isVerified()){const J=this.deviceList.getRawStoredDevicesForUser(U),ne=yield this.checkForValidDeviceSignature(U,L.keys.master,J);if(ne.length)return{devices:ne.map(oe=>l.DeviceInfo.fromStorage(J[oe],oe)),crossSigningInfo:L}}})}checkForValidDeviceSignature(U,L,z){return m(this,void 0,void 0,function*(){const J=[];if(z&&L.signatures&&L.signatures[U])for(const ne of Object.keys(L.signatures[U])){const[,oe]=ne.split(":",2);if(oe in z&&z[oe].verified===te.VERIFIED)try{yield s.verifySignature(this.olmDevice,L,U,oe,z[oe].keys[ne]),J.push(oe)}catch{}}return J})}getCrossSigningId(U){return this.crossSigningInfo.getId(U)}getStoredCrossSigningForUser(U){return this.deviceList.getStoredCrossSigningForUser(U)}checkUserTrust(U){const L=this.deviceList.getStoredCrossSigningForUser(U);return L?this.crossSigningInfo.checkUserTrust(L):new f.UserTrustLevel(!1,!1,!1)}checkDeviceTrust(U,L){const z=this.deviceList.getStoredDevice(U,L);return this.checkDeviceInfoTrust(U,z)}checkDeviceInfoTrust(U,L){const z=!!(L!=null&&L.isVerified()),J=this.deviceList.getStoredCrossSigningForUser(U);if(L&&J){const ne=this.trustCrossSignedDevices||U===this.userId;return this.crossSigningInfo.checkDeviceTrust(J,L,z,ne)}else return new f.DeviceTrustLevel(!1,!1,z,!1)}checkIfOwnDeviceCrossSigned(U){var L;const z=this.deviceList.getStoredDevice(this.userId,U);if(!z)return!1;const J=this.deviceList.getStoredCrossSigningForUser(this.userId);return(L=J==null?void 0:J.checkDeviceTrust(J,z,!1,!0).isCrossSigningVerified())!==null&&L!==void 0?L:!1}checkOwnCrossSigningTrust({allowPrivateKeyRequests:U=!1}={}){return m(this,void 0,void 0,function*(){const L=this.userId;yield this.downloadKeys([this.userId]);const z=yield this.crossSigningInfo.getCrossSigningKeysFromCache(),J=this.deviceList.getStoredCrossSigningForUser(L);if(!J){i.logger.error("Got cross-signing update event for user "+L+" but no new cross-signing information found!");return}const ne=J.getId(),oe=this.crossSigningInfo.getId()!==ne,ce=J.getId()&&!z.has("master");if(oe&&i.logger.info("Got new master public key",ne),U&&(oe||ce)){i.logger.info("Attempting to retrieve cross-signing master private key");let N=null;try{N=(yield this.crossSigningInfo.getCrossSigningKey("master",ne))[1],i.logger.info("Got cross-signing master private key")}finally{N==null||N.free()}}const pe=this.crossSigningInfo.getId("self_signing"),he=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(J.keys);const fe=pe!==J.getId("self_signing"),ve=he!==J.getId("user_signing"),ye=J.getId("self_signing")&&!z.has("self_signing"),Ee=J.getId("user_signing")&&!z.has("user_signing"),we={};if(fe&&i.logger.info("Got new self-signing key",J.getId("self_signing")),U&&(fe||ye)){i.logger.info("Attempting to retrieve cross-signing self-signing private key");let N=null;try{N=(yield this.crossSigningInfo.getCrossSigningKey("self_signing",J.getId("self_signing")))[1],i.logger.info("Got cross-signing self-signing private key")}finally{N==null||N.free()}const Z=this.deviceList.getStoredDevice(this.userId,this.deviceId),ie=yield this.crossSigningInfo.signDevice(this.userId,Z);we[this.deviceId]=ie}if(ve&&i.logger.info("Got new user-signing key",J.getId("user_signing")),U&&(ve||Ee)){i.logger.info("Attempting to retrieve cross-signing user-signing private key");let N=null;try{N=(yield this.crossSigningInfo.getCrossSigningKey("user_signing",J.getId("user_signing")))[1],i.logger.info("Got cross-signing user-signing private key")}finally{N==null||N.free()}}if(oe){const N=this.crossSigningInfo.keys.master;yield this.signObject(N);const Z=N.signatures[this.userId]["ed25519:"+this.deviceId];we[this.crossSigningInfo.getId()]=Object.assign({},N,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:Z}}})}const me=Object.keys(we);if(me.length){const N=({shouldEmit:Z=!1})=>(i.logger.info(`Starting background key sig upload for ${me}`),this.baseApis.uploadKeySignatures({[this.userId]:we}).then(ie=>{const{failures:se}=ie||{};if(i.logger.info(`Finished background key sig upload for ${me}`),Object.keys(se||[]).length>0)throw Z&&this.baseApis.emit($.KeySignatureUploadFailure,se,"checkOwnCrossSigningTrust",N),new D.KeySignatureUploadError("Key upload failed",{failures:se})}).catch(ie=>{i.logger.error(`Error during background key sig upload for ${me}`,ie)}));N({shouldEmit:!0})}this.emit($.UserTrustStatusChanged,L,this.checkUserTrust(L)),oe&&(this.emit($.KeysChanged,{}),yield this.afterCrossSigningLocalKeyChange()),yield this.backupManager.checkKeyBackup()})}storeTrustedSelfKeys(U){return m(this,void 0,void 0,function*(){U?this.crossSigningInfo.setKeys(U):this.crossSigningInfo.clearKeys(),yield this.cryptoStore.doTxn("readwrite",[w.IndexedDBCryptoStore.STORE_ACCOUNT],L=>{this.cryptoStore.storeCrossSigningKeys(L,this.crossSigningInfo.keys)})})}checkDeviceVerifications(U){return m(this,void 0,void 0,function*(){const L=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(L){if(i.logger.info(`Starting device verification upgrade for ${U}`),this.crossSigningInfo.keys.user_signing){const z=this.deviceList.getStoredCrossSigningForUser(U);if(z){const J=yield this.checkForDeviceVerificationUpgrade(U,z);J&&(yield L({users:{[U]:J}})).includes(U)&&(yield this.baseApis.setDeviceVerified(U,z.getId()))}}i.logger.info(`Finished device verification upgrade for ${U}`)}})}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(U){U.on(R.RoomMemberEvent.Membership,this.onMembership),U.on(P.ClientEvent.ToDeviceEvent,this.onToDeviceEvent),U.on(B.RoomEvent.Timeline,this.onTimelineEvent),U.on(k.MatrixEventEvent.Decrypted,this.onTimelineEvent)}start(){i.logger.warn("MatrixClient.crypto.start() is deprecated")}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}setGlobalBlacklistUnverifiedDevices(U){this.globalBlacklistUnverifiedDevices=U}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}uploadDeviceKeys(){const U={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(U).then(()=>this.baseApis.uploadKeysRequest({device_keys:U}))}updateOneTimeKeyCount(U){if(isFinite(U))this.oneTimeKeyCount=U;else throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number")}setNeedsNewFallback(U){this.needsNewFallback=U}getNeedsNewFallback(){return!!this.needsNewFallback}maybeUploadOneTimeKeys(){if(this.oneTimeKeyCheckInProgress)return;const z=Date.now();if(this.lastOneTimeKeyCheck!==null&&z-this.lastOneTimeKeyCheck<6e4)return;this.lastOneTimeKeyCheck=z;const J=this.olmDevice.maxNumberOfOneTimeKeys(),ne=Math.floor(J/2),oe=ce=>m(this,void 0,void 0,function*(){for(;ne>ce||this.getNeedsNewFallback();){if(ne>ce){i.logger.info("generating oneTimeKeys");const he=Math.min(ne-ce,5);yield this.olmDevice.generateOneTimeKeys(he)}if(this.getNeedsNewFallback()){const he=yield this.olmDevice.getFallbackKey();(!he.curve25519||Object.keys(he.curve25519).length==0)&&(i.logger.info("generating fallback key"),this.fallbackCleanup&&(clearTimeout(this.fallbackCleanup),delete this.fallbackCleanup),yield this.olmDevice.generateFallbackKey())}i.logger.info("calling uploadOneTimeKeys");const pe=yield this.uploadOneTimeKeys();if(pe.one_time_key_counts&&pe.one_time_key_counts.signed_curve25519)ce=pe.one_time_key_counts.signed_curve25519;else throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519")}});this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>this.oneTimeKeyCount!==void 0?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then(ce=>ce.one_time_key_counts.signed_curve25519||0)).then(ce=>oe(ce)).catch(ce=>{i.logger.error("Error uploading one-time keys",ce.stack||ce)}).finally(()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1})}uploadOneTimeKeys(){return m(this,void 0,void 0,function*(){const U=[];let L;if(this.getNeedsNewFallback()){L={};const ce=yield this.olmDevice.getFallbackKey();for(const[pe,he]of Object.entries(ce.curve25519)){const fe={key:he,fallback:!0};L["signed_curve25519:"+pe]=fe,U.push(this.signObject(fe))}this.setNeedsNewFallback(!1)}const z=yield this.olmDevice.getOneTimeKeys(),J={};for(const ce in z.curve25519)if(z.curve25519.hasOwnProperty(ce)){const pe={key:z.curve25519[ce]};J["signed_curve25519:"+ce]=pe,U.push(this.signObject(pe))}yield Promise.all(U);const ne={one_time_keys:J};L&&(ne["org.matrix.msc2732.fallback_keys"]=L,ne.fallback_keys=L);const oe=yield this.baseApis.uploadKeysRequest(ne);return L&&(this.fallbackCleanup=setTimeout(()=>{delete this.fallbackCleanup,this.olmDevice.forgetOldFallbackKey()},60*60*1e3)),yield this.olmDevice.markKeysAsPublished(),oe})}downloadKeys(U,L){return this.deviceList.downloadKeys(U,!!L)}getStoredDevicesForUser(U){return this.deviceList.getStoredDevicesForUser(U)}getStoredDevice(U,L){return this.deviceList.getStoredDevice(U,L)}saveDeviceList(U){return this.deviceList.saveIfDirty(U)}setDeviceVerification(U,L,z=null,J=null,ne=null,oe){return m(this,void 0,void 0,function*(){const ce=this.deviceList.getStoredCrossSigningForUser(U);if(ce&&ce.getId()===L){if(J!==null||ne!==null)throw new Error("Cannot set blocked or known for a cross-signing key");if(!z)throw new Error("Cannot set a cross-signing key as unverified");const Ee=oe?Object.values(oe)[0]:null;if(oe&&(Object.values(oe).length!==1||Ee!==ce.getId()))throw new Error(`Key did not match expected value: expected ${ce.getId()}, got ${Ee}`);if(!this.crossSigningInfo.getId()&&U===this.crossSigningInfo.userId&&(this.storeTrustedSelfKeys(ce.keys),this.emit($.UserTrustStatusChanged,this.userId,this.checkUserTrust(U))),U!==this.userId){i.logger.info("Master key "+ce.getId()+" for "+U+" marked verified. Signing...");const we=yield this.crossSigningInfo.signUser(ce);if(we){const me=({shouldEmit:N=!1})=>m(this,void 0,void 0,function*(){i.logger.info("Uploading signature for "+U+"...");const Z=yield this.baseApis.uploadKeySignatures({[U]:{[L]:we}}),{failures:ie}=Z||{};if(Object.keys(ie||[]).length>0)throw N&&this.baseApis.emit($.KeySignatureUploadFailure,ie,"setDeviceVerification",me),new D.KeySignatureUploadError("Key upload failed",{failures:ie})});yield me({shouldEmit:!0})}return we}else return ce}const pe=this.deviceList.getRawStoredDevicesForUser(U);if(!pe||!pe[L])throw new Error("Unknown device "+U+":"+L);const he=pe[L];let fe=he.verified;if(z){if(oe){for(const[Ee,we]of Object.entries(oe))if(he.keys[Ee]!==we)throw new Error(`Key did not match expected value: expected ${we}, got ${he.keys[Ee]}`)}fe=te.VERIFIED}else z!==null&&fe==te.VERIFIED&&(fe=te.UNVERIFIED);J?fe=te.BLOCKED:J!==null&&fe==te.BLOCKED&&(fe=te.UNVERIFIED);let ve=he.known;if(ne!==null&&(ve=ne),(he.verified!==fe||he.known!==ve)&&(he.verified=fe,he.known=ve,this.deviceList.storeDevicesForUser(U,pe),this.deviceList.saveIfDirty()),z&&U===this.userId){i.logger.info("Own device "+L+" marked verified: signing");let Ee;if(this.checkDeviceTrust(U,L).isCrossSigningVerified()?i.logger.log(`Own device ${L} already cross-signing verified`):Ee=yield this.crossSigningInfo.signDevice(U,l.DeviceInfo.fromStorage(he,L)),Ee){const me=({shouldEmit:N=!1})=>m(this,void 0,void 0,function*(){i.logger.info("Uploading signature for "+L);const Z=yield this.baseApis.uploadKeySignatures({[U]:{[L]:Ee}}),{failures:ie}=Z||{};if(Object.keys(ie||[]).length>0)throw N&&this.baseApis.emit($.KeySignatureUploadFailure,ie,"setDeviceVerification",me),new D.KeySignatureUploadError("Key upload failed",{failures:ie})});yield me({shouldEmit:!0})}}const ye=l.DeviceInfo.fromStorage(he,L);return this.emit($.DeviceVerificationChanged,U,L,ye),ye})}findVerificationRequestDMInProgress(U){return this.inRoomVerificationRequests.findRequestInProgress(U)}getVerificationRequestsToDeviceInProgress(U){return this.toDeviceVerificationRequests.getRequestsInProgress(U)}requestVerificationDM(U,L){const z=this.inRoomVerificationRequests.findRequestInProgress(L);if(z)return Promise.resolve(z);const J=new C.InRoomChannel(this.baseApis,L,U);return this.requestVerificationWithChannel(U,J,this.inRoomVerificationRequests)}requestVerification(U,L){L||(L=Object.keys(this.deviceList.getRawStoredDevicesForUser(U)));const z=this.toDeviceVerificationRequests.findRequestInProgress(U,L);if(z)return Promise.resolve(z);const J=new O.ToDeviceChannel(this.baseApis,U,L,O.ToDeviceChannel.makeTransactionId());return this.requestVerificationWithChannel(U,J,this.toDeviceVerificationRequests)}requestVerificationWithChannel(U,L,z){return m(this,void 0,void 0,function*(){let J=new F.VerificationRequest(L,this.verificationMethods,this.baseApis);L.transactionId&&z.setRequestByChannel(L,J),yield J.sendRequest();const ne=z.getRequestByChannel(L);return ne?J=ne:(i.logger.log(`Crypto: adding new request to requestsByTxnId with id ${L.transactionId} ${L.roomId}`),z.setRequestByChannel(L,J)),J})}beginKeyVerification(U,L,z,J=null){let ne;if(J){if(ne=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(L,J),!ne)throw new Error(`No request found for user ${L} with transactionId ${J}`)}else{J=O.ToDeviceChannel.makeTransactionId();const oe=new O.ToDeviceChannel(this.baseApis,L,[z],J,z);ne=new F.VerificationRequest(oe,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(L,J,ne)}return ne.beginKeyVerification(U,{userId:L,deviceId:z})}legacyDeviceVerification(U,L,z){return m(this,void 0,void 0,function*(){const J=O.ToDeviceChannel.makeTransactionId(),ne=new O.ToDeviceChannel(this.baseApis,U,[L],J,L),oe=new F.VerificationRequest(ne,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(U,J,oe);const ce=oe.beginKeyVerification(z,{userId:U,deviceId:L});return yield Promise.race([ce.verify(),oe.waitFor(pe=>pe.started)]),oe})}getOlmSessionsForUser(U){return m(this,void 0,void 0,function*(){const L=this.getStoredDevicesForUser(U)||[],z={};for(const J of L){const ne=J.getIdentityKey(),oe=yield this.olmDevice.getSessionInfoForDevice(ne);z[J.deviceId]={deviceIdKey:ne,sessions:oe}}return z})}getEventSenderDeviceInfo(U){const L=U.getSenderKey(),z=U.getWireContent().algorithm;if(!L||!z||U.isKeySourceUntrusted())return null;const J=this.deviceList.getDeviceByIdentityKey(z,L);if(J===null)return null;const ne=U.getClaimedEd25519Key();return ne?ne!==J.getFingerprint()?(i.logger.warn("Event "+U.getId()+" claims ed25519 key "+ne+" but sender device has key "+J.getFingerprint()),null):J:(i.logger.warn("Event "+U.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(U){var L,z;const J={};if(J.senderKey=(L=U.getSenderKey())!==null&&L!==void 0?L:void 0,J.algorithm=U.getWireContent().algorithm,!J.senderKey||!J.algorithm)return J.encrypted=!1,J;J.encrypted=!0,U.isKeySourceUntrusted()?J.authenticated=!1:J.authenticated=!0,J.sender=(z=this.deviceList.getDeviceByIdentityKey(J.algorithm,J.senderKey))!==null&&z!==void 0?z:void 0;const ne=U.getClaimedEd25519Key();return ne||(i.logger.warn("Event "+U.getId()+" claims no ed25519 key: cannot verify sending device"),J.mismatchedSender=!0),J.sender&&ne!==J.sender.getFingerprint()&&(i.logger.warn("Event "+U.getId()+" claims ed25519 key "+ne+"but sender device has key "+J.sender.getFingerprint()),J.mismatchedSender=!0),J}forceDiscardSession(U){const L=this.roomEncryptors.get(U);if(L===void 0)throw new Error("Room not encrypted");if(L.forceDiscardSession===void 0)throw new Error("Room encryption algorithm doesn't support session discarding");return L.forceDiscardSession(),Promise.resolve()}setRoomEncryption(U,L,z){return m(this,void 0,void 0,function*(){const J=this.clientStore.getRoom(U);if(!J)throw new Error(`Unable to enable encryption tracking devices in unknown room ${U}`);yield this.setRoomEncryptionImpl(J,L),!this.lazyLoadMembers&&!z&&this.deviceList.refreshOutdatedDeviceLists()})}setRoomEncryptionImpl(U,L){return m(this,void 0,void 0,function*(){const z=U.roomId;if(!L.algorithm){i.logger.log("Ignoring setRoomEncryption with no algorithm");return}const J=this.roomList.getRoomEncryption(z);if(J&&JSON.stringify(J)!=JSON.stringify(L)){i.logger.error("Ignoring m.room.encryption event which requests a change of config in "+z);return}if(this.roomEncryptors.get(z))return;let oe=null;J||(oe=this.roomList.setRoomEncryption(z,L));const ce=v.ENCRYPTION_CLASSES.get(L.algorithm);if(!ce)throw new Error("Unable to encrypt with "+L.algorithm);const pe=new ce({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:z,config:L});if(this.roomEncryptors.set(z,pe),oe&&(yield oe),i.logger.log(`Enabling encryption in ${z}`),U.membersLoaded())yield this.trackRoomDevicesImpl(U);else{const he=fe=>{U.off(x.RoomStateEvent.Update,he),U.membersLoaded()&&this.trackRoomDevicesImpl(U).catch(ve=>{i.logger.error(`Error enabling device tracking in ${z}`,ve)})};U.on(x.RoomStateEvent.Update,he)}})}trackRoomDevices(U){const L=this.clientStore.getRoom(U);if(!L)throw new Error(`Unable to start tracking devices in unknown room ${U}`);return this.trackRoomDevicesImpl(L)}trackRoomDevicesImpl(U){const L=U.roomId,z=()=>m(this,void 0,void 0,function*(){if(!this.roomEncryptors.has(L))return;i.logger.log(`Starting to track devices for room ${L} ...`),(yield U.getEncryptionTargetMembers()).forEach(oe=>{this.deviceList.startTrackingDeviceList(oe.userId)})});let J=this.roomDeviceTrackingState[L];return J||(J=z(),this.roomDeviceTrackingState[L]=J.catch(ne=>{throw delete this.roomDeviceTrackingState[L],ne})),J}ensureOlmSessionsForUsers(U,L){const z=new Map;for(const J of U){const ne=[];z.set(J,ne);const oe=this.getStoredDevicesForUser(J)||[];for(const ce of oe)ce.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&ce.verified!=te.BLOCKED&&ne.push(ce)}return s.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,z,L)}exportRoomKeys(){return m(this,void 0,void 0,function*(){const U=[];return yield this.cryptoStore.doTxn("readonly",[w.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],L=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(L,z=>{if(z===null)return;const J=this.olmDevice.exportInboundGroupSession(z.senderKey,z.sessionId,z.sessionData);delete J.first_known_index,J.algorithm=s.MEGOLM_ALGORITHM,U.push(J)})}),U})}importRoomKeys(U,L={}){let z=0,J=0;const ne=U.length;function oe(){var ce;(ce=L.progressCallback)===null||ce===void 0||ce.call(L,{stage:"load_keys",successes:z,failures:J,total:ne})}return Promise.all(U.map(ce=>!ce.room_id||!ce.algorithm?(i.logger.warn("ignoring room key entry with missing fields",ce),J++,L.progressCallback&&oe(),null):this.getRoomDecryptor(ce.room_id,ce.algorithm).importRoomKey(ce,L).finally(()=>{z++,L.progressCallback&&oe()}))).then()}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(U){const L=this.roomEncryptors.get(U.roomId);L&&L.prepareToEncrypt(U)}encryptEvent(U,L){return m(this,void 0,void 0,function*(){const z=U.getRoomId(),J=this.roomEncryptors.get(z);if(!J)throw new Error("Room "+z+" was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");yield this.trackRoomDevicesImpl(L);let ne=U.getContent();const oe=ne["m.relates_to"];oe&&(ne=Object.assign({},ne),delete ne["m.relates_to"]);const ce=ne["io.element.performance_metrics"];ce&&(ne=Object.assign({},ne),delete ne["io.element.performance_metrics"]);const pe=yield J.encryptMessage(L,U.getType(),ne);oe&&(pe["m.relates_to"]=oe),ce&&(pe["io.element.performance_metrics"]=ce),U.makeEncrypted("m.room.encrypted",pe,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)})}decryptEvent(U){return m(this,void 0,void 0,function*(){if(U.isRedacted()){const L=new k.MatrixEvent(Object.assign({room_id:U.getRoomId()},U.getUnsigned().redacted_because));let z=U.getUnsigned().redacted_because;if(L.isEncrypted())try{z=(yield this.decryptEvent(L)).clearEvent}catch(J){i.logger.warn("Decryption of redaction failed. Falling back to unencrypted event.",J)}return{clearEvent:{room_id:U.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:z}}}}else{const L=U.getWireContent();return this.getRoomDecryptor(U.getRoomId(),L.algorithm).decryptEvent(U)}})}handleDeviceListChanges(U,L){return m(this,void 0,void 0,function*(){U.oldSyncToken&&(yield this.evalDeviceListChanges(L))})}requestRoomKey(U,L,z=!1){return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(U,L,z).then(()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()}).catch(J=>{i.logger.error("Error requesting key for event",J)})}cancelRoomKeyRequest(U){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(U).catch(L=>{i.logger.warn("Error clearing pending room key requests",L)})}cancelAndResendAllOutgoingKeyRequests(){return m(this,void 0,void 0,function*(){yield this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()})}onCryptoEvent(U,L){return m(this,void 0,void 0,function*(){const z=L.getContent();yield this.setRoomEncryptionImpl(U,z)})}onSyncWillProcess(U){return m(this,void 0,void 0,function*(){U.oldSyncToken||(i.logger.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1})}onSyncCompleted(U){var L;return m(this,void 0,void 0,function*(){this.deviceList.setSyncToken((L=U.nextSyncToken)!==null&&L!==void 0?L:null),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),U.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)})}evalDeviceListChanges(U){return m(this,void 0,void 0,function*(){if(Array.isArray(U==null?void 0:U.changed)&&U.changed.forEach(L=>{this.deviceList.invalidateUserDeviceList(L)}),Array.isArray(U==null?void 0:U.left)&&U.left.length){const L=new Set(yield this.getTrackedE2eUsers());U.left.forEach(z=>{L.has(z)||this.deviceList.stopTrackingDeviceList(z)})}})}getTrackedE2eUsers(){return m(this,void 0,void 0,function*(){const U=[];for(const L of this.getTrackedE2eRooms()){const z=yield L.getEncryptionTargetMembers();for(const J of z)U.push(J.userId)}return U})}getTrackedE2eRooms(){return this.clientStore.getRooms().filter(U=>{if(!this.roomEncryptors.get(U.roomId)||!this.roomDeviceTrackingState[U.roomId])return!1;const z=U.getMyMembership();return z==="join"||z==="invite"})}encryptAndSendToDevices(U,L){return m(this,void 0,void 0,function*(){const z={eventType:a.EventType.RoomMessageEncrypted,batch:[]};try{yield Promise.all(U.map(({userId:J,deviceInfo:ne})=>m(this,void 0,void 0,function*(){const oe=ne.deviceId,ce={algorithm:s.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.ToDeviceMessageId]:(0,b.v4)()};z.batch.push({userId:J,deviceId:oe,payload:ce}),yield s.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[J,[ne]]])),yield s.encryptMessageForDevice(ce.ciphertext,this.userId,this.deviceId,this.olmDevice,J,ne,L)}))),z.batch=z.batch.filter(J=>Object.keys(J.payload.ciphertext).length>0?!0:(i.logger.log(`No ciphertext for device ${J.userId}:${J.deviceId}: pruning`),!1));try{yield this.baseApis.queueToDevice(z)}catch(J){throw i.logger.error("sendToDevice failed",J),J}}catch(J){throw i.logger.error("encryptAndSendToDevices promises failed",J),J}})}preprocessToDeviceMessages(U){return m(this,void 0,void 0,function*(){return U.filter(L=>{var z;return L.type===a.EventType.RoomMessageEncrypted&&!["m.olm.v1.curve25519-aes-sha2"].includes((z=L.content)===null||z===void 0?void 0:z.algorithm)?(i.logger.log("Ignoring invalid encrypted to-device event from "+L.sender),!1):!0})})}preprocessOneTimeKeyCounts(U){const L=U.get("signed_curve25519")||0;return this.updateOneTimeKeyCount(L),Promise.resolve()}preprocessUnusedFallbackKeys(U){return this.setNeedsNewFallback(!U.has("signed_curve25519")),Promise.resolve()}onRoomKeyEvent(U){const L=U.getContent();if(!L.room_id||!L.algorithm){i.logger.error("key event is missing fields");return}this.backupManager.checkedForBackup||this.backupManager.checkAndStart(),this.getRoomDecryptor(L.room_id,L.algorithm).onRoomKeyEvent(U)}onRoomKeyWithheldEvent(U){const L=U.getContent();if(L.code!=="m.no_olm"&&(!L.room_id||!L.session_id)||!L.algorithm||!L.sender_key){i.logger.error("key withheld event is missing fields");return}i.logger.info(`Got room key withheld event from ${U.getSender()} for ${L.algorithm} session ${L.sender_key}|${L.session_id} in room ${L.room_id} with code ${L.code} (${L.reason})`);const z=this.getRoomDecryptor(L.room_id,L.algorithm);if(z.onRoomKeyWithheldEvent&&z.onRoomKeyWithheldEvent(U),!L.room_id){const J=this.getRoomDecryptors(L.algorithm);for(const ne of J)ne.retryDecryptionFromSender(L.sender_key)}}onKeyVerificationMessage(U){if(!O.ToDeviceChannel.validateEvent(U,this.baseApis))return;const L=z=>{if(!O.ToDeviceChannel.canCreateRequest(O.ToDeviceChannel.getEventType(z)))return;const J=z.getContent(),ne=J&&J.from_device;if(!ne)return;const oe=z.getSender(),ce=new O.ToDeviceChannel(this.baseApis,oe,[ne]);return new F.VerificationRequest(ce,this.verificationMethods,this.baseApis)};this.handleVerificationEvent(U,this.toDeviceVerificationRequests,L)}handleVerificationEvent(U,L,z,J=!0){return m(this,void 0,void 0,function*(){if(U.isSending()&&U.status!=k.EventStatus.SENT){let pe,he;try{yield new Promise((fe,ve)=>{pe=fe,he=()=>{U.status==k.EventStatus.CANCELLED&&ve(new Error("Event status set to CANCELLED."))},U.once(k.MatrixEventEvent.LocalEventIdReplaced,pe),U.on(k.MatrixEventEvent.Status,he)})}catch(fe){i.logger.error("error while waiting for the verification event to be sent: ",fe);return}finally{U.removeListener(k.MatrixEventEvent.LocalEventIdReplaced,pe),U.removeListener(k.MatrixEventEvent.Status,he)}}let ne=L.getRequest(U),oe=!1;if(!ne){if(ne=z(U),!ne){i.logger.log(`Crypto: could not find VerificationRequest for ${U.getType()}, and could not create one, so ignoring.`);return}oe=!0,L.setRequest(U,ne)}U.setVerificationRequest(ne);try{yield ne.channel.handleEvent(U,ne,J)}catch(pe){i.logger.error("error while handling verification event",pe)}oe&&!ne.initiatedByMe&&!ne.invalid&&!ne.observeOnly&&this.baseApis.emit($.VerificationRequest,ne)})}onToDeviceBadEncrypted(U){return m(this,void 0,void 0,function*(){const L=U.getWireContent(),z=U.getSender(),J=L.algorithm,ne=L.sender_key;this.baseApis.emit(P.ClientEvent.UndecryptableToDeviceEvent,U);const oe=()=>{const Ee=this.getRoomDecryptors(s.MEGOLM_ALGORITHM);for(const we of Ee)we.retryDecryptionFromSender(ne)};if(z===void 0||ne===void 0||ne===void 0)return;const ce=this.lastNewSessionForced.getOrCreate(z),pe=ce.getOrCreate(ne);if(pe+X>Date.now()){i.logger.debug("New session already forced with device "+z+":"+ne+" at "+pe+": not forcing another"),yield this.olmDevice.recordSessionProblem(ne,"wedged",!0),oe();return}let he=this.deviceList.getDeviceByIdentityKey(J,ne);if(!he&&(yield this.downloadKeys([z],!1),he=this.deviceList.getDeviceByIdentityKey(J,ne),!he)){i.logger.info("Couldn't find device for identity key "+ne+": not re-establishing session"),yield this.olmDevice.recordSessionProblem(ne,"wedged",!1),oe();return}const fe=new Map([[z,[he]]]);yield s.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,fe,!0),ce.set(ne,Date.now());const ve={algorithm:s.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.ToDeviceMessageId]:(0,b.v4)()};yield s.encryptMessageForDevice(ve.ciphertext,this.userId,this.deviceId,this.olmDevice,z,he,{type:"m.dummy"}),yield this.olmDevice.recordSessionProblem(ne,"wedged",!0),oe(),yield this.baseApis.sendToDevice("m.room.encrypted",new Map([[z,new Map([[he.deviceId,ve]])]]));const ye=yield this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(z,he.deviceId);for(const Ee of ye)this.requestRoomKey(Ee.requestBody,Ee.recipients,!0)})}onRoomMembership(U,L,z){var J;const ne=L.roomId,oe=this.roomEncryptors.get(ne);oe&&(ne in this.roomDeviceTrackingState&&(L.membership=="join"?(i.logger.log("Join event for "+L.userId+" in "+ne),this.deviceList.startTrackingDeviceList(L.userId)):L.membership=="invite"&&(!((J=this.clientStore.getRoom(ne))===null||J===void 0)&&J.shouldEncryptForInvitedMembers())&&(i.logger.log("Invite event for "+L.userId+" in "+ne),this.deviceList.startTrackingDeviceList(L.userId))),oe.onRoomMembership(U,L,z))}onRoomKeyRequestEvent(U){const L=U.getContent();if(L.action==="request"){const z=new ue(U);this.receivedRoomKeyRequests.push(z)}else if(L.action==="request_cancellation"){const z=new H(U);this.receivedRoomKeyRequestCancellations.push(z)}}processReceivedRoomKeyRequests(){return m(this,void 0,void 0,function*(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{const U=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];const L=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],yield Promise.all(U.map(z=>this.processReceivedRoomKeyRequest(z))),yield Promise.all(L.map(z=>this.processReceivedRoomKeyRequestCancellation(z)))}catch(U){i.logger.error(`Error processing room key requsts: ${U}`)}finally{this.processingRoomKeyRequests=!1}}})}processReceivedRoomKeyRequest(U){return m(this,void 0,void 0,function*(){const L=U.userId,z=U.deviceId,J=U.requestBody,ne=J.room_id,oe=J.algorithm;if(i.logger.log(`m.room_key_request from ${L}:${z} for ${ne} / ${J.session_id} (id ${U.requestId})`),L!==this.userId){if(!this.roomEncryptors.get(ne)){i.logger.debug(`room key request for unencrypted room ${ne}`);return}const pe=this.roomEncryptors.get(ne),he=this.deviceList.getStoredDevice(L,z);if(!he){i.logger.debug(`Ignoring keyshare for unknown device ${L}:${z}`);return}try{yield pe.reshareKeyWithDevice(J.sender_key,J.session_id,L,he)}catch(fe){i.logger.warn("Failed to re-share keys for session "+J.session_id+" with device "+L+":"+he.deviceId,fe)}return}if(z===this.deviceId){i.logger.log("Ignoring room key request from ourselves");return}if(!this.roomDecryptors.has(ne)){i.logger.log(`room key request for unencrypted room ${ne}`);return}const ce=this.roomDecryptors.get(ne).get(oe);if(!ce){i.logger.log(`room key request for unknown alg ${oe} in room ${ne}`);return}if(!(yield ce.hasKeysForKeyRequest(U))){i.logger.log(`room key request for unknown session ${ne} / `+J.session_id);return}if(U.share=()=>{ce.shareKeysWithDevice(U)},this.checkDeviceTrust(L,z).isVerified()){i.logger.log("device is already verified: sharing keys"),U.share();return}this.emit($.RoomKeyRequest,U)})}processReceivedRoomKeyRequestCancellation(U){return m(this,void 0,void 0,function*(){i.logger.log(`m.room_key_request cancellation for ${U.userId}:${U.deviceId} (id ${U.requestId})`),this.emit($.RoomKeyRequestCancellation,U)})}getRoomDecryptor(U,L){let z,J;if(U&&(z=this.roomDecryptors.get(U),z||(z=new Map,this.roomDecryptors.set(U,z)),J=z.get(L),J))return J;const ne=v.DECRYPTION_CLASSES.get(L);if(!ne)throw new v.DecryptionError("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+L+'".');return J=new ne({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:U??void 0}),z&&z.set(L,J),J}getRoomDecryptors(U){const L=[];for(const z of this.roomDecryptors.values())z.has(U)&&L.push(z.get(U));return L}signObject(U){return m(this,void 0,void 0,function*(){const L=new Map(Object.entries(U.signatures||{})),z=U.unsigned;delete U.signatures,delete U.unsigned;const J=L.get(this.userId)||{};L.set(this.userId,J),J["ed25519:"+this.deviceId]=yield this.olmDevice.sign(d.default.stringify(U)),U.signatures=(0,Q.recursiveMapToObject)(L),z!==void 0&&(U.unsigned=z)})}}e.Crypto=K;function re(G){if(typeof G!="string"||G.indexOf(",")<0)return null;const U=Uint8Array.from(G.split(","),L=>parseInt(L));return s.encodeBase64(U)}e.fixBackupKey=re;class ue{constructor(U){const L=U.getContent();this.userId=U.getSender(),this.deviceId=L.requesting_device_id,this.requestId=L.request_id,this.requestBody=L.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}e.IncomingRoomKeyRequest=ue;class H{constructor(U){const L=U.getContent();this.userId=U.getSender(),this.deviceId=L.requesting_device_id,this.requestId=L.request_id}}}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer)},{"../@types/event":306,"../ReEmitter":317,"../client":321,"../errors":359,"../logger":374,"../models/event":383,"../models/room":392,"../models/room-member":389,"../models/room-state":390,"../models/typed-event-emitter":395,"../utils":416,"./CrossSigning":324,"./DeviceList":325,"./EncryptionSetup":326,"./OlmDevice":327,"./OutgoingRoomKeyRequestManager":328,"./SecretStorage":330,"./aes":331,"./algorithms":333,"./backup":337,"./dehydration":339,"./deviceinfo":340,"./key_passphrase":342,"./olmlib":343,"./recoverykey":344,"./store/indexeddb-crypto-store":346,"./verification/IllegalMethod":351,"./verification/QRCode":352,"./verification/SAS":353,"./verification/request/InRoomChannel":355,"./verification/request/ToDeviceChannel":356,"./verification/request/VerificationRequest":357,"another-json":1,buffer:68,uuid:287}],342:[function(t,E,e){(function(u){(function(){var g=this&&this.__awaiter||function(a,n,i,r){function s(o){return o instanceof i?o:new i(function(l){l(o)})}return new(i||(i=Promise))(function(o,l){function v(_){try{p(r.next(_))}catch(T){l(T)}}function f(_){try{p(r.throw(_))}catch(T){l(T)}}function p(_){_.done?o(_.value):s(_.value).then(v,f)}p((r=r.apply(a,n||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.deriveKey=e.keyFromPassphrase=e.keyFromAuthData=void 0;const S=t("../randomstring"),y=t("./crypto"),c=5e5,m=256;function h(a,n){if(!u.Olm)throw new Error("Olm is not available");if(!a.private_key_salt||!a.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return b(n,a.private_key_salt,a.private_key_iterations,a.private_key_bits||m)}e.keyFromAuthData=h;function d(a){return g(this,void 0,void 0,function*(){if(!u.Olm)throw new Error("Olm is not available");const n=(0,S.randomString)(32);return{key:yield b(a,n,c,m),salt:n,iterations:c}})}e.keyFromPassphrase=d;function b(a,n,i,r=m){return g(this,void 0,void 0,function*(){if(!y.subtleCrypto||!y.TextEncoder)throw new Error("Password-based backup is not available on this platform");const s=yield y.subtleCrypto.importKey("raw",new y.TextEncoder().encode(a),{name:"PBKDF2"},!1,["deriveBits"]),o=yield y.subtleCrypto.deriveBits({name:"PBKDF2",salt:new y.TextEncoder().encode(n),iterations:i,hash:"SHA-512"},s,r);return new Uint8Array(o)})}e.deriveKey=b}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../randomstring":398,"./crypto":338}],343:[function(t,E,e){(function(u,g){(function(){var S=this&&this.__awaiter||function(T,w,M,A){function W(ee){return ee instanceof M?ee:new M(function(F){F(ee)})}return new(M||(M=Promise))(function(ee,F){function C(D){try{I(A.next(D))}catch(j){F(j)}}function O(D){try{I(A.throw(D))}catch(j){F(j)}}function I(D){D.done?ee(D.value):W(D.value).then(C,O)}I((A=A.apply(T,w||[])).next())})},y=this&&this.__importDefault||function(T){return T&&T.__esModule?T:{default:T}};Object.defineProperty(e,"__esModule",{value:!0}),e.decodeBase64=e.encodeUnpaddedBase64=e.encodeBase64=e.isOlmEncrypted=e.pkVerify=e.pkSign=e.verifySignature=e.ensureOlmSessionsForDevices=e.getExistingOlmSessions=e.encryptMessageForDevice=e.MEGOLM_BACKUP_ALGORITHM=e.MEGOLM_ALGORITHM=e.OLM_ALGORITHM=void 0;const c=y(t("another-json")),m=t("../logger"),h=t("../@types/event"),d=t("../utils");var b;(function(T){T.Olm="m.olm.v1.curve25519-aes-sha2",T.Megolm="m.megolm.v1.aes-sha2",T.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2"})(b||(b={})),e.OLM_ALGORITHM=b.Olm,e.MEGOLM_ALGORITHM=b.Megolm,e.MEGOLM_BACKUP_ALGORITHM=b.MegolmBackup;function a(T,w,M,A,W,ee,F){return S(this,void 0,void 0,function*(){const C=ee.getIdentityKey(),O=yield A.getSessionIdForDevice(C);if(O===null){m.logger.log(`[olmlib.encryptMessageForDevice] Unable to find Olm session for device ${W}:${ee.deviceId}`);return}m.logger.log(`[olmlib.encryptMessageForDevice] Using Olm session ${O} for device ${W}:${ee.deviceId}`);const I=Object.assign({sender:w,sender_device:M,keys:{ed25519:A.deviceEd25519Key},recipient:W,recipient_keys:{ed25519:ee.getFingerprint()}},F);T[C]=yield A.encryptMessage(C,O,JSON.stringify(I))})}e.encryptMessageForDevice=a;function n(T,w,M){return S(this,void 0,void 0,function*(){const A=new d.MapWithDefault(()=>[]),W=new d.MapWithDefault(()=>new Map),ee=[];for(const[F,C]of Object.entries(M))for(const O of C){const I=O.deviceId,D=O.getIdentityKey();ee.push((()=>S(this,void 0,void 0,function*(){const j=yield T.getSessionIdForDevice(D,!0);j===null?A.getOrCreate(F).push(O):W.getOrCreate(F).set(I,{device:O,sessionId:j})}))())}return yield Promise.all(ee),[A,W]})}e.getExistingOlmSessions=n;function i(T,w,M,A=!1,W,ee,F=m.logger){var C,O,I;return S(this,void 0,void 0,function*(){const D=[],j=new Map,Y=new Map;for(const V of M.values())for(const x of V){const Q=x.getIdentityKey();Q!==T.deviceCurve25519Key&&(T.sessionsInProgress[Q]||(T.sessionsInProgress[Q]=new Promise(te=>{Y.set(Q,ae=>{delete T.sessionsInProgress[Q],te(ae)})})))}for(const[V,x]of M){const Q=new Map;j.set(V,Q);for(const te of x){const ae=te.deviceId,de=te.getIdentityKey();if(de===T.deviceCurve25519Key){F.info("Attempted to start session with ourself! Ignoring"),Q.set(ae,{device:te,sessionId:null});continue}const X=`for ${de} (${V}:${ae})`,$=yield T.getSessionIdForDevice(de,!!Y.get(de),F),K=Y.get(de);$!==null&&K&&K(),($===null||A)&&(A?F.info(`Forcing new Olm session ${X}`):F.info(`Making new Olm session ${X}`),D.push([V,ae])),Q.set(ae,{device:te,sessionId:$})}}if(D.length===0)return j;const q="signed_curve25519";let B,R=`one-time keys for ${D.length} devices`;try{F.debug(`Claiming ${R}`),B=yield w.claimOneTimeKeys(D,q,W),F.debug(`Claimed ${R}`)}catch(V){for(const x of Y.values())x();throw F.log(`Failed to claim ${R}`,V,D),V}ee&&"failures"in B&&ee.push(...Object.keys(B.failures));const k=B.one_time_keys||{},P=[];for(const[V,x]of M){const Q=k[V]||{};for(const te of x){const ae=te.deviceId,de=te.getIdentityKey();if(de===T.deviceCurve25519Key||!((O=(C=j.get(V))===null||C===void 0?void 0:C.get(ae))===null||O===void 0)&&O.sessionId&&!A)continue;const X=Q[ae]||{};let $=null;for(const K in X)K.indexOf(q+":")===0&&($=X[K]);if(!$){F.warn(`No one-time keys (alg=${q}) for device ${V}:${ae}`),(I=Y.get(de))===null||I===void 0||I();continue}P.push(r(T,$,V,te).then(K=>{var re,ue;(re=Y.get(de))===null||re===void 0||re(K??void 0);const H=(ue=j.get(V))===null||ue===void 0?void 0:ue.get(ae);H&&(H.sessionId=K)},K=>{var re;throw(re=Y.get(de))===null||re===void 0||re(),K}))}}return R=`Olm sessions for ${P.length} devices`,F.debug(`Starting ${R}`),yield Promise.all(P),F.debug(`Started ${R}`),j})}e.ensureOlmSessionsForDevices=i;function r(T,w,M,A){return S(this,void 0,void 0,function*(){const W=A.deviceId;try{yield s(T,w,M,W,A.getFingerprint())}catch(F){return m.logger.error("Unable to verify signature on one-time key for device "+M+":"+W+":",F),null}let ee;try{ee=yield T.createOutboundSession(A.getIdentityKey(),w.key)}catch(F){return m.logger.error("Error starting olm session with device "+M+":"+W+": "+F),null}return m.logger.log("Started new olm sessionid "+ee+" for device "+M+":"+W),ee})}function s(T,w,M,A,W){return S(this,void 0,void 0,function*(){const ee="ed25519:"+A,O=((w.signatures||{})[M]||{})[ee];if(!O)throw Error("No signature");const I=Object.assign({},w);"unsigned"in I&&delete I.unsigned,delete I.signatures;const D=c.default.stringify(I);T.verifySignature(W,D,O)})}e.verifySignature=s;function o(T,w,M,A){let W=!1;if(w instanceof Uint8Array){const C=new u.Olm.PkSigning;A=C.init_with_seed(w),w=C,W=!0}const ee=T.signatures||{};delete T.signatures;const F=T.unsigned;T.unsigned&&delete T.unsigned;try{const C=ee[M]||{};return ee[M]=C,C["ed25519:"+A]=w.sign(c.default.stringify(T))}finally{T.signatures=ee,F&&(T.unsigned=F),W&&w.free()}}e.pkSign=o;function l(T,w,M){const A="ed25519:"+w;if(!(T.signatures&&T.signatures[M]&&T.signatures[M][A]))throw new Error("No signature");const W=T.signatures[M][A],ee=new u.Olm.Utility,F=T.signatures;delete T.signatures;const C=T.unsigned;T.unsigned&&delete T.unsigned;try{ee.ed25519_verify(w,c.default.stringify(T),W)}finally{T.signatures=F,C&&(T.unsigned=C),ee.free()}}e.pkVerify=l;function v(T){return T.getSenderKey()?T.getWireType()!==h.EventType.RoomMessageEncrypted||!["m.olm.v1.curve25519-aes-sha2"].includes(T.getWireContent().algorithm)?(m.logger.error("Event was not encrypted using an appropriate algorithm"),!1):!0:(m.logger.error("Event has no sender key (not encrypted?)"),!1)}e.isOlmEncrypted=v;function f(T){return g.from(T).toString("base64")}e.encodeBase64=f;function p(T){return f(T).replace(/=+$/g,"")}e.encodeUnpaddedBase64=p;function _(T){return g.from(T,"base64")}e.decodeBase64=_}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer)},{"../@types/event":306,"../logger":374,"../utils":416,"another-json":1,buffer:68}],344:[function(t,E,e){(function(u,g){(function(){var S=this&&this.__createBinding||(Object.create?function(a,n,i,r){r===void 0&&(r=i);var s=Object.getOwnPropertyDescriptor(n,i);(!s||("get"in s?!n.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return n[i]}}),Object.defineProperty(a,r,s)}:function(a,n,i,r){r===void 0&&(r=i),a[r]=n[i]}),y=this&&this.__setModuleDefault||(Object.create?function(a,n){Object.defineProperty(a,"default",{enumerable:!0,value:n})}:function(a,n){a.default=n}),c=this&&this.__importStar||function(a){if(a&&a.__esModule)return a;var n={};if(a!=null)for(var i in a)i!=="default"&&Object.prototype.hasOwnProperty.call(a,i)&&S(n,a,i);return y(n,a),n};Object.defineProperty(e,"__esModule",{value:!0}),e.decodeRecoveryKey=e.encodeRecoveryKey=void 0;const m=c(t("bs58")),h=[139,1];function d(a){var n;const i=g.alloc(h.length+a.length+1);i.set(h,0),i.set(a,h.length);let r=0;for(let o=0;o<i.length-1;++o)r^=i[o];return i[i.length-1]=r,(n=m.encode(i).match(/.{1,4}/g))===null||n===void 0?void 0:n.join(" ")}e.encodeRecoveryKey=d;function b(a){const n=m.decode(a.replace(/ /g,""));let i=0;for(const r of n)i^=r;if(i!==0)throw new Error("Incorrect parity");for(let r=0;r<h.length;++r)if(n[r]!==h[r])throw new Error("Incorrect prefix");if(n.length!==h.length+u.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(n.slice(h.length,h.length+u.Olm.PRIVATE_KEY_LENGTH))}e.decodeRecoveryKey=b}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer)},{bs58:65,buffer:68}],345:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(r,s,o,l){l===void 0&&(l=o);var v=Object.getOwnPropertyDescriptor(s,o);(!v||("get"in v?!s.__esModule:v.writable||v.configurable))&&(v={enumerable:!0,get:function(){return s[o]}}),Object.defineProperty(r,l,v)}:function(r,s,o,l){l===void 0&&(l=o),r[l]=s[o]}),g=this&&this.__setModuleDefault||(Object.create?function(r,s){Object.defineProperty(r,"default",{enumerable:!0,value:s})}:function(r,s){r.default=s}),S=this&&this.__importStar||function(r){if(r&&r.__esModule)return r;var s={};if(r!=null)for(var o in r)o!=="default"&&Object.prototype.hasOwnProperty.call(r,o)&&u(s,r,o);return g(s,r),s},y=this&&this.__awaiter||function(r,s,o,l){function v(f){return f instanceof o?f:new o(function(p){p(f)})}return new(o||(o=Promise))(function(f,p){function _(M){try{w(l.next(M))}catch(A){p(A)}}function T(M){try{w(l.throw(M))}catch(A){p(A)}}function w(M){M.done?f(M.value):v(M.value).then(_,T)}w((l=l.apply(r,s||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.upgradeDatabase=e.VERSION=e.Backend=void 0;const c=t("../../logger"),m=S(t("../../utils"));class h{constructor(s){this.db=s,this.nextTxnId=0,s.onversionchange=()=>{c.logger.log(`versionchange for indexeddb ${this.db.name}: closing`),s.close()}}startup(){return y(this,void 0,void 0,function*(){return this})}deleteAllData(){return y(this,void 0,void 0,function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})}getOrAddOutgoingRoomKeyRequest(s){const o=s.requestBody;return new Promise((l,v)=>{const f=this.db.transaction("outgoingRoomKeyRequests","readwrite");f.onerror=v,this._getOutgoingRoomKeyRequest(f,o,p=>{if(p){c.logger.log(`already have key request outstanding for ${o.room_id} / ${o.session_id}: not sending another`),l(p);return}c.logger.log(`enqueueing key request for ${o.room_id} / `+o.session_id),f.oncomplete=()=>{l(s)},f.objectStore("outgoingRoomKeyRequests").add(s)})})}getOutgoingRoomKeyRequest(s){return new Promise((o,l)=>{const v=this.db.transaction("outgoingRoomKeyRequests","readonly");v.onerror=l,this._getOutgoingRoomKeyRequest(v,s,f=>{o(f)})})}_getOutgoingRoomKeyRequest(s,o,l){const p=s.objectStore("outgoingRoomKeyRequests").index("session").openCursor([o.room_id,o.session_id]);p.onsuccess=()=>{const _=p.result;if(!_){l(null);return}const T=_.value;if(m.deepCompare(T.requestBody,o)){l(T);return}_.continue()}}getOutgoingRoomKeyRequestByState(s){if(s.length===0)return Promise.resolve(null);let o=0,l;function v(){const w=this.result;if(w){l=w.value;return}if(o++,o>=s.length)return;const M=s[o],A=this.source.openCursor(M);A.onsuccess=v}const f=this.db.transaction("outgoingRoomKeyRequests","readonly"),p=f.objectStore("outgoingRoomKeyRequests"),_=s[o],T=p.index("state").openCursor(_);return T.onsuccess=v,i(f).then(()=>l)}getAllOutgoingRoomKeyRequestsByState(s){return new Promise((o,l)=>{const _=this.db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(s);_.onsuccess=()=>o(_.result),_.onerror=()=>l(_.error)})}getOutgoingRoomKeyRequestsByTarget(s,o,l){let v=0;const f=[];function p(){const A=this.result;if(A){const W=A.value;W.recipients.some(ee=>ee.userId===s&&ee.deviceId===o)&&f.push(W),A.continue()}else{if(v++,v>=l.length)return;const W=l[v],ee=this.source.openCursor(W);ee.onsuccess=p}}const _=this.db.transaction("outgoingRoomKeyRequests","readonly"),T=_.objectStore("outgoingRoomKeyRequests"),w=l[v],M=T.index("state").openCursor(w);return M.onsuccess=p,i(_).then(()=>f)}updateOutgoingRoomKeyRequest(s,o,l){let v=null;function f(){const T=this.result;if(!T)return;const w=T.value;if(w.state!=o){c.logger.warn(`Cannot update room key request from ${o} as it was already updated to ${w.state}`);return}Object.assign(w,l),T.update(w),v=w}const p=this.db.transaction("outgoingRoomKeyRequests","readwrite"),_=p.objectStore("outgoingRoomKeyRequests").openCursor(s);return _.onsuccess=f,i(p).then(()=>v)}deleteOutgoingRoomKeyRequest(s,o){const l=this.db.transaction("outgoingRoomKeyRequests","readwrite"),v=l.objectStore("outgoingRoomKeyRequests").openCursor(s);return v.onsuccess=()=>{const f=v.result;if(!f)return;const p=f.value;if(p.state!=o){c.logger.warn(`Cannot delete room key request in state ${p.state} (expected ${o})`);return}f.delete()},i(l)}getAccount(s,o){const v=s.objectStore("account").get("-");v.onsuccess=function(){try{o(v.result||null)}catch(f){n(s,f)}}}storeAccount(s,o){s.objectStore("account").put(o,"-")}getCrossSigningKeys(s,o){const v=s.objectStore("account").get("crossSigningKeys");v.onsuccess=function(){try{o(v.result||null)}catch(f){n(s,f)}}}getSecretStorePrivateKey(s,o,l){const f=s.objectStore("account").get(`ssss_cache:${l}`);f.onsuccess=function(){try{o(f.result||null)}catch(p){n(s,p)}}}storeCrossSigningKeys(s,o){s.objectStore("account").put(o,"crossSigningKeys")}storeSecretStorePrivateKey(s,o,l){s.objectStore("account").put(l,`ssss_cache:${o}`)}countEndToEndSessions(s,o){const v=s.objectStore("sessions").count();v.onsuccess=function(){try{o(v.result)}catch(f){n(s,f)}}}getEndToEndSessions(s,o,l){const p=o.objectStore("sessions").index("deviceKey").openCursor(s),_={};p.onsuccess=function(){const T=p.result;if(T)_[T.value.sessionId]={session:T.value.session,lastReceivedMessageTs:T.value.lastReceivedMessageTs},T.continue();else try{l(_)}catch(w){n(o,w)}}}getEndToEndSession(s,o,l,v){const p=l.objectStore("sessions").get([s,o]);p.onsuccess=function(){try{p.result?v({session:p.result.session,lastReceivedMessageTs:p.result.lastReceivedMessageTs}):v(null)}catch(_){n(l,_)}}}getAllEndToEndSessions(s,o){const v=s.objectStore("sessions").openCursor();v.onsuccess=function(){try{const f=v.result;f?(o(f.value),f.continue()):o(null)}catch(f){n(s,f)}}}storeEndToEndSession(s,o,l,v){v.objectStore("sessions").put({deviceKey:s,sessionId:o,session:l.session,lastReceivedMessageTs:l.lastReceivedMessageTs})}storeEndToEndSessionProblem(s,o,l){return y(this,void 0,void 0,function*(){const v=this.db.transaction("session_problems","readwrite");v.objectStore("session_problems").put({deviceKey:s,type:o,fixed:l,time:Date.now()}),yield i(v)})}getEndToEndSessionProblem(s,o){return y(this,void 0,void 0,function*(){let l=null;const v=this.db.transaction("session_problems","readwrite"),_=v.objectStore("session_problems").index("deviceKey").getAll(s);return _.onsuccess=()=>{const T=_.result;if(!T.length){l=null;return}T.sort((M,A)=>M.time-A.time);const w=T[T.length-1];for(const M of T)if(M.time>o){l=Object.assign({},M,{fixed:w.fixed});return}w.fixed?l=null:l=w},yield i(v),l})}filterOutNotifiedErrorDevices(s){return y(this,void 0,void 0,function*(){const l=this.db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),v=[];return yield Promise.all(s.map(f=>new Promise(p=>{const{userId:_,deviceInfo:T}=f,w=l.get([_,T.deviceId]);w.onsuccess=function(){w.result||(l.put({userId:_,deviceId:T.deviceId}),v.push(f)),p()}}))),v})}getEndToEndInboundGroupSession(s,o,l,v){let f=!1,p=!1;const T=l.objectStore("inbound_group_sessions").get([s,o]);T.onsuccess=function(){try{T.result?f=T.result.session:f=null,p!==!1&&v(f,p)}catch(A){n(l,A)}};const M=l.objectStore("inbound_group_sessions_withheld").get([s,o]);M.onsuccess=function(){try{M.result?p=M.result.session:p=null,f!==!1&&v(f,p)}catch(A){n(l,A)}}}getAllEndToEndInboundGroupSessions(s,o){const v=s.objectStore("inbound_group_sessions").openCursor();v.onsuccess=function(){const f=v.result;if(f){try{o({senderKey:f.value.senderCurve25519Key,sessionId:f.value.sessionId,sessionData:f.value.session})}catch(p){n(s,p)}f.continue()}else try{o(null)}catch(p){n(s,p)}}}addEndToEndInboundGroupSession(s,o,l,v){const p=v.objectStore("inbound_group_sessions").add({senderCurve25519Key:s,sessionId:o,session:l});p.onerror=_=>{var T;((T=p.error)===null||T===void 0?void 0:T.name)==="ConstraintError"?(_.stopPropagation(),_.preventDefault(),c.logger.log("Ignoring duplicate inbound group session: "+s+" / "+o)):n(v,new Error("Failed to add inbound group session: "+p.error))}}storeEndToEndInboundGroupSession(s,o,l,v){v.objectStore("inbound_group_sessions").put({senderCurve25519Key:s,sessionId:o,session:l})}storeEndToEndInboundGroupSessionWithheld(s,o,l,v){v.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:s,sessionId:o,session:l})}getEndToEndDeviceData(s,o){const v=s.objectStore("device_data").get("-");v.onsuccess=function(){try{o(v.result||null)}catch(f){n(s,f)}}}storeEndToEndDeviceData(s,o){o.objectStore("device_data").put(s,"-")}storeEndToEndRoom(s,o,l){l.objectStore("rooms").put(o,s)}getEndToEndRooms(s,o){const l={},f=s.objectStore("rooms").openCursor();f.onsuccess=function(){const p=f.result;if(p)l[p.key]=p.value,p.continue();else try{o(l)}catch(_){n(s,_)}}}getSessionsNeedingBackup(s){return new Promise((o,l)=>{const v=[],f=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");f.onerror=l,f.oncomplete=function(){o(v)};const p=f.objectStore("sessions_needing_backup"),_=f.objectStore("inbound_group_sessions"),T=p.openCursor();T.onsuccess=function(){const w=T.result;if(w){const M=_.get(w.key);M.onsuccess=function(){v.push({senderKey:M.result.senderCurve25519Key,sessionId:M.result.sessionId,sessionData:M.result.session})},(!s||v.length<s)&&w.continue()}}})}countSessionsNeedingBackup(s){s||(s=this.db.transaction("sessions_needing_backup","readonly"));const o=s.objectStore("sessions_needing_backup");return new Promise((l,v)=>{const f=o.count();f.onerror=v,f.onsuccess=()=>l(f.result)})}unmarkSessionsNeedingBackup(s,o){return y(this,void 0,void 0,function*(){o||(o=this.db.transaction("sessions_needing_backup","readwrite"));const l=o.objectStore("sessions_needing_backup");yield Promise.all(s.map(v=>new Promise((f,p)=>{const _=l.delete([v.senderKey,v.sessionId]);_.onsuccess=f,_.onerror=p})))})}markSessionsNeedingBackup(s,o){return y(this,void 0,void 0,function*(){o||(o=this.db.transaction("sessions_needing_backup","readwrite"));const l=o.objectStore("sessions_needing_backup");yield Promise.all(s.map(v=>new Promise((f,p)=>{const _=l.put({senderCurve25519Key:v.senderKey,sessionId:v.sessionId});_.onsuccess=f,_.onerror=p})))})}addSharedHistoryInboundGroupSession(s,o,l,v){v||(v=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));const f=v.objectStore("shared_history_inbound_group_sessions"),p=f.get([s]);p.onsuccess=()=>{const{sessions:_}=p.result||{sessions:[]};_.push([o,l]),f.put({roomId:s,sessions:_})}}getSharedHistoryInboundGroupSessions(s,o){o||(o=this.db.transaction("shared_history_inbound_group_sessions","readonly"));const v=o.objectStore("shared_history_inbound_group_sessions").get([s]);return new Promise((f,p)=>{v.onsuccess=()=>{const{sessions:_}=v.result||{sessions:[]};f(_)},v.onerror=p})}addParkedSharedHistory(s,o,l){l||(l=this.db.transaction("parked_shared_history","readwrite"));const v=l.objectStore("parked_shared_history"),f=v.get([s]);f.onsuccess=()=>{const{parked:p}=f.result||{parked:[]};p.push(o),v.put({roomId:s,parked:p})}}takeParkedSharedHistory(s,o){o||(o=this.db.transaction("parked_shared_history","readwrite"));const l=o.objectStore("parked_shared_history").openCursor(s);return new Promise((v,f)=>{l.onsuccess=()=>{const p=l.result;if(!p){v([]);return}const _=p.value;p.delete(),v(_)},l.onerror=f})}doTxn(s,o,l,v=c.logger){const f=this.db.transaction(o,s),p=i(f),_=l(f);return p.then(()=>_)}}e.Backend=h;const d=[r=>{a(r)},r=>{r.createObjectStore("account")},r=>{r.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")},r=>{r.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("device_data")},r=>{r.createObjectStore("rooms")},r=>{r.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),r.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},r=>{r.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},r=>{r.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}];e.VERSION=d.length;function b(r,s){c.logger.log(`Upgrading IndexedDBCryptoStore from version ${s} to ${e.VERSION}`),d.forEach((o,l)=>{s<=l&&o(r)})}e.upgradeDatabase=b;function a(r){const s=r.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});s.createIndex("session",["requestBody.room_id","requestBody.session_id"]),s.createIndex("state","state")}function n(r,s){r._mx_abortexception=s;try{r.abort()}catch{}}function i(r){return new Promise((s,o)=>{r.oncomplete=()=>{r._mx_abortexception!==void 0&&o(r._mx_abortexception),s(null)},r.onerror=l=>{r._mx_abortexception!==void 0?o(r._mx_abortexception):(c.logger.log("Error performing indexeddb txn",l),o(r.error))},r.onabort=l=>{r._mx_abortexception!==void 0?o(r._mx_abortexception):(c.logger.log("Error performing indexeddb txn",l),o(r.error))}})}},{"../../logger":374,"../../utils":416}],346:[function(t,E,e){(function(u){(function(){var g=this&&this.__createBinding||(Object.create?function(i,r,s,o){o===void 0&&(o=s);var l=Object.getOwnPropertyDescriptor(r,s);(!l||("get"in l?!r.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return r[s]}}),Object.defineProperty(i,o,l)}:function(i,r,s,o){o===void 0&&(o=s),i[o]=r[s]}),S=this&&this.__setModuleDefault||(Object.create?function(i,r){Object.defineProperty(i,"default",{enumerable:!0,value:r})}:function(i,r){i.default=r}),y=this&&this.__importStar||function(i){if(i&&i.__esModule)return i;var r={};if(i!=null)for(var s in i)s!=="default"&&Object.prototype.hasOwnProperty.call(i,s)&&g(r,i,s);return S(r,i),r};Object.defineProperty(e,"__esModule",{value:!0}),e.IndexedDBCryptoStore=void 0;const c=t("../../logger"),m=t("./localStorage-crypto-store"),h=t("./memory-crypto-store"),d=y(t("./indexeddb-crypto-store-backend")),b=t("../../errors"),a=y(t("../../indexeddb-helpers"));class n{static exists(r,s){return a.exists(r,s)}constructor(r,s){this.indexedDB=r,this.dbName=s}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((r,s)=>{if(!this.indexedDB){s(new Error("no indexeddb support available"));return}c.logger.log(`connecting to indexeddb ${this.dbName}`);const o=this.indexedDB.open(this.dbName,d.VERSION);o.onupgradeneeded=l=>{const v=o.result,f=l.oldVersion;d.upgradeDatabase(v,f)},o.onblocked=()=>{c.logger.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},o.onerror=l=>{c.logger.log("Error connecting to indexeddb",l),s(o.error)},o.onsuccess=()=>{const l=o.result;c.logger.log(`connected to indexeddb ${this.dbName}`),r(new d.Backend(l))}}).then(r=>r.doTxn("readonly",[n.STORE_INBOUND_GROUP_SESSIONS,n.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],s=>{r.getEndToEndInboundGroupSession("","",s,()=>{})}).then(()=>r)).catch(r=>{if(r.name==="VersionError")throw c.logger.warn("Crypto DB is too new for us to use!",r),new b.InvalidCryptoStoreError(b.InvalidCryptoStoreState.TooNew);c.logger.warn(`unable to connect to indexeddb ${this.dbName}: falling back to localStorage store: ${r}`);try{return new m.LocalStorageCryptoStore(u.localStorage)}catch(s){return c.logger.warn(`unable to open localStorage: falling back to in-memory store: ${s}`),new h.MemoryCryptoStore}}).then(r=>(this.backend=r,r)),this.backendPromise)}deleteAllData(){return new Promise((r,s)=>{if(!this.indexedDB){s(new Error("no indexeddb support available"));return}c.logger.log(`Removing indexeddb instance: ${this.dbName}`);const o=this.indexedDB.deleteDatabase(this.dbName);o.onblocked=()=>{c.logger.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},o.onerror=l=>{c.logger.log("Error deleting data from indexeddb",l),s(o.error)},o.onsuccess=()=>{c.logger.log(`Removed indexeddb instance: ${this.dbName}`),r()}}).catch(r=>{c.logger.warn(`unable to delete IndexedDBCryptoStore: ${r}`)})}getOrAddOutgoingRoomKeyRequest(r){return this.backend.getOrAddOutgoingRoomKeyRequest(r)}getOutgoingRoomKeyRequest(r){return this.backend.getOutgoingRoomKeyRequest(r)}getOutgoingRoomKeyRequestByState(r){return this.backend.getOutgoingRoomKeyRequestByState(r)}getAllOutgoingRoomKeyRequestsByState(r){return this.backend.getAllOutgoingRoomKeyRequestsByState(r)}getOutgoingRoomKeyRequestsByTarget(r,s,o){return this.backend.getOutgoingRoomKeyRequestsByTarget(r,s,o)}updateOutgoingRoomKeyRequest(r,s,o){return this.backend.updateOutgoingRoomKeyRequest(r,s,o)}deleteOutgoingRoomKeyRequest(r,s){return this.backend.deleteOutgoingRoomKeyRequest(r,s)}getAccount(r,s){this.backend.getAccount(r,s)}storeAccount(r,s){this.backend.storeAccount(r,s)}getCrossSigningKeys(r,s){this.backend.getCrossSigningKeys(r,s)}getSecretStorePrivateKey(r,s,o){this.backend.getSecretStorePrivateKey(r,s,o)}storeCrossSigningKeys(r,s){this.backend.storeCrossSigningKeys(r,s)}storeSecretStorePrivateKey(r,s,o){this.backend.storeSecretStorePrivateKey(r,s,o)}countEndToEndSessions(r,s){this.backend.countEndToEndSessions(r,s)}getEndToEndSession(r,s,o,l){this.backend.getEndToEndSession(r,s,o,l)}getEndToEndSessions(r,s,o){this.backend.getEndToEndSessions(r,s,o)}getAllEndToEndSessions(r,s){this.backend.getAllEndToEndSessions(r,s)}storeEndToEndSession(r,s,o,l){this.backend.storeEndToEndSession(r,s,o,l)}storeEndToEndSessionProblem(r,s,o){return this.backend.storeEndToEndSessionProblem(r,s,o)}getEndToEndSessionProblem(r,s){return this.backend.getEndToEndSessionProblem(r,s)}filterOutNotifiedErrorDevices(r){return this.backend.filterOutNotifiedErrorDevices(r)}getEndToEndInboundGroupSession(r,s,o,l){this.backend.getEndToEndInboundGroupSession(r,s,o,l)}getAllEndToEndInboundGroupSessions(r,s){this.backend.getAllEndToEndInboundGroupSessions(r,s)}addEndToEndInboundGroupSession(r,s,o,l){this.backend.addEndToEndInboundGroupSession(r,s,o,l)}storeEndToEndInboundGroupSession(r,s,o,l){this.backend.storeEndToEndInboundGroupSession(r,s,o,l)}storeEndToEndInboundGroupSessionWithheld(r,s,o,l){this.backend.storeEndToEndInboundGroupSessionWithheld(r,s,o,l)}storeEndToEndDeviceData(r,s){this.backend.storeEndToEndDeviceData(r,s)}getEndToEndDeviceData(r,s){this.backend.getEndToEndDeviceData(r,s)}storeEndToEndRoom(r,s,o){this.backend.storeEndToEndRoom(r,s,o)}getEndToEndRooms(r,s){this.backend.getEndToEndRooms(r,s)}getSessionsNeedingBackup(r){return this.backend.getSessionsNeedingBackup(r)}countSessionsNeedingBackup(r){return this.backend.countSessionsNeedingBackup(r)}unmarkSessionsNeedingBackup(r,s){return this.backend.unmarkSessionsNeedingBackup(r,s)}markSessionsNeedingBackup(r,s){return this.backend.markSessionsNeedingBackup(r,s)}addSharedHistoryInboundGroupSession(r,s,o,l){this.backend.addSharedHistoryInboundGroupSession(r,s,o,l)}getSharedHistoryInboundGroupSessions(r,s){return this.backend.getSharedHistoryInboundGroupSessions(r,s)}addParkedSharedHistory(r,s,o){this.backend.addParkedSharedHistory(r,s,o)}takeParkedSharedHistory(r,s){return this.backend.takeParkedSharedHistory(r,s)}doTxn(r,s,o,l){return this.backend.doTxn(r,s,o,l)}}e.IndexedDBCryptoStore=n,n.STORE_ACCOUNT="account",n.STORE_SESSIONS="sessions",n.STORE_INBOUND_GROUP_SESSIONS="inbound_group_sessions",n.STORE_INBOUND_GROUP_SESSIONS_WITHHELD="inbound_group_sessions_withheld",n.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS="shared_history_inbound_group_sessions",n.STORE_PARKED_SHARED_HISTORY="parked_shared_history",n.STORE_DEVICE_DATA="device_data",n.STORE_ROOMS="rooms",n.STORE_BACKUP="sessions_needing_backup"}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../../errors":359,"../../indexeddb-helpers":372,"../../logger":374,"./indexeddb-crypto-store-backend":345,"./localStorage-crypto-store":347,"./memory-crypto-store":348}],347:[function(t,E,e){var u=this&&this.__awaiter||function(w,M,A,W){function ee(F){return F instanceof A?F:new A(function(C){C(F)})}return new(A||(A=Promise))(function(F,C){function O(j){try{D(W.next(j))}catch(Y){C(Y)}}function I(j){try{D(W.throw(j))}catch(Y){C(Y)}}function D(j){j.done?F(j.value):ee(j.value).then(O,I)}D((W=W.apply(w,M||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.LocalStorageCryptoStore=void 0;const g=t("../../logger"),S=t("./memory-crypto-store"),y=t("../../utils"),c="crypto.",m=c+"account",h=c+"cross_signing_keys",d=c+"notified_error_devices",b=c+"device_data",a=c+"inboundgroupsessions/",n=c+"inboundgroupsessions.withheld/",i=c+"rooms/",r=c+"sessionsneedingbackup";function s(w){return c+"sessions/"+w}function o(w){return c+"session.problems/"+w}function l(w,M){return a+w+"/"+M}function v(w,M){return n+w+"/"+M}function f(w){return i+w}class p extends S.MemoryCryptoStore{static exists(M){var A;const W=M.length;for(let ee=0;ee<W;ee++)if(!((A=M.key(ee))===null||A===void 0)&&A.startsWith(c))return!0;return!1}constructor(M){super(),this.store=M}countEndToEndSessions(M,A){var W;let ee=0;for(let F=0;F<this.store.length;++F)!((W=this.store.key(F))===null||W===void 0)&&W.startsWith(s(""))&&++ee;A(ee)}_getEndToEndSessions(M){const A=_(this.store,s(M)),W={};for(const[ee,F]of Object.entries(A||{}))typeof F=="string"?W[ee]={session:F}:W[ee]=F;return W}getEndToEndSession(M,A,W,ee){const F=this._getEndToEndSessions(M);ee(F[A]||{})}getEndToEndSessions(M,A,W){W(this._getEndToEndSessions(M)||{})}getAllEndToEndSessions(M,A){var W;for(let ee=0;ee<this.store.length;++ee)if(!((W=this.store.key(ee))===null||W===void 0)&&W.startsWith(s(""))){const F=this.store.key(ee).split("/")[1];for(const C of Object.values(this._getEndToEndSessions(F)))A(C)}}storeEndToEndSession(M,A,W,ee){const F=this._getEndToEndSessions(M)||{};F[A]=W,T(this.store,s(M),F)}storeEndToEndSessionProblem(M,A,W){return u(this,void 0,void 0,function*(){const ee=o(M),F=_(this.store,ee)||[];F.push({type:A,fixed:W,time:Date.now()}),F.sort((C,O)=>C.time-O.time),T(this.store,ee,F)})}getEndToEndSessionProblem(M,A){return u(this,void 0,void 0,function*(){const W=o(M),ee=_(this.store,W)||[];if(!ee.length)return null;const F=ee[ee.length-1];for(const C of ee)if(C.time>A)return Object.assign({},C,{fixed:F.fixed});return F.fixed?null:F})}filterOutNotifiedErrorDevices(M){return u(this,void 0,void 0,function*(){const A=_(this.store,d)||{},W=[];for(const ee of M){const{userId:F,deviceInfo:C}=ee;F in A?C.deviceId in A[F]||(W.push(ee),(0,y.safeSet)(A[F],C.deviceId,!0)):(W.push(ee),(0,y.safeSet)(A,F,{[C.deviceId]:!0}))}return T(this.store,d,A),W})}getEndToEndInboundGroupSession(M,A,W,ee){ee(_(this.store,l(M,A)),_(this.store,v(M,A)))}getAllEndToEndInboundGroupSessions(M,A){for(let W=0;W<this.store.length;++W){const ee=this.store.key(W);ee!=null&&ee.startsWith(a)&&A({senderKey:ee.slice(a.length,a.length+43),sessionId:ee.slice(a.length+44),sessionData:_(this.store,ee)})}A(null)}addEndToEndInboundGroupSession(M,A,W,ee){_(this.store,l(M,A))||this.storeEndToEndInboundGroupSession(M,A,W,ee)}storeEndToEndInboundGroupSession(M,A,W,ee){T(this.store,l(M,A),W)}storeEndToEndInboundGroupSessionWithheld(M,A,W,ee){T(this.store,v(M,A),W)}getEndToEndDeviceData(M,A){A(_(this.store,b))}storeEndToEndDeviceData(M,A){T(this.store,b,M)}storeEndToEndRoom(M,A,W){T(this.store,f(M),A)}getEndToEndRooms(M,A){const W={},ee=f("");for(let F=0;F<this.store.length;++F){const C=this.store.key(F);if(C!=null&&C.startsWith(ee)){const O=C.slice(ee.length);W[O]=_(this.store,C)}}A(W)}getSessionsNeedingBackup(M){const A=_(this.store,r)||{},W=[];for(const ee in A)if(Object.prototype.hasOwnProperty.call(A,ee)){const F=ee.slice(0,43),C=ee.slice(44);if(this.getEndToEndInboundGroupSession(F,C,null,O=>{W.push({senderKey:F,sessionId:C,sessionData:O})}),M&&W.length>=M)break}return Promise.resolve(W)}countSessionsNeedingBackup(){const M=_(this.store,r)||{};return Promise.resolve(Object.keys(M).length)}unmarkSessionsNeedingBackup(M){const A=_(this.store,r)||{};for(const W of M)delete A[W.senderKey+"/"+W.sessionId];return T(this.store,r,A),Promise.resolve()}markSessionsNeedingBackup(M){const A=_(this.store,r)||{};for(const W of M)A[W.senderKey+"/"+W.sessionId]=!0;return T(this.store,r,A),Promise.resolve()}deleteAllData(){return this.store.removeItem(m),Promise.resolve()}getAccount(M,A){const W=_(this.store,m);A(W)}storeAccount(M,A){T(this.store,m,A)}getCrossSigningKeys(M,A){const W=_(this.store,h);A(W)}getSecretStorePrivateKey(M,A,W){const ee=_(this.store,c+`ssss_cache.${W}`);A(ee)}storeCrossSigningKeys(M,A){T(this.store,h,A)}storeSecretStorePrivateKey(M,A,W){T(this.store,c+`ssss_cache.${A}`,W)}doTxn(M,A,W){return Promise.resolve(W(null))}}e.LocalStorageCryptoStore=p;function _(w,M){try{return JSON.parse(w.getItem(M))}catch(A){g.logger.log("Error: Failed to get key %s: %s",M,A.message),g.logger.log(A.stack)}return null}function T(w,M,A){w.setItem(M,JSON.stringify(A))}},{"../../logger":374,"../../utils":416,"./memory-crypto-store":348}],348:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(b,a,n,i){i===void 0&&(i=n);var r=Object.getOwnPropertyDescriptor(a,n);(!r||("get"in r?!a.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return a[n]}}),Object.defineProperty(b,i,r)}:function(b,a,n,i){i===void 0&&(i=n),b[i]=a[n]}),g=this&&this.__setModuleDefault||(Object.create?function(b,a){Object.defineProperty(b,"default",{enumerable:!0,value:a})}:function(b,a){b.default=a}),S=this&&this.__importStar||function(b){if(b&&b.__esModule)return b;var a={};if(b!=null)for(var n in b)n!=="default"&&Object.prototype.hasOwnProperty.call(b,n)&&u(a,b,n);return g(a,b),a},y=this&&this.__awaiter||function(b,a,n,i){function r(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function l(p){try{f(i.next(p))}catch(_){o(_)}}function v(p){try{f(i.throw(p))}catch(_){o(_)}}function f(p){p.done?s(p.value):r(p.value).then(l,v)}f((i=i.apply(b,a||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.MemoryCryptoStore=void 0;const c=t("../../logger"),m=S(t("../../utils")),h=t("../../utils");class d{constructor(){this.outgoingRoomKeyRequests=[],this.account=null,this.crossSigningKeys=null,this.privateKeys={},this.sessions={},this.sessionProblems={},this.notifiedErrorDevices={},this.inboundGroupSessions={},this.inboundGroupSessionsWithheld={},this.deviceData=null,this.rooms={},this.sessionsNeedingBackup={},this.sharedHistoryInboundGroupSessions={},this.parkedSharedHistory=new Map}startup(){return y(this,void 0,void 0,function*(){return this})}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(a){const n=a.requestBody;return m.promiseTry(()=>{const i=this._getOutgoingRoomKeyRequest(n);return i?(c.logger.log(`already have key request outstanding for ${n.room_id} / ${n.session_id}: not sending another`),i):(c.logger.log(`enqueueing key request for ${n.room_id} / `+n.session_id),this.outgoingRoomKeyRequests.push(a),a)})}getOutgoingRoomKeyRequest(a){return Promise.resolve(this._getOutgoingRoomKeyRequest(a))}_getOutgoingRoomKeyRequest(a){for(const n of this.outgoingRoomKeyRequests)if(m.deepCompare(n.requestBody,a))return n;return null}getOutgoingRoomKeyRequestByState(a){for(const n of this.outgoingRoomKeyRequests)for(const i of a)if(n.state===i)return Promise.resolve(n);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(a){return Promise.resolve(this.outgoingRoomKeyRequests.filter(n=>n.state==a))}getOutgoingRoomKeyRequestsByTarget(a,n,i){const r=[];for(const s of this.outgoingRoomKeyRequests)for(const o of i)s.state===o&&s.recipients.some(l=>l.userId===a&&l.deviceId===n)&&r.push(s);return Promise.resolve(r)}updateOutgoingRoomKeyRequest(a,n,i){for(const r of this.outgoingRoomKeyRequests)if(r.requestId===a)return r.state!==n?(c.logger.warn(`Cannot update room key request from ${n} as it was already updated to ${r.state}`),Promise.resolve(null)):(Object.assign(r,i),Promise.resolve(r));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(a,n){for(let i=0;i<this.outgoingRoomKeyRequests.length;i++){const r=this.outgoingRoomKeyRequests[i];if(r.requestId===a)return r.state!=n?(c.logger.warn(`Cannot delete room key request in state ${r.state} (expected ${n})`),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(i,1),Promise.resolve(r))}return Promise.resolve(null)}getAccount(a,n){n(this.account)}storeAccount(a,n){this.account=n}getCrossSigningKeys(a,n){n(this.crossSigningKeys)}getSecretStorePrivateKey(a,n,i){const r=this.privateKeys[i];n(r||null)}storeCrossSigningKeys(a,n){this.crossSigningKeys=n}storeSecretStorePrivateKey(a,n,i){this.privateKeys[n]=i}countEndToEndSessions(a,n){n(Object.keys(this.sessions).length)}getEndToEndSession(a,n,i,r){const s=this.sessions[a]||{};r(s[n]||null)}getEndToEndSessions(a,n,i){i(this.sessions[a]||{})}getAllEndToEndSessions(a,n){Object.entries(this.sessions).forEach(([i,r])=>{Object.entries(r).forEach(([s,o])=>{n(Object.assign(Object.assign({},o),{deviceKey:i,sessionId:s}))})})}storeEndToEndSession(a,n,i,r){let s=this.sessions[a];s===void 0&&(s={},this.sessions[a]=s),s[n]=i}storeEndToEndSessionProblem(a,n,i){return y(this,void 0,void 0,function*(){const r=this.sessionProblems[a]=this.sessionProblems[a]||[];r.push({type:n,fixed:i,time:Date.now()}),r.sort((s,o)=>s.time-o.time)})}getEndToEndSessionProblem(a,n){return y(this,void 0,void 0,function*(){const i=this.sessionProblems[a]||[];if(!i.length)return null;const r=i[i.length-1];for(const s of i)if(s.time>n)return Object.assign({},s,{fixed:r.fixed});return r.fixed?null:r})}filterOutNotifiedErrorDevices(a){return y(this,void 0,void 0,function*(){const n=this.notifiedErrorDevices,i=[];for(const r of a){const{userId:s,deviceInfo:o}=r;s in n?o.deviceId in n[s]||(i.push(r),(0,h.safeSet)(n[s],o.deviceId,!0)):(i.push(r),(0,h.safeSet)(n,s,{[o.deviceId]:!0}))}return i})}getEndToEndInboundGroupSession(a,n,i,r){const s=a+"/"+n;r(this.inboundGroupSessions[s]||null,this.inboundGroupSessionsWithheld[s]||null)}getAllEndToEndInboundGroupSessions(a,n){for(const i of Object.keys(this.inboundGroupSessions))n({senderKey:i.slice(0,43),sessionId:i.slice(44),sessionData:this.inboundGroupSessions[i]});n(null)}addEndToEndInboundGroupSession(a,n,i,r){const s=a+"/"+n;this.inboundGroupSessions[s]===void 0&&(this.inboundGroupSessions[s]=i)}storeEndToEndInboundGroupSession(a,n,i,r){this.inboundGroupSessions[a+"/"+n]=i}storeEndToEndInboundGroupSessionWithheld(a,n,i,r){const s=a+"/"+n;this.inboundGroupSessionsWithheld[s]=i}getEndToEndDeviceData(a,n){n(this.deviceData)}storeEndToEndDeviceData(a,n){this.deviceData=a}storeEndToEndRoom(a,n,i){this.rooms[a]=n}getEndToEndRooms(a,n){n(this.rooms)}getSessionsNeedingBackup(a){const n=[];for(const i in this.sessionsNeedingBackup)if(this.inboundGroupSessions[i]&&(n.push({senderKey:i.slice(0,43),sessionId:i.slice(44),sessionData:this.inboundGroupSessions[i]}),a&&i.length>=a))break;return Promise.resolve(n)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(a){for(const n of a){const i=n.senderKey+"/"+n.sessionId;delete this.sessionsNeedingBackup[i]}return Promise.resolve()}markSessionsNeedingBackup(a){for(const n of a){const i=n.senderKey+"/"+n.sessionId;this.sessionsNeedingBackup[i]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(a,n,i){const r=this.sharedHistoryInboundGroupSessions[a]||[];r.push([n,i]),this.sharedHistoryInboundGroupSessions[a]=r}getSharedHistoryInboundGroupSessions(a){return Promise.resolve(this.sharedHistoryInboundGroupSessions[a]||[])}addParkedSharedHistory(a,n){var i;const r=(i=this.parkedSharedHistory.get(a))!==null&&i!==void 0?i:[];r.push(n),this.parkedSharedHistory.set(a,r)}takeParkedSharedHistory(a){var n;const i=(n=this.parkedSharedHistory.get(a))!==null&&n!==void 0?n:[];return this.parkedSharedHistory.delete(a),Promise.resolve(i)}doTxn(a,n,i){return Promise.resolve(i(null))}}e.MemoryCryptoStore=d},{"../../logger":374,"../../utils":416}],349:[function(t,E,e){var u=this&&this.__awaiter||function(r,s,o,l){function v(f){return f instanceof o?f:new o(function(p){p(f)})}return new(o||(o=Promise))(function(f,p){function _(M){try{w(l.next(M))}catch(A){p(A)}}function T(M){try{w(l.throw(M))}catch(A){p(A)}}function w(M){M.done?f(M.value):v(M.value).then(_,T)}w((l=l.apply(r,s||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.VerificationBase=e.VerificationEvent=e.SwitchStartEventError=void 0;const g=t("../../models/event"),S=t("../../@types/event"),y=t("../../logger"),c=t("../deviceinfo"),m=t("./Error"),h=t("../CrossSigning"),d=t("../../models/typed-event-emitter"),b=new Error("Verification timed out");class a extends Error{constructor(s){super(),this.startEvent=s}}e.SwitchStartEventError=a;var n;(function(r){r.Cancel="cancel"})(n=e.VerificationEvent||(e.VerificationEvent={}));class i extends d.TypedEventEmitter{constructor(s,o,l,v,f,p){super(),this.channel=s,this.baseApis=o,this.userId=l,this.deviceId=v,this.startEvent=f,this.request=p,this.cancelled=!1,this._done=!1,this.promise=null,this.transactionTimeoutTimer=null}get initiatedByMe(){if(!this.startEvent)return!0;const s=this.startEvent.getSender(),o=this.startEvent.getContent();return s===this.baseApis.getUserId()&&o.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){y.logger.info("Refreshing/starting the verification transaction timeout timer"),this.transactionTimeoutTimer!==null&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout(()=>{!this._done&&!this.cancelled&&(y.logger.info("Triggering verification timeout"),this.cancel(b))},10*60*1e3)}endTimer(){this.transactionTimeoutTimer!==null&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(s,o){return this.channel.send(s,o)}waitForEvent(s){if(this._done)return Promise.reject(new Error("Verification is already done"));const o=this.request.getEventFromOtherParty(s);return o?Promise.resolve(o):(this.expectedEvent=s,new Promise((l,v)=>{this.resolveEvent=l,this.rejectEvent=v}))}canSwitchStartEvent(s){return!1}switchStartEvent(s){if(this.canSwitchStartEvent(s))if(y.logger.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){const o=this.rejectEvent;this.rejectEvent=void 0,o(new a(s))}else this.startEvent=s}handleEvent(s){var o;if(!this._done){if(s.getType()===this.expectedEvent)this.expectedEvent!==S.EventType.KeyVerificationDone&&(this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),(o=this.resolveEvent)===null||o===void 0||o.call(this,s));else if(s.getType()===S.EventType.KeyVerificationCancel){const l=this.reject;if(this.reject=void 0,l){const v=s.getContent(),{reason:f,code:p}=v;l(new Error(`Other side cancelled verification because ${f} (${p})`))}}else if(this.expectedEvent){const l=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+s.getType());if(this.expectedEvent=void 0,this.rejectEvent){const v=this.rejectEvent;this.rejectEvent=void 0,v(l)}this.cancel(l)}}}done(){var s;return u(this,void 0,void 0,function*(){if(this.endTimer(),!this._done)return this.request.onVerifierFinished(),(s=this.resolve)===null||s===void 0||s.call(this),(0,h.requestKeysDuringVerification)(this.baseApis,this.userId,this.deviceId)})}cancel(s){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(s===b){const o=(0,m.newTimeoutError)();this.send(o.getType(),o.getContent())}else if(s instanceof g.MatrixEvent){if(s.getSender()!==this.userId){const l=s.getContent();s.getType()===S.EventType.KeyVerificationCancel?(l.code=l.code||"m.unknown",l.reason=l.reason||l.body||"Unknown reason",this.send(S.EventType.KeyVerificationCancel,l)):this.send(S.EventType.KeyVerificationCancel,{code:"m.unknown",reason:l.body||"Unknown reason"})}}else this.send(S.EventType.KeyVerificationCancel,{code:"m.unknown",reason:s.toString()});this.promise!==null?this.reject&&this.reject(s):this.promise=Promise.reject(s),this.emit(n.Cancel,s)}}verify(){return this.promise?this.promise:(this.promise=new Promise((s,o)=>{this.resolve=(...l)=>{this._done=!0,this.endTimer(),s(...l)},this.reject=l=>{this._done=!0,this.endTimer(),o(l)}}),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise((s,o)=>{var l;((l=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))===null||l===void 0?void 0:l.getId())===this.deviceId&&o(new Error("Device ID is the same as the cross-signing ID")),s()}).then(()=>this.doVerification()).then(this.done.bind(this),this.cancel.bind(this))),this.promise)}verifyKeys(s,o,l){return u(this,void 0,void 0,function*(){const v=[];for(const[f,p]of Object.entries(o)){const _=f.split(":",2)[1],T=this.baseApis.getStoredDevice(s,_);if(T)l(f,T,p),v.push([_,f,T.keys[f]]);else{const w=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(s);w&&w.getId()===_?(l(f,c.DeviceInfo.fromStorage({keys:{[f]:_}},_),p),v.push([_,f,_])):y.logger.warn(`verification: Could not find device ${_} to verify`)}}if(!v.length)throw new Error("No devices could be verified");y.logger.info("Verification completed! Marking devices verified: ",v);for(const[f,p,_]of v)yield this.baseApis.crypto.setDeviceVerification(s,f,!0,null,null,{[p]:_});s==this.baseApis.credentials.userId&&(yield this.baseApis.checkKeyBackup())})}get events(){}}e.VerificationBase=i},{"../../@types/event":306,"../../logger":374,"../../models/event":383,"../../models/typed-event-emitter":395,"../CrossSigning":324,"../deviceinfo":340,"./Error":350}],350:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.errorFromEvent=e.newInvalidMessageError=e.newKeyMismatchError=e.newUnexpectedMessageError=e.newUnknownMethodError=e.newTimeoutError=e.newUserCancelledError=e.errorFactory=e.newVerificationError=void 0;const u=t("../../models/event"),g=t("../../@types/event");function S(m,h,d){const b=Object.assign({},{code:m,reason:h},d);return new u.MatrixEvent({type:g.EventType.KeyVerificationCancel,content:b})}e.newVerificationError=S;function y(m,h){return function(d){return S(m,h,d)}}e.errorFactory=y,e.newUserCancelledError=y("m.user","Cancelled by user"),e.newTimeoutError=y("m.timeout","Timed out"),e.newUnknownMethodError=y("m.unknown_method","Unknown method"),e.newUnexpectedMessageError=y("m.unexpected_message","Unexpected message"),e.newKeyMismatchError=y("m.key_mismatch","Key mismatch"),e.newInvalidMessageError=y("m.invalid_message","Invalid message");function c(m){const h=m.getContent();if(h){const{code:d,reason:b}=h;return{code:d,reason:b}}else return{code:"Unknown error",reason:"m.unknown"}}e.errorFromEvent=c},{"../../@types/event":306,"../../models/event":383}],351:[function(t,E,e){var u=this&&this.__awaiter||function(y,c,m,h){function d(b){return b instanceof m?b:new m(function(a){a(b)})}return new(m||(m=Promise))(function(b,a){function n(s){try{r(h.next(s))}catch(o){a(o)}}function i(s){try{r(h.throw(s))}catch(o){a(o)}}function r(s){s.done?b(s.value):d(s.value).then(n,i)}r((h=h.apply(y,c||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.IllegalMethod=void 0;const g=t("./Base");class S extends g.VerificationBase{constructor(){super(...arguments),this.doVerification=()=>u(this,void 0,void 0,function*(){throw new Error("Verification is not possible with this method")})}static factory(c,m,h,d,b,a){return new S(c,m,h,d,b,a)}static get NAME(){return"org.matrix.illegal_method"}}e.IllegalMethod=S},{"./Base":349}],352:[function(t,E,e){(function(u,g){(function(){var S=this&&this.__awaiter||function(s,o,l,v){function f(p){return p instanceof l?p:new l(function(_){_(p)})}return new(l||(l=Promise))(function(p,_){function T(A){try{M(v.next(A))}catch(W){_(W)}}function w(A){try{M(v.throw(A))}catch(W){_(W)}}function M(A){A.done?p(A.value):f(A.value).then(T,w)}M((v=v.apply(s,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.QRCodeData=e.ReciprocateQRCode=e.QrCodeEvent=e.SCAN_QR_CODE_METHOD=e.SHOW_QR_CODE_METHOD=void 0;const y=t("./Base"),c=t("./Error"),m=t("../olmlib"),h=t("../../logger");e.SHOW_QR_CODE_METHOD="m.qr_code.show.v1",e.SCAN_QR_CODE_METHOD="m.qr_code.scan.v1";var d;(function(s){s.ShowReciprocateQr="show_reciprocate_qr"})(d=e.QrCodeEvent||(e.QrCodeEvent={}));class b extends y.VerificationBase{constructor(){super(...arguments),this.doVerification=()=>S(this,void 0,void 0,function*(){if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:o}=this.request;if(this.startEvent.getContent().secret!==(o==null?void 0:o.encodedSharedSecret))throw(0,c.newKeyMismatchError)();yield new Promise((v,f)=>{this.reciprocateQREvent={confirm:v,cancel:()=>f((0,c.newUserCancelledError)())},this.emit(d.ShowReciprocateQr,this.reciprocateQREvent)});const l={};switch(o==null?void 0:o.mode){case i.VerifyOtherUser:{const v=o.otherUserMasterKey;l[`ed25519:${v}`]=v;break}case i.VerifySelfTrusted:{const v=this.request.targetDevice.deviceId;l[`ed25519:${v}`]=o.otherDeviceKey;break}case i.VerifySelfUntrusted:{const v=o.myMasterKey;l[`ed25519:${v}`]=v;break}}yield this.verifyKeys(this.userId,l,(v,f,p)=>{const _=l[v];if(!_)throw(0,c.newKeyMismatchError)();if(p!==_)throw h.logger.error("key ID from key info does not match"),(0,c.newKeyMismatchError)();for(const T in f.keys){if(!T.startsWith("ed25519"))continue;const w=l[T];if(!w)throw(0,c.newKeyMismatchError)();if(f.keys[T]!==w)throw h.logger.error("master key does not match"),(0,c.newKeyMismatchError)()}})})}static factory(o,l,v,f,p,_){return new b(o,l,v,f,p,_)}static get NAME(){return"m.reciprocate.v1"}}e.ReciprocateQRCode=b;const a=2,n="MATRIX";var i;(function(s){s[s.VerifyOtherUser=0]="VerifyOtherUser",s[s.VerifySelfTrusted=1]="VerifySelfTrusted",s[s.VerifySelfUntrusted=2]="VerifySelfUntrusted"})(i||(i={}));class r{constructor(o,l,v,f,p,_){this.mode=o,this.sharedSecret=l,this.otherUserMasterKey=v,this.otherDeviceKey=f,this.myMasterKey=p,this.buffer=_}static create(o,l){return S(this,void 0,void 0,function*(){const v=r.generateSharedSecret(),f=r.determineMode(o,l);let p=null,_=null,T=null;if(f===i.VerifyOtherUser)p=l.getStoredCrossSigningForUser(o.otherUserId).getId("master");else if(f===i.VerifySelfTrusted)_=yield r.getOtherDeviceKey(o,l);else if(f===i.VerifySelfUntrusted){const A=l.getUserId();T=l.getStoredCrossSigningForUser(A).getId("master")}const w=r.generateQrData(o,l,f,v,p,_,T),M=r.generateBuffer(w);return new r(f,v,p,_,T,M)})}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){const o=new Uint8Array(11);return u.crypto.getRandomValues(o),(0,m.encodeUnpaddedBase64)(o)}static getOtherDeviceKey(o,l){return S(this,void 0,void 0,function*(){const v=l.getUserId(),f=o.targetDevice,p=f.deviceId?l.getStoredDevice(v,f.deviceId):void 0;if(!p)throw new Error("could not find device "+(f==null?void 0:f.deviceId));return p.getFingerprint()})}static determineMode(o,l){const v=l.getUserId(),f=o.otherUserId;let p=i.VerifyOtherUser;return v===f&&(l.checkUserTrust(v).isCrossSigningVerified()?p=i.VerifySelfTrusted:p=i.VerifySelfUntrusted),p}static generateQrData(o,l,v,f,p,_,T){const w=l.getUserId(),M=o.channel.transactionId,A={prefix:n,version:a,mode:v,transactionId:M,firstKeyB64:"",secondKeyB64:"",secretB64:f},W=l.getStoredCrossSigningForUser(w);return v===i.VerifyOtherUser?(A.firstKeyB64=W.getId("master"),A.secondKeyB64=p):v===i.VerifySelfTrusted?(A.firstKeyB64=W.getId("master"),A.secondKeyB64=_):v===i.VerifySelfUntrusted&&(A.firstKeyB64=l.getDeviceEd25519Key(),A.secondKeyB64=T),A}static generateBuffer(o){let l=g.alloc(0);const v=T=>{const w=g.from([T]);l=g.concat([l,w])},f=T=>{const w=g.alloc(2);w.writeInt16BE(T,0),l=g.concat([l,w])},p=(T,w,M=!0)=>{const A=g.from(T,w);M&&f(A.byteLength),l=g.concat([l,A])},_=T=>{const w=(0,m.decodeBase64)(T),M=g.from(w);l=g.concat([l,M])};return p(o.prefix,"ascii",!1),v(o.version),v(o.mode),p(o.transactionId,"utf-8"),_(o.firstKeyB64),_(o.secondKeyB64),_(o.secretB64),l}}e.QRCodeData=r}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer)},{"../../logger":374,"../olmlib":343,"./Base":349,"./Error":350,buffer:68}],353:[function(t,E,e){(function(u){(function(){var g=this&&this.__awaiter||function(Y,q,B,R){function k(P){return P instanceof B?P:new B(function(V){V(P)})}return new(B||(B=Promise))(function(P,V){function x(ae){try{te(R.next(ae))}catch(de){V(de)}}function Q(ae){try{te(R.throw(ae))}catch(de){V(de)}}function te(ae){ae.done?P(ae.value):k(ae.value).then(x,Q)}te((R=R.apply(Y,q||[])).next())})},S=this&&this.__importDefault||function(Y){return Y&&Y.__esModule?Y:{default:Y}};Object.defineProperty(e,"__esModule",{value:!0}),e.SAS=e.SasEvent=void 0;const y=S(t("another-json")),c=t("./Base"),m=t("./Error"),h=t("../../logger"),d=t("./SASDecimal"),b=t("../../@types/event"),a=b.EventType.KeyVerificationStart,n=[b.EventType.KeyVerificationAccept,b.EventType.KeyVerificationKey,b.EventType.KeyVerificationMac];let i;const r=(0,m.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),s=(0,m.errorFactory)("m.mismatched_commitment","Mismatched commitment"),o=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];function l(Y){return[Y[0]>>2,(Y[0]&3)<<4|Y[1]>>4,(Y[1]&15)<<2|Y[2]>>6,Y[2]&63,Y[3]>>2,(Y[3]&3)<<4|Y[4]>>4,(Y[4]&15)<<2|Y[5]>>6].map(B=>o[B])}const v={decimal:d.generateDecimalSas,emoji:l};function f(Y,q){const B={};for(const R of q)R in v&&(B[R]=v[R](Array.from(Y)));return B}const p={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function _(Y,q){return function(B,R){const k=Y[p[q]](B,R);return h.logger.log("SAS calculateMAC:",q,[B,R],k),k}}const T={"curve25519-hkdf-sha256":function(Y,q,B){const R=`${Y.baseApis.getUserId()}|${Y.baseApis.deviceId}|${Y.ourSASPubKey}|`,k=`${Y.userId}|${Y.deviceId}|${Y.theirSASPubKey}|`,P="MATRIX_KEY_VERIFICATION_SAS|"+(Y.initiatedByMe?R+k:k+R)+Y.channel.transactionId;return q.generate_bytes(P,B)},curve25519:function(Y,q,B){const R=`${Y.baseApis.getUserId()}${Y.baseApis.deviceId}`,k=`${Y.userId}${Y.deviceId}`,P="MATRIX_KEY_VERIFICATION_SAS"+(Y.initiatedByMe?R+k:k+R)+Y.channel.transactionId;return q.generate_bytes(P,B)}},w=["curve25519-hkdf-sha256","curve25519"],M=["sha256"],A=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],W=Object.keys(v),ee=new Set(w),F=new Set(M),C=new Set(A),O=new Set(W);function I(Y,q){return Array.isArray(Y)?Y.filter(B=>q.has(B)):[]}var D;(function(Y){Y.ShowSas="show_sas"})(D=e.SasEvent||(e.SasEvent={}));class j extends c.VerificationBase{constructor(){super(...arguments),this.doVerification=()=>g(this,void 0,void 0,function*(){yield u.Olm.init(),i=i||new u.Olm.Utility,yield this.baseApis.downloadKeys([this.userId]);let q=!1;do try{return this.initiatedByMe?yield this.doSendVerification():yield this.doRespondVerification()}catch(B){if(B instanceof c.SwitchStartEventError)this.startEvent=B.startEvent,q=!0;else throw B}while(q)})}static get NAME(){return"m.sas.v1"}get events(){return n}canSwitchStartEvent(q){if(q.getType()!==a)return!1;const B=q.getContent();return(B==null?void 0:B.method)===j.NAME&&!!this.waitingForAccept}sendStart(){return g(this,void 0,void 0,function*(){const q=this.channel.completeContent(a,{method:j.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:w,hashes:M,message_authentication_codes:A,short_authentication_string:W});return yield this.channel.sendCompleted(a,q),q})}verifyAndCheckMAC(q,B,R,k){return g(this,void 0,void 0,function*(){const P=T[q](this,R,6),V=new Promise((te,ae)=>{this.sasEvent={sas:f(P,B),confirm:()=>g(this,void 0,void 0,function*(){try{yield this.sendMAC(R,k),te()}catch(de){ae(de)}}),cancel:()=>ae((0,m.newUserCancelledError)()),mismatch:()=>ae(r())},this.emit(D.ShowSas,this.sasEvent)}),[x]=yield Promise.all([this.waitForEvent(b.EventType.KeyVerificationMac).then(te=>(this.expectedEvent=b.EventType.KeyVerificationDone,te)),V]),Q=x.getContent();yield this.checkMAC(R,Q,k)})}doSendVerification(){return g(this,void 0,void 0,function*(){this.waitingForAccept=!0;let q;if(this.startEvent?q=this.channel.completedContentFromEvent(this.startEvent):q=yield this.sendStart(),!this.initiatedByMe)throw new c.SwitchStartEventError(this.startEvent);let B;try{B=yield this.waitForEvent(b.EventType.KeyVerificationAccept)}finally{this.waitingForAccept=!1}let R=B.getContent();const k=I(R.short_authentication_string,O);if(!(ee.has(R.key_agreement_protocol)&&F.has(R.hash)&&C.has(R.message_authentication_code)&&k.length))throw(0,m.newUnknownMethodError)();if(typeof R.commitment!="string")throw(0,m.newInvalidMessageError)();const P=R.key_agreement_protocol,V=R.message_authentication_code,x=R.commitment,Q=new u.Olm.SAS;try{this.ourSASPubKey=Q.get_pubkey(),yield this.send(b.EventType.KeyVerificationKey,{key:this.ourSASPubKey}),B=yield this.waitForEvent(b.EventType.KeyVerificationKey),R=B.getContent();const te=R.key+y.default.stringify(q);if(i.sha256(te)!==x)throw s();this.theirSASPubKey=R.key,Q.set_their_key(R.key),yield this.verifyAndCheckMAC(P,k,Q,V)}finally{Q.free()}})}doRespondVerification(){return g(this,void 0,void 0,function*(){let q=this.channel.completedContentFromEvent(this.startEvent);const B=I(w,new Set(q.key_agreement_protocols))[0],R=I(M,new Set(q.hashes))[0],k=I(A,new Set(q.message_authentication_codes))[0],P=I(q.short_authentication_string,O);if(!(B!==void 0&&R!==void 0&&k!==void 0&&P.length))throw(0,m.newUnknownMethodError)();const V=new u.Olm.SAS;try{const x=V.get_pubkey()+y.default.stringify(q);yield this.send(b.EventType.KeyVerificationAccept,{key_agreement_protocol:B,hash:R,message_authentication_code:k,short_authentication_string:P,commitment:i.sha256(x)}),q=(yield this.waitForEvent(b.EventType.KeyVerificationKey)).getContent(),this.theirSASPubKey=q.key,V.set_their_key(q.key),this.ourSASPubKey=V.get_pubkey(),yield this.send(b.EventType.KeyVerificationKey,{key:this.ourSASPubKey}),yield this.verifyAndCheckMAC(B,P,V,k)}finally{V.free()}})}sendMAC(q,B){const R={},k=[],P="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,V=`ed25519:${this.baseApis.deviceId}`;R[V]=_(q,B)(this.baseApis.getDeviceEd25519Key(),P+V),k.push(V);const x=this.baseApis.getCrossSigningId();if(x){const te=`ed25519:${x}`;R[te]=_(q,B)(x,P+te),k.push(te)}const Q=_(q,B)(k.sort().join(","),P+"KEY_IDS");return this.send(b.EventType.KeyVerificationMac,{mac:R,keys:Q})}checkMAC(q,B,R){return g(this,void 0,void 0,function*(){const k="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(B.keys!==_(q,R)(Object.keys(B.mac).sort().join(","),k+"KEY_IDS"))throw(0,m.newKeyMismatchError)();yield this.verifyKeys(this.userId,B.mac,(P,V,x)=>{if(x!==_(q,R)(V.keys[P],k+P))throw(0,m.newKeyMismatchError)()})})}}e.SAS=j}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../../@types/event":306,"../../logger":374,"./Base":349,"./Error":350,"./SASDecimal":354,"another-json":1}],354:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.generateDecimalSas=void 0;function u(g){return[(g[0]<<5|g[1]>>3)+1e3,((g[1]&7)<<10|g[2]<<2|g[3]>>6)+1e3,((g[3]&63)<<7|g[4]>>1)+1e3]}e.generateDecimalSas=u},{}],355:[function(t,E,e){var u=this&&this.__awaiter||function(a,n,i,r){function s(o){return o instanceof i?o:new i(function(l){l(o)})}return new(i||(i=Promise))(function(o,l){function v(_){try{p(r.next(_))}catch(T){l(T)}}function f(_){try{p(r.throw(_))}catch(T){l(T)}}function p(_){_.done?o(_.value):s(_.value).then(v,f)}p((r=r.apply(a,n||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.InRoomRequests=e.InRoomChannel=void 0;const g=t("./VerificationRequest"),S=t("../../../logger"),c=t("../../../@types/event").EventType.RoomMessage,m="m.reference",h="m.relates_to";class d{constructor(n,i,r){this.client=n,this.roomId=i,this.userId=r}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(n,i){if(d.getEventType(n)!==g.REQUEST_TYPE)return;const s=i.getUserId(),o=n.getSender(),v=n.getContent().to;if(o===s)return v;if(v===s)return o}getTimestamp(n){return n.getTs()}static canCreateRequest(n){return n===g.REQUEST_TYPE}canCreateRequest(n){return d.canCreateRequest(n)}static getTransactionId(n){if(d.getEventType(n)===g.REQUEST_TYPE)return n.getId();{const i=n.getRelation();if((i==null?void 0:i.rel_type)===m)return i.event_id}}static validateEvent(n,i){const r=d.getTransactionId(n);if(typeof r!="string"||r.length===0)return!1;const s=d.getEventType(n),o=n.getContent();if(s===g.REQUEST_TYPE){if(!o||typeof o.to!="string"||!o.to.length)return S.logger.log("InRoomChannel: validateEvent: no valid to "+(o&&o.to)),!1;if(!d.getOtherPartyUserId(n,i))return S.logger.log(`InRoomChannel: validateEvent: not directed to or sent by me: ${n.getSender()}, ${o&&o.to}`),!1}return g.VerificationRequest.validateEvent(s,n,i)}static getEventType(n){const i=n.getType();if(i===c){const r=n.getContent();if(r){const{msgtype:s}=r;if(s===g.REQUEST_TYPE)return g.REQUEST_TYPE}}return i&&i!==g.REQUEST_TYPE?i:""}handleEvent(n,i,r=!1){return u(this,void 0,void 0,function*(){if(i.hasEventId(n.getId()))return;const s=d.getEventType(n);if(n.getRoomId()!==this.roomId)return;if(!this.userId){const p=d.getOtherPartyUserId(n,this.client);p&&(this.userId=p)}const o=this.client.getUserId(),l=n.getSender();if(this.userId&&l!==o&&l!==this.userId){S.logger.log(`InRoomChannel: ignoring verification event from non-participating sender ${l}`);return}this.requestEventId||(this.requestEventId=d.getTransactionId(n));const v=!!n.getUnsigned().transaction_id,f=n.getSender()===this.client.getUserId();return i.handleEvent(s,n,r,v,f)})}completedContentFromEvent(n){const i=Object.assign({},n.getContent());return i[h]=n.getRelation(),i}completeContent(n,i){return i=Object.assign({},i),(n===g.REQUEST_TYPE||n===g.READY_TYPE||n===g.START_TYPE)&&(i.from_device=this.client.getDeviceId()),n===g.REQUEST_TYPE?i={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:g.REQUEST_TYPE,to:this.userId,from_device:i.from_device,methods:i.methods}:i[h]={rel_type:m,event_id:this.transactionId},i}send(n,i){const r=this.completeContent(n,i);return this.sendCompleted(n,r)}sendCompleted(n,i){return u(this,void 0,void 0,function*(){let r=n;n===g.REQUEST_TYPE&&(r=c);const s=yield this.client.sendEvent(this.roomId,r,i);n===g.REQUEST_TYPE&&(this.requestEventId=s.event_id)})}}e.InRoomChannel=d;class b{constructor(){this.requestsByRoomId=new Map}getRequest(n){const i=n.getRoomId(),r=d.getTransactionId(n);return this.getRequestByTxnId(i,r)}getRequestByChannel(n){return this.getRequestByTxnId(n.roomId,n.transactionId)}getRequestByTxnId(n,i){const r=this.requestsByRoomId.get(n);if(r)return r.get(i)}setRequest(n,i){this.doSetRequest(n.getRoomId(),d.getTransactionId(n),i)}setRequestByChannel(n,i){this.doSetRequest(n.roomId,n.transactionId,i)}doSetRequest(n,i,r){let s=this.requestsByRoomId.get(n);s||(s=new Map,this.requestsByRoomId.set(n,s)),s.set(i,r)}removeRequest(n){const i=n.getRoomId(),r=this.requestsByRoomId.get(i);r&&(r.delete(d.getTransactionId(n)),r.size===0&&this.requestsByRoomId.delete(i))}findRequestInProgress(n){const i=this.requestsByRoomId.get(n);if(i){for(const r of i.values())if(r.pending)return r}}}e.InRoomRequests=b},{"../../../@types/event":306,"../../../logger":374,"./VerificationRequest":357}],356:[function(t,E,e){var u=this&&this.__awaiter||function(b,a,n,i){function r(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function l(p){try{f(i.next(p))}catch(_){o(_)}}function v(p){try{f(i.throw(p))}catch(_){o(_)}}function f(p){p.done?s(p.value):r(p.value).then(l,v)}f((i=i.apply(b,a||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.ToDeviceRequests=e.ToDeviceChannel=void 0;const g=t("../../../randomstring"),S=t("../../../logger"),y=t("./VerificationRequest"),c=t("../Error"),m=t("../../../models/event");class h{constructor(a,n,i,r,s){this.client=a,this.userId=n,this.devices=i,this.transactionId=r,this.deviceId=s}isToDevices(a){if(a.length===this.devices.length){for(const n of a)if(!this.devices.includes(n))return!1;return!0}else return!1}static getEventType(a){return a.getType()}static getTransactionId(a){const n=a.getContent();return n&&n.transaction_id}static canCreateRequest(a){return a===y.REQUEST_TYPE||a===y.START_TYPE}canCreateRequest(a){return h.canCreateRequest(a)}static validateEvent(a,n){if(a.isCancelled())return S.logger.warn("Ignoring flagged verification request from "+a.getSender()),!1;const i=a.getContent();if(!i)return S.logger.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!i.transaction_id)return S.logger.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const r=a.getType();if(r===y.REQUEST_TYPE){if(!Number.isFinite(i.timestamp))return S.logger.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(a.getSender()===n.getUserId()&&i.from_device==n.getDeviceId())return S.logger.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return y.VerificationRequest.validateEvent(r,a,n)}getTimestamp(a){const n=a.getContent();return n&&n.timestamp}handleEvent(a,n,i=!1){return u(this,void 0,void 0,function*(){const r=a.getType(),s=a.getContent();if(r===y.REQUEST_TYPE||r===y.READY_TYPE||r===y.START_TYPE){this.transactionId||(this.transactionId=s.transaction_id);const f=s.from_device;if(!this.deviceId&&this.devices.includes(f)&&(this.deviceId=f),!this.deviceId||this.deviceId!==f){const p=this.completeContent(y.CANCEL_TYPE,(0,c.errorFromEvent)((0,c.newUnexpectedMessageError)()));return this.sendToDevices(y.CANCEL_TYPE,p,[f])}}const o=n.phase===y.PHASE_STARTED||n.phase===y.PHASE_READY;yield n.handleEvent(a.getType(),a,i,!1,!1);const l=n.phase===y.PHASE_STARTED||n.phase===y.PHASE_READY;if((r===y.START_TYPE||r===y.READY_TYPE)&&!o&&l&&this.deviceId){const f=this.devices.filter(p=>p!==this.deviceId&&p!==this.client.getDeviceId());if(f.length){const p=this.completeContent(y.CANCEL_TYPE,{code:"m.accepted",reason:"Verification request accepted by another device"});yield this.sendToDevices(y.CANCEL_TYPE,p,f)}}})}completedContentFromEvent(a){return a.getContent()}completeContent(a,n){return n=Object.assign({},n),this.transactionId&&(n.transaction_id=this.transactionId),(a===y.REQUEST_TYPE||a===y.READY_TYPE||a===y.START_TYPE)&&(n.from_device=this.client.getDeviceId()),a===y.REQUEST_TYPE&&(n.timestamp=Date.now()),n}send(a,n={}){(a===y.REQUEST_TYPE||a===y.START_TYPE)&&!this.transactionId&&(this.transactionId=h.makeTransactionId());const i=this.completeContent(a,n);return this.sendCompleted(a,i)}sendCompleted(a,n){return u(this,void 0,void 0,function*(){let i;a===y.REQUEST_TYPE||a===y.CANCEL_TYPE&&!this.deviceId?i=yield this.sendToDevices(a,n,this.devices):i=yield this.sendToDevices(a,n,[this.deviceId]);const r=new m.MatrixEvent({sender:this.client.getUserId(),content:n,type:a});return yield this.request.handleEvent(a,r,!0,!0,!0),i})}sendToDevices(a,n,i){return u(this,void 0,void 0,function*(){if(i.length){const r=new Map;for(const s of i)r.set(s,n);yield this.client.sendToDevice(a,new Map([[this.userId,r]]))}})}static makeTransactionId(){return(0,g.randomString)(32)}}e.ToDeviceChannel=h;class d{constructor(){this.requestsByUserId=new Map}getRequest(a){return this.getRequestBySenderAndTxnId(a.getSender(),h.getTransactionId(a))}getRequestByChannel(a){return this.getRequestBySenderAndTxnId(a.userId,a.transactionId)}getRequestBySenderAndTxnId(a,n){const i=this.requestsByUserId.get(a);if(i)return i.get(n)}setRequest(a,n){this.setRequestBySenderAndTxnId(a.getSender(),h.getTransactionId(a),n)}setRequestByChannel(a,n){this.setRequestBySenderAndTxnId(a.userId,a.transactionId,n)}setRequestBySenderAndTxnId(a,n,i){let r=this.requestsByUserId.get(a);r||(r=new Map,this.requestsByUserId.set(a,r)),r.set(n,i)}removeRequest(a){const n=a.getSender(),i=this.requestsByUserId.get(n);i&&(i.delete(h.getTransactionId(a)),i.size===0&&this.requestsByUserId.delete(n))}findRequestInProgress(a,n){const i=this.requestsByUserId.get(a);if(i){for(const r of i.values())if(r.pending&&r.channel.isToDevices(n))return r}}getRequestsInProgress(a){const n=this.requestsByUserId.get(a);return n?Array.from(n.values()).filter(i=>i.pending):[]}}e.ToDeviceRequests=d},{"../../../logger":374,"../../../models/event":383,"../../../randomstring":398,"../Error":350,"./VerificationRequest":357}],357:[function(t,E,e){var u=this&&this.__awaiter||function(r,s,o,l){function v(f){return f instanceof o?f:new o(function(p){p(f)})}return new(o||(o=Promise))(function(f,p){function _(M){try{w(l.next(M))}catch(A){p(A)}}function T(M){try{w(l.throw(M))}catch(A){p(A)}}function w(M){M.done?f(M.value):v(M.value).then(_,T)}w((l=l.apply(r,s||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.VerificationRequest=e.VerificationRequestEvent=e.PHASE_DONE=e.PHASE_CANCELLED=e.PHASE_STARTED=e.PHASE_READY=e.PHASE_REQUESTED=e.PHASE_UNSENT=e.Phase=e.READY_TYPE=e.DONE_TYPE=e.CANCEL_TYPE=e.START_TYPE=e.REQUEST_TYPE=e.EVENT_PREFIX=void 0;const g=t("../../../logger"),S=t("../Error"),y=t("../QRCode"),c=t("../../../@types/event"),m=t("../../../models/typed-event-emitter"),h=10*60*1e3,d=2*60*1e3,b=3*1e3;e.EVENT_PREFIX="m.key.verification.",e.REQUEST_TYPE=e.EVENT_PREFIX+"request",e.START_TYPE=e.EVENT_PREFIX+"start",e.CANCEL_TYPE=e.EVENT_PREFIX+"cancel",e.DONE_TYPE=e.EVENT_PREFIX+"done",e.READY_TYPE=e.EVENT_PREFIX+"ready";var a;(function(r){r[r.Unsent=1]="Unsent",r[r.Requested=2]="Requested",r[r.Ready=3]="Ready",r[r.Started=4]="Started",r[r.Cancelled=5]="Cancelled",r[r.Done=6]="Done"})(a=e.Phase||(e.Phase={})),e.PHASE_UNSENT=a.Unsent,e.PHASE_REQUESTED=a.Requested,e.PHASE_READY=a.Ready,e.PHASE_STARTED=a.Started,e.PHASE_CANCELLED=a.Cancelled,e.PHASE_DONE=a.Done;var n;(function(r){r.Change="change"})(n=e.VerificationRequestEvent||(e.VerificationRequestEvent={}));class i extends m.TypedEventEmitter{constructor(s,o,l){super(),this.channel=s,this.verificationMethods=o,this.client=l,this.eventsByUs=new Map,this.eventsByThem=new Map,this._observeOnly=!1,this.timeoutTimer=null,this._accepting=!1,this._declining=!1,this.verifierHasFinished=!1,this._cancelled=!1,this._chosenMethod=null,this._qrCodeData=null,this.requestReceivedAt=null,this.commonMethods=[],this.cancelOnTimeout=()=>u(this,void 0,void 0,function*(){try{this.initiatedByMe?yield this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):yield this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(v){g.logger.error("Error while cancelling verification request",v)}}),this.channel.request=this,this.setPhase(e.PHASE_UNSENT,!1)}static validateEvent(s,o,l){const v=o.getContent();return!s||!s.startsWith(e.EVENT_PREFIX)?!1:v?(s===e.REQUEST_TYPE||s===e.READY_TYPE)&&!Array.isArray(v.methods)?(g.logger.log("VerificationRequest: validateEvent: fail because methods"),!1):(s===e.REQUEST_TYPE||s===e.READY_TYPE||s===e.START_TYPE)&&(typeof v.from_device!="string"||v.from_device.length===0)?(g.logger.log("VerificationRequest: validateEvent: fail because from_device"),!1):!0:(g.logger.log("VerificationRequest: validateEvent: no content"),!1)}get invalid(){return this.phase===e.PHASE_UNSENT}get requested(){return this.phase===e.PHASE_REQUESTED}get cancelled(){return this.phase===e.PHASE_CANCELLED}get ready(){return this.phase===e.PHASE_READY}get started(){return this.phase===e.PHASE_STARTED}get done(){return this.phase===e.PHASE_DONE}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(s){let o=this.channel.getTimestamp(s)+h;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=e.PHASE_REQUESTED){const l=this.requestReceivedAt+d;o=Math.min(o,l)}return Math.max(0,o-Date.now())}get timeout(){const s=this.getEventByEither(e.REQUEST_TYPE);return s?this.calculateEventTimeout(s):0}get requestEvent(){return this.getEventByEither(e.REQUEST_TYPE)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<e.PHASE_READY&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==e.PHASE_DONE&&this._phase!==e.PHASE_CANCELLED}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(s,o=!1){if(!o&&!this.ready&&!this.started)return!1;const l=this.eventsByThem.get(e.REQUEST_TYPE)||this.eventsByThem.get(e.READY_TYPE);if(!l){if(this.started&&this.initiatedByMe){const p=this.eventsByUs.get(e.START_TYPE),_=p&&p.getContent(),T=_&&_.method;return s==T}return!1}const v=l.getContent();if(!v)return!1;const{methods:f}=v;return Array.isArray(f)?f.includes(s):!1}get initiatedByMe(){const s=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===e.PHASE_UNSENT&&s)return!0;const o=this.eventsByUs.has(e.REQUEST_TYPE),l=this.eventsByThem.has(e.REQUEST_TYPE);if(o&&!l)return!0;if(!o&&l)return!1;const v=this.eventsByUs.has(e.START_TYPE),f=this.eventsByThem.has(e.START_TYPE);return!!(v&&!f)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){const s=this.eventsByUs.get(e.CANCEL_TYPE),o=this.eventsByThem.get(e.CANCEL_TYPE);if(s&&(!o||s.getId()<o.getId()))return s.getSender();if(o)return o.getSender()}get cancellationCode(){const s=this.getEventByEither(e.CANCEL_TYPE);return s?s.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const s=this.eventsByThem.get(e.REQUEST_TYPE)||this.eventsByThem.get(e.READY_TYPE)||this.eventsByThem.get(e.START_TYPE),o=s==null?void 0:s.getContent(),l=o==null?void 0:o.from_device;return{userId:this.otherUserId,deviceId:l}}beginKeyVerification(s,o=null){if(!this.observeOnly&&!this._verifier&&(this.phase===e.PHASE_REQUESTED||this.phase===e.PHASE_READY||this.phase===e.PHASE_UNSENT&&this.channel.canCreateRequest(e.START_TYPE))){if(this.commonMethods.length&&!this.commonMethods.includes(s)||(this._verifier=this.createVerifier(s,null,o),!this._verifier))throw(0,S.newUnknownMethodError)();this._chosenMethod=s}return this._verifier}sendRequest(){return u(this,void 0,void 0,function*(){if(!this.observeOnly&&this._phase===e.PHASE_UNSENT){const s=[...this.verificationMethods.keys()];yield this.channel.send(e.REQUEST_TYPE,{methods:s})}})}cancel({reason:s="User declined",code:o="m.user"}={}){return u(this,void 0,void 0,function*(){if(!this.observeOnly&&this._phase!==e.PHASE_CANCELLED){if(this._declining=!0,this.emit(n.Change),this._verifier)return this._verifier.cancel((0,S.errorFactory)(o,s)());this._cancellingUserId=this.client.getUserId(),yield this.channel.send(e.CANCEL_TYPE,{code:o,reason:s})}})}accept(){return u(this,void 0,void 0,function*(){if(!this.observeOnly&&this.phase===e.PHASE_REQUESTED&&!this.initiatedByMe){const s=[...this.verificationMethods.keys()];this._accepting=!0,this.emit(n.Change),yield this.channel.send(e.READY_TYPE,{methods:s})}})}waitFor(s){return new Promise((o,l)=>{const v=()=>{let f=!1;return s(this)?(o(this),f=!0):this.cancelled&&(l(new Error("cancelled")),f=!0),f&&this.off(n.Change,v),f};v()||this.on(n.Change,v)})}setPhase(s,o=!0){this._phase=s,o&&this.emit(n.Change)}getEventByEither(s){return this.eventsByThem.get(s)||this.eventsByUs.get(s)}getEventBy(s,o=!1){return o?this.eventsByThem.get(s):this.eventsByUs.get(s)}calculatePhaseTransitions(){const s=[{phase:e.PHASE_UNSENT}],o=()=>s[s.length-1].phase,l=this.eventsByThem.has(e.REQUEST_TYPE),v=this.getEventBy(e.REQUEST_TYPE,l);v&&s.push({phase:e.PHASE_REQUESTED,event:v});const f=v&&this.getEventBy(e.READY_TYPE,!l);f&&o()===e.PHASE_REQUESTED&&s.push({phase:e.PHASE_READY,event:f});let p;if(f||!v){const w=this.eventsByThem.get(e.START_TYPE),M=this.eventsByUs.get(e.START_TYPE);w&&M?p=w.getSender()<M.getSender()?w:M:p=w||M}else p=this.getEventBy(e.START_TYPE,!l);if(p){const w=o()===e.PHASE_REQUESTED&&(v==null?void 0:v.getSender())!==p.getSender(),M=o()===e.PHASE_UNSENT&&this.channel.canCreateRequest(e.START_TYPE);(w||o()===e.PHASE_READY||M)&&s.push({phase:e.PHASE_STARTED,event:p})}const _=this.eventsByUs.get(e.DONE_TYPE);(this.verifierHasFinished||_&&o()===e.PHASE_STARTED)&&s.push({phase:e.PHASE_DONE});const T=this.getEventByEither(e.CANCEL_TYPE);return(this._cancelled||T)&&o()!==e.PHASE_DONE&&s.push({phase:e.PHASE_CANCELLED,event:T}),s}transitionToPhase(s){const{phase:o,event:l}=s;if((o===e.PHASE_REQUESTED||o===e.PHASE_READY)&&!this.wasSentByOwnDevice(l)){const v=l.getContent();this.commonMethods=v.methods.filter(f=>this.verificationMethods.has(f))}if(this.observeOnly||(o===e.PHASE_REQUESTED||o===e.PHASE_STARTED||o===e.PHASE_READY)&&this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(l)&&!this.wasSentByOwnDevice(l)&&(this._observeOnly=!0),o===e.PHASE_STARTED){const{method:v}=l.getContent();!this._verifier&&!this.observeOnly&&(this._verifier=this.createVerifier(v,l),this._verifier?this._chosenMethod=v:this.cancel({code:"m.unknown_method",reason:`Unknown method: ${v}`}))}}applyPhaseTransitions(){const s=this.calculatePhaseTransitions(),o=s.findIndex(v=>v.phase===this.phase),l=s.slice(o+1);for(const v of l)this.transitionToPhase(v);return l}isWinningStartRace(s){if(s.getType()!==e.START_TYPE)return!1;const o=this._verifier.startEvent;let l;if(this.isSelfVerification)if(o){const f=o.getContent();l=f&&f.from_device}else l=this.client.getDeviceId();else o?l=o.getSender():l=this.client.getUserId();let v;if(this.isSelfVerification){const f=s.getContent();v=f&&f.from_device}else v=s.getSender();return v<l}hasEventId(s){for(const o of this.eventsByUs.values())if(o.getId()===s)return!0;for(const o of this.eventsByThem.values())if(o.getId()===s)return!0;return!1}handleEvent(s,o,l,v,f){var p;return u(this,void 0,void 0,function*(){if(this.done||this.cancelled)return;const _=this._observeOnly;if(this.adjustObserveOnly(o,l),!this.observeOnly&&!v&&(yield this.cancelOnError(s,o))||(f?this.eventsByUs.has(s):this.eventsByThem.has(s)))return;const w=this.phase;this.addEvent(s,o,f);const M=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const A=this.isWinningStartRace(o);this._verifier.canSwitchStartEvent(o)&&A?this._verifier.switchStartEvent(o):v||(s===e.CANCEL_TYPE||!((p=this._verifier.events)===null||p===void 0)&&p.includes(s))&&this._verifier.handleEvent(o)}if(M.length){l&&M.some(ee=>ee.phase===e.PHASE_READY)&&this.otherPartySupportsMethod(y.SCAN_QR_CODE_METHOD,!0)&&(this._qrCodeData=yield y.QRCodeData.create(this,this.client));const A=M[M.length-1],{phase:W}=A;this.setupTimeout(W),this.setPhase(W)}else this._observeOnly!==_&&this.emit(n.Change)}finally{g.logger.log(`Verification request ${this.channel.transactionId}: ${s} event with id:${o.getId()}, content:${JSON.stringify(o.getContent())} deviceId:${this.channel.deviceId}, sender:${o.getSender()}, isSentByUs:${f}, isLiveEvent:${l}, isRemoteEcho:${v}, phase:${w}=>${this.phase}, observeOnly:${_}=>${this._observeOnly}`)}})}setupTimeout(s){!this.timeoutTimer&&!this.observeOnly&&s===e.PHASE_REQUESTED&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer&&(s===e.PHASE_STARTED||s===e.PHASE_READY||s===e.PHASE_DONE||s===e.PHASE_CANCELLED)&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}cancelOnError(s,o){return u(this,void 0,void 0,function*(){if(s===e.START_TYPE){const f=o.getContent().method;if(!this.verificationMethods.has(f))return yield this.cancel((0,S.errorFromEvent)((0,S.newUnknownMethodError)())),!0}const l=s===e.REQUEST_TYPE&&this.phase!==e.PHASE_UNSENT,v=s===e.READY_TYPE&&this.phase!==e.PHASE_REQUESTED&&this.phase!==e.PHASE_STARTED;if(this.phase!==e.PHASE_UNSENT&&(l||v)){g.logger.warn(`Cancelling, unexpected ${s} verification event from ${o.getSender()}`);const f=`Unexpected ${s} event in phase ${this.phase}`;return yield this.cancel((0,S.errorFromEvent)((0,S.newUnexpectedMessageError)({reason:f}))),!0}return!1})}adjustObserveOnly(s,o=!1){o||(this._observeOnly=!0),this.calculateEventTimeout(s)<b&&(this._observeOnly=!0)}addEvent(s,o,l=!1){if(l?this.eventsByUs.set(s,o):this.eventsByThem.set(s,o),s===e.REQUEST_TYPE){for(const[v,f]of this.eventsByThem.entries())f.getSender()!==this.otherUserId&&this.eventsByThem.delete(v);this.requestReceivedAt=Date.now()}}createVerifier(s,o=null,l=null){l||(l=this.targetDevice);const{userId:v,deviceId:f}=l,p=this.verificationMethods.get(s);if(!p){g.logger.warn("could not find verifier constructor for method",s);return}return new p(this.channel,this.client,v,f,o,this)}wasSentByOwnUser(s){return(s==null?void 0:s.getSender())===this.client.getUserId()}wasSentByOwnDevice(s){if(!this.wasSentByOwnUser(s))return!1;const o=s.getContent();return!(!o||o.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const s=this.applyPhaseTransitions();s.length&&this.setPhase(s[s.length-1].phase)}onVerifierFinished(){this.channel.send(c.EventType.KeyVerificationDone,{}),this.verifierHasFinished=!0;const s=this.applyPhaseTransitions();s.length&&this.setPhase(s[s.length-1].phase)}getEventFromOtherParty(s){return this.eventsByThem.get(s)}}e.VerificationRequest=i},{"../../../@types/event":306,"../../../logger":374,"../../../models/typed-event-emitter":395,"../Error":350,"../QRCode":352}],358:[function(t,E,e){var u=this&&this.__awaiter||function(s,o,l,v){function f(p){return p instanceof l?p:new l(function(_){_(p)})}return new(l||(l=Promise))(function(p,_){function T(A){try{M(v.next(A))}catch(W){_(W)}}function w(A){try{M(v.throw(A))}catch(W){_(W)}}function M(A){A.done?p(A.value):f(A.value).then(T,w)}M((v=v.apply(s,o||[])).next())})},g=this&&this.__asyncValues||function(s){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o=s[Symbol.asyncIterator],l;return o?o.call(s):(s=typeof __values=="function"?__values(s):s[Symbol.iterator](),l={},v("next"),v("throw"),v("return"),l[Symbol.asyncIterator]=function(){return this},l);function v(p){l[p]=s[p]&&function(_){return new Promise(function(T,w){_=s[p](_),f(T,w,_.done,_.value)})}}function f(p,_,T,w){Promise.resolve(w).then(function(M){p({value:M,done:T})},_)}};Object.defineProperty(e,"__esModule",{value:!0}),e.RoomWidgetClient=void 0;const S=t("matrix-widget-api"),y=t("./models/event"),c=t("./@types/event"),m=t("./logger"),h=t("./client"),d=t("./sync"),b=t("./sliding-sync-sdk"),a=t("./models/event"),n=t("./models/user"),i=t("./utils");class r extends h.MatrixClient{constructor(o,l,v,f){var p,_,T,w,M,A,W,ee,F,C;super(f),this.widgetApi=o,this.capabilities=l,this.roomId=v,this.widgetApiReady=new Promise(O=>this.widgetApi.once("ready",O)),this.syncState=null,this.onEvent=O=>u(this,void 0,void 0,function*(){if(O.preventDefault(),O.detail.data.room_id===this.roomId){const I=new a.MatrixEvent(O.detail.data);yield this.syncApi.injectRoomEvents(this.room,[],[I]),this.emit(h.ClientEvent.Event,I),this.setSyncState(d.SyncState.Syncing),m.logger.info(`Received event ${I.getId()} ${I.getType()} ${I.getStateKey()}`)}else{const{event_id:I,room_id:D}=O.detail.data;m.logger.info(`Received event ${I} for a different room ${D}; discarding`)}yield this.ack(O)}),this.onToDevice=O=>u(this,void 0,void 0,function*(){O.preventDefault();const I=new a.MatrixEvent({type:O.detail.data.type,sender:O.detail.data.sender,content:O.detail.data.content});O.detail.data.encrypted&&I.makeEncrypted(c.EventType.RoomMessageEncrypted,{},"",""),this.emit(h.ClientEvent.ToDeviceEvent,I),this.setSyncState(d.SyncState.Syncing),yield this.ack(O)}),(!((p=l.sendEvent)===null||p===void 0)&&p.length||!((_=l.receiveEvent)===null||_===void 0)&&_.length||l.sendMessage===!0||Array.isArray(l.sendMessage)&&l.sendMessage.length||l.receiveMessage===!0||Array.isArray(l.receiveMessage)&&l.receiveMessage.length||!((T=l.sendState)===null||T===void 0)&&T.length||!((w=l.receiveState)===null||w===void 0)&&w.length)&&o.requestCapabilityForRoomTimeline(v),(M=l.sendEvent)===null||M===void 0||M.forEach(O=>o.requestCapabilityToSendEvent(O)),(A=l.receiveEvent)===null||A===void 0||A.forEach(O=>o.requestCapabilityToReceiveEvent(O)),l.sendMessage===!0?o.requestCapabilityToSendMessage():Array.isArray(l.sendMessage)&&l.sendMessage.forEach(O=>o.requestCapabilityToSendMessage(O)),l.receiveMessage===!0?o.requestCapabilityToReceiveMessage():Array.isArray(l.receiveMessage)&&l.receiveMessage.forEach(O=>o.requestCapabilityToReceiveMessage(O)),(W=l.sendState)===null||W===void 0||W.forEach(({eventType:O,stateKey:I})=>o.requestCapabilityToSendState(O,I)),(ee=l.receiveState)===null||ee===void 0||ee.forEach(({eventType:O,stateKey:I})=>o.requestCapabilityToReceiveState(O,I)),(F=l.sendToDevice)===null||F===void 0||F.forEach(O=>o.requestCapabilityToSendToDevice(O)),(C=l.receiveToDevice)===null||C===void 0||C.forEach(O=>o.requestCapabilityToReceiveToDevice(O)),l.turnServers&&o.requestCapability(S.MatrixCapabilities.MSC3846TurnServers),o.on(`action:${S.WidgetApiToWidgetAction.SendEvent}`,this.onEvent),o.on(`action:${S.WidgetApiToWidgetAction.SendToDevice}`,this.onToDevice),o.start()}startClient(o={}){var l,v;return u(this,void 0,void 0,function*(){this.lifecycle=new AbortController;const f=this.getUserId();f&&this.store.storeUser(new n.User(f)),o.slidingSync?this.syncApi=new b.SlidingSyncSdk(o.slidingSync,this,o,this.buildSyncApiOptions()):this.syncApi=new d.SyncApi(this,o,this.buildSyncApiOptions()),this.room=this.syncApi.createRoom(this.roomId),this.store.storeRoom(this.room),yield this.widgetApiReady,yield Promise.all((v=(l=this.capabilities.receiveState)===null||l===void 0?void 0:l.map(({eventType:p,stateKey:_})=>u(this,void 0,void 0,function*(){const w=(yield this.widgetApi.readStateEvents(p,void 0,_,[this.roomId])).map(M=>new a.MatrixEvent(M));yield this.syncApi.injectRoomEvents(this.room,[],w),w.forEach(M=>{this.emit(h.ClientEvent.Event,M),m.logger.info(`Backfilled event ${M.getId()} ${M.getType()} ${M.getStateKey()}`)})})))!==null&&v!==void 0?v:[]),this.setSyncState(d.SyncState.Syncing),m.logger.info("Finished backfilling events"),this.capabilities.turnServers&&this.watchTurnServers()})}stopClient(){this.widgetApi.off(`action:${S.WidgetApiToWidgetAction.SendEvent}`,this.onEvent),this.widgetApi.off(`action:${S.WidgetApiToWidgetAction.SendToDevice}`,this.onToDevice),super.stopClient(),this.lifecycle.abort()}joinRoom(o){return u(this,void 0,void 0,function*(){if(o===this.roomId)return this.room;throw new Error(`Unknown room: ${o}`)})}encryptAndSendEvent(o,l){return u(this,void 0,void 0,function*(){let v;try{v=yield this.widgetApi.sendRoomEvent(l.getType(),l.getContent(),o.roomId)}catch(f){throw this.updatePendingEventStatus(o,l,y.EventStatus.NOT_SENT),f}return o.updatePendingEvent(l,y.EventStatus.SENT,v.event_id),{event_id:v.event_id}})}sendStateEvent(o,l,v,f=""){return u(this,void 0,void 0,function*(){return yield this.widgetApi.sendStateEvent(l,f,v,o)})}sendToDevice(o,l){return u(this,void 0,void 0,function*(){return yield this.widgetApi.sendToDevice(o,!1,(0,i.recursiveMapToObject)(l)),{}})}queueToDevice({eventType:o,batch:l}){return u(this,void 0,void 0,function*(){const v=new i.MapWithDefault(()=>new Map);for(const{userId:f,deviceId:p,payload:_}of l)v.getOrCreate(f).set(p,_);yield this.widgetApi.sendToDevice(o,!1,(0,i.recursiveMapToObject)(v))})}encryptAndSendToDevices(o,l){return u(this,void 0,void 0,function*(){const v=new i.MapWithDefault(()=>new Map);for(const{userId:f,deviceInfo:{deviceId:p}}of o)v.getOrCreate(f).set(p,l);yield this.widgetApi.sendToDevice(l.type,!0,(0,i.recursiveMapToObject)(v))})}checkTurnServers(){return u(this,void 0,void 0,function*(){return this.turnServers.length>0})}getSyncState(){return this.syncState}setSyncState(o){const l=this.syncState;this.syncState=o,this.emit(h.ClientEvent.Sync,o,l)}ack(o){return u(this,void 0,void 0,function*(){yield this.widgetApi.transport.reply(o.detail,{})})}watchTurnServers(){var o,l,v,f;return u(this,void 0,void 0,function*(){const p=this.widgetApi.getTurnServers(),_=()=>{p.return(void 0)};this.lifecycle.signal.addEventListener("abort",_);try{try{for(var T=!0,w=g(p),M;M=yield w.next(),o=M.done,!o;){f=M.value,T=!1;try{const A=f;this.turnServers=[{urls:A.uris,username:A.username,credential:A.password}],this.emit(h.ClientEvent.TurnServers,this.turnServers),m.logger.log(`Received TURN server: ${A.uris}`)}finally{T=!0}}}catch(A){l={error:A}}finally{try{!T&&!o&&(v=w.return)&&(yield v.call(w))}finally{if(l)throw l.error}}}catch(A){m.logger.warn("Error watching TURN servers",A)}finally{this.lifecycle.signal.removeEventListener("abort",_)}})}}e.RoomWidgetClient=r},{"./@types/event":306,"./client":321,"./logger":374,"./models/event":383,"./models/user":396,"./sliding-sync-sdk":406,"./sync":414,"./utils":416,"matrix-widget-api":178}],359:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.KeySignatureUploadError=e.InvalidCryptoStoreError=e.InvalidCryptoStoreState=e.InvalidStoreError=e.InvalidStoreState=void 0;var u;(function(m){m[m.ToggledLazyLoading=0]="ToggledLazyLoading"})(u=e.InvalidStoreState||(e.InvalidStoreState={}));class g extends Error{constructor(h,d){const b=`Store is invalid because ${h}, please stop the client, delete all data and start the client again`;super(b),this.reason=h,this.value=d,this.name="InvalidStoreError"}}e.InvalidStoreError=g,g.TOGGLED_LAZY_LOADING=u.ToggledLazyLoading;var S;(function(m){m.TooNew="TOO_NEW"})(S=e.InvalidCryptoStoreState||(e.InvalidCryptoStoreState={}));class y extends Error{constructor(h){const d=`Crypto store is invalid because ${h}, please stop the client, delete all data and start the client again`;super(d),this.reason=h,this.name="InvalidCryptoStoreError"}}e.InvalidCryptoStoreError=y,y.TOO_NEW=S.TooNew;class c extends Error{constructor(h,d){super(h),this.value=d}}e.KeySignatureUploadError=c},{}],360:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.eventMapperFor=void 0;const u=t("./models/event"),g=t("./@types/event");function S(y,c){let m=!!c.preventReEmit;const h=c.decrypt!==!1;function d(b){c.toDevice&&delete b.room_id;const a=y.getRoom(b.room_id);let n;a&&b.state_key===void 0&&(n=a.findEventById(b.event_id)),!n||n.status?n=new u.MatrixEvent(b):(n.setUnsigned(Object.assign(Object.assign({},n.getUnsigned()),b.unsigned)),m=!0);const i=n.getServerAggregatedRelation(g.RelationType.Replace);if(i!=null&&i.content){const s=d(i);n.makeReplaced(s)}const r=a==null?void 0:a.findThreadForEvent(n);return r&&n.setThread(r),n.isEncrypted()&&(m||y.reEmitter.reEmit(n,[u.MatrixEventEvent.Decrypted]),h&&y.decryptEventIfNeeded(n)),m||(y.reEmitter.reEmit(n,[u.MatrixEventEvent.Replaced,u.MatrixEventEvent.VisibilityChange]),a==null||a.reEmitter.reEmit(n,[u.MatrixEventEvent.BeforeRedaction])),n}return d}e.eventMapperFor=S},{"./@types/event":306,"./models/event":383}],361:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isOptionalAString=e.isProvided=void 0;function u(S){return S!=null}e.isProvided=u;function g(S){return u(S)&&typeof S=="string"}e.isOptionalAString=g},{}],362:[function(t,E,e){var u=this&&this.__awaiter||function(m,h,d,b){function a(n){return n instanceof d?n:new d(function(i){i(n)})}return new(d||(d=Promise))(function(n,i){function r(l){try{o(b.next(l))}catch(v){i(v)}}function s(l){try{o(b.throw(l))}catch(v){i(v)}}function o(l){l.done?n(l.value):a(l.value).then(r,s)}o((b=b.apply(m,h||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.buildFeatureSupportMap=e.Feature=e.ServerSupport=void 0;var g;(function(m){m[m.Stable=0]="Stable",m[m.Unstable=1]="Unstable",m[m.Unsupported=2]="Unsupported"})(g=e.ServerSupport||(e.ServerSupport={}));var S;(function(m){m.Thread="Thread",m.ThreadUnreadNotifications="ThreadUnreadNotifications",m.LoginTokenRequest="LoginTokenRequest",m.RelationBasedRedactions="RelationBasedRedactions",m.AccountDataDeletion="AccountDataDeletion"})(S=e.Feature||(e.Feature={}));const y={[S.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[S.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[S.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[S.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[S.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]}};function c(m){var h,d,b,a;return u(this,void 0,void 0,function*(){const n=new Map;for(const[i,r]of Object.entries(y)){const s=(d=(h=m.versions)===null||h===void 0?void 0:h.includes(r.matrixVersion||""))!==null&&d!==void 0?d:!1,o=(a=(b=r.unstablePrefixes)===null||b===void 0?void 0:b.every(l=>{var v;return((v=m.unstable_features)===null||v===void 0?void 0:v[l])===!0}))!==null&&a!==void 0?a:!1;s?n.set(i,g.Stable):o?n.set(i,g.Unstable):n.set(i,g.Unsupported)}return n})}e.buildFeatureSupportMap=c},{}],363:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.FilterComponent=void 0;const u=t("./models/thread");function g(y,c){if(c.endsWith("*")){const m=c.slice(0,-1);return y.slice(0,m.length)===m}else return y===c}class S{constructor(c,m){this.filterJson=c,this.userId=m}check(c){var m,h;const d=((m=c.getUnsigned())===null||m===void 0?void 0:m["m.relations"])||{},b=Object.keys(d),a=[];return this.userId&&(!((h=d==null?void 0:d[u.THREAD_RELATION_TYPE.name])===null||h===void 0)&&h.current_user_participated)&&a.push(this.userId),this.checkFields(c.getRoomId(),c.getSender(),c.getType(),c.getContent()?c.getContent().url!==void 0:!1,b,a)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[u.FILTER_RELATED_BY_SENDERS.name]:this.filterJson[u.FILTER_RELATED_BY_SENDERS.name]||[],[u.FILTER_RELATED_BY_REL_TYPES.name]:this.filterJson[u.FILTER_RELATED_BY_REL_TYPES.name]||[]}}checkFields(c,m,h,d,b,a){const n={rooms:function(o){return c===o},senders:function(o){return m===o},types:function(o){return g(h,o)}};for(const o in n){const l=n[o],v="not_"+o,f=this.filterJson[v];if(f!=null&&f.some(l))return!1;const p=this.filterJson[o];if(p&&!p.some(l))return!1}const i=this.filterJson.contains_url;if(i!==void 0&&i!==d)return!1;const r=this.filterJson[u.FILTER_RELATED_BY_REL_TYPES.name];if(r!==void 0&&!this.arrayMatchesFilter(r,b))return!1;const s=this.filterJson[u.FILTER_RELATED_BY_SENDERS.name];return!(s!==void 0&&!this.arrayMatchesFilter(s,a))}arrayMatchesFilter(c,m){return m.length>0&&c.every(h=>m.includes(h))}filter(c){return c.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}}e.FilterComponent=S},{"./models/thread":394}],364:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Filter=void 0;const u=t("./@types/sync"),g=t("./filter-component");function S(c,m,h){const d=m.split(".");let b=c;for(let a=0;a<d.length-1;a++)b[d[a]]||(b[d[a]]={}),b=b[d[a]];b[d[d.length-1]]=h}class y{static fromJson(m,h,d){const b=new y(m,h);return b.setDefinition(d),b}constructor(m,h){this.userId=m,this.filterId=h,this.definition={}}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(m){this.definition=m;const h=m.room,d={};h&&(h.rooms&&(d.rooms=h.rooms),h.rooms&&(d.not_rooms=h.not_rooms)),this.roomFilter=new g.FilterComponent(d,this.userId),this.roomTimelineFilter=new g.FilterComponent((h==null?void 0:h.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(m){return this.roomFilter&&(m=this.roomFilter.filter(m)),this.roomTimelineFilter&&(m=this.roomTimelineFilter.filter(m)),m}setTimelineLimit(m){S(this.definition,"room.timeline.limit",m)}setUnreadThreadNotifications(m){var h,d,b;this.definition=Object.assign(Object.assign({},this.definition),{room:Object.assign(Object.assign({},(h=this.definition)===null||h===void 0?void 0:h.room),{timeline:Object.assign(Object.assign({},(b=(d=this.definition)===null||d===void 0?void 0:d.room)===null||b===void 0?void 0:b.timeline),{[u.UNREAD_THREAD_NOTIFICATIONS.name]:m})})})}setLazyLoadMembers(m){S(this.definition,"room.state.lazy_load_members",m)}setIncludeLeaveRooms(m){S(this.definition,"room.include_leave",m)}}e.Filter=y,y.LAZY_LOADING_MESSAGES_FILTER={lazy_load_members:!0}},{"./@types/sync":314,"./filter-component":363}],365:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ConnectionError=e.MatrixError=e.HTTPError=void 0;class u extends Error{constructor(c,m){super(c),this.httpStatus=m}}e.HTTPError=u;class g extends u{constructor(c={},m,h,d){let b=c.error||"Unknown message";m&&(b=`[${m}] ${b}`),h&&(b=`${b} (${h})`),super(`MatrixError: ${b}`,m),this.httpStatus=m,this.url=h,this.event=d,this.errcode=c.errcode,this.name=c.errcode||"Unknown error code",this.data=c}}e.MatrixError=g;class S extends Error{constructor(c,m){super(c+(m?`: ${m.message}`:""))}get name(){return"ConnectionError"}}e.ConnectionError=S},{}],366:[function(t,E,e){(function(u){(function(){var g=this&&this.__createBinding||(Object.create?function(i,r,s,o){o===void 0&&(o=s);var l=Object.getOwnPropertyDescriptor(r,s);(!l||("get"in l?!r.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return r[s]}}),Object.defineProperty(i,o,l)}:function(i,r,s,o){o===void 0&&(o=s),i[o]=r[s]}),S=this&&this.__setModuleDefault||(Object.create?function(i,r){Object.defineProperty(i,"default",{enumerable:!0,value:r})}:function(i,r){i.default=r}),y=this&&this.__importStar||function(i){if(i&&i.__esModule)return i;var r={};if(i!=null)for(var s in i)s!=="default"&&Object.prototype.hasOwnProperty.call(i,s)&&g(r,i,s);return S(r,i),r},c=this&&this.__awaiter||function(i,r,s,o){function l(v){return v instanceof s?v:new s(function(f){f(v)})}return new(s||(s=Promise))(function(v,f){function p(w){try{T(o.next(w))}catch(M){f(M)}}function _(w){try{T(o.throw(w))}catch(M){f(M)}}function T(w){w.done?v(w.value):l(w.value).then(p,_)}T((o=o.apply(i,r||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.FetchHttpApi=void 0;const m=y(t("../utils")),h=t("./method"),d=t("./errors"),b=t("./interface"),a=t("./utils");class n{constructor(r,s){var o;this.eventEmitter=r,this.opts=s,this.abortController=new AbortController,m.checkObjectHasKeys(s,["baseUrl","prefix"]),s.onlyData=!!s.onlyData,s.useAuthorizationHeader=(o=s.useAuthorizationHeader)!==null&&o!==void 0?o:!0}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(r,s){return this.opts.fetchFn?this.opts.fetchFn(r,s):u.fetch(r,s)}setIdBaseUrl(r){this.opts.idBaseUrl=r}idServerRequest(r,s,o,l,v){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");let f,p;r===h.Method.Get?f=o:p=o;const _=this.getUrl(s,f,l,this.opts.idBaseUrl),T={json:!0,headers:{}};return v&&(T.headers.Authorization=`Bearer ${v}`),this.requestOtherUrl(r,_,p,T)}authedRequest(r,s,o,l,v={}){o||(o={}),this.opts.accessToken&&(this.opts.useAuthorizationHeader?(v.headers||(v.headers={}),v.headers.Authorization||(v.headers.Authorization="Bearer "+this.opts.accessToken),o.access_token&&delete o.access_token):o.access_token||(o.access_token=this.opts.accessToken));const f=this.request(r,s,o,l,v);return f.catch(p=>{p.errcode=="M_UNKNOWN_TOKEN"&&!(v!=null&&v.inhibitLogoutEmit)?this.eventEmitter.emit(b.HttpApiEvent.SessionLoggedOut,p):p.errcode=="M_CONSENT_NOT_GIVEN"&&this.eventEmitter.emit(b.HttpApiEvent.NoConsent,p.message,p.data.consent_uri)}),f}request(r,s,o,l,v){const f=this.getUrl(s,o,v==null?void 0:v.prefix,v==null?void 0:v.baseUrl);return this.requestOtherUrl(r,f,l,v)}requestOtherUrl(r,s,o,l={}){var v,f,p,_;return c(this,void 0,void 0,function*(){const T=Object.assign({},l.headers||{}),w=(v=l.json)!==null&&v!==void 0?v:!0,M=w&&((f=o==null?void 0:o.constructor)===null||f===void 0?void 0:f.name)===Object.name;w&&(M&&!T["Content-Type"]&&(T["Content-Type"]="application/json"),T.Accept||(T.Accept="application/json"));const A=(p=l.localTimeoutMs)!==null&&p!==void 0?p:this.opts.localTimeoutMs,W=(_=l.keepAlive)!==null&&_!==void 0?_:!1,ee=[this.abortController.signal];A!==void 0&&ee.push((0,a.timeoutSignal)(A)),l.abortSignal&&ee.push(l.abortSignal);let F;M?F=JSON.stringify(o):F=o;const{signal:C,cleanup:O}=(0,a.anySignal)(ee);let I;try{I=yield this.fetch(s,{signal:C,method:r,body:F,headers:T,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:W})}catch(D){throw D.name==="AbortError"?D:new d.ConnectionError("fetch failed",D)}finally{O()}if(!I.ok)throw(0,a.parseErrorResponse)(I,yield I.text());return this.opts.onlyData?w?I.json():I.text():I})}getUrl(r,s,o,l){const v=new URL((l??this.opts.baseUrl)+(o??this.opts.prefix)+r);return s&&m.encodeParams(s,v.searchParams),v}}e.FetchHttpApi=n}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../utils":416,"./errors":365,"./interface":368,"./method":369,"./utils":371}],367:[function(t,E,e){(function(u){(function(){var g=this&&this.__createBinding||(Object.create?function(s,o,l,v){v===void 0&&(v=l);var f=Object.getOwnPropertyDescriptor(o,l);(!f||("get"in f?!o.__esModule:f.writable||f.configurable))&&(f={enumerable:!0,get:function(){return o[l]}}),Object.defineProperty(s,v,f)}:function(s,o,l,v){v===void 0&&(v=l),s[v]=o[l]}),S=this&&this.__setModuleDefault||(Object.create?function(s,o){Object.defineProperty(s,"default",{enumerable:!0,value:o})}:function(s,o){s.default=o}),y=this&&this.__importStar||function(s){if(s&&s.__esModule)return s;var o={};if(s!=null)for(var l in s)l!=="default"&&Object.prototype.hasOwnProperty.call(s,l)&&g(o,s,l);return S(o,s),o},c=this&&this.__exportStar||function(s,o){for(var l in s)l!=="default"&&!Object.prototype.hasOwnProperty.call(o,l)&&g(o,s,l)};Object.defineProperty(e,"__esModule",{value:!0}),e.MatrixHttpApi=void 0;const m=t("./fetch"),h=t("./prefix"),d=y(t("../utils")),b=y(t("../realtime-callbacks")),a=t("./method"),n=t("./errors"),i=t("./utils");c(t("./interface"),e),c(t("./prefix"),e),c(t("./errors"),e),c(t("./method"),e),c(t("./utils"),e);class r extends m.FetchHttpApi{constructor(){super(...arguments),this.uploads=[]}uploadContent(o,l={}){var v,f,p,_,T;const w=(v=l.includeFilename)!==null&&v!==void 0?v:!0,M=(f=l.abortController)!==null&&f!==void 0?f:new AbortController,A=(_=(p=l.type)!==null&&p!==void 0?p:o.type)!==null&&_!==void 0?_:"application/octet-stream",W=(T=l.name)!==null&&T!==void 0?T:o.name,ee={loaded:0,total:0,abortController:M},F=d.defer();if(u.XMLHttpRequest){const C=new u.XMLHttpRequest,O=function(){C.abort(),F.reject(new Error("Timeout"))};let I=b.setTimeout(O,3e4);C.onreadystatechange=function(){switch(C.readyState){case u.XMLHttpRequest.DONE:b.clearTimeout(I);try{if(C.status===0)throw new DOMException(C.statusText,"AbortError");if(!C.responseText)throw new Error("No response body.");C.status>=400?F.reject((0,i.parseErrorResponse)(C,C.responseText)):F.resolve(JSON.parse(C.responseText))}catch(j){if(j.name==="AbortError"){F.reject(j);return}F.reject(new n.ConnectionError("request failed",j))}break}},C.upload.onprogress=j=>{var Y;b.clearTimeout(I),ee.loaded=j.loaded,ee.total=j.total,I=b.setTimeout(O,3e4),(Y=l.progressHandler)===null||Y===void 0||Y.call(l,{loaded:j.loaded,total:j.total})};const D=this.getUrl("/upload",void 0,h.MediaPrefix.R0);w&&W&&D.searchParams.set("filename",encodeURIComponent(W)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&D.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),C.open(a.Method.Post,D.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&C.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),C.setRequestHeader("Content-Type",A),C.send(o),M.signal.addEventListener("abort",()=>{C.abort()})}else{const C={};w&&W&&(C.filename=W);const O={"Content-Type":A};this.authedRequest(a.Method.Post,"/upload",C,o,{prefix:h.MediaPrefix.R0,headers:O,abortSignal:M.signal}).then(I=>this.opts.onlyData?I:I.json()).then(F.resolve,F.reject)}return ee.promise=F.promise.finally(()=>{d.removeElement(this.uploads,C=>C===ee)}),M.signal.addEventListener("abort",()=>{d.removeElement(this.uploads,C=>C===ee),F.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(ee),ee.promise}cancelUpload(o){const l=this.uploads.find(v=>v.promise===o);return l?(l.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:h.MediaPrefix.R0+"/upload",params:{access_token:this.opts.accessToken}}}}e.MatrixHttpApi=r}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"../realtime-callbacks":399,"../utils":416,"./errors":365,"./fetch":366,"./interface":368,"./method":369,"./prefix":370,"./utils":371}],368:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.HttpApiEvent=void 0,function(u){u.SessionLoggedOut="Session.logged_out",u.NoConsent="no_consent"}(e.HttpApiEvent||(e.HttpApiEvent={}))},{}],369:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Method=void 0,function(u){u.Get="GET",u.Put="PUT",u.Post="POST",u.Delete="DELETE"}(e.Method||(e.Method={}))},{}],370:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.MediaPrefix=e.IdentityPrefix=e.ClientPrefix=void 0,function(u){u.R0="/_matrix/client/r0",u.V1="/_matrix/client/v1",u.V3="/_matrix/client/v3",u.Unstable="/_matrix/client/unstable"}(e.ClientPrefix||(e.ClientPrefix={})),function(u){u.V2="/_matrix/identity/v2"}(e.IdentityPrefix||(e.IdentityPrefix={})),function(u){u.R0="/_matrix/media/r0"}(e.MediaPrefix||(e.MediaPrefix={}))},{}],371:[function(t,E,e){var u=this&&this.__awaiter||function(i,r,s,o){function l(v){return v instanceof s?v:new s(function(f){f(v)})}return new(s||(s=Promise))(function(v,f){function p(w){try{T(o.next(w))}catch(M){f(M)}}function _(w){try{T(o.throw(w))}catch(M){f(M)}}function T(w){w.done?v(w.value):l(w.value).then(p,_)}T((o=o.apply(i,r||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.retryNetworkOperation=e.parseErrorResponse=e.anySignal=e.timeoutSignal=void 0;const g=t("content-type"),S=t("../logger"),y=t("../utils"),c=t("./errors");function m(i){const r=new AbortController;return setTimeout(()=>{r.abort()},i),r.signal}e.timeoutSignal=m;function h(i){const r=new AbortController;function s(){for(const l of i)l.removeEventListener("abort",o)}function o(){r.abort(),s()}for(const l of i){if(l.aborted){o();break}l.addEventListener("abort",o)}return{signal:r.signal,cleanup:s}}e.anySignal=h;function d(i,r){let s;try{s=a(i)}catch(o){return o}return(s==null?void 0:s.type)==="application/json"&&r?new c.MatrixError(JSON.parse(r),i.status,b(i)?i.responseURL:i.url):(s==null?void 0:s.type)==="text/plain"?new c.HTTPError(`Server returned ${i.status} error: ${r}`,i.status):new c.HTTPError(`Server returned ${i.status} error`,i.status)}e.parseErrorResponse=d;function b(i){return"getResponseHeader"in i}function a(i){let r;if(b(i)?r=i.getResponseHeader("Content-Type"):r=i.headers.get("Content-Type"),!r)return null;try{return(0,g.parse)(r)}catch(s){throw new Error(`Error parsing Content-Type '${r}': ${s}`)}}function n(i,r){return u(this,void 0,void 0,function*(){let s=0,o=null;for(;s<i;)try{if(s>0){const l=1e3*Math.pow(2,s);S.logger.log(`network operation failed ${s} times, retrying in ${l}ms...`),yield(0,y.sleep)(l)}return yield r()}catch(l){if(l instanceof c.ConnectionError)s+=1,o=l;else throw l}throw o})}e.retryNetworkOperation=n},{"../logger":374,"../utils":416,"./errors":365,"content-type":72}],372:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.exists=void 0;function u(g,S){return new Promise((y,c)=>{let m=!0;const h=g.open(S);h.onupgradeneeded=()=>{m=!1},h.onblocked=()=>c(h.error),h.onsuccess=()=>{h.result.close(),m||g.deleteDatabase(S),y(m)},h.onerror=()=>c(h.error)})}e.exists=u},{}],373:[function(t,E,e){var u=this&&this.__awaiter||function(b,a,n,i){function r(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function l(p){try{f(i.next(p))}catch(_){o(_)}}function v(p){try{f(i.throw(p))}catch(_){o(_)}}function f(p){p.done?s(p.value):r(p.value).then(l,v)}f((i=i.apply(b,a||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.InteractiveAuth=e.AuthType=void 0;const g=t("./logger"),S=t("./utils"),y="m.login.email.identity",c="m.login.msisdn";var m;(function(b){b.Password="m.login.password",b.Recaptcha="m.login.recaptcha",b.Terms="m.login.terms",b.Email="m.login.email.identity",b.Msisdn="m.login.msisdn",b.Sso="m.login.sso",b.SsoUnstable="org.matrix.login.sso",b.Dummy="m.login.dummy",b.RegistrationToken="m.login.registration_token",b.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token"})(m=e.AuthType||(e.AuthType={}));class h extends Error{constructor(a,n,i){super(a),this.required_stages=n,this.flows=i,this.name="NoAuthFlowFoundError"}}class d{constructor(a){this.requestingEmailToken=!1,this.attemptAuthDeferred=null,this.chosenFlow=null,this.currentStage=null,this.emailAttempt=1,this.submitPromise=null,this.requestEmailToken=()=>u(this,void 0,void 0,function*(){if(this.requestingEmailToken)g.logger.warn("Could not request email token: Already requesting");else{g.logger.trace("Requesting email token. Attempt: "+this.emailAttempt),this.requestingEmailToken=!0;try{const n=yield this.requestEmailTokenCallback(this.inputs.emailAddress,this.clientSecret,this.emailAttempt++,this.data.session);this.emailSid=n.sid,g.logger.trace("Email token request succeeded")}finally{this.requestingEmailToken=!1}}}),this.matrixClient=a.matrixClient,this.data=a.authData||{},this.requestCallback=a.doRequest,this.busyChangedCallback=a.busyChanged,this.stateUpdatedCallback=a.stateUpdated||a.startAuthStage,this.requestEmailTokenCallback=a.requestEmailToken,this.inputs=a.inputs||{},a.sessionId&&(this.data.session=a.sessionId),this.clientSecret=a.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=a.emailSid}attemptAuth(){var a,n;this.attemptAuthDeferred=(0,S.defer)();const i=this.attemptAuthDeferred.promise;if(!((a=this.data)===null||a===void 0)&&a.flows)this.startNextAuthStage();else{(n=this.busyChangedCallback)===null||n===void 0||n.call(this,!0);const r=this.data.session?{session:this.data.session}:null;this.doRequest(r).finally(()=>{var s;(s=this.busyChangedCallback)===null||s===void 0||s.call(this,!1)})}return i}poll(){return u(this,void 0,void 0,function*(){if(!this.data.session||!this.attemptAuthDeferred||this.submitPromise)return;let a={};if(this.currentStage==y&&this.emailSid){const n={sid:this.emailSid,client_secret:this.clientSecret};if(yield this.matrixClient.doesServerRequireIdServerParam()){const i=new URL(this.matrixClient.getIdentityServerUrl());n.id_server=i.host}a={type:y,threepid_creds:n,threepidCreds:n}}this.submitAuthDict(a,!0)})}getSessionId(){var a;return(a=this.data)===null||a===void 0?void 0:a.session}getClientSecret(){return this.clientSecret}getStageParams(a){var n;return(n=this.data.params)===null||n===void 0?void 0:n[a]}getChosenFlow(){return this.chosenFlow}submitAuthDict(a,n=!1){var i,r;return u(this,void 0,void 0,function*(){if(!this.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");for(n||(i=this.busyChangedCallback)===null||i===void 0||i.call(this,!0);this.submitPromise;)try{yield this.submitPromise}catch{}let s;this.data.session?(s={session:this.data.session},Object.assign(s,a)):s=a;try{this.submitPromise=this.doRequest(s,n),yield this.submitPromise}finally{this.submitPromise=null,n||(r=this.busyChangedCallback)===null||r===void 0||r.call(this,!1)}})}getEmailSid(){return this.emailSid}setEmailSid(a){this.emailSid=a}doRequest(a,n=!1){var i,r,s,o;return u(this,void 0,void 0,function*(){try{const l=yield this.requestCallback(a,n);this.attemptAuthDeferred.resolve(l),this.attemptAuthDeferred=null}catch(l){const v=(r=(i=l.data)===null||i===void 0?void 0:i.flows)!==null&&r!==void 0?r:null,f=this.data.flows||!!v;(l.httpStatus!==401||!l.data||!f)&&(n?g.logger.log("Background poll request failed doing UI auth: ignoring",l):(s=this.attemptAuthDeferred)===null||s===void 0||s.reject(l)),l.data||(l.data={}),!l.data.flows&&!l.data.completed&&!l.data.session&&(l.data.flows=this.data.flows,l.data.completed=this.data.completed,l.data.session=this.data.session),this.data=l.data;try{this.startNextAuthStage()}catch(p){this.attemptAuthDeferred.reject(p),this.attemptAuthDeferred=null;return}if(!this.emailSid&&(!((o=this.chosenFlow)===null||o===void 0)&&o.stages.includes(m.Email)))try{yield this.requestEmailToken()}catch(p){this.attemptAuthDeferred.reject(p),this.attemptAuthDeferred=null}}})}startNextAuthStage(){var a,n,i,r;const s=this.chooseStage();if(!s)throw new Error("No incomplete flows from the server");if(this.currentStage=s,s===m.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if(!((a=this.data)===null||a===void 0)&&a.errcode||!((n=this.data)===null||n===void 0)&&n.error){this.stateUpdatedCallback(s,{errcode:((i=this.data)===null||i===void 0?void 0:i.errcode)||"",error:((r=this.data)===null||r===void 0?void 0:r.error)||""});return}this.stateUpdatedCallback(s,s===y?{emailSid:this.emailSid}:{})}chooseStage(){this.chosenFlow===null&&(this.chosenFlow=this.chooseFlow()),g.logger.log("Active flow => %s",JSON.stringify(this.chosenFlow));const a=this.firstUncompletedStage(this.chosenFlow);return g.logger.log("Next stage: %s",a),a}chooseFlow(){const a=this.data.flows||[],n=!!this.inputs.emailAddress||!!this.emailSid,i=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;for(const s of a){let o=!1,l=!1;for(const v of s.stages)v===y?o=!0:v==c&&(l=!0);if(o==n&&l==i)return s}const r=[];throw n&&r.push(y),i&&r.push(c),new h("No appropriate authentication flow found",r,a)}firstUncompletedStage(a){const n=this.data.completed||[];return a.stages.find(i=>!n.includes(i))}}e.InteractiveAuth=d},{"./logger":374,"./utils":416}],374:[function(t,E,e){var u=this&&this.__importDefault||function(m){return m&&m.__esModule?m:{default:m}};Object.defineProperty(e,"__esModule",{value:!0}),e.logger=void 0;const g=u(t("loglevel")),S="matrix";g.default.methodFactory=function(m,h,d){return function(...b){return this.prefix&&b.unshift(this.prefix),m==="error"||m==="warn"||m==="trace"||m==="info"?console[m](...b):console.log(...b)}},e.logger=g.default.getLogger(S),e.logger.setLevel(g.default.levels.DEBUG,!1);function y(m){m.withPrefix=function(h){const d=this.prefix||"";return c(d+h)}}y(e.logger);function c(m){const h=g.default.getLogger(`${S}-${m}`);return h.prefix!==m&&(y(h),h.prefix=m,h.setLevel(g.default.levels.DEBUG,!1)),h}},{loglevel:151}],375:[function(t,E,e){(function(u){(function(){var g=this&&this.__createBinding||(Object.create?function(f,p,_,T){T===void 0&&(T=_);var w=Object.getOwnPropertyDescriptor(p,_);(!w||("get"in w?!p.__esModule:w.writable||w.configurable))&&(w={enumerable:!0,get:function(){return p[_]}}),Object.defineProperty(f,T,w)}:function(f,p,_,T){T===void 0&&(T=_),f[T]=p[_]}),S=this&&this.__setModuleDefault||(Object.create?function(f,p){Object.defineProperty(f,"default",{enumerable:!0,value:p})}:function(f,p){f.default=p}),y=this&&this.__exportStar||function(f,p){for(var _ in f)_!=="default"&&!Object.prototype.hasOwnProperty.call(p,_)&&g(p,f,_)},c=this&&this.__importStar||function(f){if(f&&f.__esModule)return f;var p={};if(f!=null)for(var _ in f)_!=="default"&&Object.prototype.hasOwnProperty.call(f,_)&&g(p,f,_);return S(p,f),p};Object.defineProperty(e,"__esModule",{value:!0}),e.createRoomWidgetClient=e.createClient=e.setCryptoStoreFactory=e.GroupCallType=e.GroupCallState=e.GroupCallIntent=e.GroupCallEvent=e.createNewMatrixCall=e.SecretStorage=e.ContentHelpers=void 0;const m=t("./crypto/store/memory-crypto-store"),h=t("./store/memory"),d=t("./scheduler"),b=t("./client"),a=t("./embedded");y(t("./client"),e),y(t("./embedded"),e),y(t("./http-api"),e),y(t("./autodiscovery"),e),y(t("./sync-accumulator"),e),y(t("./errors"),e),y(t("./models/beacon"),e),y(t("./models/event"),e),y(t("./models/room"),e),y(t("./models/event-timeline"),e),y(t("./models/event-timeline-set"),e),y(t("./models/poll"),e),y(t("./models/room-member"),e),y(t("./models/room-state"),e),y(t("./models/user"),e),y(t("./scheduler"),e),y(t("./filter"),e),y(t("./timeline-window"),e),y(t("./interactive-auth"),e),y(t("./service-types"),e),y(t("./store/memory"),e),y(t("./store/indexeddb"),e),y(t("./crypto/store/memory-crypto-store"),e),y(t("./crypto/store/indexeddb-crypto-store"),e),y(t("./content-repo"),e),y(t("./@types/event"),e),y(t("./@types/PushRules"),e),y(t("./@types/partials"),e),y(t("./@types/requests"),e),y(t("./@types/search"),e),y(t("./models/room-summary"),e),e.ContentHelpers=c(t("./content-helpers")),e.SecretStorage=c(t("./secret-storage"));var n=t("./webrtc/call");Object.defineProperty(e,"createNewMatrixCall",{enumerable:!0,get:function(){return n.createNewMatrixCall}});var i=t("./webrtc/groupCall");Object.defineProperty(e,"GroupCallEvent",{enumerable:!0,get:function(){return i.GroupCallEvent}}),Object.defineProperty(e,"GroupCallIntent",{enumerable:!0,get:function(){return i.GroupCallIntent}}),Object.defineProperty(e,"GroupCallState",{enumerable:!0,get:function(){return i.GroupCallState}}),Object.defineProperty(e,"GroupCallType",{enumerable:!0,get:function(){return i.GroupCallType}});let r=()=>new m.MemoryCryptoStore;function s(f){r=f}e.setCryptoStoreFactory=s;function o(f){var p,_,T;return f.store=(p=f.store)!==null&&p!==void 0?p:new h.MemoryStore({localStorage:u.localStorage}),f.scheduler=(_=f.scheduler)!==null&&_!==void 0?_:new d.MatrixScheduler,f.cryptoStore=(T=f.cryptoStore)!==null&&T!==void 0?T:r(),f}function l(f){return new b.MatrixClient(o(f))}e.createClient=l;function v(f,p,_,T){return new a.RoomWidgetClient(f,p,_,o(T))}e.createRoomWidgetClient=v}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./@types/PushRules":304,"./@types/event":306,"./@types/partials":309,"./@types/requests":312,"./@types/search":313,"./autodiscovery":319,"./client":321,"./content-helpers":322,"./content-repo":323,"./crypto/store/indexeddb-crypto-store":346,"./crypto/store/memory-crypto-store":348,"./embedded":358,"./errors":359,"./filter":364,"./http-api":367,"./interactive-auth":373,"./models/beacon":378,"./models/event":383,"./models/event-timeline":382,"./models/event-timeline-set":381,"./models/poll":385,"./models/room":392,"./models/room-member":389,"./models/room-state":390,"./models/room-summary":391,"./models/user":396,"./scheduler":403,"./secret-storage":404,"./service-types":405,"./store/indexeddb":410,"./store/memory":411,"./sync-accumulator":413,"./timeline-window":415,"./webrtc/call":418,"./webrtc/groupCall":422}],376:[function(t,E,e){var u=this&&this.__awaiter||function(c,m,h,d){function b(a){return a instanceof h?a:new h(function(n){n(a)})}return new(h||(h=Promise))(function(a,n){function i(o){try{s(d.next(o))}catch(l){n(l)}}function r(o){try{s(d.throw(o))}catch(l){n(l)}}function s(o){o.done?a(o.value):b(o.value).then(i,r)}s((d=d.apply(c,m||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.MSC3089Branch=void 0;const g=t("../@types/event"),S=t("./event-timeline");class y{constructor(m,h,d){this.client=m,this.indexEvent=h,this.directory=d}get id(){const m=this.indexEvent.getStateKey();if(!m)throw new Error("State key not found for branch");return m}get isActive(){return this.indexEvent.getContent().active===!0}get version(){var m;return(m=this.indexEvent.getContent().version)!==null&&m!==void 0?m:1}get roomId(){return this.indexEvent.getRoomId()}delete(){return u(this,void 0,void 0,function*(){yield this.client.sendStateEvent(this.roomId,g.UNSTABLE_MSC3089_BRANCH.name,{},this.id),yield this.client.redactEvent(this.roomId,this.id);const m=(yield this.getVersionHistory())[1];m&&(yield m.delete())})}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(m){return u(this,void 0,void 0,function*(){yield this.client.sendStateEvent(this.roomId,g.UNSTABLE_MSC3089_BRANCH.name,Object.assign(Object.assign({},this.indexEvent.getContent()),{name:m}),this.id)})}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(m){return u(this,void 0,void 0,function*(){yield this.client.sendStateEvent(this.roomId,g.UNSTABLE_MSC3089_BRANCH.name,Object.assign(Object.assign({},this.indexEvent.getContent()),{locked:m}),this.id)})}getFileInfo(){return u(this,void 0,void 0,function*(){const h=(yield this.getFileEvent()).getOriginalContent().file,d=this.client.mxcUrlToHttp(h.url);if(!d)throw new Error(`No HTTP URL available for ${h.url}`);return{info:h,httpUrl:d}})}getFileEvent(){return u(this,void 0,void 0,function*(){const m=this.client.getRoom(this.roomId);if(!m)throw new Error("Unknown room");let h=m.getUnfilteredTimelineSet().findEventById(this.id);for(;!h&&m.getLiveTimeline().getState(S.EventTimeline.BACKWARDS).paginationToken;)yield this.client.scrollback(m,100),h=m.getUnfilteredTimelineSet().findEventById(this.id);if(!h)throw new Error("Failed to find event");return yield this.client.decryptEventIfNeeded(h,{emit:!0,isRetry:!0}),h})}createNewVersion(m,h,d,b){return u(this,void 0,void 0,function*(){const a=yield this.directory.createFile(m,h,d,Object.assign(Object.assign({},b??{}),{"m.new_content":!0,"m.relates_to":{rel_type:g.RelationType.Replace,event_id:this.id}}));return yield this.client.sendStateEvent(this.roomId,g.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:m,version:this.version+1},a.event_id),yield this.client.sendStateEvent(this.roomId,g.UNSTABLE_MSC3089_BRANCH.name,Object.assign(Object.assign({},this.indexEvent.getContent()),{active:!1}),this.id),a})}getVersionHistory(){return u(this,void 0,void 0,function*(){const m=[];m.push(this);const h=this.client.getRoom(this.roomId);if(!h)throw new Error("Invalid or unknown room");const d=[...h.getLiveTimeline().getEvents()].reverse();let b,a=yield this.getFileEvent();do if(b=d.find(n=>n.replacingEventId()===a.getId()),b){const n=this.directory.getFile(b.getId());if(n)m.push(n),a=b;else break}while(b);return m})}}e.MSC3089Branch=y},{"../@types/event":306,"./event-timeline":382}],377:[function(t,E,e){var u=this&&this.__awaiter||function(n,i,r,s){function o(l){return l instanceof r?l:new r(function(v){v(l)})}return new(r||(r=Promise))(function(l,v){function f(T){try{_(s.next(T))}catch(w){v(w)}}function p(T){try{_(s.throw(T))}catch(w){v(w)}}function _(T){T.done?l(T.value):o(T.value).then(f,p)}_((s=s.apply(n,i||[])).next())})},g=this&&this.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(e,"__esModule",{value:!0}),e.MSC3089TreeSpace=e.TreePermissions=e.DEFAULT_TREE_POWER_LEVELS_TEMPLATE=void 0;const S=g(t("p-retry")),y=t("../@types/event"),c=t("../logger"),m=t("../utils"),h=t("./MSC3089Branch"),d=t("../crypto/algorithms/megolm");e.DEFAULT_TREE_POWER_LEVELS_TEMPLATE={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[y.EventType.RoomPowerLevels]:100,[y.EventType.RoomHistoryVisibility]:100,[y.EventType.RoomTombstone]:100,[y.EventType.RoomEncryption]:100,[y.EventType.RoomName]:50,[y.EventType.RoomMessage]:50,[y.EventType.RoomMessageEncrypted]:50,[y.EventType.Sticker]:50},users:{}};var b;(function(n){n.Viewer="viewer",n.Editor="editor",n.Owner="owner"})(b=e.TreePermissions||(e.TreePermissions={}));class a{constructor(i,r){if(this.client=i,this.roomId=r,this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const i=this.room.currentState.getStateEvents(y.EventType.SpaceParent);return i!=null&&i.length?i.every(r=>{var s;return!(!((s=r.getContent())===null||s===void 0)&&s.via)}):!0}setName(i){return u(this,void 0,void 0,function*(){yield this.client.sendStateEvent(this.roomId,y.EventType.RoomName,{name:i},"")})}invite(i,r=!0,s=!0){return u(this,void 0,void 0,function*(){const o=[this.retryInvite(i)];return r&&o.push(...this.getDirectories().map(l=>l.invite(i,r,s))),Promise.all(o).then(()=>{s&&(0,d.isRoomSharedHistory)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[i])})})}retryInvite(i){return(0,m.simpleRetryOperation)(()=>u(this,void 0,void 0,function*(){yield this.client.invite(this.roomId,i).catch(r=>{throw(r==null?void 0:r.errcode)==="M_FORBIDDEN"?new S.default.AbortError(r):r})}))}setPermissions(i,r){var s;return u(this,void 0,void 0,function*(){const o=this.room.currentState.getStateEvents(y.EventType.RoomPowerLevels,"");if(Array.isArray(o))throw new Error("Unexpected return type for power levels");const l=(o==null?void 0:o.getContent())||{},v=l.users_default||0,f=l.events_default||50,p=((s=l.events)===null||s===void 0?void 0:s[y.EventType.RoomPowerLevels])||100,_=l.users||{};switch(r){case b.Viewer:_[i]=v;break;case b.Editor:_[i]=f;break;case b.Owner:_[i]=p;break;default:throw new Error("Invalid role: "+r)}l.users=_,yield this.client.sendStateEvent(this.roomId,y.EventType.RoomPowerLevels,l,"")})}getPermissions(i){var r,s;const o=this.room.currentState.getStateEvents(y.EventType.RoomPowerLevels,"");if(Array.isArray(o))throw new Error("Unexpected return type for power levels");const l=(o==null?void 0:o.getContent())||{},v=l.users_default||0,f=l.events_default||50,p=((r=l.events)===null||r===void 0?void 0:r[y.EventType.RoomPowerLevels])||100,_=((s=l.users)===null||s===void 0?void 0:s[i])||v;return _>=p?b.Owner:_>=f?b.Editor:b.Viewer}createDirectory(i){return u(this,void 0,void 0,function*(){const r=yield this.client.unstableCreateFileTree(i);return yield this.client.sendStateEvent(this.roomId,y.EventType.SpaceChild,{via:[this.client.getDomain()]},r.roomId),yield this.client.sendStateEvent(r.roomId,y.EventType.SpaceParent,{via:[this.client.getDomain()]},this.roomId),r})}getDirectories(){const i=[],r=this.room.currentState.getStateEvents(y.EventType.SpaceChild);for(const s of r)try{const o=s.getStateKey();if(o){const l=this.client.unstableGetFileTreeSpace(o);l&&i.push(l)}}catch(o){c.logger.warn("Unable to create tree space instance for listing. Are we joined?",o)}return i}getDirectory(i){return this.getDirectories().find(r=>r.roomId===i)}delete(){return u(this,void 0,void 0,function*(){const i=this.getDirectories();for(const o of i)yield o.delete();const r=["invite","knock","join"],s=this.room.currentState.getStateEvents(y.EventType.RoomMember);for(const o of s)if(o.getStateKey()!==this.client.getUserId()&&r.includes(o.getContent().membership)){const v=o.getStateKey();if(!v)throw new Error("State key not found for branch");yield this.client.kick(this.roomId,v,"Room deleted")}yield this.client.leave(this.roomId)})}getOrderedChildren(i){const r=i.map(s=>({roomId:s.getStateKey(),order:s.getContent().order})).filter(s=>s.roomId);return r.sort((s,o)=>{var l,v,f,p;if(s.order&&!o.order)return-1;if(!s.order&&o.order)return 1;if(!s.order&&!o.order){const _=this.client.getRoom(s.roomId),T=this.client.getRoom(o.roomId);if(!_||!T)return(0,m.lexicographicCompare)(s.roomId,o.roomId);const w=(v=(l=_.currentState.getStateEvents(y.EventType.RoomCreate,""))===null||l===void 0?void 0:l.getTs())!==null&&v!==void 0?v:0,M=(p=(f=T.currentState.getStateEvents(y.EventType.RoomCreate,""))===null||f===void 0?void 0:f.getTs())!==null&&p!==void 0?p:0;return w===M?(0,m.lexicographicCompare)(s.roomId,o.roomId):w-M}else return(0,m.lexicographicCompare)(s.order,o.order)}),r}getParentRoom(){const r=this.room.currentState.getStateEvents(y.EventType.SpaceParent)[0];if(!r)throw new Error("Expected to have a parent in a non-top level space");const s=r.getStateKey();if(!s)throw new Error("No state key found for parent");const o=this.client.getRoom(s);if(!o)throw new Error("Unable to locate room for parent");return o}getOrder(){if(this.isTopLevel)return-1;const r=this.getParentRoom().currentState.getStateEvents(y.EventType.SpaceChild);return this.getOrderedChildren(r).findIndex(o=>o.roomId===this.roomId)}setOrder(i){var r,s;return u(this,void 0,void 0,function*(){if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const o=this.getParentRoom(),l=o.currentState.getStateEvents(y.EventType.SpaceChild),v=this.getOrderedChildren(l);i=Math.max(Math.min(i,v.length-1),0);const p=this.getOrder()<i;p&&i===v.length-1?i--:!p&&i===0&&i++;const _=v[p?i:i-1],T=v[p?i+1:i];let w=m.DEFAULT_ALPHABET[0],M=!1;if(!_)T!=null&&T.order&&(w=(0,m.prevString)(T.order));else if(i===v.length-1)T!=null&&T.order&&(w=(0,m.nextString)(T.order));else{const ee=_==null?void 0:_.order,F=T==null?void 0:T.order;ee&&F?ee===F?w=(0,m.nextString)(ee):w=(0,m.averageBetweenStrings)(ee,F):ee?w=(0,m.nextString)(ee):F?w=(0,m.prevString)(F):M=!0}if(M){let ee;for(let F=0;F<=i;F++){const C=v[F];if(F===0&&(ee=C.order),C.order)ee=C.order;else{ee=ee?(0,m.nextString)(ee):m.DEFAULT_ALPHABET[0];const O=o.currentState.getStateEvents(y.EventType.SpaceChild,C.roomId),I=(r=O==null?void 0:O.getContent())!==null&&r!==void 0?r:{via:[this.client.getDomain()]};yield this.client.sendStateEvent(o.roomId,y.EventType.SpaceChild,Object.assign(Object.assign({},I),{order:ee}),C.roomId)}}ee&&(w=(0,m.nextString)(ee))}const A=o.currentState.getStateEvents(y.EventType.SpaceChild,this.roomId),W=(s=A==null?void 0:A.getContent())!==null&&s!==void 0?s:{via:[this.client.getDomain()]};yield this.client.sendStateEvent(o.roomId,y.EventType.SpaceChild,Object.assign(Object.assign({},W),{order:w}),this.roomId)})}createFile(i,r,s,o){return u(this,void 0,void 0,function*(){const{content_uri:l}=yield this.client.uploadContent(r,{includeFilename:!1});s.url=l;const v={msgtype:y.MsgType.File,body:i,url:l,file:s};o=o??{},o["m.new_content"]&&(o["m.new_content"]=v);const f=yield this.client.sendMessage(this.roomId,Object.assign(Object.assign(Object.assign({},o),v),{[y.UNSTABLE_MSC3089_LEAF.name]:{}}));return yield this.client.sendStateEvent(this.roomId,y.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:i},f.event_id),f})}getFile(i){const r=this.room.currentState.getStateEvents(y.UNSTABLE_MSC3089_BRANCH.name,i);return r?new h.MSC3089Branch(this.client,r,this):null}listFiles(){return this.listAllFiles().filter(i=>i.isActive)}listAllFiles(){var i;return((i=this.room.currentState.getStateEvents(y.UNSTABLE_MSC3089_BRANCH.name))!==null&&i!==void 0?i:[]).map(s=>new h.MSC3089Branch(this.client,s,this))}}e.MSC3089TreeSpace=a},{"../@types/event":306,"../crypto/algorithms/megolm":334,"../logger":374,"../utils":416,"./MSC3089Branch":376,"p-retry":225}],378:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Beacon=e.getBeaconInfoIdentifier=e.isTimestampInDuration=e.BeaconEvent=void 0;const u=t("../content-helpers"),g=t("../utils"),S=t("./typed-event-emitter");var y;(function(d){d.New="Beacon.new",d.Update="Beacon.update",d.LivenessChange="Beacon.LivenessChange",d.Destroy="Beacon.Destroy",d.LocationUpdate="Beacon.LocationUpdate"})(y=e.BeaconEvent||(e.BeaconEvent={}));const c=(d,b,a)=>a>=d&&d+b>=a;e.isTimestampInDuration=c;const m=d=>`${d.getRoomId()}_${d.getStateKey()}`;e.getBeaconInfoIdentifier=m;class h extends S.TypedEventEmitter{constructor(b){super(),this.rootEvent=b,this.clearLatestLocation=()=>{this._latestLocationEvent=void 0,this.emit(y.LocationUpdate,this.latestLocationState)},this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return(0,e.getBeaconInfoIdentifier)(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&(0,u.parseBeaconContent)(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(b){if((0,e.getBeaconInfoIdentifier)(b)!==this.identifier)throw new Error("Invalid updating event");b.getTs()<this.rootEvent.getTs()||(this.rootEvent=b,this.setBeaconInfo(this.rootEvent),this.emit(y.Update,b,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(y.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){const b=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();b>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},b))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(b){var a;if(!this.isLive)return;const i=(a=b.filter(r=>{const s=r.getContent(),o=(0,u.parseBeaconContent)(s);if(!o.uri||!o.timestamp)return!1;const{timestamp:l}=o;return this._beaconInfo.timestamp&&(0,e.isTimestampInDuration)(this._beaconInfo.timestamp,this._beaconInfo.timeout,l)&&(!this.latestLocationState||l>this.latestLocationState.timestamp)}).sort(g.sortEventsByLatestContentTimestamp))===null||a===void 0?void 0:a[0];i&&(this._latestLocationEvent=i,this.emit(y.LocationUpdate,this.latestLocationState))}setBeaconInfo(b){this._beaconInfo=(0,u.parseBeaconInfoContent)(b.getContent()),this.checkLiveness()}checkLiveness(){const b=this.isLive;if(!this.beaconInfo)return;const a=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!a&&(0,e.isTimestampInDuration)(a,this._beaconInfo.timeout,Date.now()),b!==this.isLive&&this.emit(y.LivenessChange,this.isLive,this)}}e.Beacon=h},{"../content-helpers":322,"../utils":416,"./typed-event-emitter":395}],379:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.EventContext=void 0;const u=t("./event-timeline");class g{constructor(y){this.ourEvent=y,this.ourEventIndex=0,this.paginateTokens={[u.Direction.Backward]:null,[u.Direction.Forward]:null},this.timeline=[y]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(y=!1){return this.paginateTokens[y?u.Direction.Backward:u.Direction.Forward]}setPaginateToken(y,c=!1){this.paginateTokens[c?u.Direction.Backward:u.Direction.Forward]=y??null}addEvents(y,c=!1){c?(this.timeline=y.concat(this.timeline),this.ourEventIndex+=y.length):this.timeline=this.timeline.concat(y)}}e.EventContext=g},{"./event-timeline":382}],380:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.EventStatus=void 0,function(u){u.NOT_SENT="not_sent",u.ENCRYPTING="encrypting",u.SENDING="sending",u.QUEUED="queued",u.SENT="sent",u.CANCELLED="cancelled"}(e.EventStatus||(e.EventStatus={}))},{}],381:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.EventTimelineSet=e.DuplicateStrategy=void 0;const u=t("./event-timeline"),g=t("../logger"),S=t("./room"),y=t("./typed-event-emitter"),c=t("./relations-container");let m;m=g.logger.log.bind(g.logger);var h;(function(b){b.Ignore="ignore",b.Replace="replace"})(h=e.DuplicateStrategy||(e.DuplicateStrategy={}));class d extends y.TypedEventEmitter{constructor(a,n={},i,r,s=null){var o,l,v;super(),this.room=a,this.thread=r,this.threadListType=s,this._eventIdToTimeline=new Map,this.timelineSupport=!!n.timelineSupport,this.liveTimeline=new u.EventTimeline(this),this.displayPendingEvents=n.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=n.filter,this.relations=(l=(o=this.room)===null||o===void 0?void 0:o.relations)!==null&&l!==void 0?l:new c.RelationsContainer((v=a==null?void 0:a.client)!==null&&v!==void 0?v:i)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(a){this.filter=a}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(a){this.liveTimeline=a}eventIdToTimeline(a){return this._eventIdToTimeline.get(a)}replaceEventId(a,n){const i=this._eventIdToTimeline.get(a);i&&(this._eventIdToTimeline.delete(a),this._eventIdToTimeline.set(n,i))}resetLiveTimeline(a,n){const i=!this.timelineSupport||!n,r=this.liveTimeline,s=i?r.forkLive(u.EventTimeline.FORWARDS):r.fork(u.EventTimeline.FORWARDS);i?(this.timelines=[s],this._eventIdToTimeline=new Map):this.timelines.push(s),n&&r.setPaginationToken(n,u.EventTimeline.FORWARDS),s.setPaginationToken(a??null,u.EventTimeline.BACKWARDS),this.liveTimeline=s,this.emit(S.RoomEvent.TimelineReset,this.room,this,i)}getTimelineForEvent(a){if(a==null)return null;const n=this._eventIdToTimeline.get(a);return n===void 0?null:n}findEventById(a){const n=this.getTimelineForEvent(a);if(n)return n.getEvents().find(function(i){return i.getId()==a})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const a=new u.EventTimeline(this);return this.timelines.push(a),a}addEventsToTimeline(a,n,i,r){if(!i)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!n&&i==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&(a=this.filter.filterRoomTimeline(a),!a.length))return;const s=n?u.EventTimeline.BACKWARDS:u.EventTimeline.FORWARDS,o=n?u.EventTimeline.FORWARDS:u.EventTimeline.BACKWARDS;let l=!1,v=!1;for(const f of a){const p=f.getId(),_=this._eventIdToTimeline.get(p);if(!_){this.addEventToTimeline(f,i,{toStartOfTimeline:n}),v=!0,l=!0;continue}if(v=!1,_==i){m("Event "+p+" already in timeline "+i);continue}const T=i.getNeighbouringTimeline(s);if(T){_==T?m("Event "+p+" in neighbouring timeline - switching to "+_):m("Event "+p+" already in a different timeline "+_),i=_;continue}g.logger.info("Already have timeline for "+p+" - joining timeline "+i+" to "+_);const w=_===this.liveTimeline,M=i===this.liveTimeline,A=s===u.EventTimeline.BACKWARDS&&w,W=s===u.EventTimeline.FORWARDS&&M;if(A||W){A&&g.logger.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+_+")"),W&&g.logger.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+i+")");continue}i.setNeighbouringTimeline(_,s),_.setNeighbouringTimeline(i,o),i=_,l=!0}if(v||!l){if(s===u.EventTimeline.FORWARDS&&i===this.liveTimeline){g.logger.warn({lastEventWasNew:v,didUpdate:l}),g.logger.warn(`Refusing to set forwards pagination token of live timeline ${i} to ${r}`);return}i.setPaginationToken(r??null,s)}}addLiveEvent(a,n,i=!1,r){let s=n||h.Ignore,o;if(typeof n=="object"?{duplicateStrategy:s=h.Ignore,fromCache:i=!1,roomState:r,timelineWasEmpty:o}=n:n!==void 0&&g.logger.warn("Overload deprecated: `EventTimelineSet.addLiveEvent(event, duplicateStrategy?, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addLiveEvent(event, IAddLiveEventOptions)`"),this.filter&&!this.filter.filterRoomTimeline([a]).length)return;const l=this._eventIdToTimeline.get(a.getId());if(l){if(s===h.Replace){m("EventTimelineSet.addLiveEvent: replacing duplicate event "+a.getId());const v=l.getEvents();for(let f=0;f<v.length;f++)if(v[f].getId()===a.getId()){r||(r=l.getState(u.EventTimeline.FORWARDS)),u.EventTimeline.setEventMetadata(a,r,!1),v[f]=a;break}}else m("EventTimelineSet.addLiveEvent: ignoring duplicate event "+a.getId());return}this.addEventToTimeline(a,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:r,timelineWasEmpty:o})}addEventToTimeline(a,n,i,r=!1,s){var o,l;let v=!!i,f;if(typeof i=="object"?{toStartOfTimeline:v,fromCache:r=!1,roomState:s,timelineWasEmpty:f}=i:i!==void 0&&g.logger.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`"),n.getTimelineSet()!==this)throw new Error(`EventTimelineSet.addEventToTimeline: Timeline=${n.toString()} does not belong " +
                "in timelineSet(threadId=${(o=this.thread)===null||o===void 0?void 0:o.id})`);if(this.room&&!this.canContain(a)){let T=`event=${a.getId()}`;a.threadRootId&&(T+=`(belongs to thread=${a.threadRootId})`),g.logger.warn(`EventTimelineSet.addEventToTimeline: Ignoring ${T} that does not belong in timeline=${n.toString()} timelineSet(threadId=${(l=this.thread)===null||l===void 0?void 0:l.id})`);return}const p=a.getId();n.addEvent(a,{toStartOfTimeline:v,roomState:s,timelineWasEmpty:f}),this._eventIdToTimeline.set(p,n),this.relations.aggregateParentEvent(a),this.relations.aggregateChildEvent(a,this);const _={timeline:n,liveEvent:!v&&n==this.liveTimeline&&!r};this.emit(S.RoomEvent.Timeline,a,this.room,!!v,!1,_)}handleRemoteEcho(a,n,i){const r=this._eventIdToTimeline.get(n);r?(this._eventIdToTimeline.delete(n),this._eventIdToTimeline.set(i,r)):(!this.filter||this.filter.filterRoomTimeline([a]).length)&&this.addEventToTimeline(a,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(a){const n=this._eventIdToTimeline.get(a);if(!n)return null;const i=n.removeEvent(a);if(i){this._eventIdToTimeline.delete(a);const r={timeline:n};this.emit(S.RoomEvent.Timeline,i,this.room,void 0,!0,r)}return i}compareEventOrdering(a,n){if(a==n)return 0;const i=this._eventIdToTimeline.get(a),r=this._eventIdToTimeline.get(n);if(i===void 0||r===void 0)return null;if(i===r){let o,l;const v=i.getEvents();for(let f=0;f<v.length&&(o===void 0||l===void 0);f++){const p=v[f].getId();p==a&&(o=f),p==n&&(l=f)}return o-l}let s=i;for(;s;){if(s===r)return-1;s=s.getNeighbouringTimeline(u.EventTimeline.FORWARDS)}for(s=i;s;){if(s===r)return 1;s=s.getNeighbouringTimeline(u.EventTimeline.BACKWARDS)}return null}canContain(a){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");const{threadId:n,shouldLiveInRoom:i}=this.room.eventShouldLiveIn(a);return this.thread?this.thread.id===n:i}}e.EventTimelineSet=d},{"../logger":374,"./event-timeline":382,"./relations-container":387,"./room":392,"./typed-event-emitter":395}],382:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.EventTimeline=e.Direction=void 0;const u=t("../logger"),g=t("./room-state"),S=t("../@types/event");var y;(function(m){m.Backward="b",m.Forward="f"})(y=e.Direction||(e.Direction={}));class c{static setEventMetadata(h,d,b){var a,n,i,r;!((n=(a=h.sender)===null||a===void 0?void 0:a.events)===null||n===void 0)&&n.member||(h.sender=d.getSentinelMember(h.getSender())),!(!((r=(i=h.target)===null||i===void 0?void 0:i.events)===null||r===void 0)&&r.member)&&h.getType()===S.EventType.RoomMember&&(h.target=d.getSentinelMember(h.getStateKey())),h.isState()&&b&&(h.forwardLooking=!1)}constructor(h){var d,b;this.eventTimelineSet=h,this.events=[],this.baseIndex=0,this.startToken=null,this.endToken=null,this.prevTimeline=null,this.nextTimeline=null,this.paginationRequests={[y.Backward]:null,[y.Forward]:null},this.roomId=(b=(d=h.room)===null||d===void 0?void 0:d.roomId)!==null&&b!==void 0?b:null,this.roomId&&(this.startState=new g.RoomState(this.roomId),this.endState=new g.RoomState(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(h,{timelineWasEmpty:d}={}){var b,a;if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(b=this.startState)===null||b===void 0||b.setStateEvents(h,{timelineWasEmpty:d}),(a=this.endState)===null||a===void 0||a.setStateEvents(h,{timelineWasEmpty:d})}forkLive(h){const d=this.getState(h),b=new c(this.eventTimelineSet);return b.startState=d==null?void 0:d.clone(),b.endState=d,this.endState=d==null?void 0:d.clone(),b}fork(h){const d=this.getState(h),b=new c(this.eventTimelineSet);return b.startState=d==null?void 0:d.clone(),b.endState=d==null?void 0:d.clone(),b}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(h){if(h==c.BACKWARDS)return this.startState;if(h==c.FORWARDS)return this.endState;throw new Error("Invalid direction '"+h+"'")}getPaginationToken(h){return this.roomId?this.getState(h).paginationToken:h===y.Backward?this.startToken:this.endToken}setPaginationToken(h,d){this.roomId?this.getState(d).paginationToken=h:d===y.Backward?this.startToken=h:this.endToken=h}getNeighbouringTimeline(h){if(h==c.BACKWARDS)return this.prevTimeline;if(h==c.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+h+"'")}setNeighbouringTimeline(h,d){if(this.getNeighbouringTimeline(d))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+d+")");if(d==c.BACKWARDS)this.prevTimeline=h;else if(d==c.FORWARDS)this.nextTimeline=h;else throw new Error("Invalid direction '"+d+"'");this.setPaginationToken(null,d)}addEvent(h,d,b){let a=!!d,n;typeof d=="object"?{toStartOfTimeline:a,roomState:b,timelineWasEmpty:n}=d:d!==void 0&&u.logger.warn("Overload deprecated: `EventTimeline.addEvent(event, toStartOfTimeline, roomState?)` is deprecated in favor of the overload with `EventTimeline.addEvent(event, IAddEventOptions)`"),b||(b=a?this.startState:this.endState);const i=this.getTimelineSet();i.room&&(c.setEventMetadata(h,b,a),h.isState()&&i.room.getUnfilteredTimelineSet()===i&&(b==null||b.setStateEvents([h],{timelineWasEmpty:n}),(!h.sender||h.getType()===S.EventType.RoomMember&&!a)&&c.setEventMetadata(h,b,a)));let r;a?r=0:r=this.events.length,this.events.splice(r,0,h),a&&this.baseIndex++}removeEvent(h){for(let d=this.events.length-1;d>=0;d--){const b=this.events[d];if(b.getId()==h)return this.events.splice(d,1),d<this.baseIndex&&this.baseIndex--,b}return null}toString(){return this.name}}e.EventTimeline=c,c.BACKWARDS=y.Backward,c.FORWARDS=y.Forward},{"../@types/event":306,"../logger":374,"./room-state":390}],383:[function(t,E,e){var u=this&&this.__awaiter||function(v,f,p,_){function T(w){return w instanceof p?w:new p(function(M){M(w)})}return new(p||(p=Promise))(function(w,M){function A(F){try{ee(_.next(F))}catch(C){M(C)}}function W(F){try{ee(_.throw(F))}catch(C){M(C)}}function ee(F){F.done?w(F.value):T(F.value).then(A,W)}ee((_=_.apply(v,f||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.MatrixEvent=e.MatrixEventEvent=e.EventStatus=void 0;const g=t("matrix-events-sdk"),S=t("../logger"),y=t("../@types/event"),c=t("../utils"),m=t("./thread"),h=t("../ReEmitter"),d=t("./typed-event-emitter"),b=t("../crypto/algorithms"),a=t("../crypto/OlmDevice");var n=t("./event-status");Object.defineProperty(e,"EventStatus",{enumerable:!0,get:function(){return n.EventStatus}});const i=Object.freeze({visible:!0});var r;(function(v){v.Decrypted="Event.decrypted",v.BeforeRedaction="Event.beforeRedaction",v.VisibilityChange="Event.visibilityChange",v.LocalEventIdReplaced="Event.localEventIdReplaced",v.Status="Event.status",v.Replaced="Event.replaced",v.RelationsCreated="Event.relationsCreated"})(r=e.MatrixEventEvent||(e.MatrixEventEvent={}));class s extends d.TypedEventEmitter{constructor(f={}){var p;super(),this.event=f,this.pushActions=null,this._replacingEvent=null,this._localRedactionEvent=null,this._isCancelled=!1,this.visibility=i,this._hasCachedExtEv=!1,this._cachedExtEv=void 0,this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=null,this.decryptionPromise=null,this.retryDecryption=!1,this.encryptedDisabledForUnverifiedDevices=!1,this.sender=null,this.target=null,this.status=null,this.error=null,this.forwardLooking=!0,["state_key","type","sender","room_id","membership"].forEach(_=>{typeof f[_]=="string"&&(f[_]=(0,c.internaliseString)(f[_]))}),["membership","avatar_url","displayname"].forEach(_=>{var T;typeof((T=f.content)===null||T===void 0?void 0:T[_])=="string"&&(f.content[_]=(0,c.internaliseString)(f.content[_]))}),["rel_type"].forEach(_=>{var T,w;typeof((w=(T=f.content)===null||T===void 0?void 0:T["m.relates_to"])===null||w===void 0?void 0:w[_])=="string"&&(f.content["m.relates_to"][_]=(0,c.internaliseString)(f.content["m.relates_to"][_]))}),this.txnId=f.txn_id,this.localTimestamp=Date.now()-((p=this.getAge())!==null&&p!==void 0?p:0),this.reEmitter=new h.TypedReEmitter(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=g.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){const f=Object.assign({},this.getContent());if(this.getWireType()===y.EventType.RoomMessageEncrypted)for(const[p,_]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(p)||f[p]===void 0&&(f[p]=_);return Object.assign({},this.event,this.clearEvent,{content:f})}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){let f=`id=${this.getId()} type=${this.getWireType()} sender=${this.getSender()}`;const p=this.getRoomId();p&&(f+=` room=${p}`);const _=this.getDate();return _&&(f+=` ts=${_.toISOString()}`),f}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var f,p;const _=(f=this.getWireContent())===null||f===void 0?void 0:f["m.relates_to"];return(_==null?void 0:_.rel_type)===m.THREAD_RELATION_TYPE.name?_.event_id:((p=this.getThread())===null||p===void 0?void 0:p.id)||this.threadId}get isThreadRoot(){var f;return!!this.getServerAggregatedRelation(m.THREAD_RELATION_TYPE.name)||((f=this.getThread())===null||f===void 0?void 0:f.id)===this.getId()}get replyEventId(){var f,p;return(p=(f=this.getWireContent()["m.relates_to"])===null||f===void 0?void 0:f["m.in_reply_to"])===null||p===void 0?void 0:p.event_id}get relationEventId(){var f,p;return(p=(f=this.getWireContent())===null||f===void 0?void 0:f["m.relates_to"])===null||p===void 0?void 0:p.event_id}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}makeEncrypted(f,p,_,T){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=f,this.event.content=p,this.senderCurve25519Key=_,this.claimedEd25519Key=T}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){var f,p;return((p=(f=this.clearEvent)===null||f===void 0?void 0:f.content)===null||p===void 0?void 0:p.msgtype)==="m.bad.encrypted"}get isEncryptedDisabledForUnverifiedDevices(){return this.isDecryptionFailure()&&this.encryptedDisabledForUnverifiedDevices}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}attemptDecryption(f,p={}){return u(this,void 0,void 0,function*(){if(!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");const _=this.clearEvent&&!this.isDecryptionFailure(),T=p.forceRedecryptIfUntrusted&&this.isKeySourceUntrusted();if(_&&!T)throw new Error("Attempt to decrypt event which has already been decrypted");return this.decryptionPromise?(S.logger.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this.decryptionPromise):(this.decryptionPromise=this.decryptionLoop(f,p),this.decryptionPromise)})}cancelAndResendKeyRequest(f,p){const _=this.getWireContent();return f.requestRoomKey({algorithm:_.algorithm,room_id:this.getRoomId(),session_id:_.session_id,sender_key:_.sender_key},this.getKeyRequestRecipients(p),!0)}getKeyRequestRecipients(f){return[{userId:f,deviceId:"*"}]}decryptionLoop(f,p={}){return u(this,void 0,void 0,function*(){for(yield Promise.resolve();;){this.retryDecryption=!1;let _,T;try{f?(_=yield f.decryptEvent(this),p.isRetry===!0&&S.logger.info(`Decrypted event on retry (${this.getDetails()})`)):_=this.badEncryptedMessage("Encryption not enabled")}catch(w){const M=w instanceof b.DecryptionError?w.detailedString:String(w);if(T=w,this.retryDecryption){S.logger.log(`Error decrypting event (${this.getDetails()}), but retrying: ${M}`);continue}S.logger.warn(`Error decrypting event (${this.getDetails()}): ${M}`),_=this.badEncryptedMessage(String(w))}this.decryptionPromise=null,this.retryDecryption=!1,this.setClearData(_),this.setPushActions(null),p.emit!==!1&&this.emit(r.Decrypted,this,T);return}})}badEncryptedMessage(f){return{clearEvent:{type:y.EventType.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+f+" **"}},encryptedDisabledForUnverifiedDevices:f===`DecryptionError: ${a.WITHHELD_MESSAGES["m.unverified"]}`}}setClearData(f){var p,_;this.clearEvent=f.clearEvent,this.senderCurve25519Key=(p=f.senderCurve25519Key)!==null&&p!==void 0?p:null,this.claimedEd25519Key=(_=f.claimedEd25519Key)!==null&&_!==void 0?_:null,this.forwardingCurve25519KeyChain=f.forwardingCurve25519KeyChain||[],this.untrusted=f.untrusted||!1,this.encryptedDisabledForUnverifiedDevices=f.encryptedDisabledForUnverifiedDevices||!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===y.EventType.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(f){this.event.unsigned=f}unmarkLocallyRedacted(){const f=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!f}markLocallyRedacted(f){this._localRedactionEvent||(this.emit(r.BeforeRedaction,this,f),this._localRedactionEvent=f,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=f.event)}applyVisibilityEvent(f){var p,_;const T=(p=f==null?void 0:f.visible)!==null&&p!==void 0?p:!0,w=(_=f==null?void 0:f.reason)!==null&&_!==void 0?_:null;let M=!1;(this.visibility.visible!==T||!this.visibility.visible&&this.visibility.reason!==w)&&(M=!0),M&&(T?this.visibility=i:this.visibility=Object.freeze({visible:!1,reason:w}),this.emit(r.VisibilityChange,this,T))}messageVisibility(){return this.visibility}makeRedacted(f){if(!f.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(r.BeforeRedaction,this,f),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=f.event;for(const T in this.event)this.event.hasOwnProperty(T)&&!o.has(T)&&delete this.event[T];this.isEncrypted()&&(this.clearEvent=void 0);const p=this.getType()in l?l[this.getType()]:{},_=this.getContent();for(const T in _)_.hasOwnProperty(T)&&!p[T]&&delete _[T];this.invalidateExtensibleEvent()}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===y.EventType.RoomRedaction}asVisibilityChange(){if(!y.EVENT_VISIBILITY_CHANGE_TYPE.matches(this.getType()))return null;const f=this.getRelation();if(!f||f.rel_type!="m.reference")return null;const p=f.event_id;if(!p)return null;const _=this.getWireContent(),T=!!_.visible,w=_.reason;return w&&typeof w!="string"?null:{visible:T,reason:w,eventId:p}}isVisibilityEvent(){return y.EVENT_VISIBILITY_CHANGE_TYPE.matches(this.getType())}getRedactionEvent(){var f,p,_,T;return this.isRedacted()?!((f=this.clearEvent)===null||f===void 0)&&f.unsigned?(_=(p=this.clearEvent)===null||p===void 0?void 0:p.unsigned.redacted_because)!==null&&_!==void 0?_:null:!((T=this.event.unsigned)===null||T===void 0)&&T.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushActions}setPushActions(f){this.pushActions=f}handleRemoteEcho(f){const p=this.getUnsigned(),_=this.getId();this.event=f,p.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=p.redacted_because),this.setStatus(null),this.getId()!==_&&this.emit(r.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(f){this.status=f,this.emit(r.Status,this,f)}replaceLocalEventId(f){this.event.event_id=f,this.emit(r.LocalEventIdReplaced,this)}isRelation(f){var p;const _=(p=this.getWireContent())===null||p===void 0?void 0:p["m.relates_to"];return this.isState()&&(_==null?void 0:_.rel_type)===y.RelationType.Replace?!1:!!(_!=null&&_.rel_type&&_.event_id&&(!f||_.rel_type===f))}getRelation(){var f;return this.isRelation()&&(f=this.getWireContent()["m.relates_to"])!==null&&f!==void 0?f:null}makeReplaced(f){this.isRedacted()&&f||this.isState()||this._replacingEvent!==f&&(this._replacingEvent=f??null,this.emit(r.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(f){var p;return(p=this.getUnsigned()["m.relations"])===null||p===void 0?void 0:p[f]}replacingEventId(){const f=this.getServerAggregatedRelation(y.RelationType.Replace);if(f)return f.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){var f;const p=this.getServerAggregatedRelation(y.RelationType.Replace);if(p){const _=p.origin_server_ts;if(Number.isFinite(_))return new Date(_)}else if(this._replacingEvent)return(f=this._replacingEvent.getDate())!==null&&f!==void 0?f:void 0}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){const f=this.getRelation();if(this.replyEventId)return this.replyEventId;if(f)return f.event_id;if(this.isRedaction())return this.event.redacts}hasAssocation(){return!!this.getAssociatedId()}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(f){const p=this.getRelation();p?p.event_id=f:this.isRedaction()&&(this.event.redacts=f)}flagCancelled(f=!0){this._isCancelled=f}isCancelled(){return this._isCancelled}toSnapshot(){const f=new s(JSON.parse(JSON.stringify(this.event)));for(const[p,_]of Object.entries(this))p!=="event"&&(f[p]=_);return f}isEquivalentTo(f){if(!f)return!1;if(f===this)return!0;const p=(0,c.deepSortedObjectEntries)(this.event),_=(0,c.deepSortedObjectEntries)(f.event);return JSON.stringify(p)===JSON.stringify(_)}toJSON(){const f=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:f,encrypted:this.event}:f}setVerificationRequest(f){this.verificationRequest=f}setTxnId(f){this.txnId=f}getTxnId(){return this.txnId}setThread(f){this.thread&&this.reEmitter.stopReEmitting(this.thread,[m.ThreadEvent.Update]),this.thread=f,this.setThreadId(f==null?void 0:f.id),f&&this.reEmitter.reEmit(f,[m.ThreadEvent.Update])}getThread(){return this.thread}setThreadId(f){this.threadId=f}}e.MatrixEvent=s;const o=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),l={[y.EventType.RoomMember]:{membership:1},[y.EventType.RoomCreate]:{creator:1},[y.EventType.RoomJoinRules]:{join_rule:1},[y.EventType.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}}},{"../@types/event":306,"../ReEmitter":317,"../crypto/OlmDevice":327,"../crypto/algorithms":333,"../logger":374,"../utils":416,"./event-status":380,"./thread":394,"./typed-event-emitter":395,"matrix-events-sdk":167}],384:[function(t,E,e){var u=this&&this.__awaiter||function(b,a,n,i){function r(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function l(p){try{f(i.next(p))}catch(_){o(_)}}function v(p){try{f(i.throw(p))}catch(_){o(_)}}function f(p){p.done?s(p.value):r(p.value).then(l,v)}f((i=i.apply(b,a||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.IgnoredInvites=e.PolicyScope=e.IGNORE_INVITES_ACCOUNT_EVENT_KEY=e.POLICIES_ACCOUNT_EVENT_TYPE=void 0;const g=t("matrix-events-sdk"),S=t("./event-timeline"),y=t("../@types/partials"),c=t("../utils");e.POLICIES_ACCOUNT_EVENT_TYPE=new g.UnstableValue("m.policies","org.matrix.msc3847.policies"),e.IGNORE_INVITES_ACCOUNT_EVENT_KEY=new g.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites");var m;(function(b){b.Ban="m.ban"})(m||(m={}));var h;(function(b){b.User="m.policy.user",b.Room="m.policy.room",b.Server="m.policy.server"})(h=e.PolicyScope||(e.PolicyScope={}));class d{constructor(a){this.client=a}addRule(a,n,i){return u(this,void 0,void 0,function*(){const r=yield this.getOrCreateTargetRoom();return(yield this.client.sendStateEvent(r.roomId,a,{entity:n,reason:i,recommendation:m.Ban})).event_id})}removeRule(a){return u(this,void 0,void 0,function*(){yield this.client.redactEvent(a.getRoomId(),a.getId())})}addSource(a){return u(this,void 0,void 0,function*(){yield this.client.joinRoom(a);const n=(yield this.getOrCreateSourceRooms()).map(i=>i.roomId);return n.includes(a)?!1:(n.push(a),yield this.withIgnoreInvitesPolicies(i=>{i.sources=n}),!0)})}getRuleForInvite({sender:a,roomId:n}){return u(this,void 0,void 0,function*(){const i=yield this.getOrCreateSourceRooms(),r=a.split(":")[1],s=n.split(":")[1];for(const o of i){const l=o.getUnfilteredTimelineSet().getLiveTimeline().getState(S.EventTimeline.FORWARDS);for(const{scope:v,entities:f}of[{scope:h.Room,entities:[n]},{scope:h.User,entities:[a]},{scope:h.Server,entities:[r,s]}]){const p=l.getStateEvents(v);for(const _ of p){const T=_.getContent();if((T==null?void 0:T.recommendation)!=m.Ban)continue;const w=T==null?void 0:T.entity;if(!w)continue;let M;try{M=new RegExp((0,c.globToRegexp)(w,!1))}catch{continue}for(const A of f)if(A&&M.test(A))return _}}}return null})}getOrCreateTargetRoom(){return u(this,void 0,void 0,function*(){let n=this.getIgnoreInvitesPolicies().target;if(typeof n!="string"&&(n=null),n){const i=this.client.getRoom(n);if(i)return i;n=null}return n=(yield this.client.createRoom({name:"Individual Policy Room",preset:y.Preset.PrivateChat})).room_id,yield this.withIgnoreInvitesPolicies(i=>{i.target=n}),this.client.getRoom(n)})}getOrCreateSourceRooms(){return u(this,void 0,void 0,function*(){let n=this.getIgnoreInvitesPolicies().sources,i=!1;Array.isArray(n)||(i=!0,n=[]);let r=n.filter(s=>typeof s=="string").map(s=>this.client.getRoom(s)).filter(s=>!!s);if(r.length!=n.length&&(i=!0),r.length==0){const s=yield this.getOrCreateTargetRoom();i=!0,r=[s]}return i&&(yield this.withIgnoreInvitesPolicies(s=>{s.sources=n})),r})}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(a){return u(this,void 0,void 0,function*(){const{policies:n,ignoreInvitesPolicies:i}=this.getPoliciesAndIgnoreInvitesPolicies();a(i),n[e.IGNORE_INVITES_ACCOUNT_EVENT_KEY.name]=i,yield this.client.setAccountData(e.POLICIES_ACCOUNT_EVENT_TYPE.name,n)})}getPoliciesAndIgnoreInvitesPolicies(){var a;let n={};for(const s of[e.POLICIES_ACCOUNT_EVENT_TYPE.name,e.POLICIES_ACCOUNT_EVENT_TYPE.altName]){if(!s)continue;const o=(a=this.client.getAccountData(s))===null||a===void 0?void 0:a.getContent();if(o){n=o;break}}let i={},r=!1;for(const s of[e.IGNORE_INVITES_ACCOUNT_EVENT_KEY.name,e.IGNORE_INVITES_ACCOUNT_EVENT_KEY.altName]){if(!s)continue;const o=n[s];if(o&&typeof o=="object"){i=o,r=!0;break}}return r||(n[e.IGNORE_INVITES_ACCOUNT_EVENT_KEY.name]=i),{policies:n,ignoreInvitesPolicies:i}}}e.IgnoredInvites=d},{"../@types/partials":309,"../utils":416,"./event-timeline":382,"matrix-events-sdk":167}],385:[function(t,E,e){var u=this&&this.__awaiter||function(d,b,a,n){function i(r){return r instanceof a?r:new a(function(s){s(r)})}return new(a||(a=Promise))(function(r,s){function o(f){try{v(n.next(f))}catch(p){s(p)}}function l(f){try{v(n.throw(f))}catch(p){s(p)}}function v(f){f.done?r(f.value):i(f.value).then(o,l)}v((n=n.apply(d,b||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.Poll=e.PollEvent=void 0;const g=t("../@types/polls"),S=t("./relations"),y=t("./typed-event-emitter");var c;(function(d){d.New="Poll.new",d.End="Poll.end",d.Update="Poll.update",d.Responses="Poll.Responses",d.Destroy="Poll.Destroy",d.UndecryptableRelations="Poll.UndecryptableRelations"})(c=e.PollEvent||(e.PollEvent={}));const m=(d,b)=>({responseEvents:d.filter(n=>{if(!n.isDecryptionFailure())return g.M_POLL_RESPONSE.matches(n.getType())&&n.getTs()<=b})});class h extends y.TypedEventEmitter{constructor(b,a,n){if(super(),this.rootEvent=b,this.matrixClient=a,this.room=n,this._isFetchingResponses=!1,this.responses=null,this.undecryptableRelationEventIds=new Set,this.countUndecryptableEvents=i=>{const r=i.filter(o=>o.isDecryptionFailure()).map(o=>o.getId()),s=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...r]),this.undecryptableRelationsCount!==s&&this.emit(c.UndecryptableRelations,this.undecryptableRelationsCount)},!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var b;return(b=this.endEvent)===null||b===void 0?void 0:b.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){return u(this,void 0,void 0,function*(){return this.responses?this.responses:(this.isFetchingResponses||(yield this.fetchResponses()),this.responses)})}onNewRelation(b){var a;if(g.M_POLL_END.matches(b.getType())&&this.validateEndEvent(b)&&(this.endEvent=b,this.refilterResponsesOnEnd(),this.emit(c.End)),!this.responses)return;const n=((a=this.endEvent)===null||a===void 0?void 0:a.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:i}=m([b],n);this.countUndecryptableEvents([b]),i.length&&(i.forEach(r=>{this.responses.addEvent(r)}),this.emit(c.Responses,this.responses))}fetchResponses(){var b,a;return u(this,void 0,void 0,function*(){this._isFetchingResponses=!0;const n=yield this.matrixClient.relations(this.roomId,this.rootEvent.getId(),"m.reference",void 0,{from:this.relationsNextBatch||void 0});yield Promise.all(n.events.map(l=>this.matrixClient.decryptEventIfNeeded(l)));const i=this.responses||new S.Relations("m.reference",g.M_POLL_RESPONSE.name,this.matrixClient,[g.M_POLL_RESPONSE.altName]),r=n.events.find(l=>g.M_POLL_END.matches(l.getType()));this.validateEndEvent(r)&&(this.endEvent=r,this.refilterResponsesOnEnd(),this.emit(c.End));const s=((b=this.endEvent)===null||b===void 0?void 0:b.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:o}=m(n.events,s);o.forEach(l=>{i.addEvent(l)}),this.relationsNextBatch=(a=n.nextBatch)!==null&&a!==void 0?a:void 0,this.responses=i,this.countUndecryptableEvents(n.events),this.relationsNextBatch?this.fetchResponses():this._isFetchingResponses=!1,this.emit(c.Responses,this.responses)})}refilterResponsesOnEnd(){var b;if(!this.responses)return;const a=((b=this.endEvent)===null||b===void 0?void 0:b.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(n=>{var i;n.getTs()>a&&((i=this.responses)===null||i===void 0||i.removeEvent(n))}),this.emit(c.Responses,this.responses)}validateEndEvent(b){if(!b||this.endEvent&&this.endEvent.getTs()<b.getTs())return!1;const a=this.room.currentState,n=b.getSender();return!!n&&(n===this.rootEvent.getSender()||a.maySendRedactionForEvent(this.rootEvent,n))}}e.Poll=h},{"../@types/polls":310,"./relations":388,"./typed-event-emitter":395}],386:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(o,l,v,f){f===void 0&&(f=v);var p=Object.getOwnPropertyDescriptor(l,v);(!p||("get"in p?!l.__esModule:p.writable||p.configurable))&&(p={enumerable:!0,get:function(){return l[v]}}),Object.defineProperty(o,f,p)}:function(o,l,v,f){f===void 0&&(f=v),o[f]=l[v]}),g=this&&this.__setModuleDefault||(Object.create?function(o,l){Object.defineProperty(o,"default",{enumerable:!0,value:l})}:function(o,l){o.default=l}),S=this&&this.__importStar||function(o){if(o&&o.__esModule)return o;var l={};if(o!=null)for(var v in o)v!=="default"&&Object.prototype.hasOwnProperty.call(o,v)&&u(l,o,v);return g(l,o),l};Object.defineProperty(e,"__esModule",{value:!0}),e.ReadReceipt=e.synthesizeReceipt=void 0;const y=t("../@types/read_receipts"),c=t("./typed-event-emitter"),m=S(t("../utils")),h=t("./event"),d=t("../@types/event"),b=t("../utils"),a=t("./room");function n(o,l,v){var f;return new h.MatrixEvent({content:{[l.getId()]:{[v]:{[o]:{ts:l.getTs(),thread_id:(f=l.threadRootId)!==null&&f!==void 0?f:y.MAIN_ROOM_TIMELINE}}}},type:d.EventType.Receipt,room_id:l.getRoomId()})}e.synthesizeReceipt=n;const i=0,r=1;class s extends c.TypedEventEmitter{constructor(){super(...arguments),this.receipts=new b.MapWithDefault(()=>new Map),this.receiptCacheByEventId=new Map}getReadReceiptForUserId(l,v=!1,f=y.ReceiptType.Read){var p,_;const[T,w]=(_=(p=this.receipts.get(f))===null||p===void 0?void 0:p.get(l))!==null&&_!==void 0?_:[null,null];return v?T:w??T}getEventReadUpTo(l,v=!1){var f,p,_,T,w,M,A;const W=this.getUnfilteredTimelineSet(),ee=this.getReadReceiptForUserId(l,v,y.ReceiptType.Read),F=this.getReadReceiptForUserId(l,v,y.ReceiptType.ReadPrivate);let C;return ee!=null&&ee.eventId&&(F!=null&&F.eventId)&&(C=W.compareEventOrdering(ee==null?void 0:ee.eventId,F==null?void 0:F.eventId)),!C&&(!((f=ee==null?void 0:ee.data)===null||f===void 0)&&f.ts)&&(!((p=F==null?void 0:F.data)===null||p===void 0)&&p.ts)&&(C=((_=ee==null?void 0:ee.data)===null||_===void 0?void 0:_.ts)-((T=F==null?void 0:F.data)===null||T===void 0?void 0:T.ts)),C?(A=C<0?F==null?void 0:F.eventId:ee==null?void 0:ee.eventId)!==null&&A!==void 0?A:null:(M=(w=F==null?void 0:F.eventId)!==null&&w!==void 0?w:ee==null?void 0:ee.eventId)!==null&&M!==void 0?M:null}addReceiptToStructure(l,v,f,p,_){var T,w,M;const A=this.receipts.getOrCreate(v);let W=A.get(f);W||(W=[null,null],A.set(f,W));let ee=W[i];if(_&&(ee=(T=W[r])!==null&&T!==void 0?T:W[i]),ee){const q=this.getUnfilteredTimelineSet().compareEventOrdering(ee.eventId,l);if(q!==null&&q>=0)return}const F={eventId:l,data:p},C=_?W[i]:F,O=_?F:W[r];let I=null;C&&O&&(I=this.getUnfilteredTimelineSet().compareEventOrdering(C.eventId,O.eventId));const D=I===null||I<0,j=(w=W[r])!==null&&w!==void 0?w:W[i];_&&D?W[r]=F:_||(W[i]=F,D||(W[r]=null));const Y=(M=W[r])!==null&&M!==void 0?M:W[i];if(j!==Y){if(j&&this.receiptCacheByEventId.get(j.eventId)){const q=j.eventId;this.receiptCacheByEventId.set(q,this.receiptCacheByEventId.get(q).filter(B=>B.type!==v||B.userId!==f)),this.receiptCacheByEventId.get(q).length<1&&this.receiptCacheByEventId.delete(q)}this.receiptCacheByEventId.get(l)||this.receiptCacheByEventId.set(l,[]),this.receiptCacheByEventId.get(l).push({userId:f,type:v,data:p})}}getReceiptsForEvent(l){return this.receiptCacheByEventId.get(l.getId())||[]}fixupNotifications(l){const v=this.getReadReceiptForUserId(l,!1),f=this.timeline[this.timeline.length-1];f&&(v==null?void 0:v.eventId)===f.getId()&&l===f.getSender()&&(this.setUnread(a.NotificationCountType.Total,0),this.setUnread(a.NotificationCountType.Highlight,0))}addLocalEchoReceipt(l,v,f){this.addReceipt(n(l,v,f),!0)}getUsersReadUpTo(l){return this.getReceiptsForEvent(l).filter(function(v){return m.isSupportedReceiptType(v.type)}).map(function(v){return v.userId})}hasUserReadEvent(l,v){var f,p;const _=this.getEventReadUpTo(l,!1);if(_===v||!((f=this.timeline)===null||f===void 0)&&f.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===l)return!0;for(let T=((p=this.timeline)===null||p===void 0?void 0:p.length)-1;T>=0;--T){const w=this.timeline[T];if(w.getId()===v)return!1;if(w.getId()===_)return!0}return!1}}e.ReadReceipt=s},{"../@types/event":306,"../@types/read_receipts":311,"../utils":416,"./event":383,"./room":392,"./typed-event-emitter":395}],387:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.RelationsContainer=void 0;const u=t("./relations"),g=t("./event");class S{constructor(c,m){this.client=c,this.room=m,this.relations=new Map}getChildEventsForEvent(c,m,h){var d,b;return(b=(d=this.relations.get(c))===null||d===void 0?void 0:d.get(m))===null||b===void 0?void 0:b.get(h)}getAllChildEventsForEvent(c){var m;const h=(m=this.relations.get(c))!==null&&m!==void 0?m:new Map,d=[];for(const b of h.values())for(const a of b.values())d.push(...a.getRelations());return d}aggregateParentEvent(c){const m=this.relations.get(c.getId());if(m)for(const h of m.values())for(const d of h.values())d.setTargetEvent(c)}aggregateChildEvent(c,m){var h,d,b;if(c.isRedacted()||c.status===g.EventStatus.CANCELLED)return;const a=c.getRelation();if(!a)return;const n=()=>{if(c.isDecryptionFailure()){c.once(g.MatrixEventEvent.Decrypted,n);return}this.aggregateChildEvent(c,m)};if(c.isBeingDecrypted()||c.shouldAttemptDecryption()){c.once(g.MatrixEventEvent.Decrypted,n);return}const{event_id:i,rel_type:r}=a,s=c.getType();let o=this.relations.get(i);o||(o=new Map,this.relations.set(i,o));let l=o.get(r);l||(l=new Map,o.set(r,l));let v=l.get(s);if(!v){v=new u.Relations(r,s,this.client),l.set(s,v);const f=(h=this.room)!==null&&h!==void 0?h:m==null?void 0:m.room,p=(b=(d=m==null?void 0:m.findEventById(i))!==null&&d!==void 0?d:f==null?void 0:f.findEventById(i))!==null&&b!==void 0?b:f==null?void 0:f.getPendingEvent(i);p&&v.setTargetEvent(p)}v.addEvent(c)}}e.RelationsContainer=S},{"./event":383,"./relations":388}],388:[function(t,E,e){var u=this&&this.__awaiter||function(a,n,i,r){function s(o){return o instanceof i?o:new i(function(l){l(o)})}return new(i||(i=Promise))(function(o,l){function v(_){try{p(r.next(_))}catch(T){l(T)}}function f(_){try{p(r.throw(_))}catch(T){l(T)}}function p(_){_.done?o(_.value):s(_.value).then(v,f)}p((r=r.apply(a,n||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.Relations=e.RelationsEvent=void 0;const g=t("./event"),S=t("../logger"),y=t("../@types/event"),c=t("./typed-event-emitter"),m=t("./room");var h;(function(a){a.Add="Relations.add",a.Remove="Relations.remove",a.Redaction="Relations.redaction"})(h=e.RelationsEvent||(e.RelationsEvent={}));const d=(a,n,i=[])=>[n,...i].includes(a);class b extends c.TypedEventEmitter{constructor(n,i,r,s){super(),this.relationType=n,this.eventType=i,this.altEventTypes=s,this.relationEventIds=new Set,this.relations=new Set,this.annotationsByKey={},this.annotationsBySender={},this.sortedAnnotationsByKey=[],this.targetEvent=null,this.creationEmitted=!1,this.onEventStatus=(o,l)=>{if(!o.isSending()){o.removeListener(g.MatrixEventEvent.Status,this.onEventStatus);return}l===g.EventStatus.CANCELLED&&(o.removeListener(g.MatrixEventEvent.Status,this.onEventStatus),this.removeEvent(o))},this.onBeforeRedaction=o=>u(this,void 0,void 0,function*(){if(this.relations.has(o)){if(this.relations.delete(o),this.relationType===y.RelationType.Annotation)this.removeAnnotationFromAggregation(o);else if(this.relationType===y.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){const l=yield this.getLastReplacement();this.targetEvent.makeReplaced(l)}o.removeListener(g.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.emit(h.Redaction,o)}}),this.client=r instanceof m.Room?r.client:r}addEvent(n){return u(this,void 0,void 0,function*(){if(this.relationEventIds.has(n.getId()))return;const i=n.getRelation();if(!i){S.logger.error("Event must have relation info");return}const r=i.rel_type,s=n.getType();if(this.relationType!==r||!d(s,this.eventType,this.altEventTypes)){S.logger.error("Event relation info doesn't match this container");return}if(n.isSending()&&n.on(g.MatrixEventEvent.Status,this.onEventStatus),this.relations.add(n),this.relationEventIds.add(n.getId()),this.relationType===y.RelationType.Annotation)this.addAnnotationToAggregation(n);else if(this.relationType===y.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){const o=yield this.getLastReplacement();this.targetEvent.makeReplaced(o)}n.on(g.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.emit(h.Add,n),this.maybeEmitCreated()})}removeEvent(n){return u(this,void 0,void 0,function*(){if(this.relations.has(n)){if(this.relations.delete(n),this.relationType===y.RelationType.Annotation)this.removeAnnotationFromAggregation(n);else if(this.relationType===y.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){const i=yield this.getLastReplacement();this.targetEvent.makeReplaced(i)}this.emit(h.Remove,n)}})}getRelations(){return[...this.relations]}addAnnotationToAggregation(n){var i;const{key:r}=(i=n.getRelation())!==null&&i!==void 0?i:{};if(!r)return;let s=this.annotationsByKey[r];s||(s=this.annotationsByKey[r]=new Set,this.sortedAnnotationsByKey.push([r,s])),s.add(n),this.sortedAnnotationsByKey.sort((v,f)=>{const p=v[1];return f[1].size-p.size});const o=n.getSender();let l=this.annotationsBySender[o];l||(l=this.annotationsBySender[o]=new Set),l.add(n)}removeAnnotationFromAggregation(n){var i;const{key:r}=(i=n.getRelation())!==null&&i!==void 0?i:{};if(!r)return;const s=this.annotationsByKey[r];s&&(s.delete(n),this.sortedAnnotationsByKey.sort((v,f)=>{const p=v[1];return f[1].size-p.size}));const o=n.getSender(),l=this.annotationsBySender[o];l&&l.delete(n)}getSortedAnnotationsByKey(){return this.relationType!==y.RelationType.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==y.RelationType.Annotation?null:this.annotationsBySender}getLastReplacement(){return u(this,void 0,void 0,function*(){if(this.relationType!==y.RelationType.Replace||!this.targetEvent)return null;const n=this.targetEvent.getServerAggregatedRelation(y.RelationType.Replace),i=n==null?void 0:n.origin_server_ts,r=this.getRelations().reduce((s,o)=>o.getSender()!==this.targetEvent.getSender()||i&&i>o.getTs()||s&&s.getTs()>o.getTs()?s:o,null);return r!=null&&r.shouldAttemptDecryption()&&this.client.isCryptoEnabled()?yield r.attemptDecryption(this.client.crypto):r!=null&&r.isBeingDecrypted()&&(yield r.getDecryptionPromise()),r})}setTargetEvent(n){return u(this,void 0,void 0,function*(){if(!this.targetEvent){if(this.targetEvent=n,this.relationType===y.RelationType.Replace&&!this.targetEvent.isState()){const i=yield this.getLastReplacement();i&&this.targetEvent.makeReplaced(i)}this.maybeEmitCreated()}})}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(g.MatrixEventEvent.RelationsCreated,this.relationType,this.eventType))}}e.Relations=b},{"../@types/event":306,"../logger":374,"./event":383,"./room":392,"./typed-event-emitter":395}],389:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(o,l,v,f){f===void 0&&(f=v);var p=Object.getOwnPropertyDescriptor(l,v);(!p||("get"in p?!l.__esModule:p.writable||p.configurable))&&(p={enumerable:!0,get:function(){return l[v]}}),Object.defineProperty(o,f,p)}:function(o,l,v,f){f===void 0&&(f=v),o[f]=l[v]}),g=this&&this.__setModuleDefault||(Object.create?function(o,l){Object.defineProperty(o,"default",{enumerable:!0,value:l})}:function(o,l){o.default=l}),S=this&&this.__importStar||function(o){if(o&&o.__esModule)return o;var l={};if(o!=null)for(var v in o)v!=="default"&&Object.prototype.hasOwnProperty.call(o,v)&&u(l,o,v);return g(l,o),l};Object.defineProperty(e,"__esModule",{value:!0}),e.RoomMember=e.RoomMemberEvent=void 0;const y=t("../content-repo"),c=S(t("../utils")),m=t("../logger"),h=t("./typed-event-emitter"),d=t("../@types/event");var b;(function(o){o.Membership="RoomMember.membership",o.Name="RoomMember.name",o.PowerLevel="RoomMember.powerLevel",o.Typing="RoomMember.typing"})(b=e.RoomMemberEvent||(e.RoomMemberEvent={}));class a extends h.TypedEventEmitter{constructor(l,v){super(),this.roomId=l,this.userId=v,this._isOutOfBand=!1,this.modified=-1,this.requestedProfileInfo=!1,this.typing=!1,this.powerLevel=0,this.powerLevelNorm=0,this.disambiguate=!1,this.events={},this.name=v,this.rawDisplayName=v,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(l,v){var f,p;const _=(f=l.getDirectionalContent().displayname)!==null&&f!==void 0?f:"";if(l.getType()!==d.EventType.RoomMember)return;this._isOutOfBand=!1,this.events.member=l;const T=this.membership;this.membership=l.getDirectionalContent().membership,this.membership===void 0&&m.logger.trace(`membership event with membership undefined (forwardLooking: ${l.forwardLooking})!`,l.getContent(),"prevcontent is ",l.getPrevContent()),this.disambiguate=r(this.userId,_,v);const w=this.name;this.name=s(this.userId,_,this.disambiguate),this.rawDisplayName=c.removeDirectionOverrideChars((p=l.getDirectionalContent().displayname)!==null&&p!==void 0?p:""),(!this.rawDisplayName||!c.removeHiddenChars(this.rawDisplayName))&&(this.rawDisplayName=this.userId),T!==this.membership&&(this.updateModifiedTime(),this.emit(b.Membership,l,this,T)),w!==this.name&&(this.updateModifiedTime(),this.emit(b.Name,l,this,w))}setPowerLevelEvent(l){if(l.getType()!==d.EventType.RoomPowerLevels||l.getStateKey()!=="")return;const v=l.getDirectionalContent();let f=v.users_default||0;const p=v.users||{};Object.values(p).forEach(w=>{f=Math.max(f,w)});const _=this.powerLevel,T=this.powerLevelNorm;p[this.userId]!==void 0&&Number.isInteger(p[this.userId])?this.powerLevel=p[this.userId]:v.users_default!==void 0?this.powerLevel=v.users_default:this.powerLevel=0,this.powerLevelNorm=0,f>0&&(this.powerLevelNorm=this.powerLevel*100/f),(_!==this.powerLevel||T!==this.powerLevelNorm)&&(this.updateModifiedTime(),this.emit(b.PowerLevel,l,this))}setTypingEvent(l){if(l.getType()!=="m.typing")return;const v=this.typing;this.typing=!1;const f=l.getContent().user_ids;Array.isArray(f)&&(f.indexOf(this.userId)!==-1&&(this.typing=!0),v!==this.typing&&(this.updateModifiedTime(),this.emit(b.Typing,l,this)))}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership==="leave"&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){const l=this.events.member;let v=l.getContent(),f=l.getSender();if(v.membership==="join"&&(v=l.getPrevContent(),f=l.getUnsigned().prev_sender),v.membership==="invite"&&v.is_direct)return f}}getAvatarUrl(l,v,f,p,_=!0,T){const w=this.getMxcAvatarUrl();if(!w&&!_)return null;const M=(0,y.getHttpUriForMxc)(l,w,v,f,p,T);return M||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}}e.RoomMember=a;const n=/@.+:.+/,i=/[\u200E\u200F\u202A-\u202F]/;function r(o,l,v){return!l||l===o||!c.removeHiddenChars(l)||!v?!1:!!(n.test(l)||i.test(l)||v.getUserIdsWithDisplayName(l).some(p=>p!==o))}function s(o,l,v){return!l||l===o?o:v?c.removeDirectionOverrideChars(l)+" ("+o+")":c.removeHiddenChars(l)?c.removeDirectionOverrideChars(l):o}},{"../@types/event":306,"../content-repo":323,"../logger":374,"../utils":416,"./typed-event-emitter":395}],390:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(f,p,_,T){T===void 0&&(T=_);var w=Object.getOwnPropertyDescriptor(p,_);(!w||("get"in w?!p.__esModule:w.writable||w.configurable))&&(w={enumerable:!0,get:function(){return p[_]}}),Object.defineProperty(f,T,w)}:function(f,p,_,T){T===void 0&&(T=_),f[T]=p[_]}),g=this&&this.__setModuleDefault||(Object.create?function(f,p){Object.defineProperty(f,"default",{enumerable:!0,value:p})}:function(f,p){f.default=p}),S=this&&this.__importStar||function(f){if(f&&f.__esModule)return f;var p={};if(f!=null)for(var _ in f)_!=="default"&&Object.prototype.hasOwnProperty.call(f,_)&&u(p,f,_);return g(p,f),p},y=this&&this.__awaiter||function(f,p,_,T){function w(M){return M instanceof _?M:new _(function(A){A(M)})}return new(_||(_=Promise))(function(M,A){function W(C){try{F(T.next(C))}catch(O){A(O)}}function ee(C){try{F(T.throw(C))}catch(O){A(O)}}function F(C){C.done?M(C.value):w(C.value).then(W,ee)}F((T=T.apply(f,p||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.RoomState=e.RoomStateEvent=void 0;const c=t("./room-member"),m=t("../logger"),h=S(t("../utils")),d=t("../@types/event"),b=t("./event"),a=t("../@types/partials"),n=t("./typed-event-emitter"),i=t("./beacon"),r=t("../ReEmitter"),s=t("../@types/beacon");var o;(function(f){f[f.NotStarted=0]="NotStarted",f[f.InProgress=1]="InProgress",f[f.Finished=2]="Finished"})(o||(o={}));var l;(function(f){f.Events="RoomState.events",f.Members="RoomState.members",f.NewMember="RoomState.newMember",f.Update="RoomState.update",f.BeaconLiveness="RoomState.BeaconLiveness",f.Marker="RoomState.Marker"})(l=e.RoomStateEvent||(e.RoomStateEvent={}));class v extends n.TypedEventEmitter{constructor(p,_={status:o.NotStarted}){super(),this.roomId=p,this.oobMemberFlags=_,this.reEmitter=new r.TypedReEmitter(this),this.sentinels={},this.displayNameToUserIds=new Map,this.userIdsToDisplayNames={},this.tokenToInvite={},this.joinedMemberCount=null,this.summaryJoinedMemberCount=null,this.invitedMemberCount=null,this.summaryInvitedMemberCount=null,this.modified=-1,this.members={},this.events=new Map,this.paginationToken=null,this.beacons=new Map,this._liveBeaconIds=[],this.updateModifiedTime()}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((p,_)=>_.membership==="join"?p+1:p,0)),this.joinedMemberCount)}setJoinedMemberCount(p){this.summaryJoinedMemberCount=p}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((p,_)=>_.membership==="invite"?p+1:p,0)),this.invitedMemberCount)}setInvitedMemberCount(p){this.summaryInvitedMemberCount=p}getMembers(){return Object.values(this.members)}getMembersExcept(p){return this.getMembers().filter(_=>!p.includes(_.userId))}getMember(p){return this.members[p]||null}getSentinelMember(p){if(!p)return null;let _=this.sentinels[p];if(_===void 0){_=new c.RoomMember(this.roomId,p);const T=this.members[p];T!=null&&T.events.member&&_.setMembershipEvent(T.events.member,this),this.sentinels[p]=_}return _}getStateEvents(p,_){if(!this.events.has(p))return _===void 0?[]:null;if(_===void 0)return Array.from(this.events.get(p).values());const T=this.events.get(p).get(_);return T||null}get hasLiveBeacons(){var p;return!!(!((p=this.liveBeaconIds)===null||p===void 0)&&p.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){const p=new v(this.roomId,this.oobMemberFlags),_=this.oobMemberFlags.status;return this.oobMemberFlags.status=o.NotStarted,Array.from(this.events.values()).forEach(T=>{p.setStateEvents(Array.from(T.values()))}),this.oobMemberFlags.status=_,this.summaryInvitedMemberCount!==null&&p.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&p.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==o.Finished&&this.getMembers().forEach(T=>{var w;T.isOutOfBand()&&((w=p.getMember(T.userId))===null||w===void 0||w.markOutOfBand())}),p}setUnknownStateEvents(p){const _=p.filter(T=>!this.events.has(T.getType())||!this.events.get(T.getType()).has(T.getStateKey()));this.setStateEvents(_)}setStateEvents(p,_){this.updateModifiedTime(),p.forEach(T=>{var w;if(T.getRoomId()!==this.roomId||!T.isState())return;s.M_BEACON_INFO.matches(T.getType())&&this.setBeacon(T);const M=this.getStateEventMatching(T);this.setStateEvent(T),T.getType()===d.EventType.RoomMember&&(this.updateDisplayNameCache(T.getStateKey(),(w=T.getContent().displayname)!==null&&w!==void 0?w:""),this.updateThirdPartyTokenCache(T)),this.emit(l.Events,T,this,M)}),this.onBeaconLivenessChange(),p.forEach(T=>{if(!(T.getRoomId()!==this.roomId||!T.isState()))if(T.getType()===d.EventType.RoomMember){const w=T.getStateKey();(T.getContent().membership==="leave"||T.getContent().membership==="ban")&&(T.getContent().avatar_url=T.getContent().avatar_url||T.getPrevContent().avatar_url,T.getContent().displayname=T.getContent().displayname||T.getPrevContent().displayname);const M=this.getOrCreateMember(w,T);M.setMembershipEvent(T,this),this.updateMember(M),this.emit(l.Members,T,this,M)}else if(T.getType()===d.EventType.RoomPowerLevels){if(T.getStateKey()!=="")return;Object.values(this.members).forEach(M=>{const A=M.getLastModifiedTime();M.setPowerLevelEvent(T),A!==M.getLastModifiedTime()&&this.emit(l.Members,T,this,M)}),this.sentinels={}}else d.UNSTABLE_MSC2716_MARKER.matches(T.getType())&&this.emit(l.Marker,T,_)}),this.emit(l.Update,this)}processBeaconEvents(p,_){var T;return y(this,void 0,void 0,function*(){if(!p.length||!this.beacons.size)return;const w=[...this.beacons.values()].reduce((A,W)=>(A[W.beaconInfoId]=W,A),{}),M=(A,W)=>{if(!s.M_BEACON.matches(W.getType()))return;const ee=w[A];ee&&ee.addLocations([W])};for(const A of p){const W=(T=A.getRelation())===null||T===void 0?void 0:T.event_id;if(!W||!w[W]||!s.M_BEACON.matches(A.getType())&&!A.isEncrypted())return;try{yield _.decryptEventIfNeeded(A),M(W,A)}catch{A.isDecryptionFailure()&&A.once(b.MatrixEventEvent.Decrypted,()=>y(this,void 0,void 0,function*(){M(W,A)}))}}})}getOrCreateMember(p,_){let T=this.members[p];return T||(T=new c.RoomMember(this.roomId,p),this.members[p]=T,this.emit(l.NewMember,_,this,T)),T}setStateEvent(p){this.events.has(p.getType())||this.events.set(p.getType(),new Map),this.events.get(p.getType()).set(p.getStateKey(),p)}setBeacon(p){var _;const T=(0,i.getBeaconInfoIdentifier)(p);if(this.beacons.has(T)){const M=this.beacons.get(T);if(p.isRedacted()){M.beaconInfoId===((_=p.getRedactionEvent())===null||_===void 0?void 0:_.redacts)&&(M.destroy(),this.beacons.delete(T));return}return M.update(p)}if(p.isRedacted())return;const w=new i.Beacon(p);this.reEmitter.reEmit(w,[i.BeaconEvent.New,i.BeaconEvent.Update,i.BeaconEvent.Destroy,i.BeaconEvent.LivenessChange]),this.emit(i.BeaconEvent.New,p,w),w.on(i.BeaconEvent.LivenessChange,this.onBeaconLivenessChange.bind(this)),w.on(i.BeaconEvent.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(w.identifier,w)}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(p=>p.isLive).map(p=>p.identifier),this.emit(l.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(p){var _,T;return(T=(_=this.events.get(p.getType()))===null||_===void 0?void 0:_.get(p.getStateKey()))!==null&&T!==void 0?T:null}updateMember(p){const _=this.getStateEvents(d.EventType.RoomPowerLevels,"");_&&p.setPowerLevelEvent(_),delete this.sentinels[p.userId],this.members[p.userId]=p,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===o.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===o.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===o.NotStarted&&(this.oobMemberFlags.status=o.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===o.InProgress&&(this.oobMemberFlags.status=o.NotStarted)}clearOutOfBandMembers(){let p=0;Object.keys(this.members).forEach(_=>{this.members[_].isOutOfBand()&&(++p,delete this.members[_])}),m.logger.log(`LL: RoomState removed ${p} members...`),this.oobMemberFlags.status=o.NotStarted}setOutOfBandMembers(p){m.logger.log(`LL: RoomState about to set ${p.length} OOB members ...`),this.oobMemberFlags.status===o.InProgress&&(m.logger.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=o.Finished,p.forEach(_=>this.setOutOfBandMember(_)),this.emit(l.Update,this))}setOutOfBandMember(p){if(p.getType()!==d.EventType.RoomMember)return;const _=p.getStateKey(),T=this.getMember(_);if(T&&!T.isOutOfBand())return;const w=this.getOrCreateMember(_,p);w.setMembershipEvent(p,this),w.markOutOfBand(),this.updateDisplayNameCache(w.userId,w.name),this.setStateEvent(p),this.updateMember(w),this.emit(l.Members,p,this,w)}setTypingEvent(p){Object.values(this.members).forEach(function(_){_.setTypingEvent(p)})}getInviteForThreePidToken(p){return this.tokenToInvite[p]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(p){var _;return(_=this.displayNameToUserIds.get(h.removeHiddenChars(p)))!==null&&_!==void 0?_:[]}maySendRedactionForEvent(p,_){const T=this.getMember(_);if(!T||T.membership==="leave"||p.status||p.isRedacted())return!1;const w=this.maySendEvent(d.EventType.RoomRedaction,_);return p.getSender()===_?w:this.hasSufficientPowerLevelFor("redact",T.powerLevel)}hasSufficientPowerLevelFor(p,_){const T=this.getStateEvents(d.EventType.RoomPowerLevels,"");let w={};T&&(w=T.getContent());let M=50;return h.isNumber(w[p])&&(M=w[p]),_>=M}maySendMessage(p){return this.maySendEventOfType(d.EventType.RoomMessage,p,!1)}maySendEvent(p,_){return this.maySendEventOfType(p,_,!1)}mayClientSendStateEvent(p,_){return _.isGuest()||!_.credentials.userId?!1:this.maySendStateEvent(p,_.credentials.userId)}maySendStateEvent(p,_){return this.maySendEventOfType(p,_,!0)}maySendEventOfType(p,_,T){const w=this.getStateEvents(d.EventType.RoomPowerLevels,"");let M,A={},W=0,ee=0,F=0;if(w){M=w.getContent(),A=M.events||{},Number.isSafeInteger(M.state_default)?W=M.state_default:W=50;const O=M.users&&M.users[_];Number.isSafeInteger(O)?F=O:Number.isSafeInteger(M.users_default)&&(F=M.users_default),Number.isSafeInteger(M.events_default)&&(ee=M.events_default)}let C=T?W:ee;return Number.isSafeInteger(A[p])&&(C=A[p]),F>=C}mayTriggerNotifOfType(p,_){const T=this.getMember(_);if(!T)return!1;const w=this.getStateEvents(d.EventType.RoomPowerLevels,"");let M=50;return w&&w.getContent()&&w.getContent().notifications&&h.isNumber(w.getContent().notifications[p])&&(M=w.getContent().notifications[p]),T.powerLevel>=M}getJoinRule(){var p;const _=this.getStateEvents(d.EventType.RoomJoinRules,"");return((p=_==null?void 0:_.getContent())!==null&&p!==void 0?p:{}).join_rule||a.JoinRule.Invite}getHistoryVisibility(){var p;const _=this.getStateEvents(d.EventType.RoomHistoryVisibility,"");return((p=_==null?void 0:_.getContent())!==null&&p!==void 0?p:{}).history_visibility||a.HistoryVisibility.Shared}getGuestAccess(){var p;const _=this.getStateEvents(d.EventType.RoomGuestAccess,"");return((p=_==null?void 0:_.getContent())!==null&&p!==void 0?p:{}).guest_access||a.GuestAccess.Forbidden}findPredecessor(p=!1){if(p){const T=this.getStateEvents(d.EventType.RoomPredecessor,"");if(T){const w=T.getContent(),M=w.predecessor_room_id;let A=w.last_known_event_id;typeof A!="string"&&(A=void 0);let W=w.via_servers;if(Array.isArray(W)||(W=void 0),typeof M=="string")return{roomId:M,eventId:A,viaServers:W}}}const _=this.getStateEvents(d.EventType.RoomCreate,"");if(_){const T=_.getContent().predecessor;if(T){const w=T.room_id;if(typeof w=="string"){let M=T.event_id;return(typeof M!="string"||M==="")&&(M=void 0),{roomId:w,eventId:M}}}}return null}updateThirdPartyTokenCache(p){if(!p.getContent().third_party_invite)return;const _=(p.getContent().third_party_invite.signed||{}).token;!_||!this.getStateEvents(d.EventType.RoomThirdPartyInvite,_)||(this.tokenToInvite[_]=p)}updateDisplayNameCache(p,_){var T;const w=this.userIdsToDisplayNames[p];if(delete this.userIdsToDisplayNames[p],w){const A=h.removeHiddenChars(w),W=this.displayNameToUserIds.get(A);if(W){const ee=W.filter(F=>F!==p);this.displayNameToUserIds.set(A,ee)}}this.userIdsToDisplayNames[p]=_;const M=_&&h.removeHiddenChars(_);if(M){const A=(T=this.displayNameToUserIds.get(M))!==null&&T!==void 0?T:[];A.push(p),this.displayNameToUserIds.set(M,A)}}}e.RoomState=v},{"../@types/beacon":305,"../@types/event":306,"../@types/partials":309,"../ReEmitter":317,"../logger":374,"../utils":416,"./beacon":378,"./event":383,"./room-member":389,"./typed-event-emitter":395}],391:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.RoomSummary=void 0;class u{constructor(S,y){this.roomId=S}}e.RoomSummary=u},{}],392:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(B,R,k,P){P===void 0&&(P=k);var V=Object.getOwnPropertyDescriptor(R,k);(!V||("get"in V?!R.__esModule:V.writable||V.configurable))&&(V={enumerable:!0,get:function(){return R[k]}}),Object.defineProperty(B,P,V)}:function(B,R,k,P){P===void 0&&(P=k),B[P]=R[k]}),g=this&&this.__setModuleDefault||(Object.create?function(B,R){Object.defineProperty(B,"default",{enumerable:!0,value:R})}:function(B,R){B.default=R}),S=this&&this.__importStar||function(B){if(B&&B.__esModule)return B;var R={};if(B!=null)for(var k in B)k!=="default"&&Object.prototype.hasOwnProperty.call(B,k)&&u(R,B,k);return g(R,B),R},y=this&&this.__awaiter||function(B,R,k,P){function V(x){return x instanceof k?x:new k(function(Q){Q(x)})}return new(k||(k=Promise))(function(x,Q){function te(X){try{de(P.next(X))}catch($){Q($)}}function ae(X){try{de(P.throw(X))}catch($){Q($)}}function de(X){X.done?x(X.value):V(X.value).then(te,ae)}de((P=P.apply(B,R||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.RoomNameType=e.Room=e.RoomEvent=e.NotificationCountType=e.KNOWN_SAFE_ROOM_VERSION=void 0;const c=t("matrix-events-sdk"),m=t("./event-timeline-set"),h=t("./event-timeline"),d=t("../content-repo"),b=S(t("../utils")),a=t("../utils"),n=t("./event"),i=t("./event-status"),r=t("./room-member"),s=t("./room-summary"),o=t("../logger"),l=t("../ReEmitter"),v=t("../@types/event"),f=t("../client"),p=t("../filter"),_=t("./room-state"),T=t("./beacon"),w=t("./thread"),M=t("../@types/read_receipts"),A=t("./relations-container"),W=t("./read-receipt"),ee=t("./poll");e.KNOWN_SAFE_ROOM_VERSION="9";const F=["1","2","3","4","5","6","7","8","9"],C=30;var O;(function(B){B.Highlight="highlight",B.Total="total"})(O=e.NotificationCountType||(e.NotificationCountType={}));var I;(function(B){B.MyMembership="Room.myMembership",B.Tags="Room.tags",B.AccountData="Room.accountData",B.Receipt="Room.receipt",B.Name="Room.name",B.Redaction="Room.redaction",B.RedactionCancelled="Room.redactionCancelled",B.LocalEchoUpdated="Room.localEchoUpdated",B.Timeline="Room.timeline",B.TimelineReset="Room.timelineReset",B.TimelineRefresh="Room.TimelineRefresh",B.OldStateUpdated="Room.OldStateUpdated",B.CurrentStateUpdated="Room.CurrentStateUpdated",B.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",B.UnreadNotifications="Room.UnreadNotifications"})(I=e.RoomEvent||(e.RoomEvent={}));class D extends W.ReadReceipt{constructor(R,k,P,V={}){super(),this.roomId=R,this.client=k,this.myUserId=P,this.opts=V,this.txnToEvent=new Map,this.notificationCounts={},this.threadNotifications=new Map,this.cachedThreadReadReceipts=new Map,this.oldestThreadedReceiptTs=1/0,this.unthreadedReceipts=new Map,this.polls=new Map,this.threadsTimelineSets=[],this.filteredTimelineSets={},this.timelineNeedsRefresh=!1,this.summaryHeroes=null,this.getTypeWarning=!1,this.getVersionWarning=!1,this.tags={},this.accountData=new Map,this.summary=null,this.relations=new A.RelationsContainer(this.client,this),this.threads=new Map,this.visibilityEvents=new Map,this.threadTimelineSetsPromise=null,this.threadsReady=!1,this.updateThreadRootEvents=(x,Q,te)=>{var ae,de;x.length&&(this.updateThreadRootEvent((ae=this.threadsTimelineSets)===null||ae===void 0?void 0:ae[0],x,Q,te),x.hasCurrentUserParticipated&&this.updateThreadRootEvent((de=this.threadsTimelineSets)===null||de===void 0?void 0:de[1],x,Q,te))},this.updateThreadRootEvent=(x,Q,te,ae)=>{x&&Q.rootEvent&&(ae&&x.removeEvent(Q.id),w.Thread.hasServerSideSupport?x.addLiveEvent(Q.rootEvent,{duplicateStrategy:m.DuplicateStrategy.Replace,fromCache:!1,roomState:this.currentState}):x.addEventToTimeline(Q.rootEvent,x.getLiveTimeline(),{toStartOfTimeline:te}))},this.applyRedaction=x=>{if(x.isRedaction()){const Q=x.event.redacts,te=Q?this.findEventById(Q):void 0;if(te){if(te.makeRedacted(x),te.isState()){const ae=this.currentState.getStateEvents(te.getType(),te.getStateKey());(ae==null?void 0:ae.getId())===te.getId()&&this.currentState.setStateEvents([te])}this.emit(I.Redaction,x,this),this.visibilityEvents.delete(Q),te.isVisibilityEvent()&&this.redactVisibilityChangeEvent(x)}}},this.setMaxListeners(100),this.reEmitter=new l.TypedReEmitter(this),V.pendingEventOrdering=V.pendingEventOrdering||f.PendingEventOrdering.Chronological,this.name=R,this.normalizedName=R,this.timelineSets=[new m.EventTimelineSet(this,V)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[I.Timeline,I.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===f.PendingEventOrdering.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(x=>{const Q=this.client.getEventMapper({toDevice:!1,decrypt:!1});x.forEach(te=>y(this,void 0,void 0,function*(){const ae=Q(te);yield k.decryptEventIfNeeded(ae),ae.setStatus(i.EventStatus.NOT_SENT),this.addPendingEvent(ae,ae.getTxnId())}))})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var R;return y(this,void 0,void 0,function*(){if(this.threadTimelineSetsPromise)return this.threadTimelineSetsPromise;if(!((R=this.client)===null||R===void 0)&&R.supportsThreads())try{this.threadTimelineSetsPromise=Promise.all([this.createThreadTimelineSet(),this.createThreadTimelineSet(w.ThreadFilterType.My)]);const k=yield this.threadTimelineSetsPromise;return this.threadsTimelineSets.push(...k),k}catch{return this.threadTimelineSetsPromise=null,null}return null})}decryptCriticalEvents(){return y(this,void 0,void 0,function*(){if(!this.client.isCryptoEnabled())return;const R=this.getEventReadUpTo(this.client.getUserId(),!0),k=this.getLiveTimeline().getEvents(),P=k.findIndex(x=>x.event.event_id===R),V=k.slice(P).reverse().map(x=>this.client.decryptEventIfNeeded(x,{isRetry:!0}));yield Promise.allSettled(V)})}decryptAllEvents(){return y(this,void 0,void 0,function*(){if(!this.client.isCryptoEnabled())return;const R=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(k=>this.client.decryptEventIfNeeded(k,{isRetry:!0}));yield Promise.allSettled(R)})}getCreator(){var R;const k=this.currentState.getStateEvents(v.EventType.RoomCreate,"");return(R=k==null?void 0:k.getContent().creator)!==null&&R!==void 0?R:null}getVersion(){var R;const k=this.currentState.getStateEvents(v.EventType.RoomCreate,"");return k?(R=k.getContent().room_version)!==null&&R!==void 0?R:"1":(this.getVersionWarning||(o.logger.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}shouldUpgradeToVersion(){return F.includes(this.getVersion())?null:e.KNOWN_SAFE_ROOM_VERSION}getRecommendedVersion(){return y(this,void 0,void 0,function*(){let k=(yield this.client.getCapabilities())["m.room_versions"];if(!k){k={default:e.KNOWN_SAFE_ROOM_VERSION,available:{}};for(const V of F)k.available[V]=f.RoomVersionStability.Stable}let P=this.checkVersionAgainstCapability(k);if(P.urgent&&P.needsUpgrade)if(o.logger.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about."),k=(yield this.client.getCapabilities(!0))["m.room_versions"],k)P=this.checkVersionAgainstCapability(k);else return o.logger.warn("No room version capability - assuming upgrade required."),P;return P})}checkVersionAgainstCapability(R){const k=this.getVersion();o.logger.log(`[${this.roomId}] Current version: ${k}`),o.logger.log(`[${this.roomId}] Version capability: `,R);const P={version:k,needsUpgrade:!1,urgent:!1};return k===R.default||Object.keys(R.available).filter(x=>R.available[x]==="stable").includes(k)||(P.version=R.default,P.needsUpgrade=!0,P.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),P.urgent?o.logger.warn(`URGENT upgrade required on ${this.roomId}`):o.logger.warn(`Non-urgent upgrade required on ${this.roomId}`)),P}userMayUpgradeRoom(R){return this.currentState.maySendStateEvent(v.EventType.RoomTombstone,R)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(R){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);const k=b.removeElement(this.pendingEventList,function(P){return P.getId()==R},!1);return this.savePendingEvents(),k}hasPendingEvent(R){var k,P;return(P=(k=this.pendingEventList)===null||k===void 0?void 0:k.some(V=>V.getId()===R))!==null&&P!==void 0?P:!1}getPendingEvent(R){var k,P;return(P=(k=this.pendingEventList)===null||k===void 0?void 0:k.find(V=>V.getId()===R))!==null&&P!==void 0?P:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}getLastActiveTimestamp(){const k=this.getLiveTimeline().getEvents();return k.length?k[k.length-1].getTs():Number.MIN_SAFE_INTEGER}getMyMembership(){var R;return(R=this.selfMembership)!==null&&R!==void 0?R:"leave"}getDMInviter(){var R;const k=this.getMember(this.myUserId);if(k)return k.getDMInviter();if(this.selfMembership==="invite"&&this.getInvitedAndJoinedMemberCount()===2)return(R=this.summaryHeroes)===null||R===void 0?void 0:R[0]}guessDMUserId(){const R=this.getMember(this.myUserId);if(R){const V=R.getDMInviter();if(V)return V}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];const P=this.currentState.getMembers().find(V=>V.userId!==this.myUserId);return P?P.userId:this.myUserId}getAvatarFallbackMember(){if(this.getInvitedAndJoinedMemberCount()>2)return;const k=Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length;if(k){const V=this.summaryHeroes.map(x=>this.getMember(x)).find(x=>!!x);if(V)return V}const P=this.currentState.getMembers();if(P.length<=2){const V=P.find(x=>x.userId!==this.myUserId);if(V)return V}if(k){const V=this.summaryHeroes.map(x=>this.client.getUser(x)).find(x=>!!x);if(V){const x=new r.RoomMember(this.roomId,V.userId);return x.user=V,x}}}updateMyMembership(R){const k=this.selfMembership;this.selfMembership=R,k!==R&&(R==="leave"&&this.cleanupAfterLeaving(),this.emit(I.MyMembership,this,R,k))}loadMembersFromServer(){return y(this,void 0,void 0,function*(){const R=this.client.store.getSyncToken();return(yield this.client.members(this.roomId,void 0,"leave",R??void 0)).chunk})}loadMembers(){return y(this,void 0,void 0,function*(){let R=!1,k=yield this.client.store.getOutOfBandMembers(this.roomId);return(k===null||this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId))&&(R=!0,k=yield this.loadMembersFromServer(),o.logger.log(`LL: got ${k.length} members from server for room ${this.roomId}`)),{memberEvents:k.filter(a.noUnsafeEventProps).map(this.client.getEventMapper()),fromServer:R}})}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();const R=this.loadMembers().then(k=>(this.currentState.setOutOfBandMembers(k.memberEvents),k.fromServer)).catch(k=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),k});return R.then(k=>{if(k){const P=this.currentState.getMembers().filter(x=>x.isOutOfBand()).map(x=>{var Q;return(Q=x.events.member)===null||Q===void 0?void 0:Q.event});return o.logger.log(`LL: telling store to write ${P.length} members for room ${this.roomId}`),this.client.store.setOutOfBandMembers(this.roomId,P).catch(x=>{o.logger.log("LL: storing OOB room members failed, oh well",x)})}}).catch(k=>{o.logger.error(k)}),this.membersPromise=R,this.membersPromise}clearLoadedMembersIfNeeded(){return y(this,void 0,void 0,function*(){this.opts.lazyLoadMembers&&this.membersPromise&&(yield this.loadMembersIfNeeded(),yield this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=void 0)})}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(R=>{o.logger.error(`error after clearing loaded members from room ${this.roomId} after leaving`),o.logger.log(R)})}refreshLiveTimeline(){return y(this,void 0,void 0,function*(){const R=this.getLiveTimeline(),k=R.getPaginationToken(h.EventTimeline.FORWARDS),P=R.getPaginationToken(h.EventTimeline.BACKWARDS),V=R.getEvents(),x=V[V.length-1];o.logger.log(`[refreshLiveTimeline for ${this.roomId}] at mostRecentEventInTimeline=${x&&x.getId()} liveTimelineBefore=${R.toString()} forwardPaginationToken=${k} backwardPaginationToken=${P}`);const Q=this.getUnfilteredTimelineSet();let te;x?(this.resetLiveTimeline(null,null),this.emit(I.TimelineRefresh,this,Q),te=yield this.client.getEventTimeline(Q,x.getId())):te=yield this.client.getLatestTimeline(Q);const ae=Q.getLiveTimeline();!ae||ae.getPaginationToken(h.Direction.Forward)===null&&ae.getPaginationToken(h.Direction.Backward)===null&&ae.getEvents().length===0?(o.logger.log(`[refreshLiveTimeline for ${this.roomId}] using our new live timeline`),te.setPaginationToken(k,h.EventTimeline.FORWARDS),Q.setLiveTimeline(te),this.fixUpLegacyTimelineFields()):o.logger.log(`[refreshLiveTimeline for ${this.roomId}] \`/sync\` or some other request beat us to creating a new live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history.`),this.setTimelineNeedsRefresh(!1),this.emit(I.TimelineRefresh,this,Q)})}resetLiveTimeline(R,k){for(const P of this.timelineSets)P.resetLiveTimeline(R??void 0,k??void 0);for(const P of this.threads.values())P.resetLiveTimeline(R,k);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){const R=this.oldState,k=this.currentState;this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(h.EventTimeline.BACKWARDS),this.currentState=this.getLiveTimeline().getState(h.EventTimeline.FORWARDS),R!==this.oldState&&this.emit(I.OldStateUpdated,this,R,this.oldState),k!==this.currentState&&(this.emit(I.CurrentStateUpdated,this,k,this.currentState),this.reEmitter.stopReEmitting(k,[_.RoomStateEvent.Events,_.RoomStateEvent.Members,_.RoomStateEvent.NewMember,_.RoomStateEvent.Update,_.RoomStateEvent.Marker,T.BeaconEvent.New,T.BeaconEvent.Update,T.BeaconEvent.Destroy,T.BeaconEvent.LivenessChange]),this.reEmitter.reEmit(this.currentState,[_.RoomStateEvent.Events,_.RoomStateEvent.Members,_.RoomStateEvent.NewMember,_.RoomStateEvent.Update,_.RoomStateEvent.Marker,T.BeaconEvent.New,T.BeaconEvent.Update,T.BeaconEvent.Destroy,T.BeaconEvent.LivenessChange]))}hasUnverifiedDevices(){return y(this,void 0,void 0,function*(){if(!this.client.isRoomEncrypted(this.roomId))return!1;const R=yield this.getEncryptionTargetMembers();for(const k of R)if(this.client.getStoredDevicesForUser(k.userId).some(V=>V.isUnverified()))return!0;return!1})}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(R){const k=this.findEventById(R),P=this.findThreadForEvent(k);return P?P.timelineSet.getTimelineForEvent(R):this.getUnfilteredTimelineSet().getTimelineForEvent(R)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(R){this.timelineNeedsRefresh=R}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(R){let k=this.getUnfilteredTimelineSet().findEventById(R);if(!k){const P=this.getThreads();for(let V=0;V<P.length;V++)if(k=P[V].findEventById(R),k)return k}return k}getUnreadNotificationCount(R=O.Total){var k;let P=this.getRoomUnreadNotificationCount(R);for(const V of this.threadNotifications.values())P+=(k=V[R])!==null&&k!==void 0?k:0;return P}getUnreadCountForEventContext(R=O.Total,k){var P;return(P=!!k.threadRootId&&!k.isThreadRoot?this.getThreadUnreadNotificationCount(k.threadRootId,R):this.getRoomUnreadNotificationCount(R))!==null&&P!==void 0?P:0}getRoomUnreadNotificationCount(R=O.Total){var k;return(k=this.notificationCounts[R])!==null&&k!==void 0?k:0}getThreadUnreadNotificationCount(R,k=O.Total){var P,V;return(V=(P=this.threadNotifications.get(R))===null||P===void 0?void 0:P[k])!==null&&V!==void 0?V:0}hasThreadUnreadNotification(){var R,k;for(const P of this.threadNotifications.values())if(((R=P.highlight)!==null&&R!==void 0?R:0)>0||((k=P.total)!==null&&k!==void 0?k:0)>0)return!0;return!1}setThreadUnreadNotificationCount(R,k,P){var V,x;const Q=Object.assign({highlight:(V=this.threadNotifications.get(R))===null||V===void 0?void 0:V.highlight,total:(x=this.threadNotifications.get(R))===null||x===void 0?void 0:x.total},{[k]:P});this.threadNotifications.set(R,Q),this.emit(I.UnreadNotifications,Q,R)}get threadsAggregateNotificationType(){var R,k;let P=null;for(const V of this.threadNotifications.values()){if(((R=V.highlight)!==null&&R!==void 0?R:0)>0)return O.Highlight;((k=V.total)!==null&&k!==void 0?k:0)>0&&!P&&(P=O.Total)}return P}resetThreadUnreadNotificationCount(R){if(R)for(const[k]of this.threadNotifications)R.includes(k)||this.threadNotifications.delete(k);else this.threadNotifications.clear();this.emit(I.UnreadNotifications)}setUnreadNotificationCount(R,k){this.notificationCounts[R]=k,this.emit(I.UnreadNotifications,this.notificationCounts)}setUnread(R,k){return this.setUnreadNotificationCount(R,k)}setSummary(R){const k=R["m.heroes"],P=R["m.joined_member_count"],V=R["m.invited_member_count"];Number.isInteger(P)&&this.currentState.setJoinedMemberCount(P),Number.isInteger(V)&&this.currentState.setInvitedMemberCount(V),Array.isArray(k)&&(this.summaryHeroes=k.filter(x=>x!==this.myUserId))}setBlacklistUnverifiedDevices(R){this.blacklistUnverifiedDevices=R}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(R,k,P,V,x=!0){const Q=this.currentState.getStateEvents(v.EventType.RoomAvatar,"");if(!Q&&!x)return null;const te=Q?Q.getContent().url:null;return te?(0,d.getHttpUriForMxc)(R,te,k,P,V):null}getMxcAvatarUrl(){var R,k;return((k=(R=this.currentState.getStateEvents(v.EventType.RoomAvatar,""))===null||R===void 0?void 0:R.getContent())===null||k===void 0?void 0:k.url)||null}getCanonicalAlias(){const R=this.currentState.getStateEvents(v.EventType.RoomCanonicalAlias,"");return R&&R.getContent().alias||null}getAltAliases(){const R=this.currentState.getStateEvents(v.EventType.RoomCanonicalAlias,"");return R?R.getContent().alt_aliases||[]:[]}addEventsToTimeline(R,k,P,V){P.getTimelineSet().addEventsToTimeline(R,k,P,V)}getThread(R){var k;return(k=this.threads.get(R))!==null&&k!==void 0?k:null}getThreads(){return Array.from(this.threads.values())}getMember(R){return this.currentState.getMember(R)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership("join")}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(R){return this.currentState.getMembers().filter(function(k){return k.membership===R})}getEncryptionTargetMembers(){return y(this,void 0,void 0,function*(){yield this.loadMembersIfNeeded();let R=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(R=R.concat(this.getMembersWithMembership("invite"))),R})}shouldEncryptForInvitedMembers(){var R;const k=this.currentState.getStateEvents(v.EventType.RoomHistoryVisibility,"");return((R=k==null?void 0:k.getContent())===null||R===void 0?void 0:R.history_visibility)!=="joined"}getDefaultRoomName(R){return this.calculateRoomName(R,!0)}hasMembershipState(R,k){const P=this.getMember(R);return P?P.membership===k:!1}getOrCreateFilteredTimelineSet(R,{prepopulateTimeline:k=!0,useSyncEvents:P=!0,pendingEvents:V=!0}={}){if(this.filteredTimelineSets[R.filterId])return this.filteredTimelineSets[R.filterId];const x=Object.assign({filter:R,pendingEvents:V},this.opts),Q=new m.EventTimelineSet(this,x);this.reEmitter.reEmit(Q,[I.Timeline,I.TimelineReset]),P&&(this.filteredTimelineSets[R.filterId]=Q,this.timelineSets.push(Q));const te=this.getLiveTimeline();if(k){te.getEvents().forEach(function(de){Q.addLiveEvent(de)});let ae=te;for(;ae.getNeighbouringTimeline(h.EventTimeline.BACKWARDS);)ae=ae.getNeighbouringTimeline(h.EventTimeline.BACKWARDS);Q.getLiveTimeline().setPaginationToken(ae.getPaginationToken(h.EventTimeline.BACKWARDS),h.EventTimeline.BACKWARDS)}else if(P){const ae=te.getPaginationToken(h.Direction.Forward);Q.getLiveTimeline().setPaginationToken(ae,h.Direction.Backward)}return Q}getThreadListFilter(R=w.ThreadFilterType.All){return y(this,void 0,void 0,function*(){const k=this.client.getUserId(),P=new p.Filter(k),V={room:{timeline:{[w.FILTER_RELATED_BY_REL_TYPES.name]:[w.THREAD_RELATION_TYPE.name]}}};R===w.ThreadFilterType.My&&(V.room.timeline[w.FILTER_RELATED_BY_SENDERS.name]=[k]),P.setDefinition(V);const x=yield this.client.getOrCreateFilter(`THREAD_PANEL_${this.roomId}_${R}`,P);return P.filterId=x,P})}createThreadTimelineSet(R){return y(this,void 0,void 0,function*(){let k;if(w.Thread.hasServerSideListSupport)k=new m.EventTimelineSet(this,Object.assign(Object.assign({},this.opts),{pendingEvents:!1}),void 0,void 0,R??w.ThreadFilterType.All),this.reEmitter.reEmit(k,[I.Timeline,I.TimelineReset]);else if(w.Thread.hasServerSideSupport){const P=yield this.getThreadListFilter(R);k=this.getOrCreateFilteredTimelineSet(P,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else k=new m.EventTimelineSet(this,{pendingEvents:!1}),Array.from(this.threads).forEach(([,P])=>{if(P.length===0)return;const V=P.timeline.some(x=>x.getSender()===this.client.getUserId());(R!==w.ThreadFilterType.My||V)&&k.getLiveTimeline().addEvent(P.rootEvent,{toStartOfTimeline:!1})});return k})}processThreadRoots(R,k){for(const P of R)h.EventTimeline.setEventMetadata(P,this.currentState,k),this.getThread(P.getId())||this.createThread(P.getId(),P,[],k)}fetchRoomThreads(){var R,k;return y(this,void 0,void 0,function*(){if(!(this.threadsReady||!this.client.supportsThreads())){if(w.Thread.hasServerSideListSupport)yield Promise.all([this.fetchRoomThreadList(w.ThreadFilterType.All),this.fetchRoomThreadList(w.ThreadFilterType.My)]);else{const P=yield this.getThreadListFilter(),{chunk:V}=yield this.client.createMessagesRequest(this.roomId,"",Number.MAX_SAFE_INTEGER,h.Direction.Backward,P);if(!V.length)return;const x=V.map(this.client.getEventMapper()).sort((ae,de)=>{const X=ae.getServerAggregatedRelation(w.THREAD_RELATION_TYPE.name),$=de.getServerAggregatedRelation(w.THREAD_RELATION_TYPE.name);return X.latest_event.origin_server_ts-$.latest_event.origin_server_ts});let Q;const te=this.getLiveTimeline().getState(h.EventTimeline.FORWARDS);for(const ae of x){const de={duplicateStrategy:m.DuplicateStrategy.Ignore,fromCache:!1,roomState:te};(R=this.threadsTimelineSets[0])===null||R===void 0||R.addLiveEvent(ae,de);const X=ae.getServerAggregatedRelation(w.THREAD_RELATION_TYPE.name);X!=null&&X.current_user_participated&&((k=this.threadsTimelineSets[1])===null||k===void 0||k.addLiveEvent(ae,de),Q=ae)}this.processThreadRoots(x,!0),this.client.decryptEventIfNeeded(x[x.length-1]),Q&&this.client.decryptEventIfNeeded(Q)}this.on(w.ThreadEvent.NewReply,this.onThreadNewReply),this.on(w.ThreadEvent.Delete,this.onThreadDelete),this.threadsReady=!0}})}processPollEvents(R){return y(this,void 0,void 0,function*(){const k=x=>{if(c.M_POLL_START.matches(x.getType()))try{const Q=new ee.Poll(x,this.client,this);this.polls.set(x.getId(),Q),this.emit(ee.PollEvent.New,Q)}catch{}},P=x=>{const Q=x.relationEventId;if(Q&&this.polls.has(Q)){const te=this.polls.get(Q);te==null||te.onNewRelation(x)}},V=x=>{k(x),P(x)};for(const x of R)try{yield this.client.decryptEventIfNeeded(x),V(x)}catch{}})}fetchRoomThreadList(R){return y(this,void 0,void 0,function*(){const k=R===w.ThreadFilterType.My?this.threadsTimelineSets[1]:this.threadsTimelineSets[0],{chunk:P,end:V}=yield this.client.createThreadListMessagesRequest(this.roomId,null,void 0,h.Direction.Backward,k.threadListType,k.getFilter());if(k.getLiveTimeline().setPaginationToken(V??null,h.Direction.Backward),!P.length)return;const x=P.map(this.client.getEventMapper());this.processThreadRoots(x,!0);const Q=this.getLiveTimeline().getState(h.EventTimeline.FORWARDS);for(const te of x)k.addLiveEvent(te,{duplicateStrategy:m.DuplicateStrategy.Replace,fromCache:!1,roomState:Q})})}onThreadNewReply(R){this.updateThreadRootEvents(R,!1,!0)}onThreadDelete(R){var k;this.threads.delete(R.id);const P=this.getTimelineForEvent(R.id),V=(k=P==null?void 0:P.getEvents())===null||k===void 0?void 0:k.find(x=>x.getId()===R.id);V?R.clearEventMetadata(V):o.logger.debug("onThreadDelete: Could not find root event in room timeline");for(const x of this.threadsTimelineSets)x.removeEvent(R.id)}removeFilteredTimelineSet(R){const k=this.filteredTimelineSets[R.filterId];delete this.filteredTimelineSets[R.filterId];const P=this.timelineSets.indexOf(k);P>-1&&this.timelineSets.splice(P,1)}eventShouldLiveIn(R,k,P){var V,x;if(!(!((V=this.client)===null||V===void 0)&&V.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(R.isThreadRoot||P!=null&&P.has(R.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:R.getId()};if(R.isRelation(w.THREAD_RELATION_TYPE.name))return{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:R.threadRootId};const Q=R.getAssociatedId();let te;return Q&&(te=(x=this.findEventById(Q))!==null&&x!==void 0?x:k==null?void 0:k.find(ae=>ae.getId()===Q)),te&&(R.isRelation()||R.isRedaction())?this.eventShouldLiveIn(te,k,P):P!=null&&P.has(R.relationEventId)?{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:R.relationEventId}:{shouldLiveInRoom:!0,shouldLiveInThread:!1}}findThreadForEvent(R){if(!R)return null;const{threadId:k}=this.eventShouldLiveIn(R);return k?this.getThread(k):null}addThreadedEvents(R,k,P=!1){var V;let x=this.getThread(R);if(!x){const Q=(V=this.findEventById(R))!==null&&V!==void 0?V:k.find(te=>te.getId()===R);x=this.createThread(R,Q,k,P)}x.addEvents(k,P)}processThreadedEvents(R,k){var P;R.forEach(this.applyRedaction);const V={};for(const x of R){const{threadId:Q,shouldLiveInThread:te}=this.eventShouldLiveIn(x);te&&!V[Q]&&(V[Q]=[]),(P=V[Q])===null||P===void 0||P.push(x)}Object.entries(V).map(([x,Q])=>this.addThreadedEvents(x,Q,k))}createThread(R,k,P=[],V){var x,Q,te;if(this.threads.has(R))return this.threads.get(R);if(k){const X=this.relations.getAllChildEventsForEvent(k.getId());X!=null&&X.length&&(P=P.concat(X.filter($=>!$.isRelation(v.RelationType.Replace))))}const ae=new w.Thread(R,k,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:(x=this.cachedThreadReadReceipts.get(R))!==null&&x!==void 0?x:[]});this.cachedThreadReadReceipts.delete(R),this.threads.set(ae.id,ae),ae.addEvents(P,!1),this.reEmitter.reEmit(ae,[w.ThreadEvent.Delete,w.ThreadEvent.Update,w.ThreadEvent.NewReply,I.Timeline,I.TimelineReset]);const de=((Q=this.lastThread)===null||Q===void 0?void 0:Q.rootEvent)&&(k==null?void 0:k.localTimestamp)&&((te=this.lastThread.rootEvent)===null||te===void 0?void 0:te.localTimestamp)<(k==null?void 0:k.localTimestamp);return(!this.lastThread||de)&&(this.lastThread=ae),this.threadsReady&&this.updateThreadRootEvents(ae,V,!1),this.emit(w.ThreadEvent.New,ae,V),ae}processLiveEvent(R){if(this.applyRedaction(R),R.isVisibilityEvent()&&this.applyNewVisibilityEvent(R),this.applyPendingVisibilityEvents(R),!R.getUnsigned().transaction_id&&R.getSender()===this.myUserId){for(const[P,V]of this.txnToEvent)if(V.getId()===R.getId()){o.logger.debug("processLiveEvent: found sent event without txn ID: ",P,R.getId());const x=R.getUnsigned();x.transaction_id=P,R.setUnsigned(x);break}}}addLiveEvent(R,k){const{duplicateStrategy:P,timelineWasEmpty:V,fromCache:x}=k;for(const Q of this.timelineSets)Q.addLiveEvent(R,{duplicateStrategy:P,fromCache:x,timelineWasEmpty:V});R.sender&&R.getType()!==v.EventType.RoomRedaction&&this.addReceipt((0,W.synthesizeReceipt)(R.sender.userId,R,M.ReceiptType.Read),!0)}addPendingEvent(R,k){if(R.status!==i.EventStatus.SENDING&&R.status!==i.EventStatus.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+R.status);if(this.txnToEvent.get(k))throw new Error("addPendingEvent called on an event with known txnId "+k);if(h.EventTimeline.setEventMetadata(R,this.getLiveTimeline().getState(h.EventTimeline.FORWARDS),!1),this.txnToEvent.set(k,R),this.pendingEventList){if(this.pendingEventList.some(P=>P.status===i.EventStatus.NOT_SENT)&&(o.logger.warn("Setting event as NOT_SENT due to messages in the same state"),R.setStatus(i.EventStatus.NOT_SENT)),this.pendingEventList.push(R),this.savePendingEvents(),R.isRelation()&&this.aggregateNonLiveRelation(R),R.isRedaction()){const P=R.event.redacts;let V=this.pendingEventList.find(x=>x.getId()===P);!V&&P&&(V=this.findEventById(P)),V&&(V.markLocallyRedacted(R),this.emit(I.Redaction,R,this))}}else for(const P of this.timelineSets)P.getFilter()?P.getFilter().filterRoomTimeline([R]).length&&P.addEventToTimeline(R,P.getLiveTimeline(),{toStartOfTimeline:!1}):P.addEventToTimeline(R,P.getLiveTimeline(),{toStartOfTimeline:!1});this.emit(I.LocalEchoUpdated,R,this)}savePendingEvents(){if(this.pendingEventList){const R=this.pendingEventList.map(k=>Object.assign(Object.assign({},k.event),{txn_id:k.getTxnId()})).filter(k=>{const P=k.type===v.EventType.RoomMessageEncrypted,V=this.client.isRoomEncrypted(this.roomId);return P||!V});this.client.store.setPendingEvents(this.roomId,R)}}aggregateNonLiveRelation(R){this.relations.aggregateChildEvent(R)}getEventForTxnId(R){return this.txnToEvent.get(R)}handleRemoteEcho(R,k){const P=k.getId(),V=R.getId(),x=k.status;o.logger.debug(`Got remote echo for event ${P} -> ${V} old status ${x}`),this.txnToEvent.delete(R.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(P),k.handleRemoteEcho(R.event);const{shouldLiveInRoom:Q,threadId:te}=this.eventShouldLiveIn(R),ae=te?this.getThread(te):null;if(ae==null||ae.setEventMetadata(k),ae==null||ae.timelineSet.handleRemoteEcho(k,P,V),Q)for(const de of this.timelineSets)de.handleRemoteEcho(k,P,V);this.emit(I.LocalEchoUpdated,k,this,P,x)}updatePendingEvent(R,k,P){if(o.logger.log(`setting pendingEvent status to ${k} in ${R.getRoomId()} event ID ${R.getId()} -> ${P}`),k==i.EventStatus.SENT&&!P)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(k==i.EventStatus.SENT&&this.getTimelineForEvent(P)){const ae=this.findEventById(P);if(!(ae==null?void 0:ae.getUnsigned().transaction_id)&&ae){const X=ae.getUnsigned();X.transaction_id=R.getTxnId(),ae.setUnsigned(X),this.removeEvent(ae.getId()),this.handleRemoteEcho(ae,R)}return}const V=R.status,x=R.getId();if(!V)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const Q=j[V];if(!(Q!=null&&Q.includes(k)))throw new Error(`Invalid EventStatus transition ${V}->${k}`);if(R.setStatus(k),k==i.EventStatus.SENT){R.replaceLocalEventId(P);const{shouldLiveInRoom:te,threadId:ae}=this.eventShouldLiveIn(R),de=ae?this.getThread(ae):void 0;if(de==null||de.setEventMetadata(R),de==null||de.timelineSet.replaceEventId(x,P),te)for(const X of this.timelineSets)X.replaceEventId(x,P)}else if(k==i.EventStatus.CANCELLED){if(this.pendingEventList){const te=this.getPendingEvent(x);this.removePendingEvent(x),te!=null&&te.isRedaction()&&this.revertRedactionLocalEcho(te)}this.removeEvent(x)}this.savePendingEvents(),this.emit(I.LocalEchoUpdated,R,this,x,V)}revertRedactionLocalEcho(R){const k=R.event.redacts;if(!k)return;const P=this.getUnfilteredTimelineSet().findEventById(k);P&&(P.unmarkLocallyRedacted(),this.emit(I.RedactionCancelled,R,this),P.isRelation()&&this.aggregateNonLiveRelation(P))}addLiveEvents(R,k,P=!1){var V;let x=k,Q=!1;if(typeof k=="object"?{duplicateStrategy:x,fromCache:P=!1,timelineWasEmpty:Q}=k:k!==void 0&&o.logger.warn("Overload deprecated: `Room.addLiveEvents(events, duplicateStrategy?, fromCache?)` is deprecated in favor of the overload with `Room.addLiveEvents(events, IAddLiveEventOptions)`"),x&&["replace","ignore"].indexOf(x)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let X=0;X<this.timelineSets.length;X++){const $=this.timelineSets[X].getLiveTimeline();if($.getPaginationToken(h.EventTimeline.FORWARDS))throw new Error("live timeline "+X+" is no longer live - it has a pagination token ("+$.getPaginationToken(h.EventTimeline.FORWARDS)+")");if($.getNeighbouringTimeline(h.EventTimeline.FORWARDS))throw new Error(`live timeline ${X} is no longer live - it has a neighbouring timeline`)}const te=this.findThreadRoots(R),ae={},de={duplicateStrategy:x,fromCache:P,timelineWasEmpty:Q};for(const X of R){if(this.processLiveEvent(X),X.getUnsigned().transaction_id){const ue=this.txnToEvent.get(X.getUnsigned().transaction_id);if(ue){this.handleRemoteEcho(X,ue);continue}}const{shouldLiveInRoom:$,shouldLiveInThread:K,threadId:re}=this.eventShouldLiveIn(X,R,te);K&&!ae[re??""]&&(ae[re??""]=[]),(V=ae[re??""])===null||V===void 0||V.push(X),$&&this.addLiveEvent(X,de)}Object.entries(ae).forEach(([X,$])=>{this.addThreadedEvents(X,$,!1)})}partitionThreadedEvents(R){if(this.client.supportsThreads()){const V=this.findThreadRoots(R);return R.reduce((x,Q)=>{const{shouldLiveInRoom:te,shouldLiveInThread:ae,threadId:de}=this.eventShouldLiveIn(Q,R,V);return te&&x[0].push(Q),ae&&(Q.setThreadId(de??""),x[1].push(Q)),x},[[],[]])}else return[R,[]]}findThreadRoots(R){var k;const P=new Set;for(const V of R)V.isRelation(w.THREAD_RELATION_TYPE.name)&&P.add((k=V.relationEventId)!==null&&k!==void 0?k:"");return P}addReceipt(R,k=!1){const P=R.getContent();Object.keys(P).forEach(V=>{Object.keys(P[V]).forEach(x=>{Object.keys(P[V][x]).forEach(Q=>{var te,ae,de,X;const $=P[V][x][Q],K=!$.thread_id||$.thread_id===M.MAIN_ROOM_TIMELINE,re=K?this:this.threads.get((te=$.thread_id)!==null&&te!==void 0?te:"");if(re){if(re.addReceiptToStructure(V,x,Q,$,k),this.client.isInitialSyncComplete()&&Q===this.client.getUserId()){const H=re.timeline[re.timeline.length-1];H&&V===H.getId()&&Q===H.getSender()&&(re.setUnread(O.Total,0),re.setUnread(O.Highlight,0))}}else this.cachedThreadReadReceipts.set($.thread_id,[...(ae=this.cachedThreadReadReceipts.get($.thread_id))!==null&&ae!==void 0?ae:[],{eventId:V,receiptType:x,userId:Q,receipt:$,synthetic:k}]);const ue=this.client.getUserId();Q===ue&&!K&&$.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=$.ts),!$.thread_id&&$.ts>((X=(de=this.unthreadedReceipts.get(Q))===null||de===void 0?void 0:de.ts)!==null&&X!==void 0?X:0)&&this.unthreadedReceipts.set(Q,$)})})}),this.emit(I.Receipt,R,this)}addEphemeralEvents(R){for(const k of R)k.getType()===v.EventType.Typing?this.currentState.setTypingEvent(k):k.getType()===v.EventType.Receipt&&this.addReceipt(k)}removeEvents(R){for(const k of R)this.removeEvent(k)}removeEvent(R){let k=!1;for(const P of this.timelineSets){const V=P.removeEvent(R);V&&(V.isRedaction()&&this.revertRedactionLocalEcho(V),k=!0)}return k}recalculate(){const R=this.currentState.getStateEvents(v.EventType.RoomMember,this.myUserId);if(R){const P=R.getContent().membership;this.updateMyMembership(P),P==="invite"&&(R.getUnsigned().invite_room_state||[]).forEach(x=>{this.currentState.getStateEvents(x.type,x.state_key)||this.currentState.setStateEvents([new n.MatrixEvent({type:x.type,state_key:x.state_key,content:x.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])})}const k=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=(0,a.normalize)(this.name),this.summary=new s.RoomSummary(this.roomId,{title:this.name}),k!==this.name&&this.emit(I.Name,this)}addTags(R){this.tags=R.getContent().tags||{},this.emit(I.Tags,R,this)}addAccountData(R){for(const k of R){k.getType()==="m.tag"&&this.addTags(k);const P=k.getType(),V=this.accountData.get(P);this.accountData.set(P,k),this.emit(I.AccountData,k,this,V)}}getAccountData(R){return this.accountData.get(R)}maySendMessage(){return this.getMyMembership()==="join"&&(this.client.isRoomEncrypted(this.roomId)?this.currentState.maySendEvent(v.EventType.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(v.EventType.RoomMessage,this.myUserId))}canInvite(R){let k=this.getMyMembership()==="join";const P=this.currentState.getStateEvents(v.EventType.RoomPowerLevels,""),V=P&&P.getContent(),x=this.getMember(R);return V&&x&&V.invite>x.powerLevel&&(k=!1),k}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){const R=this.currentState.getStateEvents(v.EventType.RoomCreate,"");if(!R){this.getTypeWarning||(o.logger.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return R.getContent()[v.RoomCreateTypeField]}isSpaceRoom(){return this.getType()===v.RoomType.Space}isCallRoom(){return this.getType()===v.RoomType.UnstableCall}isElementVideoRoom(){return this.getType()===v.RoomType.ElementVideo}findPredecessor(R=!1){const k=this.getLiveTimeline().getState(h.EventTimeline.FORWARDS);return k?k.findPredecessor(R):null}roomNameGenerator(R){if(this.client.roomNameGenerator){const k=this.client.roomNameGenerator(this.roomId,R);if(k!==null)return k}switch(R.type){case Y.Actual:return R.name;case Y.Generated:switch(R.subtype){case"Inviting":return`Inviting ${q(R.names,R.count)}`;default:return q(R.names,R.count)}case Y.EmptyRoom:return R.oldName?`Empty room (was ${R.oldName})`:"Empty room"}}calculateRoomName(R,k=!1){if(!k){const re=this.currentState.getStateEvents(v.EventType.RoomName,"");if(re!=null&&re.getContent().name)return this.roomNameGenerator({type:Y.Actual,name:re.getContent().name})}const P=this.getCanonicalAlias();if(P)return this.roomNameGenerator({type:Y.Actual,name:P});const V=this.currentState.getJoinedMemberCount(),x=this.currentState.getInvitedMemberCount();let Q=V+x-1,te=[];const ae=this.currentState.getStateEvents(v.UNSTABLE_ELEMENT_FUNCTIONAL_USERS.name,"");Array.isArray(ae==null?void 0:ae.getContent().service_members)&&(te=ae.getContent().service_members);let de=[];if(this.summaryHeroes)this.summaryHeroes.forEach(re=>{if(te.includes(re)){Q--;return}const ue=this.getMember(re);de.push(ue?ue.name:re)});else{let re=this.currentState.getMembers().filter(ue=>ue.userId!==R&&(ue.membership==="invite"||ue.membership==="join"));re=re.filter(({userId:ue})=>te.includes(ue)?(Q--,!1):!0),re.sort((ue,H)=>b.compare(ue.userId,H.userId)),re=re.slice(0,5),de=re.map(ue=>ue.name)}if(Q)return this.roomNameGenerator({type:Y.Generated,names:de,count:Q});if(this.getMyMembership()=="join"){const re=this.currentState.getStateEvents(v.EventType.RoomThirdPartyInvite);if(re!=null&&re.length){const ue=re.map(H=>H.getContent().display_name);return this.roomNameGenerator({type:Y.Generated,subtype:"Inviting",names:ue,count:ue.length+1})}}let $=de;$.length||($=this.currentState.getMembers().filter(re=>re.userId!==R&&re.membership!=="invite"&&re.membership!=="join").map(re=>re.name));let K;return $.length&&(K=this.roomNameGenerator({type:Y.Generated,names:$,count:$.length+1})),this.roomNameGenerator({type:Y.EmptyRoom,oldName:K})}applyNewVisibilityEvent(R){const k=R.asVisibilityChange();if(!k)return;const P=R.getSender();if(!P||!(v.EVENT_VISIBILITY_CHANGE_TYPE.name&&this.currentState.maySendStateEvent(v.EVENT_VISIBILITY_CHANGE_TYPE.name,P)||v.EVENT_VISIBILITY_CHANGE_TYPE.altName&&this.currentState.maySendStateEvent(v.EVENT_VISIBILITY_CHANGE_TYPE.altName,P)))return;const x=this.visibilityEvents.get(k.eventId);if(x){let te=x.length-1;const ae=Math.max(0,x.length-C);for(;te>=ae&&!(x[te].getTs()<R.getTs());--te);te===-1?x.unshift(R):x.splice(te+1,0,R)}else this.visibilityEvents.set(k.eventId,[R]);const Q=this.findEventById(k.eventId);Q&&Q.applyVisibilityEvent(k)}redactVisibilityChangeEvent(R){if(!R.isVisibilityEvent)throw new Error("expected a visibility change event");const k=R.getRelation(),P=k==null?void 0:k.event_id,V=this.visibilityEvents.get(P);if(!V)return;const x=V.findIndex(Q=>Q.getId()===R.getId());if(x!==-1&&(V.splice(x,1),x===V.length)){const Q=this.findEventById(P);if(!Q)return;if(x===0)this.visibilityEvents.delete(P),Q.applyVisibilityEvent();else{const ae=V[V.length-1].asVisibilityChange();if(!ae)throw new Error("at this stage, visibility changes should be well-formed");Q.applyVisibilityEvent(ae)}}}applyPendingVisibilityEvents(R){const k=this.visibilityEvents.get(R.getId());if(!k||k.length==0)return;const P=k[k.length-1],V=P.asVisibilityChange();V&&(V.visible,!(P.getTs()<R.getTs())&&R.applyVisibilityEvent(V))}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}getLastUnthreadedReceiptFor(R){return this.unthreadedReceipts.get(R)}fixupNotifications(R){super.fixupNotifications(R);const k=this.getThreads().filter(P=>this.getThreadUnreadNotificationCount(P.id,O.Total)>0);for(const P of k)P.fixupNotifications(R)}}e.Room=D;const j={[i.EventStatus.ENCRYPTING]:[i.EventStatus.SENDING,i.EventStatus.NOT_SENT,i.EventStatus.CANCELLED],[i.EventStatus.SENDING]:[i.EventStatus.ENCRYPTING,i.EventStatus.QUEUED,i.EventStatus.NOT_SENT,i.EventStatus.SENT],[i.EventStatus.QUEUED]:[i.EventStatus.SENDING,i.EventStatus.NOT_SENT,i.EventStatus.CANCELLED],[i.EventStatus.SENT]:[],[i.EventStatus.NOT_SENT]:[i.EventStatus.SENDING,i.EventStatus.QUEUED,i.EventStatus.CANCELLED],[i.EventStatus.CANCELLED]:[]};var Y;(function(B){B[B.EmptyRoom=0]="EmptyRoom",B[B.Generated=1]="Generated",B[B.Actual=2]="Actual"})(Y=e.RoomNameType||(e.RoomNameType={}));function q(B,R){const k=R-1;return B.length?B.length===1&&k<=1?B[0]:B.length===2&&k<=2?`${B[0]} and ${B[1]}`:k>1?`${B[0]} and ${k} others`:`${B[0]} and 1 other`:"Empty room"}},{"../@types/event":306,"../@types/read_receipts":311,"../ReEmitter":317,"../client":321,"../content-repo":323,"../filter":364,"../logger":374,"../utils":416,"./beacon":378,"./event":383,"./event-status":380,"./event-timeline":382,"./event-timeline-set":381,"./poll":385,"./read-receipt":386,"./relations-container":387,"./room-member":389,"./room-state":390,"./room-summary":391,"./thread":394,"matrix-events-sdk":167}],393:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SearchResult=void 0;const u=t("./event-context");class g{static fromJson(y,c){const m=y.context||{};let h=(m.events_before||[]).map(c),d=(m.events_after||[]).map(c);const b=new u.EventContext(c(y.result)),a=b.ourEvent.threadRootId;return h=h.filter(n=>n.threadRootId===a),d=d.filter(n=>n.threadRootId===a),b.setPaginateToken(m.start,!0),b.addEvents(h,!0),b.addEvents(d,!1),b.setPaginateToken(m.end,!1),new g(y.rank,b)}constructor(y,c){this.rank=y,this.context=c}}e.SearchResult=g},{"./event-context":379}],394:[function(t,E,e){var u=this&&this.__awaiter||function(p,_,T,w){function M(A){return A instanceof T?A:new T(function(W){W(A)})}return new(T||(T=Promise))(function(A,W){function ee(O){try{C(w.next(O))}catch(I){W(I)}}function F(O){try{C(w.throw(O))}catch(I){W(I)}}function C(O){O.done?A(O.value):M(O.value).then(ee,F)}C((w=w.apply(p,_||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.threadFilterTypeToFilter=e.ThreadFilterType=e.THREAD_RELATION_TYPE=e.FILTER_RELATED_BY_REL_TYPES=e.FILTER_RELATED_BY_SENDERS=e.Thread=e.determineFeatureSupport=e.FeatureSupport=e.ThreadEvent=void 0;const g=t("../client"),S=t("../ReEmitter"),y=t("../@types/event"),c=t("./event"),m=t("./event-timeline"),h=t("./event-timeline-set"),d=t("./room"),b=t("../NamespacedValue"),a=t("../logger"),n=t("./read-receipt"),i=t("../@types/read_receipts");var r;(function(p){p.New="Thread.new",p.Update="Thread.update",p.NewReply="Thread.newReply",p.ViewThread="Thread.viewThread",p.Delete="Thread.delete"})(r=e.ThreadEvent||(e.ThreadEvent={}));var s;(function(p){p[p.None=0]="None",p[p.Experimental=1]="Experimental",p[p.Stable=2]="Stable"})(s=e.FeatureSupport||(e.FeatureSupport={}));function o(p,_){return p?s.Stable:_?s.Experimental:s.None}e.determineFeatureSupport=o;class l extends n.ReadReceipt{constructor(_,T,w){var M;if(super(),this.id=_,this.rootEvent=T,this.timeline=[],this._currentUserParticipated=!1,this.replyCount=0,this.pendingReplyCount=0,this.initialEventsFetched=!l.hasServerSideSupport,this.replayEvents=[],this.onBeforeRedaction=(A,W)=>{A!=null&&A.isRelation(e.THREAD_RELATION_TYPE.name)&&this.room.eventShouldLiveIn(A).threadId===this.id&&A.getId()!==this.id&&!W.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(r.Update,this))},this.onRedaction=A=>u(this,void 0,void 0,function*(){if(A.threadRootId===this.id)if(this.replyCount<=0){for(const W of this.timeline)this.clearEventMetadata(W);this.lastEvent=this.rootEvent,this._currentUserParticipated=!1,this.emit(r.Delete,this)}else yield this.updateThreadMetadata()}),this.onTimelineEvent=(A,W,ee)=>{ee||W.addLocalEchoReceipt(A.getSender(),A,i.ReceiptType.Read),this.onEcho(A,ee??!1)},this.onLocalEcho=A=>{this.onEcho(A,!1)},this.onEcho=(A,W)=>u(this,void 0,void 0,function*(){A.threadRootId===this.id&&this.lastEvent!==A&&(yield this.updateThreadMetadata(),A.isRelation(e.THREAD_RELATION_TYPE.name)&&(W||this.emit(r.NewReply,this,A)))}),!(w!=null&&w.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=w.room,this.client=w.client,this.pendingEventOrdering=(M=w.pendingEventOrdering)!==null&&M!==void 0?M:g.PendingEventOrdering.Chronological,this.timelineSet=new h.EventTimelineSet(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new S.TypedReEmitter(this),this.reEmitter.reEmit(this.timelineSet,[d.RoomEvent.Timeline,d.RoomEvent.TimelineReset]),this.room.on(c.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.room.on(d.RoomEvent.Redaction,this.onRedaction),this.room.on(d.RoomEvent.LocalEchoUpdated,this.onLocalEcho),this.timelineSet.on(d.RoomEvent.Timeline,this.onTimelineEvent),this.processReceipts(w.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){return u(this,void 0,void 0,function*(){this.rootEvent=this.room.findEventById(this.id);try{const _=yield this.client.fetchRoomEvent(this.roomId,this.id),T=this.client.getEventMapper();this.rootEvent=T(_)}catch(_){a.logger.error("Failed to fetch thread root to construct thread with",_)}yield this.processEvent(this.rootEvent)})}static setServerSideSupport(_){l.hasServerSideSupport=_,_!==s.Stable&&(e.FILTER_RELATED_BY_SENDERS.setPreferUnstable(!0),e.FILTER_RELATED_BY_REL_TYPES.setPreferUnstable(!0),e.THREAD_RELATION_TYPE.setPreferUnstable(!0))}static setServerSideListSupport(_){l.hasServerSideListSupport=_}static setServerSideFwdPaginationSupport(_){l.hasServerSideFwdPaginationSupport=_}get roomState(){return this.room.getLiveTimeline().getState(m.EventTimeline.FORWARDS)}addEventToTimeline(_,T){this.findEventById(_.getId())||(this.timelineSet.addEventToTimeline(_,this.liveTimeline,{toStartOfTimeline:T,fromCache:!1,roomState:this.roomState}),this.timeline=this.events)}addEvents(_,T){_.forEach(w=>this.addEvent(w,T,!1)),this.updateThreadMetadata()}addEvent(_,T,w=!0){var M,A,W;return u(this,void 0,void 0,function*(){this.setEventMetadata(_);const ee=this.lastReply(),F=!ee||_.localTimestamp>=ee.localTimestamp;if(!l.hasServerSideSupport)this.addEventToTimeline(_,T),this.client.decryptEventIfNeeded(_,{});else if(!T&&this.initialEventsFetched&&F)this.addEventToTimeline(_,!1),this.fetchEditsWhereNeeded(_);else if(_.isRelation(y.RelationType.Annotation)||_.isRelation(y.RelationType.Replace)){this.initialEventsFetched?this.addEventToTimeline(_,T):(M=this.replayEvents)===null||M===void 0||M.push(_),(A=this.timelineSet.relations)===null||A===void 0||A.aggregateParentEvent(_),(W=this.timelineSet.relations)===null||W===void 0||W.aggregateChildEvent(_,this.timelineSet);return}(!l.hasServerSideSupport||!this.rootEvent)&&_.isRelation(e.THREAD_RELATION_TYPE.name)&&this.replyCount++,w&&(this.emit(r.NewReply,this,_),this.updateThreadMetadata())})}processEvent(_){return u(this,void 0,void 0,function*(){_&&(this.setEventMetadata(_),yield this.fetchEditsWhereNeeded(_)),this.timeline=this.events})}processReceipts(_=[]){for(const{eventId:T,receiptType:w,userId:M,receipt:A,synthetic:W}of _)this.addReceiptToStructure(T,w,M,A,W)}getRootEventBundledRelationship(_=this.rootEvent){return _==null?void 0:_.getServerAggregatedRelation(e.THREAD_RELATION_TYPE.name)}processRootEvent(){return u(this,void 0,void 0,function*(){const _=this.getRootEventBundledRelationship();if(l.hasServerSideSupport&&_){this.replyCount=_.count,this._currentUserParticipated=!!_.current_user_participated;const T=this.client.getEventMapper();this.lastEvent=T(Object.assign(Object.assign({},_.latest_event),{room_id:this.roomId})),this.updatePendingReplyCount(),yield this.processEvent(this.lastEvent)}})}updatePendingReplyCount(){const T=(this.pendingEventOrdering===g.PendingEventOrdering.Detached?this.room.getPendingEvents():this.events).filter(w=>{var M;return w.threadRootId===this.id&&w.isRelation(e.THREAD_RELATION_TYPE.name)&&w.status!==null&&w.getId()!==((M=this.lastEvent)===null||M===void 0?void 0:M.getId())});this.lastPendingEvent=T.length?T[T.length-1]:void 0,this.pendingReplyCount=T.length}resetLiveTimeline(_,T){return u(this,void 0,void 0,function*(){const w=this.liveTimeline;this.timelineSet.resetLiveTimeline(_??void 0,T??void 0);const M=this.liveTimeline;let A,W;_&&(A=(yield this.client.createMessagesRequest(this.roomId,_,1,m.Direction.Forward)).end),T&&(W=(yield this.client.createMessagesRequest(this.roomId,T,1,m.Direction.Backward)).start),T&&w.getPaginationToken(m.Direction.Forward)===T&&w.setPaginationToken(W??null,m.Direction.Forward),_&&M.getPaginationToken(m.Direction.Backward)===_&&M.setPaginationToken(A??null,m.Direction.Backward)})}updateThreadMetadata(){return u(this,void 0,void 0,function*(){if(this.updatePendingReplyCount(),l.hasServerSideSupport&&(this.initialEventsFetched||(yield this.processRootEvent()),yield this.fetchRootEvent()),yield this.processRootEvent(),!this.initialEventsFetched){this.initialEventsFetched=!0;try{this.replyCount===0&&this.rootEvent?(this.timelineSet.addEventsToTimeline([this.rootEvent],!0,this.liveTimeline,null),this.liveTimeline.setPaginationToken(null,m.Direction.Backward)):yield this.client.paginateEventTimeline(this.liveTimeline,{backwards:!0,limit:Math.max(1,this.length)});for(const _ of this.replayEvents)this.addEvent(_,!1);this.replayEvents=null,this.emit(d.RoomEvent.TimelineReset,this.room,this.timelineSet,!0)}catch(_){a.logger.error("Failed to load start of newly created thread: ",_),this.initialEventsFetched=!1}}this.emit(r.Update,this)})}fetchEditsWhereNeeded(..._){return u(this,void 0,void 0,function*(){return Promise.all(_.filter(T=>T.isEncrypted()).map(T=>{if(!T.isRelation())return this.client.relations(this.roomId,T.getId(),y.RelationType.Replace,T.getType(),{limit:1}).then(w=>{w.events.length&&T.makeReplaced(w.events[0])}).catch(w=>{a.logger.error("Failed to load edits for encrypted thread event",w)})}))})}setEventMetadata(_){_&&(m.EventTimeline.setEventMetadata(_,this.roomState,!1),_.setThread(this))}clearEventMetadata(_){var T,w,M;_&&(_.setThread(void 0),(M=(w=(T=_.event)===null||T===void 0?void 0:T.unsigned)===null||w===void 0?void 0:w["m.relations"])===null||M===void 0||delete M[e.THREAD_RELATION_TYPE.name])}findEventById(_){return this.timelineSet.findEventById(_)}lastReply(_=()=>!0){for(let T=this.timeline.length-1;T>=0;T--){const w=this.timeline[T];if(_(w))return w}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var _,T;return(T=(_=this.lastPendingEvent)!==null&&_!==void 0?_:this.lastEvent)!==null&&T!==void 0?T:this.lastReply()}get events(){return this.liveTimeline.getEvents()}has(_){return this.timelineSet.findEventById(_)instanceof c.MatrixEvent}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(_,T){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(_,T){var w,M;const A=_===this.client.getUserId(),W=this.timeline[this.timeline.length-1];if(A&&W){const F=W.getTs()<this.room.getOldestThreadedReceiptTs(),C=W.getId();if(F&&C)return C}const ee=super.getEventReadUpTo(_,T);if(W){const F=this.room.getLastUnthreadedReceiptFor(_);if(!F)return ee;for(let C=((w=this.timeline)===null||w===void 0?void 0:w.length)-1;C>=0;--C){const O=this.timeline[C];if(O.getId()===ee)return ee;if(O.getTs()<F.ts)return(M=O.getId())!==null&&M!==void 0?M:ee}}return ee}hasUserReadEvent(_,T){var w,M,A,W,ee,F;if(_===this.client.getUserId()){const C=((M=(w=this.lastReply())===null||w===void 0?void 0:w.getTs())!==null&&M!==void 0?M:0)<this.room.getOldestThreadedReceiptTs(),O=(W=(A=this.room.getLastUnthreadedReceiptFor(_))===null||A===void 0?void 0:A.ts)!==null&&W!==void 0?W:0,I=((F=(ee=this===null||this===void 0?void 0:this.lastReply())===null||ee===void 0?void 0:ee.getTs())!==null&&F!==void 0?F:0)<O;if(C||I)return!0}return super.hasUserReadEvent(_,T)}setUnread(_,T){return this.room.setThreadUnreadNotificationCount(this.id,_,T)}}e.Thread=l,l.hasServerSideSupport=s.None,l.hasServerSideListSupport=s.None,l.hasServerSideFwdPaginationSupport=s.None,e.FILTER_RELATED_BY_SENDERS=new b.ServerControlledNamespacedValue("related_by_senders","io.element.relation_senders"),e.FILTER_RELATED_BY_REL_TYPES=new b.ServerControlledNamespacedValue("related_by_rel_types","io.element.relation_types"),e.THREAD_RELATION_TYPE=new b.ServerControlledNamespacedValue("m.thread","io.element.thread");var v;(function(p){p[p.My=0]="My",p[p.All=1]="All"})(v=e.ThreadFilterType||(e.ThreadFilterType={}));function f(p){switch(p){case v.My:return"participated";default:return"all"}}e.threadFilterTypeToFilter=f},{"../@types/event":306,"../@types/read_receipts":311,"../NamespacedValue":316,"../ReEmitter":317,"../client":321,"../logger":374,"./event":383,"./event-timeline":382,"./event-timeline-set":381,"./read-receipt":386,"./room":392}],395:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.TypedEventEmitter=e.EventEmitterEvents=void 0;const u=t("events");(function(S){S.NewListener="newListener",S.RemoveListener="removeListener",S.Error="error"})(e.EventEmitterEvents||(e.EventEmitterEvents={}));class g extends u.EventEmitter{addListener(y,c){return super.addListener(y,c)}emit(y,...c){return super.emit(y,...c)}eventNames(){return super.eventNames()}listenerCount(y){return super.listenerCount(y)}listeners(y){return super.listeners(y)}off(y,c){return super.off(y,c)}on(y,c){return super.on(y,c)}once(y,c){return super.once(y,c)}prependListener(y,c){return super.prependListener(y,c)}prependOnceListener(y,c){return super.prependOnceListener(y,c)}removeAllListeners(y){return super.removeAllListeners(y)}removeListener(y,c){return super.removeListener(y,c)}rawListeners(y){return super.rawListeners(y)}}e.TypedEventEmitter=g},{events:105}],396:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.User=e.UserEvent=void 0;const u=t("./typed-event-emitter");var g;(function(y){y.DisplayName="User.displayName",y.AvatarUrl="User.avatarUrl",y.Presence="User.presence",y.CurrentlyActive="User.currentlyActive",y.LastPresenceTs="User.lastPresenceTs"})(g=e.UserEvent||(e.UserEvent={}));class S extends u.TypedEventEmitter{constructor(c){super(),this.userId=c,this.modified=-1,this.presence="offline",this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={},this.displayName=c,this.rawDisplayName=c,this.updateModifiedTime()}setPresenceEvent(c){if(c.getType()!=="m.presence")return;const m=this.events.presence===null;this.events.presence=c;const h=[];(c.getContent().presence!==this.presence||m)&&h.push(g.Presence),c.getContent().avatar_url&&c.getContent().avatar_url!==this.avatarUrl&&h.push(g.AvatarUrl),c.getContent().displayname&&c.getContent().displayname!==this.displayName&&h.push(g.DisplayName),c.getContent().currently_active!==void 0&&c.getContent().currently_active!==this.currentlyActive&&h.push(g.CurrentlyActive),this.presence=c.getContent().presence,h.push(g.LastPresenceTs),c.getContent().status_msg&&(this.presenceStatusMsg=c.getContent().status_msg),c.getContent().displayname&&(this.displayName=c.getContent().displayname),c.getContent().avatar_url&&(this.avatarUrl=c.getContent().avatar_url),this.lastActiveAgo=c.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=c.getContent().currently_active,this.updateModifiedTime();for(const d of h)this.emit(d,c,this)}setDisplayName(c){const m=this.displayName;this.displayName=c,c!==m&&this.updateModifiedTime()}setRawDisplayName(c){this.rawDisplayName=c}setAvatarUrl(c){const m=this.avatarUrl;this.avatarUrl=c,c!==m&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}e.User=S},{"./typed-event-emitter":395}],397:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.PushProcessor=void 0;const u=t("./utils"),g=t("./logger"),S=t("./@types/PushRules"),y=t("./@types/event"),c=[S.PushRuleKind.Override,S.PushRuleKind.ContentSpecific,S.PushRuleKind.RoomSpecific,S.PushRuleKind.SenderSpecific,S.PushRuleKind.Underride],m=[{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:S.ConditionKind.EventMatch,key:"type",pattern:"m.reaction"}],actions:[S.PushRuleActionName.DontNotify]},{rule_id:S.RuleId.IsUserMention,default:!0,enabled:!0,conditions:[{kind:S.ConditionKind.EventPropertyContains,key:"content.org\\.matrix\\.msc3952\\.mentions.user_ids",value:""}],actions:[S.PushRuleActionName.Notify,{set_tweak:S.TweakName.Highlight}]},{rule_id:S.RuleId.IsRoomMention,default:!0,enabled:!0,conditions:[{kind:S.ConditionKind.EventPropertyIs,key:"content.org\\.matrix\\.msc3952\\.mentions.room",value:!0},{kind:S.ConditionKind.SenderNotificationPermission,key:"room"}],actions:[S.PushRuleActionName.Notify,{set_tweak:S.TweakName.Highlight}]},{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:S.ConditionKind.EventMatch,key:"type",pattern:y.EventType.RoomServerAcl},{kind:S.ConditionKind.EventMatch,key:"state_key",pattern:""}],actions:[]}],h=[{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:S.ConditionKind.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:S.ConditionKind.CallStarted}],actions:[S.PushRuleActionName.Notify,{set_tweak:S.TweakName.Sound,value:"default"}]}];class d{constructor(a){this.client=a,this.parsedKeys=new Map}static actionListToActionsObject(a){const n={notify:!1,tweaks:{}};for(const i of a)i===S.PushRuleActionName.Notify?n.notify=!0:typeof i=="object"&&(i.value===void 0&&(i.value=!0),n.tweaks[i.set_tweak]=i.value);return n}static rewriteDefaultRules(a,n=void 0){var i;let r=JSON.parse(JSON.stringify(a));r||(r={}),r.global||(r.global={}),r.global.override||(r.global.override=[]),r.global.underride||(r.global.underride=[]);const s=r.global.override;for(const l of m){const v=s.find(p=>p.rule_id===l.rule_id);let f;if(l.rule_id===S.RuleId.IsUserMention){if(!n)continue;f=JSON.parse(JSON.stringify(l)),f.conditions[0].value=n}else f=l;if(v)v.default=f.default,v.conditions=f.conditions,v.actions=f.actions;else{const p=f.rule_id;g.logger.warn(`Adding default global override for ${p}`),s.push(f)}}const o=(i=r.global.underride)!==null&&i!==void 0?i:[];for(const l of h){const v=o.find(f=>f.rule_id===l.rule_id);if(v)v.default=l.default,v.conditions=l.conditions,v.actions=l.actions;else{const f=l.rule_id;g.logger.warn(`Adding default global underride for ${f}`),o.push(l)}}return r}updateCachedPushRuleKeys(a){a||(a={}),a.global||(a.global={}),a.global.override||(a.global.override=[]),a.global.room||(a.global.room=[]),a.global.sender||(a.global.sender=[]),a.global.underride||(a.global.underride=[]);const n=new Set(this.parsedKeys.keys());for(const i of[a.global.override,a.global.room,a.global.sender,a.global.underride])for(const r of i)if(r.conditions)for(const s of r.conditions)s.kind===S.ConditionKind.EventMatch&&(n.delete(s.key),this.parsedKeys.set(s.key,d.partsForDottedKey(s.key)));n.forEach(i=>this.parsedKeys.delete(i))}matchingRuleFromKindSet(a,n){for(const i of c){const r=n[i];if(r)for(const s of r){if(!s.enabled)continue;const o=this.templateRuleToRaw(i,s);if(o&&this.ruleMatchesEvent(o,a))return Object.assign(Object.assign({},s),{kind:i})}}return null}templateRuleToRaw(a,n){const i={rule_id:n.rule_id,actions:n.actions,conditions:[]};switch(a){case S.PushRuleKind.Underride:case S.PushRuleKind.Override:i.conditions=n.conditions;break;case S.PushRuleKind.RoomSpecific:if(!n.rule_id)return null;i.conditions.push({kind:S.ConditionKind.EventMatch,key:"room_id",value:n.rule_id});break;case S.PushRuleKind.SenderSpecific:if(!n.rule_id)return null;i.conditions.push({kind:S.ConditionKind.EventMatch,key:"user_id",value:n.rule_id});break;case S.PushRuleKind.ContentSpecific:if(!n.pattern)return null;i.conditions.push({kind:S.ConditionKind.EventMatch,key:"content.body",pattern:n.pattern});break}return i}eventFulfillsCondition(a,n){switch(a.kind){case S.ConditionKind.EventMatch:return this.eventFulfillsEventMatchCondition(a,n);case S.ConditionKind.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(a,n);case S.ConditionKind.EventPropertyContains:return this.eventFulfillsEventPropertyContains(a,n);case S.ConditionKind.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(a,n);case S.ConditionKind.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(a,n);case S.ConditionKind.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(a,n);case S.ConditionKind.CallStarted:case S.ConditionKind.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(a,n)}return!1}eventFulfillsSenderNotifPermCondition(a,n){const i=a.key;if(!i)return!1;const r=this.client.getRoom(n.getRoomId());return r!=null&&r.currentState?r.currentState.mayTriggerNotifOfType(i,n.getSender()):!1}eventFulfillsRoomMemberCountCondition(a,n){if(!a.is)return!1;const i=this.client.getRoom(n.getRoomId());if(!i||!i.currentState||!i.currentState.members)return!1;const r=i.currentState.getJoinedMemberCount(),s=a.is.match(/^([=<>]*)(\d*)$/);if(!s)return!1;const o=s[1],l=parseInt(s[2]);if(isNaN(l))return!1;switch(o){case"":case"==":return r==l;case"<":return r<l;case">":return r>l;case"<=":return r<=l;case">=":return r>=l;default:return!1}}eventFulfillsDisplayNameCondition(a,n){var i;let r=n.getContent();if(n.isEncrypted()&&n.getClearContent()&&(r=n.getClearContent()),!r||!r.body||typeof r.body!="string")return!1;const s=this.client.getRoom(n.getRoomId()),o=(i=s==null?void 0:s.currentState)===null||i===void 0?void 0:i.getMember(this.client.credentials.userId);if(!o)return!1;const l=o.name,v=new RegExp("(^|\\W)"+(0,u.escapeRegExp)(l)+"(\\W|$)","i");return r.body.search(v)>-1}eventFulfillsEventMatchCondition(a,n){if(!a.key)return!1;const i=this.valueForDottedKey(a.key,n);if(typeof i!="string")return!1;if(a.value)return a.value===i;if(typeof a.pattern!="string")return!1;const r=a.key==="content.body"?this.createCachedRegex("(^|\\W)",a.pattern,"(\\W|$)"):this.createCachedRegex("^",a.pattern,"$");return!!i.match(r)}eventFulfillsEventPropertyIsCondition(a,n){return!a.key||a.value===void 0?!1:a.value===this.valueForDottedKey(a.key,n)}eventFulfillsEventPropertyContains(a,n){if(!a.key||a.value===void 0)return!1;const i=this.valueForDottedKey(a.key,n);return Array.isArray(i)?i.includes(a.value):!1}eventFulfillsCallStartedCondition(a,n){return["m.ring","m.prompt"].includes(n.getContent()["m.intent"])&&!("m.terminated"in n.getContent())&&(n.getPrevContent()["m.terminated"]!==n.getContent()["m.terminated"]||(0,u.deepCompare)(n.getPrevContent(),{}))}createCachedRegex(a,n,i){return d.cachedGlobToRegex[n]||(d.cachedGlobToRegex[n]=new RegExp(a+(0,u.globToRegexp)(n)+i,"i")),d.cachedGlobToRegex[n]}static partsForDottedKey(a){const n=[];let i="",r=!1;for(const s of a){if(r){s==="\\"||s==="."?i+=s:i+="\\"+s,r=!1;continue}s=="."?(n.push(i),i=""):s=="\\"?r=!0:i+=s}return r&&(i+="\\"),n.push(i),n}valueForDottedKey(a,n){let i=this.parsedKeys.get(a);i===void 0&&(i=d.partsForDottedKey(a),this.parsedKeys.set(a,i));let r;const s=i[0];let o=0;for(s==="content"?(r=n.getContent(),++o):s==="type"?(r=n.getType(),++o):r=n.event;o<i.length;++o){if((0,u.isNullOrUndefined)(r))return;const l=i[o];r=r[l]}return r}matchingRuleForEventWithRulesets(a,n){return!n||a.getSender()===this.client.credentials.userId?null:this.matchingRuleFromKindSet(a,n.global)}pushActionsForEventAndRulesets(a,n){const i=this.matchingRuleForEventWithRulesets(a,n);if(!i)return{};const r=d.actionListToActionsObject(i.actions);return r.tweaks.highlight===void 0&&(r.tweaks.highlight=i.kind==S.PushRuleKind.ContentSpecific),r}ruleMatchesEvent(a,n){var i;return this.client.supportsIntentionalMentions()&&n.getContent()["org.matrix.msc3952.mentions"]!==void 0&&(a.rule_id===S.RuleId.ContainsUserName||a.rule_id===S.RuleId.ContainsDisplayName||a.rule_id===S.RuleId.AtRoomNotification)?!1:!(!((i=a.conditions)===null||i===void 0)&&i.some(r=>!this.eventFulfillsCondition(r,n)))}actionsForEvent(a){return this.pushActionsForEventAndRulesets(a,this.client.pushRules)}getPushRuleById(a){var n;const i=this.getPushRuleAndKindById(a);return(n=i==null?void 0:i.rule)!==null&&n!==void 0?n:null}getPushRuleAndKindById(a){var n;for(const i of["global"])if(((n=this.client.pushRules)===null||n===void 0?void 0:n[i])!==void 0){for(const r of c)if(this.client.pushRules[i][r]!==void 0){for(const s of this.client.pushRules[i][r])if(s.rule_id===a)return{rule:s,kind:r}}}return null}}e.PushProcessor=d,d.cachedGlobToRegex={}},{"./@types/PushRules":304,"./@types/event":306,"./logger":374,"./utils":416}],398:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.randomUppercaseString=e.randomLowercaseString=e.randomString=void 0;const u="abcdefghijklmnopqrstuvwxyz",g="ABCDEFGHIJKLMNOPQRSTUVWXYZ",S="0123456789";function y(d){return h(d,g+u+S)}e.randomString=y;function c(d){return h(d,u)}e.randomLowercaseString=c;function m(d){return h(d,g)}e.randomUppercaseString=m;function h(d,b){let a="";for(let n=0;n<d;++n)a+=b.charAt(Math.floor(Math.random()*b.length));return a}},{}],399:[function(t,E,e){(function(u){(function(){Object.defineProperty(e,"__esModule",{value:!0}),e.clearTimeout=e.setTimeout=void 0;const g=t("./logger"),S=1e3;let y=0,c;const m=[],h=function(...r){};function d(r,s,...o){s=s||0,s<0&&(s=0);const l=Date.now()+s,v=y++,f={runAt:l,func:r,params:o,key:v},p=i(m,function(_){return _.runAt-l});return m.splice(p,0,f),a(),v}e.setTimeout=d;function b(r){if(m.length===0)return;let s;for(s=0;s<m.length;s++)if(m[s].key==r){m.splice(s,1);break}s===0&&a()}e.clearTimeout=b;function a(){c&&u.clearTimeout(c);const r=m[0];if(!r)return;const s=Date.now(),o=Math.min(r.runAt-s,S);c=u.setTimeout(n,o)}function n(){const r=Date.now(),s=[];for(;;){const o=m[0];if(!o||o.runAt>r)break;const l=m.shift();h("runCallbacks: popping",l.key),s.push(l)}a();for(const o of s)try{o.func.apply(u,o.params)}catch(l){g.logger.error("Uncaught exception in callback function",l)}}function i(r,s){let o=0,l=r.length;for(;o<l;){const v=o+l>>1;s(r[v])>0?l=v:o=v+1}return o}}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./logger":374}],400:[function(t,E,e){var u=this&&this.__awaiter||function(S,y,c,m){function h(d){return d instanceof c?d:new c(function(b){b(d)})}return new(c||(c=Promise))(function(d,b){function a(r){try{i(m.next(r))}catch(s){b(s)}}function n(r){try{i(m.throw(r))}catch(s){b(s)}}function i(r){r.done?d(r.value):h(r.value).then(a,n)}i((m=m.apply(S,y||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.initRustCrypto=void 0;function g(S,y,c){return u(this,void 0,void 0,function*(){throw new Error("Rust crypto is not supported under browserify.")})}e.initRustCrypto=g},{}],401:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.RUST_SDK_STORE_PREFIX=void 0,e.RUST_SDK_STORE_PREFIX="matrix-js-sdk"},{}],402:[function(t,E,e){E.exports=t("/private/var/folders/gs/7hwgz3x91qz6b7f860j0kbzh0000gn/T/tmp.9Jnnppdh/src/rust-crypto/browserify-index.ts")},{"/private/var/folders/gs/7hwgz3x91qz6b7f860j0kbzh0000gn/T/tmp.9Jnnppdh/src/rust-crypto/browserify-index.ts":400}],403:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(b,a,n,i){i===void 0&&(i=n);var r=Object.getOwnPropertyDescriptor(a,n);(!r||("get"in r?!a.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return a[n]}}),Object.defineProperty(b,i,r)}:function(b,a,n,i){i===void 0&&(i=n),b[i]=a[n]}),g=this&&this.__setModuleDefault||(Object.create?function(b,a){Object.defineProperty(b,"default",{enumerable:!0,value:a})}:function(b,a){b.default=a}),S=this&&this.__importStar||function(b){if(b&&b.__esModule)return b;var a={};if(b!=null)for(var n in b)n!=="default"&&Object.prototype.hasOwnProperty.call(b,n)&&u(a,b,n);return g(a,b),a};Object.defineProperty(e,"__esModule",{value:!0}),e.MatrixScheduler=void 0;const y=S(t("./utils"));t("./logger");const c=t("./@types/event"),m=t("./http-api");class h{static RETRY_BACKOFF_RATELIMIT(a,n,i){if(i.httpStatus===400||i.httpStatus===403||i.httpStatus===401||i instanceof m.ConnectionError||i.name==="M_TOO_LARGE")return-1;if(i.name==="M_LIMIT_EXCEEDED"){const r=i.data.retry_after_ms;if(r>0)return r}return n>4?-1:1e3*Math.pow(2,n)}static QUEUE_MESSAGES(a){return a.getType()===c.EventType.RoomMessage||a.hasAssociation()?"message":null}constructor(a=h.RETRY_BACKOFF_RATELIMIT,n=h.QUEUE_MESSAGES){this.retryAlgorithm=a,this.queueAlgorithm=n,this.queues={},this.activeQueues=[],this.procFn=null,this.processQueue=i=>{const r=this.peekNextEvent(i);if(!r){this.disableQueue(i);return}d("Queue '%s' has %s pending events",i,this.queues[i].length),Promise.resolve().then(()=>this.procFn(r.event)).then(s=>{this.removeNextEvent(i),d("Queue '%s' sent event %s",i,r.event.getId()),r.defer.resolve(s),this.processQueue(i)},s=>{r.attempts+=1;const o=this.retryAlgorithm(r.event,r.attempts,s);d("retry(%s) err=%s event_id=%s waitTime=%s",r.attempts,s,r.event.getId(),o),o===-1?(d("Queue '%s' giving up on event %s",i,r.event.getId()),this.clearQueue(i,s)):setTimeout(this.processQueue,o,i)})}}getQueueForEvent(a){const n=this.queueAlgorithm(a);return!n||!this.queues[n]?null:this.queues[n].map(function(i){return i.event})}removeEventFromQueue(a){const n=this.queueAlgorithm(a);if(!n||!this.queues[n])return!1;let i=!1;return y.removeElement(this.queues[n],r=>r.event.getId()===a.getId()?(i=!0,!0):!1),i}setProcessFunction(a){this.procFn=a,this.startProcessingQueues()}queueEvent(a){const n=this.queueAlgorithm(a);if(!n)return null;this.queues[n]||(this.queues[n]=[]);const i=y.defer();return this.queues[n].push({event:a,defer:i,attempts:0}),d("Queue algorithm dumped event %s into queue '%s'",a.getId(),n),this.startProcessingQueues(),i.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(a=>this.activeQueues.indexOf(a)===-1&&this.queues[a].length>0).forEach(a=>{this.activeQueues.push(a),this.processQueue(a)})}disableQueue(a){const n=this.activeQueues.indexOf(a);n>=0&&this.activeQueues.splice(n,1)}clearQueue(a,n){let i;for(;i=this.removeNextEvent(a);)i.defer.reject(n);this.disableQueue(a)}peekNextEvent(a){const n=this.queues[a];if(Array.isArray(n))return n[0]}removeNextEvent(a){const n=this.queues[a];if(Array.isArray(n))return n.shift()}}e.MatrixScheduler=h;function d(...b){}},{"./@types/event":306,"./http-api":367,"./logger":374,"./utils":416}],404:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0})},{}],405:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SERVICE_TYPES=void 0,function(u){u.IS="SERVICE_TYPE_IS",u.IM="SERVICE_TYPE_IM"}(e.SERVICE_TYPES||(e.SERVICE_TYPES={}))},{}],406:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(ee,F,C,O){O===void 0&&(O=C);var I=Object.getOwnPropertyDescriptor(F,C);(!I||("get"in I?!F.__esModule:I.writable||I.configurable))&&(I={enumerable:!0,get:function(){return F[C]}}),Object.defineProperty(ee,O,I)}:function(ee,F,C,O){O===void 0&&(O=C),ee[O]=F[C]}),g=this&&this.__setModuleDefault||(Object.create?function(ee,F){Object.defineProperty(ee,"default",{enumerable:!0,value:F})}:function(ee,F){ee.default=F}),S=this&&this.__importStar||function(ee){if(ee&&ee.__esModule)return ee;var F={};if(ee!=null)for(var C in ee)C!=="default"&&Object.prototype.hasOwnProperty.call(ee,C)&&u(F,ee,C);return g(F,ee),F},y=this&&this.__awaiter||function(ee,F,C,O){function I(D){return D instanceof C?D:new C(function(j){j(D)})}return new(C||(C=Promise))(function(D,j){function Y(R){try{B(O.next(R))}catch(k){j(k)}}function q(R){try{B(O.throw(R))}catch(k){j(k)}}function B(R){R.done?D(R.value):I(R.value).then(Y,q)}B((O=O.apply(ee,F||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.SlidingSyncSdk=void 0;const c=t("./models/room"),m=t("./logger"),h=S(t("./utils")),d=t("./models/event-timeline"),b=t("./client"),a=t("./sync"),n=t("./http-api"),i=t("./sliding-sync"),r=t("./@types/event"),s=t("./models/room-state"),o=t("./models/room-member"),l=3;class v{constructor(F){this.crypto=F}name(){return"e2ee"}when(){return i.ExtensionState.PreProcess}onRequest(F){if(F)return{enabled:!0}}onResponse(F){return y(this,void 0,void 0,function*(){if(F.device_lists&&(yield this.crypto.handleDeviceListChanges({oldSyncToken:"yep"},F.device_lists)),F.device_one_time_keys_count){const C=F.device_one_time_keys_count.signed_curve25519||0;this.crypto.updateOneTimeKeyCount(C)}if(F.device_unused_fallback_key_types||F["org.matrix.msc2732.device_unused_fallback_key_types"]){const C=F.device_unused_fallback_key_types||F["org.matrix.msc2732.device_unused_fallback_key_types"];this.crypto.setNeedsNewFallback(Array.isArray(C)&&!C.includes("signed_curve25519"))}this.crypto.onSyncCompleted({})})}}class f{constructor(F,C){this.client=F,this.cryptoCallbacks=C,this.nextBatch=null}name(){return"to_device"}when(){return i.ExtensionState.PreProcess}onRequest(F){const C={since:this.nextBatch!==null?this.nextBatch:void 0};return F&&(C.limit=100,C.enabled=!0),C}onResponse(F){return y(this,void 0,void 0,function*(){const C=[];let O=F.events||[];O.length>0&&this.cryptoCallbacks&&(O=yield this.cryptoCallbacks.preprocessToDeviceMessages(O)),O.map(this.client.getEventMapper()).map(I=>{if(I.getType()==="m.key.verification.cancel"){const D=I.getContent().transaction_id;D&&C.push(D)}return I}).forEach(I=>{const D=I.getContent();if(I.getType()=="m.room.message"&&D.msgtype=="m.bad.encrypted"){m.logger.log("Ignoring undecryptable to-device event from "+I.getSender());return}if(I.getType()==="m.key.verification.start"||I.getType()==="m.key.verification.request"){const j=D.transaction_id;C.includes(j)&&I.flagCancelled()}this.client.emit(b.ClientEvent.ToDeviceEvent,I)}),this.nextBatch=F.next_batch})}}class p{constructor(F){this.client=F}name(){return"account_data"}when(){return i.ExtensionState.PostProcess}onRequest(F){if(F)return{enabled:!0}}onResponse(F){F.global&&F.global.length>0&&this.processGlobalAccountData(F.global);for(const C in F.rooms){const O=A(this.client,C,F.rooms[C]),I=this.client.getRoom(C);if(!I){m.logger.warn("got account data for room but room doesn't exist on client:",C);continue}I.addAccountData(O),O.forEach(D=>{this.client.emit(b.ClientEvent.Event,D)})}}processGlobalAccountData(F){const C=A(this.client,void 0,F),O=C.reduce((I,D)=>(I[D.getType()]=this.client.store.getAccountData(D.getType()),I),{});this.client.store.storeAccountDataEvents(C),C.forEach(I=>{if(I.getType()===r.EventType.PushRules){const j=I.getContent();this.client.setPushRules(j)}const D=O[I.getType()];return this.client.emit(b.ClientEvent.AccountData,I,D),I})}}class _{constructor(F){this.client=F}name(){return"typing"}when(){return i.ExtensionState.PostProcess}onRequest(F){if(F)return{enabled:!0}}onResponse(F){if(F!=null&&F.rooms)for(const C in F.rooms)W(this.client,C,[F.rooms[C]])}}class T{constructor(F){this.client=F}name(){return"receipts"}when(){return i.ExtensionState.PostProcess}onRequest(F){if(F)return{enabled:!0}}onResponse(F){if(F!=null&&F.rooms)for(const C in F.rooms)W(this.client,C,[F.rooms[C]])}}class w{constructor(F,C,O,I){this.slidingSync=F,this.client=C,this.syncState=null,this.lastPos=null,this.failCount=0,this.notifEvents=[],this.opts=(0,a.defaultClientOpts)(O),this.syncOpts=(0,a.defaultSyncApiOpts)(I),C.getNotifTimelineSet()&&C.reEmitter.reEmit(C.getNotifTimelineSet(),[c.RoomEvent.Timeline,c.RoomEvent.TimelineReset]),this.slidingSync.on(i.SlidingSyncEvent.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(i.SlidingSyncEvent.RoomData,this.onRoomData.bind(this));const D=[new f(this.client,this.syncOpts.cryptoCallbacks),new p(this.client),new _(this.client),new T(this.client)];this.syncOpts.crypto&&D.push(new v(this.syncOpts.crypto)),D.forEach(j=>{this.slidingSync.registerExtension(j)})}onRoomData(F,C){let O=this.client.store.getRoom(F);if(!O){if(!C.initial){m.logger.debug("initial flag not set but no stored room exists for room ",F,C);return}O=(0,a._createAndReEmitRoom)(this.client,F,this.opts)}this.processRoomData(this.client,O,C)}onLifecycle(F,C,O){switch(O&&m.logger.debug("onLifecycle",F,O),F){case i.SlidingSyncState.Complete:if(this.purgeNotifications(),!C)break;this.lastPos||this.updateSyncState(a.SyncState.Prepared,{oldSyncToken:void 0,nextSyncToken:C.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(a.SyncState.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:C.pos,catchingUp:!1,fromCache:!1}),this.lastPos=C.pos;break;case i.SlidingSyncState.RequestFinished:if(O){if(this.failCount+=1,this.updateSyncState(this.failCount>l?a.SyncState.Error:a.SyncState.Reconnecting,{error:new n.MatrixError(O)}),this.shouldAbortSync(new n.MatrixError(O)))return}else this.failCount=0;break}}syncLeftRooms(){return y(this,void 0,void 0,function*(){return[]})}peek(F){return y(this,void 0,void 0,function*(){return null})}stopPeeking(){}getSyncState(){return this.syncState}getSyncStateData(){var F;return(F=this.syncStateData)!==null&&F!==void 0?F:null}createRoom(F){const{timelineSupport:C}=this.client,O=new c.Room(F,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:C});return this.client.reEmitter.reEmit(O,[c.RoomEvent.Name,c.RoomEvent.Redaction,c.RoomEvent.RedactionCancelled,c.RoomEvent.Receipt,c.RoomEvent.Tags,c.RoomEvent.LocalEchoUpdated,c.RoomEvent.AccountData,c.RoomEvent.MyMembership,c.RoomEvent.Timeline,c.RoomEvent.TimelineReset]),this.registerStateListeners(O),O}registerStateListeners(F){this.client.reEmitter.reEmit(F.currentState,[s.RoomStateEvent.Events,s.RoomStateEvent.Members,s.RoomStateEvent.NewMember,s.RoomStateEvent.Update]),F.currentState.on(s.RoomStateEvent.NewMember,(C,O,I)=>{var D;I.user=(D=this.client.getUser(I.userId))!==null&&D!==void 0?D:void 0,this.client.reEmitter.reEmit(I,[o.RoomMemberEvent.Name,o.RoomMemberEvent.Typing,o.RoomMemberEvent.PowerLevel,o.RoomMemberEvent.Membership])})}shouldAbortSync(F){return F.errcode==="M_UNKNOWN_TOKEN"?(m.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(a.SyncState.Error,{error:F}),!0):!1}processRoomData(F,C,O){var I;return y(this,void 0,void 0,function*(){O=M(F,C.roomId,O);const D=A(this.client,C.roomId,O.required_state);let j=A(this.client,C.roomId,O.timeline,!1);const Y=[];if(O.initial){const R=new Set;C.getLiveTimeline().getEvents().forEach(x=>{R.add(x.getId())});const k=[],P=[];let V=!1;for(let x=j.length-1;x>=0;x--){const Q=j[x];if(R.has(Q.getId())){V=!0;continue}V?k.push(Q):P.unshift(Q)}j=P,k.length>0&&C.addEventsToTimeline(k,!0,C.getLiveTimeline(),O.prev_batch)}const q=this.client.isRoomEncrypted(C.roomId);if(O.notification_count!=null&&C.setUnreadNotificationCount(c.NotificationCountType.Total,O.notification_count),O.highlight_count!=null&&(!q||q&&C.getUnreadNotificationCount(c.NotificationCountType.Highlight)<=0)&&C.setUnreadNotificationCount(c.NotificationCountType.Highlight,O.highlight_count),Number.isInteger(O.invited_count)&&C.currentState.setInvitedMemberCount(O.invited_count),Number.isInteger(O.joined_count)&&C.currentState.setJoinedMemberCount(O.joined_count),O.invite_state){const R=A(this.client,C.roomId,O.invite_state);this.injectRoomEvents(C,R),O.initial&&(C.recalculate(),this.client.store.storeRoom(C),this.client.emit(b.ClientEvent.Room,C)),R.forEach(k=>{this.client.emit(b.ClientEvent.Event,k)}),C.updateMyMembership("invite");return}O.initial&&C.getLiveTimeline().setPaginationToken((I=O.prev_batch)!==null&&I!==void 0?I:null,d.EventTimeline.BACKWARDS),this.injectRoomEvents(C,D,j,O.num_live),C.addEphemeralEvents(Y),C.updateMyMembership("join"),C.recalculate(),O.initial&&(F.store.storeRoom(C),F.emit(b.ClientEvent.Room,C)),this.addNotifications(j);const B=R=>y(this,void 0,void 0,function*(){F.emit(b.ClientEvent.Event,R),R.isState()&&R.getType()==r.EventType.RoomEncryption&&this.syncOpts.cryptoCallbacks&&(yield this.syncOpts.cryptoCallbacks.onCryptoEvent(C,R))});yield h.promiseMapSeries(D,B),yield h.promiseMapSeries(j,B),Y.forEach(function(R){F.emit(b.ClientEvent.Event,R)}),C.decryptCriticalEvents()})}injectRoomEvents(F,C,O,I){O=O||[],C=C||[],I=I||0;const D=F.getLiveTimeline(),j=D.getEvents().length==0;if(j){for(const q of C)this.client.getPushActionsForEvent(q);D.initialiseState(C)}j||(F.oldState.setStateEvents(C),F.currentState.setStateEvents(C));let Y=[];I>0&&(Y=O.slice(-1*I),O=O.slice(0,-1*Y.length)),F.addLiveEvents(O,{fromCache:!0}),Y.length>0&&F.addLiveEvents(Y,{fromCache:!1}),F.recalculate(),this.resolveInvites(F)}resolveInvites(F){if(!F||!this.opts.resolveInvitesToProfiles)return;const C=this.client;F.getMembersWithMembership("invite").forEach(function(O){if(O.requestedProfileInfo)return;O.requestedProfileInfo=!0;const I=C.getUser(O.userId);let D;I?D=Promise.resolve({avatar_url:I.avatarUrl,displayname:I.displayName}):D=C.getProfileInfo(O.userId),D.then(function(j){const Y=O.events.member;Y.getContent().membership==="invite"&&(Y.getContent().avatar_url=j.avatar_url,Y.getContent().displayname=j.displayname,O.setMembershipEvent(Y,F.currentState))},function(j){})})}retryImmediately(){return!0}sync(){return y(this,void 0,void 0,function*(){for(m.logger.debug("Sliding sync init loop");!this.client.isGuest();)try{m.logger.debug("Getting push rules...");const F=yield this.client.getPushRules();m.logger.debug("Got push rules"),this.client.pushRules=F;break}catch(F){if(m.logger.error("Getting push rules failed",F),this.shouldAbortSync(F))return}yield this.slidingSync.start()})}stop(){m.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(F,C){const O=this.syncState;this.syncState=F,this.syncStateData=C,this.client.emit(b.ClientEvent.Sync,this.syncState,O,C)}addNotifications(F){if(this.client.getNotifTimelineSet())for(const C of F){const O=this.client.getPushActionsForEvent(C);O&&O.notify&&O.tweaks&&O.tweaks.highlight&&this.notifEvents.push(C)}}purgeNotifications(){this.notifEvents.sort(function(F,C){return F.getTs()-C.getTs()}),this.notifEvents.forEach(F=>{var C;(C=this.client.getNotifTimelineSet())===null||C===void 0||C.addLiveEvent(F)}),this.notifEvents=[]}}e.SlidingSyncSdk=w;function M(ee,F,C){if(!C.name)return C;for(const O of C.required_state)if(O.type===r.EventType.RoomName&&O.state_key==="")return O.content={name:C.name},C;return C.required_state.push({event_id:"$fake-sliding-sync-name-event-"+F,state_key:"",type:r.EventType.RoomName,content:{name:C.name},sender:ee.getUserId(),origin_server_ts:new Date().getTime()}),C}function A(ee,F,C,O=!0){const I=ee.getEventMapper({decrypt:O});return C.map(function(D){return D.room_id=F,I(D)})}function W(ee,F,C){const O=A(ee,F,C),I=ee.getRoom(F);if(!I){m.logger.warn("got ephemeral events for room but room doesn't exist on client:",F);return}I.addEphemeralEvents(O),O.forEach(D=>{ee.emit(b.ClientEvent.Event,D)})}},{"./@types/event":306,"./client":321,"./http-api":367,"./logger":374,"./models/event-timeline":382,"./models/room":392,"./models/room-member":389,"./models/room-state":390,"./sliding-sync":407,"./sync":414,"./utils":416}],407:[function(t,E,e){var u=this&&this.__awaiter||function(i,r,s,o){function l(v){return v instanceof s?v:new s(function(f){f(v)})}return new(s||(s=Promise))(function(v,f){function p(w){try{T(o.next(w))}catch(M){f(M)}}function _(w){try{T(o.throw(w))}catch(M){f(M)}}function T(w){w.done?v(w.value):l(w.value).then(p,_)}T((o=o.apply(i,r||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.SlidingSync=e.SlidingSyncEvent=e.ExtensionState=e.SlidingSyncState=e.MSC3575_STATE_KEY_LAZY=e.MSC3575_STATE_KEY_ME=e.MSC3575_WILDCARD=void 0;const g=t("./logger"),S=t("./models/typed-event-emitter"),y=t("./utils"),c=10*1e3;e.MSC3575_WILDCARD="*",e.MSC3575_STATE_KEY_ME="$ME",e.MSC3575_STATE_KEY_LAZY="$LAZY";var m;(function(i){i.RequestFinished="FINISHED",i.Complete="COMPLETE"})(m=e.SlidingSyncState||(e.SlidingSyncState={}));class h{constructor(r){this.roomIndexToRoomId={},this.joinedCount=0,this.replaceList(r)}setModified(r){this.isModified=r}updateListRange(r){this.list.ranges=JSON.parse(JSON.stringify(r))}replaceList(r){r.filters=r.filters||{},r.ranges=r.ranges||[],this.list=JSON.parse(JSON.stringify(r)),this.isModified=!0,this.roomIndexToRoomId={},this.joinedCount=0}getList(r){let s={ranges:JSON.parse(JSON.stringify(this.list.ranges))};return(this.isModified||r)&&(s=JSON.parse(JSON.stringify(this.list))),s}isIndexInRange(r){for(const s of this.list.ranges)if(s[0]<=r&&r<=s[1])return!0;return!1}}var d;(function(i){i.PreProcess="ExtState.PreProcess",i.PostProcess="ExtState.PostProcess"})(d=e.ExtensionState||(e.ExtensionState={}));var b;(function(i){i.RoomData="SlidingSync.RoomData",i.Lifecycle="SlidingSync.Lifecycle",i.List="SlidingSync.List"})(b=e.SlidingSyncEvent||(e.SlidingSyncEvent={}));class a extends S.TypedEventEmitter{constructor(r,s,o,l,v){super(),this.proxyBaseUrl=r,this.roomSubscriptionInfo=o,this.client=l,this.timeoutMS=v,this.listModifiedCount=0,this.terminated=!1,this.needsResend=!1,this.txnId=null,this.txnIdDefers=[],this.extensions={},this.desiredRoomSubscriptions=new Set,this.confirmedRoomSubscriptions=new Set,this.customSubscriptions=new Map,this.roomIdToCustomSubscription=new Map,this.lists=new Map,s.forEach((f,p)=>{this.lists.set(p,new h(f))})}addCustomSubscription(r,s){if(this.customSubscriptions.has(r)){g.logger.warn(`addCustomSubscription: ${r} already exists as a custom subscription, ignoring.`);return}this.customSubscriptions.set(r,s)}useCustomSubscription(r,s){this.roomIdToCustomSubscription.get(r)!==s&&(this.roomIdToCustomSubscription.set(r,s),this.confirmedRoomSubscriptions.delete(r))}getListData(r){const s=this.lists.get(r);return s?{joinedCount:s.joinedCount,roomIndexToRoomId:Object.assign({},s.roomIndexToRoomId)}:null}getListParams(r){const s=this.lists.get(r);return s?s.getList(!0):null}setListRanges(r,s){const o=this.lists.get(r);return o?(o.updateListRange(s),this.resend()):Promise.reject(new Error("no list with key "+r))}setList(r,s){const o=this.lists.get(r);return o?(o.replaceList(s),this.lists.set(r,o)):this.lists.set(r,new h(s)),this.listModifiedCount+=1,this.resend()}getRoomSubscriptions(){return new Set(Array.from(this.desiredRoomSubscriptions))}modifyRoomSubscriptions(r){return this.desiredRoomSubscriptions=r,this.resend()}modifyRoomSubscriptionInfo(r){return this.roomSubscriptionInfo=r,this.confirmedRoomSubscriptions=new Set,this.resend()}registerExtension(r){if(this.extensions[r.name()])throw new Error(`registerExtension: ${r.name()} already exists as an extension`);this.extensions[r.name()]=r}getExtensionRequest(r){const s={};return Object.keys(this.extensions).forEach(o=>{s[o]=this.extensions[o].onRequest(r)}),s}onPreExtensionsResponse(r){Object.keys(r).forEach(s=>{this.extensions[s].when()==d.PreProcess&&this.extensions[s].onResponse(r[s])})}onPostExtensionsResponse(r){Object.keys(r).forEach(s=>{this.extensions[s].when()==d.PostProcess&&this.extensions[s].onResponse(r[s])})}invokeRoomDataListeners(r,s){s.required_state||(s.required_state=[]),s.timeline||(s.timeline=[]),this.emit(b.RoomData,r,s)}invokeLifecycleListeners(r,s,o){this.emit(b.Lifecycle,r,s,o)}shiftRight(r,s,o){const l=this.lists.get(r);if(l)for(let v=s;v>o;v--)l.isIndexInRange(v)&&(l.roomIndexToRoomId[v]=l.roomIndexToRoomId[v-1])}shiftLeft(r,s,o){const l=this.lists.get(r);if(l)for(let v=o;v<s;v++)l.isIndexInRange(v)&&(l.roomIndexToRoomId[v]=l.roomIndexToRoomId[v+1])}removeEntry(r,s){const o=this.lists.get(r);if(!o)return;let l=-1;for(const v in o.roomIndexToRoomId)Number(v)>l&&(l=Number(v));l<0||s>l||(this.shiftLeft(r,l,s),delete o.roomIndexToRoomId[l])}addEntry(r,s){const o=this.lists.get(r);if(!o)return;let l=-1;for(const v in o.roomIndexToRoomId)Number(v)>l&&(l=Number(v));l<0||s>l||this.shiftRight(r,l+1,s)}processListOps(r,s){let o=-1;const l=this.lists.get(s);l&&(r.ops.forEach(v=>{if(l)switch(v.op){case"DELETE":{g.logger.debug("DELETE",s,v.index,";"),delete l.roomIndexToRoomId[v.index],o!==-1&&this.removeEntry(s,o),o=v.index;break}case"INSERT":{g.logger.debug("INSERT",s,v.index,v.room_id,";"),l.roomIndexToRoomId[v.index]&&(o<0?this.addEntry(s,v.index):o>v.index?this.shiftRight(s,o,v.index):o<v.index&&this.shiftLeft(s,v.index,o)),o=-1,l.roomIndexToRoomId[v.index]=v.room_id;break}case"INVALIDATE":{const f=v.range[0];for(let p=f;p<=v.range[1];p++)delete l.roomIndexToRoomId[p];g.logger.debug("INVALIDATE",s,v.range[0],v.range[1],";");break}case"SYNC":{const f=v.range[0];for(let p=f;p<=v.range[1];p++){const _=v.room_ids[p-f];if(!_)break;l.roomIndexToRoomId[p]=_}g.logger.debug("SYNC",s,v.range[0],v.range[1],(v.room_ids||[]).join(" "),";");break}}}),o!==-1&&this.removeEntry(s,o))}resend(){var r;if(this.needsResend&&this.txnIdDefers.length>0)return this.txnIdDefers[this.txnIdDefers.length-1].promise;this.needsResend=!0,this.txnId=this.client.makeTxnId();const s=(0,y.defer)();return this.txnIdDefers.push(Object.assign(Object.assign({},s),{txnId:this.txnId})),(r=this.abortController)===null||r===void 0||r.abort(),this.abortController=new AbortController,s.promise}resolveTransactionDefers(r){if(!r)return;let s=-1;for(let o=0;o<this.txnIdDefers.length;o++)if(this.txnIdDefers[o].txnId===r){s=o;break}if(s===-1){g.logger.warn(`resolveTransactionDefers: seen ${r} but it isn't a pending txn, ignoring.`);return}for(let o=0;o<s;o++)this.txnIdDefers[o].reject(this.txnIdDefers[o].txnId);this.txnIdDefers[s].resolve(r),this.txnIdDefers=this.txnIdDefers.slice(s+1)}stop(){var r;this.terminated=!0,(r=this.abortController)===null||r===void 0||r.abort(),this.removeAllListeners(b.Lifecycle),this.removeAllListeners(b.List),this.removeAllListeners(b.RoomData)}resetup(){var r;g.logger.warn("SlidingSync: resetting connection info"),this.txnIdDefers.forEach(s=>{s.reject(s.txnId)}),this.txnIdDefers=[],this.lists.forEach(s=>{s.setModified(!0)}),this.confirmedRoomSubscriptions=new Set,this.needsResend=!0,(r=this.abortController)===null||r===void 0||r.abort(),this.abortController=new AbortController}start(){return u(this,void 0,void 0,function*(){this.abortController=new AbortController;let r;for(;!this.terminated;){this.needsResend=!1;let s=!1,o;try{const v=this.listModifiedCount,f={};this.lists.forEach((w,M)=>{f[M]=w.getList(!1)});const p={lists:f,pos:r,timeout:this.timeoutMS,clientTimeout:this.timeoutMS+c,extensions:this.getExtensionRequest(r===void 0)},_=n(this.desiredRoomSubscriptions,this.confirmedRoomSubscriptions),T=n(this.confirmedRoomSubscriptions,this.desiredRoomSubscriptions);if(T.size>0&&(p.unsubscribe_rooms=Array.from(T)),_.size>0){p.room_subscriptions={};for(const w of _){const M=this.roomIdToCustomSubscription.get(w);let A=this.roomSubscriptionInfo;M&&this.customSubscriptions.has(M)&&(A=this.customSubscriptions.get(M)),p.room_subscriptions[w]=A}}this.txnId&&(p.txn_id=this.txnId,this.txnId=null),this.pendingReq=this.client.slidingSync(p,this.proxyBaseUrl,this.abortController.signal),o=yield this.pendingReq,r=o.pos;for(const w of _)this.confirmedRoomSubscriptions.add(w);for(const w of T)this.confirmedRoomSubscriptions.delete(w);v!==this.listModifiedCount&&(g.logger.debug("list modified during await call, not updating list"),s=!0),this.lists.forEach(w=>{w.setModified(!1)}),o.lists=o.lists||{},o.rooms=o.rooms||{},o.extensions=o.extensions||{},Object.keys(o.lists).forEach(w=>{const M=this.lists.get(w);!M||!o||(M.joinedCount=o.lists[w].count)}),this.invokeLifecycleListeners(m.RequestFinished,o)}catch(v){if(v.httpStatus){if(this.invokeLifecycleListeners(m.RequestFinished,null,v),v.httpStatus===400){this.resetup(),r=void 0,yield(0,y.sleep)(50);continue}}else if(this.needsResend||v.name==="AbortError")continue;g.logger.error(v),yield(0,y.sleep)(5e3)}if(!o)continue;this.onPreExtensionsResponse(o.extensions),Object.keys(o.rooms).forEach(v=>{this.invokeRoomDataListeners(v,o.rooms[v])});const l=new Set;if(!s)for(const[v,f]of Object.entries(o.lists))f.ops=f.ops||[],f.ops.length>0&&l.add(v),this.processListOps(f,v);this.invokeLifecycleListeners(m.Complete,o),this.onPostExtensionsResponse(o.extensions),l.forEach(v=>{const f=this.lists.get(v);f&&this.emit(b.List,v,f.joinedCount,Object.assign({},f.roomIndexToRoomId))}),this.resolveTransactionDefers(o.txn_id)}})}}e.SlidingSync=a;const n=(i,r)=>{const s=new Set(i);for(const o of r)s.delete(o);return s}},{"./logger":374,"./models/typed-event-emitter":395,"./utils":416}],408:[function(t,E,e){var u=this&&this.__createBinding||(Object.create?function(v,f,p,_){_===void 0&&(_=p);var T=Object.getOwnPropertyDescriptor(f,p);(!T||("get"in T?!f.__esModule:T.writable||T.configurable))&&(T={enumerable:!0,get:function(){return f[p]}}),Object.defineProperty(v,_,T)}:function(v,f,p,_){_===void 0&&(_=p),v[_]=f[p]}),g=this&&this.__setModuleDefault||(Object.create?function(v,f){Object.defineProperty(v,"default",{enumerable:!0,value:f})}:function(v,f){v.default=f}),S=this&&this.__importStar||function(v){if(v&&v.__esModule)return v;var f={};if(v!=null)for(var p in v)p!=="default"&&Object.prototype.hasOwnProperty.call(v,p)&&u(f,v,p);return g(f,v),f},y=this&&this.__awaiter||function(v,f,p,_){function T(w){return w instanceof p?w:new p(function(M){M(w)})}return new(p||(p=Promise))(function(w,M){function A(F){try{ee(_.next(F))}catch(C){M(C)}}function W(F){try{ee(_.throw(F))}catch(C){M(C)}}function ee(F){F.done?w(F.value):T(F.value).then(A,W)}ee((_=_.apply(v,f||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.LocalIndexedDBStoreBackend=void 0;const c=t("../sync-accumulator"),m=S(t("../utils")),h=S(t("../indexeddb-helpers")),d=t("../logger"),b=[v=>{v.createObjectStore("users",{keyPath:["userId"]}),v.createObjectStore("accountData",{keyPath:["type"]}),v.createObjectStore("sync",{keyPath:["clobber"]})},v=>{v.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")},v=>{v.createObjectStore("client_options",{keyPath:["clobber"]})},v=>{v.createObjectStore("to_device_queue",{autoIncrement:!0})}],a=b.length;function n(v,f,p){const _=v.openCursor(f);return new Promise((T,w)=>{const M=[];_.onerror=()=>{w(new Error("Query failed: "+_.error))},_.onsuccess=()=>{const A=_.result;if(!A){T(M);return}M.push(p(A)),A.continue()}})}function i(v){return new Promise((f,p)=>{v.oncomplete=function(_){f(_)},v.onerror=function(){p(v.error)}})}function r(v){return new Promise((f,p)=>{v.onsuccess=function(_){f(_)},v.onerror=function(){p(v.error)}})}function s(v){return new Promise((f,p)=>{v.onsuccess=()=>f(v),v.onerror=_=>p(_)})}function o(v){return r(v).then(f=>v.result)}class l{static exists(f,p){return p="matrix-js-sdk:"+(p||"default"),h.exists(f,p)}constructor(f,p="default"){this.indexedDB=f,this.disconnected=!0,this._isNewlyCreated=!1,this.pendingUserPresenceData=[],this.dbName="matrix-js-sdk:"+p,this.syncAccumulator=new c.SyncAccumulator}connect(f){if(!this.disconnected)return d.logger.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,d.logger.log("LocalIndexedDBStoreBackend.connect: connecting...");const p=this.indexedDB.open(this.dbName,a);return p.onupgradeneeded=_=>{const T=p.result,w=_.oldVersion;d.logger.log(`LocalIndexedDBStoreBackend.connect: upgrading from ${w}`),w<1&&(this._isNewlyCreated=!0),b.forEach((M,A)=>{w<=A&&M(T)})},p.onblocked=()=>{d.logger.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},d.logger.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),r(p).then(()=>y(this,void 0,void 0,function*(){d.logger.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=p.result,this.db.onversionchange=()=>{var _;(_=this.db)===null||_===void 0||_.close(),this.disconnected=!0,this.db=void 0,f==null||f()},this.db.onclose=()=>{this.disconnected=!0,this.db=void 0,f==null||f()},yield this.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(([f,p])=>{d.logger.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:p.nextBatch,rooms:p.roomsData,account_data:{events:f}},!0)})}getOutOfBandMembers(f){return new Promise((p,_)=>{const M=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),A=IDBKeyRange.only(f),W=M.openCursor(A),ee=[];let F=!1;W.onsuccess=()=>{const C=W.result;if(!C)return!ee.length&&!F?p(null):p(ee);const O=C.value;O.oob_written?F=!0:ee.push(O),C.continue()},W.onerror=C=>{_(C)}}).then(p=>(d.logger.log(`LL: got ${p==null?void 0:p.length} membershipEvents from storage for room ${f} ...`),p))}setOutOfBandMembers(f,p){return y(this,void 0,void 0,function*(){d.logger.log(`LL: backend about to store ${p.length} members for ${f}`);const _=this.db.transaction(["oob_membership_events"],"readwrite"),T=_.objectStore("oob_membership_events");p.forEach(M=>{T.put(M)});const w={room_id:f,oob_written:!0,state_key:0};T.put(w),yield i(_),d.logger.log(`LL: backend done storing for ${f}!`)})}clearOutOfBandMembers(f){return y(this,void 0,void 0,function*(){const T=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),w=IDBKeyRange.only(f),M=o(T.openKeyCursor(w,"next")).then(I=>(I==null?void 0:I.primaryKey)[1]),A=o(T.openKeyCursor(w,"prev")).then(I=>(I==null?void 0:I.primaryKey)[1]),[W,ee]=yield Promise.all([M,A]),C=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),O=IDBKeyRange.bound([f,W],[f,ee]);d.logger.log(`LL: Deleting all users + marker in storage for room ${f}, with key range:`,[f,W],[f,ee]),yield s(C.delete(O))})}clearDatabase(){return new Promise(f=>{d.logger.log(`Removing indexeddb instance: ${this.dbName}`);const p=this.indexedDB.deleteDatabase(this.dbName);p.onblocked=()=>{d.logger.log(`can't yet delete indexeddb ${this.dbName} because it is open elsewhere`)},p.onerror=()=>{d.logger.warn(`unable to delete js-sdk store indexeddb: ${p.error}`),f()},p.onsuccess=()=>{d.logger.log(`Removed indexeddb instance: ${this.dbName}`),f()}})}getSavedSync(f=!0){const p=this.syncAccumulator.getJSON();return p.nextBatch?f?Promise.resolve(m.deepCopy(p)):Promise.resolve(p):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(f){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(f)})}syncToDatabase(f){return y(this,void 0,void 0,function*(){return this.syncToDatabasePromise?(d.logger.warn("Skipping syncToDatabase() as persist already in flight"),this.pendingUserPresenceData.push(...f),this.syncToDatabasePromise):(f.unshift(...this.pendingUserPresenceData),this.syncToDatabasePromise=this.doSyncToDatabase(f),this.syncToDatabasePromise)})}doSyncToDatabase(f){return y(this,void 0,void 0,function*(){try{const p=this.syncAccumulator.getJSON(!0);yield Promise.all([this.persistUserPresenceEvents(f),this.persistAccountData(p.accountData),this.persistSyncData(p.nextBatch,p.roomsData)])}finally{this.syncToDatabasePromise=void 0}})}persistSyncData(f,p){return d.logger.log("Persisting sync data up to",f),m.promiseTry(()=>{const _=this.db.transaction(["sync"],"readwrite");return _.objectStore("sync").put({clobber:"-",nextBatch:f,roomsData:p}),i(_).then(()=>{d.logger.log("Persisted sync data up to",f)})})}persistAccountData(f){return m.promiseTry(()=>{const p=this.db.transaction(["accountData"],"readwrite"),_=p.objectStore("accountData");for(const T of f)_.put(T);return i(p).then()})}persistUserPresenceEvents(f){return m.promiseTry(()=>{const p=this.db.transaction(["users"],"readwrite"),_=p.objectStore("users");for(const T of f)_.put({userId:T[0],event:T[1]});return i(p).then()})}getUserPresenceEvents(){return m.promiseTry(()=>{const p=this.db.transaction(["users"],"readonly").objectStore("users");return n(p,void 0,_=>[_.value.userId,_.value.event])})}loadAccountData(){return d.logger.log("LocalIndexedDBStoreBackend: loading account data..."),m.promiseTry(()=>{const p=this.db.transaction(["accountData"],"readonly").objectStore("accountData");return n(p,void 0,_=>_.value).then(_=>(d.logger.log("LocalIndexedDBStoreBackend: loaded account data"),_))})}loadSyncData(){return d.logger.log("LocalIndexedDBStoreBackend: loading sync data..."),m.promiseTry(()=>{const p=this.db.transaction(["sync"],"readonly").objectStore("sync");return n(p,void 0,_=>_.value).then(_=>(d.logger.log("LocalIndexedDBStoreBackend: loaded sync data"),_.length>1&&d.logger.warn("loadSyncData: More than 1 sync row found."),_.length>0?_[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{const p=this.db.transaction(["client_options"],"readonly").objectStore("client_options");return n(p,void 0,_=>{var T;return(T=_.value)===null||T===void 0?void 0:T.options}).then(_=>_[0])})}storeClientOptions(f){return y(this,void 0,void 0,function*(){const p=this.db.transaction(["client_options"],"readwrite");p.objectStore("client_options").put({clobber:"-",options:f}),yield i(p)})}saveToDeviceBatches(f){return y(this,void 0,void 0,function*(){const p=this.db.transaction(["to_device_queue"],"readwrite"),_=p.objectStore("to_device_queue");for(const T of f)_.add(T);yield i(p)})}getOldestToDeviceBatch(){return y(this,void 0,void 0,function*(){const p=this.db.transaction(["to_device_queue"],"readonly").objectStore("to_device_queue"),_=yield o(p.openCursor());if(!_)return null;const T=_.value;return{id:_.key,txnId:T.txnId,eventType:T.eventType,batch:T.batch}})}removeToDeviceBatch(f){return y(this,void 0,void 0,function*(){const p=this.db.transaction(["to_device_queue"],"readwrite");p.objectStore("to_device_queue").delete(f),yield i(p)})}}e.LocalIndexedDBStoreBackend=l},{"../indexeddb-helpers":372,"../logger":374,"../sync-accumulator":413,"../utils":416}],409:[function(t,E,e){var u=this&&this.__awaiter||function(c,m,h,d){function b(a){return a instanceof h?a:new h(function(n){n(a)})}return new(h||(h=Promise))(function(a,n){function i(o){try{s(d.next(o))}catch(l){n(l)}}function r(o){try{s(d.throw(o))}catch(l){n(l)}}function s(o){o.done?a(o.value):b(o.value).then(i,r)}s((d=d.apply(c,m||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.RemoteIndexedDBStoreBackend=void 0;const g=t("../logger"),S=t("../utils");class y{constructor(m,h){this.workerFactory=m,this.dbName=h,this.nextSeq=0,this.inFlight={},this.onWorkerMessage=d=>{var b;const a=d.data;if(a.command=="closed")(b=this.onClose)===null||b===void 0||b.call(this);else if(a.command=="cmd_success"||a.command=="cmd_fail"){if(a.seq===void 0){g.logger.error("Got reply from worker with no seq");return}const n=this.inFlight[a.seq];if(n===void 0){g.logger.error("Got reply for unknown seq "+a.seq);return}if(delete this.inFlight[a.seq],a.command=="cmd_success")n.resolve(a.result);else{const i=new Error(a.error.message);i.name=a.error.name,n.reject(i)}}else g.logger.warn("Unrecognised message from worker: ",a)}}connect(m){return this.onClose=m,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(m){return this.doCmd("setSyncData",[m])}syncToDatabase(m){return this.doCmd("syncToDatabase",[m])}getOutOfBandMembers(m){return this.doCmd("getOutOfBandMembers",[m])}setOutOfBandMembers(m,h){return this.doCmd("setOutOfBandMembers",[m,h])}clearOutOfBandMembers(m){return this.doCmd("clearOutOfBandMembers",[m])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(m){return this.doCmd("storeClientOptions",[m])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(m){return u(this,void 0,void 0,function*(){return this.doCmd("saveToDeviceBatches",[m])})}getOldestToDeviceBatch(){return u(this,void 0,void 0,function*(){return this.doCmd("getOldestToDeviceBatch")})}removeToDeviceBatch(m){return u(this,void 0,void 0,function*(){return this.doCmd("removeToDeviceBatch",[m])})}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{g.logger.log("IndexedDB worker is ready")})),this.startPromise}doCmd(m,h){return Promise.resolve().then(()=>{var d;const b=this.nextSeq++,a=(0,S.defer)();return this.inFlight[b]=a,(d=this.worker)===null||d===void 0||d.postMessage({command:m,seq:b,args:h}),a.promise})}}e.RemoteIndexedDBStoreBackend=y},{"../logger":374,"../utils":416}],410:[function(t,E,e){var u=this&&this.__awaiter||function(i,r,s,o){function l(v){return v instanceof s?v:new s(function(f){f(v)})}return new(s||(s=Promise))(function(v,f){function p(w){try{T(o.next(w))}catch(M){f(M)}}function _(w){try{T(o.throw(w))}catch(M){f(M)}}function T(w){w.done?v(w.value):l(w.value).then(p,_)}T((o=o.apply(i,r||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.IndexedDBStore=void 0;const g=t("./memory"),S=t("./indexeddb-local-backend"),y=t("./indexeddb-remote-backend"),c=t("../models/user"),m=t("../models/event"),h=t("../logger"),d=t("../models/typed-event-emitter"),b=1e3*60*5;class a extends g.MemoryStore{static exists(r,s){return S.LocalIndexedDBStoreBackend.exists(r,s)}constructor(r){if(super(r),this.startedUp=!1,this.syncTs=0,this.userModifiedMap={},this.emitter=new d.TypedEventEmitter,this.on=this.emitter.on.bind(this.emitter),this.onClose=()=>{this.emitter.emit("closed")},this.getSavedSync=this.degradable(()=>this.backend.getSavedSync(),"getSavedSync"),this.isNewlyCreated=this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated"),this.getSavedSyncToken=this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken"),this.deleteAllData=this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{h.logger.log("Deleted indexeddb data.")},s=>{throw h.logger.error(`Failed to delete indexeddb data: ${s}`),s}))),this.reallySave=this.degradable(()=>{this.syncTs=Date.now();const s=[];for(const o of this.getUsers())this.userModifiedMap[o.userId]!==o.getLastModifiedTime()&&o.events.presence&&(s.push([o.userId,o.events.presence.event]),this.userModifiedMap[o.userId]=o.getLastModifiedTime());return this.backend.syncToDatabase(s)}),this.setSyncData=this.degradable(s=>this.backend.setSyncData(s),"setSyncData"),this.getOutOfBandMembers=this.degradable(s=>this.backend.getOutOfBandMembers(s),"getOutOfBandMembers"),this.setOutOfBandMembers=this.degradable((s,o)=>(super.setOutOfBandMembers(s,o),this.backend.setOutOfBandMembers(s,o)),"setOutOfBandMembers"),this.clearOutOfBandMembers=this.degradable(s=>(super.clearOutOfBandMembers(s),this.backend.clearOutOfBandMembers(s)),"clearOutOfBandMembers"),this.getClientOptions=this.degradable(()=>this.backend.getClientOptions(),"getClientOptions"),this.storeClientOptions=this.degradable(s=>(super.storeClientOptions(s),this.backend.storeClientOptions(s)),"storeClientOptions"),!r.indexedDB)throw new Error("Missing required option: indexedDB");r.workerFactory?this.backend=new y.RemoteIndexedDBStoreBackend(r.workerFactory,r.dbName):this.backend=new S.LocalIndexedDBStoreBackend(r.indexedDB,r.dbName)}startup(){return this.startedUp?(h.logger.log("IndexedDBStore.startup: already started"),Promise.resolve()):(h.logger.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(h.logger.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(r=>{h.logger.log("IndexedDBStore.startup: processing presence events"),r.forEach(([s,o])=>{const l=new c.User(s);o&&l.setPresenceEvent(new m.MatrixEvent(o)),this.userModifiedMap[l.userId]=l.getLastModifiedTime(),this.storeUser(l)}),this.startedUp=!0}))}wantsSave(){return Date.now()-this.syncTs>b}save(r=!1){return r||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(r,s){const o=s?super[s]:null;return(...l)=>u(this,void 0,void 0,function*(){try{return yield r.call(this,...l)}catch(v){h.logger.error("IndexedDBStore failure, degrading to MemoryStore",v),this.emitter.emit("degraded",v);try{h.logger.log("IndexedDBStore trying to delete degraded data"),yield this.backend.clearDatabase(),h.logger.log("IndexedDBStore delete after degrading succeeded")}catch(f){h.logger.warn("IndexedDBStore delete after degrading failed",f)}if(o)return o.call(this,...l)}})}getPendingEvents(r){const s=Object.create(null,{getPendingEvents:{get:()=>super.getPendingEvents}});return u(this,void 0,void 0,function*(){if(!this.localStorage)return s.getPendingEvents.call(this,r);const o=this.localStorage.getItem(n(r));if(o)try{return JSON.parse(o)}catch(l){h.logger.error("Could not parse persisted pending events",l)}return[]})}setPendingEvents(r,s){const o=Object.create(null,{setPendingEvents:{get:()=>super.setPendingEvents}});return u(this,void 0,void 0,function*(){if(!this.localStorage)return o.setPendingEvents.call(this,r,s);s.length>0?this.localStorage.setItem(n(r),JSON.stringify(s)):this.localStorage.removeItem(n(r))})}saveToDeviceBatches(r){return this.backend.saveToDeviceBatches(r)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(r){return this.backend.removeToDeviceBatch(r)}}e.IndexedDBStore=a;function n(i){return`mx_pending_events_${i}`}},{"../logger":374,"../models/event":383,"../models/typed-event-emitter":395,"../models/user":396,"./indexeddb-local-backend":408,"./indexeddb-remote-backend":409,"./memory":411}],411:[function(t,E,e){var u=this&&this.__awaiter||function(h,d,b,a){function n(i){return i instanceof b?i:new b(function(r){r(i)})}return new(b||(b=Promise))(function(i,r){function s(v){try{l(a.next(v))}catch(f){r(f)}}function o(v){try{l(a.throw(v))}catch(f){r(f)}}function l(v){v.done?i(v.value):n(v.value).then(s,o)}l((a=a.apply(h,d||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.MemoryStore=void 0;const g=t("../models/user"),S=t("../models/room-state"),y=t("../utils");function c(h){return typeof h=="string"&&!!h&&h!=="undefined"&&h!=="null"||typeof h=="number"}class m{constructor(d={}){this.rooms={},this.users={},this.syncToken=null,this.filters=new y.MapWithDefault(()=>new Map),this.accountData=new Map,this.oobMembers=new Map,this.pendingEvents={},this.pendingToDeviceBatches=[],this.nextToDeviceBatchId=0,this.onRoomMember=(b,a,n)=>{if(n.membership==="invite")return;const i=this.users[n.userId]||new g.User(n.userId);n.name&&(i.setDisplayName(n.name),n.events.member&&i.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&i.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[i.userId]=i},this.localStorage=d.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(d){this.syncToken=d}storeRoom(d){this.rooms[d.roomId]=d,d.currentState.on(S.RoomStateEvent.Members,this.onRoomMember),d.currentState.getMembers().forEach(b=>{this.onRoomMember(null,d.currentState,b)})}getRoom(d){return this.rooms[d]||null}getRooms(){return Object.values(this.rooms)}removeRoom(d){this.rooms[d]&&this.rooms[d].currentState.removeListener(S.RoomStateEvent.Members,this.onRoomMember),delete this.rooms[d]}getRoomSummaries(){return Object.values(this.rooms).map(function(d){return d.summary})}storeUser(d){this.users[d.userId]=d}getUser(d){return this.users[d]||null}getUsers(){return Object.values(this.users)}scrollback(d,b){return[]}storeEvents(d,b,a,n){}storeFilter(d){!(d!=null&&d.userId)||!(d!=null&&d.filterId)||this.filters.getOrCreate(d.userId).set(d.filterId,d)}getFilter(d,b){var a;return((a=this.filters.get(d))===null||a===void 0?void 0:a.get(b))||null}getFilterIdByName(d){if(!this.localStorage)return null;const b="mxjssdk_memory_filter_"+d;try{const a=this.localStorage.getItem(b);if(c(a))return a}catch{}return null}setFilterIdByName(d,b){if(!this.localStorage)return;const a="mxjssdk_memory_filter_"+d;try{c(b)?this.localStorage.setItem(a,b):this.localStorage.removeItem(a)}catch{}}storeAccountDataEvents(d){d.forEach(b=>{!Object.keys(b.getContent()).length?this.accountData.delete(b.getType()):this.accountData.set(b.getType(),b)})}getAccountData(d){return this.accountData.get(d)}setSyncData(d){return Promise.resolve()}wantsSave(){return!1}save(d){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new y.MapWithDefault(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(d){return Promise.resolve(this.oobMembers.get(d)||null)}setOutOfBandMembers(d,b){return this.oobMembers.set(d,b),Promise.resolve()}clearOutOfBandMembers(d){return this.oobMembers.delete(d),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(d){return this.clientOptions=Object.assign({},d),Promise.resolve()}getPendingEvents(d){var b;return u(this,void 0,void 0,function*(){return(b=this.pendingEvents[d])!==null&&b!==void 0?b:[]})}setPendingEvents(d,b){return u(this,void 0,void 0,function*(){this.pendingEvents[d]=b})}saveToDeviceBatches(d){for(const b of d)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:b.eventType,txnId:b.txnId,batch:b.batch});return Promise.resolve()}getOldestToDeviceBatch(){return u(this,void 0,void 0,function*(){return this.pendingToDeviceBatches.length===0?null:this.pendingToDeviceBatches[0]})}removeToDeviceBatch(d){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(b=>b.id!==d),Promise.resolve()}}e.MemoryStore=m},{"../models/room-state":390,"../models/user":396,"../utils":416}],412:[function(t,E,e){var u=this&&this.__awaiter||function(S,y,c,m){function h(d){return d instanceof c?d:new c(function(b){b(d)})}return new(c||(c=Promise))(function(d,b){function a(r){try{i(m.next(r))}catch(s){b(s)}}function n(r){try{i(m.throw(r))}catch(s){b(s)}}function i(r){r.done?d(r.value):h(r.value).then(a,n)}i((m=m.apply(S,y||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.StubStore=void 0;class g{constructor(){this.accountData=new Map,this.fromToken=null}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(y){this.fromToken=y}storeRoom(y){}getRoom(y){return null}getRooms(){return[]}removeRoom(y){}getRoomSummaries(){return[]}storeUser(y){}getUser(y){return null}getUsers(){return[]}scrollback(y,c){return[]}storeEvents(y,c,m,h){}storeFilter(y){}getFilter(y,c){return null}getFilterIdByName(y){return null}setFilterIdByName(y,c){}storeAccountDataEvents(y){}getAccountData(y){}setSyncData(y){return Promise.resolve()}wantsSave(){return!1}save(){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(y,c){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(y){return Promise.resolve()}getPendingEvents(y){return u(this,void 0,void 0,function*(){return[]})}setPendingEvents(y,c){return Promise.resolve()}saveToDeviceBatches(y){return u(this,void 0,void 0,function*(){return Promise.resolve()})}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(y){return u(this,void 0,void 0,function*(){return Promise.resolve()})}}e.StubStore=g},{}],413:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SyncAccumulator=e.Category=void 0;const u=t("./logger"),g=t("./utils"),S=t("./@types/event"),y=t("./@types/read_receipts"),c=t("./@types/sync");var m;(function(a){a.Invite="invite",a.Leave="leave",a.Join="join"})(m=e.Category||(e.Category={}));function h(a){return"_localTs"in a&&a._localTs!==void 0}class d{constructor(n={}){this.opts=n,this.accountData={},this.inviteRooms={},this.joinRooms={},this.nextBatch=null,this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(n,i=!1){this.accumulateRooms(n,i),this.accumulateAccountData(n),this.nextBatch=n.next_batch}accumulateAccountData(n){!n.account_data||!n.account_data.events||n.account_data.events.forEach(i=>{this.accountData[i.type]=i})}accumulateRooms(n,i=!1){n.rooms&&(n.rooms.invite&&Object.keys(n.rooms.invite).forEach(r=>{this.accumulateRoom(r,m.Invite,n.rooms.invite[r],i)}),n.rooms.join&&Object.keys(n.rooms.join).forEach(r=>{this.accumulateRoom(r,m.Join,n.rooms.join[r],i)}),n.rooms.leave&&Object.keys(n.rooms.leave).forEach(r=>{this.accumulateRoom(r,m.Leave,n.rooms.leave[r],i)}))}accumulateRoom(n,i,r,s=!1){switch(i){case m.Invite:this.accumulateInviteState(n,r);break;case m.Join:this.inviteRooms[n]&&delete this.inviteRooms[n],this.accumulateJoinState(n,r,s);break;case m.Leave:this.inviteRooms[n]?delete this.inviteRooms[n]:delete this.joinRooms[n];break;default:u.logger.error("Unknown cateogory: ",i)}}accumulateInviteState(n,i){if(!i.invite_state||!i.invite_state.events)return;if(!this.inviteRooms[n]){this.inviteRooms[n]={invite_state:i.invite_state};return}const r=this.inviteRooms[n];i.invite_state.events.forEach(s=>{let o=!1;for(let l=0;l<r.invite_state.events.length;l++){const v=r.invite_state.events[l];v.type===s.type&&v.state_key==s.state_key&&(r.invite_state.events[l]=s,o=!0)}o||r.invite_state.events.push(s)})}accumulateJoinState(n,i,r=!1){var s,o,l,v,f,p,_,T;this.joinRooms[n]||(this.joinRooms[n]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_readReceipts:{},_threadReadReceipts:{}});const w=this.joinRooms[n];if(i.account_data&&i.account_data.events&&i.account_data.events.forEach(M=>{w._accountData[M.type]=M}),i.unread_notifications&&(w._unreadNotifications=i.unread_notifications),w._unreadThreadNotifications=(o=(s=i[c.UNREAD_THREAD_NOTIFICATIONS.stable])!==null&&s!==void 0?s:i[c.UNREAD_THREAD_NOTIFICATIONS.unstable])!==null&&o!==void 0?o:void 0,i.summary){const M="m.heroes",A="m.invited_member_count",W="m.joined_member_count",ee=w._summary,F=i.summary;ee[M]=F[M]||ee[M],ee[W]=F[W]||ee[W],ee[A]=F[A]||ee[A]}if((v=(l=i.ephemeral)===null||l===void 0?void 0:l.events)===null||v===void 0||v.forEach(M=>{M.type!==S.EventType.Receipt||!M.content||Object.keys(M.content).forEach(A=>{Object.entries(M.content[A]).forEach(([W,ee])=>{var F;if((0,g.isSupportedReceiptType)(W))for(const C of Object.keys(ee)){const O=M.content[A][W][C],I={data:M.content[A][W][C],type:W,eventId:A};!O.thread_id||O.thread_id===y.MAIN_ROOM_TIMELINE?w._readReceipts[C]=I:w._threadReadReceipts=Object.assign(Object.assign({},w._threadReadReceipts),{[O.thread_id]:Object.assign(Object.assign({},(F=w._threadReadReceipts[O.thread_id])!==null&&F!==void 0?F:{}),{[C]:I})})}})})}),i.timeline&&i.timeline.limited&&(w._timeline=[]),(p=(f=i.state)===null||f===void 0?void 0:f.events)===null||p===void 0||p.forEach(M=>{b(w._currentState,M)}),(T=(_=i.timeline)===null||_===void 0?void 0:_.events)===null||T===void 0||T.forEach((M,A)=>{var W;b(w._currentState,M);let ee;if(r)ee=M;else{ee=Object.assign({},M),ee.unsigned!==void 0&&(ee.unsigned=Object.assign({},ee.unsigned));const F=M.unsigned?M.unsigned.age:M.age;F!==void 0&&(ee._localTs=Date.now()-F)}w._timeline.push({event:ee,token:A===0&&(W=i.timeline.prev_batch)!==null&&W!==void 0?W:null})}),w._timeline.length>this.opts.maxTimelineEntries){const M=w._timeline.length-this.opts.maxTimelineEntries;for(let A=M;A<w._timeline.length;A++)if(w._timeline[A].token){w._timeline=w._timeline.slice(A,w._timeline.length);break}}}getJSON(n=!1){const i={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach(s=>{i.invite[s]=this.inviteRooms[s]}),Object.keys(this.joinRooms).forEach(s=>{const o=this.joinRooms[s],l={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:o._unreadNotifications,unread_thread_notifications:o._unreadThreadNotifications,summary:o._summary};Object.keys(o._accountData).forEach(_=>{l.account_data.events.push(o._accountData[_])});const v={type:S.EventType.Receipt,room_id:s,content:{}},f=new g.MapWithDefault(()=>new g.MapWithDefault(()=>new Map));for(const[_,T]of Object.entries(o._readReceipts))f.getOrCreate(T.eventId).getOrCreate(T.type).set(_,T.data);for(const _ of Object.values(o._threadReadReceipts))for(const[T,w]of Object.entries(_))f.getOrCreate(w.eventId).getOrCreate(w.type).set(T,w.data);v.content=(0,g.recursiveMapToObject)(f),f.size>0&&l.ephemeral.events.push(v),o._timeline.forEach(_=>{if(!l.timeline.prev_batch){if(!_.token)return;l.timeline.prev_batch=_.token}let T;!n&&h(_.event)?(T=Object.assign({},_.event),T.unsigned!==void 0&&(T.unsigned=Object.assign({},T.unsigned)),delete T._localTs,T.unsigned=T.unsigned||{},T.unsigned.age=Date.now()-_.event._localTs):T=_.event,l.timeline.events.push(T)});const p=Object.create(null);for(let _=l.timeline.events.length-1;_>=0;_--){const T=l.timeline.events[_];if(T.state_key===null||T.state_key===void 0)continue;const w=(0,g.deepCopy)(T);w.unsigned&&(w.unsigned.prev_content&&(w.content=w.unsigned.prev_content),w.unsigned.prev_sender&&(w.sender=w.unsigned.prev_sender)),b(p,w)}Object.keys(o._currentState).forEach(_=>{Object.keys(o._currentState[_]).forEach(T=>{let w=o._currentState[_][T];p[_]&&p[_][T]&&(w=p[_][T]),l.state.events.push(w)})}),i.join[s]=l});const r=[];return Object.keys(this.accountData).forEach(s=>{r.push(this.accountData[s])}),{nextBatch:this.nextBatch,roomsData:i,accountData:r}}getNextBatchToken(){return this.nextBatch}}e.SyncAccumulator=d;function b(a,n){n.state_key===null||n.state_key===void 0||!n.type||(a[n.type]||(a[n.type]=Object.create(null)),a[n.type][n.state_key]=n)}},{"./@types/event":306,"./@types/read_receipts":311,"./@types/sync":314,"./logger":374,"./utils":416}],414:[function(t,E,e){(function(u){(function(){var g=this&&this.__createBinding||(Object.create?function(q,B,R,k){k===void 0&&(k=R);var P=Object.getOwnPropertyDescriptor(B,R);(!P||("get"in P?!B.__esModule:P.writable||P.configurable))&&(P={enumerable:!0,get:function(){return B[R]}}),Object.defineProperty(q,k,P)}:function(q,B,R,k){k===void 0&&(k=R),q[k]=B[R]}),S=this&&this.__setModuleDefault||(Object.create?function(q,B){Object.defineProperty(q,"default",{enumerable:!0,value:B})}:function(q,B){q.default=B}),y=this&&this.__importStar||function(q){if(q&&q.__esModule)return q;var B={};if(q!=null)for(var R in q)R!=="default"&&Object.prototype.hasOwnProperty.call(q,R)&&g(B,q,R);return S(B,q),B},c=this&&this.__awaiter||function(q,B,R,k){function P(V){return V instanceof R?V:new R(function(x){x(V)})}return new(R||(R=Promise))(function(V,x){function Q(de){try{ae(k.next(de))}catch(X){x(X)}}function te(de){try{ae(k.throw(de))}catch(X){x(X)}}function ae(de){de.done?V(de.value):P(de.value).then(Q,te)}ae((k=k.apply(q,B||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e._createAndReEmitRoom=e.SyncApi=e.defaultSyncApiOpts=e.defaultClientOpts=e.SyncState=void 0;const m=t("./models/user"),h=t("./models/room"),d=y(t("./utils")),b=t("./utils"),a=t("./filter"),n=t("./models/event-timeline"),i=t("./logger"),r=t("./errors"),s=t("./client"),o=t("./http-api"),l=t("./@types/event"),v=t("./models/room-state"),f=t("./models/room-member"),p=t("./models/beacon"),_=t("./@types/sync"),T=t("./feature"),w=80*1e3,M=3;var A;(function(q){q.Error="ERROR",q.Prepared="PREPARED",q.Stopped="STOPPED",q.Syncing="SYNCING",q.Catchup="CATCHUP",q.Reconnecting="RECONNECTING"})(A=e.SyncState||(e.SyncState={}));const W=["org.matrix.msc2716v3"];function ee(q,B){return`FILTER_SYNC_${q}`+(B?"_"+B:"")}function F(...q){i.logger.log(...q)}var C;(function(q){q.Offline="offline",q.Online="online",q.Unavailable="unavailable"})(C||(C={}));function O(q){return Object.assign({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:s.PendingEventOrdering.Chronological,threadSupport:!1},q)}e.defaultClientOpts=O;function I(q){return Object.assign({canResetEntireTimeline:B=>!1},q)}e.defaultSyncApiOpts=I;class D{constructor(B,R,k){this.client=B,this._peekRoom=null,this.syncState=null,this.catchingUp=!1,this.running=!1,this.notifEvents=[],this.failedSyncCount=0,this.storeIsInvalid=!1,this.getPushRules=()=>c(this,void 0,void 0,function*(){try{F("Getting push rules...");const P=yield this.client.getPushRules();F("Got push rules"),this.client.pushRules=P}catch(P){return i.logger.error("Getting push rules failed",P),this.shouldAbortSync(P)?void 0:(F("Waiting for saved sync before retrying push rules..."),yield this.recoverFromSyncStartupError(this.savedSyncPromise,P),this.getPushRules())}}),this.buildDefaultFilter=()=>{const P=new a.Filter(this.client.credentials.userId);return this.client.canSupport.get(T.Feature.ThreadUnreadNotifications)!==T.ServerSupport.Unsupported&&P.setUnreadThreadNotifications(!0),P},this.checkLazyLoadStatus=()=>c(this,void 0,void 0,function*(){var P;if(F("Checking lazy load status..."),this.opts.lazyLoadMembers&&this.client.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers&&(F("Checking server lazy load support..."),(yield this.client.doesServerSupportLazyLoading())?(F("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=this.buildDefaultFilter()),this.opts.filter.setLazyLoadMembers(!0)):(F("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)),F("Checking whether lazy loading has changed in store..."),yield this.wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this.storeIsInvalid=!0;const x=new r.InvalidStoreError(r.InvalidStoreState.ToggledLazyLoading,!!this.opts.lazyLoadMembers);this.updateSyncState(A.Error,{error:x}),i.logger.warn("InvalidStoreError: store is not usable: stopping sync.");return}this.opts.lazyLoadMembers&&((P=this.syncOpts.crypto)===null||P===void 0||P.enableLazyLoading());try{F("Storing client options..."),yield this.client.storeClientOptions(),F("Stored client options")}catch(x){throw i.logger.error("Storing client options failed",x),x}}),this.getFilter=()=>c(this,void 0,void 0,function*(){F("Getting filter...");let P;this.opts.filter?P=this.opts.filter:P=this.buildDefaultFilter();let V;try{V=yield this.client.getOrCreateFilter(ee(this.client.credentials.userId),P)}catch(x){return i.logger.error("Getting filter failed",x),this.shouldAbortSync(x)?{}:(F("Waiting for saved sync before retrying filter..."),yield this.recoverFromSyncStartupError(this.savedSyncPromise,x),this.getFilter())}return{filter:P,filterId:V}}),this.onOnline=()=>{F("Browser thinks we are back online"),this.startKeepAlives(0)},this.opts=O(R),this.syncOpts=I(k),B.getNotifTimelineSet()&&B.reEmitter.reEmit(B.getNotifTimelineSet(),[h.RoomEvent.Timeline,h.RoomEvent.TimelineReset])}createRoom(B){const R=Y(this.client,B,this.opts);return R.on(v.RoomStateEvent.Marker,(k,P)=>{this.onMarkerStateEvent(R,k,P)}),R}onMarkerStateEvent(B,R,{timelineWasEmpty:k}={}){if(k){i.logger.debug(`MarkerState: Ignoring markerEventId=${R.getId()} in roomId=${B.roomId} because the timeline was empty before the marker arrived which means there is nothing to refresh.`);return}W.includes(B.getVersion())||R.getSender()===B.getCreator()?(i.logger.debug(`MarkerState: Timeline needs to be refreshed because a new markerEventId=${R.getId()} was sent in roomId=${B.roomId}`),B.setTimelineNeedsRefresh(!0),B.emit(h.RoomEvent.HistoryImportedWithinTimeline,R,B)):i.logger.debug(`MarkerState: Ignoring markerEventId=${R.getId()} in roomId=${B.roomId} because MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.`)}syncLeftRooms(){var B;return c(this,void 0,void 0,function*(){const R=this.client,k=new a.Filter(this.client.credentials.userId);k.setTimelineLimit(1),k.setIncludeLeaveRooms(!0);const P=this.opts.pollTimeout+w,x={timeout:0,filter:yield R.getOrCreateFilter(ee(R.credentials.userId,"LEFT_ROOMS"),k)},Q=yield R.http.authedRequest(o.Method.Get,"/sync",x,void 0,{localTimeoutMs:P});let te=[];return!((B=Q.rooms)===null||B===void 0)&&B.leave&&(te=this.mapSyncResponseToRoomArray(Q.rooms.leave)),(yield Promise.all(te.map(de=>c(this,void 0,void 0,function*(){const X=de.room;if(!de.isBrandNewRoom)return;de.timeline=de.timeline||{prev_batch:null,events:[]};const $=this.mapSyncEventsFormat(de.timeline,X),K=this.mapSyncEventsFormat(de.state,X);return X.getLiveTimeline().setPaginationToken(de.timeline.prev_batch,n.EventTimeline.BACKWARDS),yield this.injectRoomEvents(X,K,$),X.recalculate(),R.store.storeRoom(X),R.emit(s.ClientEvent.Room,X),this.processEventsForNotifs(X,$),X})))).filter(Boolean)})}peek(B){var R;if(((R=this._peekRoom)===null||R===void 0?void 0:R.roomId)===B)return Promise.resolve(this._peekRoom);const k=this.client;return this._peekRoom=this.createRoom(B),this.client.roomInitialSync(B,20).then(P=>{P.messages=P.messages||{chunk:[]},P.messages.chunk=P.messages.chunk||[],P.state=P.state||[];const V=d.deepCopy(P.state).map(k.getEventMapper()),x=P.state.map(k.getEventMapper()),Q=P.messages.chunk.map(k.getEventMapper());return Array.isArray(P.presence)&&P.presence.map(k.getEventMapper()).forEach(function(te){let ae=k.store.getUser(te.getContent().user_id);ae?ae.setPresenceEvent(te):(ae=j(k,te.getContent().user_id),ae.setPresenceEvent(te),k.store.storeUser(ae)),k.emit(s.ClientEvent.Event,te)}),P.messages.start&&(this._peekRoom.oldState.paginationToken=P.messages.start),this._peekRoom.oldState.setStateEvents(V),this._peekRoom.currentState.setStateEvents(x),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(Q.reverse(),!0,this._peekRoom.getLiveTimeline(),P.messages.start),k.store.storeRoom(this._peekRoom),k.emit(s.ClientEvent.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(B,R){var k;if(this._peekRoom!==B){F("Stopped peeking in room %s",B.roomId);return}this.client.http.authedRequest(o.Method.Get,"/events",{room_id:B.roomId,timeout:String(30*1e3),from:R},void 0,{localTimeoutMs:50*1e3,abortSignal:(k=this.abortController)===null||k===void 0?void 0:k.signal}).then(P=>{if(this._peekRoom!==B){F("Stopped peeking in room %s",B.roomId);return}P.chunk.filter(function(x){return x.type==="m.presence"}).map(this.client.getEventMapper()).forEach(x=>{let Q=this.client.store.getUser(x.getContent().user_id);Q?Q.setPresenceEvent(x):(Q=j(this.client,x.getContent().user_id),Q.setPresenceEvent(x),this.client.store.storeUser(Q)),this.client.emit(s.ClientEvent.Event,x)});const V=P.chunk.filter(function(x){return x.room_id===B.roomId&&x.event_id}).map(this.client.getEventMapper());B.addLiveEvents(V),this.peekPoll(B,P.end)},P=>{i.logger.error("[%s] Peek poll failed: %s",B.roomId,P),setTimeout(()=>{this.peekPoll(B,R)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){var B;return(B=this.syncStateData)!==null&&B!==void 0?B:null}recoverFromSyncStartupError(B,R){return c(this,void 0,void 0,function*(){yield B;const k=this.startKeepAlives();this.updateSyncState(A.Error,{error:R}),yield k})}wasLazyLoadingToggled(B=!1){return c(this,void 0,void 0,function*(){let R=!1;if(!(yield this.client.store.isNewlyCreated())){const P=yield this.client.store.getClientOptions();return P&&(R=!!P.lazyLoadMembers),R!==B}return!1})}shouldAbortSync(B){return B.errcode==="M_UNKNOWN_TOKEN"?(i.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(A.Error,{error:B}),!0):!1}sync(){var B,R;return c(this,void 0,void 0,function*(){if(this.running=!0,this.abortController=new AbortController,(R=(B=u.window)===null||B===void 0?void 0:B.addEventListener)===null||R===void 0||R.call(B,"online",this.onOnline,!1),this.client.isGuest())return this.doSync({});F("Getting saved sync token...");const k=this.client.store.getSavedSyncToken().then(x=>(F("Got saved sync token"),x));this.savedSyncPromise=this.client.store.getSavedSync().then(x=>{if(F(`Got reply from saved sync, exists? ${!!x}`),x)return this.syncFromCache(x)}).catch(x=>{i.logger.error("Getting saved sync failed",x)}),yield this.getPushRules(),yield this.checkLazyLoadStatus();const{filterId:P,filter:V}=yield this.getFilter();if(V){if(this.client.resetNotifTimelineSet(),!this.currentSyncRequest){let x=P;const Q=yield k;if(Q)F("Sending first sync request...");else{F("Sending initial sync request...");const te=this.buildDefaultFilter();te.setDefinition(V.getDefinition()),te.setTimelineLimit(this.opts.initialSyncLimit),x=JSON.stringify(te.getDefinition())}this.currentSyncRequest=this.doSyncRequest({filter:x},Q)}return F("Waiting for saved sync before starting sync processing..."),yield this.savedSyncPromise,this.doSync({filter:P})}})}stop(){var B,R,k;F("SyncApi.stop"),(R=(B=u.window)===null||B===void 0?void 0:B.removeEventListener)===null||R===void 0||R.call(B,"online",this.onOnline,!1),this.running=!1,(k=this.abortController)===null||k===void 0||k.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedDefer?(this.startKeepAlives(0),!0):!1}syncFromCache(B){return c(this,void 0,void 0,function*(){F("sync(): not doing HTTP hit, instead returning stored /sync data");const R=B.nextBatch;this.client.store.setSyncToken(R);const k={nextSyncToken:R,catchingUp:!1,fromCache:!0},P={next_batch:R,rooms:B.roomsData,account_data:{events:B.accountData}};try{yield this.processSyncResponse(k,P)}catch(V){i.logger.error("Error processing cached sync",V)}this.storeIsInvalid||this.updateSyncState(A.Prepared,k)})}doSync(B){return c(this,void 0,void 0,function*(){for(;this.running;){const R=this.client.store.getSyncToken();let k;try{this.currentSyncRequest||(this.currentSyncRequest=this.doSyncRequest(B,R)),k=yield this.currentSyncRequest}catch(V){if(yield this.onSyncError(V))return;continue}finally{this.currentSyncRequest=void 0}this.client.store.setSyncToken(k.next_batch),this.failedSyncCount=0,yield this.client.store.setSyncData(k);const P={oldSyncToken:R??void 0,nextSyncToken:k.next_batch,catchingUp:this.catchingUp};this.syncOpts.crypto&&(yield this.syncOpts.crypto.onSyncWillProcess(P));try{yield this.processSyncResponse(P,k)}catch(V){i.logger.error("Caught /sync error",V),this.client.emit(s.ClientEvent.SyncUnexpectedError,V)}P.catchingUp=this.catchingUp,B.hasSyncedBefore||(this.updateSyncState(A.Prepared,P),B.hasSyncedBefore=!0),this.syncOpts.cryptoCallbacks&&(yield this.syncOpts.cryptoCallbacks.onSyncCompleted(P)),this.updateSyncState(A.Syncing,P),this.client.store.wantsSave()&&(this.syncOpts.crypto&&(yield this.syncOpts.crypto.saveDeviceList(0)),this.client.store.save())}this.running||(F("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(A.Stopped))})}doSyncRequest(B,R){var k;const P=this.getSyncParams(B,R);return this.client.http.authedRequest(o.Method.Get,"/sync",P,void 0,{localTimeoutMs:P.timeout+w,abortSignal:(k=this.abortController)===null||k===void 0?void 0:k.signal})}getSyncParams(B,R){let k=this.opts.pollTimeout;(this.getSyncState()!==A.Syncing||this.catchingUp)&&(this.catchingUp=!0,k=0);let P=B.filter;this.client.isGuest()&&!P&&(P=this.getGuestFilter());const V={filter:P,timeout:k};return this.opts.disablePresence&&(V.set_presence=C.Offline),R?V.since=R:V._cacheBuster=Date.now(),[A.Reconnecting,A.Error].includes(this.getSyncState())&&(V.timeout=0),V}onSyncError(B){return c(this,void 0,void 0,function*(){if(!this.running)return F("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(A.Stopped),!0;if(i.logger.error("/sync error %s",B),this.shouldAbortSync(B))return!0;this.failedSyncCount++,i.logger.log("Number of consecutive failed sync requests:",this.failedSyncCount),F("Starting keep-alive");const R=this.startKeepAlives();return this.currentSyncRequest=void 0,this.updateSyncState(this.failedSyncCount>=M?A.Error:A.Reconnecting,{error:B}),(yield R)&&this.getSyncState()===A.Error&&this.updateSyncState(A.Catchup,{catchingUp:!0}),!1})}processSyncResponse(B,R){var k,P,V,x;return c(this,void 0,void 0,function*(){const Q=this.client;if(Array.isArray((k=R.presence)===null||k===void 0?void 0:k.events)&&R.presence.events.filter(b.noUnsafeEventProps).map(Q.getEventMapper()).forEach(function(X){let $=Q.store.getUser(X.getSender());$?$.setPresenceEvent(X):($=j(Q,X.getSender()),$.setPresenceEvent(X),Q.store.storeUser($)),Q.emit(s.ClientEvent.Event,X)}),Array.isArray((P=R.account_data)===null||P===void 0?void 0:P.events)){const X=R.account_data.events.filter(b.noUnsafeEventProps).map(Q.getEventMapper()),$=X.reduce((K,re)=>(K[re.getType()]=Q.store.getAccountData(re.getType()),K),{});Q.store.storeAccountDataEvents(X),X.forEach(function(K){if(K.getType()===l.EventType.PushRules){const ue=K.getContent();Q.setPushRules(ue)}const re=$[K.getType()];return Q.emit(s.ClientEvent.AccountData,K,re),K})}if(R.to_device&&Array.isArray(R.to_device.events)&&R.to_device.events.length>0){let X=R.to_device.events.filter(b.noUnsafeEventProps);this.syncOpts.cryptoCallbacks&&(X=yield this.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(X));const $=[];X.map(Q.getEventMapper({toDevice:!0})).map(K=>{if(K.getType()==="m.key.verification.cancel"){const re=K.getContent().transaction_id;re&&$.push(re)}return K}).forEach(function(K){const re=K.getContent();if(K.getType()=="m.room.message"&&re.msgtype=="m.bad.encrypted"){i.logger.log("Ignoring undecryptable to-device event from "+K.getSender());return}if(K.getType()==="m.key.verification.start"||K.getType()==="m.key.verification.request"){const ue=re.transaction_id;$.includes(ue)&&K.flagCancelled()}Q.emit(s.ClientEvent.ToDeviceEvent,K)})}else this.catchingUp=!1;let te=[],ae=[],de=[];if(R.rooms&&(R.rooms.invite&&(te=this.mapSyncResponseToRoomArray(R.rooms.invite)),R.rooms.join&&(ae=this.mapSyncResponseToRoomArray(R.rooms.join)),R.rooms.leave&&(de=this.mapSyncResponseToRoomArray(R.rooms.leave))),this.notifEvents=[],yield d.promiseMapSeries(te,X=>c(this,void 0,void 0,function*(){var $;const K=X.room,re=this.mapSyncEventsFormat(X.invite_state,K);yield this.injectRoomEvents(K,re);const ue=($=K.currentState.getStateEvents(l.EventType.RoomMember,Q.getUserId()))===null||$===void 0?void 0:$.getSender(),H=Q.crypto;if(H){const G=yield H.cryptoStore.takeParkedSharedHistory(K.roomId);for(const U of G)U.senderId===ue&&(yield H.olmDevice.addInboundGroupSession(K.roomId,U.senderKey,U.forwardingCurve25519KeyChain,U.sessionId,U.sessionKey,U.keysClaimed,!0,{sharedHistory:!0,untrusted:!0}))}X.isBrandNewRoom?(K.recalculate(),Q.store.storeRoom(K),Q.emit(s.ClientEvent.Room,K)):K.recalculate(),re.forEach(function(G){Q.emit(s.ClientEvent.Event,G)})})),yield d.promiseMapSeries(ae,X=>c(this,void 0,void 0,function*(){var $,K,re,ue,H,G;const U=X.room,L=this.mapSyncEventsFormat(X.state,U),z=this.mapSyncEventsFormat(X.timeline,U,!1),J=this.mapSyncEventsFormat(X.ephemeral),ne=this.mapSyncEventsFormat(X.account_data),oe=Q.isRoomEncrypted(U.roomId);X.unread_notifications&&((!oe||X.unread_notifications.notification_count===0)&&U.setUnreadNotificationCount(h.NotificationCountType.Total,($=X.unread_notifications.notification_count)!==null&&$!==void 0?$:0),(!oe||U.getUnreadNotificationCount(h.NotificationCountType.Highlight)<=0)&&U.setUnreadNotificationCount(h.NotificationCountType.Highlight,(K=X.unread_notifications.highlight_count)!==null&&K!==void 0?K:0));const ce=(re=X[_.UNREAD_THREAD_NOTIFICATIONS.name])!==null&&re!==void 0?re:X[_.UNREAD_THREAD_NOTIFICATIONS.altName];if(ce){U.resetThreadUnreadNotificationCount(Object.keys(ce));for(const[he,fe]of Object.entries(ce)){(!oe||fe.notification_count===0)&&U.setThreadUnreadNotificationCount(he,h.NotificationCountType.Total,(ue=fe.notification_count)!==null&&ue!==void 0?ue:0);const ve=U.getThreadUnreadNotificationCount(he,h.NotificationCountType.Highlight)<=0;(!oe||oe&&ve)&&U.setThreadUnreadNotificationCount(he,h.NotificationCountType.Highlight,(H=fe.highlight_count)!==null&&H!==void 0?H:0)}}else U.resetThreadUnreadNotificationCount();if(X.timeline=X.timeline||{},X.isBrandNewRoom)X.timeline.prev_batch!==null&&U.getLiveTimeline().setPaginationToken(X.timeline.prev_batch,n.EventTimeline.BACKWARDS);else if(X.timeline.limited){let he=!0;for(let fe=z.length-1;fe>=0;fe--){const ve=z[fe].getId();if(U.getTimelineForEvent(ve)){F(`Already have event ${ve} in limited sync - not resetting`),he=!1,z.splice(0,fe);break}}he&&(U.resetLiveTimeline(X.timeline.prev_batch,this.syncOpts.canResetEntireTimeline(U.roomId)?null:(G=B.oldSyncToken)!==null&&G!==void 0?G:null),Q.resetNotifTimelineSet())}if(this.syncOpts.cryptoCallbacks)for(const he of L.concat(z))he.isState()&&he.getType()===l.EventType.RoomEncryption&&he.getStateKey()===""&&(yield this.syncOpts.cryptoCallbacks.onCryptoEvent(U,he));try{yield this.injectRoomEvents(U,L,z,B.fromCache)}catch(he){i.logger.error(`Failed to process events on room ${U.roomId}:`,he)}X.summary&&U.setSummary(X.summary),U.addEphemeralEvents(J),U.addAccountData(ne),U.recalculate(),X.isBrandNewRoom&&(Q.store.storeRoom(U),Q.emit(s.ClientEvent.Room,U)),this.processEventsForNotifs(U,z);const pe=he=>Q.emit(s.ClientEvent.Event,he);L.forEach(pe),z.forEach(pe),J.forEach(pe),ne.forEach(pe),U.decryptCriticalEvents()})),yield d.promiseMapSeries(de,X=>c(this,void 0,void 0,function*(){const $=X.room,K=this.mapSyncEventsFormat(X.state,$),re=this.mapSyncEventsFormat(X.timeline,$),ue=this.mapSyncEventsFormat(X.account_data);yield this.injectRoomEvents($,K,re),$.addAccountData(ue),$.recalculate(),X.isBrandNewRoom&&(Q.store.storeRoom($),Q.emit(s.ClientEvent.Room,$)),this.processEventsForNotifs($,re),K.forEach(function(H){Q.emit(s.ClientEvent.Event,H)}),re.forEach(function(H){Q.emit(s.ClientEvent.Event,H)}),ue.forEach(function(H){Q.emit(s.ClientEvent.Event,H)})})),B.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort(function(X,$){return X.getTs()-$.getTs()}),this.notifEvents.forEach(function(X){var $;($=Q.getNotifTimelineSet())===null||$===void 0||$.addLiveEvent(X)})),R.device_lists&&this.syncOpts.crypto&&(yield this.syncOpts.crypto.handleDeviceListChanges(B,R.device_lists)),R.device_one_time_keys_count){const X=new Map(Object.entries(R.device_one_time_keys_count));(V=this.syncOpts.cryptoCallbacks)===null||V===void 0||V.preprocessOneTimeKeyCounts(X)}if(R.device_unused_fallback_key_types||R["org.matrix.msc2732.device_unused_fallback_key_types"]){const X=R.device_unused_fallback_key_types||R["org.matrix.msc2732.device_unused_fallback_key_types"];(x=this.syncOpts.cryptoCallbacks)===null||x===void 0||x.preprocessUnusedFallbackKeys(new Set(X||null))}})}startKeepAlives(B){return B===void 0&&(B=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),B>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),B):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=d.defer()),this.connectionReturnedDefer.promise}pokeKeepAlive(B=!1){var R;const k=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(B),this.connectionReturnedDefer=void 0)};this.client.http.request(o.Method.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(R=this.abortController)===null||R===void 0?void 0:R.signal}).then(()=>{k()},P=>{P.httpStatus==400||P.httpStatus==404?this.keepAliveTimer=setTimeout(k,2e3):(B=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,B),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState(A.Error,{error:P}))})}mapSyncResponseToRoomArray(B){const R=this.client;return Object.keys(B).filter(k=>!(0,b.unsafeProp)(k)).map(k=>{const P=B[k];let V=R.store.getRoom(k),x=!1;return V||(V=this.createRoom(k),x=!0),P.room=V,P.isBrandNewRoom=x,P})}mapSyncEventsFormat(B,R,k=!0){if(!B||!Array.isArray(B.events))return[];const P=this.client.getEventMapper({decrypt:k});return B.events.filter(b.noUnsafeEventProps).map(function(V){return R&&(V.room_id=R.roomId),P(V)})}resolveInvites(B){if(!B||!this.opts.resolveInvitesToProfiles)return;const R=this.client;B.getMembersWithMembership("invite").forEach(function(k){if(k.requestedProfileInfo)return;k.requestedProfileInfo=!0;const P=R.getUser(k.userId);let V;P?V=Promise.resolve({avatar_url:P.avatarUrl,displayname:P.displayName}):V=R.getProfileInfo(k.userId),V.then(function(x){const Q=k.events.member;(Q==null?void 0:Q.getContent().membership)==="invite"&&(Q.getContent().avatar_url=x.avatar_url,Q.getContent().displayname=x.displayname,k.setMembershipEvent(Q,B.currentState))},function(x){})})}injectRoomEvents(B,R,k,P=!1){return c(this,void 0,void 0,function*(){const V=B.getLiveTimeline(),x=V.getEvents().length==0;if(x){for(const Q of R)this.client.getPushActionsForEvent(Q);V.initialiseState(R,{timelineWasEmpty:x})}this.resolveInvites(B),B.recalculate(),x||(B.oldState.setStateEvents(R||[]),B.currentState.setStateEvents(R||[])),B.addLiveEvents(k||[],{fromCache:P,timelineWasEmpty:x}),this.client.processBeaconEvents(B,k)})}processEventsForNotifs(B,R){var k;if(this.client.getNotifTimelineSet())for(const P of R){const V=this.client.getPushActionsForEvent(P);V!=null&&V.notify&&(!((k=V.tweaks)===null||k===void 0)&&k.highlight)&&this.notifEvents.push(P)}}getGuestFilter(){return"{}"}updateSyncState(B,R){const k=this.syncState;this.syncState=B,this.syncStateData=R,this.client.emit(s.ClientEvent.Sync,this.syncState,k,R)}}e.SyncApi=D;function j(q,B){const R=new m.User(B);return q.reEmitter.reEmit(R,[m.UserEvent.AvatarUrl,m.UserEvent.DisplayName,m.UserEvent.Presence,m.UserEvent.CurrentlyActive,m.UserEvent.LastPresenceTs]),R}function Y(q,B,R){const{timelineSupport:k}=q,P=new h.Room(B,q,q.getUserId(),{lazyLoadMembers:R.lazyLoadMembers,pendingEventOrdering:R.pendingEventOrdering,timelineSupport:k});return q.reEmitter.reEmit(P,[h.RoomEvent.Name,h.RoomEvent.Redaction,h.RoomEvent.RedactionCancelled,h.RoomEvent.Receipt,h.RoomEvent.Tags,h.RoomEvent.LocalEchoUpdated,h.RoomEvent.AccountData,h.RoomEvent.MyMembership,h.RoomEvent.Timeline,h.RoomEvent.TimelineReset,v.RoomStateEvent.Events,v.RoomStateEvent.Members,v.RoomStateEvent.NewMember,v.RoomStateEvent.Update,p.BeaconEvent.New,p.BeaconEvent.Update,p.BeaconEvent.Destroy,p.BeaconEvent.LivenessChange]),P.on(v.RoomStateEvent.NewMember,(V,x,Q)=>{var te;Q.user=(te=q.getUser(Q.userId))!==null&&te!==void 0?te:void 0,q.reEmitter.reEmit(Q,[f.RoomMemberEvent.Name,f.RoomMemberEvent.Typing,f.RoomMemberEvent.PowerLevel,f.RoomMemberEvent.Membership])}),P}e._createAndReEmitRoom=Y}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./@types/event":306,"./@types/sync":314,"./client":321,"./errors":359,"./feature":362,"./filter":364,"./http-api":367,"./logger":374,"./models/beacon":378,"./models/event-timeline":382,"./models/room":392,"./models/room-member":389,"./models/room-state":390,"./models/user":396,"./utils":416}],415:[function(t,E,e){var u=this&&this.__awaiter||function(h,d,b,a){function n(i){return i instanceof b?i:new b(function(r){r(i)})}return new(b||(b=Promise))(function(i,r){function s(v){try{l(a.next(v))}catch(f){r(f)}}function o(v){try{l(a.throw(v))}catch(f){r(f)}}function l(v){v.done?i(v.value):n(v.value).then(s,o)}l((a=a.apply(h,d||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.TimelineIndex=e.TimelineWindow=void 0;const g=t("./models/event-timeline");t("./logger");const S=function(){},y=5;class c{constructor(d,b,a={}){this.client=d,this.timelineSet=b,this.eventCount=0,this.windowLimit=a.windowLimit||1e3}load(d,b=20){const a=n=>{if(!n)throw new Error("No timeline given to initFields");let i;const r=n.getEvents();if(!d)i=r.length;else if(i=r.findIndex(l=>l.getId()===d),i<0)throw new Error("getEventTimeline result didn't include requested event");const s=Math.min(r.length,i+Math.ceil(b/2)),o=Math.max(0,s-b);this.start=new m(n,o-n.getBaseIndex()),this.end=new m(n,s-n.getBaseIndex()),this.eventCount=s-o};return this.timelineSet.getTimelineForEvent(d)?(a(this.timelineSet.getTimelineForEvent(d)),Promise.resolve()):d?this.client.getEventTimeline(this.timelineSet,d).then(a):(a(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(d){var b,a;if(d==g.EventTimeline.BACKWARDS)return(b=this.start)!==null&&b!==void 0?b:null;if(d==g.EventTimeline.FORWARDS)return(a=this.end)!==null&&a!==void 0?a:null;throw new Error("Invalid direction '"+d+"'")}extend(d,b){const a=this.getTimelineIndex(d);if(!a)return!1;const n=d==g.EventTimeline.BACKWARDS?a.retreat(b):a.advance(b);if(n){this.eventCount+=n,S("TimelineWindow: increased cap by "+n+" (now "+this.eventCount+")");const i=this.eventCount-this.windowLimit;return i>0&&this.unpaginate(i,d!=g.EventTimeline.BACKWARDS),!0}return!1}canPaginate(d){const b=this.getTimelineIndex(d);if(!b)return!1;if(d==g.EventTimeline.BACKWARDS){if(b.index>b.minIndex())return!0}else if(b.index<b.maxIndex())return!0;const a=b.timeline.getNeighbouringTimeline(d),n=b.timeline.getPaginationToken(d);return!!a||!!n}paginate(d,b,a=!0,n=y){return u(this,void 0,void 0,function*(){const i=this.getTimelineIndex(d);if(!i)return!1;if(i.pendingPaginate)return i.pendingPaginate;if(this.extend(d,b))return!0;if(!a||n===0||!i.timeline.getPaginationToken(d))return!1;const s=this.client.paginateEventTimeline(i.timeline,{backwards:d==g.EventTimeline.BACKWARDS,limit:b}).finally(function(){i.pendingPaginate=void 0}).then(o=>o?this.paginate(d,b,!0,n-1):this.paginate(d,b,!1,0));return i.pendingPaginate=s,s})}unpaginate(d,b){const a=b?this.start:this.end;if(!a)throw new Error(`Attempting to unpaginate startOfTimeline=${b} but don't have this direction`);if(d>this.eventCount||d<0)throw new Error(`Attemting to unpaginate ${d} events, but only have ${this.eventCount} in the timeline`);for(;d>0;){const n=b?a.advance(d):a.retreat(d);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");d-=n,this.eventCount-=n,S("TimelineWindow.unpaginate: dropped "+n+" (now "+this.eventCount+")")}}getEvents(){var d,b;if(!this.start)return[];const a=[];let n=this.start.timeline;for(;;){const i=n.getEvents();let r=0,s=i.length;n===this.start.timeline&&(r=this.start.index+n.getBaseIndex()),n===((d=this.end)===null||d===void 0?void 0:d.timeline)&&(s=this.end.index+n.getBaseIndex());for(let o=r;o<s;o++)a.push(i[o]);if(n===((b=this.end)===null||b===void 0?void 0:b.timeline))break;n=n.getNeighbouringTimeline(g.EventTimeline.FORWARDS)}return a}}e.TimelineWindow=c;class m{constructor(d,b){this.timeline=d,this.index=b}minIndex(){return this.timeline.getBaseIndex()*-1}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(d){if(!d)return 0;let b;if(d<0){if(b=Math.max(d,this.minIndex()-this.index),b<0)return this.index+=b,b}else if(b=Math.min(d,this.maxIndex()-this.index),b>0)return this.index+=b,b;const a=this.timeline.getNeighbouringTimeline(d<0?g.EventTimeline.BACKWARDS:g.EventTimeline.FORWARDS);return a?(this.timeline=a,d<0?this.index=this.maxIndex():this.index=this.minIndex(),this.advance(d)):0}retreat(d){return this.advance(d*-1)*-1}}e.TimelineIndex=m},{"./logger":374,"./models/event-timeline":382}],416:[function(t,E,e){(function(u){(function(){var g=this&&this.__awaiter||function(ne,oe,ce,pe){function he(fe){return fe instanceof ce?fe:new ce(function(ve){ve(fe)})}return new(ce||(ce=Promise))(function(fe,ve){function ye(me){try{we(pe.next(me))}catch(N){ve(N)}}function Ee(me){try{we(pe.throw(me))}catch(N){ve(N)}}function we(me){me.done?fe(me.value):he(me.value).then(ye,Ee)}we((pe=pe.apply(ne,oe||[])).next())})},S=this&&this.__importDefault||function(ne){return ne&&ne.__esModule?ne:{default:ne}};Object.defineProperty(e,"__esModule",{value:!0}),e.MapWithDefault=e.noUnsafeEventProps=e.safeSet=e.unsafeProp=e.recursiveMapToObject=e.mapsEqual=e.isSupportedReceiptType=e.sortEventsByLatestContentTimestamp=e.recursivelyAssign=e.compare=e.lexicographicCompare=e.prevString=e.nextString=e.averageBetweenStrings=e.stringToBase=e.baseToString=e.alphabetPad=e.DEFAULT_ALPHABET=e.simpleRetryOperation=e.chunkPromises=e.promiseTry=e.promiseMapSeries=e.defer=e.isNullOrUndefined=e.immediate=e.sleep=e.ensureNoTrailingSlash=e.globToRegexp=e.escapeRegExp=e.normalize=e.removeDirectionOverrideChars=e.removeHiddenChars=e.isNumber=e.deepSortedObjectEntries=e.deepCompare=e.deepCopy=e.checkObjectHasKeys=e.isFunction=e.removeElement=e.encodeUri=e.decodeParams=e.replaceParam=e.encodeParams=e.internaliseString=void 0;const y=S(t("unhomoglyph")),c=S(t("p-retry")),m=t("./@types/location"),h=t("./@types/read_receipts"),d=new Map;function b(ne){return ne instanceof String&&(ne=ne.toString()),d.has(ne)||d.set(ne,ne),d.get(ne)}e.internaliseString=b;function a(ne,oe){const ce=oe??new URLSearchParams;for(const[pe,he]of Object.entries(ne))he!=null&&(Array.isArray(he)?he.forEach(fe=>{ce.append(pe,String(fe))}):ce.append(pe,String(he)));return ce}e.encodeParams=a;function n(ne,oe,ce){const pe=Object.assign(Object.assign({},ce),{[oe]:ce[ne]});return delete pe[ne],pe}e.replaceParam=n;function i(ne){const oe={},ce=new URLSearchParams(ne);for(const pe of ce.keys()){const he=ce.getAll(pe);oe[pe]=he.length===1?he[0]:he}return oe}e.decodeParams=i;function r(ne,oe){for(const ce in oe){if(!oe.hasOwnProperty(ce))continue;const pe=oe[ce];pe!=null&&(ne=ne.replace(ce,encodeURIComponent(pe)))}return ne}e.encodeUri=r;function s(ne,oe,ce){let pe;if(ce){for(pe=ne.length-1;pe>=0;pe--)if(oe(ne[pe],pe,ne))return ne.splice(pe,1),!0}else for(pe=0;pe<ne.length;pe++)if(oe(ne[pe],pe,ne))return ne.splice(pe,1),!0;return!1}e.removeElement=s;function o(ne){return Object.prototype.toString.call(ne)==="[object Function]"}e.isFunction=o;function l(ne,oe){for(const ce of oe)if(!ne.hasOwnProperty(ce))throw new Error("Missing required key: "+ce)}e.checkObjectHasKeys=l;function v(ne){return JSON.parse(JSON.stringify(ne))}e.deepCopy=v;function f(ne,oe){if(ne===oe)return!0;if(typeof ne!=typeof oe)return!1;if(typeof ne=="number"&&isNaN(ne)&&isNaN(oe))return!0;if(ne===null||oe===null)return ne===oe;if(!(ne instanceof Object)||ne.constructor!==oe.constructor||ne.prototype!==oe.prototype)return!1;if(ne instanceof RegExp||ne instanceof Date)return ne.toString()===oe.toString();if(Array.isArray(ne)){if(ne.length!==oe.length)return!1;for(let ce=0;ce<ne.length;ce++)if(!f(ne[ce],oe[ce]))return!1}else{for(const ce in oe)if(oe.hasOwnProperty(ce)!==ne.hasOwnProperty(ce))return!1;for(const ce in ne)if(oe.hasOwnProperty(ce)!==ne.hasOwnProperty(ce)||!f(ne[ce],oe[ce]))return!1}return!0}e.deepCompare=f;function p(ne){if(typeof ne!="object"||ne==null||Array.isArray(ne))return ne;const oe=[];for(const[ce,pe]of Object.entries(ne))oe.push([ce,p(pe)]);return oe.sort((ce,pe)=>te(ce[0],pe[0])),oe}e.deepSortedObjectEntries=p;function _(ne){return typeof ne=="number"&&isFinite(ne)}e.isNumber=_;function T(ne){return typeof ne=="string"?(0,y.default)(ne.normalize("NFD").replace(A,"")):""}e.removeHiddenChars=T;function w(ne){return typeof ne=="string"?ne.replace(/[\u202d-\u202e]/g,""):""}e.removeDirectionOverrideChars=w;function M(ne){return T(ne.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}e.normalize=M;const A=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function W(ne){return ne.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}e.escapeRegExp=W;function ee(ne,oe=!1){const ce=[[/\\\*/g,".*"],[/\?/g,"."]];return oe||ce.push([/\\\[(!|)(.*)\\]/g,(pe,he,fe)=>["[",he?"^":"",fe.replace(/\\-/,"-"),"]"].join("")]),ce.reduce((pe,he)=>he?pe.replace(he[0],he[1]):pe,W(ne))}e.globToRegexp=ee;function F(ne){return ne!=null&&ne.endsWith("/")?ne.slice(0,-1):ne}e.ensureNoTrailingSlash=F;function C(ne,oe){return new Promise(ce=>{setTimeout(ce,ne,oe)})}e.sleep=C;function O(){return new Promise(u)}e.immediate=O;function I(ne){return ne==null}e.isNullOrUndefined=I;function D(){let ne,oe;const ce=new Promise((pe,he)=>{ne=pe,oe=he});return{resolve:ne,reject:oe,promise:ce}}e.defer=D;function j(ne,oe){return g(this,void 0,void 0,function*(){for(const ce of ne)yield oe(yield ce)})}e.promiseMapSeries=j;function Y(ne){return Promise.resolve(ne())}e.promiseTry=Y;function q(ne,oe){return g(this,void 0,void 0,function*(){const ce=[];for(let pe=0;pe<ne.length;pe+=oe)ce.push(...yield Promise.all(ne.slice(pe,pe+oe).map(he=>he())));return ce})}e.chunkPromises=q;function B(ne){return(0,c.default)(oe=>ne(oe),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}e.simpleRetryOperation=B,e.DEFAULT_ALPHABET=(()=>{let ne="";for(let oe=32;oe<=126;oe++)ne+=String.fromCharCode(oe);return ne})();function R(ne,oe,ce=e.DEFAULT_ALPHABET){return ne.padEnd(oe,ce[0])}e.alphabetPad=R;function k(ne,oe=e.DEFAULT_ALPHABET){var ce;const pe=BigInt(oe.length);if(ne<=pe)return(ce=oe[Number(ne)-1])!==null&&ce!==void 0?ce:"";let he=ne/pe,fe=Number(ne%pe)-1;return fe<0&&(he-=BigInt(Math.abs(fe)),fe=Number(pe)-1),k(he,oe)+oe[fe]}e.baseToString=k;function P(ne,oe=e.DEFAULT_ALPHABET){const ce=BigInt(oe.length);let pe=BigInt(0);for(let he=ne.length-1,fe=BigInt(0);he>=0;he--,fe++){const ve=ne.charCodeAt(he)-oe.charCodeAt(0);pe+=BigInt(1+ve)*ce**fe}return pe}e.stringToBase=P;function V(ne,oe,ce=e.DEFAULT_ALPHABET){const pe=Math.max(ne.length,oe.length),he=P(R(ne,pe,ce),ce),fe=P(R(oe,pe,ce),ce),ve=(he+fe)/BigInt(2);return ve===he||ve==fe?k(ve,ce)+ce[0]:k(ve,ce)}e.averageBetweenStrings=V;function x(ne,oe=e.DEFAULT_ALPHABET){return k(P(ne,oe)+BigInt(1),oe)}e.nextString=x;function Q(ne,oe=e.DEFAULT_ALPHABET){return k(P(ne,oe)-BigInt(1),oe)}e.prevString=Q;function te(ne,oe){return ne<oe?-1:ne>oe?1:0}e.lexicographicCompare=te;const ae=new Intl.Collator;function de(ne,oe){return ae.compare(ne,oe)}e.compare=de;function X(ne,oe,ce=!1){for(const[pe,he]of Object.entries(oe)){if(ne[pe]instanceof Object&&he){X(ne[pe],he);continue}if(he!=null||!ce){ne[pe]=he;continue}}return ne}e.recursivelyAssign=X;function $(ne){var oe;return(oe=m.M_TIMESTAMP.findIn(ne.getContent()))!==null&&oe!==void 0?oe:-1}function K(ne,oe){return $(oe)-$(ne)}e.sortEventsByLatestContentTimestamp=K;function re(ne){return[h.ReceiptType.Read,h.ReceiptType.ReadPrivate].includes(ne)}e.isSupportedReceiptType=re;function ue(ne,oe,ce=(pe,he)=>pe===he){if(ne.size!==oe.size)return!1;for(const[pe,he]of ne){const fe=oe.get(pe);if(fe===void 0||!ce(he,fe))return!1}return!0}e.mapsEqual=ue;function H(ne){return ne instanceof Map?G(ne):Array.isArray(ne)?ne.map(oe=>H(oe)):ne}function G(ne){const oe=new Map;for(const[ce,pe]of ne)oe.set(ce,H(pe));return Object.fromEntries(oe.entries())}e.recursiveMapToObject=G;function U(ne){return ne==="__proto__"||ne==="prototype"||ne==="constructor"}e.unsafeProp=U;function L(ne,oe,ce){if(U(oe))throw new Error("Trying to modify prototype or constructor");ne[oe]=ce}e.safeSet=L;function z(ne){return!(U(ne.room_id)||U(ne.sender)||U(ne.user_id)||U(ne.event_id))}e.noUnsafeEventProps=z;class J extends Map{constructor(oe){super(),this.createDefault=oe}getOrCreate(oe){return this.has(oe)||this.set(oe,this.createDefault()),this.get(oe)}}e.MapWithDefault=J}).call(this)}).call(this,t("timers").setImmediate)},{"./@types/location":308,"./@types/read_receipts":311,"p-retry":225,timers:280,unhomoglyph:282}],417:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.releaseContext=e.acquireContext=void 0;let u=null,g=0;const S=()=>(u===null&&(u=new AudioContext),g++,u);e.acquireContext=S;const y=()=>{g--,g===0&&(u==null||u.close(),u=null)};e.releaseContext=y},{}],418:[function(t,E,e){(function(u){(function(){var g=this&&this.__createBinding||(Object.create?function(V,x,Q,te){te===void 0&&(te=Q);var ae=Object.getOwnPropertyDescriptor(x,Q);(!ae||("get"in ae?!x.__esModule:ae.writable||ae.configurable))&&(ae={enumerable:!0,get:function(){return x[Q]}}),Object.defineProperty(V,te,ae)}:function(V,x,Q,te){te===void 0&&(te=Q),V[te]=x[Q]}),S=this&&this.__setModuleDefault||(Object.create?function(V,x){Object.defineProperty(V,"default",{enumerable:!0,value:x})}:function(V,x){V.default=x}),y=this&&this.__importStar||function(V){if(V&&V.__esModule)return V;var x={};if(V!=null)for(var Q in V)Q!=="default"&&Object.prototype.hasOwnProperty.call(V,Q)&&g(x,V,Q);return S(x,V),x},c=this&&this.__awaiter||function(V,x,Q,te){function ae(de){return de instanceof Q?de:new Q(function(X){X(de)})}return new(Q||(Q=Promise))(function(de,X){function $(ue){try{re(te.next(ue))}catch(H){X(H)}}function K(ue){try{re(te.throw(ue))}catch(H){X(H)}}function re(ue){ue.done?de(ue.value):ae(ue.value).then($,K)}re((te=te.apply(V,x||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.createNewMatrixCall=e.supportsMatrixCall=e.setTracksEnabled=e.MatrixCall=e.genCallID=e.CallError=e.CallErrorCode=e.CallEvent=e.CallParty=e.CallDirection=e.CallType=e.CallState=void 0;const m=t("uuid"),h=t("sdp-transform"),d=t("../logger"),b=y(t("../utils")),a=t("../@types/event"),n=t("../randomstring"),i=t("./callEventTypes"),r=t("./callFeed"),s=t("../models/typed-event-emitter"),o=t("../crypto/deviceinfo"),l=t("./groupCall"),v=t("../http-api");var f;(function(V){V.AUDIO="audio",V.VIDEO="video"})(f||(f={}));var p;(function(V){V.OPUS="opus"})(p||(p={}));var _;(function(V){V.Fledgling="fledgling",V.InviteSent="invite_sent",V.WaitLocalMedia="wait_local_media",V.CreateOffer="create_offer",V.CreateAnswer="create_answer",V.Connecting="connecting",V.Connected="connected",V.Ringing="ringing",V.Ended="ended"})(_=e.CallState||(e.CallState={}));var T;(function(V){V.Voice="voice",V.Video="video"})(T=e.CallType||(e.CallType={}));var w;(function(V){V.Inbound="inbound",V.Outbound="outbound"})(w=e.CallDirection||(e.CallDirection={}));var M;(function(V){V.Local="local",V.Remote="remote"})(M=e.CallParty||(e.CallParty={}));var A;(function(V){V.Hangup="hangup",V.State="state",V.Error="error",V.Replaced="replaced",V.LocalHoldUnhold="local_hold_unhold",V.RemoteHoldUnhold="remote_hold_unhold",V.HoldUnhold="hold_unhold",V.FeedsChanged="feeds_changed",V.AssertedIdentityChanged="asserted_identity_changed",V.LengthChanged="length_changed",V.DataChannel="datachannel",V.SendVoipEvent="send_voip_event"})(A=e.CallEvent||(e.CallEvent={}));var W;(function(V){V.UserHangup="user_hangup",V.LocalOfferFailed="local_offer_failed",V.NoUserMedia="no_user_media",V.UnknownDevices="unknown_devices",V.SendInvite="send_invite",V.CreateAnswer="create_answer",V.CreateOffer="create_offer",V.SendAnswer="send_answer",V.SetRemoteDescription="set_remote_description",V.SetLocalDescription="set_local_description",V.AnsweredElsewhere="answered_elsewhere",V.IceFailed="ice_failed",V.InviteTimeout="invite_timeout",V.Replaced="replaced",V.SignallingFailed="signalling_timeout",V.UserBusy="user_busy",V.Transferred="transferred",V.NewSession="new_session"})(W=e.CallErrorCode||(e.CallErrorCode={}));const ee="1",F="stun:turn.matrix.org",C=60*1e3,O=1e3,I=30*1e3;class D extends Error{constructor(x,Q,te){super(Q+": "+te),this.code=x}}e.CallError=D;function j(){return Date.now().toString()+(0,n.randomString)(16)}e.genCallID=j;function Y(V){return[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:V?12e3:void 0}]}function q(V,x){return V+":"+x}class B extends s.TypedEventEmitter{constructor(x){var Q;if(super(),this.toDeviceSeq=0,this.isPtt=!1,this._state=_.Fledgling,this.candidateSendQueue=[],this.candidateSendTries=0,this.candidatesEnded=!1,this.feeds=[],this.transceivers=new Map,this.inviteOrAnswerSent=!1,this.waitForLocalAVStream=!1,this.removeTrackListeners=new Map,this.remoteOnHold=!1,this.makingOffer=!1,this.ignoreOffer=!1,this.remoteCandidateBuffer=new Map,this.gotLocalIceCandidate=te=>{if(te.candidate){if(this.candidatesEnded){d.logger.warn(`Call ${this.callId} gotLocalIceCandidate() got candidate after candidates have ended - ignoring!`);return}if(d.logger.debug(`Call ${this.callId} got local ICE ${te.candidate.sdpMid} ${te.candidate.candidate}`),this.callHasEnded())return;te.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(te.candidate)}},this.onIceGatheringStateChange=te=>{var ae;d.logger.debug(`Call ${this.callId} onIceGatheringStateChange() ice gathering state changed to ${this.peerConn.iceGatheringState}`),((ae=this.peerConn)===null||ae===void 0?void 0:ae.iceGatheringState)==="complete"&&this.queueCandidate(null)},this.getLocalOfferFailed=te=>{d.logger.error(`Call ${this.callId} getLocalOfferFailed() running`,te),this.emit(A.Error,new D(W.LocalOfferFailed,"Failed to get local offer!",te),this),this.terminate(M.Local,W.LocalOfferFailed,!1)},this.getUserMediaFailed=te=>{if(this.successor){this.successor.getUserMediaFailed(te);return}d.logger.warn(`Call ${this.callId} getUserMediaFailed() failed to get user media - ending call`,te),this.emit(A.Error,new D(W.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",te),this),this.terminate(M.Local,W.NoUserMedia,!1)},this.onIceConnectionStateChanged=()=>{var te,ae,de,X,$,K;if(!this.callHasEnded()&&(d.logger.debug(`Call ${this.callId} onIceConnectionStateChanged() running (state=${(te=this.peerConn)===null||te===void 0?void 0:te.iceConnectionState})`),["connected","completed"].includes((de=(ae=this.peerConn)===null||ae===void 0?void 0:ae.iceConnectionState)!==null&&de!==void 0?de:"")?(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.state=_.Connected,!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(A.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},O))):((X=this.peerConn)===null||X===void 0?void 0:X.iceConnectionState)=="failed"?!(($=this.peerConn)===null||$===void 0)&&$.restartIce?(this.candidatesEnded=!1,this.peerConn.restartIce()):(d.logger.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)`),this.hangup(W.IceFailed,!1)):((K=this.peerConn)===null||K===void 0?void 0:K.iceConnectionState)=="disconnected"&&(this.iceDisconnectedTimeout=setTimeout(()=>{d.logger.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)`),this.hangup(W.IceFailed,!1)},I),this.state=_.Connecting),this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState)))for(const re of this.getRemoteFeeds())re.setAudioVideoMuted(!0,!0)},this.onSignallingStateChanged=()=>{var te;d.logger.debug(`Call ${this.callId} onSignallingStateChanged() running (state=${(te=this.peerConn)===null||te===void 0?void 0:te.signalingState})`)},this.onTrack=te=>{if(te.streams.length===0){d.logger.warn(`Call ${this.callId} onTrack() called with streamless track streamless (kind=${te.track.kind})`);return}const ae=te.streams[0];if(this.pushRemoteFeed(ae),!this.removeTrackListeners.has(ae)){const de=()=>{ae.getTracks().length===0&&(d.logger.info(`Call ${this.callId} onTrack() removing track (streamId=${ae.id})`),this.deleteFeedByStream(ae),ae.removeEventListener("removetrack",de),this.removeTrackListeners.delete(ae))};ae.addEventListener("removetrack",de),this.removeTrackListeners.set(ae,de)}},this.onDataChannel=te=>{this.emit(A.DataChannel,te.channel,this)},this.onNegotiationNeeded=()=>c(this,void 0,void 0,function*(){if(d.logger.info(`Call ${this.callId} onNegotiationNeeded() negotiation is needed!`),this.state!==_.CreateOffer&&this.opponentVersion===0){d.logger.info(`Call ${this.callId} onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event`);return}this.queueGotLocalOffer()}),this.onHangupReceived=te=>{d.logger.debug(`Call ${this.callId} onHangupReceived() running`),this.partyIdMatches(te)||this.state===_.Ringing?this.terminate(M.Remote,te.reason||W.UserHangup,!0):d.logger.info(`Call ${this.callId} onHangupReceived() ignoring message from party ID ${te.party_id}: our partner is ${this.opponentPartyId}`)},this.onRejectReceived=te=>{d.logger.debug(`Call ${this.callId} onRejectReceived() running`),[_.InviteSent,_.Ringing].includes(this.state)||this.state===_.Fledgling&&this.direction===w.Inbound?this.terminate(M.Remote,te.reason||W.UserHangup,!0):d.logger.debug(`Call ${this.callId} onRejectReceived() called in wrong state (state=${this.state})`)},this.onAnsweredElsewhere=te=>{d.logger.debug(`Call ${this.callId} onAnsweredElsewhere() running`),this.terminate(M.Remote,W.AnsweredElsewhere,!0)},this.roomId=x.roomId,this.invitee=x.invitee,this.client=x.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=(Q=x.forceTURN)!==null&&Q!==void 0?Q:!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=x.opponentDeviceId,this.opponentSessionId=x.opponentSessionId,this.groupCallId=x.groupCallId,this.turnServers=x.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[F]});for(const te of this.turnServers)b.checkObjectHasKeys(te,["urls"]);this.callId=j(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){return c(this,void 0,void 0,function*(){yield this.placeCall(!0,!1)})}placeVideoCall(){return c(this,void 0,void 0,function*(){yield this.placeCall(!0,!0)})}createDataChannel(x,Q){const te=this.peerConn.createDataChannel(x,Q);return this.emit(A.DataChannel,te,this),te}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(x){const Q=this._state;this._state=x,this.emit(A.State,x,Q,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?T.Video:T.Voice}get hasLocalUserMediaVideoTrack(){var x;return!!(!((x=this.localUsermediaStream)===null||x===void 0)&&x.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(x=>{var Q;return x.purpose===i.SDPStreamMetadataPurpose.Usermedia&&((Q=x.stream)===null||Q===void 0?void 0:Q.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var x;return!!(!((x=this.localUsermediaStream)===null||x===void 0)&&x.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(x=>{var Q;return x.purpose===i.SDPStreamMetadataPurpose.Usermedia&&!!(!((Q=x.stream)===null||Q===void 0)&&Q.getAudioTracks().length)})}get hasUserMediaAudioSender(){var x;return!!(!((x=this.transceivers.get(q(i.SDPStreamMetadataPurpose.Usermedia,"audio")))===null||x===void 0)&&x.sender)}get hasUserMediaVideoSender(){var x;return!!(!((x=this.transceivers.get(q(i.SDPStreamMetadataPurpose.Usermedia,"video")))===null||x===void 0)&&x.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(x=>x.purpose===i.SDPStreamMetadataPurpose.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(x=>x.purpose===i.SDPStreamMetadataPurpose.Screenshare)}get localUsermediaStream(){var x;return(x=this.localUsermediaFeed)===null||x===void 0?void 0:x.stream}get localScreensharingStream(){var x;return(x=this.localScreensharingFeed)===null||x===void 0?void 0:x.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(x=>x.purpose===i.SDPStreamMetadataPurpose.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(x=>x.purpose===i.SDPStreamMetadataPurpose.Screenshare)}get remoteUsermediaStream(){var x;return(x=this.remoteUsermediaFeed)===null||x===void 0?void 0:x.stream}get remoteScreensharingStream(){var x;return(x=this.remoteScreensharingFeed)===null||x===void 0?void 0:x.stream}getFeedByStreamId(x){return this.getFeeds().find(Q=>Q.stream.id===x)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(x=>x.isLocal())}getRemoteFeeds(){return this.feeds.filter(x=>!x.isLocal())}initOpponentCrypto(){var x,Q;return c(this,void 0,void 0,function*(){if(!this.opponentDeviceId||!this.client.getUseE2eForGroupCall())return;if(!this.client.isCryptoEnabled()){this.opponentDeviceInfo=new o.DeviceInfo(this.opponentDeviceId);return}if(!this.client.crypto)throw new Error("Crypto is not initialised.");const te=this.invitee||((x=this.getOpponentMember())===null||x===void 0?void 0:x.userId);if(!te)throw new Error("Couldn't find opponent user ID to init crypto");const ae=yield this.client.crypto.deviceList.downloadKeys([te],!1);if(this.opponentDeviceInfo=(Q=ae.get(te))===null||Q===void 0?void 0:Q.get(this.opponentDeviceId),this.opponentDeviceInfo===void 0)throw new l.GroupCallUnknownDeviceError(te)})}getLocalSDPStreamMetadata(x=!1){const Q={};for(const te of this.getLocalFeeds())x&&(te.sdpMetadataStreamId=te.stream.id),Q[te.sdpMetadataStreamId]={purpose:te.purpose,audio_muted:te.isAudioMuted(),video_muted:te.isVideoMuted()};return Q}noIncomingFeeds(){return!this.feeds.some(x=>!x.isLocal())}pushRemoteFeed(x){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(x);return}const Q=this.getOpponentMember().userId,te=this.remoteSDPStreamMetadata[x.id].purpose,ae=this.remoteSDPStreamMetadata[x.id].audio_muted,de=this.remoteSDPStreamMetadata[x.id].video_muted;if(!te){d.logger.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=${x.id})`);return}if(this.getFeedByStreamId(x.id)){d.logger.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=${x.id})`);return}this.feeds.push(new r.CallFeed({client:this.client,call:this,roomId:this.roomId,userId:Q,deviceId:this.getOpponentDeviceId(),stream:x,purpose:te,audioMuted:ae,videoMuted:de})),this.emit(A.FeedsChanged,this.feeds,this),d.logger.info(`Call ${this.callId} pushRemoteFeed() pushed stream (streamId=${x.id}, active=${x.active}, purpose=${te})`)}pushRemoteFeedWithoutMetadata(x){var Q;const te=this.getOpponentMember().userId,ae=i.SDPStreamMetadataPurpose.Usermedia,de=(Q=this.feeds.find(X=>!X.isLocal()))===null||Q===void 0?void 0:Q.stream;if(de&&x.id!==de.id){d.logger.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=${x.id})`);return}if(this.getFeedByStreamId(x.id)){d.logger.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=${x.id})`);return}this.feeds.push(new r.CallFeed({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:te,deviceId:this.getOpponentDeviceId(),stream:x,purpose:ae})),this.emit(A.FeedsChanged,this.feeds,this),d.logger.info(`Call ${this.callId} pushRemoteFeedWithoutMetadata() pushed stream (streamId=${x.id}, active=${x.active})`)}pushNewLocalFeed(x,Q,te=!0){const ae=this.client.getUserId();if(R(x.getAudioTracks(),!0),R(x.getVideoTracks(),!0),this.getFeedByStreamId(x.id)){d.logger.warn(`Call ${this.callId} pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=${x.id})`);return}this.pushLocalFeed(new r.CallFeed({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:ae,deviceId:this.getOpponentDeviceId(),stream:x,purpose:Q}),te)}pushLocalFeed(x,Q=!0){if(this.feeds.some(te=>x.stream.id===te.stream.id)){d.logger.info(`Call ${this.callId} pushLocalFeed() ignoring duplicate local stream (streamId=${x.stream.id})`);return}if(this.feeds.push(x),Q)for(const te of x.stream.getTracks()){d.logger.info(`Call ${this.callId} pushLocalFeed() adding track to peer connection (id=${te.id}, kind=${te.kind}, streamId=${x.stream.id}, streamPurpose=${x.purpose}, enabled=${te.enabled})`);const ae=q(x.purpose,te.kind);if(this.transceivers.has(ae)){const de=this.transceivers.get(ae);de.sender.replaceTrack(te),de.direction=de.direction==="inactive"?"sendonly":"sendrecv"}else{const de=this.peerConn.addTrack(te,x.stream),X=this.peerConn.getTransceivers().find($=>$.sender===de);X?this.transceivers.set(ae,X):d.logger.warn(`Call ${this.callId} pushLocalFeed() didn't find a matching transceiver after adding track!`)}}d.logger.info(`Call ${this.callId} pushLocalFeed() pushed stream (id=${x.stream.id}, active=${x.stream.active}, purpose=${x.purpose})`),this.emit(A.FeedsChanged,this.feeds,this)}removeLocalFeed(x){const Q=q(x.purpose,"audio"),te=q(x.purpose,"video");for(const ae of[Q,te])if(this.transceivers.has(ae)){const de=this.transceivers.get(ae);de.sender&&this.peerConn.removeTrack(de.sender)}x.purpose===i.SDPStreamMetadataPurpose.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(x.stream),this.deleteFeed(x)}deleteAllFeeds(){for(const x of this.feeds)(!x.isLocal()||!this.groupCallId)&&x.dispose();this.feeds=[],this.emit(A.FeedsChanged,this.feeds,this)}deleteFeedByStream(x){const Q=this.getFeedByStreamId(x.id);if(!Q){d.logger.warn(`Call ${this.callId} deleteFeedByStream() didn't find the feed to delete (streamId=${x.id})`);return}this.deleteFeed(Q)}deleteFeed(x){x.dispose(),this.feeds.splice(this.feeds.indexOf(x),1),this.emit(A.FeedsChanged,this.feeds,this)}getCurrentCallStats(){return c(this,void 0,void 0,function*(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()})}collectCallStats(){return c(this,void 0,void 0,function*(){if(!this.peerConn)return;const x=yield this.peerConn.getStats(),Q=[];return x.forEach(te=>{Q.push(te)}),Q})}initWithInvite(x){var Q;return c(this,void 0,void 0,function*(){const te=x.getContent();this.direction=w.Inbound,(yield this.client.checkTurnServers())||d.logger.warn(`Call ${this.callId} initWithInvite() failed to get TURN credentials! Proceeding with call anyway...`);const de=te[i.SDPStreamMetadataKey];de?this.updateRemoteSDPStreamMetadata(de):d.logger.debug(`Call ${this.callId} initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams`),this.peerConn=this.createPeerConnection(),this.chooseOpponent(x),yield this.initOpponentCrypto();try{yield this.peerConn.setRemoteDescription(te.offer),yield this.addBufferedIceCandidates()}catch($){d.logger.debug(`Call ${this.callId} initWithInvite() failed to set remote description`,$),this.terminate(M.Local,W.SetRemoteDescription,!1);return}const X=(Q=this.feeds.find($=>!$.isLocal()))===null||Q===void 0?void 0:Q.stream;if(!this.isOnlyDataChannelAllowed&&(!X||X.getTracks().length===0)){d.logger.error(`Call ${this.callId} initWithInvite() no remote stream or no tracks after setting remote description!`),this.terminate(M.Local,W.SetRemoteDescription,!1);return}if(this.state=_.Ringing,x.getLocalAge()){const $=setTimeout(()=>{var re;this.state==_.Ringing&&(d.logger.debug(`Call ${this.callId} initWithInvite() invite has expired. Hanging up.`),this.hangupParty=M.Remote,this.state=_.Ended,this.stopAllMedia(),this.peerConn.signalingState!="closed"&&this.peerConn.close(),(re=this.stats)===null||re===void 0||re.removeStatsReportGatherer(this.callId),this.emit(A.Hangup,this))},te.lifetime-x.getLocalAge()),K=re=>{re!==_.Ringing&&(clearTimeout($),this.off(A.State,K))};this.on(A.State,K)}})}initWithHangup(x){this.state=_.Ended}shouldAnswerWithMediaType(x,Q,te){return x&&!Q?(d.logger.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${te} because the other side isn't sending it either.`),!1):!b.isNullOrUndefined(x)&&x!==Q&&!this.opponentSupportsSDPStreamMetadata()?(d.logger.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${te}=${x} because the other side doesn't support it. Answering with ${te}=${Q}.`),Q):x??Q}answer(x,Q){var te;return c(this,void 0,void 0,function*(){if(!this.inviteOrAnswerSent){if(x===!1&&Q===!1)throw new Error("You CANNOT answer a call without media");if(!this.localUsermediaStream&&!this.waitForLocalAVStream){const ae=this.state,de=this.shouldAnswerWithMediaType(x,this.hasRemoteUserMediaAudioTrack,"audio"),X=this.shouldAnswerWithMediaType(Q,this.hasRemoteUserMediaVideoTrack,"video");this.state=_.WaitLocalMedia,this.waitForLocalAVStream=!0;try{const $=yield this.client.getMediaHandler().getUserMediaStream(de,X);this.waitForLocalAVStream=!1;const re=[new r.CallFeed({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:(te=this.client.getDeviceId())!==null&&te!==void 0?te:void 0,stream:$,purpose:i.SDPStreamMetadataPurpose.Usermedia,audioMuted:!1,videoMuted:!1})];this.localScreensharingFeed&&re.push(this.localScreensharingFeed),this.answerWithCallFeeds(re)}catch($){if(X)d.logger.warn(`Call ${this.callId} answer() failed to getUserMedia(), trying to getUserMedia() without video`),this.state=ae,this.waitForLocalAVStream=!1,yield this.answer(de,!1);else{this.getUserMediaFailed($);return}}}else this.waitForLocalAVStream&&(this.state=_.WaitLocalMedia)}})}answerWithCallFeeds(x){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(x)}replacedBy(x){d.logger.debug(`Call ${this.callId} replacedBy() running (newCallId=${x.callId})`),this.state===_.WaitLocalMedia?(d.logger.debug(`Call ${this.callId} replacedBy() telling new call to wait for local media (newCallId=${x.callId})`),x.waitForLocalAVStream=!0):[_.CreateOffer,_.InviteSent].includes(this.state)&&(x.direction===w.Outbound?x.queueGotCallFeedsForAnswer([]):(d.logger.debug(`Call ${this.callId} replacedBy() handing local stream to new call(newCallId=${x.callId})`),x.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(Q=>Q.clone())))),this.successor=x,this.emit(A.Replaced,x,this),this.hangup(W.Replaced,!0)}hangup(x,Q){if(this.callHasEnded()||(d.logger.debug(`Call ${this.callId} hangup() ending call (reason=${x})`),this.terminate(M.Local,x,!Q),[_.Fledgling,_.WaitLocalMedia].includes(this.state)))return;const te={};(this.opponentVersion&&this.opponentVersion!==0||x!==W.UserHangup)&&(te.reason=x),this.sendVoipEvent(a.EventType.CallHangup,te)}reject(){if(this.state!==_.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){d.logger.info(`Call ${this.callId} reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=${this.opponentVersion})`),this.hangup(W.UserHangup,!0);return}d.logger.debug("Rejecting call: "+this.callId),this.terminate(M.Local,W.UserHangup,!0),this.sendVoipEvent(a.EventType.CallReject,{})}upgradeCall(x,Q){return c(this,void 0,void 0,function*(){if(!(!x&&!Q)&&this.opponentSupportsSDPStreamMetadata())try{d.logger.debug(`Call ${this.callId} upgradeCall() upgrading call (audio=${x}, video=${Q})`);const te=x||this.hasLocalUserMediaAudioTrack,ae=Q||this.hasLocalUserMediaVideoTrack,de=yield this.client.getMediaHandler().getUserMediaStream(te,ae,!1);yield this.updateLocalUsermediaStream(de,x,Q)}catch(te){d.logger.error(`Call ${this.callId} upgradeCall() failed to upgrade the call`,te),this.emit(A.Error,new D(W.NoUserMedia,"Failed to get camera access: ",te),this)}})}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(x,Q){return c(this,void 0,void 0,function*(){if(x&&this.isScreensharing())return d.logger.warn(`Call ${this.callId} setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!`),!0;if(!x&&!this.isScreensharing())return d.logger.warn(`Call ${this.callId} setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!`),!1;if(!this.opponentSupportsSDPStreamMetadata())return this.setScreensharingEnabledWithoutMetadataSupport(x,Q);if(d.logger.debug(`Call ${this.callId} setScreensharingEnabled() running (enabled=${x})`),x)try{const te=yield this.client.getMediaHandler().getScreensharingStream(Q);return te?(this.pushNewLocalFeed(te,i.SDPStreamMetadataPurpose.Screenshare),!0):!1}catch(te){return d.logger.error(`Call ${this.callId} setScreensharingEnabled() failed to get screen-sharing stream:`,te),!1}else{const te=this.transceivers.get(q(i.SDPStreamMetadataPurpose.Screenshare,"audio")),ae=this.transceivers.get(q(i.SDPStreamMetadataPurpose.Screenshare,"video"));for(const de of[te,ae])de&&de.sender&&this.peerConn.removeTrack(de.sender);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}})}setScreensharingEnabledWithoutMetadataSupport(x,Q){var te,ae,de;return c(this,void 0,void 0,function*(){if(d.logger.debug(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() running (enabled=${x})`),x)try{const X=yield this.client.getMediaHandler().getScreensharingStream(Q);if(!X)return!1;const $=X.getTracks().find(re=>re.kind==="video"),K=(te=this.transceivers.get(q(i.SDPStreamMetadataPurpose.Usermedia,"video")))===null||te===void 0?void 0:te.sender;return K==null||K.replaceTrack($??null),this.pushNewLocalFeed(X,i.SDPStreamMetadataPurpose.Screenshare,!1),!0}catch(X){return d.logger.error(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:`,X),!1}else{const X=(ae=this.localUsermediaStream)===null||ae===void 0?void 0:ae.getTracks().find(K=>K.kind==="video"),$=(de=this.transceivers.get(q(i.SDPStreamMetadataPurpose.Usermedia,"video")))===null||de===void 0?void 0:de.sender;return $==null||$.replaceTrack(X??null),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}})}updateLocalUsermediaStream(x,Q=!1,te=!1){return c(this,void 0,void 0,function*(){const ae=this.localUsermediaFeed,de=Q||!ae.isAudioMuted()&&!this.remoteOnHold,X=te||!ae.isVideoMuted()&&!this.remoteOnHold;d.logger.log(`Call ${this.callId} updateLocalUsermediaStream() running (streamId=${x.id}, audio=${de}, video=${X})`),R(x.getAudioTracks(),de),R(x.getVideoTracks(),X);for(const $ of this.localUsermediaStream.getTracks())this.localUsermediaStream.removeTrack($),$.stop();for(const $ of x.getTracks())this.localUsermediaStream.addTrack($);for(const $ of x.getTracks()){const K=q(i.SDPStreamMetadataPurpose.Usermedia,$.kind),re=this.transceivers.get(K),ue=re==null?void 0:re.sender;let H=!1;if(ue)try{d.logger.info(`Call ${this.callId} updateLocalUsermediaStream() replacing track (id=${$.id}, kind=${$.kind}, streamId=${x.id}, streamPurpose=${ae.purpose})`),yield ue.replaceTrack($),re.direction=re.direction==="inactive"?"sendonly":"sendrecv",H=!0}catch(G){d.logger.warn(`Call ${this.callId} updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead`,G)}if(!H){d.logger.info(`Call ${this.callId} updateLocalUsermediaStream() adding track to peer connection (id=${$.id}, kind=${$.kind}, streamId=${x.id}, streamPurpose=${ae.purpose})`);const G=this.peerConn.addTrack($,this.localUsermediaStream),U=this.peerConn.getTransceivers().find(L=>L.sender===G);U?this.transceivers.set(K,U):d.logger.warn(`Call ${this.callId} updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!`)}}})}setLocalVideoMuted(x){var Q,te;return c(this,void 0,void 0,function*(){if(d.logger.log(`Call ${this.callId} setLocalVideoMuted() running ${x}`),!x&&this.stopVideoTrackTimer!==void 0&&(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0),!(yield this.client.getMediaHandler().hasVideoDevice()))return this.isLocalVideoMuted();if(!this.hasUserMediaVideoSender&&!x)return(Q=this.localUsermediaFeed)===null||Q===void 0||Q.setAudioVideoMuted(null,x),yield this.upgradeCall(!1,!0),this.isLocalVideoMuted();if(!x&&this.localUsermediaStream.getVideoTracks().length===0){const ae=yield this.client.getMediaHandler().getUserMediaStream(!0,!0);yield this.updateLocalUsermediaStream(ae)}return(te=this.localUsermediaFeed)===null||te===void 0||te.setAudioVideoMuted(null,x),this.updateMuteStatus(),yield this.sendMetadataUpdate(),x&&(this.stopVideoTrackTimer=setTimeout(()=>{for(const ae of this.localUsermediaStream.getVideoTracks())ae.stop(),this.localUsermediaStream.removeTrack(ae)},120)),this.isLocalVideoMuted()})}isLocalVideoMuted(){var x,Q;return(Q=(x=this.localUsermediaFeed)===null||x===void 0?void 0:x.isVideoMuted())!==null&&Q!==void 0?Q:!1}setMicrophoneMuted(x){var Q;return c(this,void 0,void 0,function*(){return d.logger.log(`Call ${this.callId} setMicrophoneMuted() running ${x}`),(yield this.client.getMediaHandler().hasAudioDevice())?!x&&(!this.hasUserMediaAudioSender||!this.hasLocalUserMediaAudioTrack)?(yield this.upgradeCall(!0,!1),this.isMicrophoneMuted()):((Q=this.localUsermediaFeed)===null||Q===void 0||Q.setAudioVideoMuted(x,null),this.updateMuteStatus(),yield this.sendMetadataUpdate(),this.isMicrophoneMuted()):this.isMicrophoneMuted()})}isMicrophoneMuted(){var x,Q;return(Q=(x=this.localUsermediaFeed)===null||x===void 0?void 0:x.isAudioMuted())!==null&&Q!==void 0?Q:!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(x){if(this.isRemoteOnHold()!==x){this.remoteOnHold=x;for(const Q of this.peerConn.getTransceivers())Q.direction=x?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(A.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==_.Connected)return!1;let x=!0;for(const Q of this.peerConn.getTransceivers())["inactive","recvonly"].includes(Q.currentDirection)||(x=!1);return x}sendDtmfDigit(x){var Q;for(const te of this.peerConn.getSenders())if(((Q=te.track)===null||Q===void 0?void 0:Q.kind)==="audio"&&te.dtmf){te.dtmf.insertDTMF(x);return}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){const x=this.isMicrophoneMuted()||this.remoteOnHold,Q=this.isLocalVideoMuted()||this.remoteOnHold;d.logger.log(`Call ${this.callId} updateMuteStatus stream ${this.localUsermediaStream.id} micShouldBeMuted ${x} vidShouldBeMuted ${Q}`),R(this.localUsermediaStream.getAudioTracks(),!x),R(this.localUsermediaStream.getVideoTracks(),!Q)}sendMetadataUpdate(){return c(this,void 0,void 0,function*(){yield this.sendVoipEvent(a.EventType.CallSDPStreamMetadataChangedPrefix,{[i.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata()})})}gotCallFeedsForInvite(x,Q=!1){if(this.successor){this.successor.queueGotCallFeedsForAnswer(x);return}if(this.callHasEnded()){this.stopAllMedia();return}for(const te of x)this.pushLocalFeed(te);Q&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=_.CreateOffer,d.logger.debug(`Call ${this.callId} gotUserMediaForInvite() run`)}sendAnswer(){return c(this,void 0,void 0,function*(){const x={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[i.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata(!0)};x.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1};const Q=this.discardDuplicateCandidates();d.logger.info(`Call ${this.callId} sendAnswer() discarding ${Q} candidates that will be sent in answer`);try{yield this.sendVoipEvent(a.EventType.CallAnswer,x),this.inviteOrAnswerSent=!0}catch(te){this.state=_.Ringing,te instanceof v.MatrixError&&te.event&&this.client.cancelPendingEvent(te.event);let ae=W.SendAnswer,de="Failed to send answer";throw te.name=="UnknownDeviceError"&&(ae=W.UnknownDevices,de="Unknown devices present in the room"),this.emit(A.Error,new D(ae,de,te),this),te}this.sendCandidateQueue()})}queueGotCallFeedsForAnswer(x){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(x)):this.responsePromiseChain=this.gotCallFeedsForAnswer(x)}mungeSdp(x,Q){const te=(0,h.parse)(x.sdp);te.media.forEach(ae=>{const de=new Map,X=new Map;for(const $ of ae.rtp)de.set($.payload,$.codec),X.set($.codec,$.payload);for(const $ of Q){if($.mediaType!==ae.type)continue;if(!X.has($.codec)){d.logger.info(`Call ${this.callId} mungeSdp() ignoring SDP modifications for ${$.codec} as it's not present.`);continue}const K=[];$.enableDtx!==void 0&&K.push(`usedtx=${$.enableDtx?"1":"0"}`),$.maxAverageBitrate!==void 0&&K.push(`maxaveragebitrate=${$.maxAverageBitrate}`);let re=!1;for(const ue of ae.fmtp)de.get(ue.payload)===$.codec&&(re=!0,ue.config+=";"+K.join(";"));re||ae.fmtp.push({payload:X.get($.codec),config:K.join(";")})}}),x.sdp=(0,h.write)(te)}createOffer(){return c(this,void 0,void 0,function*(){const x=yield this.peerConn.createOffer();return this.mungeSdp(x,Y(this.isPtt)),x})}createAnswer(){return c(this,void 0,void 0,function*(){const x=yield this.peerConn.createAnswer();return this.mungeSdp(x,Y(this.isPtt)),x})}gotCallFeedsForAnswer(x){return c(this,void 0,void 0,function*(){if(this.callHasEnded())return;this.waitForLocalAVStream=!1;for(const te of x)this.pushLocalFeed(te);this.state=_.CreateAnswer;let Q;try{this.getRidOfRTXCodecs(),Q=yield this.createAnswer()}catch(te){d.logger.debug(`Call ${this.callId} gotCallFeedsForAnswer() failed to create answer: `,te),this.terminate(M.Local,W.CreateAnswer,!0);return}try{if(yield this.peerConn.setLocalDescription(Q),this.callHasEnded()||(this.state=_.Connecting,yield new Promise(te=>{setTimeout(te,200)}),this.callHasEnded()))return;this.sendAnswer()}catch(te){d.logger.debug(`Call ${this.callId} gotCallFeedsForAnswer() error setting local description!`,te),this.terminate(M.Local,W.SetLocalDescription,!0);return}})}onRemoteIceCandidatesReceived(x){return c(this,void 0,void 0,function*(){if(this.callHasEnded())return;const Q=x.getContent(),te=Q.candidates;if(!te){d.logger.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!`);return}const ae=Q.version===0?null:Q.party_id||null;if(this.opponentPartyId===void 0){if(ae){d.logger.info(`Call ${this.callId} onRemoteIceCandidatesReceived() buffering ${te.length} candidates until we pick an opponent`);const de=this.remoteCandidateBuffer.get(ae)||[];de.push(...te),this.remoteCandidateBuffer.set(ae,de)}return}if(!this.partyIdMatches(Q)){d.logger.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates from party ID ${Q.party_id}: we have chosen party ID ${this.opponentPartyId}`);return}yield this.addIceCandidates(te)})}onAnswerReceived(x){return c(this,void 0,void 0,function*(){const Q=x.getContent();if(d.logger.debug(`Call ${this.callId} onAnswerReceived() running (hangupParty=${Q.party_id})`),this.callHasEnded()){d.logger.debug(`Call ${this.callId} onAnswerReceived() ignoring answer because call has ended`);return}if(this.opponentPartyId!==void 0){d.logger.info(`Call ${this.callId} onAnswerReceived() ignoring answer from party ID ${Q.party_id}: we already have an answer/reject from ${this.opponentPartyId}`);return}this.chooseOpponent(x),yield this.addBufferedIceCandidates(),this.state=_.Connecting;const te=Q[i.SDPStreamMetadataKey];te?this.updateRemoteSDPStreamMetadata(te):d.logger.warn(`Call ${this.callId} onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams`);try{yield this.peerConn.setRemoteDescription(Q.answer)}catch(ae){d.logger.debug(`Call ${this.callId} onAnswerReceived() failed to set remote description`,ae),this.terminate(M.Local,W.SetRemoteDescription,!1);return}if(this.opponentPartyId!==null)try{yield this.sendVoipEvent(a.EventType.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(ae){d.logger.warn(`Call ${this.callId} onAnswerReceived() failed to send select_answer event`,ae)}})}onSelectAnswerReceived(x){return c(this,void 0,void 0,function*(){if(this.direction!==w.Inbound){d.logger.warn(`Call ${this.callId} onSelectAnswerReceived() got select_answer for an outbound call: ignoring`);return}const Q=x.getContent().selected_party_id;if(Q==null){d.logger.warn(`Call ${this.callId} onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring`);return}Q!==this.ourPartyId&&(d.logger.info(`Call ${this.callId} onSelectAnswerReceived() got select_answer for party ID ${Q}: we are party ID ${this.ourPartyId}.`),yield this.terminate(M.Remote,W.AnsweredElsewhere,!0))})}onNegotiateReceived(x){var Q;return c(this,void 0,void 0,function*(){const te=x.getContent(),ae=te.description;if(!ae||!ae.sdp||!ae.type){d.logger.info(`Call ${this.callId} onNegotiateReceived() ignoring invalid m.call.negotiate event`);return}const de=this.direction===w.Inbound,X=ae.type==="offer"&&(this.makingOffer||this.peerConn.signalingState!=="stable");if(this.ignoreOffer=!de&&X,this.ignoreOffer){d.logger.info(`Call ${this.callId} onNegotiateReceived() ignoring colliding negotiate event because we're impolite`);return}const $=this.isLocalOnHold(),K=te[i.SDPStreamMetadataKey];K?this.updateRemoteSDPStreamMetadata(K):d.logger.warn(`Call ${this.callId} onNegotiateReceived() received negotiation event without SDPStreamMetadata!`);try{if(yield this.peerConn.setRemoteDescription(ae),ae.type==="offer"){let ue;try{this.getRidOfRTXCodecs(),ue=yield this.createAnswer()}catch(H){d.logger.debug(`Call ${this.callId} onNegotiateReceived() failed to create answer: `,H),this.terminate(M.Local,W.CreateAnswer,!0);return}yield this.peerConn.setLocalDescription(ue),this.sendVoipEvent(a.EventType.CallNegotiate,{description:(Q=this.peerConn.localDescription)===null||Q===void 0?void 0:Q.toJSON(),[i.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata(!0)})}}catch(ue){d.logger.warn(`Call ${this.callId} onNegotiateReceived() failed to complete negotiation`,ue)}const re=this.isLocalOnHold();$!==re&&(this.emit(A.LocalHoldUnhold,re,this),this.emit(A.HoldUnhold,re))})}updateRemoteSDPStreamMetadata(x){var Q;this.remoteSDPStreamMetadata=b.recursivelyAssign(this.remoteSDPStreamMetadata||{},x,!0);for(const te of this.getRemoteFeeds()){const ae=te.stream.id,de=this.remoteSDPStreamMetadata[ae];te.setAudioVideoMuted(de==null?void 0:de.audio_muted,de==null?void 0:de.video_muted),te.purpose=(Q=this.remoteSDPStreamMetadata[ae])===null||Q===void 0?void 0:Q.purpose}}onSDPStreamMetadataChangedReceived(x){const te=x.getContent()[i.SDPStreamMetadataKey];this.updateRemoteSDPStreamMetadata(te)}onAssertedIdentityReceived(x){return c(this,void 0,void 0,function*(){const Q=x.getContent();Q.asserted_identity&&(this.remoteAssertedIdentity={id:Q.asserted_identity.id,displayName:Q.asserted_identity.display_name},this.emit(A.AssertedIdentityChanged,this))})}callHasEnded(){return this.state===_.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){return c(this,void 0,void 0,function*(){this.makingOffer=!0;try{yield this.gotLocalOffer()}catch(x){this.getLocalOfferFailed(x);return}finally{this.makingOffer=!1}})}gotLocalOffer(){var x,Q;return c(this,void 0,void 0,function*(){if(d.logger.debug(`Call ${this.callId} gotLocalOffer() running`),this.callHasEnded()){d.logger.debug(`Call ${this.callId} gotLocalOffer() ignoring newly created offer because the call has ended"`);return}let te;try{this.getRidOfRTXCodecs(),te=yield this.createOffer()}catch($){d.logger.debug(`Call ${this.callId} gotLocalOffer() failed to create offer: `,$),this.terminate(M.Local,W.CreateOffer,!0);return}try{yield this.peerConn.setLocalDescription(te)}catch($){d.logger.debug(`Call ${this.callId} gotLocalOffer() error setting local description!`,$),this.terminate(M.Local,W.SetLocalDescription,!0);return}if(this.peerConn.iceGatheringState==="gathering"&&(yield new Promise($=>{setTimeout($,200)})),this.callHasEnded())return;const ae=this.state===_.CreateOffer?a.EventType.CallInvite:a.EventType.CallNegotiate,de={lifetime:C};ae===a.EventType.CallInvite&&this.invitee&&(de.invitee=this.invitee),this.state===_.CreateOffer?de.offer=(x=this.peerConn.localDescription)===null||x===void 0?void 0:x.toJSON():de.description=(Q=this.peerConn.localDescription)===null||Q===void 0?void 0:Q.toJSON(),de.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},de[i.SDPStreamMetadataKey]=this.getLocalSDPStreamMetadata(!0);const X=this.discardDuplicateCandidates();d.logger.info(`Call ${this.callId} gotLocalOffer() discarding ${X} candidates that will be sent in offer`);try{yield this.sendVoipEvent(ae,de)}catch($){d.logger.error(`Call ${this.callId} gotLocalOffer() failed to send invite`,$),$ instanceof v.MatrixError&&$.event&&this.client.cancelPendingEvent($.event);let K=W.SignallingFailed,re="Signalling failed";this.state===_.CreateOffer&&(K=W.SendInvite,re="Failed to send invite"),$.name=="UnknownDeviceError"&&(K=W.UnknownDevices,re="Unknown devices present in the room"),this.emit(A.Error,new D(K,re,$),this),this.terminate(M.Local,K,!1);return}this.sendCandidateQueue(),this.state===_.CreateOffer&&(this.inviteOrAnswerSent=!0,this.state=_.InviteSent,this.inviteTimeout=setTimeout(()=>{this.inviteTimeout=void 0,this.state===_.InviteSent&&this.hangup(W.InviteTimeout,!1)},C))})}getRidOfRTXCodecs(){if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const x=RTCRtpReceiver.getCapabilities("video").codecs,te=[...RTCRtpSender.getCapabilities("video").codecs,...x];for(const de of te)if(de.mimeType==="video/rtx"){const X=te.indexOf(de);te.splice(X,1)}const ae=this.transceivers.get(q(i.SDPStreamMetadataPurpose.Screenshare,"video"));ae&&ae.setCodecPreferences(te)}sendVoipEvent(x,Q){var te,ae;return c(this,void 0,void 0,function*(){const de=Object.assign({},Q,{version:ee,call_id:this.callId,party_id:this.ourPartyId,conf_id:this.groupCallId});if(this.opponentDeviceId){const X=this.toDeviceSeq++,$=Object.assign(Object.assign({},de),{device_id:this.client.deviceId,sender_session_id:this.client.getSessionId(),dest_session_id:this.opponentSessionId,seq:X,[a.ToDeviceMessageId]:(0,m.v4)()});this.emit(A.SendVoipEvent,{type:"toDevice",eventType:x,userId:this.invitee||((te=this.getOpponentMember())===null||te===void 0?void 0:te.userId),opponentDeviceId:this.opponentDeviceId,content:$},this);const K=this.invitee||this.getOpponentMember().userId;if(this.client.getUseE2eForGroupCall()){if(!this.opponentDeviceInfo){d.logger.warn(`Call ${this.callId} sendVoipEvent() failed: we do not have opponentDeviceInfo`);return}yield this.client.encryptAndSendToDevices([{userId:K,deviceInfo:this.opponentDeviceInfo}],{type:x,content:$})}else yield this.client.sendToDevice(x,new Map([[K,new Map([[this.opponentDeviceId,$]])]]))}else this.emit(A.SendVoipEvent,{type:"sendEvent",eventType:x,roomId:this.roomId,content:de,userId:this.invitee||((ae=this.getOpponentMember())===null||ae===void 0?void 0:ae.userId)},this),yield this.client.sendEvent(this.roomId,x,de)})}queueCandidate(x){if(x?this.candidateSendQueue.push(x):this.candidatesEnded=!0,this.state===_.Ringing||!this.inviteOrAnswerSent)return;const Q=this.direction===w.Inbound?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},Q)}discardDuplicateCandidates(){let x=0;const Q=[];for(let te=0;te<this.candidateSendQueue.length;te++){const ae=this.candidateSendQueue[te];ae.candidate===""?Q.push(ae):x++}return this.candidateSendQueue=Q,x}transfer(x){return c(this,void 0,void 0,function*(){const Q=yield this.client.getProfileInfo(x),te=j(),ae={replacement_id:j(),target_user:{id:x,display_name:Q.displayname,avatar_url:Q.avatar_url},create_call:te};yield this.sendVoipEvent(a.EventType.CallReplaces,ae),yield this.terminate(M.Local,W.Transferred,!0)})}transferToCall(x){var Q,te;return c(this,void 0,void 0,function*(){const ae=(Q=x.getOpponentMember())===null||Q===void 0?void 0:Q.userId,de=ae?yield this.client.getProfileInfo(ae):void 0,X=(te=this.getOpponentMember())===null||te===void 0?void 0:te.userId,$=X?yield this.client.getProfileInfo(X):void 0,K=j(),re={replacement_id:j(),target_user:{id:X,display_name:$==null?void 0:$.displayname,avatar_url:$==null?void 0:$.avatar_url},await_call:K};yield x.sendVoipEvent(a.EventType.CallReplaces,re);const ue={replacement_id:j(),target_user:{id:ae,display_name:de==null?void 0:de.displayname,avatar_url:de==null?void 0:de.avatar_url},create_call:K};yield this.sendVoipEvent(a.EventType.CallReplaces,ue),yield this.terminate(M.Local,W.Transferred,!0),yield x.terminate(M.Local,W.Transferred,!0)})}terminate(x,Q,te){var ae;return c(this,void 0,void 0,function*(){if(!this.callHasEnded()){this.hangupParty=x,this.hangupReason=Q,this.state=_.Ended,this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=void 0),this.iceDisconnectedTimeout!==void 0&&(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=void 0),this.stopVideoTrackTimer!==void 0&&(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0);for(const[de,X]of this.removeTrackListeners)de.removeEventListener("removetrack",X);this.removeTrackListeners.clear(),this.callStatsAtEnd=yield this.collectCallStats(),this.stopAllMedia(),this.deleteAllFeeds(),this.peerConn&&this.peerConn.signalingState!=="closed"&&this.peerConn.close(),(ae=this.stats)===null||ae===void 0||ae.removeStatsReportGatherer(this.callId),te&&this.emit(A.Hangup,this),this.client.callEventHandler.calls.delete(this.callId)}})}stopAllMedia(){d.logger.debug(`Call ${this.callId} stopAllMedia() running`);for(const x of this.feeds)if(x.isLocal()&&x.purpose===i.SDPStreamMetadataPurpose.Usermedia)this.client.getMediaHandler().stopUserMediaStream(x.stream);else if(x.isLocal()&&x.purpose===i.SDPStreamMetadataPurpose.Screenshare)this.client.getMediaHandler().stopScreensharingStream(x.stream);else if(!x.isLocal()){d.logger.debug(`Call ${this.callId} stopAllMedia() stopping stream (streamId=${x.stream.id})`);for(const Q of x.stream.getTracks())Q.stop()}}checkForErrorListener(){if(this.listeners(s.EventEmitterEvents.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){return c(this,void 0,void 0,function*(){if(this.candidateSendQueue.length===0||this.callHasEnded())return;const x=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const Q={candidates:x.map(te=>te.toJSON())};this.candidatesEnded&&Q.candidates.push({candidate:""}),d.logger.debug(`Call ${this.callId} sendCandidateQueue() attempting to send ${x.length} candidates`);try{yield this.sendVoipEvent(a.EventType.CallCandidates,Q),this.candidateSendTries=0,this.sendCandidateQueue()}catch(te){if(te instanceof v.MatrixError&&te.event&&this.client.cancelPendingEvent(te.event),this.candidateSendQueue.push(...x),this.candidateSendTries>5){d.logger.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates on attempt ${this.candidateSendTries}. Giving up on this call.`,te);const de=W.SignallingFailed,X="Signalling failed";this.emit(A.Error,new D(de,X,te),this),this.hangup(de,!1);return}const ae=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,d.logger.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates. Retrying in ${ae}ms`,te),setTimeout(()=>{this.sendCandidateQueue()},ae)}})}placeCall(x,Q){var te;return c(this,void 0,void 0,function*(){if(!x)throw new Error("You CANNOT start a call without audio");this.state=_.WaitLocalMedia;try{const ae=yield this.client.getMediaHandler().getUserMediaStream(x,Q);R(ae.getAudioTracks(),!0),R(ae.getVideoTracks(),!0);const de=new r.CallFeed({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:(te=this.client.getDeviceId())!==null&&te!==void 0?te:void 0,stream:ae,purpose:i.SDPStreamMetadataPurpose.Usermedia,audioMuted:!1,videoMuted:!1});yield this.placeCallWithCallFeeds([de])}catch(ae){this.getUserMediaFailed(ae);return}})}placeCallWithCallFeeds(x,Q=!1){return c(this,void 0,void 0,function*(){this.checkForErrorListener(),this.direction=w.Outbound,yield this.initOpponentCrypto(),this.client.callEventHandler.calls.set(this.callId,this),(yield this.client.checkTurnServers())||d.logger.warn(`Call ${this.callId} placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...`),this.peerConn=this.createPeerConnection(),this.gotCallFeedsForInvite(x,Q)})}createPeerConnection(){var x;const Q=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});return Q.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),Q.addEventListener("signalingstatechange",this.onSignallingStateChanged),Q.addEventListener("icecandidate",this.gotLocalIceCandidate),Q.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),Q.addEventListener("track",this.onTrack),Q.addEventListener("negotiationneeded",this.onNegotiationNeeded),Q.addEventListener("datachannel",this.onDataChannel),(x=this.stats)===null||x===void 0||x.addStatsReportGatherer(this.callId,"unknown",Q),Q}partyIdMatches(x){return(x.version===0?null:x.party_id||null)===this.opponentPartyId}chooseOpponent(x){var Q;const te=x.getContent();d.logger.debug(`Call ${this.callId} chooseOpponent() running (partyId=${te.party_id})`),this.opponentVersion=te.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=te.party_id||null,this.opponentCaps=te.capabilities||{},this.opponentMember=(Q=this.client.getRoom(this.roomId).getMember(x.getSender()))!==null&&Q!==void 0?Q:void 0}addBufferedIceCandidates(){return c(this,void 0,void 0,function*(){const x=this.remoteCandidateBuffer.get(this.opponentPartyId);x&&(d.logger.info(`Call ${this.callId} addBufferedIceCandidates() adding ${x.length} buffered candidates for opponent ${this.opponentPartyId}`),yield this.addIceCandidates(x)),this.remoteCandidateBuffer.clear()})}addIceCandidates(x){return c(this,void 0,void 0,function*(){for(const Q of x){(Q.sdpMid===null||Q.sdpMid===void 0)&&(Q.sdpMLineIndex===null||Q.sdpMLineIndex===void 0)?d.logger.debug(`Call ${this.callId} addIceCandidates() got remote ICE end-of-candidates`):d.logger.debug(`Call ${this.callId} addIceCandidates() got remote ICE candidate (sdpMid=${Q.sdpMid}, candidate=${Q.candidate})`);try{yield this.peerConn.addIceCandidate(Q)}catch(te){this.ignoreOffer||d.logger.info(`Call ${this.callId} addIceCandidates() failed to add remote ICE candidate`,te)}}})}get hasPeerConnection(){return!!this.peerConn}initStats(x,Q="unknown"){this.stats=x,this.stats.start()}}e.MatrixCall=B;function R(V,x){for(const Q of V)Q.enabled=x}e.setTracksEnabled=R;function k(){if(typeof window>"u"||typeof document>"u")return!1;try{if(!!!(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return d.logger.error("WebRTC is not supported in this browser / environment"),!1}catch(V){return d.logger.error("Exception thrown when trying to access WebRTC",V),!1}return!0}e.supportsMatrixCall=k;function P(V,x,Q){if(!k())return null;const te=Q?Q.forceTURN:!1,ae={client:V,roomId:x,invitee:Q==null?void 0:Q.invitee,turnServers:V.getTurnServers(),forceTURN:V.forceTURN||te,opponentDeviceId:Q==null?void 0:Q.opponentDeviceId,opponentSessionId:Q==null?void 0:Q.opponentSessionId,groupCallId:Q==null?void 0:Q.groupCallId},de=new B(ae);return V.reEmitter.reEmit(de,Object.values(A)),de}e.createNewMatrixCall=P}).call(this)}).call(this,t("_process"))},{"../@types/event":306,"../crypto/deviceinfo":340,"../http-api":367,"../logger":374,"../models/typed-event-emitter":395,"../randomstring":398,"../utils":416,"./callEventTypes":420,"./callFeed":421,"./groupCall":422,_process:237,"sdp-transform":253,uuid:287}],419:[function(t,E,e){var u=this&&this.__awaiter||function(n,i,r,s){function o(l){return l instanceof r?l:new r(function(v){v(l)})}return new(r||(r=Promise))(function(l,v){function f(T){try{_(s.next(T))}catch(w){v(w)}}function p(T){try{_(s.throw(T))}catch(w){v(w)}}function _(T){T.done?l(T.value):o(T.value).then(f,p)}_((s=s.apply(n,i||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.CallEventHandler=e.CallEventHandlerEvent=void 0;const g=t("../logger"),S=t("./call"),y=t("../@types/event"),c=t("../client"),m=t("./groupCall"),h=t("../models/room"),d=3e3;var b;(function(n){n.Incoming="Call.incoming"})(b=e.CallEventHandlerEvent||(e.CallEventHandlerEvent={}));class a{constructor(i){this.nextSeqByCall=new Map,this.toDeviceEventBuffers=new Map,this.onSync=()=>{const r=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(r)):this.eventBufferPromiseChain=this.evaluateEventBuffer(r)},this.onRoomTimeline=r=>{this.callEventBuffer.push(r)},this.onToDeviceEvent=r=>{const s=r.getContent();if(!s.call_id){this.callEventBuffer.push(r);return}if(this.nextSeqByCall.has(s.call_id)||this.nextSeqByCall.set(s.call_id,0),s.seq===void 0){this.callEventBuffer.push(r);return}const o=this.nextSeqByCall.get(s.call_id)||0;if(s.seq!==o){this.toDeviceEventBuffers.has(s.call_id)||this.toDeviceEventBuffers.set(s.call_id,[]);const l=this.toDeviceEventBuffers.get(s.call_id),v=l.findIndex(f=>f.getContent().seq>s.seq);v===-1?l.push(r):l.splice(v,0,r)}else{const l=s.call_id;this.callEventBuffer.push(r),this.nextSeqByCall.set(l,s.seq+1);const v=this.toDeviceEventBuffers.get(l);let f=v&&v.shift();for(;f&&f.getContent().seq===this.nextSeqByCall.get(l);)this.callEventBuffer.push(f),this.nextSeqByCall.set(l,f.getContent().seq+1),f=v.shift()}},this.client=i,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(c.ClientEvent.Sync,this.onSync),this.client.on(h.RoomEvent.Timeline,this.onRoomTimeline),this.client.on(c.ClientEvent.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(c.ClientEvent.Sync,this.onSync),this.client.removeListener(h.RoomEvent.Timeline,this.onRoomTimeline),this.client.removeListener(c.ClientEvent.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(i){return u(this,void 0,void 0,function*(){yield Promise.all(i.map(o=>this.client.decryptEventIfNeeded(o)));const r=i.filter(o=>{const l=o.getType();return l.startsWith("m.call.")||l.startsWith("org.matrix.call.")}),s=new Set;for(const o of r){const l=o.getType();(l===y.EventType.CallAnswer||l===y.EventType.CallHangup)&&s.add(o.getContent().call_id)}for(const o of r){const l=o.getType(),v=o.getContent().call_id;if(!(l===y.EventType.CallInvite&&s.has(v)))try{yield this.handleCallEvent(o)}catch(f){g.logger.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",f)}}})}handleCallEvent(i){var r,s,o,l,v,f;return u(this,void 0,void 0,function*(){this.client.emit(c.ClientEvent.ReceivedVoipEvent,i);const p=i.getContent(),_=i.getRoomId()||((s=(r=this.client.groupCallEventHandler.getGroupCallById(p.conf_id))===null||r===void 0?void 0:r.room)===null||s===void 0?void 0:s.roomId),T=p.conf_id,w=i.getType(),M=i.getSender();let A=p.call_id?this.calls.get(p.call_id):void 0,W,ee;if(T){if(ee=this.client.groupCallEventHandler.getGroupCallById(T),!ee){g.logger.warn(`CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=${T}, type=${w})`);return}if(W=p.device_id,!W){g.logger.warn(`CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=${M})`),ee.emit(m.GroupCallEvent.Error,new m.GroupCallUnknownDeviceError(M));return}if(p.dest_session_id!==this.client.getSessionId()){g.logger.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}const F=M===this.client.credentials.userId&&(W===void 0||W===this.client.getDeviceId());if(_){if(w===y.EventType.CallInvite){if(F||i.getLocalAge()>p.lifetime-d||A&&A.state===S.CallState.Ended||(A&&g.logger.warn(`CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=${p.call_id})`),p.invitee&&p.invitee!==this.client.getUserId()))return;const C=((o=this.client.getTurnServersExpiry())!==null&&o!==void 0?o:0)-Date.now();if(g.logger.info("CallEventHandler handleCallEvent() current turn creds expire in "+C+" ms"),A=(l=(0,S.createNewMatrixCall)(this.client,_,{forceTURN:this.client.forceTURN,opponentDeviceId:W,groupCallId:T,opponentSessionId:p.sender_session_id}))!==null&&l!==void 0?l:void 0,!A){g.logger.log(`CallEventHandler handleCallEvent() this client does not support WebRTC (callId=${p.call_id})`);return}A.callId=p.call_id;const O=ee==null?void 0:ee.getGroupCallStats();O&&A.initStats(O);try{yield A.initWithInvite(i)}catch(D){D instanceof S.CallError&&(D.code===m.GroupCallErrorCode.UnknownDevice?ee==null||ee.emit(m.GroupCallEvent.Error,D):g.logger.error(D))}if(this.calls.set(A.callId,A),this.candidateEventsByCall.get(A.callId))for(const D of this.candidateEventsByCall.get(A.callId))A.onRemoteIceCandidatesReceived(D);let I;for(const D of this.calls.values()){const j=[S.CallState.WaitLocalMedia,S.CallState.CreateOffer,S.CallState.InviteSent].includes(D.state);if(A.roomId===D.roomId&&D.direction===S.CallDirection.Outbound&&((v=A.getOpponentMember())===null||v===void 0?void 0:v.userId)===D.invitee&&j){I=D;break}}I?I.callId>A.callId?(g.logger.log(`CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=${A.callId}, outgoingId=${I.callId})`),I.replacedBy(A)):(g.logger.log(`CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=${A.callId}, outgoingId=${I.callId})`),A.hangup(S.CallErrorCode.Replaced,!0)):this.client.emit(b.Incoming,A);return}else if(w===y.EventType.CallCandidates){if(F)return;A?A.onRemoteIceCandidatesReceived(i):(this.candidateEventsByCall.has(p.call_id)||this.candidateEventsByCall.set(p.call_id,[]),this.candidateEventsByCall.get(p.call_id).push(i));return}else if([y.EventType.CallHangup,y.EventType.CallReject].includes(w)){A?A.state!==S.CallState.Ended&&(w===y.EventType.CallHangup?A.onHangupReceived(p):A.onRejectReceived(p),A.state===S.CallState.Ended&&this.calls.delete(p.call_id)):(A=(f=(0,S.createNewMatrixCall)(this.client,_,{opponentDeviceId:W,opponentSessionId:p.sender_session_id}))!==null&&f!==void 0?f:void 0,A&&(A.callId=p.call_id,A.initWithHangup(i),this.calls.set(p.call_id,A)));return}if(!A||!A.hasPeerConnection){g.logger.info(`CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=${w})`);return}if(i.getContent().party_id!==A.ourPartyId)switch(w){case y.EventType.CallAnswer:F?A.state===S.CallState.Ringing&&A.onAnsweredElsewhere(p):A.onAnswerReceived(i);break;case y.EventType.CallSelectAnswer:A.onSelectAnswerReceived(i);break;case y.EventType.CallNegotiate:A.onNegotiateReceived(i);break;case y.EventType.CallAssertedIdentity:case y.EventType.CallAssertedIdentityPrefix:A.onAssertedIdentityReceived(i);break;case y.EventType.CallSDPStreamMetadataChanged:case y.EventType.CallSDPStreamMetadataChangedPrefix:A.onSDPStreamMetadataChangedReceived(i);break}}})}}e.CallEventHandler=a},{"../@types/event":306,"../client":321,"../logger":374,"../models/room":392,"./call":418,"./groupCall":422}],420:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SDPStreamMetadataPurpose=e.SDPStreamMetadataKey=void 0,e.SDPStreamMetadataKey="org.matrix.msc3077.sdp_stream_metadata",function(u){u.Usermedia="m.usermedia",u.Screenshare="m.screenshare"}(e.SDPStreamMetadataPurpose||(e.SDPStreamMetadataPurpose={}))},{}],421:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.CallFeed=e.CallFeedEvent=e.SPEAKING_THRESHOLD=void 0;const u=t("./callEventTypes"),g=t("./audioContext"),S=t("../logger"),y=t("../models/typed-event-emitter"),c=t("./call"),m=200;e.SPEAKING_THRESHOLD=-60;const h=8;var d;(function(a){a.NewStream="new_stream",a.MuteStateChanged="mute_state_changed",a.LocalVolumeChanged="local_volume_changed",a.VolumeChanged="volume_changed",a.ConnectedChanged="connected_changed",a.Speaking="speaking",a.Disposed="disposed"})(d=e.CallFeedEvent||(e.CallFeedEvent={}));class b extends y.TypedEventEmitter{constructor(n){super(),this.localVolume=1,this.measuringVolumeActivity=!1,this.speakingThreshold=e.SPEAKING_THRESHOLD,this.speaking=!1,this._disposed=!1,this._connected=!1,this.onAddTrack=()=>{this.emit(d.NewStream,this.stream)},this.onCallState=i=>{i===c.CallState.Connected?this.connected=!0:i===c.CallState.Connecting&&(this.connected=!1)},this.volumeLooper=()=>{if(!this.analyser||!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let i=-1/0;for(const s of this.frequencyBinCount)s>i&&(i=s);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(i),this.emit(d.VolumeChanged,i);let r=!1;for(const s of this.speakingVolumeSamples)if(s>this.speakingThreshold){r=!0;break}this.speaking!==r&&(this.speaking=r,this.emit(d.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,m)},this.client=n.client,this.call=n.call,this.roomId=n.roomId,this.userId=n.userId,this.deviceId=n.deviceId,this.purpose=n.purpose,this.audioMuted=n.audioMuted,this.videoMuted=n.videoMuted,this.speakingVolumeSamples=new Array(h).fill(-1/0),this.sdpMetadataStreamId=n.stream.id,this.updateStream(null,n.stream),this.stream=n.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),n.call&&(n.call.addListener(c.CallEvent.State,this.onCallState),this.onCallState(n.call.state))}get connected(){return this.isLocal()||this._connected}set connected(n){this._connected=n,this.emit(d.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(n,i){i!==n&&(n&&(n.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=i,i.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?this.initVolumeMeasuring():this.measureVolumeActivity(!1),this.emit(d.NewStream,this.stream))}initVolumeMeasuring(){if(!this.hasAudioTrack)return;this.audioContext||(this.audioContext=(0,g.acquireContext)()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}getMember(){var n;const i=this.client.getRoom(this.roomId);return(n=i==null?void 0:i.getMember(this.userId))!==null&&n!==void 0?n:null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(n){this.updateStream(this.stream,n)}setAudioVideoMuted(n,i){n!==null&&(this.audioMuted!==n&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=n),i!==null&&(this.videoMuted=i),this.emit(d.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(n){if(n){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(d.VolumeChanged,-1/0)}setSpeakingThreshold(n){this.speakingThreshold=n}clone(){const n=this.client.getMediaHandler(),i=this.stream.clone();return S.logger.log(`CallFeed clone() cloning stream (originalStreamId=${this.stream.id}, newStreamId${i.id})`),this.purpose===u.SDPStreamMetadataPurpose.Usermedia?n.userMediaStreams.push(i):n.screensharingStreams.push(i),new b({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:i,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var n,i;clearTimeout(this.volumeLooperTimeout),(n=this.stream)===null||n===void 0||n.removeEventListener("addtrack",this.onAddTrack),(i=this.call)===null||i===void 0||i.removeListener(c.CallEvent.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,(0,g.releaseContext)()),this._disposed=!0,this.emit(d.Disposed)}get disposed(){return this._disposed}set disposed(n){this._disposed=n}getLocalVolume(){return this.localVolume}setLocalVolume(n){this.localVolume=n,this.emit(d.LocalVolumeChanged,n)}}e.CallFeed=b},{"../logger":374,"../models/typed-event-emitter":395,"./audioContext":417,"./call":418,"./callEventTypes":420}],422:[function(t,E,e){var u=this&&this.__awaiter||function(F,C,O,I){function D(j){return j instanceof O?j:new O(function(Y){Y(j)})}return new(O||(O=Promise))(function(j,Y){function q(k){try{R(I.next(k))}catch(P){Y(P)}}function B(k){try{R(I.throw(k))}catch(P){Y(P)}}function R(k){k.done?j(k.value):D(k.value).then(q,B)}R((I=I.apply(F,C||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.GroupCall=e.GroupCallState=e.OtherUserSpeakingError=e.GroupCallUnknownDeviceError=e.GroupCallError=e.GroupCallErrorCode=e.GroupCallStatsReportEvent=e.GroupCallEvent=e.GroupCallTerminationReason=e.GroupCallType=e.GroupCallIntent=void 0;const g=t("../models/typed-event-emitter"),S=t("./callFeed"),y=t("./call"),c=t("../models/room-state"),m=t("../logger"),h=t("../ReEmitter"),d=t("./callEventTypes"),b=t("../@types/event"),a=t("./callEventHandler"),n=t("./groupCallEventHandler"),i=t("../utils"),r=t("./stats/groupCallStats"),s=t("./stats/statsReport");(function(F){F.Ring="m.ring",F.Prompt="m.prompt",F.Room="m.room"})(e.GroupCallIntent||(e.GroupCallIntent={}));var o;(function(F){F.Video="m.video",F.Voice="m.voice"})(o=e.GroupCallType||(e.GroupCallType={}));var l;(function(F){F.CallEnded="call_ended"})(l=e.GroupCallTerminationReason||(e.GroupCallTerminationReason={}));var v;(function(F){F.GroupCallStateChanged="group_call_state_changed",F.ActiveSpeakerChanged="active_speaker_changed",F.CallsChanged="calls_changed",F.UserMediaFeedsChanged="user_media_feeds_changed",F.ScreenshareFeedsChanged="screenshare_feeds_changed",F.LocalScreenshareStateChanged="local_screenshare_state_changed",F.LocalMuteStateChanged="local_mute_state_changed",F.ParticipantsChanged="participants_changed",F.Error="group_call_error"})(v=e.GroupCallEvent||(e.GroupCallEvent={}));var f;(function(F){F.ConnectionStats="GroupCall.connection_stats",F.ByteSentStats="GroupCall.byte_sent_stats"})(f=e.GroupCallStatsReportEvent||(e.GroupCallStatsReportEvent={}));var p;(function(F){F.NoUserMedia="no_user_media",F.UnknownDevice="unknown_device",F.PlaceCallFailed="place_call_failed"})(p=e.GroupCallErrorCode||(e.GroupCallErrorCode={}));class _ extends Error{constructor(C,O,I){I?super(O+": "+I):super(O),this.code=C}}e.GroupCallError=_;class T extends _{constructor(C){super(p.UnknownDevice,"No device found for "+C),this.userId=C}}e.GroupCallUnknownDeviceError=T;class w extends Error{constructor(){super("Cannot unmute: another user is speaking")}}e.OtherUserSpeakingError=w;var M;(function(F){F.LocalCallFeedUninitialized="local_call_feed_uninitialized",F.InitializingLocalCallFeed="initializing_local_call_feed",F.LocalCallFeedInitialized="local_call_feed_initialized",F.Entered="entered",F.Ended="ended"})(M=e.GroupCallState||(e.GroupCallState={}));const A=1e3*60*60;function W(F){var C;return((C=F.getOpponentMember())===null||C===void 0?void 0:C.userId)||F.invitee||null}class ee extends g.TypedEventEmitter{constructor(C,O,I,D,j,Y,q,B,R){var k,P;super(),this.client=C,this.room=O,this.type=I,this.isPtt=D,this.intent=j,this.dataChannelsEnabled=q,this.dataChannelOptions=B,this.activeSpeakerInterval=1e3,this.retryCallInterval=5e3,this.participantTimeout=1e3*15,this.pttMaxTransmitTime=1e3*20,this.userMediaFeeds=[],this.screenshareFeeds=[],this.calls=new Map,this.callHandlers=new Map,this.retryCallCounts=new Map,this.transmitTimer=null,this.participantsExpirationTimer=null,this.resendMemberStateTimer=null,this.initWithAudioMuted=!1,this.initWithVideoMuted=!1,this.onConnectionStats=x=>{this.emit(f.ConnectionStats,{report:x})},this.onByteSentStats=x=>{this.emit(f.ByteSentStats,{report:x})},this._state=M.LocalCallFeedUninitialized,this._participants=new Map,this._creationTs=null,this._enteredViaAnotherSession=!1,this.onIncomingCall=x=>{var Q,te;if(x.roomId!==this.room.roomId)return;if(x.state!==y.CallState.Ringing){m.logger.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call no longer in ringing state - ignoring`);return}if(!x.groupCallId||x.groupCallId!==this.groupCallId){m.logger.log(`GroupCall ${this.groupCallId} onIncomingCall() ignored because it doesn't match the current group call`),x.reject();return}const ae=(Q=x.getOpponentMember())===null||Q===void 0?void 0:Q.userId;if(ae===void 0){m.logger.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call with no member - ignoring`);return}const de=(te=this.calls.get(ae))!==null&&te!==void 0?te:new Map,X=de.get(x.getOpponentDeviceId());if((X==null?void 0:X.callId)===x.callId)return;m.logger.log(`GroupCall ${this.groupCallId} onIncomingCall() incoming call (userId=${ae}, callId=${x.callId})`),X&&X.hangup(y.CallErrorCode.Replaced,!1),this.initCall(x);const $=this.getLocalFeeds().map(K=>K.clone());if(!this.callExpected(x))for(const K of $)(0,y.setTracksEnabled)(K.stream.getAudioTracks(),!1),(0,y.setTracksEnabled)(K.stream.getVideoTracks(),!1);x.answerWithCallFeeds($),de.set(x.getOpponentDeviceId(),x),this.calls.set(ae,de),this.emit(v.CallsChanged,this.calls)},this.onRetryCallLoop=()=>{var x;let Q=!1;for(const[{userId:te},ae]of this.participants){const de=this.calls.get(te);let X=this.retryCallCounts.get(te);for(const[$,K]of ae){const re=de==null?void 0:de.get($),ue=(x=X==null?void 0:X.get($))!==null&&x!==void 0?x:0;(re==null?void 0:re.getOpponentSessionId())!==K.sessionId&&this.wantsOutgoingCall(te,$)&&ue<3&&(X===void 0&&(X=new Map,this.retryCallCounts.set(te,X)),X.set($,ue+1),Q=!0)}}Q&&this.placeOutgoingCalls()},this.onCallFeedsChanged=x=>{const Q=W(x),te=x.getOpponentDeviceId();if(!Q)throw new Error("Cannot change call feeds without user id");const ae=this.getUserMediaFeed(Q,te),de=x.remoteUsermediaFeed;de!==ae&&(!ae&&de?this.addUserMediaFeed(de):ae&&de?this.replaceUserMediaFeed(ae,de):ae&&!de&&this.removeUserMediaFeed(ae));const $=this.getScreenshareFeed(Q,te),K=x.remoteScreensharingFeed;K!==$&&(!$&&K?this.addScreenshareFeed(K):$&&K?this.replaceScreenshareFeed($,K):$&&!K&&this.removeScreenshareFeed($))},this.onCallStateChanged=(x,Q,te)=>{var ae;if(Q===y.CallState.Ended)return;const de=this.localCallFeed.isAudioMuted();x.localUsermediaStream&&x.isMicrophoneMuted()!==de&&x.setMicrophoneMuted(de);const X=this.localCallFeed.isVideoMuted();x.localUsermediaStream&&x.isLocalVideoMuted()!==X&&x.setLocalVideoMuted(X);const $=(ae=x.getOpponentMember())===null||ae===void 0?void 0:ae.userId;if(Q===y.CallState.Connected&&$){const K=this.retryCallCounts.get($);K==null||K.delete(x.getOpponentDeviceId()),(K==null?void 0:K.size)===0&&this.retryCallCounts.delete($)}},this.onCallHangup=x=>{var Q,te;if(x.hangupReason===y.CallErrorCode.Replaced)return;const ae=(te=(Q=x.getOpponentMember())===null||Q===void 0?void 0:Q.userId)!==null&&te!==void 0?te:this.room.getMember(x.invitee).userId,de=this.calls.get(ae);(de==null?void 0:de.get(x.getOpponentDeviceId()))===x&&(this.disposeCall(x,x.hangupReason),de.delete(x.getOpponentDeviceId()),de.size===0&&this.calls.delete(ae),this.emit(v.CallsChanged,this.calls))},this.onCallReplaced=(x,Q)=>{const te=x.getOpponentMember().userId;let ae=this.calls.get(te);ae===void 0&&(ae=new Map,this.calls.set(te,ae)),x.hangup(y.CallErrorCode.Replaced,!1),this.initCall(Q),ae.set(x.getOpponentDeviceId(),Q),this.emit(v.CallsChanged,this.calls)},this.onActiveSpeakerLoop=()=>{let x,Q;for(const te of this.userMediaFeeds){if(te.isLocal()&&this.userMediaFeeds.length>1)continue;const de=te.speakingVolumeSamples.reduce((X,$)=>X+Math.max($,S.SPEAKING_THRESHOLD))/te.speakingVolumeSamples.length;(!x||de>x)&&(x=de,Q=te)}Q&&this.activeSpeaker!==Q&&x&&x>S.SPEAKING_THRESHOLD&&(this.activeSpeaker=Q,this.emit(v.ActiveSpeakerChanged,this.activeSpeaker))},this.onRoomState=()=>this.updateParticipants(),this.onParticipantsChanged=()=>{this.forEachCall(x=>{const Q=this.callExpected(x);for(const te of x.getLocalFeeds())(0,y.setTracksEnabled)(te.stream.getAudioTracks(),!te.isAudioMuted()&&Q),(0,y.setTracksEnabled)(te.stream.getVideoTracks(),!te.isVideoMuted()&&Q)}),this.state===M.Entered&&this.placeOutgoingCalls()},this.onStateChanged=(x,Q)=>{(x===M.Entered||Q===M.Entered||x===M.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(te=>m.logger.error(`GroupCall ${this.groupCallId} onStateChanged() failed to update member state devices"`,te)))},this.onLocalFeedsChanged=()=>{this.state===M.Entered&&this.updateMemberState().catch(x=>m.logger.error(`GroupCall ${this.groupCallId} onLocalFeedsChanged() failed to update member state feeds`,x))},this.reEmitter=new h.ReEmitter(this),this.groupCallId=Y??(0,y.genCallID)(),this.creationTs=(P=(k=O.currentState.getStateEvents(b.EventType.GroupCallPrefix,this.groupCallId))===null||k===void 0?void 0:k.getTs())!==null&&P!==void 0?P:null,this.updateParticipants(),O.on(c.RoomStateEvent.Update,this.onRoomState),this.on(v.ParticipantsChanged,this.onParticipantsChanged),this.on(v.GroupCallStateChanged,this.onStateChanged),this.on(v.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!R;const V=this.client.getUserId()||"unknown";this.stats=new r.GroupCallStats(this.groupCallId,V),this.stats.reports.on(s.StatsReport.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(s.StatsReport.BYTE_SENT_STATS,this.onByteSentStats)}create(){return u(this,void 0,void 0,function*(){this.creationTs=Date.now(),this.client.groupCallEventHandler.groupCalls.set(this.room.roomId,this),this.client.emit(n.GroupCallEventHandlerEvent.Outgoing,this);const C={"m.intent":this.intent,"m.type":this.type,"io.element.ptt":this.isPtt,dataChannelsEnabled:this.dataChannelsEnabled,dataChannelOptions:this.dataChannelsEnabled?this.dataChannelOptions:void 0};return yield this.client.sendStateEvent(this.room.roomId,b.EventType.GroupCallPrefix,C,this.groupCallId),this})}get state(){return this._state}set state(C){const O=this._state;C!==O&&(this._state=C,this.emit(v.GroupCallStateChanged,C,O))}get participants(){return this._participants}set participants(C){const O=this._participants,I=(j,Y)=>j.sessionId===Y.sessionId&&j.screensharing===Y.screensharing,D=(j,Y)=>(0,i.mapsEqual)(j,Y,I);(0,i.mapsEqual)(C,O,D)||(this._participants=C,this.emit(v.ParticipantsChanged,C))}get creationTs(){return this._creationTs}set creationTs(C){this._creationTs=C}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(C){this._enteredViaAnotherSession=C,this.updateParticipants()}forEachCall(C){for(const O of this.calls.values())for(const I of O.values())C(I)}getLocalFeeds(){const C=[];return this.localCallFeed&&C.push(this.localCallFeed),this.localScreenshareFeed&&C.push(this.localScreenshareFeed),C}hasLocalParticipant(){var C,O;return(O=(C=this.participants.get(this.room.getMember(this.client.getUserId())))===null||C===void 0?void 0:C.has(this.client.getDeviceId()))!==null&&O!==void 0?O:!1}callExpected(C){var O;const I=W(C),D=I===null?null:this.room.getMember(I),j=C.getOpponentDeviceId();return D!==null&&j!==void 0&&((O=this.participants.get(D))===null||O===void 0?void 0:O.get(j))!==void 0}initLocalCallFeed(){return u(this,void 0,void 0,function*(){if(this.state!==M.LocalCallFeedUninitialized)throw new Error(`Cannot initialize local call feed in the "${this.state}" state.`);if(this.state=M.InitializingLocalCallFeed,this.initCallFeedPromise)return this.initCallFeedPromise;try{this.initCallFeedPromise=this.initLocalCallFeedInternal(),yield this.initCallFeedPromise}finally{this.initCallFeedPromise=void 0}})}initLocalCallFeedInternal(){return u(this,void 0,void 0,function*(){m.logger.log(`GroupCall ${this.groupCallId} initLocalCallFeedInternal() running`);let C;try{C=yield this.client.getMediaHandler().getUserMediaStream(!0,this.type===o.Video)}catch(I){if(this.allowCallWithoutVideoAndAudio)C=new MediaStream;else throw this.state=M.LocalCallFeedUninitialized,I}if(this._state!==M.InitializingLocalCallFeed)throw this.client.getMediaHandler().stopUserMediaStream(C),new Error("Group call disposed while gathering media stream");const O=new S.CallFeed({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:C,purpose:d.SDPStreamMetadataPurpose.Usermedia,audioMuted:this.initWithAudioMuted||C.getAudioTracks().length===0||this.isPtt,videoMuted:this.initWithVideoMuted||C.getVideoTracks().length===0});(0,y.setTracksEnabled)(C.getAudioTracks(),!O.isAudioMuted()),(0,y.setTracksEnabled)(C.getVideoTracks(),!O.isVideoMuted()),this.localCallFeed=O,this.addUserMediaFeed(O),this.state=M.LocalCallFeedInitialized})}updateLocalUsermediaStream(C){return u(this,void 0,void 0,function*(){if(this.localCallFeed){const O=this.localCallFeed.stream;this.localCallFeed.setNewStream(C);const I=this.localCallFeed.isAudioMuted(),D=this.localCallFeed.isVideoMuted();m.logger.log(`GroupCall ${this.groupCallId} updateLocalUsermediaStream() (oldStreamId=${O.id}, newStreamId=${C.id}, micShouldBeMuted=${I}, vidShouldBeMuted=${D})`),(0,y.setTracksEnabled)(C.getAudioTracks(),!I),(0,y.setTracksEnabled)(C.getVideoTracks(),!D),this.client.getMediaHandler().stopUserMediaStream(O)}})}enter(){return u(this,void 0,void 0,function*(){if(this.state===M.LocalCallFeedUninitialized)yield this.initLocalCallFeed();else if(this.state!==M.LocalCallFeedInitialized)throw new Error(`Cannot enter call in the "${this.state}" state`);m.logger.log(`GroupCall ${this.groupCallId} enter() running`),this.state=M.Entered,this.client.on(a.CallEventHandlerEvent.Incoming,this.onIncomingCall);for(const C of this.client.callEventHandler.calls.values())this.onIncomingCall(C);this.retryCallLoopInterval=setInterval(this.onRetryCallLoop,this.retryCallInterval),this.activeSpeaker=void 0,this.onActiveSpeakerLoop(),this.activeSpeakerLoopInterval=setInterval(this.onActiveSpeakerLoop,this.activeSpeakerInterval)})}dispose(){this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===M.Entered&&(this.forEachCall(C=>C.hangup(y.CallErrorCode.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(a.CallEventHandlerEvent.Incoming,this.onIncomingCall),this.stats.stop())}leave(){this.dispose(),this.state=M.LocalCallFeedUninitialized}terminate(C=!0){return u(this,void 0,void 0,function*(){if(this.dispose(),this.room.off(c.RoomStateEvent.Update,this.onRoomState),this.client.groupCallEventHandler.groupCalls.delete(this.room.roomId),this.client.emit(n.GroupCallEventHandlerEvent.Ended,this),this.state=M.Ended,C){const O=this.room.currentState.getStateEvents(b.EventType.GroupCallPrefix,this.groupCallId);yield this.client.sendStateEvent(this.room.roomId,b.EventType.GroupCallPrefix,Object.assign(Object.assign({},O.getContent()),{"m.terminated":l.CallEnded}),this.groupCallId)}})}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}setMicrophoneMuted(C){return u(this,void 0,void 0,function*(){if(!C&&!(yield this.client.getMediaHandler().hasAudioDevice()))return!1;const O=!C&&this.isPtt;this.isPtt&&(!C&&this.isMicrophoneMuted()?this.transmitTimer=setTimeout(()=>{this.setMicrophoneMuted(!0)},this.pttMaxTransmitTime):C&&!this.isMicrophoneMuted()&&(this.transmitTimer!==null&&clearTimeout(this.transmitTimer),this.transmitTimer=null)),this.forEachCall(D=>{var j;return(j=D.localUsermediaFeed)===null||j===void 0?void 0:j.setAudioVideoMuted(C,null)});const I=()=>u(this,void 0,void 0,function*(){const D=[];this.forEachCall(j=>D.push(j.sendMetadataUpdate())),yield Promise.all(D).catch(j=>m.logger.info(`GroupCall ${this.groupCallId} setMicrophoneMuted() failed to send some metadata updates`,j))});if(O&&(yield I()),this.localCallFeed){m.logger.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() (streamId=${this.localCallFeed.stream.id}, muted=${C})`);try{if(!C&&(yield this.client.getMediaHandler().getUserMediaStream(!0,!this.localCallFeed.isVideoMuted()))===null)return m.logger.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device to receive local stream, muted=${C}`),!1}catch{return m.logger.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device or permission to receive local stream, muted=${C}`),!1}this.localCallFeed.setAudioVideoMuted(C,null),(0,y.setTracksEnabled)(this.localCallFeed.stream.getAudioTracks(),!C)}else m.logger.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no stream muted (muted=${C})`),this.initWithAudioMuted=C;return this.forEachCall(D=>(0,y.setTracksEnabled)(D.localUsermediaFeed.stream.getAudioTracks(),!C&&this.callExpected(D))),this.emit(v.LocalMuteStateChanged,C,this.isLocalVideoMuted()),O||(yield I()),!0})}setLocalVideoMuted(C){return u(this,void 0,void 0,function*(){if(!C&&!(yield this.client.getMediaHandler().hasVideoDevice()))return!1;if(this.localCallFeed){m.logger.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() (stream=${this.localCallFeed.stream.id}, muted=${C})`);try{const I=yield this.client.getMediaHandler().getUserMediaStream(!0,!C);yield this.updateLocalUsermediaStream(I),this.localCallFeed.setAudioVideoMuted(null,C),(0,y.setTracksEnabled)(this.localCallFeed.stream.getVideoTracks(),!C)}catch{return m.logger.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no device or permission to receive local stream, muted=${C}`),!1}}else m.logger.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no stream muted (muted=${C})`),this.initWithVideoMuted=C;const O=[];return this.forEachCall(I=>O.push(I.setLocalVideoMuted(C))),yield Promise.all(O),this.forEachCall(I=>(0,y.setTracksEnabled)(I.localUsermediaFeed.stream.getVideoTracks(),!C&&this.callExpected(I))),this.emit(v.LocalMuteStateChanged,this.isMicrophoneMuted(),C),!0})}setScreensharingEnabled(C,O={}){return u(this,void 0,void 0,function*(){if(C===this.isScreensharing())return C;if(C)try{m.logger.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() is asking for screensharing permissions`);const I=yield this.client.getMediaHandler().getScreensharingStream(O);for(const D of I.getTracks()){const j=()=>{this.setScreensharingEnabled(!1),D.removeEventListener("ended",j)};D.addEventListener("ended",j)}return m.logger.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls`),this.localDesktopCapturerSourceId=O.desktopCapturerSourceId,this.localScreenshareFeed=new S.CallFeed({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:I,purpose:d.SDPStreamMetadataPurpose.Screenshare,audioMuted:!1,videoMuted:!1}),this.addScreenshareFeed(this.localScreenshareFeed),this.emit(v.LocalScreenshareStateChanged,!0,this.localScreenshareFeed,this.localDesktopCapturerSourceId),this.forEachCall(D=>D.pushLocalFeed(this.localScreenshareFeed.clone())),!0}catch(I){if(O.throwOnFail)throw I;return m.logger.error(`GroupCall ${this.groupCallId} setScreensharingEnabled() enabling screensharing error`,I),this.emit(v.Error,new _(p.NoUserMedia,"Failed to get screen-sharing stream: ",I)),!1}else return this.forEachCall(I=>{I.localScreensharingFeed&&I.removeLocalFeed(I.localScreensharingFeed)}),this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0,this.emit(v.LocalScreenshareStateChanged,!1,void 0,void 0),!1})}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(C,O){const I=this.client.getUserId(),D=this.client.getDeviceId();return C>=I&&(C!==I||O>D)}placeOutgoingCalls(){var C;let O=!1;for(const[{userId:I},D]of this.participants){const j=(C=this.calls.get(I))!==null&&C!==void 0?C:new Map;for(const[Y,q]of D){const B=j.get(Y);if((B==null?void 0:B.getOpponentSessionId())!==q.sessionId&&this.wantsOutgoingCall(I,Y)){O=!0,B!==void 0&&(m.logger.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() replacing call (userId=${I}, deviceId=${Y}, callId=${B.callId})`),B.hangup(y.CallErrorCode.NewSession,!1));const R=(0,y.createNewMatrixCall)(this.client,this.room.roomId,{invitee:I,opponentDeviceId:Y,opponentSessionId:q.sessionId,groupCallId:this.groupCallId});R===null?(m.logger.error(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to create call (userId=${I}, device=${Y})`),j.delete(Y)):(this.initCall(R),j.set(Y,R),m.logger.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() placing call (userId=${I}, deviceId=${Y}, sessionId=${q.sessionId})`),R.placeCallWithCallFeeds(this.getLocalFeeds().map(k=>k.clone()),q.screensharing).then(()=>{this.dataChannelsEnabled&&R.createDataChannel("datachannel",this.dataChannelOptions)}).catch(k=>{m.logger.warn(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to place call (userId=${I})`,k),k instanceof y.CallError&&k.code===p.UnknownDevice?this.emit(v.Error,k):this.emit(v.Error,new _(p.PlaceCallFailed,`Failed to place call to ${I}`)),R.hangup(y.CallErrorCode.SignallingFailed,!1),j.get(Y)===R&&j.delete(Y)}))}}j.size>0?this.calls.set(I,j):this.calls.delete(I)}O&&this.emit(v.CallsChanged,this.calls)}getMemberStateEvents(C){return C===void 0?this.room.currentState.getStateEvents(b.EventType.GroupCallMemberPrefix):this.room.currentState.getStateEvents(b.EventType.GroupCallMemberPrefix,C)}initCall(C){const O=W(C);if(!O)throw new Error("Cannot init call without user id");const I=()=>this.onCallFeedsChanged(C),D=(B,R)=>this.onCallStateChanged(C,B,R),j=this.onCallHangup,Y=B=>this.onCallReplaced(C,B);let q=this.callHandlers.get(O);q===void 0&&(q=new Map,this.callHandlers.set(O,q)),q.set(C.getOpponentDeviceId(),{onCallFeedsChanged:I,onCallStateChanged:D,onCallHangup:j,onCallReplaced:Y}),C.on(y.CallEvent.FeedsChanged,I),C.on(y.CallEvent.State,D),C.on(y.CallEvent.Hangup,j),C.on(y.CallEvent.Replaced,Y),C.isPtt=this.isPtt,this.reEmitter.reEmit(C,Object.values(y.CallEvent)),C.initStats(this.stats),I()}disposeCall(C,O){const I=W(C),D=C.getOpponentDeviceId();if(!I)throw new Error("Cannot dispose call without user id");const j=this.callHandlers.get(I),{onCallFeedsChanged:Y,onCallStateChanged:q,onCallHangup:B,onCallReplaced:R}=j.get(D);if(C.removeListener(y.CallEvent.FeedsChanged,Y),C.removeListener(y.CallEvent.State,q),C.removeListener(y.CallEvent.Hangup,B),C.removeListener(y.CallEvent.Replaced,R),j.delete(I),j.size===0&&this.callHandlers.delete(I),C.hangupReason===y.CallErrorCode.Replaced)return;const k=this.getUserMediaFeed(I,D);k&&this.removeUserMediaFeed(k);const P=this.getScreenshareFeed(I,D);P&&this.removeScreenshareFeed(P)}getUserMediaFeed(C,O){return this.userMediaFeeds.find(I=>I.userId===C&&I.deviceId===O)}addUserMediaFeed(C){this.userMediaFeeds.push(C),C.measureVolumeActivity(!0),this.emit(v.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(C,O){const I=this.userMediaFeeds.findIndex(D=>D.userId===C.userId&&D.deviceId===C.deviceId);if(I===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(I,1,O),C.dispose(),O.measureVolumeActivity(!0),this.emit(v.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(C){const O=this.userMediaFeeds.findIndex(I=>I.userId===C.userId&&I.deviceId===C.deviceId);if(O===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(O,1),C.dispose(),this.emit(v.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===C&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(v.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(C,O){return this.screenshareFeeds.find(I=>I.userId===C&&I.deviceId===O)}addScreenshareFeed(C){this.screenshareFeeds.push(C),this.emit(v.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(C,O){const I=this.screenshareFeeds.findIndex(D=>D.userId===C.userId&&D.deviceId===C.deviceId);if(I===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(I,1,O),C.dispose(),this.emit(v.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(C){const O=this.screenshareFeeds.findIndex(I=>I.userId===C.userId&&I.deviceId===C.deviceId);if(O===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(O,1),C.dispose(),this.emit(v.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){const C=this.room.getMember(this.client.getUserId());if(!C){m.logger.warn(`GroupCall ${this.groupCallId} updateParticipants() tried to update participants before local room member is available`);return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===M.Ended){this.participants=new Map;return}const O=new Map,I=Date.now(),D=this.state===M.Entered||this.enteredViaAnotherSession;let j=1/0;for(const Y of this.getMemberStateEvents()){const q=this.room.getMember(Y.getStateKey()),B=Y.getContent(),k=(Array.isArray(B["m.calls"])?B["m.calls"]:[]).find(x=>x["m.call_id"]===this.groupCallId);let V=(Array.isArray(k==null?void 0:k["m.devices"])?k["m.devices"]:[]).filter(x=>typeof x.device_id=="string"&&typeof x.session_id=="string"&&typeof x.expires_ts=="number"&&x.expires_ts>I&&Array.isArray(x.feeds));if(!D&&(q==null?void 0:q.userId)===this.client.getUserId()&&(V=V.filter(x=>x.device_id!==this.client.getDeviceId())),V.length>0&&(q==null?void 0:q.membership)==="join"){const x=new Map;O.set(q,x);for(const Q of V)x.set(Q.device_id,{sessionId:Q.session_id,screensharing:Q.feeds.some(te=>te.purpose===d.SDPStreamMetadataPurpose.Screenshare)}),Q.expires_ts<j&&(j=Q.expires_ts)}}if(D){let Y=O.get(C);Y===void 0&&(Y=new Map,O.set(C,Y)),Y.has(this.client.getDeviceId())||Y.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(q=>q.purpose===d.SDPStreamMetadataPurpose.Screenshare)})}this.participants=O,j<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),j-I))}updateDevices(C,O=!1){var I;return u(this,void 0,void 0,function*(){const D=Date.now(),j=this.client.getUserId(),Y=this.getMemberStateEvents(j),q=(I=Y==null?void 0:Y.getContent())!==null&&I!==void 0?I:{},B=Array.isArray(q["m.calls"])?q["m.calls"]:[];let R=null;const k=[];for(const ae of B)ae["m.call_id"]===this.groupCallId?R=ae:k.push(ae);R===null&&(R={});const V=(Array.isArray(R["m.devices"])?R["m.devices"]:[]).filter(ae=>typeof ae.device_id=="string"&&typeof ae.session_id=="string"&&typeof ae.expires_ts=="number"&&ae.expires_ts>D&&Array.isArray(ae.feeds)),x=C(V);if(x===null)return;const Q=[...k];x.length>0&&Q.push(Object.assign(Object.assign({},R),{"m.call_id":this.groupCallId,"m.devices":x}));const te={"m.calls":Q};yield this.client.sendStateEvent(this.room.roomId,b.EventType.GroupCallMemberPrefix,te,j,{keepAlive:O})})}addDeviceToMemberState(){return u(this,void 0,void 0,function*(){yield this.updateDevices(C=>[...C.filter(O=>O.device_id!==this.client.getDeviceId()),{device_id:this.client.getDeviceId(),session_id:this.client.getSessionId(),expires_ts:Date.now()+A,feeds:this.getLocalFeeds().map(O=>({purpose:O.purpose}))}])})}updateMemberState(){return u(this,void 0,void 0,function*(){this.resendMemberStateTimer!==null&&(clearInterval(this.resendMemberStateTimer),this.resendMemberStateTimer=null),this.state===M.Entered?(yield this.addDeviceToMemberState(),this.resendMemberStateTimer=setInterval(()=>u(this,void 0,void 0,function*(){m.logger.log(`GroupCall ${this.groupCallId} updateMemberState() resending call member state"`);try{yield this.addDeviceToMemberState()}catch(C){m.logger.error(`GroupCall ${this.groupCallId} updateMemberState() failed to resend call member state`,C)}}),A*3/4)):yield this.updateDevices(C=>C.filter(O=>O.device_id!==this.client.getDeviceId()),!0)})}cleanMemberState(){return u(this,void 0,void 0,function*(){const{devices:C}=yield this.client.getDevices(),O=new Map(C.map(I=>[I.device_id,I]));yield this.updateDevices(I=>{const D=I.filter(j=>{const Y=O.get(j.device_id);return(Y==null?void 0:Y.last_seen_ts)!==void 0&&!(j.device_id===this.client.getDeviceId()&&this.state!==M.Entered&&!this.enteredViaAnotherSession)});return D.length===I.length?null:D})})}getGroupCallStats(){return this.stats}}e.GroupCall=ee},{"../@types/event":306,"../ReEmitter":317,"../logger":374,"../models/room-state":390,"../models/typed-event-emitter":395,"../utils":416,"./call":418,"./callEventHandler":419,"./callEventTypes":420,"./callFeed":421,"./groupCallEventHandler":423,"./stats/groupCallStats":427,"./stats/statsReport":432}],423:[function(t,E,e){var u=this&&this.__awaiter||function(a,n,i,r){function s(o){return o instanceof i?o:new i(function(l){l(o)})}return new(i||(i=Promise))(function(o,l){function v(_){try{p(r.next(_))}catch(T){l(T)}}function f(_){try{p(r.throw(_))}catch(T){l(T)}}function p(_){_.done?o(_.value):s(_.value).then(v,f)}p((r=r.apply(a,n||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.GroupCallEventHandler=e.GroupCallEventHandlerEvent=void 0;const g=t("../client"),S=t("./groupCall"),y=t("../models/room-state"),c=t("../logger"),m=t("../@types/event"),h=t("../sync");var d;(function(a){a.Incoming="GroupCall.incoming",a.Outgoing="GroupCall.outgoing",a.Ended="GroupCall.ended",a.Participants="GroupCall.participants"})(d=e.GroupCallEventHandlerEvent||(e.GroupCallEventHandlerEvent={}));class b{constructor(n){this.client=n,this.groupCalls=new Map,this.roomDeferreds=new Map,this.onRoomsChanged=i=>{this.createGroupCallForRoom(i)},this.onRoomStateChanged=(i,r)=>{if(i.getType()===m.EventType.GroupCallPrefix){const o=i.getStateKey(),l=i.getContent(),v=this.groupCalls.get(r.roomId);!v&&!l["m.terminated"]&&!i.isRedacted()?this.createGroupCallFromRoomStateEvent(i):v&&v.groupCallId===o?l["m.terminated"]||i.isRedacted()?v.terminate(!1):l["m.type"]!==v.type&&c.logger.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=${r.roomId})`):v&&v.groupCallId!==o&&c.logger.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=${r.roomId})`)}}}start(){return u(this,void 0,void 0,function*(){this.client.getSyncState()!==h.SyncState.Syncing&&(c.logger.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(i=>{const r=()=>{if(this.client.getSyncState()===h.SyncState.Syncing)return this.client.off(g.ClientEvent.Sync,r),i()};this.client.on(g.ClientEvent.Sync,r)}));const n=this.client.getRooms();for(const i of n)this.createGroupCallForRoom(i);this.client.on(g.ClientEvent.Room,this.onRoomsChanged),this.client.on(y.RoomStateEvent.Events,this.onRoomStateChanged)})}stop(){this.client.removeListener(y.RoomStateEvent.Events,this.onRoomStateChanged)}getRoomDeferred(n){let i=this.roomDeferreds.get(n);if(i===void 0){let r;i={prom:new Promise(s=>{r=s})},i.resolve=r,this.roomDeferreds.set(n,i)}return i}waitUntilRoomReadyForGroupCalls(n){return this.getRoomDeferred(n).prom}getGroupCallById(n){return[...this.groupCalls.values()].find(i=>i.groupCallId===n)}createGroupCallForRoom(n){const i=n.currentState.getStateEvents(m.EventType.GroupCallPrefix),r=i.sort((s,o)=>o.getTs()-s.getTs());for(const s of r)if(!(s.getContent()["m.terminated"]||s.isRedacted())){c.logger.debug(`GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=${s.getStateKey()}, ts=${s.getTs()}, roomId=${n.roomId}, numOfPossibleCalls=${i.length})`),this.createGroupCallFromRoomStateEvent(s);break}c.logger.info(`GroupCallEventHandler createGroupCallForRoom() processed room (roomId=${n.roomId})`),this.getRoomDeferred(n.roomId).resolve()}createGroupCallFromRoomStateEvent(n){const i=n.getRoomId(),r=n.getContent(),s=this.client.getRoom(i);if(!s){c.logger.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=${i})`);return}const o=n.getStateKey(),l=r["m.type"];if(!Object.values(S.GroupCallType).includes(l)){c.logger.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=${l}, roomId=${i})`);return}const v=r["m.intent"];if(!Object.values(S.GroupCallIntent).includes(v)){c.logger.warn(`Received invalid group call intent (type=${l}, roomId=${i})`);return}const f=!!r["io.element.ptt"];let p;if(r!=null&&r.dataChannelsEnabled&&(r!=null&&r.dataChannelOptions)){const{ordered:T,maxPacketLifeTime:w,maxRetransmits:M,protocol:A}=r.dataChannelOptions;p={ordered:T,maxPacketLifeTime:w,maxRetransmits:M,protocol:A}}const _=new S.GroupCall(this.client,s,l,f,v,o,(r==null?void 0:r.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,p,this.client.isVoipWithNoMediaAllowed);return this.groupCalls.set(s.roomId,_),this.client.emit(d.Incoming,_),_}}e.GroupCallEventHandler=b},{"../@types/event":306,"../client":321,"../logger":374,"../models/room-state":390,"../sync":414,"./groupCall":422}],424:[function(t,E,e){var u=this&&this.__awaiter||function(h,d,b,a){function n(i){return i instanceof b?i:new b(function(r){r(i)})}return new(b||(b=Promise))(function(i,r){function s(v){try{l(a.next(v))}catch(f){r(f)}}function o(v){try{l(a.throw(v))}catch(f){r(f)}}function l(v){v.done?i(v.value):n(v.value).then(s,o)}l((a=a.apply(h,d||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.MediaHandler=e.MediaHandlerEvent=void 0;const g=t("../models/typed-event-emitter"),S=t("../webrtc/groupCall"),y=t("../logger");var c;(function(h){h.LocalStreamsChanged="local_streams_changed"})(c=e.MediaHandlerEvent||(e.MediaHandlerEvent={}));class m extends g.TypedEventEmitter{constructor(d){super(),this.client=d,this.userMediaStreams=[],this.screensharingStreams=[]}restoreMediaSettings(d,b){this.audioInput=d,this.videoInput=b}setAudioInput(d){return u(this,void 0,void 0,function*(){y.logger.info(`MediaHandler setAudioInput() running (deviceId=${d})`),this.audioInput!==d&&(this.audioInput=d,yield this.updateLocalUsermediaStreams())})}setAudioSettings(d){return u(this,void 0,void 0,function*(){y.logger.info(`MediaHandler setAudioSettings() running (opts=${JSON.stringify(d)})`),this.audioSettings=Object.assign({},d),yield this.updateLocalUsermediaStreams()})}setVideoInput(d){return u(this,void 0,void 0,function*(){y.logger.info(`MediaHandler setVideoInput() running (deviceId=${d})`),this.videoInput!==d&&(this.videoInput=d,yield this.updateLocalUsermediaStreams())})}setMediaInputs(d,b){return u(this,void 0,void 0,function*(){y.logger.log(`MediaHandler setMediaInputs() running (audioInput: ${d} videoInput: ${b})`),this.audioInput=d,this.videoInput=b,yield this.updateLocalUsermediaStreams()})}updateLocalUsermediaStreams(){return u(this,void 0,void 0,function*(){if(this.userMediaStreams.length===0)return;const d=new Map;for(const b of this.client.callEventHandler.calls.values())d.set(b.callId,{audio:b.hasLocalUserMediaAudioTrack,video:b.hasLocalUserMediaVideoTrack});for(const b of this.userMediaStreams){y.logger.log(`MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=${b.id})`);for(const a of b.getTracks())a.stop()}this.userMediaStreams=[],this.localUserMediaStream=void 0;for(const b of this.client.callEventHandler.calls.values()){if(b.callHasEnded()||!d.has(b.callId))continue;const{audio:a,video:n}=d.get(b.callId);y.logger.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=${b.callId})`);const i=yield this.getUserMediaStream(a,n);b.callHasEnded()||(yield b.updateLocalUsermediaStream(i))}for(const b of this.client.groupCallEventHandler.groupCalls.values()){if(!b.localCallFeed)continue;y.logger.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=${b.groupCallId})`);const a=yield this.getUserMediaStream(!0,b.type===S.GroupCallType.Video);b.state!==S.GroupCallState.Ended&&(yield b.updateLocalUsermediaStream(a))}this.emit(c.LocalStreamsChanged)})}hasAudioDevice(){return u(this,void 0,void 0,function*(){try{return(yield navigator.mediaDevices.enumerateDevices()).filter(b=>b.kind==="audioinput").length>0}catch(d){return y.logger.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",d),!1}})}hasVideoDevice(){return u(this,void 0,void 0,function*(){try{return(yield navigator.mediaDevices.enumerateDevices()).filter(b=>b.kind==="videoinput").length>0}catch(d){return y.logger.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",d),!1}})}getUserMediaStream(d,b,a=!0){return u(this,void 0,void 0,function*(){return this.getMediaStreamPromise?this.getMediaStreamPromise=this.getMediaStreamPromise.then(()=>this.getUserMediaStreamInternal(d,b,a)):this.getMediaStreamPromise=this.getUserMediaStreamInternal(d,b,a),this.getMediaStreamPromise})}getUserMediaStreamInternal(d,b,a){var n,i,r,s,o;return u(this,void 0,void 0,function*(){const l=d&&(yield this.hasAudioDevice()),v=b&&(yield this.hasVideoDevice());let f,p=!0;if(this.localUserMediaStream?(l!==this.localUserMediaStream.getAudioTracks().length>0&&(p=!1),v!==this.localUserMediaStream.getVideoTracks().length>0&&(p=!1),l&&((i=(n=this.localUserMediaStream.getAudioTracks()[0])===null||n===void 0?void 0:n.getSettings())===null||i===void 0?void 0:i.deviceId)!==this.audioInput&&(p=!1),v&&((s=(r=this.localUserMediaStream.getVideoTracks()[0])===null||r===void 0?void 0:r.getSettings())===null||s===void 0?void 0:s.deviceId)!==this.videoInput&&(p=!1)):p=!1,p){if(f=this.localUserMediaStream.clone(),y.logger.log(`MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=${(o=this.localUserMediaStream)===null||o===void 0?void 0:o.id} newStreamId=${f.id} shouldRequestAudio=${l} shouldRequestVideo=${v})`),!l)for(const _ of f.getAudioTracks())f.removeTrack(_);if(!v)for(const _ of f.getVideoTracks())f.removeTrack(_)}else{const _=this.getUserMediaContraints(l,v);f=yield navigator.mediaDevices.getUserMedia(_),y.logger.log(`MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=${f.id}, shouldRequestAudio=${l}, shouldRequestVideo=${v}, constraints=${JSON.stringify(_)})`);for(const T of f.getTracks()){const w=T.getSettings();T.kind==="audio"?this.audioInput=w.deviceId:T.kind==="video"&&(this.videoInput=w.deviceId)}a&&(this.localUserMediaStream=f)}return a&&this.userMediaStreams.push(f),this.emit(c.LocalStreamsChanged),f})}stopUserMediaStream(d){y.logger.log(`MediaHandler stopUserMediaStream() stopping (streamId=${d.id})`);for(const a of d.getTracks())a.stop();const b=this.userMediaStreams.indexOf(d);b!==-1&&(y.logger.debug(`MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=${d.id})`,d.id),this.userMediaStreams.splice(b,1)),this.emit(c.LocalStreamsChanged),this.localUserMediaStream===d&&(this.localUserMediaStream=void 0)}getScreensharingStream(d={},b=!0){return u(this,void 0,void 0,function*(){let a;if(this.screensharingStreams.length===0){const n=this.getScreenshareContraints(d);d.desktopCapturerSourceId?(y.logger.debug(`MediaHandler getScreensharingStream() calling getUserMedia() (opts=${JSON.stringify(d)})`),a=yield navigator.mediaDevices.getUserMedia(n)):(y.logger.debug(`MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=${JSON.stringify(d)})`),a=yield navigator.mediaDevices.getDisplayMedia(n))}else{const n=this.screensharingStreams[this.screensharingStreams.length-1];y.logger.log(`MediaHandler getScreensharingStream() cloning (streamId=${n.id})`),a=n.clone()}return b&&this.screensharingStreams.push(a),this.emit(c.LocalStreamsChanged),a})}stopScreensharingStream(d){y.logger.debug(`MediaHandler stopScreensharingStream() stopping stream (streamId=${d.id})`);for(const a of d.getTracks())a.stop();const b=this.screensharingStreams.indexOf(d);b!==-1&&(y.logger.debug(`MediaHandler stopScreensharingStream() splicing stream out (streamId=${d.id})`),this.screensharingStreams.splice(b,1)),this.emit(c.LocalStreamsChanged)}stopAllStreams(){for(const d of this.userMediaStreams){y.logger.log(`MediaHandler stopAllStreams() stopping (streamId=${d.id})`);for(const b of d.getTracks())b.stop()}for(const d of this.screensharingStreams)for(const b of d.getTracks())b.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(c.LocalStreamsChanged)}getUserMediaContraints(d,b){const a=!!navigator.webkitGetUserMedia;return{audio:d?{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0}:!1,video:b?{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:a?{exact:640}:{ideal:640},height:a?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(d){const{desktopCapturerSourceId:b,audio:a}=d;return b?{audio:a??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:b}}}:{audio:a??!1,video:!0}}}e.MediaHandler=m},{"../logger":374,"../models/typed-event-emitter":395,"../webrtc/groupCall":422}],425:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ConnectionStats=void 0;class u{constructor(){this.bandwidth={},this.bitrate={},this.packetLoss={},this.transport=[]}}e.ConnectionStats=u},{}],426:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ConnectionStatsReporter=void 0;class u{static buildBandwidthReport(S){const y=S.availableIncomingBitrate,c=S.availableOutgoingBitrate;return{download:y?Math.round(y/1e3):0,upload:c?Math.round(c/1e3):0}}}e.ConnectionStatsReporter=u},{}],427:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.GroupCallStats=void 0;const u=t("./statsReportGatherer"),g=t("./statsReportEmitter");class S{constructor(c,m,h=1e4){this.groupCallId=c,this.userId=m,this.interval=h,this.gatherers=new Map,this.reports=new g.StatsReportEmitter}start(){this.timer===void 0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(c=>c.stopProcessingStats()))}hasStatsReportGatherer(c){return this.gatherers.has(c)}addStatsReportGatherer(c,m,h){return this.hasStatsReportGatherer(c)?!1:(this.gatherers.set(c,new u.StatsReportGatherer(c,m,h,this.reports)),!0)}removeStatsReportGatherer(c){return this.gatherers.delete(c)}getStatsReportGatherer(c){return this.hasStatsReportGatherer(c)?this.gatherers.get(c):void 0}processStats(){this.gatherers.forEach(c=>c.processStats(this.groupCallId,this.userId))}}e.GroupCallStats=S},{"./statsReportEmitter":434,"./statsReportGatherer":435}],428:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.MediaSsrcHandler=void 0;const u=t("sdp-transform");class g{constructor(){this.ssrcToMid={local:new Map,remote:new Map}}findMidBySsrc(y,c){let m;return this.ssrcToMid[c].forEach((h,d)=>{if(h.find(b=>b==y)){m=d;return}}),m}parse(y,c){const m=(0,u.parse)(y),h=new Map;m.media.forEach(d=>{var b;if(d.mid&&d.type==="video"||d.type==="audio"){const a=[];(b=d.ssrcs)===null||b===void 0||b.forEach(n=>{n.attribute==="cname"&&a.push(`${n.id}`)}),h.set(`${d.mid}`,a)}}),this.ssrcToMid[c]=h}getSsrcToMidMap(y){return this.ssrcToMid[y]}}e.MediaSsrcHandler=g},{"sdp-transform":253}],429:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.MediaTrackHandler=void 0;class u{constructor(S){this.pc=S}getLocalTracks(S){const y=c=>c!==null&&c.kind===S;return this.pc.getTransceivers().filter(c=>c.currentDirection==="sendonly"||c.currentDirection==="sendrecv").filter(c=>c.sender!==null).map(c=>c.sender).map(c=>c.track).filter(y)}getTackById(S){return this.pc.getTransceivers().map(y=>{if((y==null?void 0:y.sender.track)!==null&&y.sender.track.id===S)return y.sender.track;if((y==null?void 0:y.receiver.track)!==null&&y.receiver.track.id===S)return y.receiver.track}).find(y=>y!==void 0)}getLocalTrackIdByMid(S){const y=this.pc.getTransceivers().find(c=>c.mid===S);if(y!==void 0&&y.sender&&y.sender.track)return y.sender.track.id}getRemoteTrackIdByMid(S){const y=this.pc.getTransceivers().find(c=>c.mid===S);if(y!==void 0&&y.receiver&&y.receiver.track)return y.receiver.track.id}getActiveSimulcastStreams(){return 3}}e.MediaTrackHandler=u},{}],430:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.MediaTrackStats=void 0;class u{constructor(S,y,c){this.trackId=S,this.type=y,this.kind=c,this.loss={packetsTotal:0,packetsLost:0,isDownloadStream:!1},this.bitrate={download:0,upload:0},this.resolution={width:-1,height:-1},this.framerate=0,this.codec=""}getType(){return this.type}setLoss(S){this.loss=S}getLoss(){return this.loss}setResolution(S){this.resolution=S}getResolution(){return this.resolution}setFramerate(S){this.framerate=S}getFramerate(){return this.framerate}setBitrate(S){this.bitrate=S}getBitrate(){return this.bitrate}setCodec(S){return this.codec=S,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}}e.MediaTrackStats=u},{}],431:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.MediaTrackStatsHandler=void 0;const u=t("./mediaTrackStats");class g{constructor(y,c){this.mediaSsrcHandler=y,this.mediaTrackHandler=c,this.track2stats=new Map}findTrack2Stats(y,c){let m;if(y.trackIdentifier)m=y.trackIdentifier;else if(y.mid)m=c==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(y.mid):this.mediaTrackHandler.getLocalTrackIdByMid(y.mid);else if(y.ssrc){if(!this.mediaSsrcHandler.findMidBySsrc(y.ssrc,c))return;m=c==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(y.mid):this.mediaTrackHandler.getLocalTrackIdByMid(y.mid)}if(!m)return;let h=this.track2stats.get(m);if(!h){const d=this.mediaTrackHandler.getTackById(m);if(d!==void 0){const b=d.kind==="audio"?d.kind:"video";h=new u.MediaTrackStats(m,c,b),this.track2stats.set(m,h)}else return}return h}findLocalVideoTrackStats(y){if(this.mediaTrackHandler.getLocalTracks("video").length!==0)return this.findTrack2Stats(y,"local")}getTrack2stats(){return this.track2stats}}e.MediaTrackStatsHandler=g},{"./mediaTrackStats":430}],432:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.StatsReport=void 0,function(u){u.CONNECTION_STATS="StatsReport.connection_stats",u.BYTE_SENT_STATS="StatsReport.byte_sent_stats"}(e.StatsReport||(e.StatsReport={}))},{}],433:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.StatsReportBuilder=void 0;class u{static build(S){const y={},c={download:0,upload:0},m={download:0,upload:0};let h=0,d=0;const b={local:new Map,remote:new Map},a={local:new Map,remote:new Map},n={local:new Map,remote:new Map};let i=0,r=0,s=0,o=0;for(const[l,v]of S){const f=v.getLoss(),p=f.isDownloadStream?"download":"upload";c[p]+=f.packetsTotal,m[p]+=f.packetsLost,h+=v.getBitrate().download,d+=v.getBitrate().upload,v.kind==="audio"?(i+=v.getBitrate().download,r+=v.getBitrate().upload):(s+=v.getBitrate().download,o+=v.getBitrate().upload),b[v.getType()].set(l,v.getResolution()),a[v.getType()].set(l,v.getFramerate()),n[v.getType()].set(l,v.getCodec()),v.resetBitrate()}return y.bitrate={upload:d,download:h},y.bitrate.audio={upload:r,download:i},y.bitrate.video={upload:o,download:s},y.packetLoss={total:u.calculatePacketLoss(m.download+m.upload,c.download+c.upload),download:u.calculatePacketLoss(m.download,c.download),upload:u.calculatePacketLoss(m.upload,c.upload)},y.framerate=a,y.resolution=b,y.codec=n,y}static calculatePacketLoss(S,y){return!y||y<=0||!S||S<=0?0:Math.round(S/y*100)}}e.StatsReportBuilder=u},{}],434:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.StatsReportEmitter=void 0;const u=t("../../models/typed-event-emitter"),g=t("./statsReport");class S extends u.TypedEventEmitter{emitByteSendReport(c){this.emit(g.StatsReport.BYTE_SENT_STATS,c)}emitConnectionStatsReport(c){this.emit(g.StatsReport.CONNECTION_STATS,c)}}e.StatsReportEmitter=S},{"../../models/typed-event-emitter":395,"./statsReport":432}],435:[function(t,E,e){var u=this&&this.__awaiter||function(i,r,s,o){function l(v){return v instanceof s?v:new s(function(f){f(v)})}return new(s||(s=Promise))(function(v,f){function p(w){try{T(o.next(w))}catch(M){f(M)}}function _(w){try{T(o.throw(w))}catch(M){f(M)}}function T(w){w.done?v(w.value):l(w.value).then(p,_)}T((o=o.apply(i,r||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.StatsReportGatherer=void 0;const g=t("./connectionStats"),S=t("./connectionStatsReporter"),y=t("./transportStatsReporter"),c=t("./media/mediaSsrcHandler"),m=t("./media/mediaTrackHandler"),h=t("./media/mediaTrackStatsHandler"),d=t("./trackStatsReporter"),b=t("./statsReportBuilder"),a=t("./statsValueFormatter");class n{constructor(r,s,o,l,v=!0){this.callId=r,this.remoteUserId=s,this.pc=o,this.emitter=l,this.isFocus=v,this.isActive=!0,this.connectionStats=new g.ConnectionStats,o.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new h.MediaTrackStatsHandler(new c.MediaSsrcHandler,new m.MediaTrackHandler(o))}processStats(r,s){return u(this,void 0,void 0,function*(){if(this.isActive){const o=this.pc.getStats();if(typeof(o==null?void 0:o.then)=="function")return o.then(l=>{this.currentStatsReport=typeof(l==null?void 0:l.result)=="function"?l.result():l;try{this.processStatsReport(r,s)}catch{return this.isActive=!1,!1}return this.previousStatsReport=this.currentStatsReport,!0}).catch(l=>(this.handleError(l),!1));this.isActive=!1}return Promise.resolve(!1)})}processStatsReport(r,s){var o;const l=new Map;(o=this.currentStatsReport)===null||o===void 0||o.forEach(v=>{const f=this.previousStatsReport?this.previousStatsReport.get(v.id):null;if(v.type==="candidate-pair"&&v.nominated&&v.state==="succeeded")this.connectionStats.bandwidth=S.ConnectionStatsReporter.buildBandwidthReport(v),this.connectionStats.transport=y.TransportStatsReporter.buildReport(this.currentStatsReport,v,this.connectionStats.transport,this.isFocus);else if(v.type==="inbound-rtp"||v.type==="outbound-rtp"){const p=this.trackStats.findTrack2Stats(v,v.type==="inbound-rtp"?"remote":"local");if(!p)return;f&&d.TrackStatsReporter.buildPacketsLost(p,v,f),v.type==="inbound-rtp"?(d.TrackStatsReporter.buildFramerateResolution(p,v),f&&d.TrackStatsReporter.buildBitrateReceived(p,v,f)):f&&(l.set(p.trackId,a.StatsValueFormatter.getNonNegativeValue(v.bytesSent)),d.TrackStatsReporter.buildBitrateSend(p,v,f)),d.TrackStatsReporter.buildCodec(this.currentStatsReport,p,v)}else if(v.type==="track"&&v.kind==="video"&&!v.remoteSource){const p=this.trackStats.findLocalVideoTrackStats(v);if(!p)return;d.TrackStatsReporter.buildFramerateResolution(p,v),d.TrackStatsReporter.calculateSimulcastFramerate(p,v,f,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(l),this.processAndEmitReport()}setActive(r){this.isActive=r}getActive(){return this.isActive}handleError(r){this.isActive=!1}processAndEmitReport(){const r=b.StatsReportBuilder.build(this.trackStats.getTrack2stats());this.connectionStats.bandwidth=r.bandwidth,this.connectionStats.bitrate=r.bitrate,this.connectionStats.packetLoss=r.packetLoss,this.emitter.emitConnectionStatsReport(Object.assign(Object.assign({},r),{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}}e.StatsReportGatherer=n},{"./connectionStats":425,"./connectionStatsReporter":426,"./media/mediaSsrcHandler":428,"./media/mediaTrackHandler":429,"./media/mediaTrackStatsHandler":431,"./statsReportBuilder":433,"./statsValueFormatter":436,"./trackStatsReporter":437,"./transportStatsReporter":438}],436:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.StatsValueFormatter=void 0;class u{static getNonNegativeValue(S){let y=S;return typeof y!="number"&&(y=Number(y)),isNaN(y)?0:Math.max(0,y)}}e.StatsValueFormatter=u},{}],437:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.TrackStatsReporter=void 0;const u=t("./statsValueFormatter");class g{static buildFramerateResolution(y,c){const m={height:c.frameHeight,width:c.frameWidth},h=c.framesPerSecond;m.height&&m.width&&y.setResolution(m),y.setFramerate(Math.round(h||0))}static calculateSimulcastFramerate(y,c,m,h){let d=y.getFramerate();if(!d){if(m){const b=c.timestamp-m.timestamp;b>0&&c.framesSent&&(d=(c.framesSent-m.framesSent)/b*1e3)}if(!d)return}d=h?Math.round(d/h):0,y.setFramerate(d)}static buildCodec(y,c,m){const h=y==null?void 0:y.get(m.codecId);if(h){const d=h.mimeType.split("/")[1];d&&c.setCodec(d)}}static buildBitrateReceived(y,c,m){y.setBitrate({download:g.calculateBitrate(c.bytesReceived,m.bytesReceived,c.timestamp,m.timestamp),upload:0})}static buildBitrateSend(y,c,m){y.setBitrate({download:0,upload:this.calculateBitrate(c.bytesSent,m.bytesSent,c.timestamp,m.timestamp)})}static buildPacketsLost(y,c,m){const h=c.type==="outbound-rtp"?"packetsSent":"packetsReceived";let d=c[h];(!d||d<0)&&(d=0);const b=u.StatsValueFormatter.getNonNegativeValue(m[h]),a=Math.max(0,d-b),n=u.StatsValueFormatter.getNonNegativeValue(c.packetsLost),i=u.StatsValueFormatter.getNonNegativeValue(m.packetsLost),r=Math.max(0,n-i);y.setLoss({packetsTotal:a+r,packetsLost:r,isDownloadStream:c.type!=="outbound-rtp"})}static calculateBitrate(y,c,m,h){const d=u.StatsValueFormatter.getNonNegativeValue(y),b=u.StatsValueFormatter.getNonNegativeValue(c),a=Math.max(0,d-b),n=m-h;let i=0;return n>0&&(i=Math.round(a*8/n)),i}}e.TrackStatsReporter=g},{"./statsValueFormatter":436}],438:[function(t,E,e){Object.defineProperty(e,"__esModule",{value:!0}),e.TransportStatsReporter=void 0;class u{static buildReport(S,y,c,m){const h=S==null?void 0:S.get(y.localCandidateId),d=S==null?void 0:S.get(y.remoteCandidateId);if(d&&h){const b=d.ip!==void 0?d.ip:d.address,a=d.port,n=`${b}:${a}`,i=h.ip!==void 0?h.ip:h.address,r=h.port,s=`${i}:${r}`,o=d.protocol;c.some(l=>l.ip===n&&l.type===o&&l.localIp===s)||c.push({ip:n,type:o,localIp:s,isFocus:m,localCandidateType:h.candidateType,remoteCandidateType:d.candidateType,networkType:h.networkType,rtt:y.currentRoundTripTime?y.currentRoundTripTime*1e3:NaN})}return c}}e.TransportStatsReporter=u},{}]},{},[320]);(function(){try{if(typeof document<"u"){var t=document.createElement("style");t.appendChild(document.createTextNode(".div[data-v-9bed9119]{position:relative}.div:hover div[data-v-9bed9119]{display:block}.div-2[data-v-9bed9119]{position:relative;border-radius:.75rem;padding:1rem;width:fit-content;max-width:80%;margin-bottom:1rem;margin-left:auto}.div-3[data-v-9bed9119]{position:absolute;width:max-content;display:none;bottom:0px;border-radius:.25rem;left:0px;transform:translate(-50%) translateY(50%);box-shadow:#0003 0 0 2px;padding:.25rem;z-index:9999}.div-4[data-v-9bed9119]{position:relative;border-radius:.75rem;padding:1rem;width:fit-content;max-width:80%;margin-bottom:1rem;margin-right:auto}.div-5[data-v-9bed9119]{position:absolute;width:max-content;display:none;bottom:0px;right:0px;border-radius:.25rem;transform:translate(50%) translateY(50%);box-shadow:#0003 0 0 2px;padding:.25rem;z-index:9999}.input[data-v-46284fc5]:focus{outline:none}.svg[data-v-46284fc5]{height:1.5rem;width:1.5rkm}")),document.head.appendChild(t)}}catch(E){console.error("vite-plugin-css-injected-by-js",E)}})();const Qn=(t,E)=>{const e=t.__vccOpts||t;for(const[u,g]of E)e[u]=g;return e},Zl={name:"chat-messages",props:["bgColorChat","chat","bgColorMessagePerson","textColorMessagePerson","bgColorMessageTimestamp","textColorMessageTimestamp","bgColorMessageChatbot","textColorMessageChatbot"],data:()=>({chatElementAdded:!1}),updated(){const t=document.getElementById("chat-container");t&&this.chatElementAdded&&(this.scrollToEnd(t),this.chatElementAdded=!1)},watch:{onUpdateHook0:{handler(){document.getElementById("chat-container")&&(this.chatElementAdded=!0)},immediate:!0}},computed:{onUpdateHook0(){return{0:this.chat.length}}},methods:{scrollToEnd:function(t){const E=t.clientHeight,e=t.scrollHeight;t.scrollTop=e-E}}},ed={key:0,class:"div"},td={key:1,class:"div"};function nd(t,E,e,u,g,S){return qe(),Ye("div",{id:"chat-container",style:st({height:"100%",overscrollBehaviorY:"contain",overflowY:"auto",overflowX:"hidden",backgroundColor:e.bgColorChat||"#EAEEF3",padding:"1.5rem"})},[(qe(!0),Ye(gt,null,To(e.chat,(y,c)=>(qe(),Ye("div",{key:c},[y.type=="person"?(qe(),Ye("div",ed,[Le("div",{class:"div-2",style:st({backgroundColor:e.bgColorMessagePerson||"#025CDB",color:e.textColorMessagePerson||"white"})},[y.timestamp?(qe(),Ye("div",{key:0,class:"div-3",style:st({backgroundColor:e.bgColorMessageTimestamp||"white",color:e.textColorMessageTimestamp||"black"})},ut(y.timestamp),5)):_t("",!0),Tn(" "+ut(y.message),1)],4)])):_t("",!0),y.type=="chatbot"?(qe(),Ye("div",td,[Le("div",{class:"div-4",style:st({backgroundColor:e.bgColorMessageChatbot||"white",color:e.textColorMessageChatbot||"black"})},[y.timestamp?(qe(),Ye("div",{key:0,class:"div-5",style:st({backgroundColor:e.bgColorMessageTimestamp||"white",color:e.textColorMessageTimestamp||"black"})},ut(y.timestamp),5)):_t("",!0),Tn(" "+ut(y.message),1)],4)])):_t("",!0)]))),128))],4)}const id=Qn(Zl,[["render",nd],["__scopeId","data-v-9bed9119"]]),rd={name:"chat-input",props:["onSend","inputHeight","bgColorInput","textColorInput","inputPlaceholder"],data:()=>({inputField:""}),methods:{sendMessage(t){t.preventDefault(),this.onSend&&this.onSend(this.inputField),this.inputField=""}}},sd=t=>(uo("data-v-46284fc5"),t=t(),fo(),t),od=["placeholder","value"],ad=["strokeWidth"],cd=sd(()=>Le("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"},null,-1)),ld=[cd];function dd(t,E,e,u,g,S){return qe(),Ye("form",{onSubmit:E[1]||(E[1]=(...y)=>S.sendMessage&&S.sendMessage(...y)),style:st({display:"flex",height:e.inputHeight||"60px",backgroundColor:e.bgColorInput||"white",color:e.textColorInput||"black"})},[Le("input",{class:"input",placeholder:e.inputPlaceholder||"Type your message here",onInput:E[0]||(E[0]=y=>t.inputField=y.target.value),value:t.inputField,style:st({borderWidth:"0px",backgroundColor:e.bgColorInput||"white",color:e.textColorInput||"black",width:"100%",marginLeft:"1rem",fontSize:"1rem"})},null,44,od),Le("button",{style:st({backgroundColor:e.bgColorInput||"white",flexShrink:"0",all:"unset",cursor:"pointer",margin:"auto 1rem"})},[(qe(),Ye("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",class:"svg",strokeWidth:1.5},ld,8,ad))],4)],36)}const ud=Qn(rd,[["render",dd],["__scopeId","data-v-46284fc5"]]),fd={name:"chat-icon"},hd={style:{height:"32px",width:"32px"}},pd=No('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.3259 5.77772L18.4944 6.33329V6.33329L19.3259 5.77772ZM19.3259 16.2223L18.4944 15.6667V15.6667L19.3259 16.2223ZM18.2223 17.3259L17.6667 16.4944H17.6667L18.2223 17.3259ZM14 17.9986L13.9956 16.9986C13.4451 17.001 13 17.4481 13 17.9986H14ZM14 18L14.8944 18.4472C14.9639 18.3084 15 18.1552 15 18H14ZM10 18H9C9 18.1552 9.03615 18.3084 9.10557 18.4472L10 18ZM10 17.9986H11C11 17.4481 10.5549 17.001 10.0044 16.9986L10 17.9986ZM5.77772 17.3259L6.33329 16.4944H6.33329L5.77772 17.3259ZM4.67412 16.2223L5.50559 15.6667L5.50559 15.6667L4.67412 16.2223ZM4.67412 5.77772L5.50559 6.33329L4.67412 5.77772ZM5.77772 4.67412L6.33329 5.50559L5.77772 4.67412ZM18.2223 4.67412L17.6667 5.50559L17.6667 5.50559L18.2223 4.67412ZM21 11C21 9.61635 21.0012 8.50334 20.9106 7.61264C20.8183 6.70523 20.6225 5.91829 20.1573 5.22215L18.4944 6.33329C18.7034 6.64604 18.8446 7.06578 18.9209 7.81505C18.9988 8.58104 19 9.57473 19 11H21ZM20.1573 16.7779C20.6225 16.0817 20.8183 15.2948 20.9106 14.3874C21.0012 13.4967 21 12.3836 21 11H19C19 12.4253 18.9988 13.419 18.9209 14.1849C18.8446 14.9342 18.7034 15.354 18.4944 15.6667L20.1573 16.7779ZM18.7779 18.1573C19.3238 17.7926 19.7926 17.3238 20.1573 16.7779L18.4944 15.6667C18.2755 15.9943 17.9943 16.2755 17.6667 16.4944L18.7779 18.1573ZM14.0044 18.9986C15.0785 18.9939 15.9763 18.9739 16.7267 18.8701C17.4931 18.7642 18.1699 18.5636 18.7779 18.1573L17.6667 16.4944C17.3934 16.6771 17.0378 16.8081 16.4528 16.889C15.8518 16.9721 15.0792 16.9939 13.9956 16.9986L14.0044 18.9986ZM15 18V17.9986H13V18H15ZM13.7889 20.6584L14.8944 18.4472L13.1056 17.5528L12 19.7639L13.7889 20.6584ZM10.2111 20.6584C10.9482 22.1325 13.0518 22.1325 13.7889 20.6584L12 19.7639L12 19.7639L10.2111 20.6584ZM9.10557 18.4472L10.2111 20.6584L12 19.7639L10.8944 17.5528L9.10557 18.4472ZM9 17.9986V18H11V17.9986H9ZM5.22215 18.1573C5.83014 18.5636 6.50685 18.7642 7.2733 18.8701C8.02368 18.9739 8.92154 18.9939 9.99564 18.9986L10.0044 16.9986C8.92075 16.9939 8.14815 16.9721 7.54716 16.889C6.96223 16.8081 6.60665 16.6771 6.33329 16.4944L5.22215 18.1573ZM3.84265 16.7779C4.20744 17.3238 4.6762 17.7926 5.22215 18.1573L6.33329 16.4944C6.00572 16.2755 5.72447 15.9943 5.50559 15.6667L3.84265 16.7779ZM3 11C3 12.3836 2.99879 13.4967 3.0894 14.3874C3.18171 15.2948 3.3775 16.0817 3.84265 16.7779L5.50559 15.6667C5.29662 15.354 5.15535 14.9342 5.07913 14.1849C5.00121 13.419 5 12.4253 5 11H3ZM3.84265 5.22215C3.3775 5.91829 3.18171 6.70523 3.0894 7.61264C2.99879 8.50334 3 9.61635 3 11H5C5 9.57473 5.00121 8.58104 5.07913 7.81505C5.15535 7.06578 5.29662 6.64604 5.50559 6.33329L3.84265 5.22215ZM5.22215 3.84265C4.6762 4.20744 4.20744 4.6762 3.84265 5.22215L5.50559 6.33329C5.72447 6.00572 6.00572 5.72447 6.33329 5.50559L5.22215 3.84265ZM11 3C9.61635 3 8.50334 2.99879 7.61264 3.0894C6.70523 3.18171 5.91829 3.3775 5.22215 3.84265L6.33329 5.50559C6.64604 5.29662 7.06578 5.15535 7.81505 5.07913C8.58104 5.00121 9.57473 5 11 5V3ZM13 3H11V5H13V3ZM18.7779 3.84265C18.0817 3.3775 17.2948 3.18171 16.3874 3.0894C15.4967 2.99879 14.3836 3 13 3V5C14.4253 5 15.419 5.00121 16.1849 5.07913C16.9342 5.15535 17.354 5.29662 17.6667 5.50559L18.7779 3.84265ZM20.1573 5.22215C19.7926 4.6762 19.3238 4.20744 18.7779 3.84265L17.6667 5.50559C17.9943 5.72447 18.2755 6.00572 18.4944 6.33329L20.1573 5.22215Z"></path><circle cx="16" cy="11" r="1" stroke-linecap="round"></circle><circle cx="12" cy="11" r="1" stroke-linecap="round"></circle><circle cx="8" cy="11" r="1" stroke-linecap="round"></circle></svg>',1),gd=[pd];function vd(t,E,e,u,g,S){return qe(),Ye("div",hd,gd)}const Ho=Qn(fd,[["render",vd]]),md={name:"chat-header",components:{ChatIcon:Ho},props:["headerHeight","bgColorHeader","bgColorIcon","fillColorIcon","textColorHeader","offline","colorOffline","colorOnline","closeChat"]},yd={style:{display:"flex"}},bd={key:0},_d={key:1},Sd=Le("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"},null,-1),Ed=[Sd];function wd(t,E,e,u,g,S){const y=Nt("chat-icon");return qe(),Ye("div",{style:st({display:"flex",height:e.headerHeight||"90px",flexShrink:"0",backgroundColor:e.bgColorHeader||"white"})},[Le("div",{style:st({position:"flex",borderRadius:"50%",backgroundColor:e.bgColorIcon||"#025CDB",marginTop:"auto",marginBottom:"auto",marginLeft:"1.25rem",marginRight:"1.25rem",padding:"0.75rem",fill:e.fillColorIcon||"white"})},[ot(y)],4),Le("div",{style:st({marginTop:"auto",marginBottom:"auto",width:"100%",color:e.textColorHeader||"black"})},[Le("div",{style:st({fontWeight:"600",fontSize:"1.10rem",lineHeight:"1.5rem"})}," ChatBot ",4),Le("div",yd,[Le("div",{style:st({borderRadius:"50%",height:"8px",width:"8px",margin:"auto 4px",backgroundColor:e.offline?e.colorOffline||"red":e.colorOnline||"green"})},null,4),e.offline?(qe(),Ye("div",bd,"Offline")):(qe(),Ye("div",_d,"Online"))])],4),(qe(),Ye("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2",onClick:E[0]||(E[0]=c=>e.closeChat()),style:st({height:"1.75rem",width:"1.75rem",flexShrink:"0",margin:"1rem",cursor:"pointer",color:e.textColorHeader||"black"})},Ed,4))],4)}const Td=Qn(md,[["render",wd]]),Rd={name:"chat",components:{ChatIcon:Ho,ChatHeader:Td,ChatMessages:id,ChatInput:ud},props:["bgColorIcon","margin","fillColorIcon","width","height","boxShadow","headerHeight","bgColorHeader","textColorHeader","offline","colorOffline","colorOnline","bgColorChat","bgColorMessageChatbot","bgColorMessagePerson","bgColorMessageTimestamp","textColorMessageChatbot","textColorMessagePerson","textColorMessageTimestamp","chat","onSend","inputHeight","bgColorInput","textColorInput","inputPlaceholder"],data:()=>({chatOpen:!1}),methods:{stateCloseChat(){this.chatOpen=!1},stateOpenChat(){this.chatOpen=!0}}},Id={style:{display:"flex",flexDirection:"column",height:"100%"}};function Cd(t,E,e,u,g,S){const y=Nt("chat-icon"),c=Nt("chat-header"),m=Nt("chat-messages"),h=Nt("chat-input");return qe(),Ye("div",null,[Le("div",{onClick:E[0]||(E[0]=d=>S.stateOpenChat()),style:st({position:"fixed",bottom:"0px",right:"0px",overflow:"hidden",transform:t.chatOpen?"translateY(100%)":"translateY(0%)",transitionTimingFunction:"cubic-bezier(0.4, 0, 0.2, 1)",transitionDuration:"300ms",transitionDelay:t.chatOpen?"0ms":"300ms"})},[Le("div",{style:st({position:"flex",borderRadius:"50%",cursor:"pointer",backgroundColor:e.bgColorIcon||"#025CDB",margin:e.margin||"20px",padding:"0.75rem",fill:e.fillColorIcon||"white"})},[ot(y)],4)],4),Le("div",{style:st({position:"fixed",bottom:"0px",right:"0px",maxHeight:"100%",maxWidth:"100%",width:e.width||"410px",height:e.height||"700px",overflow:"hidden",transform:t.chatOpen?"translateY(0%)":"translateY(100%)",transitionTimingFunction:"cubic-bezier(0.4, 0, 0.2, 1)",transitionDuration:"300ms",transitionDelay:t.chatOpen?"300ms":"0ms"})},[Le("div",{style:st({margin:e.margin||"20px",overflow:"hidden",borderRadius:"0.75rem",boxShadow:e.boxShadow||"rgba(0,0,0,0.4) 0 0 6px",maxHeight:e.margin?"calc(100% - "+e.margin+" - "+e.margin+")":"calc(100% - 40px)",maxWidth:e.margin?"calc(100% - "+e.margin+" - "+e.margin+")":"calc(100% - 40px)",width:e.width&&e.margin?"calc("+e.width+" - "+e.margin+" - "+e.margin+")":e.width?"calc("+e.width+" - 40px)":e.margin?"calc(410px - "+e.margin+" - "+e.margin+")":"calc(410px - 40px)",height:e.height&&e.margin?"calc("+e.height+" - "+e.margin+" - "+e.margin+")":e.height?"calc("+e.height+" - 40px)":e.margin?"calc(700px - "+e.margin+" - "+e.margin+")":"calc(700px - 40px)"})},[Le("div",Id,[ot(c,{closeChat:S.stateCloseChat,headerHeight:e.headerHeight,bgColorHeader:e.bgColorHeader,bgColorIcon:e.bgColorIcon,textColorHeader:e.textColorHeader,fillColorIcon:e.fillColorIcon,offline:e.offline,colorOffline:e.colorOffline,colorOnline:e.colorOnline},null,8,["closeChat","headerHeight","bgColorHeader","bgColorIcon","textColorHeader","fillColorIcon","offline","colorOffline","colorOnline"]),ot(m,{bgColorChat:e.bgColorChat,bgColorMessageChatbot:e.bgColorMessageChatbot,bgColorMessagePerson:e.bgColorMessagePerson,bgColorMessageTimestamp:e.bgColorMessageTimestamp,textColorMessageChatbot:e.textColorMessageChatbot,textColorMessagePerson:e.textColorMessagePerson,textColorMessageTimestamp:e.textColorMessageTimestamp,chat:e.chat},null,8,["bgColorChat","bgColorMessageChatbot","bgColorMessagePerson","bgColorMessageTimestamp","textColorMessageChatbot","textColorMessagePerson","textColorMessageTimestamp","chat"]),ot(h,{onSend:e.onSend,inputHeight:e.inputHeight,bgColorInput:e.bgColorInput,textColorInput:e.textColorInput,inputPlaceholder:e.inputPlaceholder},null,8,["onSend","inputHeight","bgColorInput","textColorInput","inputPlaceholder"])])],4)],4)])}const Md=Qn(Rd,[["render",Cd]]);const In=(t,E)=>{const e=t.__vccOpts||t;for(const[u,g]of E)e[u]=g;return e},Ad={components:{Chat:Md},data(){return{teste:"123",dialogo:[{message:"Hi! How are you?",type:"chatbot",timestamp:"3:45 PM"},{message:"Hello, i'm fine, thanks.",type:"person",timestamp:"3:46 PM"},{message:"How can i help you?",type:"chatbot",timestamp:"3:47 PM"}],darkTheme:tc(!0)}},methods:{receberMensagem(t){const E={type:"chatbot",timestamp:this.formatAMPM(new Date),message:t};this.dialogo.push(E)},handleSendEvent(t){if(t=="")return;const E={type:"person",timestamp:this.formatAMPM(new Date),message:t};this.dialogo.push(E);try{window.chatConvidado.enviarMensagemTexto(E.message)}catch(e){console.log(e);const u={type:"chatbot",timestamp:this.formatAMPM(new Date),message:"Falha enviando mensagem "};this.dialogo.push(u)}},getRandomNumber(){return Math.floor(Math.random()*(2e3-1e3+1))+1e3},formatAMPM(t){var E=t.getHours(),e=t.getMinutes(),u=E>=12?"PM":"AM";E=E%12,E=E||12;var g=E+":"+e+" "+u;return g}}},Od=Le("div",{style:{width:"100%"}}," TESTE ",-1);function kd(t,E,e,u,g,S){const y=Nt("Chat");return qe(),Ye(gt,null,[Od,Le("div",{style:st([{width:"100vw",height:"100vh"},g.darkTheme&&"backgroundColor: #2C2D2E"])},null,4),Le("div",{style:st([{position:"fixed",top:"0px",right:"0px",margin:"20px"},g.darkTheme&&"color: #fff"]),onClick:E[0]||(E[0]=c=>g.darkTheme=!g.darkTheme)},ut(g.darkTheme?"Light":"Dark")+" Style "+ut(g.teste),5),Tn(" [ "),ot(y,{onSend:S.handleSendEvent,chat:g.dialogo,bgColorHeader:g.darkTheme&&"#1e1e1e",bgColorChat:g.darkTheme&&"#2C2D2E",bgColorInput:g.darkTheme&&"#1e1e1e",bgColorIcon:g.darkTheme&&"#9B51E0",bgColorMessageChatbot:g.darkTheme&&"#1e1e1e",bgColorMessagePerson:g.darkTheme&&"#9B51E0",bgColorMessageTimestamp:g.darkTheme&&"#1e1e1e",textColorInput:g.darkTheme&&"#fff",textColorHeader:g.darkTheme&&"#fff",textColorMessageChatbot:g.darkTheme&&"#fff",textColorMessageTimestamp:g.darkTheme&&"#fff"},null,8,["onSend","chat","bgColorHeader","bgColorChat","bgColorInput","bgColorIcon","bgColorMessageChatbot","bgColorMessagePerson","bgColorMessageTimestamp","textColorInput","textColorHeader","textColorMessageChatbot","textColorMessageTimestamp"]),Tn("] ")],64)}const Pd=In(Ad,[["render",kd]]);const Dd={props:{msg:Object}},xd={class:"card__footer font-light justify-end flex items-center"},Ld={class:"text-xs"},Nd={key:0,class:"material-icons ml-1 text-base",style:{color:"#23b6f2"}};function Bd(t,E,e,u,g,S){return qe(),Ye("div",{class:$n(["card relative px-2 p-1 rounded-b text-left m-2",[e.msg.mine?"mine self-end":"self-start"]])},[Le("header",{class:$n(["font-medium card__header",[e.msg.mine?"text-green-600":"text-orange-600"]])},ut(e.msg.name),3),Le("article",null,ut(e.msg.text),1),Le("footer",xd,[Le("span",Ld,ut(new Date(e.msg.timeStamp).toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0})),1),e.msg.mine?(qe(),Ye("span",Nd,"done_all")):_t("",!0)])],2)}const Ud=In(Dd,[["render",Bd],["__scopeId","data-v-72246f81"]]);const Fd={name:"MessageForm",data(){return{dirty:!1}},methods:{submit(){let t=document.querySelector(".chat__msg");t.value&&(window.navigator.vibrate(30),this.$socket.emit("chat-message",{msg:t.value,room:this.$route.params.name,user:sessionStorage.getItem("user-name")}),this.$emit("ping",t.value),t.value="",this.autoResize({target:t}),this.dirty=!1)},autoResize(t){this.dirty=!0,t.target.style.height="auto",t.target.style.height=t.target.scrollHeight+"px",t.target.value===""&&(this.dirty=!1)}}},$o=t=>(uo("data-v-424865f2"),t=t(),fo(),t),jd={class:"chat flex items-center relative my-1 mb-2"},Kd=$o(()=>Le("span",{class:"material-icons absolute chat__smiley self-end"},"tag_faces",-1)),Hd={class:"chat__options absolute inline-flex self-end"},$d=$o(()=>Le("span",{class:"material-icons chat__attach mr-4"},"attach_file",-1)),Vd={key:0,class:"material-icons chat__cam mr-2"},Wd={key:0,class:"material-icons text-white"},Gd={key:1,class:"material-icons text-white"};function qd(t,E,e,u,g,S){return qe(),Ye("form",jd,[Kd,Le("textarea",{class:"chat__msg rounded-full tracking-wide px-10 p-2 ml-1 w-full resize-none",rows:"1",placeholder:"Type a message",onKeypress:E[0]||(E[0]=jo(Ts((...y)=>S.submit&&S.submit(...y),["exact","prevent"]),["enter"])),onInput:E[1]||(E[1]=(...y)=>S.autoResize&&S.autoResize(...y))},null,32),Le("div",Hd,[$d,ot(Ur,{name:"slide-fade"},{default:ho(()=>[g.dirty?_t("",!0):(qe(),Ye("span",Vd,"camera_alt"))]),_:1})]),Le("button",{type:"submit",onClick:E[2]||(E[2]=Ts((...y)=>S.submit&&S.submit(...y),["prevent"])),class:"send rounded-full flex mx-1 p-2"},[g.dirty?_t("",!0):(qe(),Ye("span",Wd,"mic")),g.dirty?(qe(),Ye("span",Gd,"send")):_t("",!0)])])}const zd=In(Fd,[["render",qd],["__scopeId","data-v-424865f2"]]),Yd={props:["msg"]},Jd={class:"bg-blue-200 font-hairline p-1 rounded text-gray-900 self-center m-2",style:{width:"max-content"}};function Qd(t,E,e,u,g,S){return qe(),Ye("div",Jd,ut(e.msg.text),1)}const Xd=In(Yd,[["render",Qd]]),Zd="/cndChatPrivadoLead2.css",eu={},tu={class:"rounded-full w-10 h-10 flex items-center justify-center overflow-hidden"},nu=Le("img",{src:Zd,alt:"kickbuttowski",class:"h-full w-full object-contain"},null,-1),iu=[nu];function ru(t,E,e,u,g,S){return qe(),Ye("div",tu,iu)}const su=In(eu,[["render",ru]]);const ou={components:{messageCard:Ud,messageForm:zd,Avatar:su,notificationCard:Xd},props:["atendenteNome","atendenteAvatar","atendenteEmail","conversa"],data(){return{novaMensagem:"",roomName:"Sala Vendas",users:[],isOption:!1}},mounted(){},methods:{component(t){return t?"messageCard":"notificationCard"},leaveRoom(){this.$socket.emit("leave-group",this.roomName)},enviarMensagem(){this.novaMensagem&&(this.$parent.registrarNovaMensagem(this.novaMensagem),this.novaMensagem="")},appendMsg(t){this.messages.push({id:Math.random(),text:t,timeStamp:new Date,name:"You",mine:!0,isMsg:!0});let E=document.querySelector(".container__messages");setTimeout(()=>{E.scrollTop=E.scrollHeight},0),this.scrollToLatest()},scrollToLatest(){let t=document.querySelector(".container__messages");setTimeout(()=>{t.scrollTop=t.scrollHeight},0)},optionsClose(){this.isOption=!1}}},au=Le("link",{href:"https://fonts.googleapis.com/css?family=Open+Sans:400,600,700",rel:"stylesheet",type:"text/css"},null,-1),cu={id:"chatbox"},lu=No('<div id="friendslist" style="display:none;"><div id="topmenu"><span class="friends"></span><span class="chats"></span><span class="history"></span></div></div>',1),du={id:"chatview",class:"p1",style:{display:"block"}},uu={id:"profile",class:"animate"},fu={class:"animate"},hu={style:{"font-weight":"bolder"}},pu={id:"chat-messages",class:"animate"},gu={key:0,class:"message right"},vu=["src"],mu={class:"bubble"},yu=Le("div",{class:"corner"},null,-1),bu={key:1,class:"message"},_u=["src"],Su={class:"bubble"},Eu=Le("div",{class:"corner"},null,-1),wu={id:"sendmessage"},Tu=["src"];function Ru(t,E,e,u,g,S){return qe(),Ye(gt,null,[au,Le("div",cu,[lu,Le("div",du,[Le("div",uu,[Le("p",fu,ut(e.atendenteNome),1),Le("span",hu,ut(e.atendenteEmail),1)]),Le("div",pu,[(qe(!0),Ye(gt,null,To(e.conversa,y=>(qe(),Ye("div",null,[y.tipoAtendimento?(qe(),Ye("div",gu,[Le("img",{src:y.avatar},null,8,vu),Le("div",mu,[Tn(ut(y.mensagem)+" ",1),yu,Le("span",null,ut(y.dataHora.toLocaleTimeString()),1)])])):_t("",!0),y.tipoAtendimento?_t("",!0):(qe(),Ye("div",bu,[Le("img",{src:y.avatar},null,8,_u),Le("div",Su,[Tn(ut(y.mensagem)+" ",1),Eu,Le("span",null,ut(y.dataHora.toLocaleTimeString()),1)])]))]))),256))]),Le("div",wu,[Lc(Le("input",{"onUpdate:modelValue":E[0]||(E[0]=y=>g.novaMensagem=y),placeholder:"Envie sua mensagem",onKeyup:E[1]||(E[1]=jo((...y)=>S.enviarMensagem&&S.enviarMensagem(...y),["enter"]))},null,544),[[Hl,g.novaMensagem]]),Le("button",{id:"send",onClick:E[2]||(E[2]=(...y)=>S.enviarMensagem&&S.enviarMensagem(...y))})])]),Le("img",{src:e.atendenteAvatar,class:"floatingImg",style:{top:"20px",width:"68px",left:"108px"}},null,8,Tu)])],64)}const Iu=In(ou,[["render",Ru]]);function Vo(t,E){return function(){return t.apply(E,arguments)}}const{toString:Cu}=Object.prototype,{getPrototypeOf:Fr}=Object,xi=(t=>E=>{const e=Cu.call(E);return t[e]||(t[e]=e.slice(8,-1).toLowerCase())})(Object.create(null)),xt=t=>(t=t.toLowerCase(),E=>xi(E)===t),Li=t=>E=>typeof E===t,{isArray:Bn}=Array,Jn=Li("undefined");function Mu(t){return t!==null&&!Jn(t)&&t.constructor!==null&&!Jn(t.constructor)&&Et(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const Wo=xt("ArrayBuffer");function Au(t){let E;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?E=ArrayBuffer.isView(t):E=t&&t.buffer&&Wo(t.buffer),E}const Ou=Li("string"),Et=Li("function"),Go=Li("number"),Ni=t=>t!==null&&typeof t=="object",ku=t=>t===!0||t===!1,fi=t=>{if(xi(t)!=="object")return!1;const E=Fr(t);return(E===null||E===Object.prototype||Object.getPrototypeOf(E)===null)&&!(Symbol.toStringTag in t)&&!(Symbol.iterator in t)},Pu=xt("Date"),Du=xt("File"),xu=xt("Blob"),Lu=xt("FileList"),Nu=t=>Ni(t)&&Et(t.pipe),Bu=t=>{let E;return t&&(typeof FormData=="function"&&t instanceof FormData||Et(t.append)&&((E=xi(t))==="formdata"||E==="object"&&Et(t.toString)&&t.toString()==="[object FormData]"))},Uu=xt("URLSearchParams"),Fu=t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function Xn(t,E,{allOwnKeys:e=!1}={}){if(t===null||typeof t>"u")return;let u,g;if(typeof t!="object"&&(t=[t]),Bn(t))for(u=0,g=t.length;u<g;u++)E.call(null,t[u],u,t);else{const S=e?Object.getOwnPropertyNames(t):Object.keys(t),y=S.length;let c;for(u=0;u<y;u++)c=S[u],E.call(null,t[c],c,t)}}function qo(t,E){E=E.toLowerCase();const e=Object.keys(t);let u=e.length,g;for(;u-- >0;)if(g=e[u],E===g.toLowerCase())return g;return null}const zo=(()=>typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global)(),Yo=t=>!Jn(t)&&t!==zo;function vr(){const{caseless:t}=Yo(this)&&this||{},E={},e=(u,g)=>{const S=t&&qo(E,g)||g;fi(E[S])&&fi(u)?E[S]=vr(E[S],u):fi(u)?E[S]=vr({},u):Bn(u)?E[S]=u.slice():E[S]=u};for(let u=0,g=arguments.length;u<g;u++)arguments[u]&&Xn(arguments[u],e);return E}const ju=(t,E,e,{allOwnKeys:u}={})=>(Xn(E,(g,S)=>{e&&Et(g)?t[S]=Vo(g,e):t[S]=g},{allOwnKeys:u}),t),Ku=t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),Hu=(t,E,e,u)=>{t.prototype=Object.create(E.prototype,u),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:E.prototype}),e&&Object.assign(t.prototype,e)},$u=(t,E,e,u)=>{let g,S,y;const c={};if(E=E||{},t==null)return E;do{for(g=Object.getOwnPropertyNames(t),S=g.length;S-- >0;)y=g[S],(!u||u(y,t,E))&&!c[y]&&(E[y]=t[y],c[y]=!0);t=e!==!1&&Fr(t)}while(t&&(!e||e(t,E))&&t!==Object.prototype);return E},Vu=(t,E,e)=>{t=String(t),(e===void 0||e>t.length)&&(e=t.length),e-=E.length;const u=t.indexOf(E,e);return u!==-1&&u===e},Wu=t=>{if(!t)return null;if(Bn(t))return t;let E=t.length;if(!Go(E))return null;const e=new Array(E);for(;E-- >0;)e[E]=t[E];return e},Gu=(t=>E=>t&&E instanceof t)(typeof Uint8Array<"u"&&Fr(Uint8Array)),qu=(t,E)=>{const u=(t&&t[Symbol.iterator]).call(t);let g;for(;(g=u.next())&&!g.done;){const S=g.value;E.call(t,S[0],S[1])}},zu=(t,E)=>{let e;const u=[];for(;(e=t.exec(E))!==null;)u.push(e);return u},Yu=xt("HTMLFormElement"),Ju=t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,u,g){return u.toUpperCase()+g}),Is=(({hasOwnProperty:t})=>(E,e)=>t.call(E,e))(Object.prototype),Qu=xt("RegExp"),Jo=(t,E)=>{const e=Object.getOwnPropertyDescriptors(t),u={};Xn(e,(g,S)=>{E(g,S,t)!==!1&&(u[S]=g)}),Object.defineProperties(t,u)},Xu=t=>{Jo(t,(E,e)=>{if(Et(t)&&["arguments","caller","callee"].indexOf(e)!==-1)return!1;const u=t[e];if(Et(u)){if(E.enumerable=!1,"writable"in E){E.writable=!1;return}E.set||(E.set=()=>{throw Error("Can not rewrite read-only method '"+e+"'")})}})},Zu=(t,E)=>{const e={},u=g=>{g.forEach(S=>{e[S]=!0})};return Bn(t)?u(t):u(String(t).split(E)),e},ef=()=>{},tf=(t,E)=>(t=+t,Number.isFinite(t)?t:E),Qi="abcdefghijklmnopqrstuvwxyz",Cs="0123456789",Qo={DIGIT:Cs,ALPHA:Qi,ALPHA_DIGIT:Qi+Qi.toUpperCase()+Cs},nf=(t=16,E=Qo.ALPHA_DIGIT)=>{let e="";const{length:u}=E;for(;t--;)e+=E[Math.random()*u|0];return e};function rf(t){return!!(t&&Et(t.append)&&t[Symbol.toStringTag]==="FormData"&&t[Symbol.iterator])}const sf=t=>{const E=new Array(10),e=(u,g)=>{if(Ni(u)){if(E.indexOf(u)>=0)return;if(!("toJSON"in u)){E[g]=u;const S=Bn(u)?[]:{};return Xn(u,(y,c)=>{const m=e(y,g+1);!Jn(m)&&(S[c]=m)}),E[g]=void 0,S}}return u};return e(t,0)},of=xt("AsyncFunction"),af=t=>t&&(Ni(t)||Et(t))&&Et(t.then)&&Et(t.catch),Te={isArray:Bn,isArrayBuffer:Wo,isBuffer:Mu,isFormData:Bu,isArrayBufferView:Au,isString:Ou,isNumber:Go,isBoolean:ku,isObject:Ni,isPlainObject:fi,isUndefined:Jn,isDate:Pu,isFile:Du,isBlob:xu,isRegExp:Qu,isFunction:Et,isStream:Nu,isURLSearchParams:Uu,isTypedArray:Gu,isFileList:Lu,forEach:Xn,merge:vr,extend:ju,trim:Fu,stripBOM:Ku,inherits:Hu,toFlatObject:$u,kindOf:xi,kindOfTest:xt,endsWith:Vu,toArray:Wu,forEachEntry:qu,matchAll:zu,isHTMLForm:Yu,hasOwnProperty:Is,hasOwnProp:Is,reduceDescriptors:Jo,freezeMethods:Xu,toObjectSet:Zu,toCamelCase:Ju,noop:ef,toFiniteNumber:tf,findKey:qo,global:zo,isContextDefined:Yo,ALPHABET:Qo,generateString:nf,isSpecCompliantForm:rf,toJSONObject:sf,isAsyncFn:of,isThenable:af};function Ge(t,E,e,u,g){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",E&&(this.code=E),e&&(this.config=e),u&&(this.request=u),g&&(this.response=g)}Te.inherits(Ge,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Te.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const Xo=Ge.prototype,Zo={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{Zo[t]={value:t}});Object.defineProperties(Ge,Zo);Object.defineProperty(Xo,"isAxiosError",{value:!0});Ge.from=(t,E,e,u,g,S)=>{const y=Object.create(Xo);return Te.toFlatObject(t,y,function(m){return m!==Error.prototype},c=>c!=="isAxiosError"),Ge.call(y,t.message,E,e,u,g),y.cause=t,y.name=t.name,S&&Object.assign(y,S),y};const cf=null;function mr(t){return Te.isPlainObject(t)||Te.isArray(t)}function ea(t){return Te.endsWith(t,"[]")?t.slice(0,-2):t}function Ms(t,E,e){return t?t.concat(E).map(function(g,S){return g=ea(g),!e&&S?"["+g+"]":g}).join(e?".":""):E}function lf(t){return Te.isArray(t)&&!t.some(mr)}const df=Te.toFlatObject(Te,{},null,function(E){return/^is[A-Z]/.test(E)});function Bi(t,E,e){if(!Te.isObject(t))throw new TypeError("target must be an object");E=E||new FormData,e=Te.toFlatObject(e,{metaTokens:!0,dots:!1,indexes:!1},!1,function(r,s){return!Te.isUndefined(s[r])});const u=e.metaTokens,g=e.visitor||d,S=e.dots,y=e.indexes,m=(e.Blob||typeof Blob<"u"&&Blob)&&Te.isSpecCompliantForm(E);if(!Te.isFunction(g))throw new TypeError("visitor must be a function");function h(i){if(i===null)return"";if(Te.isDate(i))return i.toISOString();if(!m&&Te.isBlob(i))throw new Ge("Blob is not supported. Use a Buffer instead.");return Te.isArrayBuffer(i)||Te.isTypedArray(i)?m&&typeof Blob=="function"?new Blob([i]):Buffer.from(i):i}function d(i,r,s){let o=i;if(i&&!s&&typeof i=="object"){if(Te.endsWith(r,"{}"))r=u?r:r.slice(0,-2),i=JSON.stringify(i);else if(Te.isArray(i)&&lf(i)||(Te.isFileList(i)||Te.endsWith(r,"[]"))&&(o=Te.toArray(i)))return r=ea(r),o.forEach(function(v,f){!(Te.isUndefined(v)||v===null)&&E.append(y===!0?Ms([r],f,S):y===null?r:r+"[]",h(v))}),!1}return mr(i)?!0:(E.append(Ms(s,r,S),h(i)),!1)}const b=[],a=Object.assign(df,{defaultVisitor:d,convertValue:h,isVisitable:mr});function n(i,r){if(!Te.isUndefined(i)){if(b.indexOf(i)!==-1)throw Error("Circular reference detected in "+r.join("."));b.push(i),Te.forEach(i,function(o,l){(!(Te.isUndefined(o)||o===null)&&g.call(E,o,Te.isString(l)?l.trim():l,r,a))===!0&&n(o,r?r.concat(l):[l])}),b.pop()}}if(!Te.isObject(t))throw new TypeError("data must be an object");return n(t),E}function As(t){const E={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(u){return E[u]})}function jr(t,E){this._pairs=[],t&&Bi(t,this,E)}const ta=jr.prototype;ta.append=function(E,e){this._pairs.push([E,e])};ta.toString=function(E){const e=E?function(u){return E.call(this,u,As)}:As;return this._pairs.map(function(g){return e(g[0])+"="+e(g[1])},"").join("&")};function uf(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function na(t,E,e){if(!E)return t;const u=e&&e.encode||uf,g=e&&e.serialize;let S;if(g?S=g(E,e):S=Te.isURLSearchParams(E)?E.toString():new jr(E,e).toString(u),S){const y=t.indexOf("#");y!==-1&&(t=t.slice(0,y)),t+=(t.indexOf("?")===-1?"?":"&")+S}return t}class ff{constructor(){this.handlers=[]}use(E,e,u){return this.handlers.push({fulfilled:E,rejected:e,synchronous:u?u.synchronous:!1,runWhen:u?u.runWhen:null}),this.handlers.length-1}eject(E){this.handlers[E]&&(this.handlers[E]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(E){Te.forEach(this.handlers,function(u){u!==null&&E(u)})}}const Os=ff,ia={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},hf=typeof URLSearchParams<"u"?URLSearchParams:jr,pf=typeof FormData<"u"?FormData:null,gf=typeof Blob<"u"?Blob:null,vf=(()=>{let t;return typeof navigator<"u"&&((t=navigator.product)==="ReactNative"||t==="NativeScript"||t==="NS")?!1:typeof window<"u"&&typeof document<"u"})(),mf=(()=>typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function")(),Pt={isBrowser:!0,classes:{URLSearchParams:hf,FormData:pf,Blob:gf},isStandardBrowserEnv:vf,isStandardBrowserWebWorkerEnv:mf,protocols:["http","https","file","blob","url","data"]};function yf(t,E){return Bi(t,new Pt.classes.URLSearchParams,Object.assign({visitor:function(e,u,g,S){return Pt.isNode&&Te.isBuffer(e)?(this.append(u,e.toString("base64")),!1):S.defaultVisitor.apply(this,arguments)}},E))}function bf(t){return Te.matchAll(/\w+|\[(\w*)]/g,t).map(E=>E[0]==="[]"?"":E[1]||E[0])}function _f(t){const E={},e=Object.keys(t);let u;const g=e.length;let S;for(u=0;u<g;u++)S=e[u],E[S]=t[S];return E}function ra(t){function E(e,u,g,S){let y=e[S++];const c=Number.isFinite(+y),m=S>=e.length;return y=!y&&Te.isArray(g)?g.length:y,m?(Te.hasOwnProp(g,y)?g[y]=[g[y],u]:g[y]=u,!c):((!g[y]||!Te.isObject(g[y]))&&(g[y]=[]),E(e,u,g[y],S)&&Te.isArray(g[y])&&(g[y]=_f(g[y])),!c)}if(Te.isFormData(t)&&Te.isFunction(t.entries)){const e={};return Te.forEachEntry(t,(u,g)=>{E(bf(u),g,e,0)}),e}return null}const Sf={"Content-Type":void 0};function Ef(t,E,e){if(Te.isString(t))try{return(E||JSON.parse)(t),Te.trim(t)}catch(u){if(u.name!=="SyntaxError")throw u}return(e||JSON.stringify)(t)}const Ui={transitional:ia,adapter:["xhr","http"],transformRequest:[function(E,e){const u=e.getContentType()||"",g=u.indexOf("application/json")>-1,S=Te.isObject(E);if(S&&Te.isHTMLForm(E)&&(E=new FormData(E)),Te.isFormData(E))return g&&g?JSON.stringify(ra(E)):E;if(Te.isArrayBuffer(E)||Te.isBuffer(E)||Te.isStream(E)||Te.isFile(E)||Te.isBlob(E))return E;if(Te.isArrayBufferView(E))return E.buffer;if(Te.isURLSearchParams(E))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),E.toString();let c;if(S){if(u.indexOf("application/x-www-form-urlencoded")>-1)return yf(E,this.formSerializer).toString();if((c=Te.isFileList(E))||u.indexOf("multipart/form-data")>-1){const m=this.env&&this.env.FormData;return Bi(c?{"files[]":E}:E,m&&new m,this.formSerializer)}}return S||g?(e.setContentType("application/json",!1),Ef(E)):E}],transformResponse:[function(E){const e=this.transitional||Ui.transitional,u=e&&e.forcedJSONParsing,g=this.responseType==="json";if(E&&Te.isString(E)&&(u&&!this.responseType||g)){const y=!(e&&e.silentJSONParsing)&&g;try{return JSON.parse(E)}catch(c){if(y)throw c.name==="SyntaxError"?Ge.from(c,Ge.ERR_BAD_RESPONSE,this,null,this.response):c}}return E}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Pt.classes.FormData,Blob:Pt.classes.Blob},validateStatus:function(E){return E>=200&&E<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};Te.forEach(["delete","get","head"],function(E){Ui.headers[E]={}});Te.forEach(["post","put","patch"],function(E){Ui.headers[E]=Te.merge(Sf)});const Kr=Ui,wf=Te.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Tf=t=>{const E={};let e,u,g;return t&&t.split(`
`).forEach(function(y){g=y.indexOf(":"),e=y.substring(0,g).trim().toLowerCase(),u=y.substring(g+1).trim(),!(!e||E[e]&&wf[e])&&(e==="set-cookie"?E[e]?E[e].push(u):E[e]=[u]:E[e]=E[e]?E[e]+", "+u:u)}),E},ks=Symbol("internals");function Fn(t){return t&&String(t).trim().toLowerCase()}function hi(t){return t===!1||t==null?t:Te.isArray(t)?t.map(hi):String(t)}function Rf(t){const E=Object.create(null),e=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let u;for(;u=e.exec(t);)E[u[1]]=u[2];return E}const If=t=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim());function Xi(t,E,e,u,g){if(Te.isFunction(u))return u.call(this,E,e);if(g&&(E=e),!!Te.isString(E)){if(Te.isString(u))return E.indexOf(u)!==-1;if(Te.isRegExp(u))return u.test(E)}}function Cf(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(E,e,u)=>e.toUpperCase()+u)}function Mf(t,E){const e=Te.toCamelCase(" "+E);["get","set","has"].forEach(u=>{Object.defineProperty(t,u+e,{value:function(g,S,y){return this[u].call(this,E,g,S,y)},configurable:!0})})}class Fi{constructor(E){E&&this.set(E)}set(E,e,u){const g=this;function S(c,m,h){const d=Fn(m);if(!d)throw new Error("header name must be a non-empty string");const b=Te.findKey(g,d);(!b||g[b]===void 0||h===!0||h===void 0&&g[b]!==!1)&&(g[b||m]=hi(c))}const y=(c,m)=>Te.forEach(c,(h,d)=>S(h,d,m));return Te.isPlainObject(E)||E instanceof this.constructor?y(E,e):Te.isString(E)&&(E=E.trim())&&!If(E)?y(Tf(E),e):E!=null&&S(e,E,u),this}get(E,e){if(E=Fn(E),E){const u=Te.findKey(this,E);if(u){const g=this[u];if(!e)return g;if(e===!0)return Rf(g);if(Te.isFunction(e))return e.call(this,g,u);if(Te.isRegExp(e))return e.exec(g);throw new TypeError("parser must be boolean|regexp|function")}}}has(E,e){if(E=Fn(E),E){const u=Te.findKey(this,E);return!!(u&&this[u]!==void 0&&(!e||Xi(this,this[u],u,e)))}return!1}delete(E,e){const u=this;let g=!1;function S(y){if(y=Fn(y),y){const c=Te.findKey(u,y);c&&(!e||Xi(u,u[c],c,e))&&(delete u[c],g=!0)}}return Te.isArray(E)?E.forEach(S):S(E),g}clear(E){const e=Object.keys(this);let u=e.length,g=!1;for(;u--;){const S=e[u];(!E||Xi(this,this[S],S,E,!0))&&(delete this[S],g=!0)}return g}normalize(E){const e=this,u={};return Te.forEach(this,(g,S)=>{const y=Te.findKey(u,S);if(y){e[y]=hi(g),delete e[S];return}const c=E?Cf(S):String(S).trim();c!==S&&delete e[S],e[c]=hi(g),u[c]=!0}),this}concat(...E){return this.constructor.concat(this,...E)}toJSON(E){const e=Object.create(null);return Te.forEach(this,(u,g)=>{u!=null&&u!==!1&&(e[g]=E&&Te.isArray(u)?u.join(", "):u)}),e}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([E,e])=>E+": "+e).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(E){return E instanceof this?E:new this(E)}static concat(E,...e){const u=new this(E);return e.forEach(g=>u.set(g)),u}static accessor(E){const u=(this[ks]=this[ks]={accessors:{}}).accessors,g=this.prototype;function S(y){const c=Fn(y);u[c]||(Mf(g,y),u[c]=!0)}return Te.isArray(E)?E.forEach(S):S(E),this}}Fi.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);Te.freezeMethods(Fi.prototype);Te.freezeMethods(Fi);const Bt=Fi;function Zi(t,E){const e=this||Kr,u=E||e,g=Bt.from(u.headers);let S=u.data;return Te.forEach(t,function(c){S=c.call(e,S,g.normalize(),E?E.status:void 0)}),g.normalize(),S}function sa(t){return!!(t&&t.__CANCEL__)}function Zn(t,E,e){Ge.call(this,t??"canceled",Ge.ERR_CANCELED,E,e),this.name="CanceledError"}Te.inherits(Zn,Ge,{__CANCEL__:!0});function Af(t,E,e){const u=e.config.validateStatus;!e.status||!u||u(e.status)?t(e):E(new Ge("Request failed with status code "+e.status,[Ge.ERR_BAD_REQUEST,Ge.ERR_BAD_RESPONSE][Math.floor(e.status/100)-4],e.config,e.request,e))}const Of=Pt.isStandardBrowserEnv?function(){return{write:function(e,u,g,S,y,c){const m=[];m.push(e+"="+encodeURIComponent(u)),Te.isNumber(g)&&m.push("expires="+new Date(g).toGMTString()),Te.isString(S)&&m.push("path="+S),Te.isString(y)&&m.push("domain="+y),c===!0&&m.push("secure"),document.cookie=m.join("; ")},read:function(e){const u=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return u?decodeURIComponent(u[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}}():function(){return{write:function(){},read:function(){return null},remove:function(){}}}();function kf(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}function Pf(t,E){return E?t.replace(/\/+$/,"")+"/"+E.replace(/^\/+/,""):t}function oa(t,E){return t&&!kf(E)?Pf(t,E):E}const Df=Pt.isStandardBrowserEnv?function(){const E=/(msie|trident)/i.test(navigator.userAgent),e=document.createElement("a");let u;function g(S){let y=S;return E&&(e.setAttribute("href",y),y=e.href),e.setAttribute("href",y),{href:e.href,protocol:e.protocol?e.protocol.replace(/:$/,""):"",host:e.host,search:e.search?e.search.replace(/^\?/,""):"",hash:e.hash?e.hash.replace(/^#/,""):"",hostname:e.hostname,port:e.port,pathname:e.pathname.charAt(0)==="/"?e.pathname:"/"+e.pathname}}return u=g(window.location.href),function(y){const c=Te.isString(y)?g(y):y;return c.protocol===u.protocol&&c.host===u.host}}():function(){return function(){return!0}}();function xf(t){const E=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return E&&E[1]||""}function Lf(t,E){t=t||10;const e=new Array(t),u=new Array(t);let g=0,S=0,y;return E=E!==void 0?E:1e3,function(m){const h=Date.now(),d=u[S];y||(y=h),e[g]=m,u[g]=h;let b=S,a=0;for(;b!==g;)a+=e[b++],b=b%t;if(g=(g+1)%t,g===S&&(S=(S+1)%t),h-y<E)return;const n=d&&h-d;return n?Math.round(a*1e3/n):void 0}}function Ps(t,E){let e=0;const u=Lf(50,250);return g=>{const S=g.loaded,y=g.lengthComputable?g.total:void 0,c=S-e,m=u(c),h=S<=y;e=S;const d={loaded:S,total:y,progress:y?S/y:void 0,bytes:c,rate:m||void 0,estimated:m&&y&&h?(y-S)/m:void 0,event:g};d[E?"download":"upload"]=!0,t(d)}}const Nf=typeof XMLHttpRequest<"u",Bf=Nf&&function(t){return new Promise(function(e,u){let g=t.data;const S=Bt.from(t.headers).normalize(),y=t.responseType;let c;function m(){t.cancelToken&&t.cancelToken.unsubscribe(c),t.signal&&t.signal.removeEventListener("abort",c)}Te.isFormData(g)&&(Pt.isStandardBrowserEnv||Pt.isStandardBrowserWebWorkerEnv?S.setContentType(!1):S.setContentType("multipart/form-data;",!1));let h=new XMLHttpRequest;if(t.auth){const n=t.auth.username||"",i=t.auth.password?unescape(encodeURIComponent(t.auth.password)):"";S.set("Authorization","Basic "+btoa(n+":"+i))}const d=oa(t.baseURL,t.url);h.open(t.method.toUpperCase(),na(d,t.params,t.paramsSerializer),!0),h.timeout=t.timeout;function b(){if(!h)return;const n=Bt.from("getAllResponseHeaders"in h&&h.getAllResponseHeaders()),r={data:!y||y==="text"||y==="json"?h.responseText:h.response,status:h.status,statusText:h.statusText,headers:n,config:t,request:h};Af(function(o){e(o),m()},function(o){u(o),m()},r),h=null}if("onloadend"in h?h.onloadend=b:h.onreadystatechange=function(){!h||h.readyState!==4||h.status===0&&!(h.responseURL&&h.responseURL.indexOf("file:")===0)||setTimeout(b)},h.onabort=function(){h&&(u(new Ge("Request aborted",Ge.ECONNABORTED,t,h)),h=null)},h.onerror=function(){u(new Ge("Network Error",Ge.ERR_NETWORK,t,h)),h=null},h.ontimeout=function(){let i=t.timeout?"timeout of "+t.timeout+"ms exceeded":"timeout exceeded";const r=t.transitional||ia;t.timeoutErrorMessage&&(i=t.timeoutErrorMessage),u(new Ge(i,r.clarifyTimeoutError?Ge.ETIMEDOUT:Ge.ECONNABORTED,t,h)),h=null},Pt.isStandardBrowserEnv){const n=(t.withCredentials||Df(d))&&t.xsrfCookieName&&Of.read(t.xsrfCookieName);n&&S.set(t.xsrfHeaderName,n)}g===void 0&&S.setContentType(null),"setRequestHeader"in h&&Te.forEach(S.toJSON(),function(i,r){h.setRequestHeader(r,i)}),Te.isUndefined(t.withCredentials)||(h.withCredentials=!!t.withCredentials),y&&y!=="json"&&(h.responseType=t.responseType),typeof t.onDownloadProgress=="function"&&h.addEventListener("progress",Ps(t.onDownloadProgress,!0)),typeof t.onUploadProgress=="function"&&h.upload&&h.upload.addEventListener("progress",Ps(t.onUploadProgress)),(t.cancelToken||t.signal)&&(c=n=>{h&&(u(!n||n.type?new Zn(null,t,h):n),h.abort(),h=null)},t.cancelToken&&t.cancelToken.subscribe(c),t.signal&&(t.signal.aborted?c():t.signal.addEventListener("abort",c)));const a=xf(d);if(a&&Pt.protocols.indexOf(a)===-1){u(new Ge("Unsupported protocol "+a+":",Ge.ERR_BAD_REQUEST,t));return}h.send(g||null)})},pi={http:cf,xhr:Bf};Te.forEach(pi,(t,E)=>{if(t){try{Object.defineProperty(t,"name",{value:E})}catch{}Object.defineProperty(t,"adapterName",{value:E})}});const Uf={getAdapter:t=>{t=Te.isArray(t)?t:[t];const{length:E}=t;let e,u;for(let g=0;g<E&&(e=t[g],!(u=Te.isString(e)?pi[e.toLowerCase()]:e));g++);if(!u)throw u===!1?new Ge(`Adapter ${e} is not supported by the environment`,"ERR_NOT_SUPPORT"):new Error(Te.hasOwnProp(pi,e)?`Adapter '${e}' is not available in the build`:`Unknown adapter '${e}'`);if(!Te.isFunction(u))throw new TypeError("adapter is not a function");return u},adapters:pi};function er(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new Zn(null,t)}function Ds(t){return er(t),t.headers=Bt.from(t.headers),t.data=Zi.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),Uf.getAdapter(t.adapter||Kr.adapter)(t).then(function(u){return er(t),u.data=Zi.call(t,t.transformResponse,u),u.headers=Bt.from(u.headers),u},function(u){return sa(u)||(er(t),u&&u.response&&(u.response.data=Zi.call(t,t.transformResponse,u.response),u.response.headers=Bt.from(u.response.headers))),Promise.reject(u)})}const xs=t=>t instanceof Bt?t.toJSON():t;function xn(t,E){E=E||{};const e={};function u(h,d,b){return Te.isPlainObject(h)&&Te.isPlainObject(d)?Te.merge.call({caseless:b},h,d):Te.isPlainObject(d)?Te.merge({},d):Te.isArray(d)?d.slice():d}function g(h,d,b){if(Te.isUndefined(d)){if(!Te.isUndefined(h))return u(void 0,h,b)}else return u(h,d,b)}function S(h,d){if(!Te.isUndefined(d))return u(void 0,d)}function y(h,d){if(Te.isUndefined(d)){if(!Te.isUndefined(h))return u(void 0,h)}else return u(void 0,d)}function c(h,d,b){if(b in E)return u(h,d);if(b in t)return u(void 0,h)}const m={url:S,method:S,data:S,baseURL:y,transformRequest:y,transformResponse:y,paramsSerializer:y,timeout:y,timeoutMessage:y,withCredentials:y,adapter:y,responseType:y,xsrfCookieName:y,xsrfHeaderName:y,onUploadProgress:y,onDownloadProgress:y,decompress:y,maxContentLength:y,maxBodyLength:y,beforeRedirect:y,transport:y,httpAgent:y,httpsAgent:y,cancelToken:y,socketPath:y,responseEncoding:y,validateStatus:c,headers:(h,d)=>g(xs(h),xs(d),!0)};return Te.forEach(Object.keys(Object.assign({},t,E)),function(d){const b=m[d]||g,a=b(t[d],E[d],d);Te.isUndefined(a)&&b!==c||(e[d]=a)}),e}const aa="1.4.0",Hr={};["object","boolean","number","function","string","symbol"].forEach((t,E)=>{Hr[t]=function(u){return typeof u===t||"a"+(E<1?"n ":" ")+t}});const Ls={};Hr.transitional=function(E,e,u){function g(S,y){return"[Axios v"+aa+"] Transitional option '"+S+"'"+y+(u?". "+u:"")}return(S,y,c)=>{if(E===!1)throw new Ge(g(y," has been removed"+(e?" in "+e:"")),Ge.ERR_DEPRECATED);return e&&!Ls[y]&&(Ls[y]=!0,console.warn(g(y," has been deprecated since v"+e+" and will be removed in the near future"))),E?E(S,y,c):!0}};function Ff(t,E,e){if(typeof t!="object")throw new Ge("options must be an object",Ge.ERR_BAD_OPTION_VALUE);const u=Object.keys(t);let g=u.length;for(;g-- >0;){const S=u[g],y=E[S];if(y){const c=t[S],m=c===void 0||y(c,S,t);if(m!==!0)throw new Ge("option "+S+" must be "+m,Ge.ERR_BAD_OPTION_VALUE);continue}if(e!==!0)throw new Ge("Unknown option "+S,Ge.ERR_BAD_OPTION)}}const yr={assertOptions:Ff,validators:Hr},$t=yr.validators;class _i{constructor(E){this.defaults=E,this.interceptors={request:new Os,response:new Os}}request(E,e){typeof E=="string"?(e=e||{},e.url=E):e=E||{},e=xn(this.defaults,e);const{transitional:u,paramsSerializer:g,headers:S}=e;u!==void 0&&yr.assertOptions(u,{silentJSONParsing:$t.transitional($t.boolean),forcedJSONParsing:$t.transitional($t.boolean),clarifyTimeoutError:$t.transitional($t.boolean)},!1),g!=null&&(Te.isFunction(g)?e.paramsSerializer={serialize:g}:yr.assertOptions(g,{encode:$t.function,serialize:$t.function},!0)),e.method=(e.method||this.defaults.method||"get").toLowerCase();let y;y=S&&Te.merge(S.common,S[e.method]),y&&Te.forEach(["delete","get","head","post","put","patch","common"],i=>{delete S[i]}),e.headers=Bt.concat(y,S);const c=[];let m=!0;this.interceptors.request.forEach(function(r){typeof r.runWhen=="function"&&r.runWhen(e)===!1||(m=m&&r.synchronous,c.unshift(r.fulfilled,r.rejected))});const h=[];this.interceptors.response.forEach(function(r){h.push(r.fulfilled,r.rejected)});let d,b=0,a;if(!m){const i=[Ds.bind(this),void 0];for(i.unshift.apply(i,c),i.push.apply(i,h),a=i.length,d=Promise.resolve(e);b<a;)d=d.then(i[b++],i[b++]);return d}a=c.length;let n=e;for(b=0;b<a;){const i=c[b++],r=c[b++];try{n=i(n)}catch(s){r.call(this,s);break}}try{d=Ds.call(this,n)}catch(i){return Promise.reject(i)}for(b=0,a=h.length;b<a;)d=d.then(h[b++],h[b++]);return d}getUri(E){E=xn(this.defaults,E);const e=oa(E.baseURL,E.url);return na(e,E.params,E.paramsSerializer)}}Te.forEach(["delete","get","head","options"],function(E){_i.prototype[E]=function(e,u){return this.request(xn(u||{},{method:E,url:e,data:(u||{}).data}))}});Te.forEach(["post","put","patch"],function(E){function e(u){return function(S,y,c){return this.request(xn(c||{},{method:E,headers:u?{"Content-Type":"multipart/form-data"}:{},url:S,data:y}))}}_i.prototype[E]=e(),_i.prototype[E+"Form"]=e(!0)});const gi=_i;class $r{constructor(E){if(typeof E!="function")throw new TypeError("executor must be a function.");let e;this.promise=new Promise(function(S){e=S});const u=this;this.promise.then(g=>{if(!u._listeners)return;let S=u._listeners.length;for(;S-- >0;)u._listeners[S](g);u._listeners=null}),this.promise.then=g=>{let S;const y=new Promise(c=>{u.subscribe(c),S=c}).then(g);return y.cancel=function(){u.unsubscribe(S)},y},E(function(S,y,c){u.reason||(u.reason=new Zn(S,y,c),e(u.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(E){if(this.reason){E(this.reason);return}this._listeners?this._listeners.push(E):this._listeners=[E]}unsubscribe(E){if(!this._listeners)return;const e=this._listeners.indexOf(E);e!==-1&&this._listeners.splice(e,1)}static source(){let E;return{token:new $r(function(g){E=g}),cancel:E}}}const jf=$r;function Kf(t){return function(e){return t.apply(null,e)}}function Hf(t){return Te.isObject(t)&&t.isAxiosError===!0}const br={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(br).forEach(([t,E])=>{br[E]=t});const $f=br;function ca(t){const E=new gi(t),e=Vo(gi.prototype.request,E);return Te.extend(e,gi.prototype,E,{allOwnKeys:!0}),Te.extend(e,E,null,{allOwnKeys:!0}),e.create=function(g){return ca(xn(t,g))},e}const lt=ca(Kr);lt.Axios=gi;lt.CanceledError=Zn;lt.CancelToken=jf;lt.isCancel=sa;lt.VERSION=aa;lt.toFormData=Bi;lt.AxiosError=Ge;lt.Cancel=lt.CanceledError;lt.all=function(E){return Promise.all(E)};lt.spread=Kf;lt.isAxiosError=Hf;lt.mergeConfig=xn;lt.AxiosHeaders=Bt;lt.formToJSON=t=>ra(Te.isHTMLForm(t)?new FormData(t):t);lt.HttpStatusCode=$f;lt.default=lt;const Vf=lt;class Wf{constructor(){wt(this,"sessao");wt(this,"usuario");wt(this,"servidor");wt(this,"sala");wt(this,"dadosSala");wt(this,"mensagens",[]);wt(this,"dadosUsuarioLider");wt(this,"dadosUsuarioLogin");wt(this,"salas",{});wt(this,"matrixClient")}getCookie(E){try{let e={};return document.cookie.split(";").forEach(function(u){let[g,S]=u.split("=");e[g.trim()]=S}),e[E]}catch{return console.log("erro optendo cookie:"+E),null}}async conectar(){this.sessao=this.getCookie("cndMatrixSessao"),this.usuario=this.getCookie("cndMatrixusuario"),this.sala=this.getCookie("cndMatrixSala"),console.log("Conectando com :"),console.log(this.usuario),console.log(this.sessao);const E=this.matrixClient=matrixcs.createClient({baseUrl:this.servidor,accessToken:this.sessao,userId:this.usuario});await this.matrixClient.startClient();const e=new Promise((u,g)=>{this.matrixClient.on("sync",(S,y)=>{S==="PREPARED"&&console.log("CONECTOU"),S==="SYNCING"?u(this.matrixClient):S==="ERROR"&&g(y.error)})});await Promise.all([E,e]),window.chatConvidado=this}async loadEventosExemplo(){this.matrixClient.on("RoomMember.typing",function(E,e){e.typing,console.log(e),console.log("digitando")}),this.matrixClient.on("Room.timeline",function(E,e,u){if(E.getType()!=="m.room.message"){console.log("Evento diferente"),console.log(E.getType());return}this.sala=e,E.event.sender!==chatConvidado.usuario?(console.log("Aceitou evento de:"),console.log(E.event.sender),console.log("O usurio logado  o"),console.log(this.usuario),console.log(E.event),document.getElementById("cndChatMensagemRecebida").value=E.event.content.body,document.getElementById("cndChatReceberMensagem").click()):(console.log("NEGOU evento de:"),console.log("event.event.sender"),console.log("event.event"))})}async efeturarLogin(E,e){usuario=E,senha=e,await athis.conectar()}getSalas(){return this.salas=this.matrixClient.store.getRoomSummaries(),this.salas}async getSala(){return this.sala==null&&(this.sala=this.getSalas()[0].roomId),await this.abrirSala(this.sala),this.sala}getDadosSala(){return this.dadosSala===void 0&&this.getSala(),this.dadosSala}async abrirSala(E){try{console.log("entrando na sala:"),console.log(E),this.dadosSala=this.matrixClient.getRooms().find(e=>e.roomId==E)}catch(e){console.log("Erro lendo dados da sala"+E),console.log(e)}}enviarMensagemTexto(E){const e={body:E,msgtype:"m.text"};this.matrixClient.sendEvent(this.getSala(),"m.room.message",e,"",(u,g)=>{console.log(u)})}}const Gf=Object.freeze({CHAT_TELA_CHEIA:1,BOLHA:2,CHAT_PEQUENO:3,AGUARDANDO_CONEXAO:4,LOGIN:5}),qf={data(){return{sessao:"",usuario:"",servidor:"https://matrix.casanovadigital.com.br",servidorWS:"https://contatows.casanovadigital.com.br/api/v1",sala:"",usuarioLider:void 0,usuarioLogin:void 0,membros:void 0,mensagemRecebida:"",conversa:[],tipoVisualizacao:Gf.CHAT_PEQUENO,matrix:void 0,foiLogadoUsuario:!1,foiCarregadoMembros:!1,foiCarregadoMensagensIniciais:!1}},computed:{foiCarregadoDadosIniciais:function(){return this.foiLogadoUsuario&&this.foiCarregadoMembros&&this.foiCarregadoMensagensIniciais}},created(){this.carregarVariaveisIniciais()},components:{ChatBolha:Pd,ChatTelaInteira:Iu},methods:{carregarVariaveisIniciais(){this.$cookies.isKey("cndMatrixSessao")&&(console.log("TEm"),this.sessao=this.$cookies.get("cndMatrixSessao")),this.$cookies.isKey("cndMatrixSala")&&(this.sala=this.$cookies.get("cndMatrixSala")),this.$cookies.isKey("cndMatrixusuario")&&(this.usuario=this.$cookies.get("cndMatrixusuario")),this.logar()},registrarNovaMensagem(t){var E={};E.tipoAtendimento=!1,E.mensagem=t,E.dataHora=new Date,E.codUsuario=this.usuarioLogin.codigoUsuario,E.avatar=this.usuarioLogin.avatar,this.conversa.push(E);const e={body:t,msgtype:"m.text"};this.matrix.matrixClient.sendEvent(this.sala,"m.room.message",e,"",(u,g)=>{console.log(u)}),setTimeout(function(){document.getElementById("chat-messages").scrollTo(0,document.getElementById("chat-messages").scrollHeight)},1e3)},async logar(){this.matrix=new Wf,this.matrix.usuario=this.usuario,this.matrix.servidor=this.servidor,this.matrix.sessao=this.sessao,this.matrix.sala=this.sala,await this.matrix.conectar(),console.log("conectou"),this.foiLogadoUsuario=!0,await this.loadMembros(),this.loadMensagensIniciais();let t=this.conversa,E=this.usuarioLider;this.matrix.matrixClient.on("Room.timeline",function(e,u,g){if(e.getType()!=="m.room.message"){console.log("Evento diferente"),console.log(e.getType());return}this.sala=u;var S={};try{e.event.sender===E.codigoUsuario?(S.tipoAtendimento=!0,S.mensagem=e.event.content.body,S.dataHora=new Date(e.localTimestamp),S.codUsuario=e.sender,S.avatar=E.avatar,t.push(S),setTimeout(function(){document.getElementById("chat-messages").scrollTo(0,document.getElementById("chat-messages").scrollHeight)},1e3)):(console.log("NEGOU evento de:"),console.log(E),console.log(E.codigoUsuario),console.log(e.event.sender),console.log(e.event))}catch(y){console.log(y)}})},async loadMembros(){console.log("wsURL:::"),console.log(this.servidorWS);var t=this.servidorWS+"/salas/salaPrimeiroContato/membros/"+this.sala;console.log(t),await Vf.get(t).then(E=>{E.data.sucesso?(this.membros=E.data.retorno.membros,this.usuarioLider=E.data.retorno.membroLider,this.usuarioLogin=E.data.retorno.membroLogin,this.dadosIniciaisCarregados=!0,this.foiCarregadoMembros=!0):(console.log("ERRO OBTENDO MEMBROS "),console.log(E.data),console.log(E.data.sucesso))})},async loadMensagensIniciais(){try{console.log("_____________________"),console.log(this.matrix.getDadosSala()),console.log("_____________________");var t=await this.matrix.getDadosSala();console.log(this.usuarioLider);for(var E of t.timeline)if(E.event.type==="m.room.message"){if(console.log("Mensagem"),console.log(E.event),console.log(this.usuarioLider),console.log(this.usuarioLider.codigoUsuario),console.log(E.sender.userId),E.sender.userId===this.usuarioLider.codigoUsuario&&(console.log("Mensagem do atendente"),E.event.content.msgtype==="m.text")){var e={};e.tipoAtendimento=!0,e.mensagem=E.event.content.body,e.dataHora=new Date(E.localTimestamp),e.codUsuario=E.sender.userId,e.avatar=this.usuarioLider.avatar,this.conversa.push(e)}if(E.sender.userId===this.usuarioLogin.codigoUsuario&&E.event.content.msgtype==="m.text"){var e={};e.tipoAtendimento=!1,e.mensagem=E.event.content.body,e.dataHora=new Date(E.localTimestamp),e.codUsuario=E.sender.userId,e.avatar=this.usuarioLogin.avatar,this.conversa.push(e)}}this.foiCarregadoMensagensIniciais=!0}catch(u){console.log("Erro obtendo sala "),console.log(u)}},receberCMD(){this.receberMensagem(this.mensagemRecebida)},receberMensagem(t){try{var E=document.getElementById("cndChatMensagemRecebida").value;this.$refs.chatBolhaUI.receberMensagem(E)}catch{}}},mounted(){console.log("montou")}};function zf(t,E,e,u,g,S){const y=Nt("router-view");Nt("ChatBolha");const c=Nt("ChatTelaInteira");return qe(),Ye(gt,null,[ot(y),_t("",!0),S.foiCarregadoDadosIniciais?(qe(),xo(c,{key:1,atendenteNome:g.usuarioLider.nome,atendenteAvatar:g.usuarioLider.avatar,atendenteEmail:g.usuarioLider.email,conversa:g.conversa},null,8,["atendenteNome","atendenteAvatar","atendenteEmail","conversa"])):_t("",!0)],64)}const Yf=In(qf,[["render",zf]]),ji=zl(Yf);ji.use(Xl);ji.mount("#cndChatBolha");console.log(ji);window.appCndChatBolha=ji;
